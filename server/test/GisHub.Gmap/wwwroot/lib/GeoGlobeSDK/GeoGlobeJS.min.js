window.GeoGlobe={singleFile:!0};
(function(){window.GeoGlobe=window.GeoGlobe||{};window.GeoGlobe.LngLatBounds={};window.GeoGlobe.LngLat={};window.GeoGlobe.Point=mapboxgl.Point;window.GeoGlobe.BoxHandler=mapboxgl.BoxHandler;window.GeoGlobe.Class={};window.GeoGlobe.Layer={};window.GeoGlobe.Source={};window.GeoGlobe.Event={};window.GeoGlobe.Control={};window.GeoGlobe.Marker={};window.GeoGlobe.Popup={};window.GeoGlobe.Filter={};window.GeoGlobe.Format={};window.GeoGlobe.Analysis={};window.GeoGlobe.Protocol={};window.GeoGlobe.Query={};
window.GeoGlobe.Statistic={};window.GeoGlobe.HeatMap={};window.GeoGlobe.LayerGroup={};window.GeoGlobe.Protocol={};window.GeoGlobe.Service={};window.GeoGlobe.DynamicFeature={};window.GeoGlobe.DynamicTrace={};GeoGlobe.getScriptArg=function(a){var b=document.getElementsByTagName("script");return(b[b.length-1].src.match(RegExp("(?:\\?|&)"+a+"=(.*?)(?=&|$)"))||["",null])[1]};if(!GeoGlobe.singleFile){for(var a=["View2D/tool/Class.js","View2D/tool/dom.js","View2D/tool/Util.js","View2D/tool/Proj4cn.js","View2D/tool/ProjAxisOrder.js",
"View2D/tool/Projection.js","View2D/BaseTypes/BaseTypes.js","View2D/BaseTypes/Pixel.js","View2D/BaseTypes/Size.js","View2D/BaseTypes/Date.js","View2D/tool/Console.js","View2D/tool/Request/Request.js","View2D/tool/Request/XMLHttpRequest.js","View2D/map/Map.js","View2D/geo/Lng_Lat_bounds_geo.js","View2D/geo/Lng_Lat_geo.js","View2D/Layer/Layer.js","View2D/Layer/wmsLayer.js","View2D/Layer/wmtsLayer.js","View2D/Layer/WMTS.js","View2D/Layer/WMS.js","View2D/Layer/GeoTileLayer.js","View2D/Layer/GeoWMTSLayer.js",
"View2D/Layer/vectortileLayer.js","View2D/Layer/VTS.js","View2D/Layer/RasterLayer.js","View2D/Layer/FillLayer.js","View2D/Layer/CircleLayer.js","View2D/Layer/SymbolLayer.js","View2D/Layer/FillExtrusionLayer.js","View2D/Layer/LineLayer.js","View2D/Layer/BackgroundLayer.js","View2D/Layer/ThematicTileLayer.js","View2D/Layer/CanvasLayer.js","View2D/Layer/TDTLayer.js","View2D/Layer/HotArea.js","View2D/Source/Source.js","View2D/Source/GeoJSONSource.js","View2D/Source/RasterSource.js","View2D/Source/ImageSource.js",
"View2D/Source/VectorSource.js","View2D/Source/VideoSource.js","View2D/Source/CanvasSource.js","View2D/Marker/Marker.js","View2D/Popup/Popup.js","View2D/control/Control.js","View2D/control/Navigation.js","View2D/control/Attribution.js","View2D/control/Scale.js","View2D/control/Geolocate.js","View2D/control/MapContextMenu.js","View2D/event/Event.js","View2D/event/mapMouseEvent.js","View2D/event/mapTouchEvent.js","View2D/event/mapDataEvent.js","View2D/event/mapBoxZoomEvent.js","View2D/handler/Handler.js",
"View2D/handler/BoxZoomHandler.js","View2D/handler/DoubleClickZoomHandler.js","View2D/handler/DragPanHandler.js","View2D/handler/DragRotateHandler.js","View2D/handler/KeyboardHandler.js","View2D/handler/ScrollZoomHandler.js","View2D/handler/TouchZoomRotateHandler.js","View2D/AutoFeature/DynamicTrace.js","View2D/AutoFeature/DynamicFeature.js","View2D/Geometry/Geometry.js","View2D/Geometry/Collection.js","View2D/Geometry/Point.js","View2D/Geometry/MultiPoint.js","View2D/Geometry/Curve.js","View2D/Geometry/LineString.js",
"View2D/Geometry/LinearRing.js","View2D/Geometry/Polygon.js","View2D/Geometry/MultiLineString.js","View2D/Geometry/MultiPolygon.js","View2D/Feature/Feature.js","View2D/Filter/Filter.js","View2D/Filter/FeatureId.js","View2D/Filter/Logical.js","View2D/Filter/Comparison.js","View2D/Filter/Spatial.js","View2D/Filter/Function.js","View2D/Protocol/Protocol.js","View2D/Protocol/HTTP.js","View2D/Protocol/WFS.js","View2D/Protocol/WFS/v1.js","View2D/Protocol/WFS/v1_0_0.js","View2D/Protocol/WFS/v1_1_0.js","View2D/Protocol/CSW.js",
"View2D/Protocol/CSW/v2_0_2.js","View2D/Protocol/Script.js","View2D/Format/Format.js","View2D/Format/XML.js","View2D/Format/XML/VersionedOGC.js","View2D/Format/GML.js","View2D/Format/GML/Base.js","View2D/Format/GML/v2.js","View2D/Format/GML/v3.js","View2D/Format/KML.js","View2D/Format/OWSCommon.js","View2D/Format/OWSCommon/v1.js","View2D/Format/OWSCommon/v1_0_0.js","View2D/Format/OWSCommon/v1_1_0.js","View2D/Format/WFSCapabilities.js","View2D/Format/WFSCapabilities/v1.js","View2D/Format/WFSCapabilities/v1_0_0.js",
"View2D/Format/WFSCapabilities/v1_1_0.js","View2D/Format/WFSDescribeFeatureType.js","View2D/Format/WKT.js","View2D/Format/CQL.js","View2D/Format/Filter.js","View2D/Format/Filter/v1.js","View2D/Format/Filter/v1_0_0.js","View2D/Format/Filter/v1_1_0.js","View2D/Format/WFST.js","View2D/Format/WFST/v1.js","View2D/Format/WFST/v1_0_0.js","View2D/Format/WFST/v1_1_0.js","View2D/Format/JSON.js","View2D/Format/GeoJSON.js","View2D/Format/Util/WMTS.js","View2D/Format/Util/WMS.js","View2D/Format/Util/VTS.js","View2D/Format/WMSCapabilities.js",
"View2D/Format/WMSCapabilities/v1.js","View2D/Format/WMSCapabilities/v1_1.js","View2D/Format/WMSCapabilities/v1_1_0.js","View2D/Format/WMSCapabilities/v1_1_1.js","View2D/Format/WMSCapabilities/v1_1_1_WMSC.js","View2D/Format/WMSCapabilities/v1_3.js","View2D/Format/WMSCapabilities/v1_3_0.js","View2D/Format/WMSUtil.js","View2D/Format/WMTSCapabilities.js","View2D/Format/WMTSCapabilities/v1_0_0.js","View2D/Format/WMTSUtil.js","View2D/Format/VTSCapabilities.js","View2D/Format/VTSCapabilities/v1_0_0.js",
"View2D/Format/WPSCapabilities.js","View2D/Format/WPSCapabilities/v1_0_0.js","View2D/Format/WCSGetCoverage.js","View2D/Format/WPSExecute.js","View2D/Format/OGCExceptionReport.js","View2D/Format/QueryStringFilter.js","View2D/Format/BusCapabilities.js","View2D/Format/XML2JSON.js","View2D/Format/CSWGetRecords.js","View2D/Format/CSWGetRecords/v2_0_2.js","View2D/Format/QueryStringFilter.js","View2D/Format/X2JS.js","View2D/Analysis/BufferAnalysis.js","View2D/Analysis/GetFeature.js","View2D/Analysis/SpatialAnalysis.js",
"View2D/Analysis/CoreBufferAnalysis.js","View2D/Query/Service.js","View2D/Query/RouteQuery.js","View2D/Query/RoutesResult.js","View2D/Query/RouteInfoResult.js","View2D/Query/BusQuery.js","View2D/Query/WFSQuery.js","View2D/Query/GeoCodingQuery.js","View2D/Query/GeoCodingQuery/v1.js","View2D/Query/GeoCodingQuery/v1_0_0.js","View2D/Query/GeoCodingQuery/v1_1_0.js","View2D/Heatmap/HeatMap.js","View2D/BaseLayerGroup/BaseLayerGroup.js","View2D/Service/Service.js","View2D/Service/WFST.js","View2D/Service/CTS.js",
"View2D/Service/VTS.js","View2D/Service/WMS.js","View2D/Service/WMTS.js","View2D/Service/DTJ.js","View2D/Service/Fonts.js","View2D/Statistics/GeoStatisticsService.js","View2D/ElementContainer/ElementContainer.js","View2D/ElementContainer/MaptalksEC.js","View2D/tool/Lang.js","View2D/tool/Lang/en.js","View2D/tool/Lang/zh-CN.js"],b="",c=/(^|(.*?\/))(GeoGlobeJSAPI.js)(\?|$)/,d=document.getElementsByTagName("script"),e=0,f=d.length;e<f;e++){var g=d[e].getAttribute("src");if(g&&(g=g.match(c))){b=g[1];break}}c=
Array(a.length);e=0;for(f=a.length;e<f;e++)c[e]="<script src='"+b+a[e]+"'><\/script>";c.length>0&&document.write(c.join(""))}GeoGlobe.scriptName=!GeoGlobe.singleFile?"GeoGlobeJSAPI/GeoGlobeJSAPI.js":"GeoGlobeJS.min.js";GeoGlobe.getScriptLocation=function(){for(var a="",b=RegExp("(^|(.*?\\/))("+GeoGlobe.scriptName+")(\\?|$)"),c=document.getElementsByTagName("script"),d=0,e=c.length;d<e;d++){var f=c[d].getAttribute("src");if(f&&(f=f.match(b))){a=f[1];break}}return a};GeoGlobe.imagesPath="";GeoGlobe.createNS=
function(a){for(var a=a.split("."),b=window,c=0;c<a.length;c++)b[a[c]]||(b[a[c]]={}),b=b[a[c]]};GeoGlobe.VERSION_NUMBER="GeoGlobeJSAPI 2018 -- $Version: 0.44.2 build-20190329 $"})();GeoGlobe.Class=function(){var a=arguments.length,b=arguments[0],c=arguments[a-1],d=typeof c.initialize=="function"?c.initialize:function(){b.prototype.initialize.apply(this,arguments)};a>1?[d,b].concat(Array.prototype.slice.call(arguments).slice(1,a-1),c):d.prototype=c;return d};
GeoGlobe.Class4OL=function(){var a=arguments.length,b=arguments[0],c=arguments[a-1],d=typeof c.initialize=="function"?c.initialize:function(){b.prototype.initialize.apply(this,arguments)};a>1?(a=[d,b].concat(Array.prototype.slice.call(arguments).slice(1,a-1),c),GeoGlobe.inherit.apply(null,a)):d.prototype=c;return d};
GeoGlobe.inherit=function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c;var d,e,c=2;for(d=arguments.length;c<d;c++){e=arguments[c];if(typeof e==="function")e=e.prototype;GeoGlobe.Util.extend(a.prototype,e)}};GeoGlobe.Util=GeoGlobe.Util||{};GeoGlobe.Util.extend=function(a,b){a=a||{};if(b){for(var c in b){var d=b[c];d!==void 0&&(a[c]=d)}if(!(typeof window.Event=="function"&&b instanceof window.Event)&&b.hasOwnProperty&&b.hasOwnProperty("toString"))a.toString=b.toString}return a};
GeoGlobe.Util.deepExtend=function(a){for(var b=1;b<arguments.length;b++)for(var c in arguments[b])if(arguments[b].hasOwnProperty(c))switch(GeoGlobe.Util.getType(arguments[b][c])){case "array":a.hasOwnProperty(c)&&GeoGlobe.Util.getType(a[c])==="array"?GeoGlobe.Util.deepExtend(a[c],arguments[b][c]):a[c]=GeoGlobe.Util.deepExtend([],arguments[b][c]);break;case "object":a.hasOwnProperty(c)&&GeoGlobe.Util.getType(a[c])==="object"?GeoGlobe.Util.deepExtend(a[c],arguments[b][c]):a[c]=GeoGlobe.Util.deepExtend({},
arguments[b][c]);break;default:a[c]=arguments[b][c]}return a};
(function(){function a(a){for(var b=0;b<a.length;b++)if(a[b]in c)return a[b];return a[0]}function b(a){a.preventDefault();a.stopPropagation();window.removeEventListener("click",b,!0)}GeoGlobe.DOM=GeoGlobe.DOM||{};GeoGlobe.DOM.create=function(a,b,c){a=window.document.createElement(a);if(b)a.className=b;c&&c.appendChild(a);return a};var c=window.document.documentElement.style,d=a(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),e;GeoGlobe.DOM.disableDrag=function(){d&&(e=c[d],c[d]=
"none")};GeoGlobe.DOM.enableDrag=function(){d&&(c[d]=e)};var f=a(["transform","WebkitTransform"]);GeoGlobe.DOM.setTransform=function(a,b){a.style[f]=b};GeoGlobe.DOM.suppressClick=function(){window.addEventListener("click",b,!0);window.setTimeout(function(){window.removeEventListener("click",b,!0)},0)};GeoGlobe.DOM.mousePos=function(a,b){var c=a.getBoundingClientRect(),b=b.touches?b.touches[0]:b;return new mapboxgl.Point(b.clientX-c.left-a.clientLeft,b.clientY-c.top-a.clientTop)};GeoGlobe.DOM.touchPos=
function(a,b){for(var c=a.getBoundingClientRect(),d=[],e=b.type==="touchend"?b.changedTouches:b.touches,f=0;f<e.length;f++)d.push(new mapboxgl.Point(e[f].clientX-c.left-a.clientLeft,e[f].clientY-c.top-a.clientTop));return d};GeoGlobe.DOM.remove=function(a){a.parentNode&&a.parentNode.removeChild(a)}})();GeoGlobe.Util=GeoGlobe.Util||{};
GeoGlobe.Util.getElement=function(){for(var a=[],b=0,c=arguments.length;b<c;b++){var d=arguments[b];typeof d=="string"&&(d=document.getElementById(d));if(arguments.length==1)return d;a.push(d)}return a};GeoGlobe.Util.isElement=function(a){return!!(a&&a.nodeType===1)};GeoGlobe.Util.isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"};GeoGlobe.Util.removeItem=function(a,b){for(var c=a.length-1;c>=0;c--)a[c]==b&&a.splice(c,1);return a};
GeoGlobe.Util.indexOf=function(a,b){if(typeof a.indexOf=="function")return a.indexOf(b);else{for(var c=0,d=a.length;c<d;c++)if(a[c]==b)return c;return-1}};GeoGlobe.Util.dotless=/\./g;GeoGlobe.IMAGE_RELOAD_ATTEMPTS=0;GeoGlobe.Util.alphaHackNeeded=null;GeoGlobe.Util.alphaHack=function(){if(GeoGlobe.Util.alphaHackNeeded==null){var a=navigator.appVersion.split("MSIE"),a=parseFloat(a[1]),b=!1;try{b=!!document.body.filters}catch(c){}GeoGlobe.Util.alphaHackNeeded=b&&a>=5.5&&a<7}return GeoGlobe.Util.alphaHackNeeded};
GeoGlobe.Util.upperCaseObject=function(a){var b={},c;for(c in a)b[c.toUpperCase()]=a[c];return b};GeoGlobe.Util.applyDefaults=function(a,b){var a=a||{},c=typeof window.Event=="function"&&b instanceof window.Event,d;for(d in b)if(a[d]===void 0||!c&&b.hasOwnProperty&&b.hasOwnProperty(d)&&!a.hasOwnProperty(d))a[d]=b[d];if(!c&&b&&b.hasOwnProperty&&b.hasOwnProperty("toString")&&!a.hasOwnProperty("toString"))a.toString=b.toString;return a};
GeoGlobe.Util.getParameterString=function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}else d=encodeURIComponent(d);b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")};GeoGlobe.Util.urlAppend=function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c};
GeoGlobe.Util.getImagesLocation=function(){return GeoGlobe.ImgPath||GeoGlobe._getScriptLocation()+"img/"};GeoGlobe.Util.getImageLocation=function(a){return GeoGlobe.Util.getImagesLocation()+a};GeoGlobe.Util.Try=function(){for(var a=null,b=0,c=arguments.length;b<c;b++){var d=arguments[b];try{a=d();break}catch(e){}}return a};GeoGlobe.Util.getXmlNodeValue=function(a){var b=null;GeoGlobe.Util.Try(function(){b=a.text;if(!b)b=a.textContent;if(!b)b=a.firstChild.nodeValue},function(){b=a.textContent});return b};
GeoGlobe.Util.mouseLeft=function(a,b){for(var c=a.relatedTarget?a.relatedTarget:a.toElement;c!=b&&c!=null;)c=c.parentNode;return c!=b};GeoGlobe.Util.DEFAULT_PRECISION=14;GeoGlobe.Util.toFloat=function(a,b){if(b==null)b=GeoGlobe.Util.DEFAULT_PRECISION;typeof a!=="number"&&(a=parseFloat(a));return b===0?a:parseFloat(a.toPrecision(b))};GeoGlobe.Util.rad=function(a){return a*Math.PI/180};GeoGlobe.Util.deg=function(a){return a*180/Math.PI};
GeoGlobe.Util.VincentyConstants={a:6378137,b:6356752.3142,f:1/298.257223563};
GeoGlobe.Util.distVincenty=function(a,b){for(var c=GeoGlobe.Util.VincentyConstants,d=c.a,e=c.b,c=c.f,f=GeoGlobe.Util.rad(b.lng-a.lng),g=Math.atan((1-c)*Math.tan(GeoGlobe.Util.rad(a.lat))),h=Math.atan((1-c)*Math.tan(GeoGlobe.Util.rad(b.lat))),j=Math.sin(g),g=Math.cos(g),l=Math.sin(h),h=Math.cos(h),n=f,o=2*Math.PI,q=20;Math.abs(n-o)>1.0E-12&&--q>0;){var r=Math.sin(n),m=Math.cos(n),p=Math.sqrt(h*r*h*r+(g*l-j*h*m)*(g*l-j*h*m));if(p==0)return 0;var m=j*l+g*h*m,t=Math.atan2(p,m),s=Math.asin(g*h*r/p),u=
Math.cos(s)*Math.cos(s),r=m-2*j*l/u,v=c/16*u*(4+c*(4-3*u)),o=n,n=f+(1-v)*c*Math.sin(s)*(t+v*p*(r+v*m*(-1+2*r*r)))}if(q==0)return NaN;d=u*(d*d-e*e)/(e*e);c=d/1024*(256+d*(-128+d*(74-47*d)));return(e*(1+d/16384*(4096+d*(-768+d*(320-175*d))))*(t-c*p*(r+c/4*(m*(-1+2*r*r)-c/6*r*(-3+4*p*p)*(-3+4*r*r))))).toFixed(3)/1E3};
GeoGlobe.Util.destinationVincenty=function(a,b,c){for(var d=GeoGlobe.Util,e=d.VincentyConstants,f=e.a,g=e.b,e=e.f,h=a.lng,j=a.lat,a=d.rad(b),b=Math.sin(a),a=Math.cos(a),l=(1-e)*Math.tan(d.rad(j)),j=1/Math.sqrt(1+l*l),n=l*j,o=Math.atan2(l,a),l=j*b,q=1-l*l,f=q*(f*f-g*g)/(g*g),r=1+f/16384*(4096+f*(-768+f*(320-175*f))),m=f/1024*(256+f*(-128+f*(74-47*f))),f=c/(g*r),p=2*Math.PI;Math.abs(f-p)>1.0E-12;)var t=Math.cos(2*o+f),s=Math.sin(f),u=Math.cos(f),v=m*s*(t+m/4*(u*(-1+2*t*t)-m/6*t*(-3+4*s*s)*(-3+4*t*t))),
p=f,f=c/(g*r)+v;c=n*s-j*u*a;c=Math.atan2(n*u+j*s*a,(1-e)*Math.sqrt(l*l+c*c));g=e/16*q*(4+e*(4-3*q));return new GeoGlobe.LngLat(h+d.deg(Math.atan2(s*b,j*u-n*s*a)-(1-g)*e*l*(f+g*s*(t+g*u*(-1+2*t*t)))),d.deg(c))};
GeoGlobe.Util.getParameters=function(a,b){var b=b||{},a=a===null||a===void 0?window.location.href:a,c="";if(GeoGlobe.String.contains(a,"?"))var d=a.indexOf("?")+1,c=GeoGlobe.String.contains(a,"#")?a.indexOf("#"):a.length,c=a.substring(d,c);for(var d={},c=c.split(/[&;]/),e=0,f=c.length;e<f;++e){var g=c[e].split("=");if(g[0]){var h=g[0];try{h=decodeURIComponent(h)}catch(j){h=unescape(h)}g=(g[1]||"").replace(/\+/g," ");try{g=decodeURIComponent(g)}catch(l){g=unescape(g)}b.splitArgs!==!1&&(g=g.split(","));
g.length==1&&(g=g[0]);d[h]=g}}return d};GeoGlobe.Util.lastSeqID=0;GeoGlobe.Util.createUniqueID=function(a){a=a==null?"id_":a.replace(GeoGlobe.Util.dotless,"_");GeoGlobe.Util.lastSeqID+=1;return a+GeoGlobe.Util.lastSeqID};GeoGlobe.INCHES_PER_UNIT={inches:1,ft:12,mi:63360,m:1/0.0254,km:39370,dd:4374754,yd:36};GeoGlobe.INCHES_PER_UNIT["in"]=GeoGlobe.INCHES_PER_UNIT.inches;GeoGlobe.INCHES_PER_UNIT.degrees=GeoGlobe.INCHES_PER_UNIT.dd;GeoGlobe.INCHES_PER_UNIT.nmi=1852*GeoGlobe.INCHES_PER_UNIT.m;
GeoGlobe.METERS_PER_INCH=0.0254000508001016;
GeoGlobe.Util.extend(GeoGlobe.INCHES_PER_UNIT,{Inch:GeoGlobe.INCHES_PER_UNIT.inches,Meter:1/GeoGlobe.METERS_PER_INCH,Foot:0.3048006096012192/GeoGlobe.METERS_PER_INCH,IFoot:0.3048/GeoGlobe.METERS_PER_INCH,ClarkeFoot:0.3047972651151/GeoGlobe.METERS_PER_INCH,SearsFoot:0.30479947153867626/GeoGlobe.METERS_PER_INCH,GoldCoastFoot:0.3047997101815088/GeoGlobe.METERS_PER_INCH,IInch:0.0254/GeoGlobe.METERS_PER_INCH,MicroInch:2.54E-5/GeoGlobe.METERS_PER_INCH,Mil:2.54E-8/GeoGlobe.METERS_PER_INCH,Centimeter:0.01/
GeoGlobe.METERS_PER_INCH,Kilometer:1E3/GeoGlobe.METERS_PER_INCH,Yard:0.9144018288036576/GeoGlobe.METERS_PER_INCH,SearsYard:0.914398414616029/GeoGlobe.METERS_PER_INCH,IndianYard:0.9143985307444408/GeoGlobe.METERS_PER_INCH,IndianYd37:0.91439523/GeoGlobe.METERS_PER_INCH,IndianYd62:0.9143988/GeoGlobe.METERS_PER_INCH,IndianYd75:0.9143985/GeoGlobe.METERS_PER_INCH,IndianFoot:0.30479951/GeoGlobe.METERS_PER_INCH,IndianFt37:0.30479841/GeoGlobe.METERS_PER_INCH,IndianFt62:0.3047996/GeoGlobe.METERS_PER_INCH,IndianFt75:0.3047995/
GeoGlobe.METERS_PER_INCH,Mile:1609.3472186944373/GeoGlobe.METERS_PER_INCH,IYard:0.9144/GeoGlobe.METERS_PER_INCH,IMile:1609.344/GeoGlobe.METERS_PER_INCH,NautM:1852/GeoGlobe.METERS_PER_INCH,"Lat-66":110943.31648893273/GeoGlobe.METERS_PER_INCH,"Lat-83":110946.25736872235/GeoGlobe.METERS_PER_INCH,Decimeter:0.1/GeoGlobe.METERS_PER_INCH,Millimeter:0.001/GeoGlobe.METERS_PER_INCH,Dekameter:10/GeoGlobe.METERS_PER_INCH,Decameter:10/GeoGlobe.METERS_PER_INCH,Hectometer:100/GeoGlobe.METERS_PER_INCH,GermanMeter:1.0000135965/
GeoGlobe.METERS_PER_INCH,CaGrid:0.999738/GeoGlobe.METERS_PER_INCH,ClarkeChain:20.1166194976/GeoGlobe.METERS_PER_INCH,GunterChain:20.11684023368047/GeoGlobe.METERS_PER_INCH,BenoitChain:20.116782494375872/GeoGlobe.METERS_PER_INCH,SearsChain:20.11676512155/GeoGlobe.METERS_PER_INCH,ClarkeLink:0.201166194976/GeoGlobe.METERS_PER_INCH,GunterLink:0.2011684023368047/GeoGlobe.METERS_PER_INCH,BenoitLink:0.20116782494375873/GeoGlobe.METERS_PER_INCH,SearsLink:0.2011676512155/GeoGlobe.METERS_PER_INCH,Rod:5.02921005842012/
GeoGlobe.METERS_PER_INCH,IntnlChain:20.1168/GeoGlobe.METERS_PER_INCH,IntnlLink:0.201168/GeoGlobe.METERS_PER_INCH,Perch:5.02921005842012/GeoGlobe.METERS_PER_INCH,Pole:5.02921005842012/GeoGlobe.METERS_PER_INCH,Furlong:201.1684023368046/GeoGlobe.METERS_PER_INCH,Rood:3.778266898/GeoGlobe.METERS_PER_INCH,CapeFoot:0.3047972615/GeoGlobe.METERS_PER_INCH,Brealey:375/GeoGlobe.METERS_PER_INCH,ModAmFt:0.304812252984506/GeoGlobe.METERS_PER_INCH,Fathom:1.8288/GeoGlobe.METERS_PER_INCH,"NautM-UK":1853.184/GeoGlobe.METERS_PER_INCH,
"50kilometers":5E4/GeoGlobe.METERS_PER_INCH,"150kilometers":15E4/GeoGlobe.METERS_PER_INCH});
GeoGlobe.Util.extend(GeoGlobe.INCHES_PER_UNIT,{mm:GeoGlobe.INCHES_PER_UNIT.Meter/1E3,cm:GeoGlobe.INCHES_PER_UNIT.Meter/100,dm:GeoGlobe.INCHES_PER_UNIT.Meter*100,km:GeoGlobe.INCHES_PER_UNIT.Meter*1E3,kmi:GeoGlobe.INCHES_PER_UNIT.nmi,fath:GeoGlobe.INCHES_PER_UNIT.Fathom,ch:GeoGlobe.INCHES_PER_UNIT.IntnlChain,link:GeoGlobe.INCHES_PER_UNIT.IntnlLink,"us-in":GeoGlobe.INCHES_PER_UNIT.inches,"us-ft":GeoGlobe.INCHES_PER_UNIT.Foot,"us-yd":GeoGlobe.INCHES_PER_UNIT.Yard,"us-ch":GeoGlobe.INCHES_PER_UNIT.GunterChain,
"us-mi":GeoGlobe.INCHES_PER_UNIT.Mile,"ind-yd":GeoGlobe.INCHES_PER_UNIT.IndianYd37,"ind-ft":GeoGlobe.INCHES_PER_UNIT.IndianFt37,"ind-ch":20.11669506/GeoGlobe.METERS_PER_INCH});GeoGlobe.DOTS_PER_INCH=96;GeoGlobe.Util.normalizeScale=function(a){return a>1?1/a:a};GeoGlobe.Util.getResolutionFromScale=function(a,b){var c;a&&(b==null&&(b="degrees"),c=1/(GeoGlobe.Util.normalizeScale(a)*GeoGlobe.INCHES_PER_UNIT[b]*GeoGlobe.DOTS_PER_INCH));return c};
GeoGlobe.Util.getScaleFromResolution=function(a,b){b==null&&(b="degrees");return a*GeoGlobe.INCHES_PER_UNIT[b]*GeoGlobe.DOTS_PER_INCH};
GeoGlobe.Util.pagePosition=function(a){var b=[0,0],c=GeoGlobe.Util.getViewportElement();if(!a||a==window||a==c)return b;var d=GeoGlobe.IS_GECKO&&document.getBoxObjectFor&&GeoGlobe.Element.getStyle(a,"position")=="absolute"&&(a.style.top==""||a.style.left==""),e=null;if(a.getBoundingClientRect)a=a.getBoundingClientRect(),e=window.pageYOffset||c.scrollTop,b[0]=a.left+(window.pageXOffset||c.scrollLeft),b[1]=a.top+e;else if(document.getBoxObjectFor&&!d)a=document.getBoxObjectFor(a),c=document.getBoxObjectFor(c),
b[0]=a.screenX-c.screenX,b[1]=a.screenY-c.screenY;else{b[0]=a.offsetLeft;b[1]=a.offsetTop;e=a.offsetParent;if(e!=a)for(;e;)b[0]+=e.offsetLeft,b[1]+=e.offsetTop,e=e.offsetParent;c=GeoGlobe.BROWSER_NAME;if(c=="opera"||c=="safari"&&GeoGlobe.Element.getStyle(a,"position")=="absolute")b[1]-=document.body.offsetTop;for(e=a.offsetParent;e&&e!=document.body;){b[0]-=e.scrollLeft;if(c!="opera"||e.tagName!="TR")b[1]-=e.scrollTop;e=e.offsetParent}}return b};
GeoGlobe.Util.getViewportElement=function(){var a=arguments.callee.viewportElement;if(a==void 0)a=GeoGlobe.BROWSER_NAME=="msie"&&document.compatMode!="CSS1Compat"?document.body:document.documentElement,arguments.callee.viewportElement=a;return a};
GeoGlobe.Util.isEquivalentUrl=function(a,b,c){c=c||{};GeoGlobe.Util.applyDefaults(c,{ignoreCase:!0,ignorePort80:!0,ignoreHash:!0,splitArgs:!1});var a=GeoGlobe.Util.createUrlObject(a,c),b=GeoGlobe.Util.createUrlObject(b,c),d;for(d in a)if(d!=="args"&&a[d]!=b[d])return!1;for(d in a.args){if(a.args[d]!=b.args[d])return!1;delete b.args[d]}for(d in b.args)return!1;return!0};
GeoGlobe.Util.createUrlObject=function(a,b){b=b||{};if(!/^\w+:\/\//.test(a)){var c=window.location,d=c.port?":"+c.port:"",d=c.protocol+"//"+c.host.split(":").shift()+d;a.indexOf("/")===0?a=d+a:(c=c.pathname.split("/"),c.pop(),a=d+c.join("/")+"/"+a)}b.ignoreCase&&(a=a.toLowerCase());c=document.createElement("a");c.href=a;d={};d.host=c.host.split(":").shift();d.protocol=c.protocol;d.port=b.ignorePort80?c.port=="80"||c.port=="0"?"":c.port:c.port==""||c.port=="0"?"80":c.port;d.hash=b.ignoreHash||c.hash===
"#"?"":c.hash;var e=c.search;e||(e=a.indexOf("?"),e=e!=-1?a.substr(e):"");d.args=GeoGlobe.Util.getParameters(e,{splitArgs:b.splitArgs});d.pathname=c.pathname.charAt(0)=="/"?c.pathname:"/"+c.pathname;return d};GeoGlobe.Util.removeTail=function(a){var b=null,b=a.indexOf("?"),c=a.indexOf("#");return b=b==-1?c!=-1?a.substr(0,c):a:c!=-1?a.substr(0,Math.min(b,c)):a.substr(0,b)};GeoGlobe.IS_GECKO=function(){var a=navigator.userAgent.toLowerCase();return a.indexOf("webkit")==-1&&a.indexOf("gecko")!=-1}();
GeoGlobe.CANVAS_SUPPORTED=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))}();GeoGlobe.BROWSER_NAME=function(){var a="",b=navigator.userAgent.toLowerCase();b.indexOf("opera")!=-1?a="opera":b.indexOf("msie")!=-1?a="msie":b.indexOf("safari")!=-1?a="safari":b.indexOf("mozilla")!=-1&&(a=b.indexOf("firefox")!=-1?"firefox":"mozilla");return a}();GeoGlobe.Util.getBrowserName=function(){return GeoGlobe.BROWSER_NAME};
GeoGlobe.Util.getRenderedDimensions=function(a,b,c){var d,e,f=document.createElement("div");f.style.visibility="hidden";for(var g=c&&c.containerElement?c.containerElement:document.body,h=!1,j=null,l=g;l&&l.tagName.toLowerCase()!="body";){var n=GeoGlobe.Element.getStyle(l,"position");if(n=="absolute"){h=!0;break}else if(n&&n!="static")break;l=l.parentNode}if(h&&(g.clientHeight===0||g.clientWidth===0))j=document.createElement("div"),j.style.visibility="hidden",j.style.position="absolute",j.style.overflow=
"visible",j.style.width=document.body.clientWidth+"px",j.style.height=document.body.clientHeight+"px",j.appendChild(f);f.style.position="absolute";if(b)if(b.w)d=b.w,f.style.width=d+"px";else if(b.h)e=b.h,f.style.height=e+"px";if(c&&c.displayClass)f.className=c.displayClass;b=document.createElement("div");b.innerHTML=a;b.style.overflow="visible";if(b.childNodes){a=0;for(c=b.childNodes.length;a<c;a++)if(b.childNodes[a].style)b.childNodes[a].style.overflow="visible"}f.appendChild(b);j?g.appendChild(j):
g.appendChild(f);if(!d)d=parseInt(b.scrollWidth),f.style.width=d+"px";e||(e=parseInt(b.scrollHeight));f.removeChild(b);j?(j.removeChild(f),g.removeChild(j)):g.removeChild(f);return new GeoGlobe.Size(d,e)};
GeoGlobe.Util.getScrollbarWidth=function(){var a=GeoGlobe.Util._scrollbarWidth;if(a==null){var b=null,c=null,b=a=0,b=document.createElement("div");b.style.position="absolute";b.style.top="-1000px";b.style.left="-1000px";b.style.width="100px";b.style.height="50px";b.style.overflow="hidden";c=document.createElement("div");c.style.width="100%";c.style.height="200px";b.appendChild(c);document.body.appendChild(b);a=c.offsetWidth;b.style.overflow="scroll";b=c.offsetWidth;document.body.removeChild(document.body.lastChild);
GeoGlobe.Util._scrollbarWidth=a-b;a=GeoGlobe.Util._scrollbarWidth}return a};GeoGlobe.Util.randomStr=function(a){for(var b="",c=[],d=0;d<a;d++)c.push(String.fromCharCode(97+Math.ceil(Math.random()*25)));for(d=0;d<a;d++)b+=c[d];return b};GeoGlobe.Util.globalEval=function(a){a&&GeoGlobe.String.trim(a)&&(window.execScript||function(a){window.eval.call(window,a)})(a)};
GeoGlobe.Util.getResolutionFromScale_DPI=function(a,b,c){var d;a&&(b==null&&(b="degrees"),d=1/(GeoGlobe.Util.normalizeScale(a)*GeoGlobe.INCHES_PER_UNIT[b]*c));return d};GeoGlobe.Util.getScaleFromResolution_DPI=function(a,b,c){b==null&&(b="degrees");return a*GeoGlobe.INCHES_PER_UNIT[b]*c};
GeoGlobe.Util.getMapLevelFormResolution=function(a,b){if(!b)return 0;var c,d,e=Number.POSITIVE_INFINITY,f=a.getResolutions();c=0;for(len=f.length;c<len;c++){d=Math.abs(f[c]-b);if(d>e)break;e=d}return Math.max(0,c-1)};GeoGlobe.Util.getMapLevelFormScale=function(a,b,c,d){b=GeoGlobe.Util.getResolutionFromScale_DPI(b,c?c:"degrees",d?d:96);return GeoGlobe.Util.getMapLevelFormResolution(a,b)};
GeoGlobe.Util.delayFun=function(a,b,c){var d;return function(){var e=this,f=arguments,g=c&&!d;clearTimeout(d);d=setTimeout(function(){d=null;c||a.apply(e,f)},b);g&&a.apply(e,f)}};GeoGlobe.Util.clone=function(a){if(typeof a!="object")return a;if(a==null)return a;var b=a.constructor==Array?[]:{},c;for(c in a)b[c]=GeoGlobe.Util.clone(a[c]);return b};
GeoGlobe.Util.getType=function(a){if(a instanceof Element)return"element";return{"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regExp","[object Undefined]":"undefined","[object Null]":"null","[object Object]":"object"}[Object.prototype.toString.call(a)]};
GeoGlobe.Util.formatNumberToThousands=function(a,b,c){a=a.toString().replace(/\$|\,/g,"");isNaN(a)&&(a="0");for(var d=a===(a=Math.abs(a)),a=Math.floor(a*Math.pow(10,b)+0.50000000001),e=a%Math.pow(10,b),a=Math.floor(a/Math.pow(10,b)).toString(),e=e.toString();e.length<b;)e="0"+e;if(c)for(c=0;c<Math.floor((a.length-(1+c))/3);c++)a=a.substring(0,a.length-(4*c+3))+","+a.substring(a.length-(4*c+3));return b>0?(d?"":"-")+a+"."+e:(d?"":"-")+a};
GeoGlobe.Util.getFormattedString=function(a,b){var c;c=b.replace(/{a}/g,a.a);c=c.replace(/{b}/g,a.b);if(c.contains("{c"))for(var d=c.split("{c"),e=0,f=0;f<d.length-1;f++)e=d[f+1].split("}")[0],c=c.replace(RegExp("{c"+e+"}","g"),GeoGlobe.Util.formatNumberToThousands(parseFloat(a.c),e===""?2:e,!0));return c};
GeoGlobe.Util.getGradientImageData=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");b.width=1;b.height=256;var b=c.createLinearGradient(0,0,0,256),d;for(d in a)a.hasOwnProperty(d)&&b.addColorStop(d,a[d]);c.fillStyle=b;c.fillRect(0,0,1,256);return c.getImageData(0,0,1,256).data};
GeoGlobe.Util.getRgbColor=function(a){var a=a.toLowerCase(),b=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(a&&b.test(a)){if(a.length===4){for(var b="#",c=1;c<4;c+=1)b+=a.slice(c,c+1).concat(a.slice(c,c+1));a=b}b=[];for(c=1;c<7;c+=2)b.push(parseInt("0x"+a.slice(c,c+2)));return"rgb("+b.join(",")+")"}else{if(a.startsWith("rgba")||a.startsWith("hsla"))return a.substring(0,3)+a.substring(4,a.lastIndexOf(","))+")";if(a.startsWith("rgb")||a.startsWith("hsl"))return a;return""}};
GeoGlobe.Util.getShadeColor=function(a,b){var a=GeoGlobe.Util.getHexColor(a),a=a.substr(1),c=parseInt(a,16),d=Math.round(2.55*b),e=(c>>16)+d,f=(c>>8&255)+d,c=(c&255)+d;return"#"+(16777216+(e<255?e<1?0:e:255)*65536+(f<255?f<1?0:f:255)*256+(c<255?c<1?0:c:255)).toString(16).slice(1)};
GeoGlobe.Util.getHexColor=function(a){a=a.toLowerCase();if(/^(rgb|rgba)/.test(a)){for(var b=a.split("(")[1].split(")")[0].split(","),c="#",d=0;d<3;d++){var e=Number(b[d]).toString(16);e==="0"&&(e+=e);e.length===1&&(e="0"+e);c+=e}c.length!==7&&(c=a);return c}else if(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(a))if(b=a.replace(/#/,"").split(""),b.length===6)return a;else{if(b.length===3){a="#";for(d=0;d<b.length;d+=1)a+=b[d]+b[d];return a}}else return a};
GeoGlobe.Util.transferToLonLat=function(a){return a[1]===-2.3810769323182276E8?[a[0]/2.003750834E7*180,-90]:[a[0]/2.003750834E7*180,180/Math.PI*(2*Math.atan(Math.exp(a[1]/2.003750834E7*180*Math.PI/180))-Math.PI/2)]};GeoGlobe.Util.transferToMercator=function(a){return a[1]===-90?[a[0]*2.003750834E7/180,-2.3810769323182276E8]:[a[0]*2.003750834E7/180,Math.log(Math.tan((90+a[1])*Math.PI/360))/(Math.PI/180)*2.003750834E7/180]};
GeoGlobe.Util.formatDate=function(a,b){var c={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours()%12===0?12:a.getHours()%12,"H+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds(),"q+":Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()},d={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};/(y+)/.test(b)&&(b=b.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));/(E+)/.test(b)&&(b=b.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>
2?"/u661f/u671f":"/u5468":"")+d[a.getDay()+""]));for(var e in c)RegExp("("+e+")").test(b)&&(b=b.replace(RegExp.$1,RegExp.$1.length===1?c[e]:("00"+c[e]).substr((""+c[e]).length)));return b};
(function(a){typeof exports==="object"&&typeof module!=="undefined"?module.exports=a():typeof define==="function"&&define.amd?define([],a):(typeof window!=="undefined"?window:typeof global!=="undefined"?global:typeof self!=="undefined"?self:this).proj4cn=a()})(function(){return function b(c,d,e){function f(h,l){if(!d[h]){if(!c[h]){var n=typeof require=="function"&&require;if(!l&&n)return n(h,!0);if(g)return g(h,!0);n=Error("Cannot find module '"+h+"'");throw n.code="MODULE_NOT_FOUND",n;}n=d[h]={exports:{}};
c[h][0].call(n.exports,function(b){var d=c[h][1][b];return f(d?d:b)},n,n.exports,b,c,d,e)}return d[h].exports}for(var g=typeof require=="function"&&require,h=0;h<e.length;h++)f(e[h]);return f}({1:[function(b,c,d){var c=b("../util").forEachPoint,e=b("./gcj-02"),f=Math.PI*3E3/180,g=d.toGCJ02=c(function(b,c,d){var e=b[d]-0.0065,g=b[d+1]-0.006,b=Math.sqrt(e*e+g*g)-2.0E-5*Math.sin(g*f),e=Math.atan2(g,e)-3.0E-6*Math.cos(e*f);c[d]=b*Math.cos(e);c[d+1]=b*Math.sin(e);return c}),h=d.fromGCJ02=c(function(b,
c,d){var e=b[d],g=b[d+1],b=Math.sqrt(e*e+g*g)+2.0E-5*Math.sin(g*f),e=Math.atan2(g,e)+3.0E-6*Math.cos(e*f);c[d]=b*Math.cos(e)+0.0065;c[d+1]=b*Math.sin(e)+0.006;return c});d.toWGS84=function(b,c,d){b=g(b,c,d);return e.toWGS84(b,b,d)};d.fromWGS84=function(b,c,d){b=e.fromWGS84(b,c,d);return h(b,b,d)}},{"../util":8,"./gcj-02":2}],2:[function(b,c,d){function e(b,c){var d,e=b-105,f=c-35;d=-100+2*e+3*f+0.2*f*f+0.1*e*f+0.2*Math.sqrt(Math.abs(e));d+=(20*Math.sin(6*e*g)+20*Math.sin(2*e*g))*2/3;d+=(20*Math.sin(f*
g)+40*Math.sin(f/3*g))*2/3;d+=(160*Math.sin(f/12*g)+320*Math.sin(f*g/30))*2/3;f=b-105;e=c-35;e=300+f+2*e+0.1*f*f+0.1*f*e+0.1*Math.sqrt(Math.abs(f));e+=(20*Math.sin(6*f*g)+20*Math.sin(2*f*g))*2/3;e+=(20*Math.sin(f*g)+40*Math.sin(f/3*g))*2/3;e+=(150*Math.sin(f/12*g)+300*Math.sin(f/30*g))*2/3;var f=c/180*g,m=Math.sin(f),m=1-j*m*m,p=Math.sqrt(m);d=d*180/(h*(1-j)/(m*p)*g);e=e*180/(h/p*Math.cos(f)*g);return[e,d]}function f(b,c){if(b<72.004||b>137.8347)return!0;if(c<0.8293||c>55.8271)return!0;return!1}var b=
b("../util").forEachPoint,g=Math.PI,h=6378245,j=0.006693421622965943;d.toWGS84=b(function(b,c,d){var g=b[d],b=b[d+1];if(!f(g,b)){var h=e(g,b);g-=h[0];b-=h[1]}c[d]=g;c[d+1]=b});d.fromWGS84=b(function(b,c,d){var g=b[d],b=b[d+1];if(!f(g,b)){var h=e(g,b);g+=h[0];b+=h[1]}c[d]=g;c[d+1]=b})},{"../util":8}],3:[function(b,c,d){d.bd09=b("./bd-09");d.gcj02=b("./gcj-02")},{"./bd-09":1,"./gcj-02":2}],4:[function(b,c,d){var e=b("./projection/index"),f=b("./datum/index");d.smerc2bmerc=function(b,c,d){b=e.sphericalMercator.inverse(b,
c,d);b=f.bd09.fromWGS84(b,b,d);return e.baiduMercator.forward(b,b,d)};d.bmerc2smerc=function(b,c,d){b=e.baiduMercator.inverse(b,c,d);b=f.bd09.toWGS84(b,b,d);return e.sphericalMercator.forward(b,b,d)};d.bmerc2ll=function(b,c,d){b=e.baiduMercator.inverse(b,c,d);return f.bd09.toWGS84(b,b,d)};d.ll2bmerc=function(b,c,d){b=f.bd09.fromWGS84(b,c,d);return e.baiduMercator.forward(b,b,d)};d.ll2smerc=e.sphericalMercator.forward;d.smerc2ll=e.sphericalMercator.inverse;d.datum=f;d.projection=e;d.gcj02towgs84=function(b,
c,d){return f.gcj02.toWGS84(b,c,d)};d.wgs84togcj02=function(b,c,d){return f.gcj02.fromWGS84(b,c,d)}},{"./datum/index":3,"./projection/index":6}],5:[function(b,c,d){function e(b,c,d,e){var f=b[d],b=b[d+1],g=Math.abs(b)/e[9],g=e[2]+e[3]*g+e[4]*g*g+e[5]*g*g*g+e[6]*g*g*g*g+e[7]*g*g*g*g*g+e[8]*g*g*g*g*g*g;c[d]=(e[0]+e[1]*Math.abs(f))*(f<0?-1:1);c[d+1]=g*(b<0?-1:1)}var b=b("../util").forEachPoint,f=[1.289059486E7,8362377.87,5591021,3481989.83,1678043.12,0],g=[75,60,45,30,15,0],h=[[1.410526172116255E-8,
8.98305509648872E-6,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-0.03801003308653,1.73379812E7],[-7.435856389565537E-9,8.983055097726239E-6,-0.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,1.026014486E7],[-3.030883460898826E-8,8.98305509983578E-6,0.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,0.32710905363475,
6856817.37],[-1.981981304930552E-8,8.983055099779535E-6,0.03278182852591,40.31678527705744,0.65659298677277,-4.44255534477492,0.85341911805263,0.12923347998204,-0.04625736007561,4482777.06],[3.09191371068437E-9,8.983055096812155E-6,6.995724062E-5,23.10934304144901,-2.3663490511E-4,-0.6321817810242,-0.00663494467273,0.03430082397953,-0.00466043876332,2555164.4],[2.890871144776878E-9,8.983055095805407E-6,-3.068298E-8,7.47137025468032,-3.53937994E-6,-0.02145144861037,-1.234426596E-5,1.0322952773E-4,
-3.23890364E-6,826088.5]],j=[[-0.0015702102444,111320.7020616939,1704480524535203,-10338987376042340,26112667856603880,-35149669176653700,26595700718403920,-10725012454188240,1800819912950474,82.5],[8.277824516172526E-4,111320.7020463578,6.477955746671607E8,-4.082003173641316E9,1.077490566351142E10,-1.517187553151559E10,1.205306533862167E10,-5.124939663577472E9,9.133119359512032E8,67.5],[0.00337398766765,111320.7020202162,4481351.045890365,-2.339375119931662E7,7.968221547186455E7,-1.159649932797253E8,
9.723671115602145E7,-4.366194633752821E7,8477230.501135234,52.5],[0.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-3.441963504368392E-4,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-3.218135878613132E-4,111320.7020701615,0.00369383431289,823725.6402795718,0.46104986909093,2351.343141331292,
1.58060784298199,8.77738589078284,0.37238884252424,7.45]];d.forward=b(function(b,c,d){for(var f=b[d];f>180;)f-=360;for(;f<-180;)f+=360;var b=b[d+1],b=Math.max(b,-74),b=Math.min(b,74),h=null,m;for(m=0;m<g.length;++m)if(b>=g[m]){h=j[m];break}if(h===null)for(m=g.length-1;m>=0;--m)if(b<=-g[m]){h=j[m];break}c[d]=f;c[d+1]=b;e(c,c,d,h)});d.inverse=b(function(b,c,d){for(var g=Math.abs(b[d+1]),j=null,m=0;m<f.length;m++)if(g>=f[m]){j=h[m];break}e(b,c,d,j)})},{"../util":8}],6:[function(b,c,d){d.baiduMercator=
b("./baidu-mercator");d.sphericalMercator=b("./spherical-mercator")},{"./baidu-mercator":5,"./spherical-mercator":7}],7:[function(b,c,d){var b=b("../util").forEachPoint,e=Math.PI/180;d.forward=b(function(b,c,d){var j=Math.sin(Math.max(Math.min(85.0511287798,b[d+1]),-85.0511287798)*e);c[d]=6378137*b[d]*e;c[d+1]=6378137*Math.log((1+j)/(1-j))/2});d.inverse=b(function(b,c,d){c[d]=b[d]/6378137/e;c[d+1]=(2*Math.atan(Math.exp(b[d+1]/6378137))-Math.PI/2)/e})},{"../util":8}],8:[function(b,c,d){d.forEachPoint=
function(b){return function(c,d,h){for(var j=c.length,h=h?h:2,d=d?d:h!==2?c.slice():Array(j),l=0;l<j;l+=h)b(c,d,l);return d}}},{}]},{},[4])(4)});if(GeoGlobe)GeoGlobe.Proj4cn=proj4cn;GeoGlobe.ProjAxisOrder={AXIS_ORDER_EN:!0,AXIS_ORDER_NE:!1};
GeoGlobe.ProjAxisOrder.AxisOrder={"EPSG:900913":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,WGS84:GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"IGNF:WGS84G":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4326":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4490":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4269":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:2361":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:27700":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:904490":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,"EPSG:4171":GeoGlobe.ProjAxisOrder.AXIS_ORDER_NE,
"EPSG:32637":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32638":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32639":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32640":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:32641":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:28991":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:28992":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:31300":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:31370":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2176":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2177":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,
"EPSG:2178":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2179":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2180":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2154":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:3346":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:3857":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN,"EPSG:2065":GeoGlobe.ProjAxisOrder.AXIS_ORDER_EN};
GeoGlobe.SpatialReference=GeoGlobe.Class({proj:null,projCode:null,titleRegEx:/\+title=[^\+]*/,initialize:function(a,b){GeoGlobe.Util.extend(this,b);this.projCode=a;if(typeof Proj4js=="object")this.proj=new Proj4js.Proj(a)},getCode:function(){return this.proj?this.proj.srsCode:this.projCode},getUnits:function(){return this.proj?this.proj.units:null},toString:function(){return this.getCode()},equals:function(a){var b=!1;a&&(a instanceof GeoGlobe.SpatialReference||(a=new GeoGlobe.SpatialReference(a)),
typeof Proj4js=="object"&&this.proj.defData&&a.proj.defData?b=this.proj.defData.replace(this.titleRegEx,"")==a.proj.defData.replace(this.titleRegEx,""):a.getCode&&(b=this.getCode(),a=a.getCode(),b=b==a||!!GeoGlobe.SpatialReference.transforms[b]&&GeoGlobe.SpatialReference.transforms[b][a]===GeoGlobe.SpatialReference.nullTransform));return b},destroy:function(){delete this.proj;delete this.projCode},CLASS_NAME:"GeoGlobe.SpatialReference"});GeoGlobe.SpatialReference.transforms={};
GeoGlobe.SpatialReference.defaults={"EPSG:4326":{units:"degrees",maxExtent:[-180,-90,180,90],yx:!0},"CRS:84":{units:"degrees",maxExtent:[-180,-90,180,90]},"EPSG:900913":{units:"m",maxExtent:[-2.003750834E7,-2.003750834E7,2.003750834E7,2.003750834E7]}};
GeoGlobe.SpatialReference.addTransform=function(a,b,c){if(c===GeoGlobe.SpatialReference.nullTransform){var d=GeoGlobe.SpatialReference.defaults[a];d&&!GeoGlobe.SpatialReference.defaults[b]&&(GeoGlobe.SpatialReference.defaults[b]=d)}GeoGlobe.SpatialReference.transforms[a]||(GeoGlobe.SpatialReference.transforms[a]={});GeoGlobe.SpatialReference.transforms[a][b]=c};
GeoGlobe.SpatialReference.transform=function(a,b,c){if(b&&c)if(b instanceof GeoGlobe.SpatialReference||(b=new GeoGlobe.SpatialReference(b)),c instanceof GeoGlobe.SpatialReference||(c=new GeoGlobe.SpatialReference(c)),b.proj&&c.proj)a=Proj4js.transform(b.proj,c.proj,a);else{var b=b.getCode(),c=c.getCode(),d=GeoGlobe.SpatialReference.transforms;if(d[b]&&d[b][c])d[b][c](a)}return a};GeoGlobe.SpatialReference.nullTransform=function(a){return a};
(function(){function a(a){a.x=180*a.x/d;a.y=180/Math.PI*(2*Math.atan(Math.exp(a.y/d*Math.PI))-Math.PI/2);return a}function b(a){a.x=a.x*d/180;a.y=Math.max(-2.003750834E7,Math.min(Math.log(Math.tan((90+a.y)*Math.PI/360))/Math.PI*d,2.003750834E7));return a}function c(c,d){var e=GeoGlobe.SpatialReference.addTransform,f=GeoGlobe.SpatialReference.nullTransform,g,q,r,m,p;g=0;for(q=d.length;g<q;++g){r=d[g];e(c,r,b);e(r,c,a);for(p=g+1;p<q;++p)m=d[p],e(r,m,f),e(m,r,f)}}var d=2.003750834E7,e=["EPSG:900913",
"EPSG:3857","EPSG:102113","EPSG:102100"],f=["CRS:84","urn:ogc:def:crs:EPSG:6.6:4326","EPSG:4326"],g;for(g=e.length-1;g>=0;--g)c(e[g],f);for(g=f.length-1;g>=0;--g)c(f[g],e)})();
GeoGlobe.String={startsWith:function(a,b){return a.indexOf(b)==0},contains:function(a,b){return a.indexOf(b)!=-1},trim:function(a){return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},camelize:function(a){for(var a=a.split("-"),b=a[0],c=1,d=a.length;c<d;c++){var e=a[c];b+=e.charAt(0).toUpperCase()+e.substring(1)}return b},format:function(a,b,c){b||(b=window);return a.replace(GeoGlobe.String.tokenRegEx,function(a,e){for(var f,g=e.split(/\.+/),h=0;h<g.length;h++){h==0&&(f=b);if(f===void 0)break;f=f[g[h]]}typeof f==
"function"&&(f=c?f.apply(null,c):f());return typeof f=="undefined"?"undefined":f})},tokenRegEx:/\$\{([\w.]+?)\}/g,numberRegEx:/^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/,isNumeric:function(a){return GeoGlobe.String.numberRegEx.test(a)},numericIf:function(a,b){var c=a;b===!0&&a!=null&&a.replace&&(a=a.replace(/^\s*|\s*$/g,""));return GeoGlobe.String.isNumeric(a)?parseFloat(a):c}};
GeoGlobe.Number={decimalSeparator:".",thousandsSeparator:",",limitSigDigs:function(a,b){var c=0;b>0&&(c=parseFloat(a.toPrecision(b)));return c},format:function(a,b,c,d){b=typeof b!="undefined"?b:0;c=typeof c!="undefined"?c:GeoGlobe.Number.thousandsSeparator;d=typeof d!="undefined"?d:GeoGlobe.Number.decimalSeparator;b!=null&&(a=parseFloat(a.toFixed(b)));var e=a.toString().split(".");e.length==1&&b==null&&(b=0);a=e[0];if(c)for(var f=/(-?[0-9]+)([0-9]{3})/;f.test(a);)a=a.replace(f,"$1"+c+"$2");b==0?
b=a:(c=e.length>1?e[1]:"0",b!=null&&(c+=Array(b-c.length+1).join("0")),b=a+d+c);return b},zeroPad:function(a,b,c){for(a=a.toString(c||10);a.length<b;)a="0"+a;return a}};GeoGlobe.Function={bind:function(a,b){var c=Array.prototype.slice.apply(arguments,[2]);return function(){var d=c.concat(Array.prototype.slice.apply(arguments,[0]));return a.apply(b,d)}},bindAsEventListener:function(a,b){return function(c){return a.call(b,c||window.event)}},False:function(){return!1},True:function(){return!0},Void:function(){}};
GeoGlobe.Array={filter:function(a,b,c){var d=[];if(Array.prototype.filter)d=a.filter(b,c);else{var e=a.length;if(typeof b!="function")throw new TypeError;for(var f=0;f<e;f++)if(f in a){var g=a[f];b.call(c,g,f,a)&&d.push(g)}}return d}};if(!String.prototype.endsWith)String.prototype.endsWith=function(a,b){var c=this.toString();if(typeof b!=="number"||!isFinite(b)||Math.floor(b)!==b||b>c.length)b=c.length;b-=a.length;c=c.lastIndexOf(a,b);return c!==-1&&c===b};
GeoGlobe.Pixel=GeoGlobe.Class4OL({x:0,y:0,initialize:function(a,b){this.x=parseFloat(a);this.y=parseFloat(b)},toString:function(){return"x="+this.x+",y="+this.y},clone:function(){return new GeoGlobe.Pixel(this.x,this.y)},equals:function(a){var b=!1;a!=null&&(b=this.x==a.x&&this.y==a.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(a.x)&&isNaN(a.y));return b},distanceTo:function(a){return Math.sqrt(Math.pow(this.x-a.x,2)+Math.pow(this.y-a.y,2))},add:function(a,b){if(a==null||b==null)throw new TypeError("Pixel.add cannot receive null values");
return new GeoGlobe.Pixel(this.x+a,this.y+b)},offset:function(a){var b=this.clone();a&&(b=this.add(a.x,a.y));return b},CLASS_NAME:"GeoGlobe.Pixel"});GeoGlobe.Size=GeoGlobe.Class4OL({w:0,h:0,initialize:function(a,b){this.w=parseFloat(a);this.h=parseFloat(b)},toString:function(){return"w="+this.w+",h="+this.h},clone:function(){return new GeoGlobe.Size(this.w,this.h)},equals:function(a){var b=!1;a!=null&&(b=this.w==a.w&&this.h==a.h||isNaN(this.w)&&isNaN(this.h)&&isNaN(a.w)&&isNaN(a.h));return b},CLASS_NAME:"GeoGlobe.Size"});
GeoGlobe.Date={dateRegEx:/^(?:(\d{4})(?:-(\d{2})(?:-(\d{2}))?)?)?(?:(?:T(\d{1,2}):(\d{2}):(\d{2}(?:\.\d+)?)(Z|(?:[+-]\d{1,2}(?::(\d{2}))?)))|Z)?$/,toISOString:function(){return"toISOString"in Date.prototype?function(a){return a.toISOString()}:function(a){return isNaN(a.getTime())?"Invalid Date":a.getUTCFullYear()+"-"+GeoGlobe.Number.zeroPad(a.getUTCMonth()+1,2)+"-"+GeoGlobe.Number.zeroPad(a.getUTCDate(),2)+"T"+GeoGlobe.Number.zeroPad(a.getUTCHours(),2)+":"+GeoGlobe.Number.zeroPad(a.getUTCMinutes(),
2)+":"+GeoGlobe.Number.zeroPad(a.getUTCSeconds(),2)+"."+GeoGlobe.Number.zeroPad(a.getUTCMilliseconds(),3)+"Z"}}(),parse:function(a){var b;if((a=a.match(this.dateRegEx))&&(a[1]||a[7])){b=parseInt(a[1],10)||0;var c=parseInt(a[2],10)-1||0,d=parseInt(a[3],10)||1;b=new Date(Date.UTC(b,c,d));if(c=a[7]){var d=parseInt(a[4],10),e=parseInt(a[5],10),f=parseFloat(a[6]),g=f|0;b.setUTCHours(d,e,g,Math.round(1E3*(f-g)));c!=="Z"&&(c=parseInt(c,10),a=parseInt(a[8],10)||0,b=new Date(b.getTime()+-1E3*(60*c*60+a*60)))}}else b=
new Date("invalid");return b}};GeoGlobe.Console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){},userError:function(a){alert(a)},assert:function(){},dir:function(){},dirxml:function(){},trace:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){},profile:function(){},profileEnd:function(){},count:function(){},CLASS_NAME:"GeoGlobe.Console"};
(function(){for(var a=document.getElementsByTagName("script"),b=0,c=a.length;b<c;++b)if(a[b].src.indexOf("firebug.js")!=-1&&console){GeoGlobe.Util.extend(GeoGlobe.Console,console);break}})();GeoGlobe.ProxyHost="";GeoGlobe.timeout=0;if(!GeoGlobe.Request)GeoGlobe.Request={};
GeoGlobe.Util.extend(GeoGlobe.Request,{DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:void 0,password:void 0,params:null,proxy:GeoGlobe.ProxyHost,timeout:GeoGlobe.timeout,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,makeSameOrigin:function(a,b){var c=a.indexOf("http")!==0,d=!c&&a.match(this.URL_SPLIT_REGEX);if(d){var e=window.location,c=d[1]==e.protocol&&d[3]==e.hostname,
d=d[4],e=e.port;if(d!=80&&d!=""||e!="80"&&e!="")c=c&&d==e}c||b&&(a=typeof b=="function"?b(a):a.indexOf("cts?")>=0?b+a:b+encodeURIComponent(a));return a},issue:function(a){var b=GeoGlobe.Util.extend(this.DEFAULT_CONFIG,{proxy:GeoGlobe.ProxyHost,timeout:GeoGlobe.timeout}),a=a||{};a.headers=a.headers||{};a=GeoGlobe.Util.applyDefaults(a,b);a.headers=GeoGlobe.Util.applyDefaults(a.headers,b.headers);var b=!1,c;for(c in a.headers)a.headers.hasOwnProperty(c)&&c.toLowerCase()==="x-requested-with"&&(b=!0);
b===!1&&(a.headers["X-Requested-With"]="XMLHttpRequest");var d=new GeoGlobe.Request.XMLHttpRequest;a.url=encodeURI(a.url);var e=GeoGlobe.Util.urlAppend(a.url,GeoGlobe.Util.getParameterString(a.params||{})),e=GeoGlobe.Request.makeSameOrigin(e,a.proxy);d.open(a.method,e,a.async,a.user,a.password);for(var f in a.headers)/*d.setRequestHeader(f,a.headers[f]);*/var g=this;d.onreadystatechange=function(){d.readyState==GeoGlobe.Request.XMLHttpRequest.DONE&&null!==!1&&g.runCallbacks({request:d,config:a,requestUrl:e})};
a.async&&d.setTimeout(a.timeout);a.async===!1?d.send(a.data):window.setTimeout(function(){d.readyState!==0&&d.send(a.data)},0);return d},runCallbacks:function(a){var b=a.request,a=a.config,c=a.scope?GeoGlobe.Function.bind(a.callback,a.scope):a.callback,d;a.success&&(d=a.scope?GeoGlobe.Function.bind(a.success,a.scope):a.success);var e;a.failure&&(e=a.scope?GeoGlobe.Function.bind(a.failure,a.scope):a.failure);if(GeoGlobe.Util.createUrlObject(a.url).protocol=="file:"&&b.responseText)b.status=200;c(b);
(!b.status||b.status>=200&&b.status<300)&&d&&d(b);b.status&&(b.status<200||b.status>=300)&&e&&e(b)},GET:function(a){a=GeoGlobe.Util.extend(a,{method:"GET"});return GeoGlobe.Request.issue(a)},POST:function(a){a=GeoGlobe.Util.extend(a,{method:"POST"});a.headers=a.headers?a.headers:{};"CONTENT-TYPE"in GeoGlobe.Util.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml");return GeoGlobe.Request.issue(a)},PUT:function(a){a=GeoGlobe.Util.extend(a,{method:"PUT"});a.headers=a.headers?a.headers:
{};"CONTENT-TYPE"in GeoGlobe.Util.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml");return GeoGlobe.Request.issue(a)},DELETE:function(a){a=GeoGlobe.Util.extend(a,{method:"DELETE"});return GeoGlobe.Request.issue(a)},HEAD:function(a){a=GeoGlobe.Util.extend(a,{method:"HEAD"});return GeoGlobe.Request.issue(a)},OPTIONS:function(a){a=GeoGlobe.Util.extend(a,{method:"OPTIONS"});return GeoGlobe.Request.issue(a)}});
GeoGlobe.nullHandler=function(a){GeoGlobe.Console.userError(GeoGlobe.i18n("unhandledRequest",{statusText:a.statusText}))};GeoGlobe.loadURL=function(a,b,c,d,e){typeof b=="string"&&(b=GeoGlobe.Util.getParameters(b));return GeoGlobe.Request.GET({url:a,params:b,success:d?d:GeoGlobe.nullHandler,failure:e?e:GeoGlobe.nullHandler,scope:c})};GeoGlobe.Request.setProxyHost=function(a){GeoGlobe.ProxyHost=a};GeoGlobe.Request.getProxyHost=function(){return GeoGlobe.ProxyHost};
GeoGlobe.Request.setTimeout=function(a){GeoGlobe.timeout=a};GeoGlobe.appendToProxy=function(a){var a=a.split("?"),b=GeoGlobe.ProxyHost+encodeURI(encodeURI(a[0]));a.length===2&&(b+="?"+a[1]);return b};GeoGlobe.loadScript=function(a){GeoGlobe.Request.GET({url:a,async:!1,headers:{Accept:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"},success:function(a){GeoGlobe.Util.globalEval(a.responseText)},failure:function(){alert("\u52a0\u8f7d:"+a+" \u5931\u8d25\u3002")}})};
(function(){function a(){this._object=f&&!j?new f:new window.ActiveXObject("Microsoft.XMLHTTP");this._listeners=[]}function b(){return new a}function c(a){b.onreadystatechange&&b.onreadystatechange.apply(a);a.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function d(a){try{a.responseText=a._object.responseText}catch(b){}try{var c;var d=a._object,e=d.responseXML,f=d.responseText;if(h&&f&&e&&!e.documentElement&&d.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/))e=
new window.ActiveXObject("Microsoft.XMLDOM"),e.async=!1,e.validateOnParse=!1,e.loadXML(f);c=e&&(h&&e.parseError!=0||!e.documentElement||e.documentElement&&e.documentElement.tagName=="parsererror")?null:e;a.responseXML=c}catch(g){}try{a.status=a._object.status}catch(j){}try{a.statusText=a._object.statusText}catch(s){}}function e(a){a._object.onreadystatechange=new window.Function}var f=window.XMLHttpRequest,g=!!window.controllers,h=window.document.all&&!window.opera,j=h&&window.navigator.userAgent.match(/MSIE 7.0/);
b.prototype=a.prototype;if(g&&f.wrapped)b.wrapped=f.wrapped;b.UNSENT=0;b.OPENED=1;b.HEADERS_RECEIVED=2;b.LOADING=3;b.DONE=4;b.prototype.readyState=b.UNSENT;b.prototype.responseText="";b.prototype.responseXML=null;b.prototype.status=0;b.prototype.statusText="";b.prototype.priority="NORMAL";b.prototype.onreadystatechange=null;b.onreadystatechange=null;b.onopen=null;b.onsend=null;b.onabort=null;b.prototype.open=function(a,f,j,q,r){delete this._headers;arguments.length<3&&(j=!0);this._async=j;var m=this,
p=this.readyState,t;h&&j&&(t=function(){p!=b.DONE&&(e(m),m.abort())},window.attachEvent("onunload",t));b.onopen&&b.onopen.apply(this,arguments);arguments.length>4?this._object.open(a,f,j,q,r):arguments.length>3?this._object.open(a,f,j,q):this._object.open(a,f,j);try{this._object.responseType="msxml-document"}catch(s){}this.readyState=b.OPENED;c(this);this._object.onreadystatechange=function(){if(!g||j)m.readyState=m._object.readyState,d(m),m._aborted?m.readyState=b.UNSENT:(m.readyState==b.DONE&&(delete m._data,
e(m),h&&j&&window.detachEvent("onunload",t)),p!=m.readyState&&c(m),p=m.readyState)}};b.prototype.setTimeout=function(a){this._object.timeout=a};b.prototype.send=function(a){b.onsend&&b.onsend.apply(this,arguments);arguments.length||(a=null);a&&a.nodeType&&(a=window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):a.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml"));this._data=a;this._object.send(this._data);if(g&&!this._async){this.readyState=
b.OPENED;for(d(this);this.readyState<b.DONE;)if(this.readyState++,c(this),this._aborted)break}};b.prototype.abort=function(){b.onabort&&b.onabort.apply(this,arguments);if(this.readyState>b.UNSENT)this._aborted=!0;this._object.abort();e(this);this.readyState=b.UNSENT;delete this._data};b.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()};b.prototype.getResponseHeader=function(a){return this._object.getResponseHeader(a)};b.prototype.setRequestHeader=function(a,b){if(!this._headers)this._headers=
{};this._headers[a]=b;return this._object.setRequestHeader(a,b)};b.prototype.addEventListener=function(a,b,c){for(var d=0,e;e=this._listeners[d];d++)if(e[0]==a&&e[1]==b&&e[2]==c)return;this._listeners.push([a,b,c])};b.prototype.removeEventListener=function(a,b,c){for(var d=0,e;e=this._listeners[d];d++)if(e[0]==a&&e[1]==b&&e[2]==c)break;e&&this._listeners.splice(d,1)};b.prototype.dispatchEvent=function(a){a={type:a.type,target:this,currentTarget:this,eventPhase:2,bubbles:a.bubbles,cancelable:a.cancelable,
timeStamp:a.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};a.type=="readystatechange"&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[a]);for(var b=0,c;c=this._listeners[b];b++)c[0]==a.type&&!c[2]&&(c[1].handleEvent||c[1]).apply(this,[a])};b.prototype.toString=function(){return"[object XMLHttpRequest]"};b.toString=function(){return"[XMLHttpRequest]"};if(!window.Function.prototype.apply)window.Function.prototype.apply=
function(a,b){b||(b=[]);a.__func=this;a.__func(b[0],b[1],b[2],b[3],b[4]);delete a.__func};if(!GeoGlobe.Request)GeoGlobe.Request={};GeoGlobe.Request.XMLHttpRequest=b})();
GeoGlobe.Map=GeoGlobe.Class(mapboxgl.FreeCRSMap,{pitch3Dzoom:16,is3Dpitching:!0,isAttributionControl:!0,isScrollZoom:!0,isBooxZoom:!0,isDragRotate:!0,isDragPan:!0,isKeyboard:!0,isDoubleClickZoom:!0,isTouchZoomRotate:!0,isTrackResize:!0,epsg:"EPSG:3857",units:null,initialize:function(a){this.options=a;if(a.isAttributionControl==!1)a.attributionControl=a.isAttributionControl;if(a.isScrollZoom==!1)a.scrollZoom=a.isScrollZoom;if(a.isBooxZoom==!1)a.boxZoom=a.isBooxZoom;if(a.isDragRotate==!1)a.dragRotate=
a.isDragRotate;if(a.isDragPan==!1)a.dragPan=a.isDragPan;if(a.isKeyboard==!1)a.keyboard=a.isKeyboard;if(a.isDoubleClickZoom==!1)a.doubleClickZoom=a.isDoubleClickZoom;if(a.isTouchZoomRotate==!1)a.touchZoomRotate=a.isTouchZoomRotate;if(a.isTrackResize==!1)a.trackResize=a.isTrackResize;if(!a.epsg)a.epsg="EPSG:3857";if(!a.units)a.units="degrees";if(!a.isConstrain)a.isConstrain=!1;this.map=new mapboxgl.FreeCRSMap(a);if(window.GeoGlobe&&a.mapCRS)window.GeoGlobe.MapOptions={map:this.map,topTileExtent:a.mapCRS.topTileExtent,
units:a.units};this.map.epsg=a.epsg;this.map.units=a.units;this.map.setIsConstrain(a.isConstrain);this.map.pitch3Dzoom=this.options.pitch3Dzoom?this.options.pitch3Dzoom:16;this.map.setIs3DPZoom(this.options.is3Dpitching);return this.map},CLASS_NAME:"GeoGlobe.Map"});mapboxgl.FreeCRSMap.prototype.addCanvasLayer=function(a){a.addTo(this)};mapboxgl.FreeCRSMap.prototype.removeCanvasLayer=function(a){a.remove()};
mapboxgl.FreeCRSMap.prototype.setIs3DPZoom=function(a){if(a)this.on("zoom",this.setZoompitch);else this.off("zoom",this.setZoompitch)};mapboxgl.FreeCRSMap.prototype.set3Dzoom=function(a){if(a)this.pitch3Dzoom=a};mapboxgl.FreeCRSMap.prototype.setZoompitch=function(){var a=this.getZoom(),b=this.pitch3Dzoom;parseInt(a)==b&&this.setPitch(60)};mapboxgl.FreeCRSMap.prototype.addLayers=function(a){if(a.length>0)for(var b=0;b<a.length;b++)this.addLayer(a[b])};
mapboxgl.FreeCRSMap.prototype.getResolutions=function(){for(var a=[],b=0;b<=20;b++)a.push(this.getResolutionForLevel(b));return a};mapboxgl.FreeCRSMap.prototype.getResolutionForLevel=function(a,b){var c=Math.abs(this._tileExtent[2]-this._tileExtent[0]);c===360&&(c=4.00750166855784E7);return c/(b?b:256)/Math.pow(2,a)};mapboxgl.FreeCRSMap.prototype.setIsConstrain=function(a){this.isConstrain=a;this.transform._constraining=!this.isConstrain};
mapboxgl.FreeCRSMap.prototype.addLayer=function(a,b){if(a.CLASS_NAME==="GeoGlobe.Layer.VTS"||a.layerType==="VTS"){var c=a,d=c.layers;this.addSource(c.source_id,c.source);if(d.length>0)for(c=0;c<d.length;c++)this.addLayer(d[c]);return this}if(a.CLASS_NAME==="GeoGlobe.Layer.MultidateVTS"){c=a;d=c.layers;this.addSource(c.source_id,c.source);if(d.length>0)for(c=0;c<d.length;c++)this.addLayer(d[c]);return this}if(a.layerOption&&a.layerOption.metadata.type==="wms"&&a.layerOption.metadata.isTile===!1)return a.addTo(this),
this.style.addLayer(a.layerOption,b),this._update(!0),this;if(a.layerOption&&a.layerOption.metadata.type==="hotarea")return a.addTo(this),this;if(typeof a.source==="object"&&this._mapCRS&&a.source&&a.source.type=="geojson"&&a.source.data&&!a.source.data.customprj&&(a.source.data.customprj=this._geojson_customprj,this._geojson_customprj_custompyramid))a.source.data.customprj_custompyramid=this._geojson_customprj_custompyramid;this.style.addLayer(a,b);this._update(!0);return this};
mapboxgl.FreeCRSMap.prototype.removeLayerAndSource=function(a){if(this.getLayer(a))this.removeLayer(a),this.removeSource(a);else throw Error("Layer not found");};mapboxgl.FreeCRSMap.prototype.loadSprite=function(a,b){this.style._loadSprite(a,b)};mapboxgl.FreeCRSMap.prototype.removeAllImages=function(){var a=this.style.imageManager,b;for(b in a.images)a.removeImage(b)};mapboxgl.FreeCRSMap.prototype.removeAllLayers=function(){var a=this.style._layers,b;for(b in a)this.removeLayer(b)};
mapboxgl.FreeCRSMap.prototype.removeAllSources=function(){var a=this.style.sourceCaches,b;for(b in a)this.removeSource(b)};
mapboxgl.FreeCRSMap.prototype.moveLayerContainer=function(a,b){if(this.getLayerContainer(a)){var c=[];this.eleContainer.childNodes.forEach(function(a){c.push(a.className)});var d=c.indexOf(a);c.splice(d,1);d=b?c.indexOf(b):c.length;if(b&&d===-1)this.fire("error",{error:Error('layer_container with id "'+b+'" does not exist on this map.')});else{c.splice(d,0,a);for(d=0;d<c.length;d++)for(var e=0;e<this.eleContainer.childNodes.length;e++)if(c[d]===this.eleContainer.childNodes[e].className)this.eleContainer.childNodes[e].style.zIndex=
d}}else this.fire("error",{error:Error("The layer_container '"+a+"' does not exist in the map's style and cannot be moved.")})};mapboxgl.FreeCRSMap.prototype.getLayerContainer=function(a){for(var b=0;b<this.eleContainer.childNodes.length;b++)if(a===this.eleContainer.childNodes[b].className)return this.eleContainer.childNodes[b]};
mapboxgl.FreeCRSMap.prototype.getLayer=function(a){var b=this.style.getLayer(a);if(!b&&this._visuals)for(var c=0;c<this._visuals.length;c++)if(b=this._visuals[c].getLayer(a))break;return b};
mapboxgl.FreeCRSMap.prototype.moveLayer=function(a,b){var c=this.getLayer(a),d=this.getLayer(b);if(c)if(b&&!d)this.fire("error",{error:Error("\u56fe\u5c42'"+b+"'\u4e0d\u5b58\u5728\u3002")});else if(!c._parent&&(!d||!d._parent))return this.style.moveLayer(a,b),this._update(!0),this;else if(c._parent&&(!d||d._parent))if(!d||c._parent.type===d._parent.type)return c._parent.moveLayer(a,b),this;else this.fire("error",{error:Error("\u6682\u4e0d\u652f\u6301\u4e0d\u540c\u7c7b\u522b\u53ef\u89c6\u5316\u56fe\u5c42\u95f4\u7684\u79fb\u52a8\u3002")});
else this.fire("error",{error:Error("\u6682\u4e0d\u652f\u6301mapbox\u56fe\u5c42\u4e0e\u53ef\u89c6\u5316\u56fe\u5c42\u95f4\u7684\u79fb\u52a8\u3002")});else this.fire("error",{error:Error(a?"\u56fe\u5c42'"+a+"'\u4e0d\u5b58\u5728\uff0c\u56e0\u6b64\u4e0d\u80fd\u88ab\u79fb\u52a8\u3002":"\u56fe\u5c42ID\u4e0d\u80fd\u4e3a\u7a7a\u3002")})};
mapboxgl.FreeCRSMap.prototype.removeLayer=function(a){var b=this.getLayer(a);if(b)return b._parent?b._parent.removeLayer(a):(this.style.removeLayer(a),this._update(!0)),this;else this.fire("error",{error:Error(a?"\u56fe\u5c42'"+a+"'\u4e0d\u5b58\u5728\uff0c\u56e0\u6b64\u4e0d\u80fd\u88ab\u79fb\u9664\u3002":"\u56fe\u5c42ID\u4e0d\u80fd\u4e3a\u7a7a\u3002")})};GeoGlobe.LngLatBounds=mapboxgl.LngLatBounds;mapboxgl.LngLatBounds.prototype.clone=function(){return new mapboxgl.LngLatBounds(this._sw,this._ne)};
mapboxgl.LngLatBounds.prototype.contains=function(a,b,c){c==null&&(c=!0);if(a==null||b==null)return!1;var a=GeoGlobe.Util.toFloat(a),b=GeoGlobe.Util.toFloat(b),d=!1;return d=c?a>=this._sw.lng&&a<=this._ne.lng&&b>=this._sw.lat&&b<=this._ne.lat:a>this._sw.lng&&a<this._ne.lng&&b>this._sw.lat&&b<this._ne.lat};mapboxgl.LngLatBounds.prototype.getWidth=function(){return this._ne.lng-this._sw.lng};
mapboxgl.LngLatBounds.prototype.containsLonLat=function(a,b){typeof b==="boolean"&&(b={inclusive:b});var b=b||{},c=this.contains(a.lng,a.lat,b.inclusive),d=b.worldBounds;d&&!c&&(c=d.getWidth(),c=this.containsLonLat({lng:a.lng-Math.round((a.lng-(d._sw.lng+d._ne.lng)/2)/c)*c,lat:a.lat},{inclusive:b.inclusive}));return c};mapboxgl.LngLatBounds.prototype.equals=function(a){var b=!1;a!=null&&(b=this._sw.lng==a._sw.lng&&this._ne.lng==a._ne.lng&&this._ne.lat==a._ne.lat&&this._sw.lat==a._sw.lat);return b};
mapboxgl.LngLatBounds.prototype.toBBOX=function(a,b){a==null&&(a=6);var c=Math.pow(10,a),d=Math.round(this._sw.lng*c)/c,e=Math.round(this._sw.lat*c)/c,f=Math.round(this._ne.lng*c)/c,c=Math.round(this._ne.lat*c)/c;return b===!0?e+","+d+","+c+","+f:d+","+e+","+f+","+c};
mapboxgl.LngLatBounds.prototype.toGeometry=function(){return new GeoGlobe.Geometry.Polygon([new GeoGlobe.Geometry.LinearRing([new GeoGlobe.Geometry.Point(this._sw.lng,this._sw.lat),new GeoGlobe.Geometry.Point(this._ne.lng,this._sw.lat),new GeoGlobe.Geometry.Point(this._ne.lng,this._ne.lat),new GeoGlobe.Geometry.Point(this._sw.lng,this._ne.lat)])])};
mapboxgl.LngLatBounds.prototype.getCenterLonLat=function(){if(!this.centerLonLat)this.centerLonLat=new GeoGlobe.LngLat((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2);return this.centerLonLat};mapboxgl.LngLatBounds.prototype.CLASS_NAME="GeoGlobe.LngLatBounds";GeoGlobe.LngLatBounds.fromString=function(a,b){var c=a.split(",");return GeoGlobe.LngLatBounds.fromArray(c,b)};
GeoGlobe.LngLatBounds.fromArray=function(a,b){return b===!0?new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(a[1],a[0]),new GeoGlobe.LngLat(a[3],a[2])):new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(a[0],a[1]),new GeoGlobe.LngLat(a[2],a[3]))};
GeoGlobe.LngLatBounds.toGeometryByTwoPixel=function(a,b,c){for(var a=[mapboxgl.Point.convert(a),mapboxgl.Point.convert(b)],a=[a[0],new mapboxgl.Point(a[1].x,a[0].y),a[1],new mapboxgl.Point(a[0].x,a[1].y)],b=[],d=0;d<a.length;d++){var e=c.unproject(a[d]),e=new GeoGlobe.Geometry.Point(e.lng,e.lat);b.push(e)}return new GeoGlobe.Geometry.Polygon([new GeoGlobe.Geometry.LinearRing(b)])};GeoGlobe.LngLat=mapboxgl.LngLat;
GeoGlobe.Layer=GeoGlobe.Class(mapboxgl.FreeCRSMap,{initialize:function(){return this},CLASS_NAME:"GeoGlobe.Layer"});
GeoGlobe.Layer.WMTS=GeoGlobe.Class4OL({url:null,layer:null,format:null,matrixSet:null,style:null,name:null,resolutions:null,zoomOffset:null,matrixIds:null,tileOrigin:null,tileFullExtent:null,initialize:function(a){return this._getWMTSLayer(a)},_getWMTSLayer:function(a){var b={};if(a.layer)b.LAYER=a.layer;if(a.format)b.FORMAT=a.format;if(a.matrixSet)b.TILEMATRIXSET=a.matrixSet;if(a.version)b.VERSION=a.version;if(!a.zoomOffset)a.zoomOffset=0;if(a.style)b.STYLE=a.style;b.TILEMATRIX="{z}";b.TILEROW="{y}";
b.TILECOL="{x}";GeoGlobe.Util.applyDefaults(b,{service:"WMTS",request:"GetTile"});b=this.urlAppend(a.url,this.getParameterString(b||{}));b=GeoGlobe.appendToProxy(b);b.indexOf("tianditu")!==-1&&(b+="&tk="+(a.token||"e90d56e5a09d1767899ad45846b0cefd"));return{id:"wmts_"+a.layer+"_"+GeoGlobe.Util.randomStr(8),type:"raster",source:{type:"raster",tiles:[b],zoomOffset:a.zoomOffset,tileSize:256}}},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d==
"object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},clone:function(a){a==null&&(a=new GeoGlobe.Layer.WMTS(this.id,this.tileSize,this.filter,this.opacity,this.visible,this.name,this.url));return a},getMatrix:function(){var a;if(!this.matrixIds||
this.matrixIds.length===0)a={identifier:this.getIdentifier()};else if("scaleDenominator"in this.matrixIds[0])for(var b=GeoGlobe.METERS_PER_INCH*GeoGlobe.INCHES_PER_UNIT[this.units]*this.getServerResolution()/2.8E-4,c=Number.POSITIVE_INFINITY,d,e=0,f=this.matrixIds.length;e<f;++e)d=Math.abs(1-this.matrixIds[e].scaleDenominator/b),d<c&&(c=d,a=this.matrixIds[e]);else a=this.matrixIds[this.getIdentifier()];return a},CLASS_NAME:"GeoGlobe.Layer.WMTS"});
GeoGlobe.Layer.WMS=GeoGlobe.Class4OL({url:null,layer:null,format:null,version:null,width:256,height:256,SRS:null,initialize:function(a){if(a.isTile!=void 0&&a.isTile===!1)this.layerOption=this._getWMSLayer(a);else return this._getWMSTileLayer(a)},addTo:function(a){this.map=a;this.move=GeoGlobe.Function.bind(GeoGlobe.Util.delayFun(this.moveend,300),this);this.map.on("moveend",this.move);this.width=a.getCanvas().width;this.height=a.getCanvas().height;var b=a.getBounds(),a=b._ne.lng,c=b._ne.lat,d=b._sw.lng,
b=b._sw.lat;this.layerOption.source.url=this.layerOption.source.url.replace("{bbox}",d+","+b+","+a+","+c).replace("{width}",this.width).replace("{height}",this.height);this.layerOption.source.coordinates=[[d,c],[a,c],[a,b],[d,b]]},_getWMSLayer:function(a){a.transparent||a.transparent===!1?this.options.transparent=a.transparent:a.transparent=!0;this.options=a;this.url=a.url;var b=this.getParamString({SERVICE:"WMS",REQUEST:"GetMap",VERSION:a.version,LAYERS:a.layer,styles:a.styles,FORMAT:a.format,TRANSPARENT:a.transparent,
BBOX:"{bbox}",WIDTH:"{width}",HEIGHT:"{height}",SRS:a.SRS}),c="",c=this.url.endsWith("?")?this.url+b:this.url+"?"+b,c=GeoGlobe.appendToProxy(c),b=GeoGlobe.Util.randomStr(10),d={name:a.layer,srs:a.SRS,type:"wms",isTile:a.isTile,format:a.formats};this.id="layer_"+a.layer+"_"+b;return{id:this.id,source:{type:"image",url:c,coordinates:[]},metadata:d,type:"raster"}},_getWMSTileLayer:function(a){var b={};if(a.layer)b.LAYERS=a.layer;if(a.format)b.FORMAT=a.format;b.TRANSPARENT=a.transparent||a.transparent===
!1?a.transparent:!0;if(a.styles)b.styles=a.styles;if(!a.tileSize)a.tileSize=256;b.HEIGHT=a.tileSize;b.WIDTH=a.tileSize;if(a.version)b.VERSION=a.version;if(a.SRS)b.SRS=a.SRS;b.BBOX="{bbox-epsg-3857}";GeoGlobe.Util.applyDefaults(b,{service:"WMS",request:"GetMap"});var c={name:a.layer,srs:a.SRS,bbox:a.bbox,format:a.format},d="wms_"+a.layer+"_"+GeoGlobe.Util.randomStr(8),b=this.urlAppend(a.url,this.getParameterString(b||{})),b=GeoGlobe.appendToProxy(b);return{id:d,type:"raster",source:{type:"raster",
tiles:[b],tileSize:a.tileSize},metadata:c}},moveend:function(){if(this.map.style._layers[this.id]&&(this.map.style._layers[this.id].layout&&this.map.style._layers[this.id].layout.visibility!="none"||this.map.style._layers[this.id].visibility&&this.map.style._layers[this.id].visibility!="none")){var a=this.map.getBounds(),b=a._ne.lng,c=a._ne.lat,d=a._sw.lng,e=a._sw.lat,a=d+","+e+","+b+","+c;this.width=this.map.getCanvas().width;this.height=this.map.getCanvas().height;var f=this.getParameterString({SERVICE:"WMS",
REQUEST:"GetMap",VERSION:this.options.version,LAYERS:this.options.layer,styles:this.options.styles,FORMAT:this.options.format,TRANSPARENT:this.options.transparent,BBOX:a,WIDTH:this.width,HEIGHT:this.height,SRS:this.options.SRS}),a="",a=this.url.endsWith("?")?this.url+f:this.url+"?"+f,a=GeoGlobe.appendToProxy(a),b=[[d,c],[b,c],[b,e],[d,e]],c=this.map.getSource(this.id);c.url=a;c.options.url=a;c.coordinates=b;c.options.coordinates=b;c.isReload=!0;c.load()}},getParameterString:function(a){var b=[],c;
for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},clone:function(a){a==null&&(a=new GeoGlobe.Layer.WMS(this.id,this.tileSize,this.filter,this.opacity,this.visible,
this.name,this.url));return a},getParamString:function(a){var b=[],c;for(c in a){var d=a[c];d!=null&&typeof d!="function"&&b.push(c+"="+d)}return b.join("&")},CLASS_NAME:"GeoGlobe.Layer.WMS"});
GeoGlobe.Layer.VTS=GeoGlobe.Class4OL({url:null,layer:null,format:null,matrixSet:null,style:null,name:null,resolutions:null,zoomOffset:null,matrixIds:null,tileOrigin:null,tileFullExtent:null,initialize:function(a){this.source_id="source_vts_"+GeoGlobe.Util.randomStr(6);this.layers=this._getVTSLayer(a);this.source={type:"vector",tiles:[this.url_tmpl]}},_getVTSLayer:function(a){this.url=a.url;var b={};if(a.layer)b.LAYER=a.layer;if(a.format)b.FORMAT=a.format;if(a.matrixSet)b.TILEMATRIXSET=a.matrixSet;
if(a.version)b.VERSION=a.version;if(a.tileSize)b.WIDTH=a.tileSize,b.HEIGHT=a.tileSize;b.TILEMATRIX="{z}";b.TILEROW="{y}";b.TILECOL="{x}";GeoGlobe.Util.applyDefaults(b,{service:"WMTS",request:"GetTile"});var c=GeoGlobe.ProxyHost+this.urlAppend(a.url,this.getParameterString(b||{}));this.url_tmpl=c;var d="source_vts_"+GeoGlobe.Util.randomStr(6);this.source_id=d;var e=[];this.GetStyle(a.styleName,function(c){var g={sprite:c.sprite?GeoGlobe.ProxyHost+c.sprite:"",glyphs:c.glyphs?GeoGlobe.ProxyHost+c.glyphs:
"",styleName:c.name,layerIdentifier:b.LAYER,matrixSet:b.TILEMATRIXSET,format:b.FORMAT,bbox:a.tileBBox?a.tileBBox:"",minZoom:a.minZoom?a.minZoom:"",maxZoom:a.maxZoom?a.maxZoom:""};if(c.styleData)for(var h=0;h<c.styleData.layers.length;h++)c.styleData.layers[h].metadata=g,c.styleData.layers[h].source=d,e[h]=c.styleData.layers[h];else for(h=0;h<c.layers.length;h++)c.layers[h].source=d,c.layers[h].metadata=g,e[h]=c.layers[h]},function(){alert("WMTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
c+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return e},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},GetStyle:function(a,
b,c){var d=this.url;if(a==""||a==void 0)alert("\u8bf7\u67e5\u770b\u6837\u5f0f\u540d\u79f0\u662f\u5426\u5b58\u5728");else{var e={REQUEST:"GetStyle",SERVICE:"WMTS",VERSION:"1.0.0",STYLENAME:a};c||(c=function(){this.failFn(e.REQUEST)});GeoGlobe.Request.GET({url:d,params:e,scope:this,async:!1,success:function(a){a=a.responseText;if(!a)return c(),!1;a=(new GeoGlobe.Format.JSON).read(a);b(a)},failure:c})}},clone:function(a){a==null&&(a=new GeoGlobe.Layer.VTS(this.id,this.tileSize,this.filter,this.opacity,
this.visible,this.name,this.url));return a},getMatrix:function(){var a;if(!this.matrixIds||this.matrixIds.length===0)a={identifier:this.getIdentifier()};else if("scaleDenominator"in this.matrixIds[0])for(var b=GeoGlobe.METERS_PER_INCH*GeoGlobe.INCHES_PER_UNIT[this.units]*this.getServerResolution()/2.8E-4,c=Number.POSITIVE_INFINITY,d,e=0,f=this.matrixIds.length;e<f;++e)d=Math.abs(1-this.matrixIds[e].scaleDenominator/b),d<c&&(c=d,a=this.matrixIds[e]);else a=this.matrixIds[this.getIdentifier()];return a},
CLASS_NAME:"GeoGlobe.Layer.VTS"});
GeoGlobe.Layer.MultidateVTS=GeoGlobe.Class4OL({url:null,layer:null,format:null,matrixSet:null,style:null,name:null,resolutions:null,zoomOffset:null,matrixIds:null,tileOrigin:null,tileFullExtent:null,initialize:function(a){this.source_id="source_MultidateVTS_"+GeoGlobe.Util.randomStr(6);this.layers=this._getMultidateVTSLayer(a);if(a.format!=="protobuf")return this.layers;this.source={type:"vector",tiles:[this.url_tmpl]}},_getMultidateVTSLayer:function(a){this.url=a.url;var b={};if(a.layer)b.LAYER=
a.layer;if(a.format)b.FORMAT=a.format;if(a.matrixSet)b.TILEMATRIXSET=a.matrixSet;if(a.version)b.VERSION=a.version;if(a.format!=="protobuf"&&a.styleName)b.STYLENAME=a.styleName;if(a.time)b.TIME=a.time;if(a.useRecent)b.USERECENT=a.useRecent;if(a.tileSize)b.WIDTH=a.tileSize,b.HEIGHT=a.tileSize;b.TILEMATRIX="{z}";b.TILEROW="{y}";b.TILECOL="{x}";GeoGlobe.Util.applyDefaults(b,{service:"WMTS",request:"GetTile"});var c=GeoGlobe.ProxyHost+this.urlAppend(a.url,this.getParameterString(b||{}));this.url_tmpl=
c;if(b.FORMAT!=="protobuf")return{id:"geowmts",type:"raster",source:{type:"raster",tiles:[this.url_tmpl],tileSize:256},maxzoom:22,minzoom:0};var d="source_MultidateVTS_"+GeoGlobe.Util.randomStr(6);this.source_id=d;var e=[];this.GetStyle(a.styleName,function(c){var g={sprite:c.sprite?GeoGlobe.ProxyHost+c.sprite:"",glyphs:c.glyphs?GeoGlobe.ProxyHost+c.glyphs:a.glyphs?GeoGlobe.ProxyHost+a.glyphs+"?SERVICE=FLS&VERSION=1.0&REQUEST=GetFont&FONTNAME={fontstack}&RANGE={range}.pbf":"",styleName:c.name,layerIdentifier:b.LAYER,
matrixSet:b.TILEMATRIXSET,format:b.FORMAT,bbox:a.tileBBox?a.tileBBox:"",minZoom:a.minZoom?a.minZoom:"",maxZoom:a.maxZoom?a.maxZoom:""};if(c.styleData)for(var h=0;h<c.styleData.layers.length;h++)c.styleData.layers[h].metadata=g,c.styleData.layers[h].source=d,e[h]=c.styleData.layers[h];else for(h=0;h<c.layers.length;h++)c.layers[h].source=d,c.layers[h].metadata=g,e[h]=c.layers[h]},function(){alert("WMTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
c+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return e},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},GetStyle:function(a,
b,c){var d=this.url;if(a==""||a==void 0)alert("\u8bf7\u67e5\u770b\u6837\u5f0f\u540d\u79f0\u662f\u5426\u5b58\u5728");else{var e={REQUEST:"GetStyle",SERVICE:"WMTS",VERSION:"1.0.0",STYLENAME:a};c||(c=function(){this.failFn(e.REQUEST)});GeoGlobe.Request.GET({url:d,params:e,scope:this,async:!1,success:function(a){a=a.responseText;if(!a)return c(),!1;a=(new GeoGlobe.Format.JSON).read(a);b(a)},failure:c})}},clone:function(a){a==null&&(a=new GeoGlobe.Layer.MultidateVTS(this.id,this.tileSize,this.filter,this.opacity,
this.visible,this.name,this.url));return a},getMatrix:function(){var a;if(!this.matrixIds||this.matrixIds.length===0)a={identifier:this.getIdentifier()};else if("scaleDenominator"in this.matrixIds[0])for(var b=GeoGlobe.METERS_PER_INCH*GeoGlobe.INCHES_PER_UNIT[this.units]*this.getServerResolution()/2.8E-4,c=Number.POSITIVE_INFINITY,d,e=0,f=this.matrixIds.length;e<f;++e)d=Math.abs(1-this.matrixIds[e].scaleDenominator/b),d<c&&(c=d,a=this.matrixIds[e]);else a=this.matrixIds[this.getIdentifier()];return a},
CLASS_NAME:"GeoGlobe.Layer.MultidateVTS"});
GeoGlobe.Layer.Export=GeoGlobe.Class4OL({url:null,f:null,format:null,size:256,transparent:!0,initialize:function(a){return this._getExportTileLayer(a)},_getExportTileLayer:function(a){DEFAULT_PARAMS={};var b={BBOX:"{bbox-epsg-3857}"};b.format=a.format?a.format:"image/png";b.transparent=a.transparent||a.transparent===!1?a.transparent:!0;b.f=a.f?a.f:"image";b.size=a.size?a.size+","+a.size:"256,256";GeoGlobe.Util.applyDefaults(b,DEFAULT_PARAMS);var c={url:a.url,transparent:b.transparent,size:b.size,
bbox:b.BBOX,format:b.format,f:b.f},a=this.urlAppend(a.url,this.getParameterString(b||{})),a=GeoGlobe.appendToProxy(a);return{id:"GEO_ARCGIS_EXPORT",type:"raster",source:{type:"raster",tiles:[a],tileSize:b.size.split(",")[0]*1},metadata:c}},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+
"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},CLASS_NAME:"GeoGlobe.Layer.Export"});
GeoGlobe.Layer.WMS_=GeoGlobe.Class(GeoGlobe.Layer,{id:null,name:null,tileSize:256,url:null,filter:null,opacity:0,visible:!0,maxZoom:20,minZoom:0,initialize:function(a){return{id:a.id,layer:{id:a.id,type:"raster",source:a.id},source:{type:"raster",tiles:a.url,tileSize:256}}},getTileUrl:function(){return this.url},clone:function(a){a==null&&(a=new GeoGlobe.Layer.WMS_(this.id,this.tileSize,this.filter,this.opacity,this.visible,this.maxZoom,this.minZoom,this.name,this.url));return a},CLASS_NAME:"GeoGlobe.Layer.WMS_"});
GeoGlobe.Layer.WMTS_=GeoGlobe.Class(GeoGlobe.Layer,{id:null,name:null,matrixSet:null,matrixIds:null,tileFullExtent:null,tileSize:256,url:null,filter:null,opacity:0,visible:!0,initialize:function(a){a={id:a.id,layer:{id:a.id,type:"raster",source:a.id},source:{type:"raster",tiles:a.url,tileSize:256}};if(this.matrixIds){var b=this.matrixIds.length;if(b&&typeof this.matrixIds[0]==="string"){var c=this.matrixIds;this.matrixIds=Array(b);for(var d=0;d<b;++d)this.matrixIds[d]={identifier:c[d]}}}return a},
getTileUrl:function(){return this.url},clone:function(a){a==null&&(a=new GeoGlobe.Layer.WMTS_(this.id,this.tileSize,this.filter,this.opacity,this.visible,this.name,this.url));return a},getMatrix:function(){var a;if(!this.matrixIds||this.matrixIds.length===0)a={identifier:this.getIdentifier()};else if("scaleDenominator"in this.matrixIds[0])for(var b=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.getServerResolution()/2.8E-4,c=Number.POSITIVE_INFINITY,d,e=0,f=this.matrixIds.length;e<
f;++e)d=Math.abs(1-this.matrixIds[e].scaleDenominator/b),d<c&&(c=d,a=this.matrixIds[e]);else a=this.matrixIds[this.getIdentifier()];return a},CLASS_NAME:"GeoGlobe.Layer.WMTS_"});
GeoGlobe.Layer.GeoTileLayer=GeoGlobe.Class(GeoGlobe.Layer,{id:null,tileSize:256,url:null,minzoom:null,maxzoom:null,serviceName:null,accessUrl:null,initialize:function(a){this.url=a.url;var b=[],c;this.extent=a.maxextent;(function(a){var c=a.split("/services/");c[0]&&c[1]?(b.push(c[0]+"/DataServer"),b.push(c[1])):alert("\u89e3\u6790\u670d\u52a1\u5730\u5740\u9519\u8bef:"+a)})(this.url);(function(a){c=a.split(",");for(a=0;a<c.length;a++)c[a]=parseInt(c[a])})(this.extent);return{id:a.id,name:a.name,type:a.type,
source:{type:a.type,tiles:[b[0]+"?T="+b[1]+"&X={x}&Y={y}&L={z}"],tileSize:a.tileSize},maxzoom:parseInt(a.maxzoom),minzoom:parseInt(a.minzoom),paint:{"raster-opacity":a.opacity==null?1:a.opacity},layout:{visibility:a.visibility==null?"visible":a.visibility}}},convertUrl:function(a){var b=a.split("/services/");b[0]&&b[1]?(this.accessUrl=b[0]+"/DataServer",this.serviceName=b[1]):OpenLayers.Console.error("\u89e3\u6790\u670d\u52a1\u5730\u5740\u9519\u8bef:"+a)},selectUrl:function(a,b){return b[a%b.length]},
getDataExtent:function(){if(this.maxExtent)return this.maxExtent.clone()},clone:function(a){return a=new GeoGlobe.Layer.GeoTileLayer(this.name,this.url,this.options)},CLASS_NAME:"GeoGlobe.Layer.GeoTileLayer"});
GeoGlobe.Layer.GeoWMTSLayer=GeoGlobe.Class(GeoGlobe.Layer.WMTS,{id:null,name:null,matrixSet:null,matrixIds:null,tileFullExtent:null,tileSize:256,url:null,filter:null,opacity:0,visible:!0,time:"9999-01-01 00:00:00",userecent:!0,initialize:function(a){return{id:a.id,type:a.type,source:{type:a.type,tiles:[a.url],tileSize:a.tileSize},maxzoom:parseInt(a.maxzoom),minzoom:parseInt(a.minzoom)}},setVerstionTime:function(a){if(a)this.time=this.params.time=a,this.redraw()},setParams:function(a){if(a.time)this.time=
this.params.time=a.time,a=typeof a.userecent=="boolean"?a.userecent:!0,this.userecent=this.params.USERECENT=a,this.redraw()},clone:function(a){a==null&&(a=new GeoGlobe.Layer.GeoWMTSLayer(this.options));new GeoGlobe.Layer.GeoWMTSLayer(this.options);return a},CLASS_NAME:"GeoGlobe.Layer.GeoWMTSLayer"});
GeoGlobe.Layer.VectorTile=GeoGlobe.Class(GeoGlobe.Layer,{id:null,name:null,url:null,filter:null,opacity:0,visible:!0,maxZoom:20,minZoom:0,initialize:function(a){return a},getTileUrl:function(){return this.url},clone:function(a){a==null&&(a=new GeoGlobe.Layer.VectorTile(this.id,this.tileSize,this.filter,this.opacity,this.visible,this.maxZoom,this.minZoom,this.name,this.url));return a},CLASS_NAME:"GeoGlobe.Layer.VectorTile"});
GeoGlobe.Layer.RasterLayer=GeoGlobe.Class(GeoGlobe.Layer,{initialize:function(a){return a},CLASS_NAME:"GeoGlobe.Layer.RasterLayer"});GeoGlobe.Layer.FillLayer=GeoGlobe.Class(GeoGlobe.Layer,{initialize:function(a){return a},CLASS_NAME:"GeoGlobe.Layer.FillLayer"});
GeoGlobe.Layer.CircleLayer=GeoGlobe.Class(GeoGlobe.Layer,{"circle-radius":null,"circle-color":null,"circle-blur":null,"circle-opacity":null,"circle-pitch-scale":null,"circle-translate":null,"circle-translate-anchor":null,initialize:function(a){return a},CLASS_NAME:"GeoGlobe.Layer.CircleLayer"});GeoGlobe.Layer.SymbolLayer=GeoGlobe.Class(GeoGlobe.Layer,{initialize:function(a){return a},CLASS_NAME:"GeoGlobe.Layer.SymbolLayer"});
GeoGlobe.Layer.FillExtrusionLayer=GeoGlobe.Class(GeoGlobe.Layer,{initialize:function(a){return a},CLASS_NAME:"GeoGlobe.Layer.FillExtrusionLayer"});GeoGlobe.Layer.LineLayer=GeoGlobe.Class(GeoGlobe.Layer,{initialize:function(a){return a},CLASS_NAME:"GeoGlobe.Layer.LineLayer"});GeoGlobe.Layer.BackgroundLayer=GeoGlobe.Class(GeoGlobe.Layer,{"background-color":null,"background-pattern":null,"background-opacity":null,initialize:function(a){return a},CLASS_NAME:"GeoGlobe.Layer.BackgroundLayer"});
GeoGlobe.Layer.ThematicTileLayer=GeoGlobe.Class4OL(GeoGlobe.Layer,{map:null,version:"1.0.0",id:null,layerID:null,chartID:null,maxExtent:null,format:"png",colorSchemeID:null,hasLegend:!1,legendType:0,legendPosition:"br",hasEdge:!1,hasLabel:!1,hasBaseMap:!1,hasBaseMapLegend:!1,baseMapExampleColumnNums:2,initialize:function(a,b){var c=b.box,d=c._ne.lng,e=c._ne.lat,f=c._sw.lng,c=c._sw.lat,g=b.params;this.map=a;this.options=b;GeoGlobe.Function.bind(this.seturl,this);g=this.seturl(g);this.layer={id:this.options.id,
minzoom:b.minzoom?this.options.minzoom:0,maxzoom:b.maxzoom?this.options.maxzoom:20,source:{type:"image",url:this.options.url+"/map/"+this.options.layerID+"/"+this.options.chartID+"/"+f+"/"+c+"/"+d+"/"+e+"/"+this.options.width+"/"+this.options.height+".png?"+g,coordinates:[[f,e],[d,e],[d,c],[f,c]]},type:"raster"};this.zoome=$.proxy(this.zoomend,this);this.drage=$.proxy(this.dragend,this);this.map.on("zoomend",this.zoome);this.map.on("dragend",this.drage);GeoGlobe.Function.bind(this.remove,this);return this},
zoomend:function(){if(this.map.style._layers[this.options.id]&&this.map.style._layers[this.options.id].layout&&this.map.style._layers[this.options.id].layout.visibility!="none"){var a=this.map.style._layers[this.options.id].metadata,b=this.map.style._layers[this.options.id].paint,c=this.map.style._layers[this.options.id].layout;this.map.removeLayer(this.options.id);this.map.removeSource(this.options.id);box=this.map.getBounds();var d=this.options.params;maxx=box._ne.lng;maxy=box._ne.lat;minx=box._sw.lng;
miny=box._sw.lat;d=this.seturl(d);this.options.width=this.map.getCanvas().width;this.options.height=this.map.getCanvas().height;url=this.options.url+"/map/"+this.options.layerID+"/"+this.options.chartID+"/"+minx+"/"+miny+"/"+maxx+"/"+maxy+"/"+this.options.width+"/"+this.options.height+".png?"+d;layer={id:this.options.id,name:this.options.name,source:{type:"image",url:url,coordinates:[[minx,maxy],[maxx,maxy],[maxx,miny],[minx,miny]]},type:"raster"};layer.paint=b;layer.layout=c;layer.metadata=a;this.map.addLayer(layer)}},
dragend:function(){if(this.map.style._layers[this.options.id]&&this.map.style._layers[this.options.id].layout&&this.map.style._layers[this.options.id].layout.visibility!="none"){var a=this.map.style._layers[this.options.id].metadata,b=this.map.style._layers[this.options.id].paint,c=this.map.style._layers[this.options.id].layout;this.map.removeLayer(this.options.id);this.map.removeSource(this.options.id);box=this.map.getBounds();var d=this.options.params;maxx=box._ne.lng;maxy=box._ne.lat;minx=box._sw.lng;
miny=box._sw.lat;d=this.seturl(d);this.options.width=this.map.getCanvas().width;this.options.height=this.map.getCanvas().height;url=this.options.url+"/map/"+this.options.layerID+"/"+this.options.chartID+"/"+minx+"/"+miny+"/"+maxx+"/"+maxy+"/"+this.options.width+"/"+this.options.height+".png?"+d;layer={id:this.options.id,name:this.options.name,source:{type:"image",url:url,coordinates:[[minx,maxy],[maxx,maxy],[maxx,miny],[minx,miny]]},type:"raster"};layer.paint=b;layer.layout=c;layer.metadata=a;this.map.addLayer(layer)}},
seturl:function(a){var b="",c;for(c in a)a[c]!=-1&&(b+=c+"="+a[c]+"&");return b=b.substring(0,b.length-1)},getCapabilities:function(a,b,c){typeof c!="function"&&(c=function(){alert("\u4e13\u9898\u56fe\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});$.ajax({url:a,dataType:"json",cache:!1,async:!1,
success:function(a){typeof b=="function"&&b(a)},failure:c})},remove:function(a){this.map.off("zoomend",this.zoome);this.map.off("dragend",this.drage);this.map.removeLayer(a);this.map.removeSource(a)},showLegend:function(){var a=this.getLegend({layerID:this.layerID,chartID:this.chartID,colorSchemeID:this.colorSchemeID,drawLegend:"ThematicMap",legendType:this.legendType});this.imageLegend||(new GeoGlobe.Marker(a)).setLngLat([lnglat.lng,lnglat.lat]).addTo(this.map)},getLegend:function(a){if(this.url.indexOf("/",
this.url.length-1)!=-1)this.url=this.url.substr(0,this.url.length-1);var b;b=GeoGlobe.String.format("${url}/legend/${layerID}/${chartID}.${format}?drawLegend=${drawLegend}&legendType=${legendType}",{url:this.url,layerID:a.layerID,chartID:a.chartID,format:a.format||"png",drawLegend:a.drawLegend,legendType:a.legendType});typeof a.colorSchemeID==="string"&&(b+="&ColorSchemeID="+a.colorSchemeID);return b},setLegendLocation:function(a){var b=this.map.getSize();switch(this.legendPosition){case "br":var c=
b.w-this.legendSize.w,b=b.h-this.legendSize.h;a.style.left=c+"px";a.style.top=b+"px";break;case "bl":b=b.h-this.legendSize.h;a.style.left="0px";a.style.top=b+"px";break;case "tl":a.style.left="0px";a.style.top="0px";break;case "tr":c=b.w-this.legendSize.w,a.style.left=c+"px",a.style.top="0px"}},showBaseMapLegend:function(){var a=this.getBaseMapLegend({layerID:this.layerID,chartID:this.chartID,drawLegend:"BaseMap",baseMapExampleColumnNums:this.baseMapExampleColumnNums});this.imageBaseMapLegend||(new GeoGlobe.Marker(a)).setLngLat([lnglat.lng,
lnglat.lat]).addTo(this.map)},getBaseMapLegend:function(a){if(this.url.indexOf("/",this.url.length-1)!=-1)this.url=this.url.substr(0,this.url.length-1);return a=GeoGlobe.String.format("${url}/legend/${layerID}/${chartID}.${format}?drawLegend=${drawLegend}&baseMapExampleColumnNums=${baseMapExampleColumnNums}",{url:this.url,layerID:a.layerID,chartID:a.chartID,format:a.format||"png",drawLegend:a.drawLegend,baseMapExampleColumnNums:a.baseMapExampleColumnNums})},setBaseMapLegendLocation:function(a){var b=
this.map.getSize();switch(this.baseMapLegendPosition){case "br":var c=b.w-this.baseMapLegendSize.w,b=b.h-this.baseMapLegendSize.h;a.style.left=c+"px";a.style.top=b+"px";break;case "bl":b=b.h-this.baseMapLegendSize.h;a.style.left="0px";a.style.top=b+"px";break;case "tl":a.style.left="50px";a.style.top="0px";break;case "tr":c=b.w-this.baseMapLegendSize.w,a.style.left=c+"px",a.style.top="0px"}},updateHotArea:function(a){a.zoomChanged?this.vectorLayer.removeAllFeatures():this.vectorLayer.redraw()},clone:function(a){a==
null&&(a=new GeoGlobe.Layer.ThematicTileLayer(this.id,this.url,this.params,this.getOptions()));return a},getURL:function(a){var a=this.adjustBounds(a),b=this.getImageSize(),a=GeoGlobe.String.format("${url}/map/${layerID}/${chartID}/${left}/${bottom}/${right}/${top}/${width}/${height}.${format}?hasLegend=${hasLegend}&legendType=${legendType}&hasEdge=${hasEdge}&hasLabel=${hasLabel}&hasBaseMap=${hasBaseMap}&hasBaseMapLegend=${hasBaseMapLegend}&baseMapExampleColumnNums=${baseMapExampleColumnNums}",{url:this.url,
layerID:this.layerID,chartID:this.chartID,left:a.left,bottom:a.bottom,right:a.right,top:a.top,width:b.w,height:b.h,format:this.format,hasLegend:this.hasLegend,legendType:this.legendType,hasEdge:this.hasEdge,hasLabel:this.hasLabel,hasBaseMap:this.hasBaseMap,hasBaseMapLegend:this.hasBaseMapLegend,baseMapExampleColumnNums:this.baseMapExampleColumnNums});typeof this.colorSchemeID==="string"&&(a+="&ColorSchemeID="+this.colorSchemeID);return a},CLASS_NAME:"GeoGlobe.Layer.ThematicTileLayer"});
GeoGlobe.CanvasLayer=GeoGlobe.Class4OL({map:null,context:null,initialize:function(a){this.id=GeoGlobe.Util.createUniqueID(this.CLASS_NAME+"_");this.options=a},drawOnMove:null,_drawLayer:function(){this.clear();var a=this._prepareDrawParams();a&&this.draw.apply(this,a)},_prepareDrawParams:function(){var a=[];if(!this._drawContext)this._drawContext=this.prepareToDraw.apply(this,[this.context].concat(a));a=[this.context];a.push.apply(a,this._drawContext);return a},prepareToDraw:function(){},draw:function(){},
addTo:function(a){this.map=a;var b=a.getCanvasContainer();this.canvas=document.createElement("canvas");this.canvas.id=this.id;this.canvas.style.width=a.getCanvas().style.width;this.canvas.style.height=a.getCanvas().style.height;this.canvas.style.position="absolute";this.canvas.style.display="none";this.canvas.width=a.getCanvas().width;this.canvas.height=a.getCanvas().height;b.appendChild(this.canvas);this.context=this.canvas.getContext("2d");this._bindEvent();var c={type:"canvas",canvas:this.canvas.id,
animate:!0,coordinates:this._boundsToCoordinates(a.getBounds())},d={id:this.id+"_layer",source:this.id,type:"raster",paint:{"raster-opacity":1}};a.addSource(this.id,c);a.addLayer(d);this.source=a.getSource(this.id);this.layer=a.getLayer(this.id+"_layer");b.removeChild(this.canvas);this._drawLayer()},_bindEvent:function(){var a=this.map;this._move=GeoGlobe.Function.bind(function(a){typeof this.drawOnMove==="function"&&this.drawOnMove(a)},this);this._moveend=GeoGlobe.Function.bind(function(a){this.source.setCoordinates(this._boundsToCoordinates(a.target.getBounds()));
this._drawLayer()},this);a.on("move",this._move);a.on("moveend",this._moveend)},pause:function(){this.source.pause()},play:function(){this.source.play()},setOpacity:function(a){this.map.setPaintProperty(this.layer.id,"raster-opacity",parseFloat(a))},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},remove:function(){this.clear();var a=this.map;a.off("move",this._move);a.off("moveend",this._moveend);a.removeSource(this.source.id);a.removeLayer(this.layer.id);this.map=
this.canvas=null},_boundsToCoordinates:function(a){var b=a.toArray(),a=b[0][0],c=b[0][1],d=b[1][0],b=b[1][1];return[[a,b],[d,b],[d,c],[a,c]]},CLASS_NAME:"GeoGlobe.CanvasLayer"});
GeoGlobe.TDTLayer=GeoGlobe.Class4OL({initialize:function(a,b){return this._getLayer(a,b)},_getLayer:function(a,b){var c="tdt_"+a+"_"+GeoGlobe.Util.randomStr(8),d=GeoGlobe.ProxyHost+this._getUrlTemplateByName(a)+"&tk="+(b||"e90d56e5a09d1767899ad45846b0cefd");return{id:c,type:"raster",source:{type:"raster",tiles:[d],tileSize:256}}},_getUrlTemplateByName:function(a){return"http://t0.tianditu.com/"+a+"/wmts?"+this._getParameterString(this.tdtParams[a])},tdtParams:{vec_w:{SERVICE:"WMTS",REQUEST:"GetTile",
LAYER:"vec",TILEMATRIXSET:"w",FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"},cva_w:{SERVICE:"WMTS",REQUEST:"GetTile",LAYER:"cva",TILEMATRIXSET:"w",FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"},vec_c:{SERVICE:"WMTS",REQUEST:"GetTile",LAYER:"vec",TILEMATRIXSET:"c",FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"},cva_c:{SERVICE:"WMTS",REQUEST:"GetTile",LAYER:"cva",
TILEMATRIXSET:"c",FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"},img_w:{SERVICE:"WMTS",REQUEST:"GetTile",LAYER:"img",TILEMATRIXSET:"w",FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"},cia_w:{SERVICE:"WMTS",REQUEST:"GetTile",LAYER:"cia",TILEMATRIXSET:"w",FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"},img_c:{SERVICE:"WMTS",REQUEST:"GetTile",LAYER:"img",TILEMATRIXSET:"c",
FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"},cia_c:{SERVICE:"WMTS",REQUEST:"GetTile",LAYER:"cia",TILEMATRIXSET:"c",FORMAT:"tiles",VERSION:"1.0.0",STYLE:"default",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"}},_getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];d!=null&&typeof d!="function"&&b.push(c.toUpperCase()+"="+d)}return b.join("&")},CLASS_NAME:"GeoGlobe.TDTLayer"});
GeoGlobe.Layer.HotArea=GeoGlobe.Class4OL({url:null,layer:null,format:null,matrixSet:null,style:null,version:"1.0.0",name:null,layerid:null,hotareaLayers:null,hotareaHighlightedLayers:null,tileUrls:null,initialize:function(a){this.name=a.name?a.name:null;this.url=a.url;this.layer=a.layer;this.format=a.format;this.matrixSet=a.matrixSet;this.style=a.style;this.layerid="geoglobe_layer_hotarea_"+GeoGlobe.Util.randomStr(8);this.layerOption={id:this.layerid,type:"raster",source:{type:"raster",rasterType:"hotarea",
tiles:[GeoGlobe.appendToProxy(a.url+"?SERVICE=WMTS&REQUEST=GetTile&LAYER="+this.layer+"&TILEMATRIXSET="+this.matrixSet+"&FORMAT="+this.format+"&VERSION="+this.version+"&STYLE="+this.style+"&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}")],tileSize:256},paint:{"raster-opacity":1},metadata:{type:"hotarea"}};this.hotareaLayers=[];this.hotareaHighlightedLayers=[];this.tileUrls=[];this.onclick=typeof a.onclick==="function"?a.onclick:this.onclick},addTo:function(a){this.map=a;a.addLayer(this.layerOption);this._bindEvent()},
_bindEvent:function(){var a=this.map;GeoGlobe.Layer.HotArea["callback_tileJSON_"+this.layerid]=GeoGlobe.Function.bind(this.callback_tile,this);var b=GeoGlobe.Function.bind(function(b){for(var d=[[b.point.x-2,b.point.y-2],[b.point.x+2,b.point.y+2]],e=[],f=0;f<this.hotareaLayers.length;f++)e.push(this.hotareaLayers[f].id);d=a.queryRenderedFeatures(d,{layers:e});d.length>0?(d=[d[0]],this.map.getCanvas().style.cursor="pointer"):this.map.getCanvas().style.cursor="";e=d.reduce(function(a,b){a.push(b.properties.displayname);
return a},["==","displayname"]);e=e.length===2?["==","displayname",""]:e;for(f=0;f<this.hotareaHighlightedLayers.length;f++)a.setFilter(this.hotareaHighlightedLayers[f].id,e);if(b.type==="click")b.features=d,this.onclick(b)},this);a.on("click",b);a.on("mousemove",b);b=GeoGlobe.Function.bind(function(){for(var b=0;b<this.hotareaHighlightedLayers.length;b++)a.removeLayer(this.hotareaHighlightedLayers[b].id);this.hotareaHighlightedLayers=[];for(b=0;b<this.hotareaLayers.length;b++)a.removeLayer(this.hotareaLayers[b].id),
a.removeSource(this.hotareaLayers[b].id);this.hotareaLayers=[];this.tileUrls=[]},this);a.on("zoomstart",b)},callback_tile:function(a){for(var b=a.tileUrl,c=!1,d=0;d<this.tileUrls.length;d++)this.tileUrls[d]===b&&(c=!0);if(!c){this.tileUrls.push(b);b=a.data;c=b.features;for(d=0;d<c.length;d++){var e=c[d].properties.picsymid;c[d].properties.overPicUrl=this.getPicURL(e,!0);c[d].properties.outPicUrl=this.getPicURL(e,!1)}a=a.map;d=GeoGlobe.Util.randomStr(8);b={id:"hotarea_id_"+d,type:"fill",source:{type:"geojson",
data:b},paint:{"fill-color":"#088","fill-opacity":0}};a.addLayer(b);this.hotareaLayers.push(b);d={id:"hotarea_highlighted_id_"+d,type:"fill",source:b.id,paint:{"fill-outline-color":"#484896","fill-color":"#6e599f","fill-opacity":0},filter:["==","displayname",""]};a.addLayer(d);this.hotareaHighlightedLayers.push(d)}},getPicURL:function(a,b){return this.url+"?"+this._getParameterString({SERVICE:"WMTS",REQUEST:"GetIcon",VERSION:this.version,LAYER:this.layer,PICID:a,ISANTI:b})},_getParameterString:function(a){var b=
[],c;for(c in a){var d=a[c];d!=null&&typeof d!="function"&&b.push(c.toUpperCase()+"="+d)}return b.join("&")},onclick:function(){},CLASS_NAME:"GeoGlobe.Layer.HotArea"});GeoGlobe.Source=GeoGlobe.Class(mapboxgl.FreeCRSMap,{SourceId:null,initialize:function(){return this},CLASS_NAME:"GeoGlobe.Source"});GeoGlobe.Source.GeoJSONSource=GeoGlobe.Class(mapboxgl.FreeCRSMap,{initialize:function(a,b){var c={};c.id=a;c.source=b;return c},CLASS_NAME:"GeoGlobe.Source.GeoJSONSource"});
GeoGlobe.Source.RasterSource=GeoGlobe.Class(mapboxgl.FreeCRSMap,{initialize:function(a){return{id:a.id,type:"raster",tiles:a.url,tileSize:256}},CLASS_NAME:"GeoGlobe.Source.RasterSource"});GeoGlobe.Source.ImageSource=GeoGlobe.Class(mapboxgl.FreeCRSMap,{initialize:function(a,b){var c={};c.id=a;c.source=b;return c},CLASS_NAME:"GeoGlobe.Source.ImageSource"});GeoGlobe.Source.VectorSource=GeoGlobe.Class(mapboxgl.FreeCRSMap,{initialize:function(a){return{id:a.id,type:a.type,tiles:a.url}},CLASS_NAME:"GeoGlobe.Source.VectorSource"});
GeoGlobe.Source.VideoSource=GeoGlobe.Class(mapboxgl.FreeCRSMap,{initialize:function(a,b){var c={};c.id=a;c.video=b;return c},CLASS_NAME:"GeoGlobe.Source.VideoSource"});GeoGlobe.Marker=mapboxgl.Marker;GeoGlobe.Popup=mapboxgl.Popup;GeoGlobe.Control=mapboxgl.Control||{};GeoGlobe.Control.Navigation=mapboxgl.NavigationControl;GeoGlobe.Control.Attribution=mapboxgl.AttributionControl;
GeoGlobe.Control.Scale=GeoGlobe.Class4OL({initialize:function(a){this.options=a;mapboxgl.util.bindAll(["_onMove"],this)},getDefaultPosition:function(){return"bottom-left"},_onMove:function(){this._updateScale(this._map,this._container,this.options)},onAdd:function(a){this._map=a;this._container=GeoGlobe.DOM.create("div","mapboxgl-ctrl mapboxgl-ctrl-scale",a.getContainer());this._map.on("move",this._onMove);this._onMove();return this._container},onRemove:function(){this._container.parentNode.removeChild(this._container);
this._map.off("move",this._onMove);this._map=void 0},_updateScale:function(a,b,c){var d=c&&c.maxWidth||100,e=a._container.clientHeight/2,a=this._getDistance(a.unproject([0,e]),a.unproject([d,e]));c&&c.unit==="imperial"?(c=3.2808*a,c>5280?this._setScale(b,d,c/5280,"mi"):this._setScale(b,d,c,"ft")):this._setScale(b,d,a,"m")},_setScale:function(a,b,c,d){var e=this._getRoundNum(c),c=e/c;d==="m"&&e>=1E3&&(e/=1E3,d="km");a.style.width=b*c+"px";a.innerHTML=e+d},_getDistance:function(a,b){var c=null;if(this._map.units===
"m")c=b.lng-a.lng;else var c=Math.PI/180,d=a.lat*c,e=b.lat*c,c=6371E3*Math.acos(Math.min(Math.sin(d)*Math.sin(e)+Math.cos(d)*Math.cos(e)*Math.cos((b.lng-a.lng)*c),1));return c},_getRoundNum:function(a){var b=Math.pow(10,(""+Math.floor(a)).length-1);a/=b;return b*(a>=10?10:a>=5?5:a>=3?3:a>=2?2:1)},CLASS_NAME:"GeoGlobe.Control.Scale"});GeoGlobe.Control.Geolocate=mapboxgl.GeolocateControl;
GeoGlobe.Control.MapContextMenu=GeoGlobe.Class4OL({menuDiv:null,className:null,contentHTML:null,lngLat:null,point:null,initialize:function(a){GeoGlobe.Util.extend(this,a)},getDefaultPosition:function(){return"top-left"},onAdd:function(a){this._map=a;this._onContextMenu=GeoGlobe.Function.bind(this._showContextMenu,this);this._map.on("contextmenu",this._onContextMenu);this._onMouseDown=GeoGlobe.Function.bind(this.hide,this);this._map.on("mousedown",this._onMouseDown);return this._container=this._createContainer()},
_createContainer:function(){var a=window.document.createElement("div");a.className="mapboxgl-ctrl";this.className&&a.classList.add(this.className);a.style.position="absolute";a.style.background="white";a.style.border="1px solid #adbfe4";a.style.zIndex=2;a.innerHTML=this.contentHTML?this.contentHTML:"";this.menuDiv=a;this.menuDiv.onmousedown=GeoGlobe.Function.bind(function(a){(a||event).preventDefault();event.stopPropagation&&event.stopPropagation()},this);this.hide();return a},_showContextMenu:function(a){this.lngLat=
a.lngLat;this.point=a.point;this.menuDiv.style.left=a.point.x+"px";this.menuDiv.style.top=a.point.y+"px";this.show()},onRemove:function(){this._container.parentNode.removeChild(this._container);this._map.off("contextmenu",this._onContextMenu);this._map.off("mousedown",this._onMouseDown);this.contentHTML=this._container=this.menuDiv=null;this._map=void 0},show:function(){if(this.menuDiv&&this.menuDiv.style.display=="none")this.menuDiv.style.display=""},hide:function(){if(this.menuDiv&&this.menuDiv.style.display!=
"none")this.menuDiv.style.display="none"},setContentHTML:function(a){if(a!=null)this.contentHTML=a;if(this.menuDiv!=null&&this.contentHTML!=null&&this.contentHTML!=this.menuDiv.innerHTML)this.menuDiv.innerHTML=this.contentHTML},addItem:function(a){var b=document.createElement("div");b.id=a.id;b.style.cssText="padding-bottom: 2px; line-height: 17px; margin: 0px 2px; padding-left: 6px; width:"+a.width+"px; padding-right: 6px; color: #000; font-size: 12px; cursor: pointer; padding-top: 2px;";b.innerHTML=
"<span>"+a.text+"</span>";b.onclick=GeoGlobe.Function.bind(function(){a.callback({target:a,control:this,map:this._map,lngLat:this.lngLat,point:this.point});this.hide()},this);b.onmouseover=function(){b.style.color="#6688cc"};b.onmouseout=function(){b.style.color="#000"};this.menuDiv.appendChild(b);this.setContentHTML(this.menuDiv.innerHTML)},addSeparator:function(){var a=document.createElement("div");a.style.cssText="border-bottom:#adbfe4 1px solid;margin:0px 6px;font-size:0px;padding:1px";this.menuDiv.appendChild(a);
this.setContentHTML(this.menuDiv.innerHTML)},mousePos:function(a,b){var c=a.getBoundingClientRect();return new GeoGlobe.Point(b.clientX-c.left-a.clientLeft,b.clientY-c.top-a.clientTop)},CLASS_NAME:"GeoGlobe.View2D.Control.MapContextMenu"});GeoGlobe.MenuItem=GeoGlobe.Class4OL({id:null,text:null,callback:null,width:100,initialize:function(a){this.id=GeoGlobe.Util.createUniqueID(this.CLASS_NAME+"_");GeoGlobe.Util.extend(this,a)},setText:function(a){this.text=a},CLASS_NAME:"GeoGlobe.MenuItem"});
GeoGlobe.Control.MapCesium=GeoGlobe.Class4OL({map:null,viewer:null,isPitchChanged:!1,isHeadingChanged:!1,_MAPBOX_MOVE:"mapbox is moving",_CESIUM_MOVE:"cesium is moving",_isMoving:null,_handler:null,_currentCesiumHeading:0,_currentCesiumPitch:0,initialize:function(a){this.map=a.map?a.map:this.map;this.viewer=a.viewer?a.viewer:this.viewer;this.isPitchChanged=a.isPitchChanged!==void 0?a.isPitchChanged:this.isPitchChanged;this.isHeadingChanged=a.isHeadingChanged!==void 0?a.isHeadingChanged:this.isHeadingChanged;
this._isMoving=this._MAPBOX_MOVE;this._isSync=!1;this._currentCesiumHeading=0;this._currentCesiumPitch=-Cesium.Math.PI_OVER_TWO;this._handler=new Cesium.ScreenSpaceEventHandler(this.viewer.canvas);this._bindEvent();this._updateCesium()},_bindEvent:function(){if(this.map&&!this._handler.getInputAction(Cesium.ScreenSpaceEventType.MOUSE_MOVE)){var a=this;this.map.on("move",function(){a._isSync&&a._updateCesium()});this.map.on("mouseover",function(){a._isMoving=a._MAPBOX_MOVE});this._handler.setInputAction(function(){a._isMoving=
a._CESIUM_MOVE;a._currentCesiumHeading=a.viewer.camera.heading;a._currentCesiumPitch=a.viewer.camera.pitch},Cesium.ScreenSpaceEventType.MOUSE_MOVE);this.viewer.canvas.addEventListener("mouseout",function(){a._isMoving=a._MAPBOX_MOVE});this.viewer.scene.preRender.addEventListener(function(){a._isSync&&a._updateMapbox()})}},setEnabled:function(a){this._isSync=a},_unbindEvent:function(){if(this.map){for(var a=0;a<this.map._listeners.move.length;a++)this.map._listeners.move[a].name&&this.map._listeners.move[a].name===
"MAPCESIUM_MOVE_EVENT"&&this.map._listeners.move.splice(a,1);for(a=0;a<this.map._listeners.mouseover.length;a++)this.map._listeners.mouseover[a].name&&this.map._listeners.mouseover[a].name==="MAPCESIUM_MOVEOVER_EVENT"&&this.map._listeners.mouseover.splice(a,1);for(a=0;a<this.viewer.scene.preRender._listeners.length;a++)this.viewer.scene.preRender._listeners[a].name==="CESIUM_RENDER_EVENT"&&this.viewer.scene.preRender._listeners.splice(a,1);this._handler.removeInputAction(Cesium.ScreenSpaceEventType.MOUSE_MOVE)}},
destroy:function(){if(this.map)this._unbindEvent(),this.viewer=this._handler=this.map=null},_calDistanceFromMapboxToCesium:function(){return this.map.transform.cameraToCenterDistance*(78271.51696402031/Math.pow(2,this.map.getZoom()+1.2))},_calHeadingFromMapboxToCesium:function(){var a=this.map.getBearing();return Cesium.Math.toRadians(a)},_calPitchFromMapboxToCesium:function(){var a=this.map.getPitch();return Cesium.Math.toRadians(a-90)},_calDestinationFromMapboxToCesium:function(){var a=new Cesium.Cartographic(Cesium.Math.toRadians(this.map.getCenter().lng),
Cesium.Math.toRadians(this.map.getCenter().lat));return Cesium.Ellipsoid.WGS84.cartographicToCartesian(a)},_getCenterPoint:function(){var a=this.viewer.canvas,a=new Cesium.Cartesian2(a.clientWidth/2,a.clientHeight/2);return this.viewer.scene.globe.pick(this.viewer.camera.getPickRay(a),this.viewer.scene)||this.viewer.camera.pickEllipsoid(a)},_updateCesium:function(){if(this._isMoving!==this._CESIUM_MOVE){var a=this._calDistanceFromMapboxToCesium(),b,c;c=this.isHeadingChanged?this._calHeadingFromMapboxToCesium():
this._currentCesiumHeading;b=this.isPitchChanged?this._calPitchFromMapboxToCesium():this._currentCesiumPitch;this.viewer.camera.setView({destination:this._calDestinationFromMapboxToCesium(),orientation:{heading:c,pitch:b}});this.viewer.camera.moveBackward(a)}},_updateMapbox:function(){if(this.viewer&&this._isMoving!==this._MAPBOX_MOVE){var a=Cesium.Ellipsoid.WGS84,b=0,c=0,c=this._getCenterPoint();if(!c)b=this.viewer.scene.globe,c=this.viewer.camera.positionCartographic.clone(),b=b.getHeight(c),c.height=
b||0,c=a.cartographicToCartesian(c);var b=Cesium.Cartesian3.distance(c,this.viewer.camera.position)/this.map.transform.cameraToCenterDistance,b=Math.log2(78271.51696402031/b)-1.2,d=a.cartesianToCartographic(c),d=[Cesium.Math.toDegrees(d.longitude),Cesium.Math.toDegrees(d.latitude)];this.map.setZoom(b);this.map.setCenter(d);if(c){var b=viewer.camera.up,d=viewer.camera.right,e=new Cesium.Cartesian3(-c.y,c.x,0),d=Cesium.Cartesian3.angleBetween(d,e),b=Cesium.Cartesian3.cross(c,b,new Cesium.Cartesian3).z<
0?-d:d,b=Cesium.Math.toDegrees(b),d=this.viewer.camera.position,e=new Cesium.Cartesian3;a.geocentricSurfaceNormal(c,e);a=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(d,c,a);Cesium.Cartesian3.normalize(a,a);a=Math.acos(Cesium.Cartesian3.dot(e,a));c=isNaN(a)?0:a}else b=Cesium.Math.toDegrees(this.viewer.camera.heading),c=Cesium.Math.PI_OVER_THREE;this.isHeadingChanged&&this.map.setBearing(b);this.isPitchChanged&&this.map.setPitch(Cesium.Math.toDegrees(c))}},CLASS_NAME:"GeoGlobe.View2D.Control.MapCesium"});
GeoGlobe.Event=mapboxgl.Evented;GeoGlobe.Event.MapMouseEvent=mapboxgl.Event;GeoGlobe.Event.MapTouchEvent=mapboxgl.Event;GeoGlobe.Event.mapDataEvent=mapboxgl.Event;GeoGlobe.Event.mapBoxZoomEvent=mapboxgl.Event;GeoGlobe.Handler=GeoGlobe.Class({initialize:function(){},CLASS_NAME:"GeoGlobe.Handler"});
GeoGlobe.BoxHandler3D=GeoGlobe.Class4OL({initialize:function(a){this._map=a;this._el=a.getCanvasContainer();this._container=a.getContainer();this._onMouseDown=this._onMouseDown.bind(this);this._onMouseMove=this._onMouseMove.bind(this);this._onMouseUp=this._onMouseUp.bind(this);this._onKeyDown=this._onKeyDown.bind(this)},isEnabled:function(){return!!this._enabled},isActive:function(){return!!this._active},enable:function(){if(!this.isEnabled())this._el.addEventListener("mousedown",this._onMouseDown,
!1),this._enabled=!0},disable:function(){if(this.isEnabled())this._el.removeEventListener("mousedown",this._onMouseDown),this._enabled=!1},_onMouseDown:function(a){if(a.button===0)window.document.addEventListener("mousemove",this._onMouseMove,!1),window.document.addEventListener("keydown",this._onKeyDown,!1),window.document.addEventListener("mouseup",this._onMouseUp,!1),GeoGlobe.DOM.disableDrag(),this._startPos=GeoGlobe.DOM.mousePos(this._el,a),this._active=!0},_onMouseMove:function(a){var b=this._startPos,
c=GeoGlobe.DOM.mousePos(this._el,a);if(!this._box)this._box=GeoGlobe.DOM.create("canvas","geoglobe-boxhandler3d",this._container),this._box.style.position="absolute",this._box.width=this._map.transform.width,this._box.height=this._map.transform.height,this._boxContext=this._box.getContext("2d"),this._boxContext.lineWidth=2,this._boxContext.globalAlpha=0.7,this._boxContext.fillStyle="#a09e9e",this._boxContext.strokeStyle="#b90909",this._boxContext.setLineDash([2,2]),this._container.classList.add("mapboxgl-crosshair"),
this._fireEvent("boxstart",a);var d=this._map.unproject(b),e=this._map.unproject(c),a=this._map.project([d.lng,e.lat]),d=this._map.project([e.lng,d.lat]);this._boxContext.clearRect(0,0,this._box.width,this._box.height);this._boxContext.beginPath();this._boxContext.moveTo(b.x,b.y);this._boxContext.lineTo(a.x,a.y);this._boxContext.lineTo(c.x,c.y);this._boxContext.lineTo(d.x,d.y);this._boxContext.closePath();this._boxContext.fill();this._boxContext.stroke()},_onMouseUp:function(a){if(a.button===0){var b=
this._startPos,c=GeoGlobe.DOM.mousePos(this._el,a),d=(new GeoGlobe.LngLatBounds).extend(this._map.unproject(b)).extend(this._map.unproject(c)),e=[GeoGlobe.Point.convert(b),GeoGlobe.Point.convert(c)],e=[e[0],new GeoGlobe.Point(e[1].x,e[0].y),e[1],new GeoGlobe.Point(e[0].x,e[1].y)].map(function(a){return this._map.unproject(a)}.bind(this));this._finish();b.x===c.x&&b.y===c.y||this._map.fire("boxend",{originalEvent:a,boxBounds:d,boxLnglats:e,startPos:b,endPos:c})}},_onKeyDown:function(a){a.keyCode===
27&&(this._finish(),this._fireEvent("boxcancel",a))},_finish:function(){this._active=!1;window.document.removeEventListener("mousemove",this._onMouseMove,!1);window.document.removeEventListener("keydown",this._onKeyDown,!1);window.document.removeEventListener("mouseup",this._onMouseUp,!1);this._container.classList.remove("mapboxgl-crosshair");if(this._box)this._box.parentNode.removeChild(this._box),this._box=null;GeoGlobe.DOM.enableDrag()},_fireEvent:function(a,b){return this._map.fire(a,{originalEvent:b})},
CLASS_NAME:"GeoGlobe.BoxHandler3D"});GeoGlobe.Handler.BoxZoomHandler=GeoGlobe.Class(GeoGlobe.Handler,{initialize:function(a){return this.handler=a.boxZoom},CLASS_NAME:"GeoGlobe.Handler.BoxZoomHandler"});GeoGlobe.Handler.DoubleClickZoomHandler=GeoGlobe.Class(GeoGlobe.Handler,{initialize:function(a){return this.handler=a.doubleClickZoom},CLASS_NAME:"GeoGlobe.Handler.DoubleClickZoomHandler"});
GeoGlobe.Handler.DragPanHandler=GeoGlobe.Class(GeoGlobe.Handler,{initialize:function(a){return this.handler=a.dragPan},CLASS_NAME:"GeoGlobe.Handler.DragPanHandler"});GeoGlobe.Handler.DragRotateHandler=GeoGlobe.Class(GeoGlobe.Handler,{map:null,initialize:function(a){return this.handler=a.dragRotate},isActivate:function(){return this.handler.isActive()},isEnabled:function(){return this.handler.isEnabled()},enable:function(){this.handler.enable()},disable:function(){this.handler.disable()},CLASS_NAME:"GeoGlobe.Handler.DragRotateHandler"});
GeoGlobe.Handler.KeyboardHandler=GeoGlobe.Class(GeoGlobe.Handler,{initialize:function(a){return this.handler=a.keyboard},CLASS_NAME:"GeoGlobe.Handler.KeyboardHandler"});GeoGlobe.Handler.ScrollZoomHandler=GeoGlobe.Class(GeoGlobe.Handler,{initialize:function(a){return this.handler=a.scrollZoom},CLASS_NAME:"GeoGlobe.Handler.ScrollZoomHandler"});GeoGlobe.Handler.TouchZoomRotateHandler=GeoGlobe.Class(GeoGlobe.Handler,{initialize:function(a){return this.handler=a.touchZoomRotate},CLASS_NAME:"GeoGlobe.Handler.TouchZoomRotateHandler"});
GeoGlobe.DynamicTrace=GeoGlobe.Class({frame_num:0,origons:[0,0],destinations:[0,0],map:null,id:null,initialize:function(a){this.options=a;frame_num=a.frame_num;map=a.map;id=a.id;origins=a.origons;destinations=a.destinations;num=destinations.length;pointid=id+"point";routeid1=id+"route1";routeid2=id+"route2";point={};route={};route1={};route2={};counter=0;request=null},autotrace:function(a,b){frame_num||(frame_num=1E3);a&&(frame_num=a);route={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",
coordinates:[origins[0],destinations[0]]}}]};for(var c=1;c<num;c++){var d={type:"Feature",geometry:{type:"LineString",coordinates:[origins[c],destinations[c]]}};route.features.push(d)}point={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:origins[0]}}]};for(c=1;c<num;c++)d={type:"Feature",geometry:{type:"Point",coordinates:origins[c]}},point.features.push(d);d=[];d.push(turf.lineDistance(route.features[0],"kilometers"));for(c=1;c<num;c++)d.push(turf.lineDistance(route.features[c],
"kilometers"));for(var e=0;e<num;e++){for(var f=[],c=0;c<d[e];c++){var g=turf.along(route.features[e],c/frame_num*d[e],"kilometers");f.push(g.geometry.coordinates)}route.features[e].geometry.coordinates=f}route1={type:"FeatureCollection",features:[]};for(e=0;e<num;e++)d={type:"Feature",geometry:{type:"LineString",coordinates:[origins[e],origins[e]]}},route1.features.push(d);route2={type:"FeatureCollection",features:[]};for(e=0;e<num;e++)d={type:"Feature",geometry:{type:"LineString",coordinates:[origins[e],
origins[e]]}},route2.features.push(d);counter=0;map.addSource(routeid1,{type:"geojson",data:route1});map.addSource(routeid2,{type:"geojson",data:route2});map.addSource(pointid,{type:"geojson",data:point});b?(map.addLayer({id:routeid1,source:routeid1,type:b.line.type,paint:b.line.paint}),map.addLayer({id:routeid2,source:routeid2,type:b.line.type,paint:b.line.paint}),map.addLayer({id:pointid,source:pointid,type:b.point.type,paint:b.point.paint})):(map.addLayer({id:routeid1,source:routeid1,type:"line",
paint:{"line-width":{base:2,stops:[[12,2],[22,180]]},"line-color":"red"}}),map.addLayer({id:routeid2,source:routeid2,type:"line",paint:{"line-width":{base:2,stops:[[12,2],[22,180]]},"line-color":"red"}}),map.addLayer({id:pointid,source:pointid,type:"circle",paint:{"circle-radius":{base:2,stops:[[12,2],[22,180]]},"circle-color":"yellow","circle-opacity":1}}))},run:function(){for(var a=0;a<num;a++)point.features[a].geometry.coordinates=route.features[a].geometry.coordinates[counter],route1.features[a].geometry.coordinates.push(route.features[a].geometry.coordinates[counter]),
route2.features[a].geometry.coordinates.push(route.features[a].geometry.coordinates[counter]),route1.features[a].geometry.coordinates.length>11&&route1.features[a].geometry.coordinates.shift();map.getSource(pointid).setData(point);map.getSource(routeid1).setData(route1);counter%10==0&&map.getSource(routeid2).setData(route2);point.features[0].geometry.coordinates[0]!==destinations[0][0]&&(request=requestAnimationFrame(run));counter+=1},reset:function(){for(var a=0;a<num;a++)point.features[a].geometry.coordinates=
origins[a],route1.features[a].geometry.coordinates=[],route2.features[a].geometry.coordinates=[],route1.features[a].geometry.coordinates.push(origins[a]),route2.features[a].geometry.coordinates.push(origins[a]);map.getSource(pointid).setData(point);map.getSource(routeid1).setData(route1);map.getSource(routeid2).setData(route2);counter=0;cancelAnimationFrame(request)},replay:function(){for(var a=0;a<num;a++)point.features[a].geometry.coordinates=origins[a],route1.features[a].geometry.coordinates=[],
route2.features[a].geometry.coordinates=[],route1.features[a].geometry.coordinates.push(origins[a]),route2.features[a].geometry.coordinates.push(origins[a]);map.getSource(pointid).setData(point);map.getSource(routeid1).setData(route1);map.getSource(routeid2).setData(route2);counter=0;run(counter)},pause:function(){cancelAnimationFrame(request)},removetrace:function(){map.removeLayer(pointid);map.removeLayer(routeid1);map.removeLayer(routeid2);map.removeSource(pointid);map.removeSource(routeid1);map.removeSource(routeid2)},
CLASS_NAME:"GeoGlobe.DynamicTrace"});
GeoGlobe.DynamicFeature=GeoGlobe.Class({data:null,map:null,style:null,isdraw:null,id:null,property:null,initialize:function(a){this.options=a;map=a.map;feat_data=a.data;speed=500;i=0;sourceid=null;style=a.style;property=style.property;val_property=feat_data.features[0].properties[property];sourceid=a.id;isdraw=a.isdraw;color_num=[];size_num=[];isdraw&&(this.setdata(),this.setstyle())},setdata:function(a){a?(map.removeSource(sourceid),map.addSource(sourceid,{type:"geojson",data:a})):map.addSource(sourceid,
{type:"geojson",data:feat_data})},setstyle:function(){var a=0;if(style.color){color=style.color;for(var b=color[val_property],c=0;c<b.length;c++)color_num.push([c,b[c]]);opacity=style.opacity;if(style.size){size=style.size;b=size[val_property];for(c=0;c<b.length;c++)size_num.push([c,b[c]])}else size_num=[[0,7],[1,5],[2,3]]}else opacity=0.3,color_num=[[0,"red"],[1,"#FFC0CB"],[2,"#FFB6C1"]],size_num=[[0,7],[1,5],[2,3]];style.type==="point"?setInterval(function(){i%speed===0&&(map.addLayer({id:sourceid,
type:"circle",source:sourceid,paint:{"circle-color":{stops:[color_num[a]]},"circle-opacity":opacity,"circle-radius":{stops:[size_num[a]]}}}),a++,a>2&&(a=0));i+=5},1):style.type==="line"?setInterval(function(){i%speed===0&&(map.addLayer({id:sourceid,type:"line",source:sourceid,paint:{"line-color":{stops:[color_num[a]]},"line-opacity":opacity,"line-width":{stops:[size_num[a]]}}}),a++,a>2&&(a=0));i+=5},1):style.type==="fill"?setInterval(function(){i%speed===0&&(map.addLayer({id:sourceid,type:"fill",
source:sourceid,paint:{"fill-color":{stops:[color_num[a]]},"fill-opacity":0.3,"fill-outline-color":{stops:[color_num[a]]}}}),a++,a>2&&(a=0));i+=5},1):alert("\u8bf7\u786e\u5b9a\u663e\u793a\u7684\u8981\u7d20\u7684\u7c7b\u578b")},CLASS_NAME:"GeoGlobe.DynamicFeature"});
GeoGlobe.Geometry=GeoGlobe.Class4OL({id:null,parent:null,bounds:null,initialize:function(){this.id=GeoGlobe.Util.createUniqueID(this.CLASS_NAME+"_")},destroy:function(){this.bounds=this.id=null},clone:function(){return new GeoGlobe.Geometry},setBounds:function(a){if(a)this.bounds=a.clone()},clearBounds:function(){this.bounds=null;this.parent&&this.parent.clearBounds()},extendBounds:function(a){this.getBounds()?this.bounds.extend(a):this.setBounds(a)},getBounds:function(){this.bounds==null&&this.calculateBounds();
return this.bounds},calculateBounds:function(){},distanceTo:function(){},getVertices:function(){},atPoint:function(a,b,c){var d=!1;this.getBounds()!=null&&a!=null&&(b=b!=null?b:0,d=c!=null?c:0,c=new GeoGlobe.LngLat(this.bounds._sw.lng-b,this.bounds._sw.lat-d),b=new GeoGlobe.LngLat(this.bounds._ne.lng+b,this.bounds._ne.lat+d),d=(new GeoGlobe.LngLatBounds(c,b)).containsLonLat(a));return d},getLength:function(){return 0},getArea:function(){return 0},getCentroid:function(){return null},toString:function(){return GeoGlobe.Format&&
GeoGlobe.Format.WKT?GeoGlobe.Format.WKT.prototype.write(new GeoGlobe.Feature(this)):Object.prototype.toString.call(this)},CLASS_NAME:"GeoGlobe.Geometry"});
GeoGlobe.Geometry.fromWKT=function(a){var b;if(GeoGlobe.Format&&GeoGlobe.Format.WKT){var c=GeoGlobe.Geometry.fromWKT.format;if(!c)c=new GeoGlobe.Format.WKT,GeoGlobe.Geometry.fromWKT.format=c;a=c.read(a);if(a instanceof GeoGlobe.Feature)b=a.geometry;else if(GeoGlobe.Util.isArray(a)){b=a.length;for(var c=Array(b),d=0;d<b;++d)c[d]=a[d].geometry;b=new GeoGlobe.Geometry.Collection(c)}}return b};
GeoGlobe.Geometry.segmentsIntersect=function(a,b,c){var d=c&&c.point,c=c&&c.tolerance,e=!1,f=a.x1-b.x1,g=a.y1-b.y1,h=a.x2-a.x1,j=a.y2-a.y1,l=b.y2-b.y1,n=b.x2-b.x1,o=l*h-n*j,l=n*g-l*f,g=h*g-j*f;o==0?l==0&&g==0&&(e=!0):(f=l/o,o=g/o,f>=0&&f<=1&&o>=0&&o<=1&&(d?(h=a.x1+f*h,o=a.y1+f*j,e=new GeoGlobe.Geometry.Point(h,o)):e=!0));if(c)if(e){if(d){a=[a,b];b=0;a:for(;b<2;++b){f=a[b];for(j=1;j<3;++j)if(h=f["x"+j],o=f["y"+j],d=Math.sqrt(Math.pow(h-e.x,2)+Math.pow(o-e.y,2)),d<c){e.x=h;e.y=o;break a}}}}else{a=[a,
b];b=0;a:for(;b<2;++b){h=a[b];o=a[(b+1)%2];for(j=1;j<3;++j)if(f={x:h["x"+j],y:h["y"+j]},g=GeoGlobe.Geometry.distanceToSegment(f,o),g.distance<c){e=d?new GeoGlobe.Geometry.Point(f.x,f.y):!0;break a}}}return e};GeoGlobe.Geometry.distanceToSegment=function(a,b){var c=GeoGlobe.Geometry.distanceSquaredToSegment(a,b);c.distance=Math.sqrt(c.distance);return c};
GeoGlobe.Geometry.distanceSquaredToSegment=function(a,b){var c=a.x,d=a.y,e=b.x1,f=b.y1,g=b.x2,h=b.y2,j=g-e,l=h-f,n=j==0&&l==0?0:(j*(c-e)+l*(d-f))/(Math.pow(j,2)+Math.pow(l,2));n<=0||(n>=1?(e=g,f=h):(e+=n*j,f+=n*l));return{distance:Math.pow(e-c,2)+Math.pow(f-d,2),x:e,y:f,along:n}};GeoGlobe.Geometry.fromGeoJson=function(a){var b;if(GeoGlobe.Format&&GeoGlobe.Format.GeoJSON){format=new GeoGlobe.Format.GeoJSON;b=null;try{b=format.parseGeometry(a)}catch(c){console.log(c)}}return b};
GeoGlobe.Geometry.Collection=GeoGlobe.Class4OL(GeoGlobe.Geometry,{components:null,componentTypes:null,initialize:function(a){GeoGlobe.Geometry.prototype.initialize.apply(this,arguments);this.components=[];a!=null&&this.addComponents(a)},destroy:function(){this.components.length=0;this.components=null;GeoGlobe.Geometry.prototype.destroy.apply(this,arguments)},clone:function(){for(var a=eval("new "+this.CLASS_NAME+"()"),b=0,c=this.components.length;b<c;b++)a.addComponent(this.components[b].clone());
GeoGlobe.Util.applyDefaults(a,this);return a},getComponentsString:function(){for(var a=[],b=0,c=this.components.length;b<c;b++)a.push(this.components[b].toShortString());return a.join(",")},calculateBounds:function(){this.bounds=null;var a=new GeoGlobe.LngLatBounds,b=this.components;if(b)for(var c=0,d=b.length;c<d;c++)a.extend(b[c].getBounds());a._sw!=null&&a._sw!=null&&a._ne!=null&&a._ne!=null&&a._sw.lng!=null&&a._sw.lat!=null&&a._ne.lng!=null&&a._ne.lat!=null&&this.setBounds(a)},addComponents:function(a){GeoGlobe.Util.isArray(a)||
(a=[a]);for(var b=0,c=a.length;b<c;b++)this.addComponent(a[b])},addComponent:function(a,b){var c=!1;if(a&&(this.componentTypes==null||GeoGlobe.Util.indexOf(this.componentTypes,a.CLASS_NAME)>-1)){if(b!=null&&b<this.components.length){var c=this.components.slice(0,b),d=this.components.slice(b,this.components.length);c.push(a);this.components=c.concat(d)}else this.components.push(a);a.parent=this;this.clearBounds();c=!0}return c},removeComponents:function(a){var b=!1;GeoGlobe.Util.isArray(a)||(a=[a]);
for(var c=a.length-1;c>=0;--c)b=this.removeComponent(a[c])||b;return b},removeComponent:function(a){GeoGlobe.Util.removeItem(this.components,a);this.clearBounds();return!0},getLength:function(){for(var a=0,b=0,c=this.components.length;b<c;b++)a+=this.components[b].getLength();return a},getArea:function(){for(var a=0,b=0,c=this.components.length;b<c;b++)a+=this.components[b].getArea();return a},getGeodesicArea:function(a){for(var b=0,c=0,d=this.components.length;c<d;c++)b+=this.components[c].getGeodesicArea(a);
return b},getCentroid:function(a){if(!a)return this.components.length&&this.components[0].getCentroid();a=this.components.length;if(!a)return!1;for(var b=[],c=[],d=0,e=Number.MAX_VALUE,f,g=0;g<a;++g){f=this.components[g];var h=f.getArea();f=f.getCentroid(!0);!isNaN(h)&&!isNaN(f.x)&&!isNaN(f.y)&&(b.push(h),d+=h,e=h<e&&h>0?h:e,c.push(f))}a=b.length;if(d===0){for(g=0;g<a;++g)b[g]=1;d=b.length}else{for(g=0;g<a;++g)b[g]/=e;d/=e}for(var j=e=0,g=0;g<a;++g)f=c[g],h=b[g],e+=f.x*h,j+=f.y*h;return new GeoGlobe.Geometry.Point(e/
d,j/d)},getGeodesicLength:function(a){for(var b=0,c=0,d=this.components.length;c<d;c++)b+=this.components[c].getGeodesicLength(a);return b},move:function(a,b){for(var c=0,d=this.components.length;c<d;c++)this.components[c].move(a,b)},rotate:function(a,b){for(var c=0,d=this.components.length;c<d;++c)this.components[c].rotate(a,b)},resize:function(a,b,c){for(var d=0;d<this.components.length;++d)this.components[d].resize(a,b,c);return this},distanceTo:function(a,b){for(var c=!(b&&b.edge===!1)&&b&&b.details,
d,e,f,g=Number.POSITIVE_INFINITY,h=0,j=this.components.length;h<j;++h)if(d=this.components[h].distanceTo(a,b),f=c?d.distance:d,f<g&&(g=f,e=d,g==0))break;return e},equals:function(a){var b=!0;if(!a||!a.CLASS_NAME||this.CLASS_NAME!=a.CLASS_NAME)b=!1;else if(!GeoGlobe.Util.isArray(a.components)||a.components.length!=this.components.length)b=!1;else for(var c=0,d=this.components.length;c<d;++c)if(!this.components[c].equals(a.components[c])){b=!1;break}return b},transform:function(a,b){if(a&&b){for(var c=
0,d=this.components.length;c<d;c++)this.components[c].transform(a,b);this.bounds=null}return this},intersects:function(a){for(var b=!1,c=0,d=this.components.length;c<d;++c)if(b=a.intersects(this.components[c]))break;return b},getVertices:function(a){for(var b=[],c=0,d=this.components.length;c<d;++c)Array.prototype.push.apply(b,this.components[c].getVertices(a));return b},CLASS_NAME:"GeoGlobe.Geometry.Collection"});
GeoGlobe.Geometry.Point=GeoGlobe.Class4OL(GeoGlobe.Geometry,{x:null,y:null,initialize:function(a,b){GeoGlobe.Geometry.prototype.initialize.apply(this,arguments);this.x=parseFloat(a);this.y=parseFloat(b)},clone:function(a){a==null&&(a=new GeoGlobe.Geometry.Point(this.x,this.y));GeoGlobe.Util.applyDefaults(a,this);return a},calculateBounds:function(){var a=new GeoGlobe.LngLat(this.x,this.y),b=new GeoGlobe.LngLat(this.x,this.y);this.bounds=new GeoGlobe.LngLatBounds(a,b)},distanceTo:function(a,b){var c=
!(b&&b.edge===!1)&&b&&b.details,d,e,f,g,h;a instanceof GeoGlobe.Geometry.Point?(e=this.x,f=this.y,g=a.x,h=a.y,d=Math.sqrt(Math.pow(e-g,2)+Math.pow(f-h,2)),d=!c?d:{x0:e,y0:f,x1:g,y1:h,distance:d}):(d=a.distanceTo(this,b),c&&(d={x0:d.x1,y0:d.y1,x1:d.x0,y1:d.y0,distance:d.distance}));return d},equals:function(a){var b=!1;a!=null&&(b=this.x==a.x&&this.y==a.y||isNaN(this.x)&&isNaN(this.y)&&isNaN(a.x)&&isNaN(a.y));return b},toShortString:function(){return this.x+", "+this.y},move:function(a,b){this.x+=
a;this.y+=b;this.clearBounds()},rotate:function(a,b){a*=Math.PI/180;var c=this.distanceTo(b),d=a+Math.atan2(this.y-b.y,this.x-b.x);this.x=b.x+c*Math.cos(d);this.y=b.y+c*Math.sin(d);this.clearBounds()},getCentroid:function(){return new GeoGlobe.Geometry.Point(this.x,this.y)},resize:function(a,b,c){this.x=b.x+a*(c==void 0?1:c)*(this.x-b.x);this.y=b.y+a*(this.y-b.y);this.clearBounds();return this},intersects:function(a){var b=!1;return b=a.CLASS_NAME=="GeoGlobe.Geometry.Point"?this.equals(a):a.intersects(this)},
transform:function(a,b){if(a&&b)GeoGlobe.SpatialReference.transform(this,a,b),this.bounds=null;return this},getVertices:function(){return[this]},CLASS_NAME:"GeoGlobe.Geometry.Point"});GeoGlobe.Geometry.MultiPoint=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.Point"],addPoint:function(a,b){this.addComponent(a,b)},removePoint:function(a){this.removeComponent(a)},CLASS_NAME:"GeoGlobe.Geometry.MultiPoint"});
GeoGlobe.Geometry.Curve=GeoGlobe.Class4OL(GeoGlobe.Geometry.MultiPoint,{componentTypes:["GeoGlobe.Geometry.Point"],getLength:function(){var a=0;if(this.components&&this.components.length>1)for(var b=1,c=this.components.length;b<c;b++)a+=this.components[b-1].distanceTo(this.components[b]);return a},getGeodesicLength:function(a){var b=this;if(a){var c=new GeoGlobe.SpatialReference("EPSG:4326");c.equals(a)||(b=this.clone().transform(a,c))}a=0;if(b.components&&b.components.length>1)for(var d,e=1,f=b.components.length;e<
f;e++)c=b.components[e-1],d=b.components[e],a+=GeoGlobe.Util.distVincenty({lng:c.x,lat:c.y},{lng:d.x,lat:d.y});return a*1E3},CLASS_NAME:"GeoGlobe.Geometry.Curve"});
GeoGlobe.Geometry.LineString=GeoGlobe.Class4OL(GeoGlobe.Geometry.Curve,{removeComponent:function(){var a=this.components&&this.components.length>2;a&&GeoGlobe.Geometry.Collection.prototype.removeComponent.apply(this,arguments);return a},intersects:function(a){var b=!1,c=a.CLASS_NAME;if(c=="GeoGlobe.Geometry.LineString"||c=="GeoGlobe.Geometry.LinearRing"||c=="GeoGlobe.Geometry.Point"){var d=this.getSortedSegments(),a=c=="GeoGlobe.Geometry.Point"?[{x1:a.x,y1:a.y,x2:a.x,y2:a.y}]:a.getSortedSegments(),
e,f,g,h,j,l,n,o=0,q=d.length;a:for(;o<q;++o){c=d[o];e=c.x1;f=c.x2;g=c.y1;h=c.y2;var r=0,m=a.length;for(;r<m;++r){j=a[r];if(j.x1>f)break;if(!(j.x2<e)&&(l=j.y1,n=j.y2,!(Math.min(l,n)>Math.max(g,h))&&!(Math.max(l,n)<Math.min(g,h))&&GeoGlobe.Geometry.segmentsIntersect(c,j))){b=!0;break a}}}}else b=a.intersects(this);return b},getSortedSegments:function(){for(var a=this.components.length-1,b=Array(a),c,d,e=0;e<a;++e)c=this.components[e],d=this.components[e+1],b[e]=c.x<d.x?{x1:c.x,y1:c.y,x2:d.x,y2:d.y}:
{x1:d.x,y1:d.y,x2:c.x,y2:c.y};return b.sort(function(a,b){return a.x1-b.x1})},splitWithSegment:function(a,b){for(var c=!(b&&b.edge===!1),d=b&&b.tolerance,e=[],f=this.getVertices(),g=[],h=[],j=!1,l,n,o,q={point:!0,tolerance:d},r=null,m=0,p=f.length-2;m<=p;++m)if(d=f[m],g.push(d.clone()),l=f[m+1],n={x1:d.x,y1:d.y,x2:l.x,y2:l.y},n=GeoGlobe.Geometry.segmentsIntersect(a,n,q),n instanceof GeoGlobe.Geometry.Point&&((o=n.x===a.x1&&n.y===a.y1||n.x===a.x2&&n.y===a.y2||n.equals(d)||n.equals(l)?!0:!1)||c))n.equals(h[h.length-
1])||h.push(n.clone()),!(m===0&&n.equals(d))&&!n.equals(l)&&(j=!0,n.equals(d)||g.push(n),e.push(new GeoGlobe.Geometry.LineString(g)),g=[n.clone()]);j&&(g.push(l.clone()),e.push(new GeoGlobe.Geometry.LineString(g)));if(h.length>0)var t=a.x1<a.x2?1:-1,s=a.y1<a.y2?1:-1,r={lines:e,points:h.sort(function(a,b){return t*a.x-t*b.x||s*a.y-s*b.y})};return r},split:function(a,b){var c=null,d=b&&b.mutual,e,f,g,h;if(a instanceof GeoGlobe.Geometry.LineString){var j=this.getVertices(),l,n,o,q,r,m=[];g=[];for(var p=
0,t=j.length-2;p<=t;++p){l=j[p];n=j[p+1];o={x1:l.x,y1:l.y,x2:n.x,y2:n.y};h=h||[a];d&&m.push(l.clone());for(var s=0;s<h.length;++s)if(q=h[s].splitWithSegment(o,b))if(r=q.lines,r.length>0&&(r.unshift(s,1),Array.prototype.splice.apply(h,r),s+=r.length-2),d)for(var u=0,v=q.points.length;u<v;++u)r=q.points[u],r.equals(l)||(m.push(r),g.push(new GeoGlobe.Geometry.LineString(m)),m=r.equals(n)?[]:[r.clone()])}d&&g.length>0&&m.length>0&&(m.push(n.clone()),g.push(new GeoGlobe.Geometry.LineString(m)))}else c=
a.splitWith(this,b);h&&h.length>1?f=!0:h=[];g&&g.length>1?e=!0:g=[];if(f||e)c=d?[g,h]:h;return c},splitWith:function(a,b){return a.split(this,b)},getVertices:function(a){return a===!0?[this.components[0],this.components[this.components.length-1]]:a===!1?this.components.slice(1,this.components.length-1):this.components.slice()},distanceTo:function(a,b){var c=!(b&&b.edge===!1)&&b&&b.details,d,e={},f=Number.POSITIVE_INFINITY;if(a instanceof GeoGlobe.Geometry.Point){for(var g=this.getSortedSegments(),
h=a.x,j=a.y,l,n=0,o=g.length;n<o;++n)if(l=g[n],d=GeoGlobe.Geometry.distanceToSegment(a,l),d.distance<f){if(f=d.distance,e=d,f===0)break}else if(l.x2>h&&(j>l.y1&&j<l.y2||j<l.y1&&j>l.y2))break;e=c?{distance:e.distance,x0:e.x,y0:e.y,x1:h,y1:j}:e.distance}else if(a instanceof GeoGlobe.Geometry.LineString){var g=this.getSortedSegments(),h=a.getSortedSegments(),q,r,m=h.length,p={point:!0},n=0,o=g.length;a:for(;n<o;++n){j=g[n];l=j.x1;r=j.y1;for(var t=0;t<m;++t)if(d=h[t],q=GeoGlobe.Geometry.segmentsIntersect(j,
d,p)){f=0;e={distance:0,x0:q.x,y0:q.y,x1:q.x,y1:q.y};break a}else if(d=GeoGlobe.Geometry.distanceToSegment({x:l,y:r},d),d.distance<f)f=d.distance,e={distance:f,x0:l,y0:r,x1:d.x,y1:d.y}}if(!c)e=e.distance;f!==0&&j&&(d=a.distanceTo(new GeoGlobe.Geometry.Point(j.x2,j.y2),b),n=c?d.distance:d,n<f&&(e=c?{distance:f,x0:d.x1,y0:d.y1,x1:d.x0,y1:d.y0}:n))}else e=a.distanceTo(this,b),c&&(e={distance:e.distance,x0:e.x1,y0:e.y1,x1:e.x0,y1:e.y0});return e},simplify:function(a){if(this&&this!==null){var b=this.getVertices();
if(b.length<3)return this;var c=function(a,b,d,j){for(var l=0,n=0,o=b,q;o<d;o++)q=Math.abs(0.5*(a[b].x*a[d].y+a[d].x*a[o].y+a[o].x*a[b].y-a[d].x*a[b].y-a[o].x*a[d].y-a[b].x*a[o].y))/Math.sqrt(Math.pow(a[b].x-a[d].x,2)+Math.pow(a[b].y-a[d].y,2))*2,q>l&&(l=q,n=o);l>j&&n!=b&&(e.push(n),c(a,b,n,j),c(a,n,d,j))},d=b.length-1,e=[];e.push(0);for(e.push(d);b[0].equals(b[d]);)d--,e.push(d);c(b,0,d,a);a=[];e.sort(function(a,b){return a-b});for(d=0;d<e.length;d++)a.push(b[e[d]]);return new GeoGlobe.Geometry.LineString(a)}else return this},
CLASS_NAME:"GeoGlobe.Geometry.LineString"});GeoGlobe.Geometry.LineString.createCurveLine=function(a){for(var b=[],c=0;c<a.length-1;c++){var d=GeoGlobe.Geometry.LineString.getCurveCoordinatesByTwoPoints(a[c],a[c+1]);d&&d.length>0&&(b=b.concat(d))}return new GeoGlobe.Geometry.LineString(b)};
GeoGlobe.Geometry.LineString.getCurveCoordinatesByTwoPoints=function(a,b){if(!a||!b||!(a instanceof GeoGlobe.Geometry.Point)||!(b instanceof GeoGlobe.Geometry.Point))return null;curveCoordinates=[];var c,d,e,f=d=0;if(typeof b=="undefined")typeof curveCoordinates!="undefined"&&(curveCoordinates=[]);else{var g=parseFloat(a.y),h=parseFloat(b.y),j=parseFloat(a.x),l=parseFloat(b.x);l>j&&parseFloat(l-j)>180&&j<0&&(j=parseFloat(360+j));j>l&&parseFloat(j-l)>180&&l<0&&(l=parseFloat(360+l));e=0;h==g?(c=0,d=
j-l):l==j?(c=Math.PI/2,d=g-h):(c=Math.atan((h-g)/(l-j)),d=(h-g)/Math.sin(c));e==0&&(e=c+Math.PI/5);d/=2;c=d*Math.cos(e)+j;e=d*Math.sin(e)+g;for(d=0;d<31;d++)curveCoordinates.push(new GeoGlobe.Geometry.Point(j*(1-2*f+f*f)+c*(2*f-2*f*f)+l*f*f,g*(1-2*f+f*f)+e*(2*f-2*f*f)+h*f*f)),f+=1/30;return curveCoordinates}};
GeoGlobe.Geometry.LinearRing=GeoGlobe.Class4OL(GeoGlobe.Geometry.LineString,{componentTypes:["GeoGlobe.Geometry.Point"],addComponent:function(a,b){var c=!1,d=this.components.pop();if(b!=null||!a.equals(d))c=GeoGlobe.Geometry.Collection.prototype.addComponent.apply(this,arguments);GeoGlobe.Geometry.Collection.prototype.addComponent.apply(this,[this.components[0]]);return c},removeComponent:function(){var a=this.components&&this.components.length>3;a&&(this.components.pop(),GeoGlobe.Geometry.Collection.prototype.removeComponent.apply(this,
arguments),GeoGlobe.Geometry.Collection.prototype.addComponent.apply(this,[this.components[0]]));return a},move:function(a,b){for(var c=0,d=this.components.length;c<d-1;c++)this.components[c].move(a,b)},rotate:function(a,b){for(var c=0,d=this.components.length;c<d-1;++c)this.components[c].rotate(a,b)},resize:function(a,b,c){for(var d=0,e=this.components.length;d<e-1;++d)this.components[d].resize(a,b,c);return this},transform:function(a,b){if(a&&b){for(var c=0,d=this.components.length;c<d-1;c++)this.components[c].transform(a,
b);this.bounds=null}return this},getCentroid:function(){if(this.components){var a=this.components.length;if(a>0&&a<=2)return this.components[0].clone();else if(a>2){var b=0,c=0,d=this.components[0].x,e=this.components[0].y,f=-1*this.getArea();if(f!=0){for(var g=0;g<a-1;g++){var h=this.components[g],j=this.components[g+1];b+=(h.x+j.x-2*d)*((h.x-d)*(j.y-e)-(j.x-d)*(h.y-e));c+=(h.y+j.y-2*e)*((h.x-d)*(j.y-e)-(j.x-d)*(h.y-e))}b=d+b/(6*f);a=e+c/(6*f)}else{for(g=0;g<a-1;g++)b+=this.components[g].x,c+=this.components[g].y;
b/=a-1;a=c/(a-1)}return new GeoGlobe.Geometry.Point(b,a)}else return null}},getArea:function(){var a=0;if(this.components&&this.components.length>2){for(var b=a=0,c=this.components.length;b<c-1;b++){var d=this.components[b],e=this.components[b+1];a+=(d.x+e.x)*(e.y-d.y)}a=-a/2}return a},getGeodesicArea:function(a){var b=this;if(a){var c=new GeoGlobe.SpatialReference("EPSG:4326");c.equals(a)||(b=this.clone().transform(a,c))}a=0;c=b.components&&b.components.length;if(c>2){for(var d,e,f=0;f<c-1;f++)d=
b.components[f],e=b.components[f+1],a+=GeoGlobe.Util.rad(e.x-d.x)*(2+Math.sin(GeoGlobe.Util.rad(d.y))+Math.sin(GeoGlobe.Util.rad(e.y)));a=a*40680631590769/2}return a},containsPoint:function(a){for(var b=GeoGlobe.Number.limitSigDigs,c=b(a.x,14),a=b(a.y,14),d=this.components.length-1,e,f,g,h,j,l=0,n=0;n<d;++n)if(e=this.components[n],g=b(e.x,14),e=b(e.y,14),f=this.components[n+1],h=b(f.x,14),f=b(f.y,14),e==f){if(a==e&&(g<=h&&c>=g&&c<=h||g>=h&&c<=g&&c>=h)){l=-1;break}}else{j=b((a-f)*((h-g)/(f-e))+h,14);
if(j==c&&(e<f&&a>=e&&a<=f||e>f&&a<=e&&a>=f)){l=-1;break}j<=c||g!=h&&(j<Math.min(g,h)||j>Math.max(g,h))||(e<f&&a>=e&&a<f||e>f&&a<e&&a>=f)&&++l}return l==-1?1:!!(l&1)},intersects:function(a){var b=!1;if(a.CLASS_NAME=="GeoGlobe.Geometry.Point")b=this.containsPoint(a);else if(a.CLASS_NAME=="GeoGlobe.Geometry.LineString")b=a.intersects(this);else if(a.CLASS_NAME=="GeoGlobe.Geometry.LinearRing")b=GeoGlobe.Geometry.LineString.prototype.intersects.apply(this,[a]);else for(var c=0,d=a.components.length;c<
d;++c)if(b=a.components[c].intersects(this))break;return b},getVertices:function(a){return a===!0?[]:this.components.slice(0,this.components.length-1)},CLASS_NAME:"GeoGlobe.Geometry.LinearRing"});
GeoGlobe.Geometry.Polygon=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.LinearRing"],getArea:function(){var a=0;if(this.components&&this.components.length>0){a+=Math.abs(this.components[0].getArea());for(var b=1,c=this.components.length;b<c;b++)a-=Math.abs(this.components[b].getArea())}return a},getGeodesicArea:function(a){var b=0;if(this.components&&this.components.length>0){b+=Math.abs(this.components[0].getGeodesicArea(a));for(var c=1,d=this.components.length;c<
d;c++)b-=Math.abs(this.components[c].getGeodesicArea(a))}return b},containsPoint:function(a){var b=this.components.length,c=!1;if(b>0&&(c=this.components[0].containsPoint(a),c!==1&&c&&b>1))for(var d,e=1;e<b;++e)if(d=this.components[e].containsPoint(a)){c=d===1?1:!1;break}return c},intersects:function(a){var b=!1,c,d;if(a.CLASS_NAME=="GeoGlobe.Geometry.Point")b=this.containsPoint(a);else if(a.CLASS_NAME=="GeoGlobe.Geometry.LineString"||a.CLASS_NAME=="GeoGlobe.Geometry.LinearRing"){c=0;for(d=this.components.length;c<
d;++c)if(b=a.intersects(this.components[c]))break;if(!b){c=0;for(d=a.components.length;c<d;++c)if(b=this.containsPoint(a.components[c]))break}}else{c=0;for(d=a.components.length;c<d;++c)if(b=this.intersects(a.components[c]))break}if(!b&&a.CLASS_NAME=="GeoGlobe.Geometry.Polygon"){var e=this.components[0];c=0;for(d=e.components.length;c<d;++c)if(b=a.containsPoint(e.components[c]))break}return b},distanceTo:function(a,b){return b&&b.edge===!1&&this.intersects(a)?0:GeoGlobe.Geometry.Collection.prototype.distanceTo.apply(this,
[a,b])},CLASS_NAME:"GeoGlobe.Geometry.Polygon"});GeoGlobe.Geometry.Polygon.createRegularPolygon=function(a,b,c,d){var e=Math.PI*(1/c-0.5);d&&(e+=d/180*Math.PI);for(var f,g=[],h=0;h<c;++h)f=e+h*2*Math.PI/c,d=a.x+b*Math.cos(f),f=a.y+b*Math.sin(f),g.push(new GeoGlobe.Geometry.Point(d,f));a=new GeoGlobe.Geometry.LinearRing(g);return new GeoGlobe.Geometry.Polygon([a])};
GeoGlobe.Geometry.MultiLineString=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.LineString"],split:function(a,b){for(var c=null,d=b&&b.mutual,e,f,g,h,j=[],l=[a],n=0,o=this.components.length;n<o;++n){f=this.components[n];g=!1;for(var q=0;q<l.length;++q)if(e=f.split(l[q],b)){if(d){g=e[0];for(var r=0,m=g.length;r<m;++r)r===0&&j.length?j[j.length-1].addComponent(g[r]):j.push(new GeoGlobe.Geometry.MultiLineString([g[r]]));g=!0;e=e[1]}if(e.length){e.unshift(q,1);Array.prototype.splice.apply(l,
e);break}}g||(j.length?j[j.length-1].addComponent(f.clone()):j=[new GeoGlobe.Geometry.MultiLineString(f.clone())])}j&&j.length>1?g=!0:j=[];l&&l.length>1?h=!0:l=[];if(g||h)c=d?[j,l]:l;return c},splitWith:function(a,b){var c=null,d=b&&b.mutual,e,f,g,h,j,l;if(a instanceof GeoGlobe.Geometry.LineString){l=[];j=[a];for(var n=0,o=this.components.length;n<o;++n){g=!1;f=this.components[n];for(var q=0;q<j.length;++q)if(e=j[q].split(f,b)){d&&(g=e[0],g.length&&(g.unshift(q,1),Array.prototype.splice.apply(j,g),
q+=g.length-2),e=e[1],e.length===0&&(e=[f.clone()]));g=0;for(var r=e.length;g<r;++g)g===0&&l.length?l[l.length-1].addComponent(e[g]):l.push(new GeoGlobe.Geometry.MultiLineString([e[g]]));g=!0}g||(l.length?l[l.length-1].addComponent(f.clone()):l=[new GeoGlobe.Geometry.MultiLineString([f.clone()])])}}else c=a.split(this);j&&j.length>1?h=!0:j=[];l&&l.length>1?g=!0:l=[];if(h||g)c=d?[j,l]:l;return c},CLASS_NAME:"GeoGlobe.Geometry.MultiLineString"});
GeoGlobe.Geometry.MultiPolygon=GeoGlobe.Class4OL(GeoGlobe.Geometry.Collection,{componentTypes:["GeoGlobe.Geometry.Polygon"],CLASS_NAME:"GeoGlobe.Geometry.MultiPolygon"});GeoGlobe.State={UNKNOWN:"Unknown",INSERT:"Insert",UPDATE:"Update",DELETE:"Delete"};
GeoGlobe.Feature=GeoGlobe.Class4OL({id:null,fid:null,lonlat:null,geometry:null,attributes:null,data:null,bounds:null,state:null,url:null,modified:null,initialize:function(a,b){this.data=b!=null?b:{};this.id=GeoGlobe.Util.createUniqueID(this.CLASS_NAME+"_");this.lonlat=null;this.geometry=a?a:null;this.state=null;this.attributes={};if(b)this.attributes=GeoGlobe.Util.extend(this.attributes,b)},destroy:function(){this.data=this.lonlat=this.id=this.modified=this.geometry=null},clone:function(){return new GeoGlobe.Feature(this.geometry?
this.geometry.clone():null,this.attributes)},createMarker:function(){return null},destroyMarker:function(){},createPopup:function(){return null},atPoint:function(a,b,c){var d=!1;this.geometry&&(d=this.geometry.atPoint(a,b,c));return d},destroyPopup:function(){},toState:function(a){if(a==GeoGlobe.State.UPDATE)switch(this.state){case GeoGlobe.State.UNKNOWN:case GeoGlobe.State.DELETE:this.state=a}else if(a==GeoGlobe.State.INSERT)switch(this.state){case GeoGlobe.State.UNKNOWN:break;default:this.state=
a}else if(a==GeoGlobe.State.DELETE)switch(this.state){case GeoGlobe.State.UNKNOWN:case GeoGlobe.State.UPDATE:this.state=a}else if(a==GeoGlobe.State.UNKNOWN)this.state=a},CLASS_NAME:"GeoGlobe.Feature"});GeoGlobe.Feature.getBoundsByFeatures=function(a){for(var b=a.length,c=Array(b),d=0;d<b;++d)c[d]=a[d].geometry;a=new GeoGlobe.Geometry.Collection(c);a.calculateBounds();return a.bounds};
GeoGlobe.Feature.fromGeoJson=function(a){var b;GeoGlobe.Format&&GeoGlobe.Format.GeoJSON&&(format=new GeoGlobe.Format.GeoJSON,b=format.read(a));return b};GeoGlobe.Filter=GeoGlobe.Class4OL({initialize:function(a){GeoGlobe.Util.extend(this,a)},destroy:function(){},evaluate:function(){return!0},clone:function(){return null},toString:function(){return GeoGlobe.Format&&GeoGlobe.Format.CQL?GeoGlobe.Format.CQL.prototype.write(this):Object.prototype.toString.call(this)},CLASS_NAME:"GeoGlobe.Filter"});
GeoGlobe.Filter.FeatureId=GeoGlobe.Class4OL(GeoGlobe.Filter,{fids:null,type:"FID",initialize:function(a){this.fids=[];GeoGlobe.Filter.prototype.initialize.apply(this,[a])},evaluate:function(a){for(var b=0,c=this.fids.length;b<c;b++)if((a.fid||a.id)==this.fids[b])return!0;return!1},clone:function(){var a=new GeoGlobe.Filter.FeatureId;GeoGlobe.Util.extend(a,this);a.fids=this.fids.slice();return a},CLASS_NAME:"GeoGlobe.Filter.FeatureId"});
GeoGlobe.Filter.Logical=GeoGlobe.Class4OL(GeoGlobe.Filter,{filters:null,type:null,initialize:function(a){this.filters=[];GeoGlobe.Filter.prototype.initialize.apply(this,[a])},destroy:function(){this.filters=null;GeoGlobe.Filter.prototype.destroy.apply(this)},evaluate:function(a){var b,c;switch(this.type){case GeoGlobe.Filter.Logical.AND:b=0;for(c=this.filters.length;b<c;b++)if(this.filters[b].evaluate(a)==!1)return!1;return!0;case GeoGlobe.Filter.Logical.OR:b=0;for(c=this.filters.length;b<c;b++)if(this.filters[b].evaluate(a)==
!0)return!0;return!1;case GeoGlobe.Filter.Logical.NOT:return!this.filters[0].evaluate(a)}},clone:function(){for(var a=[],b=0,c=this.filters.length;b<c;++b)a.push(this.filters[b].clone());return new GeoGlobe.Filter.Logical({type:this.type,filters:a})},CLASS_NAME:"GeoGlobe.Filter.Logical"});GeoGlobe.Filter.Logical.AND="&&";GeoGlobe.Filter.Logical.OR="||";GeoGlobe.Filter.Logical.NOT="!";
GeoGlobe.Filter.Comparison=GeoGlobe.Class4OL(GeoGlobe.Filter,{type:null,property:null,value:null,matchCase:!0,lowerBoundary:null,upperBoundary:null,initialize:function(a){GeoGlobe.Filter.prototype.initialize.apply(this,[a]);if(this.type===GeoGlobe.Filter.Comparison.LIKE&&a.matchCase===void 0)this.matchCase=null},evaluate:function(a){if(a instanceof GeoGlobe.Feature)a=a.attributes;var b=!1,a=a[this.property];if(a===void 0)return!1;switch(this.type){case GeoGlobe.Filter.Comparison.EQUAL_TO:b=this.value;
b=!this.matchCase&&typeof a=="string"&&typeof b=="string"?a.toUpperCase()==b.toUpperCase():a==b;break;case GeoGlobe.Filter.Comparison.NOT_EQUAL_TO:b=this.value;b=!this.matchCase&&typeof a=="string"&&typeof b=="string"?a.toUpperCase()!=b.toUpperCase():a!=b;break;case GeoGlobe.Filter.Comparison.LESS_THAN:b=a<this.value;break;case GeoGlobe.Filter.Comparison.GREATER_THAN:b=a>this.value;break;case GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO:b=a<=this.value;break;case GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO:b=
a>=this.value;break;case GeoGlobe.Filter.Comparison.BETWEEN:b=a>=this.lowerBoundary&&a<=this.upperBoundary;break;case GeoGlobe.Filter.Comparison.LIKE:b=RegExp(this.value,"gi").test(a);break;case GeoGlobe.Filter.Comparison.IS_NULL:b=a===null}return b},value2regex:function(a,b,c){if(a==".")throw Error("'.' is an unsupported wildCard character for GeoGlobe.Filter.Comparison");a=a?a:"*";b=b?b:".";this.value=this.value.replace(RegExp("\\"+(c?c:"!")+"(.|$)","g"),"\\$1");this.value=this.value.replace(RegExp("\\"+
b,"g"),".");this.value=this.value.replace(RegExp("\\"+a,"g"),".*");this.value=this.value.replace(RegExp("\\\\.\\*","g"),"\\"+a);return this.value=this.value.replace(RegExp("\\\\\\.","g"),"\\"+b)},regex2value:function(){var a=this.value,a=a.replace(/!/g,"!!"),a=a.replace(/(\\)?\\\./g,function(a,c){return c?a:"!."}),a=a.replace(/(\\)?\\\*/g,function(a,c){return c?a:"!*"}),a=a.replace(/\\\\/g,"\\");return a=a.replace(/\.\*/g,"*")},clone:function(){return GeoGlobe.Util.extend(new GeoGlobe.Filter.Comparison,
this)},CLASS_NAME:"GeoGlobe.Filter.Comparison"});GeoGlobe.Filter.Comparison.EQUAL_TO="==";GeoGlobe.Filter.Comparison.NOT_EQUAL_TO="!=";GeoGlobe.Filter.Comparison.LESS_THAN="<";GeoGlobe.Filter.Comparison.GREATER_THAN=">";GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO="<=";GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO=">=";GeoGlobe.Filter.Comparison.BETWEEN="..";GeoGlobe.Filter.Comparison.LIKE="~";GeoGlobe.Filter.Comparison.IS_NULL="NULL";
GeoGlobe.Filter.Spatial=GeoGlobe.Class4OL(GeoGlobe.Filter,{type:null,property:null,value:null,distance:null,distanceUnits:null,evaluate:function(a){var b=!1;switch(this.type){case GeoGlobe.Filter.Spatial.BBOX:case GeoGlobe.Filter.Spatial.INTERSECTS:if(a.geometry){var c=this.value;this.value.CLASS_NAME=="GeoGlobe.LngLatBounds"&&(c=this.value.toGeometry());a.geometry.intersects(c)&&(b=!0)}break;default:throw Error("evaluate is not implemented for this filter type.");}return b},clone:function(){var a=
GeoGlobe.Util.applyDefaults({value:this.value&&this.value.clone&&this.value.clone()},this);return new GeoGlobe.Filter.Spatial(a)},CLASS_NAME:"GeoGlobe.Filter.Spatial"});GeoGlobe.Filter.Spatial.BBOX="BBOX";GeoGlobe.Filter.Spatial.INTERSECTS="INTERSECTS";GeoGlobe.Filter.Spatial.DWITHIN="DWITHIN";GeoGlobe.Filter.Spatial.WITHIN="WITHIN";GeoGlobe.Filter.Spatial.CONTAINS="CONTAINS";GeoGlobe.Filter.Function=GeoGlobe.Class4OL(GeoGlobe.Filter,{name:null,params:null,CLASS_NAME:"GeoGlobe.Filter.Function"});
GeoGlobe.Protocol=GeoGlobe.Class4OL({format:null,options:null,autoDestroy:!0,defaultFilter:null,initialize:function(a){a=a||{};GeoGlobe.Util.extend(this,a);this.options=a},mergeWithDefaultFilter:function(a){return a&&this.defaultFilter?new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.AND,filters:[this.defaultFilter,a]}):a||this.defaultFilter||void 0},destroy:function(){this.format=this.options=null},read:function(a){a=a||{};a.filter=this.mergeWithDefaultFilter(a.filter)},create:function(){},
update:function(){},"delete":function(){},commit:function(){},abort:function(){},createCallback:function(a,b,c){return GeoGlobe.Function.bind(function(){a.apply(this,[b,c])},this)},CLASS_NAME:"GeoGlobe.Protocol"});GeoGlobe.Protocol.Response=GeoGlobe.Class4OL({code:null,requestType:null,last:!0,features:null,data:null,reqFeatures:null,priv:null,error:null,initialize:function(a){GeoGlobe.Util.extend(this,a)},success:function(){return this.code>0},CLASS_NAME:"GeoGlobe.Protocol.Response"});
GeoGlobe.Protocol.Response.SUCCESS=1;GeoGlobe.Protocol.Response.FAILURE=0;
GeoGlobe.Protocol.HTTP=GeoGlobe.Class4OL(GeoGlobe.Protocol,{url:null,headers:null,params:null,callback:null,scope:null,readWithPOST:!1,updateWithPOST:!1,deleteWithPOST:!1,wildcarded:!1,srsInBBOX:!1,initialize:function(){this.params={};this.headers={};GeoGlobe.Protocol.prototype.initialize.apply(this,arguments);if(!this.filterToParams&&GeoGlobe.Format.QueryStringFilter){var a=new GeoGlobe.Format.QueryStringFilter({wildcarded:this.wildcarded,srsInBBOX:this.srsInBBOX});this.filterToParams=function(b,
c){return a.write(b,c)}}},destroy:function(){this.headers=this.params=null;GeoGlobe.Protocol.prototype.destroy.apply(this)},read:function(a){GeoGlobe.Protocol.prototype.read.apply(this,arguments);a=a||{};a.params=GeoGlobe.Util.applyDefaults(a.params,this.options.params);a=GeoGlobe.Util.applyDefaults(a,this.options);if(a.filter&&this.filterToParams)a.params=this.filterToParams(a.filter,a.params);var b=a.readWithPOST!==void 0?a.readWithPOST:this.readWithPOST,c=new GeoGlobe.Protocol.Response({requestType:"read"});
b?(b=a.headers||{},b["Content-Type"]="application/x-www-form-urlencoded",c.priv=GeoGlobe.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,c,a),data:GeoGlobe.Util.getParameterString(a.params),headers:b})):c.priv=GeoGlobe.Request.GET({url:a.url,callback:this.createCallback(this.handleRead,c,a),params:a.params,headers:a.headers});return c},handleRead:function(a,b){this.handleResponse(a,b)},create:function(a,b){var b=GeoGlobe.Util.applyDefaults(b,this.options),c=new GeoGlobe.Protocol.Response({reqFeatures:a,
requestType:"create"});c.priv=GeoGlobe.Request.POST({url:b.url,callback:this.createCallback(this.handleCreate,c,b),headers:b.headers,data:this.format.write(a)});return c},handleCreate:function(a,b){this.handleResponse(a,b)},update:function(a,b){var b=b||{},c=b.url||a.url||this.options.url+"/"+a.fid,b=GeoGlobe.Util.applyDefaults(b,this.options),d=new GeoGlobe.Protocol.Response({reqFeatures:a,requestType:"update"});d.priv=GeoGlobe.Request[this.updateWithPOST?"POST":"PUT"]({url:c,callback:this.createCallback(this.handleUpdate,
d,b),headers:b.headers,data:this.format.write(a)});return d},handleUpdate:function(a,b){this.handleResponse(a,b)},"delete":function(a,b){var b=b||{},c=b.url||a.url||this.options.url+"/"+a.fid,b=GeoGlobe.Util.applyDefaults(b,this.options),d=new GeoGlobe.Protocol.Response({reqFeatures:a,requestType:"delete"}),e=this.deleteWithPOST?"POST":"DELETE",c={url:c,callback:this.createCallback(this.handleDelete,d,b),headers:b.headers};if(this.deleteWithPOST)c.data=this.format.write(a);d.priv=GeoGlobe.Request[e](c);
return d},handleDelete:function(a,b){this.handleResponse(a,b)},handleResponse:function(a,b){var c=a.priv;if(b.callback){if(c.status>=200&&c.status<300){if(a.requestType!="delete")a.features=this.parseFeatures(c);a.code=GeoGlobe.Protocol.Response.SUCCESS}else a.code=GeoGlobe.Protocol.Response.FAILURE;b.callback.call(b.scope,a)}},parseFeatures:function(a){var b=a.responseXML;if(!b||!b.documentElement)b=a.responseText;if(!b||b.length<=0)return null;return this.format.read(b)},commit:function(a,b){function c(a){for(var b=
a.features?a.features.length:0,c=Array(b),e=0;e<b;++e)c[e]=a.features[e].fid;m.insertIds=c;d.apply(this,[a])}function d(a){this.callUserCallback(a,b);r=r&&a.success();f++;if(f>=q&&b.callback)m.code=r?GeoGlobe.Protocol.Response.SUCCESS:GeoGlobe.Protocol.Response.FAILURE,b.callback.apply(b.scope,[m])}var b=GeoGlobe.Util.applyDefaults(b,this.options),e=[],f=0,g={};g[GeoGlobe.State.INSERT]=[];g[GeoGlobe.State.UPDATE]=[];g[GeoGlobe.State.DELETE]=[];for(var h,j,l=[],n=0,o=a.length;n<o;++n)if(h=a[n],j=g[h.state])j.push(h),
l.push(h);var q=(g[GeoGlobe.State.INSERT].length>0?1:0)+g[GeoGlobe.State.UPDATE].length+g[GeoGlobe.State.DELETE].length,r=!0,m=new GeoGlobe.Protocol.Response({reqFeatures:l});h=g[GeoGlobe.State.INSERT];h.length>0&&e.push(this.create(h,GeoGlobe.Util.applyDefaults({callback:c,scope:this},b.create)));h=g[GeoGlobe.State.UPDATE];for(n=h.length-1;n>=0;--n)e.push(this.update(h[n],GeoGlobe.Util.applyDefaults({callback:d,scope:this},b.update)));h=g[GeoGlobe.State.DELETE];for(n=h.length-1;n>=0;--n)e.push(this["delete"](h[n],
GeoGlobe.Util.applyDefaults({callback:d,scope:this},b["delete"])));return e},abort:function(a){a&&a.priv.abort()},callUserCallback:function(a,b){var c=b[a.requestType];c&&c.callback&&c.callback.call(c.scope,a)},CLASS_NAME:"GeoGlobe.Protocol.HTTP"});GeoGlobe.Protocol.WFS=function(a){var a=GeoGlobe.Util.applyDefaults(a,GeoGlobe.Protocol.WFS.DEFAULTS),b=GeoGlobe.Protocol.WFS["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported WFS version: "+a.version;return new b(a)};
GeoGlobe.Protocol.WFS.DEFAULTS={version:"1.0.0"};
GeoGlobe.Protocol.WFS.v1=GeoGlobe.Class4OL(GeoGlobe.Protocol,{version:null,srsName:"EPSG:4326",featureType:null,featureNS:null,geometryName:"the_geom",schema:null,featurePrefix:"feature",formatOptions:null,readFormat:null,readOptions:null,initialize:function(a){GeoGlobe.Protocol.prototype.initialize.apply(this,[a]);if(!a.format)this.format=GeoGlobe.Format.WFST(GeoGlobe.Util.extend({version:this.version,featureType:this.featureType,featureNS:this.featureNS,featurePrefix:this.featurePrefix,geometryName:this.geometryName,
srsName:this.srsName,schema:this.schema},this.formatOptions));!a.geometryName&&parseFloat(this.format.version)>1&&this.setGeometryName(null)},destroy:function(){this.options&&!this.options.format&&this.format.destroy();this.format=null;GeoGlobe.Protocol.prototype.destroy.apply(this)},read:function(a){GeoGlobe.Protocol.prototype.read.apply(this,arguments);a=GeoGlobe.Util.extend({},a);GeoGlobe.Util.applyDefaults(a,this.options||{});var b=new GeoGlobe.Protocol.Response({requestType:"read"}),c=GeoGlobe.Format.XML.prototype.write.apply(this.format,
[this.format.writeNode("wfs:GetFeature",a)]);b.priv=GeoGlobe.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,b,a),params:a.params,headers:a.headers,data:c});return b},setFeatureType:function(a){this.featureType=a;this.format.featureType=a},setGeometryName:function(a){this.geometryName=a;this.format.geometryName=a},handleRead:function(a,b){b=GeoGlobe.Util.extend({},b);GeoGlobe.Util.applyDefaults(b,this.options);if(b.callback){var c=a.priv;c.status>=200&&c.status<300?(c=this.parseResponse(c,
b.readOptions))&&c.success!==!1?(b.readOptions&&b.readOptions.output=="object"?GeoGlobe.Util.extend(a,c):a.features=c,a.code=GeoGlobe.Protocol.Response.SUCCESS):(a.code=GeoGlobe.Protocol.Response.FAILURE,a.error=c):a.code=GeoGlobe.Protocol.Response.FAILURE;b.callback.call(b.scope,a)}},parseResponse:function(a,b){var c=a.responseXML;if(!c||!c.documentElement)c=a.responseText;if(!c||c.length<=0)return null;var d=null;try{d=this.readFormat!==null?this.readFormat.read(c):this.format.read(c,b)}catch(e){alert("\u7a0b\u5e8f\u8fd0\u884c\u5f02\u5e38\uff1a"+
e.name+"\uff0c"+e.message)}if(!this.featureNS)c=this.readFormat||this.format,this.featureNS=c.featureNS,c.autoConfig=!1,this.geometryName||this.setGeometryName(c.geometryName);return d},commit:function(a,b){b=GeoGlobe.Util.extend({},b);GeoGlobe.Util.applyDefaults(b,this.options);var c=new GeoGlobe.Protocol.Response({requestType:"commit",reqFeatures:a});c.priv=GeoGlobe.Request.POST({url:b.url,headers:b.headers,data:this.format.write(a,b),callback:this.createCallback(this.handleCommit,c,b)});return c},
handleCommit:function(a,b){if(b.callback){var c=a.priv,d=c.responseXML;if(!d||!d.documentElement)d=c.responseText;c=this.format.read(d)||{};a.insertIds=c.insertIds||[];c.success?a.code=GeoGlobe.Protocol.Response.SUCCESS:(a.code=GeoGlobe.Protocol.Response.FAILURE,a.error=c);b.callback.call(b.scope,a)}},filterDelete:function(a,b){b=GeoGlobe.Util.extend({},b);GeoGlobe.Util.applyDefaults(b,this.options);new GeoGlobe.Protocol.Response({requestType:"commit"});var c=this.format.createElementNSPlus("wfs:Transaction",
{attributes:{service:"WFS",version:this.version}}),d=this.format.createElementNSPlus("wfs:Delete",{attributes:{typeName:(b.featureNS?this.featurePrefix+":":"")+b.featureType}});b.featureNS&&d.setAttribute("xmlns:"+this.featurePrefix,b.featureNS);var e=this.format.writeNode("ogc:Filter",a);d.appendChild(e);c.appendChild(d);c=GeoGlobe.Format.XML.prototype.write.apply(this.format,[c]);return GeoGlobe.Request.POST({url:this.url,callback:b.callback||function(){},data:c})},abort:function(a){a&&a.priv.abort()},
CLASS_NAME:"GeoGlobe.Protocol.WFS.v1"});GeoGlobe.Protocol.WFS.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Protocol.WFS.v1,{version:"1.0.0",CLASS_NAME:"GeoGlobe.Protocol.WFS.v1_0_0"});
GeoGlobe.Protocol.WFS.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Protocol.WFS.v1,{version:"1.1.0",initialize:function(){GeoGlobe.Protocol.WFS.v1.prototype.initialize.apply(this,arguments);if(this.outputFormat&&!this.readFormat)if(this.outputFormat.toLowerCase()=="gml2")this.readFormat=new GeoGlobe.Format.GML.v2({featureType:this.featureType,featureNS:this.featureNS,geometryName:this.geometryName});else if(this.outputFormat.toLowerCase()=="json")this.readFormat=new GeoGlobe.Format.GeoJSON},CLASS_NAME:"GeoGlobe.Protocol.WFS.v1_1_0"});
GeoGlobe.Protocol.CSW=function(a){var a=GeoGlobe.Util.applyDefaults(a,GeoGlobe.Protocol.CSW.DEFAULTS),b=GeoGlobe.Protocol.CSW["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported CSW version: "+a.version;return new b(a)};GeoGlobe.Protocol.CSW.DEFAULTS={version:"2.0.2"};
GeoGlobe.Protocol.CSW.v2_0_2=GeoGlobe.Class4OL(GeoGlobe.Protocol,{formatOptions:null,initialize:function(a){GeoGlobe.Protocol.prototype.initialize.apply(this,[a]);if(!a.format)this.format=new GeoGlobe.Format.CSWGetRecords.v2_0_2(GeoGlobe.Util.extend({},this.formatOptions))},destroy:function(){this.options&&!this.options.format&&this.format.destroy();this.format=null;GeoGlobe.Protocol.prototype.destroy.apply(this)},read:function(a){a=GeoGlobe.Util.extend({},a);GeoGlobe.Util.applyDefaults(a,this.options||
{});var b=new GeoGlobe.Protocol.Response({requestType:"read"}),c=this.format.write(a.params||a);b.priv=GeoGlobe.Request.POST({url:a.url,callback:this.createCallback(this.handleRead,b,a),params:a.params,headers:a.headers,data:c});return b},handleRead:function(a,b){if(b.callback){var c=a.priv;c.status>=200&&c.status<300?(a.data=this.parseData(c),a.code=GeoGlobe.Protocol.Response.SUCCESS):a.code=GeoGlobe.Protocol.Response.FAILURE;b.callback.call(b.scope,a)}},parseData:function(a){var b=a.responseXML;
if(!b||!b.documentElement)b=a.responseText;if(!b||b.length<=0)return null;return this.format.read(b)},CLASS_NAME:"GeoGlobe.Protocol.CSW.v2_0_2"});
GeoGlobe.Protocol.Script=GeoGlobe.Class4OL(GeoGlobe.Protocol,{url:null,params:null,callback:null,callbackTemplate:"GeoGlobe.Protocol.Script.registry.${id}",callbackKey:"callback",callbackPrefix:"",scope:null,format:null,pendingRequests:null,srsInBBOX:!1,initialize:function(){this.params={};this.pendingRequests={};GeoGlobe.Protocol.prototype.initialize.apply(this,arguments);if(!this.format)this.format=new GeoGlobe.Format.GeoJSON;if(!this.filterToParams&&GeoGlobe.Format.QueryStringFilter){var a=new GeoGlobe.Format.QueryStringFilter({srsInBBOX:this.srsInBBOX});
this.filterToParams=function(b,c){return a.write(b,c)}}},read:function(a){GeoGlobe.Protocol.prototype.read.apply(this,arguments);a=GeoGlobe.Util.applyDefaults(a,this.options);a.params=GeoGlobe.Util.applyDefaults(a.params,this.options.params);if(a.filter&&this.filterToParams)a.params=this.filterToParams(a.filter,a.params);var b=new GeoGlobe.Protocol.Response({requestType:"read"}),c=this.createRequest(a.url,a.params,GeoGlobe.Function.bind(function(c){b.data=c;this.handleRead(b,a)},this));b.priv=c;return b},
createRequest:function(a,b,c){var c=GeoGlobe.Protocol.Script.register(c),d=GeoGlobe.String.format(this.callbackTemplate,{id:c}),b=GeoGlobe.Util.extend({},b);b[this.callbackKey]=this.callbackPrefix+d;a=GeoGlobe.Util.urlAppend(a,GeoGlobe.Util.getParameterString(b));b=document.createElement("script");b.type="text/javascript";b.src=a;b.id="GeoGlobe_Protocol_Script_"+c;this.pendingRequests[b.id]=b;document.getElementsByTagName("head")[0].appendChild(b);return b},destroyRequest:function(a){GeoGlobe.Protocol.Script.unregister(a.id.split("_").pop());
delete this.pendingRequests[a.id];a.parentNode&&a.parentNode.removeChild(a)},handleRead:function(a,b){this.handleResponse(a,b)},handleResponse:function(a,b){if(b.callback)a.data?(a.features=this.parseFeatures(a.data),a.code=GeoGlobe.Protocol.Response.SUCCESS):a.code=GeoGlobe.Protocol.Response.FAILURE,this.destroyRequest(a.priv),b.callback.call(b.scope,a)},parseFeatures:function(a){return this.format.read(a)},abort:function(a){if(a)this.destroyRequest(a.priv);else for(var b in this.pendingRequests)this.destroyRequest(this.pendingRequests[b])},
destroy:function(){this.abort();delete this.params;delete this.format;GeoGlobe.Protocol.prototype.destroy.apply(this)},CLASS_NAME:"GeoGlobe.Protocol.Script"});(function(){var a=GeoGlobe.Protocol.Script,b=0;a.registry={};a.register=function(c){var d="c"+ ++b;a.registry[d]=function(){c.apply(this,arguments)};return d};a.unregister=function(b){delete a.registry[b]}})();
GeoGlobe.Format=GeoGlobe.Class4OL({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(a){GeoGlobe.Util.extend(this,a);this.options=a},destroy:function(){},read:function(){throw Error("Read not implemented.");},write:function(){throw Error("Write not implemented.");},CLASS_NAME:"GeoGlobe.Format"});
GeoGlobe.Format.XML=GeoGlobe.Class4OL(GeoGlobe.Format,{namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(a){if(window.ActiveXObject)this.xmldom=new ActiveXObject("Microsoft.XMLDOM");GeoGlobe.Format.prototype.initialize.apply(this,[a]);this.namespaces=GeoGlobe.Util.extend({},this.namespaces);this.namespaceAlias={};for(var b in this.namespaces)this.namespaceAlias[this.namespaces[b]]=b},destroy:function(){this.xmldom=null;GeoGlobe.Format.prototype.destroy.apply(this,
arguments)},setNamespace:function(a,b){this.namespaces[a]=b;this.namespaceAlias[b]=a},read:function(a){var b=a.indexOf("<");b>0&&(a=a.substring(b));b=GeoGlobe.Util.Try(GeoGlobe.Function.bind(function(){var b;b=window.ActiveXObject&&!this.xmldom?new ActiveXObject("Microsoft.XMLDOM"):this.xmldom;b.loadXML(a);return b},this),function(){return(new DOMParser).parseFromString(a,"text/xml")},function(){var b=new XMLHttpRequest;b.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(a),!1);b.overrideMimeType&&
b.overrideMimeType("text/xml");b.send(null);return b.responseXML});if(this.keepData)this.data=b;return b},write:function(a){if(a.xml)a=a.xml;else{var b=new XMLSerializer;if(a.nodeType==1){var c=document.implementation.createDocument("","",null);c.importNode&&(a=c.importNode(a,!0));c.appendChild(a);a=b.serializeToString(c)}else a=b.serializeToString(a)}return a},createElementNS:function(a,b){return this.xmldom?typeof a=="string"?this.xmldom.createNode(1,b,a):this.xmldom.createNode(1,b,""):document.createElementNS(a,
b)},createDocumentFragment:function(){return this.xmldom?this.xmldom.createDocumentFragment():document.createDocumentFragment()},createTextNode:function(a){typeof a!=="string"&&(a=String(a));return this.xmldom?this.xmldom.createTextNode(a):document.createTextNode(a)},getElementsByTagNameNS:function(a,b,c){var d=[];if(a.getElementsByTagNameNS)d=a.getElementsByTagNameNS(b,c);else for(var a=a.getElementsByTagName("*"),e,f,g=0,h=a.length;g<h;++g)if(e=a[g],f=e.prefix?e.prefix+":"+c:c,c=="*"||f==e.nodeName)(b==
"*"||b==e.namespaceURI)&&d.push(e);return d},getAttributeNodeNS:function(a,b,c){var d=null;if(a.getAttributeNodeNS)d=a.getAttributeNodeNS(b,c);else for(var a=a.attributes,e,f,g=0,h=a.length;g<h;++g)if(e=a[g],e.namespaceURI==b&&(f=e.prefix?e.prefix+":"+c:c,f==e.nodeName)){d=e;break}return d},getAttributeNS:function(a,b,c){var d="";if(a.getAttributeNS)d=a.getAttributeNS(b,c)||"";else if(a=this.getAttributeNodeNS(a,b,c))d=a.nodeValue;return d},getChildValue:function(a,b){var c=b||"";if(a)for(var d=a.firstChild;d;d=
d.nextSibling)switch(d.nodeType){case 3:case 4:c+=d.nodeValue}return c},isSimpleContent:function(a){for(var b=!0,a=a.firstChild;a;a=a.nextSibling)if(a.nodeType===1){b=!1;break}return b},contentType:function(a){for(var b=!1,c=!1,d=GeoGlobe.Format.XML.CONTENT_TYPE.EMPTY,a=a.firstChild;a;a=a.nextSibling){switch(a.nodeType){case 1:c=!0;break;case 8:break;default:b=!0}if(c&&b)break}if(c&&b)d=GeoGlobe.Format.XML.CONTENT_TYPE.MIXED;else if(c)return GeoGlobe.Format.XML.CONTENT_TYPE.COMPLEX;else if(b)return GeoGlobe.Format.XML.CONTENT_TYPE.SIMPLE;
return d},hasAttributeNS:function(a,b,c){var d=!1;return d=a.hasAttributeNS?a.hasAttributeNS(b,c):!!this.getAttributeNodeNS(a,b,c)},setAttributeNS:function(a,b,c,d){if(a.setAttributeNS)a.setAttributeNS(b,c,d);else if(this.xmldom)b?(b=a.ownerDocument.createNode(2,c,b),b.nodeValue=d,a.setAttributeNode(b)):a.setAttribute(c,d);else throw"setAttributeNS not implemented";},createElementNSPlus:function(a,b){var b=b||{},c=b.uri||this.namespaces[b.prefix];c||(c=a.indexOf(":"),c=this.namespaces[a.substring(0,
c)]);c||(c=this.namespaces[this.defaultPrefix]);c=this.createElementNS(c,a);b.attributes&&this.setAttributes(c,b.attributes);var d=b.value;d!=null&&c.appendChild(this.createTextNode(d));return c},setAttributes:function(a,b){var c,d,e;for(e in b)b[e]!=null&&b[e].toString&&(c=b[e].toString(),d=this.namespaces[e.substring(0,e.indexOf(":"))]||null,this.setAttributeNS(a,d,e,c))},readNode:function(a,b){b||(b={});var c=this.readers[a.namespaceURI?this.namespaceAlias[a.namespaceURI]:this.defaultPrefix];if(c){var d=
a.localName||a.nodeName.split(":").pop();(c=c[d]||c["*"])&&c.apply(this,[a,b])}return b},readChildNodes:function(a,b){b||(b={});for(var c=a.childNodes,d,e=0,f=c.length;e<f;++e)d=c[e],d.nodeType==1&&this.readNode(d,b);return b},writeNode:function(a,b,c){var d,e=a.indexOf(":");e>0?(d=a.substring(0,e),a=a.substring(e+1)):d=c?this.namespaceAlias[c.namespaceURI]:this.defaultPrefix;b=this.writers[d][a].apply(this,[b]);c&&c.appendChild(b);return b},getChildEl:function(a,b,c){return a&&this.getThisOrNextEl(a.firstChild,
b,c)},getNextEl:function(a,b,c){return a&&this.getThisOrNextEl(a.nextSibling,b,c)},getThisOrNextEl:function(a,b,c){a:for(;a;a=a.nextSibling)switch(a.nodeType){case 1:if((!b||b===(a.localName||a.nodeName.split(":").pop()))&&(!c||c===a.namespaceURI))break a;a=null;break a;case 3:if(/^\s*$/.test(a.nodeValue))break;case 4:case 6:case 12:case 10:case 11:a=null;break a}return a||null},lookupNamespaceURI:function(a,b){var c=null;if(a)if(a.lookupNamespaceURI)c=a.lookupNamespaceURI(b);else a:switch(a.nodeType){case 1:if(a.namespaceURI!==
null&&a.prefix===b){c=a.namespaceURI;break a}if(c=a.attributes.length)for(var d,e=0;e<c;++e)if(d=a.attributes[e],d.prefix==="xmlns"&&d.name==="xmlns:"+b){c=d.value||null;break a}else if(d.name==="xmlns"&&b===null){c=d.value||null;break a}c=this.lookupNamespaceURI(a.parentNode,b);break a;case 2:c=this.lookupNamespaceURI(a.ownerElement,b);break a;case 9:c=this.lookupNamespaceURI(a.documentElement,b);break a;case 6:case 12:case 10:case 11:break a;default:c=this.lookupNamespaceURI(a.parentNode,b)}return c},
getXMLDoc:function(){if(!GeoGlobe.Format.XML.document&&!this.xmldom)if(document.implementation&&document.implementation.createDocument)GeoGlobe.Format.XML.document=document.implementation.createDocument("","",null);else if(!this.xmldom&&window.ActiveXObject)this.xmldom=new ActiveXObject("Microsoft.XMLDOM");return GeoGlobe.Format.XML.document||this.xmldom},CLASS_NAME:"GeoGlobe.Format.XML"});GeoGlobe.Format.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3};
GeoGlobe.Format.XML.lookupNamespaceURI=GeoGlobe.Function.bind(GeoGlobe.Format.XML.prototype.lookupNamespaceURI,GeoGlobe.Format.XML.prototype);GeoGlobe.Format.XML.document=null;
GeoGlobe.Format.XML.VersionedOGC=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{defaultVersion:null,version:null,profile:null,allowFallback:!1,name:null,stringifyOutput:!1,parser:null,initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a]);a=this.CLASS_NAME;this.name=a.substring(a.lastIndexOf(".")+1)},getVersion:function(a,b){var c;if(a){if(c=this.version,!c&&(c=a.getAttribute("version"),!c))c=this.defaultVersion}else c=b&&b.version||this.version||this.defaultVersion;return c},getParser:function(a){var a=
a||this.defaultVersion,b=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=a){var c=GeoGlobe.Format[this.name]["v"+a.replace(/\./g,"_")+b];if(!c&&(b!==""&&this.allowFallback&&(b="",c=GeoGlobe.Format[this.name]["v"+a.replace(/\./g,"_")]),!c))throw"Can't find a "+this.name+" parser for version "+a+b;this.parser=new c(this.options)}return this.parser},write:function(a,b){this.parser=this.getParser(this.getVersion(null,b));var c=this.parser.write(a,b);return this.stringifyOutput===
!1?c:GeoGlobe.Format.XML.prototype.write.apply(this,[c])},read:function(a,b){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));var c=this.getVersion(a.documentElement);this.parser=this.getParser(c);var d=this.parser.read(a,b),e=this.parser.errorProperty||null;if(e!==null&&d[e]===void 0)e=new GeoGlobe.Format.OGCExceptionReport,d.error=e.read(a);d.version=c;return d},CLASS_NAME:"GeoGlobe.Format.XML.VersionedOGC"});
GeoGlobe.Format.GML=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(a){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g};GeoGlobe.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){typeof a==
"string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));for(var a=this.getElementsByTagNameNS(a.documentElement,this.gmlns,this.featureName),b=[],c=0;c<a.length;c++){var d=this.parseFeature(a[c]);d&&b.push(d)}return b},parseFeature:function(a){for(var b=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],c,d,e,f=0;f<b.length;++f)if(c=b[f],d=this.getElementsByTagNameNS(a,this.gmlns,c),d.length>0){if(e=this.parseGeometry[c.toLowerCase()])e=e.apply(this,
[d[0]]),this.internalProjection&&this.externalProjection&&e.transform(this.externalProjection,this.internalProjection);else throw new TypeError("Unsupported geometry type: "+c);break}var g;c=this.getElementsByTagNameNS(a,this.gmlns,"Box");for(f=0;f<c.length;++f)b=c[f],d=this.parseGeometry.box.apply(this,[b]),b=b.parentNode,(b.localName||b.nodeName.split(":").pop())==="boundedBy"?g=d:e=d.toGeometry();var h;this.extractAttributes&&(h=this.parseAttributes(a));h=new GeoGlobe.Feature(e,h);h.bounds=g;h.gml=
{featureType:a.firstChild.nodeName.split(":")[1],featureNS:a.firstChild.namespaceURI,featureNSPrefix:a.firstChild.prefix};for(var a=a.firstChild,j;a;){if(a.nodeType==1&&(j=a.getAttribute("fid")||a.getAttribute("id")))break;a=a.nextSibling}h.fid=j;return h},parseGeometry:{point:function(a){var b,c;c=[];b=this.getElementsByTagNameNS(a,this.gmlns,"pos");if(b.length>0)c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),c=c.split(this.regExes.splitSpace);if(c.length==0&&(b=this.getElementsByTagNameNS(a,
this.gmlns,"coordinates"),b.length>0))c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.removeSpace,""),c=c.split(",");c.length==0&&(b=this.getElementsByTagNameNS(a,this.gmlns,"coord"),b.length>0&&(a=this.getElementsByTagNameNS(b[0],this.gmlns,"X"),b=this.getElementsByTagNameNS(b[0],this.gmlns,"Y"),a.length>0&&b.length>0&&(c=[a[0].firstChild.nodeValue,b[0].firstChild.nodeValue])));c.length==2&&(c[2]=null);return this.xy?new GeoGlobe.Geometry.Point(c[0],c[1],c[2]):new GeoGlobe.Geometry.Point(c[1],
c[0],c[2])},multipoint:function(a){var a=this.getElementsByTagNameNS(a,this.gmlns,"Point"),b=[];if(a.length>0)for(var c,d=0;d<a.length;++d)(c=this.parseGeometry.point.apply(this,[a[d]]))&&b.push(c);return new GeoGlobe.Geometry.MultiPoint(b)},linestring:function(a,b){var c,d;d=[];var e=[];c=this.getElementsByTagNameNS(a,this.gmlns,"posList");if(c.length>0){d=this.getChildValue(c[0]);d=d.replace(this.regExes.trimSpace,"");d=d.split(this.regExes.splitSpace);var f=parseInt(c[0].getAttribute("dimension")),
g,h,j;for(c=0;c<d.length/f;++c)g=c*f,h=d[g],j=d[g+1],g=f==2?null:d[g+2],this.xy?e.push(new GeoGlobe.Geometry.Point(h,j,g)):e.push(new GeoGlobe.Geometry.Point(j,h,g))}if(d.length==0&&(c=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),c.length>0)){d=this.getChildValue(c[0]);d=d.replace(this.regExes.trimSpace,"");d=d.replace(this.regExes.trimComma,",");f=d.split(this.regExes.splitSpace);for(c=0;c<f.length;++c)d=f[c].split(","),d.length==2&&(d[2]=null),this.xy?e.push(new GeoGlobe.Geometry.Point(d[0],
d[1],d[2])):e.push(new GeoGlobe.Geometry.Point(d[1],d[0],d[2]))}d=null;e.length!=0&&(d=b?new GeoGlobe.Geometry.LinearRing(e):new GeoGlobe.Geometry.LineString(e));return d},multilinestring:function(a){var a=this.getElementsByTagNameNS(a,this.gmlns,"LineString"),b=[];if(a.length>0)for(var c,d=0;d<a.length;++d)(c=this.parseGeometry.linestring.apply(this,[a[d]]))&&b.push(c);return new GeoGlobe.Geometry.MultiLineString(b)},polygon:function(a){var a=this.getElementsByTagNameNS(a,this.gmlns,"LinearRing"),
b=[];if(a.length>0)for(var c,d=0;d<a.length;++d)(c=this.parseGeometry.linestring.apply(this,[a[d],!0]))&&b.push(c);return new GeoGlobe.Geometry.Polygon(b)},multipolygon:function(a){var a=this.getElementsByTagNameNS(a,this.gmlns,"Polygon"),b=[];if(a.length>0)for(var c,d=0;d<a.length;++d)(c=this.parseGeometry.polygon.apply(this,[a[d]]))&&b.push(c);return new GeoGlobe.Geometry.MultiPolygon(b)},envelope:function(a){var b=[],c,d,e=this.getElementsByTagNameNS(a,this.gmlns,"lowerCorner");if(e.length>0){c=
[];if(e.length>0)c=e[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),c=c.split(this.regExes.splitSpace);c.length==2&&(c[2]=null);var f=this.xy?new GeoGlobe.Geometry.Point(c[0],c[1],c[2]):new GeoGlobe.Geometry.Point(c[1],c[0],c[2])}a=this.getElementsByTagNameNS(a,this.gmlns,"upperCorner");if(a.length>0){c=[];if(a.length>0)c=a[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),c=c.split(this.regExes.splitSpace);c.length==2&&(c[2]=null);var g=this.xy?new GeoGlobe.Geometry.Point(c[0],
c[1],c[2]):new GeoGlobe.Geometry.Point(c[1],c[0],c[2])}f&&g&&(b.push(new GeoGlobe.Geometry.Point(f.x,f.y)),b.push(new GeoGlobe.Geometry.Point(g.x,f.y)),b.push(new GeoGlobe.Geometry.Point(g.x,g.y)),b.push(new GeoGlobe.Geometry.Point(f.x,g.y)),b.push(new GeoGlobe.Geometry.Point(f.x,f.y)),b=new GeoGlobe.Geometry.LinearRing(b),d=new GeoGlobe.Geometry.Polygon([b]));return d},box:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),c=null,a=null;if(b.length>0)b=b[0].firstChild.nodeValue,
b=b.split(" "),b.length==2&&(c=b[0].split(","),a=b[1].split(","));if(c!==null&&a!==null)return c=new GeoGlobe.LngLat(parseFloat(c[0]),parseFloat(c[1])),a=new GeoGlobe.LngLat(parseFloat(a[0]),parseFloat(a[1])),new GeoGlobe.LngLatBounds(c,a)}},parseAttributes:function(a){for(var b={},a=a.firstChild,c,d,e;a;){if(a.nodeType==1){a=a.childNodes;for(c=0;c<a.length;++c)if(d=a[c],d.nodeType==1)if(e=d.childNodes,e.length==1){if(e=e[0],e.nodeType==3||e.nodeType==4)d=d.prefix?d.nodeName.split(":")[1]:d.nodeName,
e=e.nodeValue.replace(this.regExes.trimSpace,""),b[d]=e}else b[d.nodeName.split(":").pop()]=null;break}a=a.nextSibling}return b},write:function(a){GeoGlobe.Util.isArray(a)||(a=[a]);for(var b=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName),c=0;c<a.length;c++)b.appendChild(this.createFeatureXML(a[c]));return GeoGlobe.Format.XML.prototype.write.apply(this,[b])},createFeatureXML:function(a){var b=this.buildGeometryNode(a.geometry),c=this.createElementNS(this.featureNS,this.featurePrefix+
":"+this.geometryName);c.appendChild(b);var b=this.createElementNS(this.gmlns,"gml:"+this.featureName),d=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName);d.setAttribute("fid",a.fid||a.id);d.appendChild(c);for(var e in a.attributes){var c=this.createTextNode(a.attributes[e]),f=this.createElementNS(this.featureNS,this.featurePrefix+":"+e.substring(e.lastIndexOf(":")+1));f.appendChild(c);d.appendChild(f)}b.appendChild(d);return b},buildGeometryNode:function(a){this.externalProjection&&
this.internalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b=a.CLASS_NAME;return this.buildGeometry[b.substring(b.lastIndexOf(".")+1).toLowerCase()].apply(this,[a])},buildGeometry:{point:function(a){var b=this.createElementNS(this.gmlns,"gml:Point");b.appendChild(this.buildCoordinatesNode(a));return b},multipoint:function(a){for(var b=this.createElementNS(this.gmlns,"gml:MultiPoint"),a=a.components,c,d,e=0;e<a.length;e++)c=this.createElementNS(this.gmlns,
"gml:pointMember"),d=this.buildGeometry.point.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},linestring:function(a){var b=this.createElementNS(this.gmlns,"gml:LineString");b.appendChild(this.buildCoordinatesNode(a));return b},multilinestring:function(a){for(var b=this.createElementNS(this.gmlns,"gml:MultiLineString"),a=a.components,c,d,e=0;e<a.length;++e)c=this.createElementNS(this.gmlns,"gml:lineStringMember"),d=this.buildGeometry.linestring.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);
return b},linearring:function(a){var b=this.createElementNS(this.gmlns,"gml:LinearRing");b.appendChild(this.buildCoordinatesNode(a));return b},polygon:function(a){for(var b=this.createElementNS(this.gmlns,"gml:Polygon"),a=a.components,c,d,e=0;e<a.length;++e)c=e==0?"outerBoundaryIs":"innerBoundaryIs",c=this.createElementNS(this.gmlns,"gml:"+c),d=this.buildGeometry.linearring.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},multipolygon:function(a){for(var b=this.createElementNS(this.gmlns,
"gml:MultiPolygon"),a=a.components,c,d,e=0;e<a.length;++e)c=this.createElementNS(this.gmlns,"gml:polygonMember"),d=this.buildGeometry.polygon.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},lnglatbounds:function(a){var b=this.createElementNS(this.gmlns,"gml:Box");b.appendChild(this.buildCoordinatesNode(a));return b}},buildCoordinatesNode:function(a){var b=this.createElementNS(this.gmlns,"gml:coordinates");b.setAttribute("decimal",".");b.setAttribute("cs",",");b.setAttribute("ts"," ");
var c=[];if(a instanceof mapboxgl.LngLatBounds)c.push(a.getWest()+","+a.getSouth()),c.push(a.getEast()+","+a.getNorth());else for(var a=a.components?a.components:[a],d=0;d<a.length;d++)c.push(a[d].x+","+a[d].y);c=this.createTextNode(c.join(" "));b.appendChild(c);return b},CLASS_NAME:"GeoGlobe.Format.GML"});if(!GeoGlobe.Format.GML)GeoGlobe.Format.GML={};
GeoGlobe.Format.GML.Base=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},defaultPrefix:"gml",schemaLocation:null,featureType:null,featureNS:null,geometryName:"geometry",extractAttributes:!0,srsName:null,xy:!0,geometryTypes:null,singleFeatureType:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,featureMember:/^(.*:)?featureMembers?$/},
initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a]);this.setGeometryTypes();a&&a.featureNS&&this.setNamespace("feature",a.featureNS);this.singleFeatureType=!a||typeof a.featureType==="string"},read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var b=[];this.readNode(a,{features:b},!0);if(b.length==0){var c=this.getElementsByTagNameNS(a,this.namespaces.gml,"featureMember");if(c.length)for(var a=
0,d=c.length;a<d;++a)this.readNode(c[a],{features:b},!0);else c=this.getElementsByTagNameNS(a,this.namespaces.gml,"featureMembers"),c.length&&this.readNode(c[0],{features:b},!0)}return b},readNode:function(a,b,c){if(c===!0&&this.autoConfig===!0)this.featureType=null,delete this.namespaceAlias[this.featureNS],delete this.namespaces.feature,this.featureNS=null;if(!this.featureNS&&!(a.prefix in this.namespaces)&&a.parentNode.namespaceURI==this.namespaces.gml&&this.regExes.featureMember.test(a.parentNode.nodeName))this.featureType=
a.nodeName.split(":").pop(),this.setNamespace("feature",a.namespaceURI),this.featureNS=a.namespaceURI,this.autoConfig=!0;return GeoGlobe.Format.XML.prototype.readNode.apply(this,[a,b])},readers:{gml:{_inherit:function(){},featureMember:function(a,b){this.readChildNodes(a,b)},featureMembers:function(a,b){this.readChildNodes(a,b)},name:function(a,b){b.name=this.getChildValue(a)},boundedBy:function(a,b){var c={};this.readChildNodes(a,c);if(c.components&&c.components.length>0)b.bounds=c.components[0]},
Point:function(a,b){var c={points:[]};this.readChildNodes(a,c);if(!b.components)b.components=[];b.components.push(c.points[0])},coordinates:function(a,b){for(var c=this.getChildValue(a).replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),c=c.split(this.regExes.splitSpace),d,e=c.length,f=Array(e),g=0;g<e;++g)d=c[g].split(","),f[g]=this.xy?new GeoGlobe.Geometry.Point(d[0],d[1],d[2]):new GeoGlobe.Geometry.Point(d[1],d[0],d[2]);b.points=f},coord:function(a,b){var c={};this.readChildNodes(a,
c);if(!b.points)b.points=[];b.points.push(new GeoGlobe.Geometry.Point(c.x,c.y,c.z))},X:function(a,b){b.x=this.getChildValue(a)},Y:function(a,b){b.y=this.getChildValue(a)},Z:function(a,b){b.z=this.getChildValue(a)},MultiPoint:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new GeoGlobe.Geometry.MultiPoint(c.components)]},pointMember:function(a,b){this.readChildNodes(a,b)},LineString:function(a,b){var c={};this.readers.gml._inherit.apply(this,
[a,c,b]);this.readChildNodes(a,c);if(!b.components)b.components=[];b.components.push(new GeoGlobe.Geometry.LineString(c.points))},MultiLineString:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new GeoGlobe.Geometry.MultiLineString(c.components)]},lineStringMember:function(a,b){this.readChildNodes(a,b)},Polygon:function(a,b){var c={outer:null,inner:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);c.inner.unshift(c.outer);
if(!b.components)b.components=[];b.components.push(new GeoGlobe.Geometry.Polygon(c.inner))},LinearRing:function(a,b){var c={};this.readers.gml._inherit.apply(this,[a,c]);this.readChildNodes(a,c);b.components=[new GeoGlobe.Geometry.LinearRing(c.points)]},MultiPolygon:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new GeoGlobe.Geometry.MultiPolygon(c.components)]},polygonMember:function(a,b){this.readChildNodes(a,b)},GeometryCollection:function(a,
b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);b.components=[new GeoGlobe.Geometry.Collection(c.components)]},geometryMember:function(a,b){this.readChildNodes(a,b)}},feature:{"*":function(a,b){var c,d=a.localName||a.nodeName.split(":").pop();if(b.features)if(!this.singleFeatureType&&GeoGlobe.Util.indexOf(this.featureType,d)!==-1)c="_typeName";else if(d===this.featureType)c="_typeName";else{if(GeoGlobe.Util.isArray(this.featureType_))for(var e=0;e<this.featureType_.length;e++)if(this.featureType_[e]===
d){c="_typeName";break}}else a.childNodes.length==0||a.childNodes.length==1&&a.firstChild.nodeType==3?this.extractAttributes&&(c="_attribute"):c="_geometry";c&&this.readers.feature[c].apply(this,[a,b])},_typeName:function(a,b){var c={components:[],attributes:{}};this.readChildNodes(a,c);if(c.name)c.attributes.name=c.name;var d=new GeoGlobe.Feature(c.components[0],c.attributes);if(!this.singleFeatureType)d.type=a.nodeName.split(":").pop(),d.namespace=a.namespaceURI;var e=a.getAttribute("fid")||this.getAttributeNS(a,
this.namespaces.gml,"id");if(e)d.fid=e;this.internalProjection&&this.externalProjection&&d.geometry&&d.geometry.transform(this.externalProjection,this.internalProjection);if(c.bounds)d.bounds=c.bounds;b.features.push(d)},_geometry:function(a,b){if(!this.geometryName)this.geometryName=a.nodeName.split(":").pop();this.readChildNodes(a,b)},_attribute:function(a,b){var c=a.localName||a.nodeName.split(":").pop(),d=this.getChildValue(a);b.attributes[c]=d}},wfs:{FeatureCollection:function(a,b){this.readChildNodes(a,
b)}}},write:function(a){a=this.writeNode("gml:"+(GeoGlobe.Util.isArray(a)?"featureMembers":"featureMember"),a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return GeoGlobe.Format.XML.prototype.write.apply(this,[a])},writers:{gml:{featureMember:function(a){var b=this.createElementNSPlus("gml:featureMember");this.writeNode("feature:_typeName",a,b);return b},MultiPoint:function(a){for(var b=this.createElementNSPlus("gml:MultiPoint"),a=a.components||[a],c=0,d=a.length;c<
d;++c)this.writeNode("pointMember",a[c],b);return b},pointMember:function(a){var b=this.createElementNSPlus("gml:pointMember");this.writeNode("Point",a,b);return b},MultiLineString:function(a){for(var b=this.createElementNSPlus("gml:MultiLineString"),a=a.components||[a],c=0,d=a.length;c<d;++c)this.writeNode("lineStringMember",a[c],b);return b},lineStringMember:function(a){var b=this.createElementNSPlus("gml:lineStringMember");this.writeNode("LineString",a,b);return b},MultiPolygon:function(a){for(var b=
this.createElementNSPlus("gml:MultiPolygon"),a=a.components||[a],c=0,d=a.length;c<d;++c)this.writeNode("polygonMember",a[c],b);return b},polygonMember:function(a){var b=this.createElementNSPlus("gml:polygonMember");this.writeNode("Polygon",a,b);return b},GeometryCollection:function(a){for(var b=this.createElementNSPlus("gml:GeometryCollection"),c=0,d=a.components.length;c<d;++c)this.writeNode("geometryMember",a.components[c],b);return b},geometryMember:function(a){var b=this.createElementNSPlus("gml:geometryMember"),
a=this.writeNode("feature:_geometry",a);b.appendChild(a.firstChild);return b}},feature:{_typeName:function(a){var b=this.createElementNSPlus("feature:"+this.featureType,{attributes:{fid:a.fid}});a.geometry&&this.writeNode("feature:_geometry",a.geometry,b);for(var c in a.attributes){var d=a.attributes[c];d!=null&&this.writeNode("feature:_attribute",{name:c,value:d},b)}return b},_geometry:function(a){this.externalProjection&&this.internalProjection&&(a=a.clone().transform(this.internalProjection,this.externalProjection));
var b=this.createElementNSPlus("feature:"+this.geometryName),a=this.writeNode("gml:"+this.geometryTypes[a.CLASS_NAME],a,b);this.srsName&&a.setAttribute("srsName",this.srsName);return b},_attribute:function(a){return this.createElementNSPlus("feature:"+a.name,{value:a.value})}},wfs:{FeatureCollection:function(a){for(var b=this.createElementNSPlus("wfs:FeatureCollection"),c=0,d=a.length;c<d;++c)this.writeNode("gml:featureMember",a[c],b);return b}}},setGeometryTypes:function(){this.geometryTypes={"GeoGlobe.Geometry.Point":"Point",
"GeoGlobe.Geometry.MultiPoint":"MultiPoint","GeoGlobe.Geometry.LineString":"LineString","GeoGlobe.Geometry.MultiLineString":"MultiLineString","GeoGlobe.Geometry.Polygon":"Polygon","GeoGlobe.Geometry.MultiPolygon":"MultiPolygon","GeoGlobe.Geometry.Collection":"GeometryCollection"}},setFeatureType_:function(a){this.featureType_=a},CLASS_NAME:"GeoGlobe.Format.GML.Base"});
GeoGlobe.Format.GML.v2=GeoGlobe.Class4OL(GeoGlobe.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/2.1.2/feature.xsd",initialize:function(a){GeoGlobe.Format.GML.Base.prototype.initialize.apply(this,[a])},readers:{gml:GeoGlobe.Util.applyDefaults({outerBoundaryIs:function(a,b){var c={};this.readChildNodes(a,c);b.outer=c.components[0]},innerBoundaryIs:function(a,b){var c={};this.readChildNodes(a,c);b.inner.push(c.components[0])},Box:function(a,b){var c={};this.readChildNodes(a,
c);if(!b.components)b.components=[];var d=c.points[0],c=c.points[1],d=new GeoGlobe.LngLat(d.x,d.y),c=new GeoGlobe.LngLat(c.x,c.y);b.components.push(new GeoGlobe.LngLatBounds(d,c))}},GeoGlobe.Format.GML.Base.prototype.readers.gml),feature:GeoGlobe.Format.GML.Base.prototype.readers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.readers.wfs},write:function(a){a=this.writeNode(GeoGlobe.Util.isArray(a)?"wfs:FeatureCollection":"gml:featureMember",a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",
this.schemaLocation);return GeoGlobe.Format.XML.prototype.write.apply(this,[a])},writers:{gml:GeoGlobe.Util.applyDefaults({Point:function(a){var b=this.createElementNSPlus("gml:Point");this.writeNode("coordinates",[a],b);return b},coordinates:function(a){for(var b=a.length,c=Array(b),d,e=0;e<b;++e)d=a[e],c[e]=this.xy?d.x+","+d.y:d.y+","+d.x,d.z!=void 0&&(c[e]+=","+d.z);return this.createElementNSPlus("gml:coordinates",{attributes:{decimal:".",cs:",",ts:" "},value:b==1?c[0]:c.join(" ")})},LineString:function(a){var b=
this.createElementNSPlus("gml:LineString");this.writeNode("coordinates",a.components,b);return b},Polygon:function(a){var b=this.createElementNSPlus("gml:Polygon");this.writeNode("outerBoundaryIs",a.components[0],b);for(var c=1;c<a.components.length;++c)this.writeNode("innerBoundaryIs",a.components[c],b);return b},outerBoundaryIs:function(a){var b=this.createElementNSPlus("gml:outerBoundaryIs");this.writeNode("LinearRing",a,b);return b},innerBoundaryIs:function(a){var b=this.createElementNSPlus("gml:innerBoundaryIs");
this.writeNode("LinearRing",a,b);return b},LinearRing:function(a){var b=this.createElementNSPlus("gml:LinearRing");this.writeNode("coordinates",a.components,b);return b},Box:function(a){var b=this.createElementNSPlus("gml:Box");this.writeNode("coordinates",[{x:a._sw.lng,y:a._sw.lat},{x:a._ne.lng,y:a._ne.lat}],b);this.srsName&&b.setAttribute("srsName",this.srsName);return b}},GeoGlobe.Format.GML.Base.prototype.writers.gml),feature:GeoGlobe.Format.GML.Base.prototype.writers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.writers.wfs},
CLASS_NAME:"GeoGlobe.Format.GML.v2"});
GeoGlobe.Format.GML.v3=GeoGlobe.Class4OL(GeoGlobe.Format.GML.Base,{schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",curve:!1,multiCurve:!0,surface:!1,multiSurface:!0,initialize:function(a){GeoGlobe.Format.GML.Base.prototype.initialize.apply(this,[a])},readers:{gml:GeoGlobe.Util.applyDefaults({_inherit:function(a,b,c){if(a=parseInt(a.getAttribute("srsDimension"),10)||c&&c.srsDimension)b.srsDimension=a},featureMembers:function(a,
b){this.readChildNodes(a,b)},Curve:function(a,b){var c={points:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);if(!b.components)b.components=[];b.components.push(new GeoGlobe.Geometry.LineString(c.points))},segments:function(a,b){this.readChildNodes(a,b)},LineStringSegment:function(a,b){var c={};this.readChildNodes(a,c);c.points&&Array.prototype.push.apply(b.points,c.points)},pos:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace),
c=this.xy?new GeoGlobe.Geometry.Point(c[0],c[1],c[2]):new GeoGlobe.Geometry.Point(c[1],c[0],c[2]);b.points=[c]},posList:function(a,b){for(var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(this.regExes.splitSpace),d=b.srsDimension||parseInt(a.getAttribute("srsDimension")||a.getAttribute("dimension"),10)||2,e,f,g,h=Array(c.length/d),j=0,l=c.length;j<l;j+=d)e=c[j],f=c[j+1],g=d==2?void 0:c[j+2],h[j/d]=this.xy?new GeoGlobe.Geometry.Point(e,f,g):new GeoGlobe.Geometry.Point(f,e,g);b.points=
h},Surface:function(a,b){this.readChildNodes(a,b)},patches:function(a,b){this.readChildNodes(a,b)},PolygonPatch:function(a,b){this.readers.gml.Polygon.apply(this,[a,b])},exterior:function(a,b){var c={};this.readChildNodes(a,c);b.outer=c.components[0]},interior:function(a,b){var c={};this.readChildNodes(a,c);b.inner.push(c.components[0])},MultiCurve:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);if(c.components.length>0)b.components=[new GeoGlobe.Geometry.MultiLineString(c.components)]},
curveMember:function(a,b){this.readChildNodes(a,b)},MultiSurface:function(a,b){var c={components:[]};this.readers.gml._inherit.apply(this,[a,c,b]);this.readChildNodes(a,c);if(c.components.length>0)b.components=[new GeoGlobe.Geometry.MultiPolygon(c.components)]},surfaceMember:function(a,b){this.readChildNodes(a,b)},surfaceMembers:function(a,b){this.readChildNodes(a,b)},pointMembers:function(a,b){this.readChildNodes(a,b)},lineStringMembers:function(a,b){this.readChildNodes(a,b)},polygonMembers:function(a,
b){this.readChildNodes(a,b)},geometryMembers:function(a,b){this.readChildNodes(a,b)},Envelope:function(a,b){var c={points:Array(2)};this.readChildNodes(a,c);if(!b.components)b.components=[];var d=c.points[0],c=c.points[1],d=new GeoGlobe.LngLat(d.x,d.y),c=new GeoGlobe.LngLat(c.x,c.y);b.components.push(new GeoGlobe.LngLatBounds(d,c))},lowerCorner:function(a,b){var c={};this.readers.gml.pos.apply(this,[a,c]);b.points[0]=c.points[0]},upperCorner:function(a,b){var c={};this.readers.gml.pos.apply(this,
[a,c]);b.points[1]=c.points[0]}},GeoGlobe.Format.GML.Base.prototype.readers.gml),feature:GeoGlobe.Format.GML.Base.prototype.readers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.readers.wfs},write:function(a){a=this.writeNode("gml:"+(GeoGlobe.Util.isArray(a)?"featureMembers":"featureMember"),a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return GeoGlobe.Format.XML.prototype.write.apply(this,[a])},writers:{gml:GeoGlobe.Util.applyDefaults({featureMembers:function(a){for(var b=
this.createElementNSPlus("gml:featureMembers"),c=0,d=a.length;c<d;++c)this.writeNode("feature:_typeName",a[c],b);return b},Point:function(a){var b=this.createElementNSPlus("gml:Point");this.writeNode("pos",a,b);return b},pos:function(a){return this.createElementNSPlus("gml:pos",{value:this.xy?a.x+" "+a.y:a.y+" "+a.x})},LineString:function(a){var b=this.createElementNSPlus("gml:LineString");this.writeNode("posList",a.components,b);return b},Curve:function(a){var b=this.createElementNSPlus("gml:Curve");
this.writeNode("segments",a,b);return b},segments:function(a){var b=this.createElementNSPlus("gml:segments");this.writeNode("LineStringSegment",a,b);return b},LineStringSegment:function(a){var b=this.createElementNSPlus("gml:LineStringSegment");this.writeNode("posList",a.components,b);return b},posList:function(a){for(var b=a.length,c=Array(b),d,e=0;e<b;++e)d=a[e],c[e]=this.xy?d.x+" "+d.y:d.y+" "+d.x;return this.createElementNSPlus("gml:posList",{value:c.join(" ")})},Surface:function(a){var b=this.createElementNSPlus("gml:Surface");
this.writeNode("patches",a,b);return b},patches:function(a){var b=this.createElementNSPlus("gml:patches");this.writeNode("PolygonPatch",a,b);return b},PolygonPatch:function(a){var b=this.createElementNSPlus("gml:PolygonPatch",{attributes:{interpolation:"planar"}});this.writeNode("exterior",a.components[0],b);for(var c=1,d=a.components.length;c<d;++c)this.writeNode("interior",a.components[c],b);return b},Polygon:function(a){var b=this.createElementNSPlus("gml:Polygon");this.writeNode("exterior",a.components[0],
b);for(var c=1,d=a.components.length;c<d;++c)this.writeNode("interior",a.components[c],b);return b},exterior:function(a){var b=this.createElementNSPlus("gml:exterior");this.writeNode("LinearRing",a,b);return b},interior:function(a){var b=this.createElementNSPlus("gml:interior");this.writeNode("LinearRing",a,b);return b},LinearRing:function(a){var b=this.createElementNSPlus("gml:LinearRing");this.writeNode("posList",a.components,b);return b},MultiCurve:function(a){for(var b=this.createElementNSPlus("gml:MultiCurve"),
a=a.components||[a],c=0,d=a.length;c<d;++c)this.writeNode("curveMember",a[c],b);return b},curveMember:function(a){var b=this.createElementNSPlus("gml:curveMember");this.curve?this.writeNode("Curve",a,b):this.writeNode("LineString",a,b);return b},MultiSurface:function(a){for(var b=this.createElementNSPlus("gml:MultiSurface"),a=a.components||[a],c=0,d=a.length;c<d;++c)this.writeNode("surfaceMember",a[c],b);return b},surfaceMember:function(a){var b=this.createElementNSPlus("gml:surfaceMember");this.surface?
this.writeNode("Surface",a,b):this.writeNode("Polygon",a,b);return b},Envelope:function(a){var b=this.createElementNSPlus("gml:Envelope");this.writeNode("lowerCorner",a,b);this.writeNode("upperCorner",a,b);this.srsName&&b.setAttribute("srsName",this.srsName);return b},lowerCorner:function(a){return this.createElementNSPlus("gml:lowerCorner",{value:this.xy?a._sw.lng+" "+a._sw.lat:a._sw.lat+" "+a._sw.lng})},upperCorner:function(a){return this.createElementNSPlus("gml:upperCorner",{value:this.xy?a._ne.lng+
" "+a._ne.lat:a._ne.lat+" "+a._ne.lng})}},GeoGlobe.Format.GML.Base.prototype.writers.gml),feature:GeoGlobe.Format.GML.Base.prototype.writers.feature,wfs:GeoGlobe.Format.GML.Base.prototype.writers.wfs},setGeometryTypes:function(){this.geometryTypes={"GeoGlobe.Geometry.Point":"Point","GeoGlobe.Geometry.MultiPoint":"MultiPoint","GeoGlobe.Geometry.LineString":this.curve===!0?"Curve":"LineString","GeoGlobe.Geometry.MultiLineString":this.multiCurve===!1?"MultiLineString":"MultiCurve","GeoGlobe.Geometry.Polygon":this.surface===
!0?"Surface":"Polygon","GeoGlobe.Geometry.MultiPolygon":this.multiSurface===!1?"MultiPolygon":"MultiSurface","GeoGlobe.Geometry.Collection":"GeometryCollection"}},CLASS_NAME:"GeoGlobe.Format.GML.v3"});
GeoGlobe.Format.KML=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"GeoGlobe export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,kvpAttributes:!1,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,initialize:function(a){this.regExes=
{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g};this.externalProjection=new GeoGlobe.SpatialReference("EPSG:4326");GeoGlobe.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){this.features=[];this.styles={};this.fetched={};return this.parseData(a,{depth:0,styleBaseUrl:this.styleBaseUrl})},parseData:function(a,b){typeof a=="string"&&
(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));for(var c=["Link","NetworkLink","Style","StyleMap","Placemark"],d=0,e=c.length;d<e;++d){var f=c[d],g=this.getElementsByTagNameNS(a,"*",f);if(g.length!=0)switch(f.toLowerCase()){case "link":case "networklink":this.parseLinks(g,b);break;case "style":this.extractStyles&&this.parseStyles(g,b);break;case "stylemap":this.extractStyles&&this.parseStyleMaps(g,b);break;case "placemark":this.parseFeatures(g,b)}}return this.features},parseLinks:function(a,
b){if(b.depth>=this.maxDepth)return!1;var c=GeoGlobe.Util.extend({},b);c.depth++;for(var d=0,e=a.length;d<e;d++){var f=this.parseProperty(a[d],"*","href");f&&!this.fetched[f]&&(this.fetched[f]=!0,(f=this.fetchLink(f))&&this.parseData(f,c))}},fetchLink:function(a){if(a=GeoGlobe.Request.GET({url:a,async:!1}))return a.responseText},parseStyles:function(a,b){for(var c=0,d=a.length;c<d;c++){var e=this.parseStyle(a[c]);e&&(this.styles[(b.styleBaseUrl||"")+"#"+e.id]=e)}},parseKmlColor:function(a){var b=
null;a&&(a=a.match(this.regExes.kmlColor))&&(b={color:"#"+a[4]+a[3]+a[2],opacity:parseInt(a[1],16)/255});return b},parseStyle:function(a){for(var b={},c=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],d,e,f=0,g=c.length;f<g;++f)if(d=c[f],e=this.getElementsByTagNameNS(a,"*",d)[0])switch(d.toLowerCase()){case "linestyle":d=this.parseProperty(e,"*","color");if(d=this.parseKmlColor(d))b.strokeColor=d.color,b.strokeOpacity=d.opacity;(d=this.parseProperty(e,"*","width"))&&(b.strokeWidth=
d);break;case "polystyle":d=this.parseProperty(e,"*","color");if(d=this.parseKmlColor(d))b.fillOpacity=d.opacity,b.fillColor=d.color;this.parseProperty(e,"*","fill")=="0"&&(b.fillColor="none");this.parseProperty(e,"*","outline")=="0"&&(b.strokeWidth="0");break;case "iconstyle":var h=parseFloat(this.parseProperty(e,"*","scale")||1);d=32*h;var j=32*h,l=this.getElementsByTagNameNS(e,"*","Icon")[0];if(l){var n=this.parseProperty(l,"*","href");if(n){var o=this.parseProperty(l,"*","w"),q=this.parseProperty(l,
"*","h");GeoGlobe.String.startsWith(n,"http://maps.google.com/mapfiles/kml")&&!o&&!q&&(q=o=64,h/=2);o=o||q;q=q||o;o&&(d=parseInt(o)*h);q&&(j=parseInt(q)*h);if(q=n.match(this.regExes.kmlIconPalette))o=q[1],q=q[2],n=this.parseProperty(l,"*","x"),l=this.parseProperty(l,"*","y"),n="http://maps.google.com/mapfiles/kml/pal"+o+"/icon"+((l?7-l/32:7)*8+(n?n/32:0))+q;b.graphicOpacity=1;b.externalGraphic=n}}if(e=this.getElementsByTagNameNS(e,"*","hotSpot")[0])n=parseFloat(e.getAttribute("x")),l=parseFloat(e.getAttribute("y")),
o=e.getAttribute("xunits"),o=="pixels"?b.graphicXOffset=-n*h:o=="insetPixels"?b.graphicXOffset=-d+n*h:o=="fraction"&&(b.graphicXOffset=-d*n),e=e.getAttribute("yunits"),e=="pixels"?b.graphicYOffset=-j+l*h+1:e=="insetPixels"?b.graphicYOffset=-(l*h)+1:e=="fraction"&&(b.graphicYOffset=-j*(1-l)+1);b.graphicWidth=d;b.graphicHeight=j;break;case "balloonstyle":(e=GeoGlobe.Util.getXmlNodeValue(e))&&(b.balloonStyle=e.replace(this.regExes.straightBracket,"${$1}"));break;case "labelstyle":if(d=this.parseProperty(e,
"*","color"),d=this.parseKmlColor(d))b.fontColor=d.color,b.fontOpacity=d.opacity}!b.strokeColor&&b.fillColor&&(b.strokeColor=b.fillColor);if((a=a.getAttribute("id"))&&b)b.id=a;return b},parseStyleMaps:function(a,b){for(var c=0,d=a.length;c<d;c++)for(var e=a[c],f=this.getElementsByTagNameNS(e,"*","Pair"),e=e.getAttribute("id"),g=0,h=f.length;g<h;g++){var j=f[g],l=this.parseProperty(j,"*","key");(j=this.parseProperty(j,"*","styleUrl"))&&l=="normal"&&(this.styles[(b.styleBaseUrl||"")+"#"+e]=this.styles[(b.styleBaseUrl||
"")+j])}},parseFeatures:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],g=this.parseFeature.apply(this,[f]);if(g){if(this.extractStyles&&g.attributes&&g.attributes.styleUrl)g.style=this.getStyle(g.attributes.styleUrl,b);if(this.extractStyles){var h=this.getElementsByTagNameNS(f,"*","Style")[0];if(h&&(h=this.parseStyle(h)))g.style=GeoGlobe.Util.extend(g.style,h)}if(this.extractTracks){if((f=this.getElementsByTagNameNS(f,this.namespaces.gx,"Track"))&&f.length>0)g={features:[],feature:g},
this.readNode(f[0],g),g.features.length>0&&c.push.apply(c,g.features)}else c.push(g)}else throw"Bad Placemark: "+d;}this.features=this.features.concat(c)},readers:{kml:{when:function(a,b){b.whens.push(GeoGlobe.Date.parse(this.getChildValue(a)))},_trackPointAttribute:function(a,b){var c=a.nodeName.split(":").pop();b.attributes[c].push(this.getChildValue(a))}},gx:{Track:function(a,b){var c={whens:[],points:[],angles:[]};if(this.trackAttributes){var d;c.attributes={};for(var e=0,f=this.trackAttributes.length;e<
f;++e)if(d=this.trackAttributes[e],c.attributes[d]=[],!(d in this.readers.kml))this.readers.kml[d]=this.readers.kml._trackPointAttribute}this.readChildNodes(a,c);if(c.whens.length!==c.points.length)throw Error("gx:Track with unequal number of when ("+c.whens.length+") and gx:coord ("+c.points.length+") elements.");var g=c.angles.length>0;if(g&&c.whens.length!==c.angles.length)throw Error("gx:Track with unequal number of when ("+c.whens.length+") and gx:angles ("+c.angles.length+") elements.");for(var h,
e=0,f=c.whens.length;e<f;++e){h=b.feature.clone();h.fid=b.feature.fid||b.feature.id;d=c.points[e];h.geometry=d;if("z"in d)h.attributes.altitude=d.z;this.internalProjection&&this.externalProjection&&h.geometry.transform(this.externalProjection,this.internalProjection);if(this.trackAttributes)for(var j=0,l=this.trackAttributes.length;j<l;++j)d=this.trackAttributes[j],h.attributes[d]=c.attributes[d][e];h.attributes.when=c.whens[e];h.attributes.trackId=b.feature.id;if(g)d=c.angles[e],h.attributes.heading=
parseFloat(d[0]),h.attributes.tilt=parseFloat(d[1]),h.attributes.roll=parseFloat(d[2]);b.features.push(h)}},coord:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(/\s+/),d=new GeoGlobe.Geometry.Point(c[0],c[1]);if(c.length>2)d.z=parseFloat(c[2]);b.points.push(d)},angles:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,"").split(/\s+/);b.angles.push(c)}}},parseFeature:function(a){for(var b=["MultiGeometry","Polygon","LineString","Point"],c,
d,e,f=0,g=b.length;f<g;++f)if(c=b[f],this.internalns=a.namespaceURI?a.namespaceURI:this.kmlns,d=this.getElementsByTagNameNS(a,this.internalns,c),d.length>0){if(b=this.parseGeometry[c.toLowerCase()])e=b.apply(this,[d[0]]),this.internalProjection&&this.externalProjection&&e.transform(this.externalProjection,this.internalProjection);else throw new TypeError("Unsupported geometry type: "+c);break}var h;this.extractAttributes&&(h=this.parseAttributes(a));c=new GeoGlobe.Feature(e,h);a=a.getAttribute("id")||
a.getAttribute("name");if(a!=null)c.fid=a;return c},getStyle:function(a,b){var c=GeoGlobe.Util.removeTail(a),d=GeoGlobe.Util.extend({},b);d.depth++;d.styleBaseUrl=c;!this.styles[a]&&!GeoGlobe.String.startsWith(a,"#")&&d.depth<=this.maxDepth&&!this.fetched[c]&&(c=this.fetchLink(c))&&this.parseData(c,d);return GeoGlobe.Util.extend({},this.styles[a])},parseGeometry:{point:function(a){var b=this.getElementsByTagNameNS(a,this.internalns,"coordinates"),a=[];if(b.length>0)var c=b[0].firstChild.nodeValue,
c=c.replace(this.regExes.removeSpace,""),a=c.split(",");b=null;if(a.length>1)a.length==2&&(a[2]=null),b=new GeoGlobe.Geometry.Point(a[0],a[1],a[2]);else throw"Bad coordinate string: "+c;return b},linestring:function(a,b){var c=this.getElementsByTagNameNS(a,this.internalns,"coordinates"),d=null;if(c.length>0){for(var c=this.getChildValue(c[0]),c=c.replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),d=c.split(this.regExes.splitSpace),e=d.length,f=Array(e),g,h,j=0;j<e;++j)if(g=
d[j].split(","),h=g.length,h>1)g.length==2&&(g[2]=null),f[j]=new GeoGlobe.Geometry.Point(g[0],g[1],g[2]);else throw"Bad LineString point coordinates: "+d[j];if(e)d=b?new GeoGlobe.Geometry.LinearRing(f):new GeoGlobe.Geometry.LineString(f);else throw"Bad LineString coordinates: "+c;}return d},polygon:function(a){var a=this.getElementsByTagNameNS(a,this.internalns,"LinearRing"),b=a.length,c=Array(b);if(b>0)for(var d=0,e=a.length;d<e;++d)if(b=this.parseGeometry.linestring.apply(this,[a[d],!0]))c[d]=b;
else throw"Bad LinearRing geometry: "+d;return new GeoGlobe.Geometry.Polygon(c)},multigeometry:function(a){for(var b,c=[],d=a.childNodes,e=0,f=d.length;e<f;++e)a=d[e],a.nodeType==1&&(b=this.parseGeometry[(a.prefix?a.nodeName.split(":")[1]:a.nodeName).toLowerCase()])&&c.push(b.apply(this,[a]));return new GeoGlobe.Geometry.Collection(c)}},parseAttributes:function(a){var b={},c=a.getElementsByTagName("ExtendedData");c.length&&(b=this.parseExtendedData(c[0]));for(var d,e,f,a=a.childNodes,c=0,g=a.length;c<
g;++c)if(d=a[c],d.nodeType==1&&(e=d.childNodes,e.length>=1&&e.length<=3)){switch(e.length){case 1:f=e[0];break;case 2:f=e[0];e=e[1];f=f.nodeType==3||f.nodeType==4?f:e;break;default:f=e[1]}if(f.nodeType==3||f.nodeType==4)if(d=d.prefix?d.nodeName.split(":")[1]:d.nodeName,f=GeoGlobe.Util.getXmlNodeValue(f))f=f.replace(this.regExes.trimSpace,""),b[d]=f}return b},parseExtendedData:function(a){var b={},c,d,e,f,g=a.getElementsByTagName("Data");c=0;for(d=g.length;c<d;c++){e=g[c];f=e.getAttribute("name");
var h={},j=e.getElementsByTagName("value");j.length&&(h.value=this.getChildValue(j[0]));this.kvpAttributes?b[f]=h.value:(e=e.getElementsByTagName("displayName"),e.length&&(h.displayName=this.getChildValue(e[0])),b[f]=h)}a=a.getElementsByTagName("SimpleData");c=0;for(d=a.length;c<d;c++)h={},e=a[c],f=e.getAttribute("name"),h.value=this.getChildValue(e),this.kvpAttributes?b[f]=h.value:(h.displayName=f,b[f]=h);return b},parseProperty:function(a,b,c){var d,a=this.getElementsByTagNameNS(a,b,c);try{d=GeoGlobe.Util.getXmlNodeValue(a[0])}catch(e){d=
null}return d},write:function(a){GeoGlobe.Util.isArray(a)||(a=[a]);for(var b=this.createElementNS(this.kmlns,"kml"),c=this.createFolderXML(),d=0,e=a.length;d<e;++d)c.appendChild(this.createPlacemarkXML(a[d]));b.appendChild(c);return GeoGlobe.Format.XML.prototype.write.apply(this,[b])},createFolderXML:function(){var a=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var b=this.createElementNS(this.kmlns,"name"),c=this.createTextNode(this.foldersName);b.appendChild(c);a.appendChild(b)}this.foldersDesc&&
(b=this.createElementNS(this.kmlns,"description"),c=this.createTextNode(this.foldersDesc),b.appendChild(c),a.appendChild(b));return a},createPlacemarkXML:function(a){var b=this.createElementNS(this.kmlns,"name"),c=a.style&&a.style.label?a.style.label:a.id;b.appendChild(this.createTextNode(a.attributes.name||c));var d=this.createElementNS(this.kmlns,"description");d.appendChild(this.createTextNode(a.attributes.description||this.placemarksDesc));c=this.createElementNS(this.kmlns,"Placemark");a.fid!=
null&&c.setAttribute("id",a.fid);c.appendChild(b);c.appendChild(d);b=this.buildGeometryNode(a.geometry);c.appendChild(b);a.attributes&&(a=this.buildExtendedData(a.attributes))&&c.appendChild(a);return c},buildGeometryNode:function(a){var b=a.CLASS_NAME,b=this.buildGeometry[b.substring(b.lastIndexOf(".")+1).toLowerCase()],c=null;b&&(c=b.apply(this,[a]));return c},buildGeometry:{point:function(a){var b=this.createElementNS(this.kmlns,"Point");b.appendChild(this.buildCoordinatesNode(a));return b},multipoint:function(a){return this.buildGeometry.collection.apply(this,
[a])},linestring:function(a){var b=this.createElementNS(this.kmlns,"LineString");b.appendChild(this.buildCoordinatesNode(a));return b},multilinestring:function(a){return this.buildGeometry.collection.apply(this,[a])},linearring:function(a){var b=this.createElementNS(this.kmlns,"LinearRing");b.appendChild(this.buildCoordinatesNode(a));return b},polygon:function(a){for(var b=this.createElementNS(this.kmlns,"Polygon"),a=a.components,c,d,e=0,f=a.length;e<f;++e)c=e==0?"outerBoundaryIs":"innerBoundaryIs",
c=this.createElementNS(this.kmlns,c),d=this.buildGeometry.linearring.apply(this,[a[e]]),c.appendChild(d),b.appendChild(c);return b},multipolygon:function(a){return this.buildGeometry.collection.apply(this,[a])},collection:function(a){for(var b=this.createElementNS(this.kmlns,"MultiGeometry"),c,d=0,e=a.components.length;d<e;++d)(c=this.buildGeometryNode.apply(this,[a.components[d]]))&&b.appendChild(c);return b}},buildCoordinatesNode:function(a){var b=this.createElementNS(this.kmlns,"coordinates"),
c;if(c=a.components){for(var d=c.length,e=Array(d),f=0;f<d;++f)a=c[f],e[f]=this.buildCoordinates(a);c=e.join(" ")}else c=this.buildCoordinates(a);c=this.createTextNode(c);b.appendChild(c);return b},buildCoordinates:function(a){this.internalProjection&&this.externalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));return a.x+","+a.y},buildExtendedData:function(a){var b=this.createElementNS(this.kmlns,"ExtendedData"),c;for(c in a)if(a[c]&&c!="name"&&c!="description"&&
c!="styleUrl"){var d=this.createElementNS(this.kmlns,"Data");d.setAttribute("name",c);var e=this.createElementNS(this.kmlns,"value");if(typeof a[c]=="object"){if(a[c].value&&e.appendChild(this.createTextNode(a[c].value)),a[c].displayName){var f=this.createElementNS(this.kmlns,"displayName");f.appendChild(this.getXMLDoc().createCDATASection(a[c].displayName));d.appendChild(f)}}else e.appendChild(this.createTextNode(a[c]));d.appendChild(e);b.appendChild(d)}return this.isSimpleContent(b)?null:b},CLASS_NAME:"GeoGlobe.Format.KML"});
GeoGlobe.Format.OWSCommon=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",getVersion:function(a){var b=this.version;if(!b&&((a=a.getAttribute("xmlns:ows"))&&a.substring(a.lastIndexOf("/")+1)==="1.1"&&(b="1.1.0"),!b))b=this.defaultVersion;return b},CLASS_NAME:"GeoGlobe.Format.OWSCommon"});
GeoGlobe.Format.OWSCommon.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},read:function(a,b){GeoGlobe.Util.applyDefaults(b,this.options);var c={};this.readChildNodes(a,c);return c},readers:{ows:{Exception:function(a,b){var c={code:a.getAttribute("exceptionCode"),locator:a.getAttribute("locator"),texts:[]};b.exceptions.push(c);this.readChildNodes(a,c)},ExceptionText:function(a,b){var c=this.getChildValue(a);b.texts.push(c)},
ServiceIdentification:function(a,b){b.serviceIdentification={};this.readChildNodes(a,b.serviceIdentification)},Title:function(a,b){b.title=this.getChildValue(a)},Abstract:function(a,b){b["abstract"]=this.getChildValue(a)},Keywords:function(a,b){b.keywords={};this.readChildNodes(a,b.keywords)},Keyword:function(a,b){b[this.getChildValue(a)]=!0},ServiceType:function(a,b){b.serviceType={codeSpace:a.getAttribute("codeSpace"),value:this.getChildValue(a)}},ServiceTypeVersion:function(a,b){b.serviceTypeVersion=
this.getChildValue(a)},Fees:function(a,b){b.fees=this.getChildValue(a)},AccessConstraints:function(a,b){b.accessConstraints=this.getChildValue(a)},ServiceProvider:function(a,b){b.serviceProvider={};this.readChildNodes(a,b.serviceProvider)},ProviderName:function(a,b){b.providerName=this.getChildValue(a)},ProviderSite:function(a,b){b.providerSite=this.getAttributeNS(a,this.namespaces.xlink,"href")},ServiceContact:function(a,b){b.serviceContact={};this.readChildNodes(a,b.serviceContact)},IndividualName:function(a,
b){b.individualName=this.getChildValue(a)},PositionName:function(a,b){b.positionName=this.getChildValue(a)},ContactInfo:function(a,b){b.contactInfo={};this.readChildNodes(a,b.contactInfo)},Phone:function(a,b){b.phone={};this.readChildNodes(a,b.phone)},Voice:function(a,b){b.voice=this.getChildValue(a)},Address:function(a,b){b.address={};this.readChildNodes(a,b.address)},DeliveryPoint:function(a,b){b.deliveryPoint=this.getChildValue(a)},City:function(a,b){b.city=this.getChildValue(a)},AdministrativeArea:function(a,
b){b.administrativeArea=this.getChildValue(a)},PostalCode:function(a,b){b.postalCode=this.getChildValue(a)},Country:function(a,b){b.country=this.getChildValue(a)},ElectronicMailAddress:function(a,b){b.electronicMailAddress=this.getChildValue(a)},Role:function(a,b){b.role=this.getChildValue(a)},OperationsMetadata:function(a,b){b.operationsMetadata={};this.readChildNodes(a,b.operationsMetadata)},Operation:function(a,b){var c=a.getAttribute("name");b[c]={};this.readChildNodes(a,b[c])},DCP:function(a,
b){b.dcp={};this.readChildNodes(a,b.dcp)},HTTP:function(a,b){b.http={};this.readChildNodes(a,b.http)},Get:function(a,b){if(!b.get)b.get=[];var c={url:this.getAttributeNS(a,this.namespaces.xlink,"href")};this.readChildNodes(a,c);b.get.push(c)},Post:function(a,b){if(!b.post)b.post=[];var c={url:this.getAttributeNS(a,this.namespaces.xlink,"href")};this.readChildNodes(a,c);b.post.push(c)},Parameter:function(a,b){if(!b.parameters)b.parameters={};var c=a.getAttribute("name");b.parameters[c]={};this.readChildNodes(a,
b.parameters[c])},Constraint:function(a,b){if(!b.constraints)b.constraints={};var c=a.getAttribute("name");b.constraints[c]={};this.readChildNodes(a,b.constraints[c])},Value:function(a,b){b[this.getChildValue(a)]=!0},OutputFormat:function(a,b){b.formats.push({value:this.getChildValue(a)});this.readChildNodes(a,b)},WGS84BoundingBox:function(a,b){var c={};c.crs=a.getAttribute("crs");b.BoundingBox?b.BoundingBox.push(c):(b.projection=c.crs,c=b);this.readChildNodes(a,c)},BoundingBox:function(a,b){this.readers.ows.WGS84BoundingBox.apply(this,
[a,b])},LowerCorner:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),c=c.split(this.regExes.splitSpace);b.left=c[0];b.bottom=c[1]},UpperCorner:function(a,b){var c=this.getChildValue(a).replace(this.regExes.trimSpace,""),c=c.replace(this.regExes.trimComma,","),c=c.split(this.regExes.splitSpace);b.right=c[0];b.top=c[1];b.bounds=new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(b.left,b.bottom),new GeoGlobe.LngLat(b.right,b.top));delete b.left;
delete b.bottom;delete b.right;delete b.top},Language:function(a,b){b.language=this.getChildValue(a)}}},writers:{ows:{BoundingBox:function(a,b){var c=this.createElementNSPlus(b||"ows:BoundingBox",{attributes:{crs:a.projection}});this.writeNode("ows:LowerCorner",a,c);this.writeNode("ows:UpperCorner",a,c);return c},LowerCorner:function(a){return this.createElementNSPlus("ows:LowerCorner",{value:a.bounds._sw.lng+" "+a.bounds._sw.lat})},UpperCorner:function(a){return this.createElementNSPlus("ows:UpperCorner",
{value:a.bounds._ne.lng+" "+a.bounds._ne.lat})},Identifier:function(a){return this.createElementNSPlus("ows:Identifier",{value:a})},Title:function(a){return this.createElementNSPlus("ows:Title",{value:a})},Abstract:function(a){return this.createElementNSPlus("ows:Abstract",{value:a})},OutputFormat:function(a){return this.createElementNSPlus("ows:OutputFormat",{value:a})}}},CLASS_NAME:"GeoGlobe.Format.OWSCommon.v1"});
GeoGlobe.Format.OWSCommon.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:GeoGlobe.Util.applyDefaults({ExceptionReport:function(a,b){b.success=!1;b.exceptionReport={version:a.getAttribute("version"),language:a.getAttribute("language"),exceptions:[]};this.readChildNodes(a,b.exceptionReport)}},GeoGlobe.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:GeoGlobe.Format.OWSCommon.v1.prototype.writers.ows},
CLASS_NAME:"GeoGlobe.Format.OWSCommon.v1_0_0"});
GeoGlobe.Format.OWSCommon.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1,{namespaces:{ows:"http://www.opengis.net/ows/1.1",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:GeoGlobe.Util.applyDefaults({ExceptionReport:function(a,b){b.exceptionReport={version:a.getAttribute("version"),language:a.getAttribute("xml:lang"),exceptions:[]};this.readChildNodes(a,b.exceptionReport)},AllowedValues:function(a,b){b.allowedValues={};this.readChildNodes(a,b.allowedValues)},AnyValue:function(a,b){b.anyValue=
!0},DataType:function(a,b){b.dataType=this.getChildValue(a)},Range:function(a,b){b.range={};this.readChildNodes(a,b.range)},MinimumValue:function(a,b){b.minValue=this.getChildValue(a)},MaximumValue:function(a,b){b.maxValue=this.getChildValue(a)},Identifier:function(a,b){b.identifier=this.getChildValue(a)},SupportedCRS:function(a,b){b.supportedCRS=this.getChildValue(a)}},GeoGlobe.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:GeoGlobe.Util.applyDefaults({Range:function(a){var b=this.createElementNSPlus("ows:Range",
{attributes:{"ows:rangeClosure":a.closure}});this.writeNode("ows:MinimumValue",a.minValue,b);this.writeNode("ows:MaximumValue",a.maxValue,b);return b},MinimumValue:function(a){return this.createElementNSPlus("ows:MinimumValue",{value:a})},MaximumValue:function(a){return this.createElementNSPlus("ows:MaximumValue",{value:a})},Value:function(a){return this.createElementNSPlus("ows:Value",{value:a})}},GeoGlobe.Format.OWSCommon.v1.prototype.writers.ows)},CLASS_NAME:"GeoGlobe.Format.OWSCommon.v1_1_0"});
GeoGlobe.Format.WFSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.1.0",CLASS_NAME:"GeoGlobe.Format.WFSCapabilities"});
GeoGlobe.Format.WFSCapabilities.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{wfs:"http://www.opengis.net/wfs",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",ows:"http://www.opengis.net/ows"},errorProperty:"featureTypeList",defaultPrefix:"wfs",read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var b={};this.readNode(a,b);return b},readers:{wfs:{WFS_Capabilities:function(a,
b){this.readChildNodes(a,b)},FeatureTypeList:function(a,b){b.featureTypeList={featureTypes:[]};this.readChildNodes(a,b.featureTypeList)},FeatureType:function(a,b){var c={};this.readChildNodes(a,c);b.featureTypes.push(c)},Name:function(a,b){var c=this.getChildValue(a);if(c&&(c=c.split(":"),b.name=c.pop(),c.length>0))b.featureNS=this.lookupNamespaceURI(a,c[0])},Title:function(a,b){var c=this.getChildValue(a);if(c)b.title=c},Abstract:function(a,b){var c=this.getChildValue(a);c&&(b["abstract"]=c)}}},
CLASS_NAME:"GeoGlobe.Format.WFSCapabilities.v1"});
GeoGlobe.Format.WFSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.WFSCapabilities.v1,{readers:{wfs:GeoGlobe.Util.applyDefaults({Service:function(a,b){b.service={};this.readChildNodes(a,b.service)},Fees:function(a,b){var c=this.getChildValue(a);if(c&&c.toLowerCase()!="none")b.fees=c},AccessConstraints:function(a,b){var c=this.getChildValue(a);if(c&&c.toLowerCase()!="none")b.accessConstraints=c},OnlineResource:function(a,b){var c=this.getChildValue(a);if(c&&c.toLowerCase()!="none")b.onlineResource=
c},Keywords:function(a,b){var c=this.getChildValue(a);if(c&&c.toLowerCase()!="none")b.keywords=c.split(", ")},Capability:function(a,b){b.capability={};this.readChildNodes(a,b.capability)},Request:function(a,b){b.request={};this.readChildNodes(a,b.request)},GetFeature:function(a,b){b.getfeature={href:{},formats:[]};this.readChildNodes(a,b.getfeature)},ResultFormat:function(a,b){for(var c=a.childNodes,d,e=0;e<c.length;e++)d=c[e],d.nodeType==1&&b.formats.push(d.nodeName)},DCPType:function(a,b){this.readChildNodes(a,
b)},HTTP:function(a,b){this.readChildNodes(a,b.href)},Get:function(a,b){b.get=a.getAttribute("onlineResource")},Post:function(a,b){b.post=a.getAttribute("onlineResource")},SRS:function(a,b){var c=this.getChildValue(a);if(c)b.srs=c},LatLongBoundingBox:function(a,b){var c=a.getAttribute("minx"),d=a.getAttribute("miny"),e=a.getAttribute("maxx"),f=a.getAttribute("maxy");b.bbox=c+","+d+","+e+","+f},TemporalFeatureLayer:function(a,b){b.temporalFeatureLayers=[];var c={};this.readChildNodes(a,c);b.temporalFeatureLayers.push(c)},
Extent:function(a,b){b.defaultTime=a.getAttribute("default");var c=this.getChildValue(a).split("/");b.time=c},Dimension:function(a,b){b.defaultTime=a.getAttribute("default");var c=this.getChildValue(a).split("/");b.time=c}},GeoGlobe.Format.WFSCapabilities.v1.prototype.readers.wfs)},CLASS_NAME:"GeoGlobe.Format.WFSCapabilities.v1_0_0"});
GeoGlobe.Format.WFSCapabilities.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.WFSCapabilities.v1,{regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},readers:{wfs:GeoGlobe.Util.applyDefaults({DefaultSRS:function(a,b){var c=this.getChildValue(a);if(c)b.srs=c},WGS84BoundingBox:function(a,b){var c=this.getChildValue(a.getElementsByTagName("ows:LowerCorner")[0]).split(" "),d=this.getChildValue(a.getElementsByTagName("ows:UpperCorner")[0]).split(" ");b.bbox=c[0]+","+c[1]+
","+d[0]+","+d[1]},TemporalFeatureLayer:function(a,b){b.temporalFeatureLayers=[];var c={};this.readChildNodes(a,c);b.temporalFeatureLayers.push(c)},Extent:function(a,b){b.defaultTime=a.getAttribute("default");var c=this.getChildValue(a).split("/");b.time=c},Dimension:function(a,b){b.defaultTime=a.getAttribute("default");var c=this.getChildValue(a).split("/");b.time=c}},GeoGlobe.Format.WFSCapabilities.v1.prototype.readers.wfs),ows:GeoGlobe.Format.OWSCommon.v1.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WFSCapabilities.v1_1_0"});
GeoGlobe.Format.WFSDescribeFeatureType=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{regExes:{trimSpace:/^\s*|\s*$/g},namespaces:{xsd:"http://www.w3.org/2001/XMLSchema"},readers:{xsd:{schema:function(a,b){var c=[],d={},e,f;this.readChildNodes(a,{complexTypes:c,customTypes:d});var g=a.attributes,h,j;e=0;for(f=g.length;e<f;++e)h=g[e],j=h.name,j.indexOf("xmlns")===0?this.setNamespace(j.split(":")[1]||"",h.value):b[j]=h.value;b.featureTypes=c;b.targetPrefix=this.namespaceAlias[b.targetNamespace];e=0;for(f=c.length;e<
f;++e)if(g=c[e],h=d[g.typeName],d[g.typeName])g.typeName=h.name},complexType:function(a,b){var c={typeName:a.getAttribute("name")};this.readChildNodes(a,c);b.complexTypes.push(c)},complexContent:function(a,b){this.readChildNodes(a,b)},extension:function(a,b){this.readChildNodes(a,b)},sequence:function(a,b){var c={elements:[]};this.readChildNodes(a,c);b.properties=c.elements},element:function(a,b){var c;if(b.elements){var d={};c=a.attributes;for(var e,f=0,g=c.length;f<g;++f)e=c[f],d[e.name]=e.value;
c=d.type||d.ref;if(!c)c={},this.readChildNodes(a,c),d.restriction=c,d.type=c.base;d.localType=(c.base||c).split(":").pop();b.elements.push(d);this.readChildNodes(a,d)}b.complexTypes&&(c=a.getAttribute("type"),d=c.split(":").pop(),b.customTypes[d]={name:a.getAttribute("name"),type:c})},annotation:function(a,b){b.annotation={};this.readChildNodes(a,b.annotation)},appinfo:function(a,b){if(!b.appinfo)b.appinfo=[];b.appinfo.push(this.getChildValue(a))},documentation:function(a,b){if(!b.documentation)b.documentation=
[];var c=this.getChildValue(a);b.documentation.push({lang:a.getAttribute("xml:lang"),textContent:c.replace(this.regExes.trimSpace,"")})},simpleType:function(a,b){this.readChildNodes(a,b)},restriction:function(a,b){b.base=a.getAttribute("base");this.readRestriction(a,b)}}},readRestriction:function(a,b){for(var c=a.childNodes,d,e,f=0,g=c.length;f<g;++f)d=c[f],d.nodeType==1&&(e=d.nodeName.split(":").pop(),d=d.getAttribute("value"),b[e]?(typeof b[e]=="string"&&(b[e]=[b[e]]),b[e].push(d)):b[e]=d)},read:function(a){typeof a==
"string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var b={};if(a.nodeName.split(":").pop()==="ExceptionReport"){var c=new GeoGlobe.Format.OGCExceptionReport;b.error=c.read(a)}else this.readNode(a,b);return b},CLASS_NAME:"GeoGlobe.Format.WFSDescribeFeatureType"});
GeoGlobe.Format.WKT=GeoGlobe.Class4OL(GeoGlobe.Format,{initialize:function(a){this.regExes={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/};GeoGlobe.Format.prototype.initialize.apply(this,[a])},read:function(a){var b,c,a=a.replace(/[\n\r]/g," ");if(c=this.regExes.typeStr.exec(a))if(a=c[1].toLowerCase(),c=c[2],this.parse[a]&&(b=this.parse[a].apply(this,[c])),this.internalProjection&&this.externalProjection)if(b&&
b.CLASS_NAME=="GeoGlobe.Feature")b.geometry.transform(this.externalProjection,this.internalProjection);else if(b&&a!="geometrycollection"&&typeof b=="object"){a=0;for(c=b.length;a<c;a++)b[a].geometry.transform(this.externalProjection,this.internalProjection)}return b},write:function(a){var b,c;a.constructor==Array?c=!0:(a=[a],c=!1);var d=[];c&&d.push("GEOMETRYCOLLECTION(");for(var e=0,f=a.length;e<f;++e)c&&e>0&&d.push(","),b=a[e].geometry,d.push(this.extractGeometry(b));c&&d.push(")");return d.join("")},
extractGeometry:function(a){var b=a.CLASS_NAME.split(".")[2].toLowerCase();if(!this.extract[b])return null;this.internalProjection&&this.externalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));return(b=="collection"?"GEOMETRYCOLLECTION":b.toUpperCase())+"("+this.extract[b].apply(this,[a])+")"},extract:{point:function(a){return a.x+" "+a.y},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push("("+this.extract.point.apply(this,[a.components[c]])+
")");return b.join(",")},linestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b.join(",")},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push("("+this.extract.linestring.apply(this,[a.components[c]])+")");return b.join(",")},polygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push("("+this.extract.linestring.apply(this,[a.components[c]])+")");return b.join(",")},multipolygon:function(a){for(var b=
[],c=0,d=a.components.length;c<d;++c)b.push("("+this.extract.polygon.apply(this,[a.components[c]])+")");return b.join(",")},collection:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extractGeometry.apply(this,[a.components[c]]));return b.join(",")}},parse:{point:function(a){a=GeoGlobe.String.trim(a).split(this.regExes.spaces);return new GeoGlobe.Feature(new GeoGlobe.Geometry.Point(a[0],a[1]))},multipoint:function(a){for(var b=GeoGlobe.String.trim(a).split(","),c=[],d=0,e=b.length;d<
e;++d)a=b[d].replace(this.regExes.trimParens,"$1"),c.push(this.parse.point.apply(this,[a]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.MultiPoint(c))},linestring:function(a){for(var a=GeoGlobe.String.trim(a).split(","),b=[],c=0,d=a.length;c<d;++c)b.push(this.parse.point.apply(this,[a[c]]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.LineString(b))},multilinestring:function(a){for(var b=GeoGlobe.String.trim(a).split(this.regExes.parenComma),c=[],d=0,e=b.length;d<e;++d)a=
b[d].replace(this.regExes.trimParens,"$1"),c.push(this.parse.linestring.apply(this,[a]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.MultiLineString(c))},polygon:function(a){for(var b,a=GeoGlobe.String.trim(a).split(this.regExes.parenComma),c=[],d=0,e=a.length;d<e;++d)b=a[d].replace(this.regExes.trimParens,"$1"),b=this.parse.linestring.apply(this,[b]).geometry,b=new GeoGlobe.Geometry.LinearRing(b.components),c.push(b);return new GeoGlobe.Feature(new GeoGlobe.Geometry.Polygon(c))},multipolygon:function(a){for(var b=
GeoGlobe.String.trim(a).split(this.regExes.doubleParenComma),c=[],d=0,e=b.length;d<e;++d)a=b[d].replace(this.regExes.trimParens,"$1"),c.push(this.parse.polygon.apply(this,[a]).geometry);return new GeoGlobe.Feature(new GeoGlobe.Geometry.MultiPolygon(c))},geometrycollection:function(a){for(var a=a.replace(/,\s*([A-Za-z])/g,"|$1"),a=GeoGlobe.String.trim(a).split("|"),b=[],c=0,d=a.length;c<d;++c)b.push(GeoGlobe.Format.WKT.prototype.read.apply(this,[a[c]]));return b}},CLASS_NAME:"GeoGlobe.Format.WKT"});
GeoGlobe.Format.CQL=function(){function a(a){function b(){var a=e.pop();switch(a.type){case "LOGICAL":var c=b(),g=b();return new GeoGlobe.Filter.Logical({filters:[g,c],type:f[a.text.toUpperCase()]});case "NOT":return a=b(),new GeoGlobe.Filter.Logical({filters:[a],type:GeoGlobe.Filter.Logical.NOT});case "BETWEEN":return e.pop(),g=b(),a=b(),c=b(),new GeoGlobe.Filter.Comparison({property:c,lowerBoundary:a,upperBoundary:g,type:GeoGlobe.Filter.Comparison.BETWEEN});case "COMPARISON":return g=b(),c=b(),
new GeoGlobe.Filter.Comparison({property:c,value:g,type:d[a.text.toUpperCase()]});case "IS_NULL":return c=b(),new GeoGlobe.Filter.Comparison({property:c,type:d[a.text.toUpperCase()]});case "VALUE":return(c=a.text.match(/^'(.*)'$/))?c[1].replace(/''/g,"'"):Number(a.text);case "SPATIAL":switch(a.text.toUpperCase()){case "BBOX":var a=b(),c=b(),g=b(),h=b(),j=b();return new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.BBOX,property:j,value:GeoGlobe.LngLatBounds.fromArray([h,g,c,a])});case "INTERSECTS":return g=
b(),c=b(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.INTERSECTS,property:c,value:g});case "WITHIN":return g=b(),c=b(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.WITHIN,property:c,value:g});case "CONTAINS":return g=b(),c=b(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.CONTAINS,property:c,value:g});case "DWITHIN":return a=b(),g=b(),c=b(),new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.DWITHIN,value:g,property:c,distance:Number(a)})}case "GEOMETRY":return GeoGlobe.Geometry.fromWKT(a.text);
default:return a.text}}for(var c=[],e=[];a.length;){var g=a.shift();switch(g.type){case "PROPERTY":case "GEOMETRY":case "VALUE":e.push(g);break;case "COMPARISON":case "BETWEEN":case "IS_NULL":case "LOGICAL":for(var j=h[g.type];c.length>0&&h[c[c.length-1].type]<=j;)e.push(c.pop());c.push(g);break;case "SPATIAL":case "NOT":case "LPAREN":c.push(g);break;case "RPAREN":for(;c.length>0&&c[c.length-1].type!="LPAREN";)e.push(c.pop());c.pop();c.length>0&&c[c.length-1].type=="SPATIAL"&&e.push(c.pop());case "COMMA":case "END":break;
default:throw Error("Unknown token type "+g.type);}}for(;c.length>0;)e.push(c.pop());a=b();if(e.length>0){a="Remaining tokens after building AST: \n";for(c=e.length-1;c>=0;c--)a+=e[c].type+": "+e[c].text+"\n";throw Error(a);}return a}var b={PROPERTY:/^[_a-zA-Z]\w*/,COMPARISON:/^(=|<>|<=|<|>=|>|LIKE)/i,IS_NULL:/^IS NULL/i,COMMA:/^,/,LOGICAL:/^(AND|OR)/i,VALUE:/^('([^']|'')*'|\d+(\.\d*)?|\.\d+)/,LPAREN:/^\(/,RPAREN:/^\)/,SPATIAL:/^(BBOX|INTERSECTS|DWITHIN|WITHIN|CONTAINS)/i,NOT:/^NOT/i,BETWEEN:/^BETWEEN/i,
GEOMETRY:function(a){var b=/^(POINT|LINESTRING|POLYGON|MULTIPOINT|MULTILINESTRING|MULTIPOLYGON|GEOMETRYCOLLECTION)/.exec(a);if(b){var c=a.length,b=a.indexOf("(",b[0].length);if(b>-1)for(var d=1;b<c&&d>0;)switch(b++,a.charAt(b)){case "(":d++;break;case ")":d--}return[a.substr(0,b+1)]}},END:/^$/},c={LPAREN:["GEOMETRY","SPATIAL","PROPERTY","VALUE","LPAREN"],RPAREN:["NOT","LOGICAL","END","RPAREN"],PROPERTY:["COMPARISON","BETWEEN","COMMA","IS_NULL"],BETWEEN:["VALUE"],IS_NULL:["END"],COMPARISON:["VALUE"],
COMMA:["GEOMETRY","VALUE","PROPERTY"],VALUE:["LOGICAL","COMMA","RPAREN","END"],SPATIAL:["LPAREN"],LOGICAL:["NOT","VALUE","SPATIAL","PROPERTY","LPAREN"],NOT:["PROPERTY","LPAREN"],GEOMETRY:["COMMA","RPAREN"]},d={"=":GeoGlobe.Filter.Comparison.EQUAL_TO,"<>":GeoGlobe.Filter.Comparison.NOT_EQUAL_TO,"<":GeoGlobe.Filter.Comparison.LESS_THAN,"<=":GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,">":GeoGlobe.Filter.Comparison.GREATER_THAN,">=":GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,LIKE:GeoGlobe.Filter.Comparison.LIKE,
BETWEEN:GeoGlobe.Filter.Comparison.BETWEEN,"IS NULL":GeoGlobe.Filter.Comparison.IS_NULL},e={},f={AND:GeoGlobe.Filter.Logical.AND,OR:GeoGlobe.Filter.Logical.OR},g={},h={RPAREN:3,LOGICAL:2,COMPARISON:1},j;for(j in d)d.hasOwnProperty(j)&&(e[d[j]]=j);for(j in f)f.hasOwnProperty(j)&&(g[f[j]]=j);return GeoGlobe.Class4OL(GeoGlobe.Format,{read:function(d){var e=d,d=[],f,g=["NOT","GEOMETRY","SPATIAL","PROPERTY","LPAREN"];do{a:{f=g;for(var h=void 0,g=void 0,j=f.length,h=0;h<j;h++){var g=f[h],p=b[g]instanceof
RegExp?b[g].exec(e):(0,b[g])(e);if(p){f=p[0];e=e.substr(f.length).replace(/^\s*/,"");f={type:g,text:f,remainder:e};break a}}d="ERROR: In parsing: ["+e+"], expected one of: ";for(h=0;h<j;h++)g=f[h],d+="\n    "+g+": "+b[g];throw Error(d);}e=f.remainder;g=c[f.type];if(f.type!="END"&&!g)throw Error("No follows list for "+f.type);d.push(f)}while(f.type!="END");d=a(d);if(this.keepData)this.data=d;return d},write:function(a){if(a instanceof GeoGlobe.Geometry)return a.toString();switch(a.CLASS_NAME){case "GeoGlobe.Filter.Spatial":switch(a.type){case GeoGlobe.Filter.Spatial.BBOX:return"BBOX("+
a.property+","+a.value.toBBOX()+")";case GeoGlobe.Filter.Spatial.DWITHIN:return"DWITHIN("+a.property+", "+this.write(a.value)+", "+a.distance+")";case GeoGlobe.Filter.Spatial.WITHIN:return"WITHIN("+a.property+", "+this.write(a.value)+")";case GeoGlobe.Filter.Spatial.INTERSECTS:return"INTERSECTS("+a.property+", "+this.write(a.value)+")";case GeoGlobe.Filter.Spatial.CONTAINS:return"CONTAINS("+a.property+", "+this.write(a.value)+")";default:throw Error("Unknown spatial filter type: "+a.type);}case "GeoGlobe.Filter.Logical":if(a.type==
GeoGlobe.Filter.Logical.NOT)return"NOT ("+this.write(a.filters[0])+")";else{for(var b="(",c=!0,d=0;d<a.filters.length;d++)c?c=!1:b+=") "+g[a.type]+" (",b+=this.write(a.filters[d]);return b+")"}case "GeoGlobe.Filter.Comparison":return a.type==GeoGlobe.Filter.Comparison.BETWEEN?a.property+" BETWEEN "+this.write(a.lowerBoundary)+" AND "+this.write(a.upperBoundary):a.value!==null?a.property+" "+e[a.type]+" "+this.write(a.value):a.property+" "+e[a.type];case void 0:if(typeof a==="string")return"'"+a.replace(/'/g,
"''")+"'";else if(typeof a==="number")return String(a);default:throw Error("Can't encode: "+a.CLASS_NAME+" "+a);}},CLASS_NAME:"GeoGlobe.Format.CQL"})}();GeoGlobe.Format.Filter=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"GeoGlobe.Format.Filter"});
GeoGlobe.Format.Filter.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc",gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"ogc",schemaLocation:null,initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){var b={};this.readers.ogc.Filter.apply(this,[a,b]);return b.filter},readers:{ogc:{_expression:function(a){for(var b="",c=a.firstChild;c;c=
c.nextSibling)switch(c.nodeType){case 1:a=this.readNode(c);a.property?b+="${"+a.property+"}":a.value!==void 0&&(b+=a.value);break;case 3:case 4:b+=c.nodeValue}return b},Filter:function(a,b){var c={fids:[],filters:[]};this.readChildNodes(a,c);if(c.fids.length>0)b.filter=new GeoGlobe.Filter.FeatureId({fids:c.fids});else if(c.filters.length>0)b.filter=c.filters[0]},FeatureId:function(a,b){var c=a.getAttribute("fid");c&&b.fids.push(c)},And:function(a,b){var c=new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.AND});
this.readChildNodes(a,c);b.filters.push(c)},Or:function(a,b){var c=new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.OR});this.readChildNodes(a,c);b.filters.push(c)},Not:function(a,b){var c=new GeoGlobe.Filter.Logical({type:GeoGlobe.Filter.Logical.NOT});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLessThan:function(a,b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LESS_THAN});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsGreaterThan:function(a,b){var c=
new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.GREATER_THAN});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLessThanOrEqualTo:function(a,b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsGreaterThanOrEqualTo:function(a,b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsBetween:function(a,
b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.BETWEEN});this.readChildNodes(a,c);b.filters.push(c)},Literal:function(a,b){b.value=GeoGlobe.String.numericIf(this.getChildValue(a),!0)},PropertyName:function(a,b){b.property=this.getChildValue(a)},LowerBoundary:function(a,b){b.lowerBoundary=GeoGlobe.String.numericIf(this.readers.ogc._expression.call(this,a),!0)},UpperBoundary:function(a,b){b.upperBoundary=GeoGlobe.String.numericIf(this.readers.ogc._expression.call(this,a),!0)},
Intersects:function(a,b){this.readSpatial(a,b,GeoGlobe.Filter.Spatial.INTERSECTS)},Within:function(a,b){this.readSpatial(a,b,GeoGlobe.Filter.Spatial.WITHIN)},Contains:function(a,b){this.readSpatial(a,b,GeoGlobe.Filter.Spatial.CONTAINS)},DWithin:function(a,b){this.readSpatial(a,b,GeoGlobe.Filter.Spatial.DWITHIN)},Distance:function(a,b){b.distance=parseInt(this.getChildValue(a));b.distanceUnits=a.getAttribute("units")},Function:function(){},PropertyIsNull:function(a,b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.IS_NULL});
this.readChildNodes(a,c);b.filters.push(c)}}},readSpatial:function(a,b,c){c=new GeoGlobe.Filter.Spatial({type:c});this.readChildNodes(a,c);c.value=c.components[0];delete c.components;b.filters.push(c)},encodeLiteral:function(a){a instanceof Date&&(a=GeoGlobe.Date.toISOString(a));return a},writeOgcExpression:function(a,b){a instanceof GeoGlobe.Filter.Function?this.writeNode("Function",a,b):this.writeNode("Literal",a,b);return b},write:function(a){return this.writers.ogc.Filter.apply(this,[a])},writers:{ogc:{Filter:function(a){var b=
this.createElementNSPlus("ogc:Filter");this.writeNode(this.getFilterType(a),a,b);return b},_featureIds:function(a){for(var b=this.createDocumentFragment(),c=0,d=a.fids.length;c<d;++c)this.writeNode("ogc:FeatureId",a.fids[c],b);return b},FeatureId:function(a){return this.createElementNSPlus("ogc:FeatureId",{attributes:{fid:a}})},And:function(a){for(var b=this.createElementNSPlus("ogc:And"),c,d=0,e=a.filters.length;d<e;++d)c=a.filters[d],this.writeNode(this.getFilterType(c),c,b);return b},Or:function(a){for(var b=
this.createElementNSPlus("ogc:Or"),c,d=0,e=a.filters.length;d<e;++d)c=a.filters[d],this.writeNode(this.getFilterType(c),c,b);return b},Not:function(a){var b=this.createElementNSPlus("ogc:Not"),a=a.filters[0];this.writeNode(this.getFilterType(a),a,b);return b},PropertyIsLessThan:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLessThan");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsGreaterThan:function(a){var b=this.createElementNSPlus("ogc:PropertyIsGreaterThan");
this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsLessThanOrEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLessThanOrEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsGreaterThanOrEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsGreaterThanOrEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsBetween:function(a){var b=this.createElementNSPlus("ogc:PropertyIsBetween");
this.writeNode("PropertyName",a,b);this.writeNode("LowerBoundary",a,b);this.writeNode("UpperBoundary",a,b);return b},PropertyName:function(a){return this.createElementNSPlus("ogc:PropertyName",{value:a.property})},Literal:function(a){return this.createElementNSPlus("ogc:Literal",{value:(this.encodeLiteral||GeoGlobe.Format.Filter.v1.prototype.encodeLiteral)(a)})},LowerBoundary:function(a){var b=this.createElementNSPlus("ogc:LowerBoundary");this.writeOgcExpression(a.lowerBoundary,b);return b},UpperBoundary:function(a){var b=
this.createElementNSPlus("ogc:UpperBoundary");this.writeNode("Literal",a.upperBoundary,b);return b},INTERSECTS:function(a){return this.writeSpatial(a,"Intersects")},WITHIN:function(a){return this.writeSpatial(a,"Within")},CONTAINS:function(a){return this.writeSpatial(a,"Contains")},DWITHIN:function(a){var b=this.writeSpatial(a,"DWithin");this.writeNode("Distance",a,b);return b},Distance:function(a){return this.createElementNSPlus("ogc:Distance",{attributes:{units:a.distanceUnits},value:a.distance})},
Function:function(a){for(var b=this.createElementNSPlus("ogc:Function",{attributes:{name:a.name}}),a=a.params,c=0,d=a.length;c<d;c++)this.writeOgcExpression(a[c],b);return b},PropertyIsNull:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNull");this.writeNode("PropertyName",a,b);return b},SortBy:function(a){for(var b=this.createElementNSPlus("ogc:SortBy"),c=0,d=a.length;c<d;c++)this.writeNode("ogc:SortProperty",a[c],b);return b},SortProperty:function(a){var b=this.createElementNSPlus("ogc:SortProperty");
this.writeNode("ogc:PropertyName",a,b);this.writeNode("ogc:SortOrder",a.order=="DESC"?"DESC":"ASC",b);return b},SortOrder:function(a){return this.createElementNSPlus("ogc:SortOrder",{value:a})}}},getFilterType:function(a){var b=this.filterMap[a.type];if(!b)throw"Filter writing not supported for rule type: "+a.type;return b},filterMap:{"&&":"And","||":"Or","!":"Not","==":"PropertyIsEqualTo","!=":"PropertyIsNotEqualTo","<":"PropertyIsLessThan",">":"PropertyIsGreaterThan","<=":"PropertyIsLessThanOrEqualTo",
">=":"PropertyIsGreaterThanOrEqualTo","..":"PropertyIsBetween","~":"PropertyIsLike",NULL:"PropertyIsNull",BBOX:"BBOX",DWITHIN:"DWITHIN",WITHIN:"WITHIN",CONTAINS:"CONTAINS",INTERSECTS:"INTERSECTS",FID:"_featureIds"},CLASS_NAME:"GeoGlobe.Format.Filter.v1"});
GeoGlobe.Format.Filter.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.GML.v2,GeoGlobe.Format.Filter.v1,{VERSION:"1.0.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.0.0/filter.xsd",initialize:function(a){GeoGlobe.Format.GML.v2.prototype.initialize.apply(this,[a])},readers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(a,b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsNotEqualTo:function(a,b){var c=
new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.NOT_EQUAL_TO});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLike:function(a,b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LIKE});this.readChildNodes(a,c);var d=a.getAttribute("wildCard"),e=a.getAttribute("singleChar"),f=a.getAttribute("escape");c.value2regex(d,e,f);b.filters.push(c)}},GeoGlobe.Format.Filter.v1.prototype.readers.ogc),gml:GeoGlobe.Format.GML.v2.prototype.readers.gml,feature:GeoGlobe.Format.GML.v2.prototype.readers.feature},
writers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsNotEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNotEqualTo");this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsLike:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{wildCard:"*",singleChar:".",escape:"!"}});
this.writeNode("PropertyName",a,b);this.writeNode("Literal",a.regex2value(),b);return b},BBOX:function(a){var b=this.createElementNSPlus("ogc:BBOX");a.property&&this.writeNode("PropertyName",a,b);var c=this.writeNode("gml:Box",a.value,b);a.projection&&c.setAttribute("srsName",a.projection);return b}},GeoGlobe.Format.Filter.v1.prototype.writers.ogc),gml:GeoGlobe.Format.GML.v2.prototype.writers.gml,feature:GeoGlobe.Format.GML.v2.prototype.writers.feature},writeSpatial:function(a,b){var c=this.createElementNSPlus("ogc:"+
b);this.writeNode("PropertyName",a,c);if(a.value instanceof GeoGlobe.Filter.Function)this.writeNode("Function",a.value,c);else{var d;d=a.value instanceof GeoGlobe.Geometry?this.writeNode("feature:_geometry",a.value).firstChild:this.writeNode("gml:Box",a.value);a.projection&&d.setAttribute("srsName",a.projection);c.appendChild(d)}return c},CLASS_NAME:"GeoGlobe.Format.Filter.v1_0_0"});
GeoGlobe.Format.Filter.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.GML.v3,GeoGlobe.Format.Filter.v1,{VERSION:"1.1.0",schemaLocation:"http://www.opengis.net/ogc/filter/1.1.0/filter.xsd",initialize:function(a){GeoGlobe.Format.GML.v3.prototype.initialize.apply(this,[a])},readers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(a,b){var c=a.getAttribute("matchCase"),c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.EQUAL_TO,matchCase:!(c==="false"||c==="0")});this.readChildNodes(a,
c);b.filters.push(c)},PropertyIsNotEqualTo:function(a,b){var c=a.getAttribute("matchCase"),c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.NOT_EQUAL_TO,matchCase:!(c==="false"||c==="0")});this.readChildNodes(a,c);b.filters.push(c)},PropertyIsLike:function(a,b){var c=new GeoGlobe.Filter.Comparison({type:GeoGlobe.Filter.Comparison.LIKE});this.readChildNodes(a,c);var d=a.getAttribute("wildCard"),e=a.getAttribute("singleChar"),f=a.getAttribute("escapeChar");c.value2regex(d,e,f);b.filters.push(c)}},
GeoGlobe.Format.Filter.v1.prototype.readers.ogc),gml:GeoGlobe.Format.GML.v3.prototype.readers.gml,feature:GeoGlobe.Format.GML.v3.prototype.readers.feature},writers:{ogc:GeoGlobe.Util.applyDefaults({PropertyIsEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsEqualTo",{attributes:{matchCase:a.matchCase}});this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsNotEqualTo:function(a){var b=this.createElementNSPlus("ogc:PropertyIsNotEqualTo",{attributes:{matchCase:a.matchCase}});
this.writeNode("PropertyName",a,b);this.writeOgcExpression(a.value,b);return b},PropertyIsLike:function(a){var b=this.createElementNSPlus("ogc:PropertyIsLike",{attributes:{matchCase:a.matchCase,wildCard:"*",singleChar:".",escapeChar:"!"}});this.writeNode("PropertyName",a,b);this.writeNode("Literal",a.regex2value(),b);return b},BBOX:function(a){var b=this.createElementNSPlus("ogc:BBOX");a.property&&this.writeNode("PropertyName",a,b);var c=this.writeNode("gml:Envelope",a.value);a.projection&&c.setAttribute("srsName",
a.projection);b.appendChild(c);return b},SortBy:function(a){for(var b=this.createElementNSPlus("ogc:SortBy"),c=0,d=a.length;c<d;c++)this.writeNode("ogc:SortProperty",a[c],b);return b},SortProperty:function(a){var b=this.createElementNSPlus("ogc:SortProperty");this.writeNode("ogc:PropertyName",a,b);this.writeNode("ogc:SortOrder",a.order=="DESC"?"DESC":"ASC",b);return b},SortOrder:function(a){return this.createElementNSPlus("ogc:SortOrder",{value:a})}},GeoGlobe.Format.Filter.v1.prototype.writers.ogc),
gml:GeoGlobe.Format.GML.v3.prototype.writers.gml,feature:GeoGlobe.Format.GML.v3.prototype.writers.feature},writeSpatial:function(a,b){var c=this.createElementNSPlus("ogc:"+b);this.writeNode("PropertyName",a,c);if(a.value instanceof GeoGlobe.Filter.Function)this.writeNode("Function",a.value,c);else{var d;d=a.value instanceof GeoGlobe.Geometry?this.writeNode("feature:_geometry",a.value).firstChild:this.writeNode("gml:Envelope",a.value);a.projection&&d.setAttribute("srsName",a.projection);c.appendChild(d)}return c},
CLASS_NAME:"GeoGlobe.Format.Filter.v1_1_0"});GeoGlobe.Format.WFST=function(a){var a=GeoGlobe.Util.applyDefaults(a,GeoGlobe.Format.WFST.DEFAULTS),b=GeoGlobe.Format.WFST["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported WFST version: "+a.version;return new b(a)};GeoGlobe.Format.WFST.DEFAULTS={version:"1.0.0"};
GeoGlobe.Format.WFST.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},defaultPrefix:"wfs",version:null,schemaLocations:null,srsName:null,extractAttributes:!0,xy:!0,stateName:null,initialize:function(a){this.stateName={};this.stateName[GeoGlobe.State.INSERT]="wfs:Insert";this.stateName[GeoGlobe.State.UPDATE]=
"wfs:Update";this.stateName[GeoGlobe.State.DELETE]="wfs:Delete";GeoGlobe.Format.XML.prototype.initialize.apply(this,[a])},getSrsName:function(a,b){var c=b&&b.srsName;c||(c=a&&a.layer?a.layer.projection.getCode():this.srsName);return c},read:function(a,b){b=b||{};GeoGlobe.Util.applyDefaults(b,{output:"features"});typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var c={};a&&this.readNode(a,c,!0);if(c.features&&b.output==="features")c=
c.features;return c},readers:{wfs:{FeatureCollection:function(a,b){b.features=[];this.readChildNodes(a,b)}}},write:function(a,b){var c=this.writeNode("wfs:Transaction",{features:a,options:b}),d=this.schemaLocationAttr();d&&this.setAttributeNS(c,this.namespaces.xsi,"xsi:schemaLocation",d);return GeoGlobe.Format.XML.prototype.write.apply(this,[c])},writers:{wfs:{GetFeature:function(a){var b=this.createElementNSPlus("wfs:GetFeature",{attributes:{service:"WFS",version:this.version,outputFormat:a&&a.outputFormat,
maxFeatures:a&&a.maxFeatures,resultType:a&&a.resultType,startPosition:a&&a.startPosition,"xsi:schemaLocation":this.schemaLocationAttr(a)}});if(typeof this.featureType=="string")this.writeNode("Query",a,b);else for(var c=0,d=this.featureType.length;c<d;c++)a.featureType=this.featureType[c],this.writeNode("Query",a,b);return b},Transaction:function(a){var a=a||{},b=a.options||{},c=this.createElementNSPlus("wfs:Transaction",{attributes:{service:"WFS",version:this.version,handle:b.handle}}),d,e=a.features;
if(e){b.multi===!0&&GeoGlobe.Util.extend(this.geometryTypes,{"GeoGlobe.Geometry.Point":"MultiPoint","GeoGlobe.Geometry.LineString":this.multiCurve===!0?"MultiCurve":"MultiLineString","GeoGlobe.Geometry.Polygon":this.multiSurface===!0?"MultiSurface":"MultiPolygon"});var f,g,a=0;for(d=e.length;a<d;++a)g=e[a],(f=this.stateName[g.state])&&this.writeNode(f,{feature:g,options:b},c);b.multi===!0&&this.setGeometryTypes()}if(b.nativeElements){a=0;for(d=b.nativeElements.length;a<d;++a)this.writeNode("wfs:Native",
b.nativeElements[a],c)}return c},Native:function(a){return this.createElementNSPlus("wfs:Native",{attributes:{vendorId:a.vendorId,safeToIgnore:a.safeToIgnore},value:a.value})},Insert:function(a){var b=a.feature,a=a.options,a=this.createElementNSPlus("wfs:Insert",{attributes:{handle:a&&a.handle}});this.srsName=this.getSrsName(b);this.writeNode("feature:_typeName",b,a);return a},Update:function(a){var b=a.feature,a=a.options,a=this.createElementNSPlus("wfs:Update",{attributes:{handle:a&&a.handle,typeName:(this.featureNS?
this.featurePrefix+":":"")+this.featureType}});this.featureNS&&a.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);var c=b.modified;if(this.geometryName!==null&&(!c||c.geometry!==void 0))this.srsName=this.getSrsName(b),this.writeNode("Property",{name:this.geometryName,value:b.geometry},a);for(var d in b.attributes)b.attributes[d]!==void 0&&(!c||!c.attributes||c.attributes&&c.attributes[d]!==void 0)&&this.writeNode("Property",{name:d,value:b.attributes[d]},a);this.writeNode("ogc:Filter",new GeoGlobe.Filter.FeatureId({fids:[b.fid]}),
a);return a},Property:function(a){var b=this.createElementNSPlus("wfs:Property");this.writeNode("Name",a.name,b);a.value!==null&&this.writeNode("Value",a.value,b);return b},Name:function(a){return this.createElementNSPlus("wfs:Name",{value:a})},Value:function(a){var b;a instanceof GeoGlobe.Geometry?(b=this.createElementNSPlus("wfs:Value"),a=this.writeNode("feature:_geometry",a).firstChild,b.appendChild(a)):b=this.createElementNSPlus("wfs:Value",{value:a});return b},Delete:function(a){var b=a.feature,
a=a.options,a=this.createElementNSPlus("wfs:Delete",{attributes:{handle:a&&a.handle,typeName:(this.featureNS?this.featurePrefix+":":"")+this.featureType}});this.featureNS&&a.setAttribute("xmlns:"+this.featurePrefix,this.featureNS);this.writeNode("ogc:Filter",new GeoGlobe.Filter.FeatureId({fids:[b.fid]}),a);return a}}},schemaLocationAttr:function(a){var a=GeoGlobe.Util.extend({featurePrefix:this.featurePrefix,schema:this.schema},a),b=GeoGlobe.Util.extend({},this.schemaLocations);if(a.schema)b[a.featurePrefix]=
a.schema;var a=[],c,d;for(d in b)(c=this.namespaces[d])&&a.push(c+" "+b[d]);return a.join(" ")||void 0},setFilterProperty:function(a){if(a.filters)for(var b=0,c=a.filters.length;b<c;++b)GeoGlobe.Format.WFST.v1.prototype.setFilterProperty.call(this,a.filters[b]);else if(a instanceof GeoGlobe.Filter.Spatial&&!a.property)a.property=this.geometryName},CLASS_NAME:"GeoGlobe.Format.WFST.v1"});
GeoGlobe.Format.WFST.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.Filter.v1_0_0,GeoGlobe.Format.WFST.v1,{version:"1.0.0",srsNameInQuery:!1,schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.0.0/WFS-transaction.xsd"},initialize:function(a){GeoGlobe.Format.Filter.v1_0_0.prototype.initialize.apply(this,[a]);GeoGlobe.Format.WFST.v1.prototype.initialize.apply(this,[a])},readNode:function(){return GeoGlobe.Format.GML.v2.prototype.readNode.apply(this,arguments)},readers:{wfs:GeoGlobe.Util.applyDefaults({WFS_TransactionResponse:function(a,
b){b.insertIds=[];b.success=!1;this.readChildNodes(a,b)},InsertResult:function(a,b){var c={fids:[]};this.readChildNodes(a,c);b.insertIds=b.insertIds.concat(c.fids)},TransactionResult:function(a,b){this.readChildNodes(a,b)},Status:function(a,b){this.readChildNodes(a,b)},SUCCESS:function(a,b){b.success=!0}},GeoGlobe.Format.WFST.v1.prototype.readers.wfs),gml:GeoGlobe.Format.GML.v2.prototype.readers.gml,feature:GeoGlobe.Format.GML.v2.prototype.readers.feature,ogc:GeoGlobe.Format.Filter.v1_0_0.prototype.readers.ogc},
writers:{wfs:GeoGlobe.Util.applyDefaults({Query:function(a){var a=GeoGlobe.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,featureType:this.featureType,srsName:this.srsName,srsNameInQuery:this.srsNameInQuery},a),b=a.featurePrefix,c=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(a.featureNS?b+":":"")+a.featureType,time:a&&a.time,userecent:a&&a.userecent}});a.srsNameInQuery&&a.srsName&&c.setAttribute("srsName",a.srsName);a.featureNS&&c.setAttribute("xmlns:"+b,a.featureNS);
if(a.propertyNames)for(var b=0,d=a.propertyNames.length;b<d;b++)this.writeNode("ogc:PropertyName",{property:a.propertyNames[b]},c);a.filter&&(this.setFilterProperty(a.filter),this.writeNode("ogc:Filter",a.filter,c));a.sortBy&&this.writeNode("ogc:SortBy",a.sortBy,c);a.groupBy&&this.writeNode("ogc:GroupBy",a.groupBy,c);return c}},GeoGlobe.Format.WFST.v1.prototype.writers.wfs),gml:GeoGlobe.Format.GML.v2.prototype.writers.gml,feature:GeoGlobe.Format.GML.v2.prototype.writers.feature,ogc:GeoGlobe.Format.Filter.v1_0_0.prototype.writers.ogc},
CLASS_NAME:"GeoGlobe.Format.WFST.v1_0_0"});
GeoGlobe.Format.WFST.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.Filter.v1_1_0,GeoGlobe.Format.WFST.v1,{version:"1.1.0",schemaLocations:{wfs:"http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"},initialize:function(a){GeoGlobe.Format.Filter.v1_1_0.prototype.initialize.apply(this,[a]);GeoGlobe.Format.WFST.v1.prototype.initialize.apply(this,[a])},readNode:function(){return GeoGlobe.Format.GML.v3.prototype.readNode.apply(this,arguments)},readers:{wfs:GeoGlobe.Util.applyDefaults({FeatureCollection:function(a,b){b.numberOfFeatures=
parseInt(a.getAttribute("numberOfFeatures"));GeoGlobe.Format.WFST.v1.prototype.readers.wfs.FeatureCollection.apply(this,arguments)},TransactionResponse:function(a,b){b.insertIds=[];b.success=!1;this.readChildNodes(a,b)},TransactionSummary:function(a,b){b.success=!0},InsertResults:function(a,b){this.readChildNodes(a,b)},Feature:function(a,b){var c={fids:[]};this.readChildNodes(a,c);b.insertIds.push(c.fids[0])}},GeoGlobe.Format.WFST.v1.prototype.readers.wfs),gml:GeoGlobe.Format.GML.v3.prototype.readers.gml,
feature:GeoGlobe.Format.GML.v3.prototype.readers.feature,ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.readers.ogc,ows:GeoGlobe.Format.OWSCommon.v1_0_0.prototype.readers.ows},writers:{wfs:GeoGlobe.Util.applyDefaults({GetFeature:function(a){var b=GeoGlobe.Format.WFST.v1.prototype.writers.wfs.GetFeature.apply(this,arguments);a&&this.setAttributes(b,{resultType:a.resultType,startIndex:a.startIndex,count:a.count});return b},Query:function(a){var a=GeoGlobe.Util.extend({featureNS:this.featureNS,featurePrefix:this.featurePrefix,
featureType:this.featureType,srsName:this.srsName},a),b=a.featurePrefix,c=this.createElementNSPlus("wfs:Query",{attributes:{typeName:(a.featureNS?b+":":"")+a.featureType,srsName:a.srsName,time:a&&a.time,userecent:a&&a.userecent}});a.featureNS&&c.setAttribute("xmlns:"+b,a.featureNS);if(a.propertyNames)for(var b=0,d=a.propertyNames.length;b<d;b++)this.writeNode("wfs:PropertyName",{property:a.propertyNames[b]},c);a.filter&&(GeoGlobe.Format.WFST.v1_1_0.prototype.setFilterProperty.call(this,a.filter),
this.writeNode("ogc:Filter",a.filter,c));a.sortBy&&this.writeNode("ogc:SortBy",a.sortBy,c);a.groupBy&&this.writeNode("ogc:GroupBy",a.groupBy,c);return c},PropertyName:function(a){return this.createElementNSPlus("wfs:PropertyName",{value:a.property})}},GeoGlobe.Format.WFST.v1.prototype.writers.wfs),gml:GeoGlobe.Format.GML.v3.prototype.writers.gml,feature:GeoGlobe.Format.GML.v3.prototype.writers.feature,ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"GeoGlobe.Format.WFST.v1_1_0"});
GeoGlobe.Format.JSON=GeoGlobe.Class4OL(GeoGlobe.Format,{indent:"    ",space:" ",newline:"\n",level:0,pretty:!1,nativeJSON:function(){return!(!window.JSON||!(typeof JSON.parse=="function"&&typeof JSON.stringify=="function"))}(),read:function(a,b){var c;if(this.nativeJSON)c=JSON.parse(a,b);else try{if(/^[\],:{}\s]*$/.test(a.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))&&(c=eval("("+a+")"),typeof b===
"function")){var d=function(a,c){if(c&&typeof c==="object")for(var e in c)c.hasOwnProperty(e)&&(c[e]=d(e,c[e]));return b(a,c)};c=d("",c)}}catch(e){}if(this.keepData)this.data=c;return c},write:function(a,b){this.pretty=!!b;var c=null,d=typeof a;if(this.serialize[d])try{c=!this.pretty&&this.nativeJSON?JSON.stringify(a):this.serialize[d].apply(this,[a])}catch(e){GeoGlobe.Console.error("Trouble serializing: "+e)}return c},writeIndent:function(){var a=[];if(this.pretty)for(var b=0;b<this.level;++b)a.push(this.indent);
return a.join("")},writeNewline:function(){return this.pretty?this.newline:""},writeSpace:function(){return this.pretty?this.space:""},serialize:{object:function(a){if(a==null)return"null";if(a.constructor==Date)return this.serialize.date.apply(this,[a]);if(a.constructor==Array)return this.serialize.array.apply(this,[a]);var b=["{"];this.level+=1;var c,d,e,f=!1;for(c in a)a.hasOwnProperty(c)&&(d=GeoGlobe.Format.JSON.prototype.write.apply(this,[c,this.pretty]),e=GeoGlobe.Format.JSON.prototype.write.apply(this,
[a[c],this.pretty]),d!=null&&e!=null&&(f&&b.push(","),b.push(this.writeNewline(),this.writeIndent(),d,":",this.writeSpace(),e),f=!0));this.level-=1;b.push(this.writeNewline(),this.writeIndent(),"}");return b.join("")},array:function(a){var b,c=["["];this.level+=1;for(var d=0,e=a.length;d<e;++d)b=GeoGlobe.Format.JSON.prototype.write.apply(this,[a[d],this.pretty]),b!=null&&(d>0&&c.push(","),c.push(this.writeNewline(),this.writeIndent(),b));this.level-=1;c.push(this.writeNewline(),this.writeIndent(),
"]");return c.join("")},string:function(a){var b={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};if(/["\\\x00-\x1f]/.test(a))return'"'+a.replace(/([\x00-\x1f\\"])/g,function(a,d){var e=b[d];if(e)return e;e=d.charCodeAt();return"\\u00"+Math.floor(e/16).toString(16)+(e%16).toString(16)})+'"';return'"'+a+'"'},number:function(a){return isFinite(a)?String(a):"null"},"boolean":function(a){return String(a)},date:function(a){function b(a){return a<10?"0"+a:a}return'"'+
a.getFullYear()+"-"+b(a.getMonth()+1)+"-"+b(a.getDate())+"T"+b(a.getHours())+":"+b(a.getMinutes())+":"+b(a.getSeconds())+'"'}},CLASS_NAME:"GeoGlobe.Format.JSON"});
GeoGlobe.Format.GeoJSON=GeoGlobe.Class4OL(GeoGlobe.Format.JSON,{ignoreExtraDims:!1,read:function(a,b,c){var b=b?b:"FeatureCollection",d=null,e=null;if(e=typeof a=="string"?GeoGlobe.Format.JSON.prototype.read.apply(this,[a,c]):a)if(typeof e.type!="string")GeoGlobe.Console.error("Bad GeoJSON - no type: "+a);else{if(this.isValidType(e,b))switch(b){case "Geometry":try{d=this.parseGeometry(e)}catch(f){GeoGlobe.Console.error(f)}break;case "Feature":try{d=this.parseFeature(e),d.type="Feature"}catch(g){GeoGlobe.Console.error(g)}break;
case "FeatureCollection":switch(d=[],e.type){case "Feature":try{d.push(this.parseFeature(e))}catch(h){d=null,GeoGlobe.Console.error(h)}break;case "FeatureCollection":a=0;for(b=e.features.length;a<b;++a)try{d.push(this.parseFeature(e.features[a]))}catch(j){d=null,GeoGlobe.Console.error(j)}break;default:try{var l=this.parseGeometry(e);d.push(new GeoGlobe.Feature(l))}catch(n){d=null,GeoGlobe.Console.error(n)}}}}else GeoGlobe.Console.error("Bad JSON: "+a);return d},isValidType:function(a,b){var c=!1;
switch(b){case "Geometry":GeoGlobe.Util.indexOf(["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","Box","GeometryCollection"],a.type)==-1?GeoGlobe.Console.error("Unsupported geometry type: "+a.type):c=!0;break;case "FeatureCollection":c=!0;break;default:a.type==b?c=!0:GeoGlobe.Console.error("Cannot convert types from "+a.type+" to "+b)}return c},parseFeature:function(a){var b,c,d;c=a.properties?a.properties:{};d=a.geometry&&a.geometry.bbox||a.bbox;try{b=this.parseGeometry(a.geometry)}catch(e){throw e;
}b=new GeoGlobe.Feature(b,c);if(d)b.bounds=GeoGlobe.LngLatBounds.fromArray(d);if(a.id)b.fid=a.id;return b},parseGeometry:function(a){if(a==null)return null;var b,c=!1;if(a.type=="GeometryCollection"){if(!GeoGlobe.Util.isArray(a.geometries))throw"GeometryCollection must have geometries array: "+a;b=a.geometries.length;for(var c=Array(b),d=0;d<b;++d)c[d]=this.parseGeometry.apply(this,[a.geometries[d]]);b=new GeoGlobe.Geometry.Collection(c);c=!0}else{if(!GeoGlobe.Util.isArray(a.coordinates))throw"Geometry must have coordinates array: "+
a;if(!this.parseCoords[a.type.toLowerCase()])throw"Unsupported geometry type: "+a.type;try{b=this.parseCoords[a.type.toLowerCase()].apply(this,[a.coordinates])}catch(e){throw e;}}this.internalProjection&&this.externalProjection&&!c&&b.transform(this.externalProjection,this.internalProjection);return b},parseCoords:{point:function(a){if(this.ignoreExtraDims==!1&&a.length!=2)throw"Only 2D points are supported: "+a;return new GeoGlobe.Geometry.Point(a[0],a[1])},multipoint:function(a){for(var b=[],c=
null,d=0,e=a.length;d<e;++d){try{c=this.parseCoords.point.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new GeoGlobe.Geometry.MultiPoint(b)},linestring:function(a){for(var b=[],c=null,d=0,e=a.length;d<e;++d){try{c=this.parseCoords.point.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new GeoGlobe.Geometry.LineString(b)},multilinestring:function(a){for(var b=[],c=null,d=0,e=a.length;d<e;++d){try{c=this.parseCoords.linestring.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new GeoGlobe.Geometry.MultiLineString(b)},
polygon:function(a){for(var b=[],c,d,e=0,f=a.length;e<f;++e){try{d=this.parseCoords.linestring.apply(this,[a[e]])}catch(g){throw g;}c=new GeoGlobe.Geometry.LinearRing(d.components);b.push(c)}return new GeoGlobe.Geometry.Polygon(b)},multipolygon:function(a){for(var b=[],c=null,d=0,e=a.length;d<e;++d){try{c=this.parseCoords.polygon.apply(this,[a[d]])}catch(f){throw f;}b.push(c)}return new GeoGlobe.Geometry.MultiPolygon(b)},box:function(a){if(a.length!=2)throw"GeoJSON box coordinates must have 2 elements";
return new GeoGlobe.Geometry.Polygon([new GeoGlobe.Geometry.LinearRing([new GeoGlobe.Geometry.Point(a[0][0],a[0][1]),new GeoGlobe.Geometry.Point(a[1][0],a[0][1]),new GeoGlobe.Geometry.Point(a[1][0],a[1][1]),new GeoGlobe.Geometry.Point(a[0][0],a[1][1]),new GeoGlobe.Geometry.Point(a[0][0],a[0][1])])])}},write:function(a,b){var c={type:null};if(GeoGlobe.Util.isArray(a)){c.type="FeatureCollection";var d=a.length;c.features=Array(d);for(var e=0;e<d;++e){var f=a[e];if(!f instanceof GeoGlobe.Feature)throw"FeatureCollection only supports collections of features: "+
f;c.features[e]=this.extract.feature.apply(this,[f])}}else if(a.CLASS_NAME.indexOf("GeoGlobe.Geometry")==0)c=this.extract.geometry.apply(this,[a]);else if(a instanceof GeoGlobe.Feature&&(c=this.extract.feature.apply(this,[a]),a.layer&&a.layer.projection))c.crs=this.createCRSObject(a);return GeoGlobe.Format.JSON.prototype.write.apply(this,[c,b])},createCRSObject:function(a){var a=a.layer.projection.toString(),b={};a.match(/epsg:/i)&&(a=parseInt(a.substring(a.indexOf(":")+1)),b=a==4326?{type:"name",
properties:{name:"urn:ogc:def:crs:OGC:1.3:CRS84"}}:{type:"name",properties:{name:"EPSG:"+a}});return b},extract:{feature:function(a){var b=this.extract.geometry.apply(this,[a.geometry]),b={type:"Feature",properties:a.attributes,geometry:b};if(a.fid!=null)b.id=a.fid;return b},geometry:function(a){if(a==null)return null;this.internalProjection&&this.externalProjection&&(a=a.clone(),a.transform(this.internalProjection,this.externalProjection));var b=a.CLASS_NAME.split(".")[2],a=this.extract[b.toLowerCase()].apply(this,
[a]);return b=="Collection"?{type:"GeometryCollection",geometries:a}:{type:b,coordinates:a}},point:function(a){return[a.x,a.y]},multipoint:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},linestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.point.apply(this,[a.components[c]]));return b},multilinestring:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,
[a.components[c]]));return b},polygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.linestring.apply(this,[a.components[c]]));return b},multipolygon:function(a){for(var b=[],c=0,d=a.components.length;c<d;++c)b.push(this.extract.polygon.apply(this,[a.components[c]]));return b},collection:function(a){for(var b=a.components.length,c=Array(b),d=0;d<b;++d)c[d]=this.extract.geometry.apply(this,[a.components[d]]);return c}},CLASS_NAME:"GeoGlobe.Format.GeoJSON"});
GeoGlobe.Format.VTS=GeoGlobe.Class4OL({initialize:function(a){GeoGlobe.Util.extend(this,a)},getVTSCapabilities:function(a){this.url=a;var b=null;this.getCapabilities(a,function(a){var d=a.responseXML;if(!d||!d.documentElement)d=a.responseText;b=(new GeoGlobe.Format.VTSCapabilities.v1_0_0).read(d)},function(){alert("VTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return b},getCapabilities:function(a,b,c){typeof c!="function"&&(c=function(){alert("VTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});GeoGlobe.Request.GET({url:a,params:{REQUEST:"GetCapabilities",SERVICE:"WMTS"},scope:this,async:!1,success:function(a){typeof b==
"function"&&b(a)},failure:c})},createLayerOption:function(a,b,c){if(!("layer"in c))throw Error("Missing property 'layer' in configuration.");for(var d=b.contents,e,f=0,g=d.layers.length;f<g;++f)if(d.layers[f].identifier===c.layer){e=d.layers[f];break}if(!e)throw Error("Layer not found");f=c.format;!f&&e.formats&&e.formats.length&&(f=e.formats[0]);var h;if(c.matrixSet)h=d.tileMatrixSets[c.matrixSet];else if(c.projection)for(var f=0,j=e.tileMatrixSetLinks.length;f<j;f++){if(d.tileMatrixSets[e.tileMatrixSetLinks[f].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,
"$1:$3")===c.projection){h=d.tileMatrixSets[e.tileMatrixSetLinks[f].tileMatrixSet];break}}else e.tileMatrixSetLinks.length>=1&&(h=d.tileMatrixSets[e.tileMatrixSetLinks[0].tileMatrixSet]);if(!h)throw Error("matrixSet not found");var l=[];c.styleName&&c.styleName!=""?l[0]=c.styleName:this.GetStyleName(function(a){l=a});(f=c.requestEncoding)||(f="KVP");f=[];g=c.params||{};delete c.params;for(var j=0,n=e.dimensions.length;j<n;j++){var o=e.dimensions[j];f.push(o.identifier);g.hasOwnProperty(o.identifier)||
(g[o.identifier]=o["default"])}for(var q=c.projection||h.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),r=c.units||(q==="EPSG:4326"?"degrees":"m"),m=[],p,t,c=[],n=e.tileMatrixSetLinks,g=function(a){m.push(a*2.8E-4/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[r]);if(!p||p>a)p=a;if(!t||t<a)t=a},o=0,j=n.length;o<j;o++)if(f=n[o],f.tileMatrixSet===h.identifier){if(f.tileMatrixSetLimits){for(var j={},o=0,s=h.matrixIds.length;o<s;o++)j[h.matrixIds[o].identifier]=h.matrixIds[o];o=
0;for(s=f.tileMatrixSetLimits.length;o<s;o++)n=j[f.tileMatrixSetLimits[o].tileMatrix],c.push(n),g(n.scaleDenominator)}else{o=0;for(s=h.matrixIds.length;o<s;o++)g(h.matrixIds[o].scaleDenominator)}break}m.sort(function(a,b){return b-a});var u="",v={layers:[],source:{},source_id:"",url:"",url_tmpl:"",layerType:"VTS"},b=this.getParameterString({SERVICE:"WMTS",REQUEST:"GetTile",VERSION:b.version,LAYER:e.identifier,TILEMATRIXSET:h.identifier,FORMAT:"protobuf",TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"});
v.url=a;u=a.endsWith("?")?GeoGlobe.ProxyHost+a+b:GeoGlobe.ProxyHost+a+"?"+b;v.url_tmpl=u;GeoGlobe.Util.randomStr(10);if(e.bounds)var w=[e.bounds._sw.lng,e.bounds._sw.lat,e.bounds._ne.lng,e.bounds._ne.lat];else e.BoundingBox&&(w=e.BoundingBox[0].bounds.toBBOX());var x=d.tileMatrixSets[e.tileMatrixSetLinks[0].tileMatrixSet].matrixIds[0].identifier;this.GetStyle(l[0],function(a){var b={name:e.identifier,sprite:a.sprite?GeoGlobe.ProxyHost+a.sprite:"",glyphs:a.glyphs?GeoGlobe.ProxyHost+a.glyphs:"",styleName:a.styleName,
srs:q,bbox:w,format:e.formats,zoomoffset:x},c="source_vts_"+GeoGlobe.Util.randomStr(6);v.source_id=c;v.source={type:"vector",tiles:[u]};if(a.styleData)for(var d=0;d<a.styleData.layers.length;d++)a.styleData.layers[d].metadata=b,a.styleData.layers[d].source=c,v.layers[d]=a.styleData.layers[d];else for(d=0;d<a.layers.length;d++)a.layers[d].metadata=b,a.layers[d].source=c,v.layers[d]=a.layers[d]},function(){alert("WMTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return v},createLayer:function(a,b){var c=this.getVTSCapabilities(a),b=b?b:{};b.layer=b.layer?b.layer:c.contents.layers[0].identifier;b.styleName=b.styleName?b.styleName:"";return this.createLayerOption(a,c,b)},createLayers:function(a){for(var b=this.getVTSCapabilities(a),c=b.contents.layers,d=[],e=0;e<c.length;e++){var f=this.createLayerOption(a,b,{layer:c[e].identifier});d.push(f)}return d},GetStyleName:function(a,b){var c=this.url,d={REQUEST:"GetStyle",
SERVICE:"WMTS",VERSION:"1.0.0"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.Request.GET({url:c,params:d,scope:this,async:!1,success:function(c){c=c.responseText;if(!c)return b(),!1;var c=(new GeoGlobe.Format.JSON).read(c),d=[];if(c.style)for(var g=0;g<c.style.length;g++)d.push(c.style[g].styleName);else if(c.styleName)for(g=0;g<c.styleName.length;g++)d.push(c.styleName[g]);a(d)},failure:b})},GetStyle:function(a,b,c){var d=this.url;if(a==""||a==void 0)alert("\u8bf7\u67e5\u770b\u6837\u5f0f\u540d\u79f0\u662f\u5426\u5b58\u5728");
else{var e={REQUEST:"GetStyle",SERVICE:"WMTS",VERSION:"1.0.0",STYLENAME:a};c||(c=function(){this.failFn(e.REQUEST)});GeoGlobe.Request.GET({url:d,params:e,scope:this,async:!1,success:function(a){a=a.responseText;if(!a)return c(),!1;a=(new GeoGlobe.Format.JSON).read(a);b(a)},failure:c})}},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];d!=null&&typeof d!="function"&&b.push(c+"="+d)}return b.join("&")},CLASS_NAME:"GeoGlobe.Format.VTS"});
GeoGlobe.Format.WMTS=GeoGlobe.Class4OL({initialize:function(a){GeoGlobe.Util.extend(this,a)},getWMTSCapabilities:function(a){var b=null;this.getCapabilities(a,function(a){var d=a.responseXML;if(!d||!d.documentElement)d=a.responseText;b=(new GeoGlobe.Format.WMTSCapabilities.v1_0_0).read(d)},function(){alert("WMTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return b},getCapabilities:function(a,b,c){typeof c!="function"&&(c=function(){alert("WMTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});GeoGlobe.Request.GET({url:a,params:{REQUEST:"GetCapabilities",SERVICE:"WMTS"},scope:this,async:!1,success:function(a){typeof b==
"function"&&b(a)},failure:c})},createLayerOption:function(a,b,c){if(!("layer"in c))throw Error("Missing property 'layer' in configuration.");for(var d=b.contents,e,f=0,g=d.layers.length;f<g;++f)if(d.layers[f].identifier===c.layer){e=d.layers[f];break}if(!e)throw Error("Layer not found");var h=c.format;!h&&e.formats&&e.formats.length&&(h=e.formats[0]);var j;if(c.matrixSet)j=d.tileMatrixSets[c.matrixSet];else if(c.projection)for(var f=0,l=e.tileMatrixSetLinks.length;f<l;f++){if(d.tileMatrixSets[e.tileMatrixSetLinks[f].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,
"$1:$3")===c.projection){j=d.tileMatrixSets[e.tileMatrixSetLinks[f].tileMatrixSet];break}}else e.tileMatrixSetLinks.length>=1&&(j=d.tileMatrixSets[e.tileMatrixSetLinks[0].tileMatrixSet]);if(!j)throw Error("matrixSet not found");for(var n,f=0,g=e.styles.length;f<g;++f)if(n=e.styles[f],n.isDefault)break;(f=c.requestEncoding)||(f="KVP");f=[];g=c.params||{};delete c.params;for(var o=0,l=e.dimensions.length;o<l;o++){var q=e.dimensions[o];f.push(q.identifier);g.hasOwnProperty(q.identifier)||(g[q.identifier]=
q["default"])}for(var f=c.projection||j.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),r=c.units||(f==="EPSG:4326"?"degrees":"m"),m=[],p,t,c=[],q=e.tileMatrixSetLinks,o=function(a){m.push(a*2.8E-4/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[r]);if(!p||p>a)p=a;if(!t||t<a)t=a},s=0,l=q.length;s<l;s++)if(g=q[s],g.tileMatrixSet===j.identifier){if(g.tileMatrixSetLimits){for(var l={},s=0,u=j.matrixIds.length;s<u;s++)l[j.matrixIds[s].identifier]=j.matrixIds[s];s=0;for(u=g.tileMatrixSetLimits.length;s<
u;s++)q=l[g.tileMatrixSetLimits[s].tileMatrix],c.push(q),o(q.scaleDenominator)}else{s=0;for(u=j.matrixIds.length;s<u;s++)o(j.matrixIds[s].scaleDenominator)}break}m.sort(function(a,b){return b-a});c="";b=this.getParameterString({SERVICE:"WMTS",REQUEST:"GetTile",VERSION:b.version,LAYER:e.identifier,STYLE:n.identifier,TILEMATRIXSET:j.identifier,FORMAT:h,TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"});c=a.endsWith("?")?GeoGlobe.ProxyHost+a+b:GeoGlobe.ProxyHost+a+"?"+b;a=GeoGlobe.Util.randomStr(10);if(e.bounds)var v=
[e.bounds._sw.lng,e.bounds._sw.lat,e.bounds._ne.lng,e.bounds._ne.lat];else e.BoundingBox&&(v=e.BoundingBox[0].bounds.toBBOX());return{id:"layer_"+e.identifier+"_"+a,type:"raster",source:{type:"raster",tiles:[c],tileSize:256},metadata:{name:e.identifier,srs:f,bbox:v,format:e.formats,zoomoffset:d.tileMatrixSets[e.tileMatrixSetLinks[0].tileMatrixSet].matrixIds[0].identifier},paint:{"raster-opacity":1}}},createLayer:function(a,b){var c=this.getWMTSCapabilities(a);return this.createLayerOption(a,c,b?{layer:b.layer}:
{layer:c.contents.layers[0].identifier})},createLayers:function(a){for(var b=this.getWMTSCapabilities(a),c=b.contents.layers,d=[],e=0;e<c.length;e++){var f=this.createLayerOption(a,b,{layer:c[e].identifier});d.push(f)}return d},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];d!=null&&typeof d!="function"&&b.push(c+"="+d)}return b.join("&")},calculationTopTileExtentAndZoomOffset:function(a){var b={},c=null,d=0.0254,e=111E3,f=96,g=[],h=[];if(a.hasOwnProperty("inchConvertMeterRatio"))d=
a.inchConvertMeterRatio;if(a.hasOwnProperty("degreeConvertMeterRatio"))e=a.degreeConvertMeterRatio;if(a.hasOwnProperty("dpi"))f=a.dpi;var j=Math.ceil(Math.log(Math.max(Number(a.matrixWidth),Number(a.matrixHeight)))/Math.LN2),l=Math.pow(2,j);if(a.hasOwnProperty("resolution"))if(a.resolution!=="")c=a.resolution;else{alert("\u8bf7\u8f93\u5165resolution\u503c\uff0c\u6216\u8005\u5c06\u8be5\u5c5e\u6027\u6ce8\u91ca");return}else if(a.hasOwnProperty("units")){if(a.units=="m"&&(c=a.scaleDenominator*d/f),a.units==
"degrees"&&(c=a.scaleDenominator*d/(f*e)),a.units!=="m"&&a.units!=="degrees"){alert("\u8bf7\u786e\u5b9a\u5355\u4f4d\u662fm\u8fd8\u662fdegrees");return}}else c=Math.abs(a.topLeftCorner[0])<=800&&Math.abs(a.topLeftCorner[1])<=800?a.scaleDenominator*d/(f*e):a.scaleDenominator*d/f;g[0]=a.topLeftCorner[0];g[3]=a.topLeftCorner[1];g[1]=g[3]-a.tileSize*c*l;g[2]=g[0]+a.tileSize*c*l;a=j-Number(a.identifier);h[0]=(g[0]+g[2])/2;h[1]=(g[1]+g[3])/2;b.topTileExtent=g;b.zoomOffset=a;b.centerPoint=h;b.proposalZoom=
a-1;return b},CLASS_NAME:"GeoGlobe.Format.WMTS"});
GeoGlobe.Format.WMS=GeoGlobe.Class4OL({initialize:function(a){GeoGlobe.Util.extend(this,a)},getWMSCapabilities:function(a){var b=null;this.getCapabilities(a,function(a){var d=a.responseXML;if(!d||!d.documentElement)d=a.responseText;b=(new GeoGlobe.Format.WMSCapabilities.v1_1_1).read(d)},function(){alert("WMS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+
"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return b},getCapabilities:function(a,b,c){typeof c!="function"&&(c=function(){alert("WMS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});GeoGlobe.Request.GET({url:a,params:{REQUEST:"GetCapabilities",SERVICE:"WMS",VERSION:"1.1.1"},scope:this,
async:!1,success:function(a){typeof b=="function"&&b(a)},failure:c})},createLayerOption:function(a,b,c){if(!("layer"in c))throw Error("Missing property 'layer' in configuration.");for(var b=b.capability,d,e=0,f=b.layers.length;e<f;++e)if(b.layers[e].name===c.layer){d=b.layers[e];break}if(!d)throw Error("Layer not found");b=c.format;if(!b&&d.formats&&d.formats.length){for(e=0;e<d.formats.length;e++)d.formats[e]=="image/png"&&(b=d.formats[e]);b!="image/png"&&(b=d.formats[0])}e=c.styles;if(!e&&d.styles&&
d.styles.length)e=d.styles[0].name;var f=eval(d.srs),g,h;for(h in f)g=h;h="";h=c.transparent;c.isTile?(c=this.getParameterString({SERVICE:"WMS",REQUEST:"GetMap",VERSION:"1.1.1",LAYERS:d.name,styles:e,FORMAT:b,TRANSPARENT:h,BBOX:"{bbox-epsg-3857}",WIDTH:"256",HEIGHT:"256",SRS:g}),h=a.endsWith("?")?a+c:a+"?"+c,h=GeoGlobe.appendToProxy(h),a=GeoGlobe.Util.randomStr(10),d={id:"layer_"+d.name+"_"+a,type:"raster",source:{type:"raster",tiles:[h],tileSize:256},metadata:{name:d.name,srs:g,bbox:d.bbox,format:b},
paint:{"raster-opacity":1}}):d=new GeoGlobe.Layer.WMS({url:a,layer:d.name,format:b,version:"1.1.1",SRS:g,styles:e,bbox:d.bbox,isTile:!1});return d},createLayer:function(a,b,c){this.url=a;var b=b?b:{},c=c===void 0||c?!0:!1,d=b&&b.transparent===void 0||b.transparent?!0:!1,e=this.getWMSCapabilities(a);return this.createLayerOption(a,e,{layer:b&&b.layer?b.layer:e.capability.layers[0].name,transparent:d,isTile:c})},createLayers:function(a,b,c){for(var b=b?b:{},c=c===void 0||c?!0:!1,b=b&&b.transparent===
void 0||b.transparent?!0:!1,d=this.getWMSCapabilities(a),e=d.capability.layers,f=[],g=0;g<e.length;g++){var h=this.createLayerOption(a,d,{layer:e[g].name,transparent:b,isTile:c});f.push(h)}return f},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];d!=null&&typeof d!="function"&&b.push(c+"="+d)}return b.join("&")},CLASS_NAME:"GeoGlobe.Format.WMS"});GeoGlobe.Format.WMSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.1.1",profile:null,CLASS_NAME:"GeoGlobe.Format.WMSCapabilities"});
GeoGlobe.Format.WMSCapabilities.v1=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{wms:"http://www.opengis.net/wms",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"wms",read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));var b=a;if(a&&a.nodeType==9)a=a.documentElement;var c={};this.readNode(a,c);if(c.service===void 0)a=new GeoGlobe.Format.OGCExceptionReport,c.error=a.read(b);return c},readers:{wms:{Service:function(a,
b){b.service={};this.readChildNodes(a,b.service)},Name:function(a,b){b.name=this.getChildValue(a)},Title:function(a,b){b.title=this.getChildValue(a)},Abstract:function(a,b){b["abstract"]=this.getChildValue(a)},BoundingBox:function(a){var b={};b.bbox=[parseFloat(a.getAttribute("minx")),parseFloat(a.getAttribute("miny")),parseFloat(a.getAttribute("maxx")),parseFloat(a.getAttribute("maxy"))];a={x:parseFloat(a.getAttribute("resx")),y:parseFloat(a.getAttribute("resy"))};if(!isNaN(a.x)||!isNaN(a.y))b.res=
a;return b},OnlineResource:function(a,b){b.href=this.getAttributeNS(a,this.namespaces.xlink,"href")},ContactInformation:function(a,b){b.contactInformation={};this.readChildNodes(a,b.contactInformation)},ContactPersonPrimary:function(a,b){b.personPrimary={};this.readChildNodes(a,b.personPrimary)},ContactPerson:function(a,b){b.person=this.getChildValue(a)},ContactOrganization:function(a,b){b.organization=this.getChildValue(a)},ContactPosition:function(a,b){b.position=this.getChildValue(a)},ContactAddress:function(a,
b){b.contactAddress={};this.readChildNodes(a,b.contactAddress)},AddressType:function(a,b){b.type=this.getChildValue(a)},Address:function(a,b){b.address=this.getChildValue(a)},City:function(a,b){b.city=this.getChildValue(a)},StateOrProvince:function(a,b){b.stateOrProvince=this.getChildValue(a)},PostCode:function(a,b){b.postcode=this.getChildValue(a)},Country:function(a,b){b.country=this.getChildValue(a)},ContactVoiceTelephone:function(a,b){b.phone=this.getChildValue(a)},ContactFacsimileTelephone:function(a,
b){b.fax=this.getChildValue(a)},ContactElectronicMailAddress:function(a,b){b.email=this.getChildValue(a)},Fees:function(a,b){var c=this.getChildValue(a);if(c&&c.toLowerCase()!="none")b.fees=c},AccessConstraints:function(a,b){var c=this.getChildValue(a);if(c&&c.toLowerCase()!="none")b.accessConstraints=c},Capability:function(a,b){b.capability={nestedLayers:[],layers:[]};this.readChildNodes(a,b.capability)},Request:function(a,b){b.request={};this.readChildNodes(a,b.request)},GetCapabilities:function(a,
b){b.getcapabilities={formats:[]};this.readChildNodes(a,b.getcapabilities)},Format:function(a,b){GeoGlobe.Util.isArray(b.formats)?b.formats.push(this.getChildValue(a)):b.format=this.getChildValue(a)},DCPType:function(a,b){this.readChildNodes(a,b)},HTTP:function(a,b){this.readChildNodes(a,b)},Get:function(a,b){b.get={};this.readChildNodes(a,b.get);if(!b.href)b.href=b.get.href},Post:function(a,b){b.post={};this.readChildNodes(a,b.post);if(!b.href)b.href=b.get.href},GetMap:function(a,b){b.getmap={formats:[]};
this.readChildNodes(a,b.getmap)},GetFeatureInfo:function(a,b){b.getfeatureinfo={formats:[]};this.readChildNodes(a,b.getfeatureinfo)},Exception:function(a,b){b.exception={formats:[]};this.readChildNodes(a,b.exception)},Layer:function(a,b){var c,d;b.capability?(d=b.capability,c=b):d=b;var e=a.getAttributeNode("queryable"),f=e&&e.specified?a.getAttribute("queryable"):null,g=(e=a.getAttributeNode("cascaded"))&&e.specified?a.getAttribute("cascaded"):null,e=(e=a.getAttributeNode("opaque"))&&e.specified?
a.getAttribute("opaque"):null,h=a.getAttribute("noSubsets"),j=a.getAttribute("fixedWidth"),l=a.getAttribute("fixedHeight"),n=c||{},o=GeoGlobe.Util.extend;c={nestedLayers:[],styles:c?[].concat(c.styles):[],srs:c?o({},n.srs):{},metadataURLs:[],bbox:c?o({},n.bbox):{},llbbox:n.llbbox,dimensions:c?o({},n.dimensions):{},authorityURLs:c?o({},n.authorityURLs):{},identifiers:{},keywords:[],queryable:f&&f!==""?f==="1"||f==="true":n.queryable||!1,cascaded:g!==null?parseInt(g):n.cascaded||0,opaque:e?e==="1"||
e==="true":n.opaque||!1,noSubsets:h!==null?h==="1"||h==="true":n.noSubsets||!1,fixedWidth:j!=null?parseInt(j):n.fixedWidth||0,fixedHeight:l!=null?parseInt(l):n.fixedHeight||0,minScale:n.minScale,maxScale:n.maxScale,attribution:n.attribution};b.nestedLayers.push(c);c.capability=d;this.readChildNodes(a,c);delete c.capability;if(c.name){f=c.name.split(":");g=d.request;e=g.getfeatureinfo;if(f.length>0)c.prefix=f[0];d.layers.push(c);if(c.formats===void 0)c.formats=g.getmap.formats;if(c.infoFormats===void 0&&
e)c.infoFormats=e.formats}},Attribution:function(a,b){b.attribution={};this.readChildNodes(a,b.attribution)},LogoURL:function(a,b){b.logo={width:a.getAttribute("width"),height:a.getAttribute("height")};this.readChildNodes(a,b.logo)},Style:function(a,b){var c={};b.styles.push(c);this.readChildNodes(a,c)},LegendURL:function(a,b){var c={width:a.getAttribute("width"),height:a.getAttribute("height")};b.legend=c;this.readChildNodes(a,c)},MetadataURL:function(a,b){var c={type:a.getAttribute("type")};b.metadataURLs.push(c);
this.readChildNodes(a,c)},DataURL:function(a,b){b.dataURL={};this.readChildNodes(a,b.dataURL)},FeatureListURL:function(a,b){b.featureListURL={};this.readChildNodes(a,b.featureListURL)},AuthorityURL:function(a,b){var c=a.getAttribute("name"),d={};this.readChildNodes(a,d);b.authorityURLs[c]=d.href},Identifier:function(a,b){var c=a.getAttribute("authority");b.identifiers[c]=this.getChildValue(a)},KeywordList:function(a,b){this.readChildNodes(a,b)},SRS:function(a,b){b.srs[this.getChildValue(a)]=!0}}},
CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1"});
GeoGlobe.Format.WMSCapabilities.v1_1=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1,{readers:{wms:GeoGlobe.Util.applyDefaults({WMT_MS_Capabilities:function(a,b){this.readChildNodes(a,b)},Keyword:function(a,b){b.keywords&&b.keywords.push(this.getChildValue(a))},DescribeLayer:function(a,b){b.describelayer={formats:[]};this.readChildNodes(a,b.describelayer)},GetLegendGraphic:function(a,b){b.getlegendgraphic={formats:[]};this.readChildNodes(a,b.getlegendgraphic)},GetStyles:function(a,b){b.getstyles=
{formats:[]};this.readChildNodes(a,b.getstyles)},PutStyles:function(a,b){b.putstyles={formats:[]};this.readChildNodes(a,b.putstyles)},UserDefinedSymbolization:function(a,b){var c={supportSLD:parseInt(a.getAttribute("SupportSLD"))==1,userLayer:parseInt(a.getAttribute("UserLayer"))==1,userStyle:parseInt(a.getAttribute("UserStyle"))==1,remoteWFS:parseInt(a.getAttribute("RemoteWFS"))==1};b.userSymbols=c},LatLonBoundingBox:function(a,b){b.llbbox=[parseFloat(a.getAttribute("minx")),parseFloat(a.getAttribute("miny")),
parseFloat(a.getAttribute("maxx")),parseFloat(a.getAttribute("maxy"))]},BoundingBox:function(a,b){var c=GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,[a,b]);c.srs=a.getAttribute("SRS");b.bbox[c.srs]=c},ScaleHint:function(a,b){var c=a.getAttribute("min"),d=a.getAttribute("max"),e=Math.pow(2,0.5),f=GeoGlobe.INCHES_PER_UNIT.m;if(c!=0)b.maxScale=parseFloat((c/e*f*GeoGlobe.DOTS_PER_INCH).toPrecision(13));if(d!=Number.POSITIVE_INFINITY)b.minScale=parseFloat((d/e*f*GeoGlobe.DOTS_PER_INCH).toPrecision(13))},
Dimension:function(a,b){var c={name:a.getAttribute("name").toLowerCase(),units:a.getAttribute("units"),unitsymbol:a.getAttribute("unitSymbol")};b.dimensions[c.name]=c},Extent:function(a,b){var c=a.getAttribute("name").toLowerCase();if(c in b.dimensions){c=b.dimensions[c];c.nearestVal=a.getAttribute("nearestValue")==="1";c.multipleVal=a.getAttribute("multipleValues")==="1";c.current=a.getAttribute("current")==="1";c["default"]=a.getAttribute("default")||"";var d=this.getChildValue(a);c.values=d.split(",")}}},
GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1"});GeoGlobe.Format.WMSCapabilities.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_1,{version:"1.1.0",readers:{wms:GeoGlobe.Util.applyDefaults({SRS:function(a,b){for(var c=this.getChildValue(a).split(/ +/),d=0,e=c.length;d<e;d++)b.srs[c[d]]=!0}},GeoGlobe.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1_0"});
GeoGlobe.Format.WMSCapabilities.v1_1_1=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_1,{version:"1.1.1",readers:{wms:GeoGlobe.Util.applyDefaults({SRS:function(a,b){b.srs[this.getChildValue(a)]=!0}},GeoGlobe.Format.WMSCapabilities.v1_1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1_1"});
GeoGlobe.Format.WMSCapabilities.v1_1_1_WMSC=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_1_1,{version:"1.1.1",profile:"WMSC",readers:{wms:GeoGlobe.Util.applyDefaults({VendorSpecificCapabilities:function(a,b){b.vendorSpecific={tileSets:[]};this.readChildNodes(a,b.vendorSpecific)},TileSet:function(a,b){var c={srs:{},bbox:{},resolutions:[]};this.readChildNodes(a,c);b.tileSets.push(c)},Resolutions:function(a,b){for(var c=this.getChildValue(a).split(" "),d=0,e=c.length;d<e;d++)c[d]!=""&&b.resolutions.push(parseFloat(c[d]))},
Width:function(a,b){b.width=parseInt(this.getChildValue(a))},Height:function(a,b){b.height=parseInt(this.getChildValue(a))},Layers:function(a,b){b.layers=this.getChildValue(a)},Styles:function(a,b){b.styles=this.getChildValue(a)}},GeoGlobe.Format.WMSCapabilities.v1_1_1.prototype.readers.wms)},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_1_1_WMSC"});
GeoGlobe.Format.WMSCapabilities.v1_3=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1,{readers:{wms:GeoGlobe.Util.applyDefaults({WMS_Capabilities:function(a,b){this.readChildNodes(a,b)},LayerLimit:function(a,b){b.layerLimit=parseInt(this.getChildValue(a))},MaxWidth:function(a,b){b.maxWidth=parseInt(this.getChildValue(a))},MaxHeight:function(a,b){b.maxHeight=parseInt(this.getChildValue(a))},BoundingBox:function(a,b){var c=GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,
[a,b]);c.srs=a.getAttribute("CRS");b.bbox[c.srs]=c},CRS:function(a,b){this.readers.wms.SRS.apply(this,[a,b])},EX_GeographicBoundingBox:function(a,b){b.llbbox=[];this.readChildNodes(a,b.llbbox)},westBoundLongitude:function(a,b){b[0]=this.getChildValue(a)},eastBoundLongitude:function(a,b){b[2]=this.getChildValue(a)},southBoundLatitude:function(a,b){b[1]=this.getChildValue(a)},northBoundLatitude:function(a,b){b[3]=this.getChildValue(a)},MinScaleDenominator:function(a,b){b.maxScale=parseFloat(this.getChildValue(a)).toPrecision(16)},
MaxScaleDenominator:function(a,b){b.minScale=parseFloat(this.getChildValue(a)).toPrecision(16)},Dimension:function(a,b){var c={name:a.getAttribute("name").toLowerCase(),units:a.getAttribute("units"),unitsymbol:a.getAttribute("unitSymbol"),nearestVal:a.getAttribute("nearestValue")==="1",multipleVal:a.getAttribute("multipleValues")==="1","default":a.getAttribute("default")||"",current:a.getAttribute("current")==="1",values:this.getChildValue(a).split(",")};b.dimensions[c.name]=c},Keyword:function(a,
b){var c={value:this.getChildValue(a),vocabulary:a.getAttribute("vocabulary")};b.keywords&&b.keywords.push(c)}},GeoGlobe.Format.WMSCapabilities.v1.prototype.readers.wms),sld:{UserDefinedSymbolization:function(a,b){this.readers.wms.UserDefinedSymbolization.apply(this,[a,b]);b.userSymbols.inlineFeature=parseInt(a.getAttribute("InlineFeature"))==1;b.userSymbols.remoteWCS=parseInt(a.getAttribute("RemoteWCS"))==1},DescribeLayer:function(a,b){this.readers.wms.DescribeLayer.apply(this,[a,b])},GetLegendGraphic:function(a,
b){this.readers.wms.GetLegendGraphic.apply(this,[a,b])}}},CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_3"});GeoGlobe.Format.WMSCapabilities.v1_3_0=GeoGlobe.Class4OL(GeoGlobe.Format.WMSCapabilities.v1_3,{version:"1.3.0",CLASS_NAME:"GeoGlobe.Format.WMSCapabilities.v1_3_0"});
GeoGlobe.Format.WMSUtil=GeoGlobe.Class4OL({initialize:function(a){GeoGlobe.Util.extend(this,a)},getWMSCapabilities:function(a,b){var c=!0,d=null;this.getCapabilities(a,b,GeoGlobe.Function.bind(function(b){var f=b.responseXML;if(!f||!f.documentElement)f=b.responseText;f==null||f==""?(this.failFn(a),c=!1):d=(new GeoGlobe.Format.WMSCapabilities).read(f)},this),function(){alert("WMS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});if(c)return d},createLayer:function(a,b){var c=!0,d=null;this.getCapabilities(a,b,GeoGlobe.Function.bind(function(e){var f=e.responseXML;if(!f||!f.documentElement)f=e.responseText;f==null||f==""?(this.failFn(a),c=!1):(e=(new GeoGlobe.Format.WMSCapabilities).read(f),d=this._createLayer(a,e,b,"2D"))},this),function(){alert("WMS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});if(c)return d},failFn:function(a){alert("WMS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")},getCapabilities:function(a,b,c,d){var e={REQUEST:"GetCapabilities",SERVICE:"WMS",VERSION:b&&b.version?b.version:"1.1.1"};typeof d!="function"&&(d=
function(){alert("WMS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+"\n\u7248\u672c\u53f7\uff1a"+e[VERSION]+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});GeoGlobe.Request.GET({url:a,params:e,scope:this,async:!1,success:function(a){typeof c=="function"&&c(a)},failure:d})},_createLayer:function(a,b,c){c||(c={});var d=b.capability,e;e=d.layers[0];
for(var f=0,g=d.layers.length;f<g;++f)if(d.layers[f].name===c.layer){e=d.layers[f];break}if(!e)throw Error("Layer not found");d=c.format;!d&&e.formats&&e.formats.length>0&&(d=e.formats[0]);f=c.transparent;if(!f||f=="")f=!0;var h;if(e.name)h=e.name;g=c.version;if(!g&&b.version)g=b.version;b=c.srs;if(!b&&e.srs)for(var j in e.srs)b=j;b=="EPSG:-9999"&&(b="EPSG:4326");e=GeoGlobe.LngLatBounds.fromArray(e.llbbox);j="SERVICE=WMS&REQUEST=GetMap&VERSION="+g+"&LAYERS="+h+"&styles=default&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256&SRS="+
b+"&FORMAT="+d+"&TRANSPARENT="+f;wmts_url=a.endsWith("?")?a+j:a+"?"+j;return{url:wmts_url,version:g,name:h,projection:b,format:d,bounds:e,transparent:f}},CLASS_NAME:"GeoGlobe.Format.WMSUtil"});
GeoGlobe.Format.VTSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(a,b){if(!("layer"in b))throw Error("Missing property 'layer' in configuration.");for(var c=a.contents,d,e=0,f=c.layers.length;e<f;++e)if(c.layers[e].identifier===b.layer){d=c.layers[e];break}if(!d)throw Error("Layer not found");var g=b.format;!g&&d.formats&&d.formats.length&&(g=d.formats[0]);var h;if(b.matrixSet)h=c.tileMatrixSets[b.matrixSet];
else if(b.projection)for(var e=0,j=d.tileMatrixSetLinks.length;e<j;e++){if(c.tileMatrixSets[d.tileMatrixSetLinks[e].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3")===b.projection){h=c.tileMatrixSets[d.tileMatrixSetLinks[e].tileMatrixSet];break}}else d.tileMatrixSetLinks.length>=1&&(h=c.tileMatrixSets[d.tileMatrixSetLinks[0].tileMatrixSet]);if(!h)throw Error("matrixSet not found");for(var l,e=0,f=d.styles.length;e<f;++e)if(l=d.styles[e],l.isDefault)break;(c=b.requestEncoding)||
(c="KVP");var n=[],e=b.params||{};delete b.params;f=0;for(j=d.dimensions.length;f<j;f++){var o=d.dimensions[f];n.push(o.identifier);e.hasOwnProperty(o.identifier)||(e[o.identifier]=o["default"])}for(var n=b.projection||h.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),q=b.units||(n==="EPSG:4326"?"degrees":"m"),r=[],m,p,n=[],o=d.tileMatrixSetLinks,f=function(a){r.push(a*2.8E-4/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[q]);if(!m||m>a)m=a;if(!p||p<a)p=a},t=0,j=o.length;t<j;t++)if(e=
o[t],e.tileMatrixSet===h.identifier){if(e.tileMatrixSetLimits){for(var j={},t=0,s=h.matrixIds.length;t<s;t++)j[h.matrixIds[t].identifier]=h.matrixIds[t];t=0;for(s=e.tileMatrixSetLimits.length;t<s;t++)o=j[e.tileMatrixSetLimits[t].tileMatrix],n.push(o),f(o.scaleDenominator)}else{t=0;for(s=h.matrixIds.length;t<s;t++)f(h.matrixIds[t].scaleDenominator)}break}if(c==="REST"&&d.resourceUrls){n=[];e=0;for(f=d.resourceUrls.length;e<f;++e)c=d.resourceUrls[e],c.format===g&&c.resourceType==="tile"&&n.push(c.template)}else{j=
a.operationsMetadata.GetTile.dcp.http.get;n=[];e=0;for(f=j.length;e<f;e++)o=j[e].constraints,(!o||o&&o.GetEncoding.allowedValues[c])&&n.push(j[e].url)}r.sort(function(a,b){return b-a});c="";g="SERVICE=WMTS&REQUEST=GetTile&VERSION="+a.version+"&LAYER="+d.identifier+"&STYLE="+l.identifier+"&TILEMATRIXSET="+h.identifier+"&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT="+g;c=n[0].endsWith("?")?n[0]+g:n[0]+"?"+g;g=GeoGlobe.Util.applyDefaults(b,{id:d.identifier,url:[c]});g=new GeoGlobe.Layer.VTS(g);g.matrixSet=
h;g.identifier=d.identifier;g.bounds=d.bounds;return g},CLASS_NAME:"GeoGlobe.Format.VTSCapabilities"});
GeoGlobe.Format.VTSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a]);this.options=a;a=GeoGlobe.Util.extend({},GeoGlobe.Format.VTSCapabilities.prototype.yx);this.yx=GeoGlobe.Util.extend(a,this.yx)},read:function(a){typeof a=="string"&&
(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var b={};this.readNode(a,b);b.version=this.version;return b},readers:{wmts:{Capabilities:function(a,b){this.readChildNodes(a,b)},Contents:function(a,b){b.contents={};b.contents.layers=[];b.contents.tileMatrixSets={};this.readChildNodes(a,b.contents)},Layer:function(a,b){var c={styles:[],formats:[],dimensions:[],tileMatrixSetLinks:[]};this.readChildNodes(a,c);b.layers.push(c)},Style:function(a,b){var c={};
c.isDefault=a.getAttribute("isDefault")==="true";this.readChildNodes(a,c);b.styles.push(c)},Format:function(a,b){b.formats.push(this.getChildValue(a))},TileMatrixSetLink:function(a,b){var c={};this.readChildNodes(a,c);b.tileMatrixSetLinks.push(c)},TileMatrixSet:function(a,b){if(b.layers){var c={matrixIds:[]};this.readChildNodes(a,c);b.tileMatrixSets[c.identifier]=c}else b.tileMatrixSet=this.getChildValue(a)},TileMatrixSetLimits:function(a,b){b.tileMatrixSetLimits=[];this.readChildNodes(a,b)},TileMatrixLimits:function(a,
b){var c={};this.readChildNodes(a,c);b.tileMatrixSetLimits.push(c)},MinTileRow:function(a,b){b.minTileRow=parseInt(this.getChildValue(a))},MaxTileRow:function(a,b){b.maxTileRow=parseInt(this.getChildValue(a))},MinTileCol:function(a,b){b.minTileCol=parseInt(this.getChildValue(a))},MaxTileCol:function(a,b){b.maxTileCol=parseInt(this.getChildValue(a))},TileMatrix:function(a,b){if(b.identifier){var c={supportedCRS:b.supportedCRS};this.readChildNodes(a,c);b.matrixIds.push(c)}else b.tileMatrix=this.getChildValue(a)},
ScaleDenominator:function(a,b){b.scaleDenominator=parseFloat(this.getChildValue(a))},TopLeftCorner:function(a,b){var c=this.getChildValue(a).split(" "),d;b.supportedCRS&&(d=!!this.yx[b.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2")]);b.topLeftCorner=d?new GeoGlobe.LngLat(c[1],c[0]):new GeoGlobe.LngLat(c[0],c[1])},TileWidth:function(a,b){b.tileWidth=parseInt(this.getChildValue(a))},TileHeight:function(a,b){b.tileHeight=parseInt(this.getChildValue(a))},MatrixWidth:function(a,
b){b.matrixWidth=parseInt(this.getChildValue(a))},MatrixHeight:function(a,b){b.matrixHeight=parseInt(this.getChildValue(a))},ResourceURL:function(a,b){b.resourceUrl=b.resourceUrl||{};var c=a.getAttribute("resourceType");if(!b.resourceUrls)b.resourceUrls=[];c=b.resourceUrl[c]={format:a.getAttribute("format"),template:a.getAttribute("template"),resourceType:c};b.resourceUrls.push(c)},LegendURL:function(a,b){b.legends=b.legends||[];var c={format:a.getAttribute("format"),href:a.getAttribute("xlink:href")},
d=a.getAttribute("width"),e=a.getAttribute("height"),f=a.getAttribute("minScaleDenominator"),g=a.getAttribute("maxScaleDenominator");if(d!==null)c.width=parseInt(d);if(e!==null)c.height=parseInt(e);if(f!==null)c.minScaleDenominator=parseInt(f);if(g!==null)c.maxScaleDenominator=parseInt(g);b.legends.push(c)},InfoFormat:function(a,b){b.infoFormats=b.infoFormats||[];b.infoFormats.push(this.getChildValue(a))},WSDL:function(a,b){b.wsdl={};b.wsdl.href=a.getAttribute("xlink:href")},ServiceMetadataURL:function(a,
b){b.serviceMetadataUrl={};b.serviceMetadataUrl.href=a.getAttribute("xlink:href")},Dimension:function(a,b){var c={values:[]};this.readChildNodes(a,c);b.dimensions.push(c)},Default:function(a,b){b["default"]=this.getChildValue(a)},Value:function(a,b){b.values.push(this.getChildValue(a))}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.VTSCapabilities.v1_0_0"});
GeoGlobe.Format.WMTSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(a,b){if(!("layer"in b))throw Error("Missing property 'layer' in configuration.");for(var c=a.contents,d,e=0,f=c.layers.length;e<f;++e)if(c.layers[e].identifier===b.layer){d=c.layers[e];break}if(!d)throw Error("Layer not found");var g=b.format;!g&&d.formats&&d.formats.length&&(g=d.formats[0]);var h;if(b.matrixSet)h=c.tileMatrixSets[b.matrixSet];
else if(b.projection)for(var e=0,j=d.tileMatrixSetLinks.length;e<j;e++){if(c.tileMatrixSets[d.tileMatrixSetLinks[e].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3")===b.projection){h=c.tileMatrixSets[d.tileMatrixSetLinks[e].tileMatrixSet];break}}else d.tileMatrixSetLinks.length>=1&&(h=c.tileMatrixSets[d.tileMatrixSetLinks[0].tileMatrixSet]);if(!h)throw Error("matrixSet not found");for(var l,e=0,f=d.styles.length;e<f;++e)if(l=d.styles[e],l.isDefault)break;(c=b.requestEncoding)||
(c="KVP");var n=[],e=b.params||{};delete b.params;f=0;for(j=d.dimensions.length;f<j;f++){var o=d.dimensions[f];n.push(o.identifier);e.hasOwnProperty(o.identifier)||(e[o.identifier]=o["default"])}for(var n=b.projection||h.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),q=b.units||(n==="EPSG:4326"?"degrees":"m"),r=[],m,p,n=[],o=d.tileMatrixSetLinks,f=function(a){r.push(a*2.8E-4/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[q]);if(!m||m>a)m=a;if(!p||p<a)p=a},t=0,j=o.length;t<j;t++)if(e=
o[t],e.tileMatrixSet===h.identifier){if(e.tileMatrixSetLimits){for(var j={},t=0,s=h.matrixIds.length;t<s;t++)j[h.matrixIds[t].identifier]=h.matrixIds[t];t=0;for(s=e.tileMatrixSetLimits.length;t<s;t++)o=j[e.tileMatrixSetLimits[t].tileMatrix],n.push(o),f(o.scaleDenominator)}else{t=0;for(s=h.matrixIds.length;t<s;t++)f(h.matrixIds[t].scaleDenominator)}break}if(c==="REST"&&d.resourceUrls){n=[];e=0;for(f=d.resourceUrls.length;e<f;++e)c=d.resourceUrls[e],c.format===g&&c.resourceType==="tile"&&n.push(c.template)}else{j=
a.operationsMetadata.GetTile.dcp.http.get;n=[];e=0;for(f=j.length;e<f;e++)o=j[e].constraints,(!o||o&&o.GetEncoding.allowedValues[c])&&n.push(j[e].url)}r.sort(function(a,b){return b-a});c="";g="SERVICE=WMTS&REQUEST=GetTile&VERSION="+a.version+"&LAYER="+d.identifier+"&STYLE="+l.identifier+"&TILEMATRIXSET="+h.identifier+"&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT="+g;c=n[0].endsWith("?")?n[0]+g:n[0]+"?"+g;g=GeoGlobe.Util.applyDefaults(b,{id:d.identifier,url:[c]});g={id:g.id,layer:{id:g.id,type:"raster",
source:g.id},source:{type:"raster",tiles:g.url,tileSize:256}};g.matrixSet=h;g.identifier=d.identifier;g.bounds=d.bounds;return g},CLASS_NAME:"GeoGlobe.Format.WMTSCapabilities"});
GeoGlobe.Format.WMTSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a]);this.options=a;a=GeoGlobe.Util.extend({},GeoGlobe.Format.WMTSCapabilities.prototype.yx);this.yx=GeoGlobe.Util.extend(a,this.yx)},read:function(a){typeof a=="string"&&
(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var b={};this.readNode(a,b);b.version=this.version;return b},readers:{wmts:{Capabilities:function(a,b){this.readChildNodes(a,b)},Contents:function(a,b){b.contents={};b.contents.layers=[];b.contents.tileMatrixSets={};this.readChildNodes(a,b.contents)},Layer:function(a,b){var c={styles:[],formats:[],dimensions:[],tileMatrixSetLinks:[]};this.readChildNodes(a,c);b.layers.push(c)},Style:function(a,b){var c={};
c.isDefault=a.getAttribute("isDefault")==="true";this.readChildNodes(a,c);b.styles.push(c)},Format:function(a,b){b.formats.push(this.getChildValue(a))},TileMatrixSetLink:function(a,b){var c={};this.readChildNodes(a,c);b.tileMatrixSetLinks.push(c)},TileMatrixSet:function(a,b){if(b.layers){var c={matrixIds:[]};this.readChildNodes(a,c);b.tileMatrixSets[c.identifier]=c}else b.tileMatrixSet=this.getChildValue(a)},TileMatrixSetLimits:function(a,b){b.tileMatrixSetLimits=[];this.readChildNodes(a,b)},TileMatrixLimits:function(a,
b){var c={};this.readChildNodes(a,c);b.tileMatrixSetLimits.push(c)},MinTileRow:function(a,b){b.minTileRow=parseInt(this.getChildValue(a))},MaxTileRow:function(a,b){b.maxTileRow=parseInt(this.getChildValue(a))},MinTileCol:function(a,b){b.minTileCol=parseInt(this.getChildValue(a))},MaxTileCol:function(a,b){b.maxTileCol=parseInt(this.getChildValue(a))},TileMatrix:function(a,b){if(b.identifier){var c={supportedCRS:b.supportedCRS};this.readChildNodes(a,c);b.matrixIds.push(c)}else b.tileMatrix=this.getChildValue(a)},
ScaleDenominator:function(a,b){b.scaleDenominator=parseFloat(this.getChildValue(a))},TopLeftCorner:function(a,b){var c=this.getChildValue(a).split(" "),d;b.supportedCRS&&(d=!!this.yx[b.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2")]);b.topLeftCorner=d?new GeoGlobe.LngLat(c[1],c[0]):new GeoGlobe.LngLat(c[0],c[1])},TileWidth:function(a,b){b.tileWidth=parseInt(this.getChildValue(a))},TileHeight:function(a,b){b.tileHeight=parseInt(this.getChildValue(a))},MatrixWidth:function(a,
b){b.matrixWidth=parseInt(this.getChildValue(a))},MatrixHeight:function(a,b){b.matrixHeight=parseInt(this.getChildValue(a))},ResourceURL:function(a,b){b.resourceUrl=b.resourceUrl||{};var c=a.getAttribute("resourceType");if(!b.resourceUrls)b.resourceUrls=[];c=b.resourceUrl[c]={format:a.getAttribute("format"),template:a.getAttribute("template"),resourceType:c};b.resourceUrls.push(c)},LegendURL:function(a,b){b.legends=b.legends||[];var c={format:a.getAttribute("format"),href:a.getAttribute("xlink:href")},
d=a.getAttribute("width"),e=a.getAttribute("height"),f=a.getAttribute("minScaleDenominator"),g=a.getAttribute("maxScaleDenominator");if(d!==null)c.width=parseInt(d);if(e!==null)c.height=parseInt(e);if(f!==null)c.minScaleDenominator=parseInt(f);if(g!==null)c.maxScaleDenominator=parseInt(g);b.legends.push(c)},InfoFormat:function(a,b){b.infoFormats=b.infoFormats||[];b.infoFormats.push(this.getChildValue(a))},WSDL:function(a,b){b.wsdl={};b.wsdl.href=a.getAttribute("xlink:href")},ServiceMetadataURL:function(a,
b){b.serviceMetadataUrl={};b.serviceMetadataUrl.href=a.getAttribute("xlink:href")},Dimension:function(a,b){var c={values:[]};this.readChildNodes(a,c);b.dimensions.push(c)},Default:function(a,b){b["default"]=this.getChildValue(a)},Value:function(a,b){b.values.push(this.getChildValue(a))}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WMTSCapabilities.v1_0_0"});
GeoGlobe.Format.WMTSUtil=GeoGlobe.Class4OL({initialize:function(a){GeoGlobe.Util.extend(this,a)},getWMTSCapabilities:function(a){var b=null;this.getCapabilities(a,function(a){var d=a.responseXML;if(!d||!d.documentElement)d=a.responseText;b=(new GeoGlobe.Format.WMTSCapabilities.v1_0_0).read(d)},function(){alert("WMTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return b},getCapabilities:function(a,b,c){typeof c!="function"&&(c=function(){alert("WMTS\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+a+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});GeoGlobe.Request.GET({url:a,params:{REQUEST:"GetCapabilities",SERVICE:"WMTS"},scope:this,async:!1,success:function(a){typeof b==
"function"&&b(a)},failure:c})},createLayerOption:function(a,b,c){if(!("layer"in c))throw Error("Missing property 'layer' in configuration.");for(var d=b.contents,e,f=0,g=d.layers.length;f<g;++f)if(d.layers[f].identifier===c.layer){e=d.layers[f];break}if(!e)throw Error("Layer not found");var h=c.format;!h&&e.formats&&e.formats.length&&(h=e.formats[0]);var j;if(c.matrixSet)j=d.tileMatrixSets[c.matrixSet];else if(c.projection){f=0;for(g=e.tileMatrixSetLinks.length;f<g;f++)if(d.tileMatrixSets[e.tileMatrixSetLinks[f].tileMatrixSet].supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,
"$1:$3")===c.projection){j=d.tileMatrixSets[e.tileMatrixSetLinks[f].tileMatrixSet];break}}else e.tileMatrixSetLinks.length>=1&&(j=d.tileMatrixSets[e.tileMatrixSetLinks[0].tileMatrixSet]);if(!j)throw Error("matrixSet not found");for(var l,f=0,g=e.styles.length;f<g;++f)if(l=e.styles[f],l.isDefault)break;(d=c.requestEncoding)||(d="KVP");d=[];f=c.params||{};delete c.params;for(var g=0,n=e.dimensions.length;g<n;g++){var o=e.dimensions[g];d.push(o.identifier);f.hasOwnProperty(o.identifier)||(f[o.identifier]=
o["default"])}for(var d=c.projection||j.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),q=c.units||(d==="EPSG:4326"?"degrees":"m"),r=[],m,p,c=[],n=e.tileMatrixSetLinks,f=function(a){r.push(a*2.8E-4/GeoGlobe.METERS_PER_INCH/GeoGlobe.INCHES_PER_UNIT[q]);if(!m||m>a)m=a;if(!p||p<a)p=a},o=0,g=n.length;o<g;o++)if(d=n[o],d.tileMatrixSet===j.identifier){if(d.tileMatrixSetLimits){for(var g={},o=0,t=j.matrixIds.length;o<t;o++)g[j.matrixIds[o].identifier]=j.matrixIds[o];o=0;for(t=d.tileMatrixSetLimits.length;o<
t;o++)n=g[d.tileMatrixSetLimits[o].tileMatrix],c.push(n),f(n.scaleDenominator)}else{o=0;for(t=j.matrixIds.length;o<t;o++)f(j.matrixIds[o].scaleDenominator)}break}r.sort(function(a,b){return b-a});c="";b=this.getParameterString({SERVICE:"WMTS",REQUEST:"GetTile",VERSION:b.version,LAYER:e.identifier,STYLE:l.identifier,TILEMATRIXSET:j.identifier,FORMAT:h,TILEMATRIX:"{z}",TILEROW:"{y}",TILECOL:"{x}"});c=a.endsWith("?")?GeoGlobe.ProxyHost+a+b:GeoGlobe.ProxyHost+a+"?"+b;a=GeoGlobe.Util.randomStr(10);return{id:"layer_"+
e.identifier+"_"+a,type:"raster",source:{type:"raster",tiles:[c],tileSize:256},paint:{"raster-opacity":1}}},createLayer:function(a){var b=this.getWMTSCapabilities(a);return this.createLayerOption(a,b,{layer:b.contents.layers[0].identifier})},createLayers:function(a){for(var b=this.getWMTSCapabilities(a),c=b.contents.layers,d=[],e=0;e<c.length;e++){var f=this.createLayerOption(a,b,{layer:c[e].identifier});d.push(f)}return d},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];d!=null&&
typeof d!="function"&&b.push(c+"="+d)}return b.join("&")},calculationTopTileExtentAndZoomOffset:function(a){var b={},c=null,d=0.0254,e=111E3,f=96,g=[],h=[];if(a.hasOwnProperty("inchConvertMeterRatio"))d=a.inchConvertMeterRatio;if(a.hasOwnProperty("degreeConvertMeterRatio"))e=a.degreeConvertMeterRatio;if(a.hasOwnProperty("dpi"))f=a.dpi;var j=Math.ceil(Math.log(Math.max(Number(a.matrixWidth),Number(a.matrixHeight)))/Math.LN2),l=Math.pow(2,j);if(a.hasOwnProperty("resolution"))if(a.resolution!=="")c=
a.resolution;else{alert("\u8bf7\u8f93\u5165resolution\u503c\uff0c\u6216\u8005\u5c06\u8be5\u5c5e\u6027\u6ce8\u91ca");return}else if(a.hasOwnProperty("units")){if(a.units=="m"&&(c=a.scaleDenominator*d/f),a.units=="degrees"&&(c=a.scaleDenominator*d/(f*e)),a.units!=="m"&&a.units!=="degrees"){alert("\u8bf7\u786e\u5b9a\u5355\u4f4d\u662fm\u8fd8\u662fdegrees");return}}else c=Math.abs(a.topLeftCorner[0])<=800&&Math.abs(a.topLeftCorner[1])<=800?a.scaleDenominator*d/(f*e):a.scaleDenominator*d/f;g[0]=a.topLeftCorner[0];
g[3]=a.topLeftCorner[1];g[1]=g[3]-a.tileSize*c*l;g[2]=g[0]+a.tileSize*c*l;a=j-Number(a.identifier);h[0]=(g[0]+g[2])/2;h[1]=(g[1]+g[3])/2;b.topTileExtent=g;b.zoomOffset=a;b.centerPoint=h;b.proposalZoom=a-1;return b},CLASS_NAME:"GeoGlobe.Format.WMTSUtil"});GeoGlobe.Format.WPSCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",CLASS_NAME:"GeoGlobe.Format.WPSCapabilities"});
GeoGlobe.Format.WPSCapabilities.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ows:"http://www.opengis.net/ows/1.1",wps:"http://www.opengis.net/wps/1.0.0",xlink:"http://www.w3.org/1999/xlink"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;
var b={};this.readNode(a,b);return b},readers:{wps:{Capabilities:function(a,b){this.readChildNodes(a,b)},ProcessOfferings:function(a,b){b.processOfferings={};this.readChildNodes(a,b.processOfferings)},Process:function(a,b){var c={processVersion:this.getAttributeNS(a,this.namespaces.wps,"processVersion")};this.readChildNodes(a,c);b[c.identifier]=c},Languages:function(a,b){b.languages=[];this.readChildNodes(a,b.languages)},Default:function(a,b){var c={isDefault:!0};this.readChildNodes(a,c);b.push(c)},
Supported:function(a,b){var c={};this.readChildNodes(a,c);b.push(c)}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WPSCapabilities.v1_0_0"});
GeoGlobe.Format.WCSGetCoverage=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ows:"http://www.opengis.net/ows/1.1",wcs:"http://www.opengis.net/wcs/1.1",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},VERSION:"1.1.2",schemaLocation:"http://www.opengis.net/wcs/1.1 http://schemas.opengis.net/wcs/1.1/wcsGetCoverage.xsd",write:function(a){a=this.writeNode("wcs:GetCoverage",
a);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return GeoGlobe.Format.XML.prototype.write.apply(this,[a])},writers:{wcs:{GetCoverage:function(a){var b=this.createElementNSPlus("wcs:GetCoverage",{attributes:{version:a.version||this.VERSION,service:"WCS"}});this.writeNode("ows:Identifier",a.identifier,b);this.writeNode("wcs:DomainSubset",a.domainSubset,b);this.writeNode("wcs:Output",a.output,b);return b},DomainSubset:function(a){var b=this.createElementNSPlus("wcs:DomainSubset",
{});this.writeNode("ows:BoundingBox",a.boundingBox,b);a.temporalSubset&&this.writeNode("wcs:TemporalSubset",a.temporalSubset,b);return b},TemporalSubset:function(a){for(var b=this.createElementNSPlus("wcs:TemporalSubset",{}),c=0,d=a.timePeriods.length;c<d;++c)this.writeNode("wcs:TimePeriod",a.timePeriods[c],b);return b},TimePeriod:function(a){var b=this.createElementNSPlus("wcs:TimePeriod",{});this.writeNode("wcs:BeginPosition",a.begin,b);this.writeNode("wcs:EndPosition",a.end,b);a.resolution&&this.writeNode("wcs:TimeResolution",
a.resolution,b);return b},BeginPosition:function(a){return this.createElementNSPlus("wcs:BeginPosition",{value:a})},EndPosition:function(a){return this.createElementNSPlus("wcs:EndPosition",{value:a})},TimeResolution:function(a){return this.createElementNSPlus("wcs:TimeResolution",{value:a})},Output:function(a){var b=this.createElementNSPlus("wcs:Output",{attributes:{format:a.format,store:a.store}});a.gridCRS&&this.writeNode("wcs:GridCRS",a.gridCRS,b);return b},GridCRS:function(a){var b=this.createElementNSPlus("wcs:GridCRS",
{});this.writeNode("wcs:GridBaseCRS",a.baseCRS,b);a.type&&this.writeNode("wcs:GridType",a.type,b);a.origin&&this.writeNode("wcs:GridOrigin",a.origin,b);this.writeNode("wcs:GridOffsets",a.offsets,b);a.CS&&this.writeNode("wcs:GridCS",a.CS,b);return b},GridBaseCRS:function(a){return this.createElementNSPlus("wcs:GridBaseCRS",{value:a})},GridOrigin:function(a){return this.createElementNSPlus("wcs:GridOrigin",{value:a})},GridType:function(a){return this.createElementNSPlus("wcs:GridType",{value:a})},GridOffsets:function(a){return this.createElementNSPlus("wcs:GridOffsets",
{value:a})},GridCS:function(a){return this.createElementNSPlus("wcs:GridCS",{value:a})}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.writers.ows},CLASS_NAME:"GeoGlobe.Format.WCSGetCoverage"});
GeoGlobe.Format.WPSExecute=GeoGlobe.Class4OL(GeoGlobe.Format.XML,GeoGlobe.Format.Filter.v1_1_0,{namespaces:{ows:"http://www.opengis.net/ows/1.1",gml:"http://www.opengis.net/gml",wps:"http://www.opengis.net/wps/1.0.0",wfs:"http://www.opengis.net/wfs",ogc:"http://www.opengis.net/ogc",wcs:"http://www.opengis.net/wcs",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},VERSION:"1.0.0",
schemaLocation:"http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd",schemaLocationAttr:function(){},write:function(a){var b;GeoGlobe.Format.XML.supportActiveX?this.xmldom=b=new ActiveXObject("Microsoft.XMLDOM"):b=document.implementation.createDocument("","",null);a=this.writeNode("wps:Execute",a,b);this.setAttributeNS(a,this.namespaces.xsi,"xsi:schemaLocation",this.schemaLocation);return GeoGlobe.Format.XML.prototype.write.apply(this,[a])},read:function(a){typeof a==
"string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var b={};this.readNode(a,b);return b},writers:{wps:{Execute:function(a){var b=this.createElementNSPlus("wps:Execute",{attributes:{version:this.VERSION,service:"WPS"}});this.writeNode("ows:Identifier",a.identifier,b);this.writeNode("wps:DataInputs",a.dataInputs,b);this.writeNode("wps:ResponseForm",a.responseForm,b);return b},ResponseForm:function(a){var b=this.createElementNSPlus("wps:ResponseForm",
{});a.rawDataOutput&&this.writeNode("wps:RawDataOutput",a.rawDataOutput,b);a.responseDocument&&this.writeNode("wps:ResponseDocument",a.responseDocument,b);return b},ResponseDocument:function(a){var b=this.createElementNSPlus("wps:ResponseDocument",{attributes:{storeExecuteResponse:a.storeExecuteResponse,lineage:a.lineage,status:a.status}});if(a.outputs)for(var c=0,d=a.outputs.length;c<d;c++)this.writeNode("wps:Output",a.outputs[c],b);return b},Output:function(a){var b=this.createElementNSPlus("wps:Output",
{attributes:{asReference:a.asReference,mimeType:a.mimeType,encoding:a.encoding,schema:a.schema}});this.writeNode("ows:Identifier",a.identifier,b);this.writeNode("ows:Title",a.title,b);this.writeNode("ows:Abstract",a["abstract"],b);return b},RawDataOutput:function(a){var b=this.createElementNSPlus("wps:RawDataOutput",{attributes:{mimeType:a.mimeType,encoding:a.encoding,schema:a.schema}});this.writeNode("ows:Identifier",a.identifier,b);return b},DataInputs:function(a){for(var b=this.createElementNSPlus("wps:DataInputs",
{}),c=0,d=a.length;c<d;++c)this.writeNode("wps:Input",a[c],b);return b},Input:function(a){var b=this.createElementNSPlus("wps:Input",{});this.writeNode("ows:Identifier",a.identifier,b);a.title&&this.writeNode("ows:Title",a.title,b);a.data&&this.writeNode("wps:Data",a.data,b);a.reference&&this.writeNode("wps:Reference",a.reference,b);a.boundingBoxData&&this.writeNode("wps:BoundingBoxData",a.boundingBoxData,b);return b},Data:function(a){var b=this.createElementNSPlus("wps:Data",{});a.literalData?this.writeNode("wps:LiteralData",
a.literalData,b):a.complexData?this.writeNode("wps:ComplexData",a.complexData,b):a.boundingBoxData&&this.writeNode("ows:BoundingBox",a.boundingBoxData,b);return b},LiteralData:function(a){return this.createElementNSPlus("wps:LiteralData",{attributes:{uom:a.uom},value:a.value})},ComplexData:function(a){var b=this.createElementNSPlus("wps:ComplexData",{attributes:{mimeType:a.mimeType,encoding:a.encoding,schema:a.schema}}),c=a.value;typeof c==="string"?b.appendChild(this.getXMLDoc().createCDATASection(a.value)):
b.appendChild(c);return b},Reference:function(a){var b=this.createElementNSPlus("wps:Reference",{attributes:{mimeType:a.mimeType,"xlink:href":a.href,method:a.method,encoding:a.encoding,schema:a.schema}});a.body&&this.writeNode("wps:Body",a.body,b);return b},BoundingBoxData:function(a,b){this.writers.ows.BoundingBox.apply(this,[a,b,"wps:BoundingBoxData"])},Body:function(a){var b=this.createElementNSPlus("wps:Body",{});a.wcs?this.writeNode("wcs:GetCoverage",a.wcs,b):a.wfs?(this.featureType=a.wfs.featureType,
this.version=a.wfs.version,this.writeNode("wfs:GetFeature",a.wfs,b)):this.writeNode("wps:Execute",a,b);return b}},wcs:GeoGlobe.Format.WCSGetCoverage.prototype.writers.wcs,wfs:GeoGlobe.Format.WFST.v1_1_0.prototype.writers.wfs,ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.writers.ogc,ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.writers.ows},readers:{wps:{ExecuteResponse:function(a,b){b.executeResponse={lang:a.getAttribute("lang"),statusLocation:a.getAttribute("statusLocation"),serviceInstance:a.getAttribute("serviceInstance"),
service:a.getAttribute("service")};this.readChildNodes(a,b.executeResponse)},Process:function(a,b){b.process={};this.readChildNodes(a,b.process)},Status:function(a,b){b.status={creationTime:a.getAttribute("creationTime")};this.readChildNodes(a,b.status)},ProcessSucceeded:function(a,b){b.processSucceeded=!0},ProcessOutputs:function(a,b){b.processOutputs=[];this.readChildNodes(a,b.processOutputs)},Output:function(a,b){var c={};this.readChildNodes(a,c);b.push(c)},Reference:function(a,b){b.reference=
{href:a.getAttribute("href"),mimeType:a.getAttribute("mimeType"),encoding:a.getAttribute("encoding"),schema:a.getAttribute("schema")}},Data:function(a,b){b.data={};this.readChildNodes(a,b)},LiteralData:function(a,b){b.literalData={dataType:a.getAttribute("dataType"),uom:a.getAttribute("uom"),value:this.getChildValue(a)}},ComplexData:function(a,b){b.complexData={mimeType:a.getAttribute("mimeType"),schema:a.getAttribute("schema"),encoding:a.getAttribute("encoding"),value:""};if(this.isSimpleContent(a)){var c;
for(c=a.firstChild;c;c=c.nextSibling)switch(c.nodeType){case 3:case 4:b.complexData.value+=c.nodeValue}}else for(c=a.firstChild;c;c=c.nextSibling)if(c.nodeType==1)b.complexData.value=c},BoundingBox:function(a,b){b.boundingBoxData={dimensions:a.getAttribute("dimensions"),crs:a.getAttribute("crs")};this.readChildNodes(a,b.boundingBoxData)}},ows:GeoGlobe.Format.OWSCommon.v1_1_0.prototype.readers.ows},CLASS_NAME:"GeoGlobe.Format.WPSExecute"});
GeoGlobe.Format.OGCExceptionReport=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{ogc:"http://www.opengis.net/ogc"},regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},defaultPrefix:"ogc",read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));var b={exceptionReport:null};a.documentElement&&(this.readChildNodes(a,b),b.exceptionReport===null&&(b=(new GeoGlobe.Format.OWSCommon).read(a)));return b},readers:{ogc:{ServiceExceptionReport:function(a,
b){b.exceptionReport={exceptions:[]};this.readChildNodes(a,b.exceptionReport)},ServiceException:function(a,b){var c={code:a.getAttribute("code"),locator:a.getAttribute("locator"),text:this.getChildValue(a)};b.exceptions.push(c)}}},CLASS_NAME:"GeoGlobe.Format.OGCExceptionReport"});
GeoGlobe.Format.QueryStringFilter=function(){function a(a){a=a.replace(/%/g,"\\%");a=a.replace(/\\\\\.(\*)?/g,function(a,b){return b?a:"\\\\_"});a=a.replace(/\\\\\.\*/g,"\\\\%");a=a.replace(/(\\)?\.(\*)?/g,function(a,b,c){return b||c?a:"_"});a=a.replace(/(\\)?\.\*/g,function(a,b){return b?a:"%"});a=a.replace(/\\\./g,".");return a=a.replace(/(\\)?\\\*/g,function(a,b){return b?a:"*"})}var b={};b[GeoGlobe.Filter.Comparison.EQUAL_TO]="eq";b[GeoGlobe.Filter.Comparison.NOT_EQUAL_TO]="ne";b[GeoGlobe.Filter.Comparison.LESS_THAN]=
"lt";b[GeoGlobe.Filter.Comparison.LESS_THAN_OR_EQUAL_TO]="lte";b[GeoGlobe.Filter.Comparison.GREATER_THAN]="gt";b[GeoGlobe.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO]="gte";b[GeoGlobe.Filter.Comparison.LIKE]="ilike";return GeoGlobe.Class4OL(GeoGlobe.Format,{wildcarded:!1,srsInBBOX:!1,write:function(c,d){var d=d||{},e=c.CLASS_NAME,e=e.substring(e.lastIndexOf(".")+1);switch(e){case "Spatial":switch(c.type){case GeoGlobe.Filter.Spatial.BBOX:d.bbox=c.value.toArray();this.srsInBBOX&&c.projection&&d.bbox.push(c.projection.getCode());
break;case GeoGlobe.Filter.Spatial.DWITHIN:d.tolerance=c.distance;case GeoGlobe.Filter.Spatial.WITHIN:d.lon=c.value.x;d.lat=c.value.y;break;default:GeoGlobe.Console.warn("Unknown spatial filter type "+c.type)}break;case "Comparison":e=b[c.type];if(e!==void 0){var f=c.value;c.type==GeoGlobe.Filter.Comparison.LIKE&&(f=a(f),this.wildcarded&&(f="%"+f+"%"));d[c.property+"__"+e]=f;d.queryable=d.queryable||[];d.queryable.push(c.property)}else GeoGlobe.Console.warn("Unknown comparison filter type "+c.type);
break;case "Logical":if(c.type===GeoGlobe.Filter.Logical.AND){e=0;for(f=c.filters.length;e<f;e++)d=this.write(c.filters[e],d)}else GeoGlobe.Console.warn("Unsupported logical filter type "+c.type);break;default:GeoGlobe.Console.warn("Unknown filter type "+e)}return d},CLASS_NAME:"GeoGolobe.Format.QueryStringFilter"})}();
GeoGlobe.Format.BusCapabilities=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{tagName:"NETWORK_Capabilities",read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));var a=a.nodeName!=this.tagName?a.getElementsByTagName(this.tagName):[a],b={};a.length>0&&this.runChildNodes(b,a[0]);return b},runChildNodes:function(a,b,c){for(var b=b.childNodes,d,e,f=0;f<b.length;++f)d=b[f],d.nodeType==1&&(e=c?this["read_"+c+"_"+d.nodeName]:this["read_"+d.nodeName])&&e.apply(this,[a,d])},
read_Service:function(a,b){var c={};this.runChildNodes(c,b,"Service");a.service=c},read_Service_Name:function(a,b){var c=this.getChildValue(b);if(c)a.name=c},read_Service_Title:function(a,b){var c=this.getChildValue(b);if(c)a.title=c},read_Service_Abstract:function(a,b){var c=this.getChildValue(b);if(c)a.serviceAbstract=c},read_Service_KeywordList:function(){},read_Service_OnlineResource:function(a,b){var c=this.getChildValue(b);if(a)a.onlineResource=c},read_Capability:function(a,b){var c={};this.runChildNodes(c,
b,"Capability");a.capability=c},read_Capability_Request:function(a,b){var c={};this.runChildNodes(c,b,"Capability_Request");a.request=c},read_Capability_Request_GetCapabilities:function(a,b){var c=b.getElementsByTagName("HTTP"),d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_GetCapabilities_DCPType_HTTP");a.getCapabilities=d},read_Capability_Request_GetCapabilities_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_GetCapabilities_DCPType_HTTP_Post:function(a,
b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},read_Capability_Request_queryStation:function(a,b){var c=b.getElementsByTagName("HTTP"),d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_queryStation_DCPType_HTTP");a.queryStation=d},read_Capability_Request_queryStation_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_queryStation_DCPType_HTTP_Post:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},
read_Capability_Request_queryLine:function(a,b){var c=b.getElementsByTagName("HTTP"),d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_queryLine_DCPType_HTTP");a.queryLine=d},read_Capability_Request_queryLine_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_queryLine_DCPType_HTTP_Post:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},read_Capability_Request_queryChange:function(a,b){var c=b.getElementsByTagName("HTTP"),
d={};c[0]&&this.runChildNodes(d,c[0],"Capability_Request_queryChange_DCPType_HTTP")},read_Capability_Request_queryChange_DCPType_HTTP_Get:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.getUrl=c},read_Capability_Request_queryChange_DCPType_HTTP_Post:function(a,b){var c=b.getAttribute("onlineResource");if(c)a.postUrl=c},read_Capability_Networks:function(a,b){for(var c=b.getElementsByTagName("Name"),d=[],e=0;e<c.length;e++){var f=this.getChildValue(c[e]);f&&d.push(f)}a.networks=d},CLASS_NAME:"GeoGlobe.Format.BusCapabilities"});
GeoGlobe.Format.XML2JSON=GeoGlobe.Class4OL({initialize:function(){},read:function(a,b,c){b||(b="");a=a.replace(/\s*\/>/g,"/>");a=a.replace(/<\?[^>]*>/g,"").replace(/<\![^>]*>/g,"");b.sort||(b=b.split(","));for(var a=this.no_fast_endings(a),a=this.attris_to_tags(a),a=escape(a),a=a.split("%3C").join("<").split("%3E").join(">").split("%3D").join("=").split("%22").join('"'),d=0;d<b.length;d++)a=a.replace(RegExp("<"+b[d]+">","g"),"*$**"+b[d]+"**$*"),a=a.replace(RegExp("</"+b[d]+">","g"),"*$***"+b[d]+"**$*");
this.xmlobject={};b=this.xml_to_object("<JSONTAGWRAPPER>"+a+"</JSONTAGWRAPPER>").JSONTAGWRAPPER;c&&(b=this.show_json_structure(b,c));return b},xml_to_object:function(a){for(var b=a.replace(/<\//g,"?"),b=b.split("<"),a=[],c=0,d=[],e=1;e<b.length;e++){var f=b[e].split(">")[0];d.push(f);c++;for(a.push(c+"<"+b[e].split("?")[0]);b[e].indexOf("?"+d[d.length-1]+">")>=0;)c--,d.pop()}for(var g=-1,b="this.xmlobject",e=0;e<a.length;e++){var c="",d=a[e].split("<")[0],h=a[e].split("<")[1].split(">")[0],h=h.replace(/%3A/,
"_"),f=a[e].split(">")[1];if(d<=g)for(var g=g-d+1,j=0;j<g;j++)b=b.substring(0,b.lastIndexOf("."));b+="."+h;g=b.substring(0,b.lastIndexOf("."));eval("typeof "+g)!="object"&&(c+=g+"={value:"+g+"};\n");j=b.substring(b.lastIndexOf(".")+1);h=!1;for(k in eval(g))k==j&&(h=!0);g=!0;for(j=0;j<f.length;j+=3)f.charAt(j)!="%"&&(g=!1);f!=""&&!g?f/1!=f&&(f="'"+f.replace(/\'/g,"\\'")+"'",f=f.replace(/\*\$\*\*\*/g,"</"),f=f.replace(/\*\$\*\*/g,"<"),f=f.replace(/\*\*\$\*/g,">")):f="{}";f.charAt(0)=="'"&&(f="unescape("+
f+")");h&&!eval(b+".sort")&&(c+=b+"=["+b+"];\n");g="=";after="";h&&(g=".push(",after=")");eval(c+b+g+f+after);eval(b+".sort")&&(b+="["+eval(b+".length-1")+"]");g=d}return this.xmlobject},show_json_structure:function(a,b,c){var d="";d+=a.sort?"[\n":"{\n";for(var e in a)a.sort||(d+=e+":"),d+=typeof a[e]=="object"?this.show_json_structure(a[e],!1,1):typeof a[e]=="function"?a[e]+"":typeof a[e]!="string"?a[e]+",\n":"'"+a[e].replace(/\'/g,"\\'").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r")+
"',\n";d+=a.sort?"],\n":"},\n";if(!c){d=d.substring(0,d.lastIndexOf(","));d=d.replace(RegExp(",\n}","g"),"\n}");d=d.replace(RegExp(",\n]","g"),"\n]");a=d.split("\n");d="";for(e=c=0;e<a.length;e++){(a[e].indexOf("}")>=0||a[e].indexOf("]")>=0)&&c--;tabs="";for(var f=0;f<c;f++)tabs+="\t";d+=tabs+a[e]+"\n";(a[e].indexOf("{")>=0||a[e].indexOf("[")>=0)&&c++}b=="html"&&(d=d.replace(/</g,"&lt;").replace(/>/g,"&gt;"),d=d.replace(/\n/g,"<BR>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;"));b=="compact"&&(d=d.replace(/\n/g,
"").replace(/\t/g,""))}return d},no_fast_endings:function(a){for(var a=a.split("/>"),b=1;b<a.length;b++){var c=a[b-1].substring(a[b-1].lastIndexOf("<")+1).split(" ")[0];a[b]="></"+c+">"+a[b]}return a=a.join("")},attris_to_tags:function(a){for(var b=" =\"'".split(""),a=a.split(">"),c=0;c<a.length;c++){for(var d=a[c].split("<"),e=0;e<4;e++)d[0]=d[0].replace(RegExp(b[e],"g"),"_jsonconvtemp"+e+"_");if(d[1]){d[1]=d[1].replace(/'/g,'"');d[1]=d[1].split('"');for(var f=1;f<d[1].length;f+=2)for(e=0;e<4;e++)d[1][f]=
d[1][f].replace(RegExp(b[e],"g"),"_jsonconvtemp"+e+"_");d[1]=d[1].join('"')}a[c]=d.join("<")}a=a.join(">");a=a.replace(/ ([^=]*)=([^ |>]*)/g,"><$1>$2</$1");a=a.replace(/>"/g,">").replace(/"</g,"<");for(e=0;e<4;e++)a=a.replace(RegExp("_jsonconvtemp"+e+"_","g"),b[e]);return a},CLASS_NAME:"GeoGlobe.Format.XML2JSON"});
GeoGlobe.Format.CSWGetRecords=function(a){var a=GeoGlobe.Util.applyDefaults(a,GeoGlobe.Format.CSWGetRecords.DEFAULTS),b=GeoGlobe.Format.CSWGetRecords["v"+a.version.replace(/\./g,"_")];if(!b)throw"Unsupported CSWGetRecords version: "+a.version;return new b(a)};GeoGlobe.Format.CSWGetRecords.DEFAULTS={version:"2.0.2"};
GeoGlobe.Format.CSWGetRecords.v2_0_2=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{namespaces:{csw:"http://www.opengis.net/cat/csw/2.0.2",dc:"http://purl.org/dc/elements/1.1/",dct:"http://purl.org/dc/terms/",gmd:"http://www.isotc211.org/2005/gmd",geonet:"http://www.fao.org/geonetwork",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"csw",version:"2.0.2",schemaLocation:"http://www.opengis.net/cat/csw/2.0.2 http://schemas.opengis.net/csw/2.0.2/CSW-discovery.xsd",
requestId:null,resultType:null,outputFormat:null,outputSchema:null,startPosition:null,maxRecords:null,DistributedSearch:null,ResponseHandler:null,Query:null,regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9)a=a.documentElement;var b={};this.readNode(a,b);return b},readers:{csw:{GetRecordsResponse:function(a,
b){b.records=[];this.readChildNodes(a,b);var c=this.getAttributeNS(a,"","version");if(c!="")b.version=c},RequestId:function(a,b){b.RequestId=this.getChildValue(a)},SearchStatus:function(a,b){b.SearchStatus={};var c=this.getAttributeNS(a,"","timestamp");if(c!="")b.SearchStatus.timestamp=c},SearchResults:function(a,b){this.readChildNodes(a,b);for(var c=a.attributes,d={},e=0,f=c.length;e<f;++e)d[c[e].name]=c[e].name=="numberOfRecordsMatched"||c[e].name=="numberOfRecordsReturned"||c[e].name=="nextRecord"?
parseInt(c[e].nodeValue):c[e].nodeValue;b.SearchResults=d},SummaryRecord:function(a,b){var c={type:"SummaryRecord"};this.readChildNodes(a,c);b.records.push(c)},BriefRecord:function(a,b){var c={type:"BriefRecord"};this.readChildNodes(a,c);b.records.push(c)},DCMIRecord:function(a,b){var c={type:"DCMIRecord"};this.readChildNodes(a,c);b.records.push(c)},Record:function(a,b){var c={type:"Record"};this.readChildNodes(a,c);b.records.push(c)},"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();
b[c]=this.getChildValue(a)}},geonet:{info:function(a,b){var c={};this.readChildNodes(a,c);b.gninfo=c}},dc:{"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();GeoGlobe.Util.isArray(b[c])||(b[c]=[]);for(var d={},e=a.attributes,f=0,g=e.length;f<g;++f)d[e[f].name]=e[f].nodeValue;d.value=this.getChildValue(a);d.value!=""&&b[c].push(d)}},dct:{"*":function(a,b){var c=a.localName||a.nodeName.split(":").pop();GeoGlobe.Util.isArray(b[c])||(b[c]=[]);b[c].push(this.getChildValue(a))}},ows:GeoGlobe.Util.applyDefaults({BoundingBox:function(a,
b){if(b.bounds)b.BoundingBox=[{crs:b.projection,value:[b.bounds._sw.lng,b.bounds._sw.lat,b.bounds._ne.lng,b.bounds._ne.lat]}],delete b.projection,delete b.bounds;GeoGlobe.Format.OWSCommon.v1_0_0.prototype.readers.ows.BoundingBox.apply(this,arguments)}},GeoGlobe.Format.OWSCommon.v1_0_0.prototype.readers.ows)},write:function(a){a=this.writeNode("csw:GetRecords",a);a.setAttribute("xmlns:gmd",this.namespaces.gmd);return GeoGlobe.Format.XML.prototype.write.apply(this,[a])},writers:{csw:{GetRecords:function(a){a||
(a={});var b=this.createElementNSPlus("csw:GetRecords",{attributes:{service:"CSW",version:this.version,requestId:a.requestId||this.requestId,resultType:a.resultType||this.resultType,outputFormat:a.outputFormat||this.outputFormat,outputSchema:a.outputSchema||this.outputSchema,startPosition:a.startPosition||this.startPosition,maxRecords:a.maxRecords||this.maxRecords}});if(a.DistributedSearch||this.DistributedSearch)this.writeNode("csw:DistributedSearch",a.DistributedSearch||this.DistributedSearch,b);
var c=a.ResponseHandler||this.ResponseHandler;if(GeoGlobe.Util.isArray(c)&&c.length>0)for(var d=0,e=c.length;d<e;d++)this.writeNode("csw:ResponseHandler",c[d],b);this.writeNode("Query",a.Query||this.Query,b);return b},DistributedSearch:function(a){return this.createElementNSPlus("csw:DistributedSearch",{attributes:{hopCount:a.hopCount}})},ResponseHandler:function(a){return this.createElementNSPlus("csw:ResponseHandler",{value:a.value})},Query:function(a){a||(a={});var b=this.createElementNSPlus("csw:Query",
{attributes:{typeNames:a.typeNames||"csw:Record"}}),c=a.ElementName;if(GeoGlobe.Util.isArray(c)&&c.length>0)for(var d=0,e=c.length;d<e;d++)this.writeNode("csw:ElementName",c[d],b);else this.writeNode("csw:ElementSetName",a.ElementSetName||{value:"summary"},b);a.Constraint&&this.writeNode("csw:Constraint",a.Constraint,b);a.SortBy&&this.writeNode("ogc:SortBy",a.SortBy,b);return b},ElementName:function(a){return this.createElementNSPlus("csw:ElementName",{value:a.value})},ElementSetName:function(a){return this.createElementNSPlus("csw:ElementSetName",
{attributes:{typeNames:a.typeNames},value:a.value})},Constraint:function(a){var b=this.createElementNSPlus("csw:Constraint",{attributes:{version:a.version}});if(a.Filter){var c=new GeoGlobe.Format.Filter({version:a.version});b.appendChild(c.write(a.Filter))}else a.CqlText&&(a=this.createElementNSPlus("CqlText",{value:a.CqlText.value}),b.appendChild(a));return b}},ogc:GeoGlobe.Format.Filter.v1_1_0.prototype.writers.ogc},CLASS_NAME:"GeoGlobe.Format.CSWGetRecords.v2_0_2"});
(function(a,b){a.GeoGlobe.Format.X2JS=b();a.GeoGlobe.Format.X2JS.CLASS_NAME="GeoGlobe.Format.X2JS"})(window,function(){return function(a){function b(a){var b=a.localName;if(b==null)b=a.baseName;if(b==null||b=="")b=a.nodeName;return b}function c(a){return typeof a=="string"?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):a}function d(a,b,c,d){for(var e=0;e<a.length;e++){var f=a[e];if(typeof f==="string"){if(f==d)break}else if(f instanceof
RegExp){if(f.test(d))break}else if(typeof f==="function"&&f(b,c,d))break}return e!=a.length}function e(b,c,e){switch(a.arrayAccessForm){case "property":b[c+"_asArray"]=b[c]instanceof Array?b[c]:[b[c]]}!(b[c]instanceof Array)&&a.arrayAccessFormPaths.length>0&&d(a.arrayAccessFormPaths,b,c,e)&&(b[c]=[b[c]])}function f(a){var b=a.split(/[-T:+Z]/g),c=new Date(b[0],b[1]-1,b[2]),d=b[5].split(".");c.setHours(b[3],b[4],d[0]);d.length>1&&c.setMilliseconds(d[1]);b[6]&&b[7]?(b=b[6]*60+Number(b[7]),b=0+((/\d\d-\d\d:\d\d$/.test(a)?
"-":"+")=="-"?-1*b:b),c.setMinutes(c.getMinutes()-b-c.getTimezoneOffset())):a.indexOf("Z",a.length-1)!==-1&&(c=new Date(Date.UTC(c.getFullYear(),c.getMonth(),c.getDate(),c.getHours(),c.getMinutes(),c.getSeconds(),c.getMilliseconds())));return c}function g(b,c,e){return a.datetimeAccessFormPaths.length>0?(e=e.split(".#")[0],d(a.datetimeAccessFormPaths,b,c,e)?f(b):b):b}function h(c,f){if(c.nodeType==p.DOCUMENT_NODE){for(var j={},o=c.childNodes,m=0;m<o.length;m++){var l=o.item(m);if(l.nodeType==p.ELEMENT_NODE){var n=
b(l);j[n]=h(l,n)}}return j}else if(c.nodeType==p.ELEMENT_NODE){j={};j.__cnt=0;o=c.childNodes;for(m=0;m<o.length;m++)if(l=o.item(m),n=b(l),l.nodeType!=p.COMMENT_NODE){var r=f+"."+n;if(l.nodeType==p.ELEMENT_NODE&&a.xmlElementsFilter.length>0?d(a.xmlElementsFilter,j,n,r):1)j.__cnt++,j[n]==null?(j[n]=h(l,r),e(j,n,r)):(j[n]!=null&&!(j[n]instanceof Array)&&(j[n]=[j[n]],e(j,n,r)),j[n][j[n].length]=h(l,r))}for(o=0;o<c.attributes.length;o++)m=c.attributes.item(o),j.__cnt++,j[a.attributePrefix+m.name]=m.value;
o=c.prefix;if(o!=null&&o!="")j.__cnt++,j.__prefix=o;if(j["#text"]!=null){j.__text=j["#text"];if(j.__text instanceof Array)j.__text=j.__text.join("\n");if(a.stripWhitespaces)j.__text=j.__text.trim();delete j["#text"];a.arrayAccessForm=="property"&&delete j["#text_asArray"];j.__text=g(j.__text,n,f+"."+n)}if(j["#cdata-section"]!=null)j.__cdata=j["#cdata-section"],delete j["#cdata-section"],a.arrayAccessForm=="property"&&delete j["#cdata-section_asArray"];j.__cnt==0&&a.emptyNodeForm=="text"?j="":j.__cnt==
1&&j.__text!=null?j=j.__text:j.__cnt==1&&j.__cdata!=null&&!a.keepCData?j=j.__cdata:j.__cnt>1&&j.__text!=null&&a.skipEmptyTextNodesForObj&&(a.stripWhitespaces&&j.__text==""||j.__text.trim()=="")&&delete j.__text;delete j.__cnt;if(a.enableToStringFunc&&(j.__text!=null||j.__cdata!=null))j.toString=function(){return(this.__text!=null?this.__text:"")+(this.__cdata!=null?this.__cdata:"")};return j}else if(c.nodeType==p.TEXT_NODE||c.nodeType==p.CDATA_SECTION_NODE)return c.nodeValue}function j(b,d,e,f){d=
"<"+(b!=null&&b.__prefix!=null?b.__prefix+":":"")+d;if(e!=null)for(var g=0;g<e.length;g++){var h=e[g],j=b[h];a.escapeMode&&(j=c(j));d+=" "+h.substr(a.attributePrefix.length)+"=";d+=a.useDoubleQuotes?'"'+j+'"':"'"+j+"'"}d+=f?"/>":">";return d}function l(a,b){return"</"+(a.__prefix!=null?a.__prefix+":":"")+b+">"}function n(b,c){return a.arrayAccessForm=="property"&&c.toString().indexOf("_asArray",c.toString().length-8)!==-1||c.toString().indexOf(a.attributePrefix)==0||c.toString().indexOf("__")==0||
b[c]instanceof Function?!0:!1}function o(a){var b=0;if(a instanceof Object)for(var c in a)n(a,c)||b++;return b}function q(b){var c=[];if(b instanceof Object)for(var d in b)d.toString().indexOf("__")==-1&&d.toString().indexOf(a.attributePrefix)==0&&c.push(d);return c}function r(b){var d="";if(b instanceof Object){var e="";b.__cdata!=null&&(e+="<![CDATA["+b.__cdata+"]]\>");b.__text!=null&&(e+=a.escapeMode?c(b.__text):b.__text);d+=e}else b!=null&&(d+=a.escapeMode?c(b):b);return d}function m(b,c){var e=
"";if(o(b)>0)for(var f in b){var g;if(!(g=n(b,f)))if(g=c!="")g=c===""?f:c+"."+f,g=!(a.jsonPropertiesFilter.length==0||g==""||d(a.jsonPropertiesFilter,b,f,g));if(!g){var h=b[f];g=q(h);if(h==null||h==void 0)e+=j(h,f,g,!0);else if(h instanceof Object)if(h instanceof Array){var p=f,A=c,B="";if(h.length==0)B+=j(h,p,g,!0);else for(g=0;g<h.length;g++)B+=j(h[g],p,q(h[g]),!1),B+=m(h[g],A===""?p:A+"."+p),B+=l(h[g],p);e+=B}else h instanceof Date?(e+=j(h,f,g,!1),e+=h.toISOString(),e+=l(h,f)):o(h)>0||h.__text!=
null||h.__cdata!=null?(e+=j(h,f,g,!1),e+=m(h,c===""?f:c+"."+f),e+=l(h,f)):e+=j(h,f,g,!0);else e+=j(h,f,g,!1),e+=r(h),e+=l(h,f)}}e+=r(b);return e}a=a||{};if(a.escapeMode===void 0)a.escapeMode=!0;a.attributePrefix=a.attributePrefix||"_";a.arrayAccessForm=a.arrayAccessForm||"none";a.emptyNodeForm=a.emptyNodeForm||"text";if(a.enableToStringFunc===void 0)a.enableToStringFunc=!0;a.arrayAccessFormPaths=a.arrayAccessFormPaths||[];if(a.skipEmptyTextNodesForObj===void 0)a.skipEmptyTextNodesForObj=!0;if(a.stripWhitespaces===
void 0)a.stripWhitespaces=!0;a.datetimeAccessFormPaths=a.datetimeAccessFormPaths||[];if(a.useDoubleQuotes===void 0)a.useDoubleQuotes=!1;a.xmlElementsFilter=a.xmlElementsFilter||[];a.jsonPropertiesFilter=a.jsonPropertiesFilter||[];if(a.keepCData===void 0)a.keepCData=!1;var p={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(a){var b=window.ActiveXObject||"ActiveXObject"in window;if(a===void 0)return null;var c;if(window.DOMParser){var d=new window.DOMParser,
e=null;if(!b)try{e=d.parseFromString("INVALID","text/xml").getElementsByTagName("parsererror")[0].namespaceURI}catch(f){e=null}try{c=d.parseFromString(a,"text/xml"),e!=null&&c.getElementsByTagNameNS(e,"parsererror").length>0&&(c=null)}catch(g){c=null}}else a.indexOf("<?")==0&&(a=a.substr(a.indexOf("?>")+2)),c=new ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(a);return c};this.asArray=function(a){return a===void 0||a==null?[]:a instanceof Array?a:[a]};this.toXmlDateTime=function(a){return a instanceof
Date?a.toISOString():typeof a==="number"?(new Date(a)).toISOString():null};this.asDateTime=function(a){return typeof a=="string"?f(a):a};this.xml2json=function(a){return h(a)};this.xml_str2json=function(a){a=this.parseXmlString(a);return a!=null?this.xml2json(a):null};this.json2xml_str=function(a){return m(a,"")};this.json2xml=function(a){return this.parseXmlString(this.json2xml_str(a))};this.getVersion=function(){return"1.2.0"}}});
GeoGlobe.Analysis.BufferAnalysis=GeoGlobe.Class4OL({url:null,type:1,accuracy:32,initialize:function(a,b){this.url=a;GeoGlobe.Util.extend(this,b)},_buildPostXML:function(a,b){return'<?xml version="1.0" encoding="UTF-8" standalone="yes"?><wps:Execute service="WPS" version="1.0.0" xmlns:gml="http://www.opengis.net/gml" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 ../wpsExecute_request.xsd"><ows:Identifier>Buffer</ows:Identifier><wps:DataInputs><wps:Input><ows:Identifier>InputPolygon</ows:Identifier><wps:Data><wps:ComplexData schema="http://foo.bar/MyComplexValueSchema.xsd" mimeType="text/xml" encoding="UTF-8">'+
(new GeoGlobe.Format.GML).write(a)+"</wps:ComplexData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferDistance</ows:Identifier><wps:Data><wps:LiteralData>"+b+"</wps:LiteralData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferType</ows:Identifier><wps:Data><wps:LiteralData>"+this.type+"</wps:LiteralData></wps:Data></wps:Input><wps:Input><ows:Identifier>BufferAccuracy</ows:Identifier><wps:Data><wps:LiteralData>"+this.accuracy+"</wps:LiteralData></wps:Data></wps:Input></wps:DataInputs><wps:ResponseForm><wps:RawDataOutput><ows:Identifier>BufferedPolygon</ows:Identifier></wps:RawDataOutput></wps:ResponseForm></wps:Execute>"},
_getFeaturesCenter:function(a){return this._getFeaturesExtent(a).getCenterLonLat()},_getFeaturesExtent:function(a){GeoGlobe.Util.isArray(a)||(a=[a]);var b=null;if(a&&a.length>0)for(var b=new GeoGlobe.LngLatBounds,c=null,d=0,e=a.length;d<e;d++)(c=a[d].geometry)&&b.extend(c.getBounds());return b},startAnalysis:function(a,b,c){var d=["m","km","degree"],a=(new GeoGlobe.Format.GeoJSON).read(a),e=this._getFeaturesCenter(a);if(!c||GeoGlobe.Util.indexOf(d,c)==-1)c="m";switch(c){case "km":b*=1E3;case "m":b=
this._meterToDegree(b,e)}b=this._buildPostXML(a,b);new GeoGlobe.Request.POST({url:this.url,data:b,scope:this,success:function(a){""==a.responseText||null==a.responseText?this.failFn():(a=this._parserResult(a),a=(new GeoGlobe.Format.GeoJSON).write(a),this.successFn((new GeoGlobe.Format.JSON).read(a)))},failure:this.failFn})},_meterToDegree:function(a,b){return a*(8.99E-6/Math.cos(GeoGlobe.Util.rad(b.lat)))},successFn:function(){},failFn:function(){alert("\u7f13\u51b2\u5206\u6790\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u68c0\u6d4b\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002")},
_parserResult:function(a){var b=null,b=new GeoGlobe.Format.XML;if(!a.responseXML)a.responseXML=b.read(a.responseText);return b=(new GeoGlobe.Format.GML).read(a.responseXML)},CLASS_NAME:"GeoGlobe.Analysis.BufferAnalysis"});GeoGlobe.Analysis.BufferAnalysis.CAP_ROUND=1;GeoGlobe.Analysis.BufferAnalysis.CAP_BUTT=2;GeoGlobe.Analysis.BufferAnalysis.CAP_SQUARE=3;
GeoGlobe.Analysis.GetFeature=GeoGlobe.Class4OL({url:null,type:"intersection",_reqStrTemplate:"{'GetFeature': {'service': 'OverlapService','version': '1.0.0','dataSource':'${sourceInputs}','Query': [{'typeName':'${dataInputs}'}],'maxFeatures': '','startPosition': '','outPutFormat': 'GeoJSON','resultType': ''}}",initialize:function(a,b){this.url=a;GeoGlobe.Util.extend(this,b)},_buildReqStr:function(){return GeoGlobe.String.format(this._reqStrTemplate,{type:this.type,dataInputs:this.typeName,sourceInputs:this.DataSource})},
startAnalysis:function(){if(this._checkSet())return!1;var a=this._buildReqStr();new GeoGlobe.Request.POST({url:this.url,data:a,scope:this,success:function(a){""==a.responseText||null==a.responseText?this.failFn():this.successFn(a)},failure:this.failFn})},_checkSet:function(){if(!this.url)return!1},successFn:function(){},failFn:function(){alert("\u670d\u52a1\u8bf7\u6c42\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u68c0\u6d4b\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002")},CLASS_NAME:"GeoGlobe.Analysis.GetFeature"});
GeoGlobe.Analysis.SpatialAnalysis=GeoGlobe.Class({url:null,type:"intersection",_requestStrTemplate:"{'SpatialAnalysis': {'service': 'OverlapService','version': '1.0.0','origionLayerNames': ['${origionLayerNames}'],'targetLayerNames': ['${targetLayerNames}'],'outPutFormat': 'GeoJSON','operator': '${dataInputs}','isSynchronization': 'true','tolerance': '${tolerance}'}}",initialize:function(a,b){this.url=a;GeoGlobe.Util.extend(this,b)},_buildRequestStr:function(){return GeoGlobe.String.format(this._requestStrTemplate,
{type:this.type,dataInputs:this.operator,origionLayerNames:this.origionLayerNames,targetLayerNames:this.targetLayerNames,tolerance:this.tolerance})},startAnalysis:function(a){if(this._checkSet())return!1;var b=this._buildRequestStr();new GeoGlobe.Request.POST({url:this.url,data:b,scope:this,success:function(b){""==b.responseText||null==b.responseText?this.failFn():this.successFn(b,a)},failure:this.failFn})},_checkSet:function(){if(!this.url)return!1},successFn:function(){},failFn:function(){alert("\u53e0\u7f6e\u5206\u6790\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u68c0\u6d4b\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002")},
CLASS_NAME:"GeoGlobe.Analysis.SpatialAnalysis"});
GeoGlobe.Analysis.CoreBufferAnalysis=GeoGlobe.Class({url:null,type:"intersection",_requestStrTemplate:"{'BufferAnalysis': {'service': 'OverlapService','version': '1.0.0','layerName': '${layerName}','bufferRadius': '${bufferRadius}','bufferStyle':'${bufferStyle}','outPutFormat': 'JSON','bufferType': '${bufferType}','isSynchronization': 'true'}}",initialize:function(a,b){this.url=a;GeoGlobe.Util.extend(this,b)},_buildRequestStr:function(){return GeoGlobe.String.format(this._requestStrTemplate,{type:this.type,
layerName:this.layerName,bufferRadius:this.bufferRadius,bufferStyle:this.bufferStyle,bufferType:this.bufferType})},startAnalysis:function(a){if(this._checkSet())return!1;var b=this._buildRequestStr();new GeoGlobe.Request.POST({url:this.url,data:b,scope:this,success:function(b){""==b.responseText||null==b.responseText?this.failFn():this.successFn(b,a)},failure:this.failFn})},_checkSet:function(){if(!this.url)return!1},successFn:function(){},failFn:function(){alert("\u7f13\u51b2\u5206\u6790\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u68c0\u6d4b\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c")},
CLASS_NAME:"GeoGlobe.Analysis.CoreBufferAnalysis"});
GeoGlobe.Query.Service=GeoGlobe.Class4OL({name:null,url:null,version:null,userid:"test@liferay.com",initialize:function(a,b,c){this.name=a;this.url=b;GeoGlobe.Util.extend(this,c)},getCapabilities:function(){},isExist:function(){},failFn:function(a){alert("\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+this.url+"\n\u64cd\u4f5c\u7c7b\u578b\uff1a"+
a)},_parseToXML:function(a){var b=a.responseXML;if(!b||!b.documentElement)b=a.responseText;return(new GeoGlobe.Format.XML).read(b)},_checkIsError:function(a){if((new GeoGlobe.Format.XML).read(a).selectNodes("ServiceExceptionReport").length>0)return this._parseToJSON(a);return null},_isException:function(a){if(a&&a.ServiceExceptionReport)return!0;return!1},_parseToJSON:function(a){return(new GeoGlobe.Util.Format.XML2JSON).read(a)},CLASS_NAME:"GeoGlobe.Query.Service"});
GeoGlobe.Query.RouteQuery=GeoGlobe.Class4OL(GeoGlobe.Query.Service,{_format:null,initialize:function(a,b,c){this.name=a;this.url=b;this._format=new GeoGlobe.Format.RouteQuery;GeoGlobe.Util.extend(this,c)},getCapabilities:function(a,b){GeoGlobe.loadURL(this.url,{REQUEST:"GetCapabilities"},this,a,b)},findRoute:function(a,b,c){var d={REQUEST:"FindRoute",SERVICE:"ROUTE",VERSION:"1.0.0"},e={data:!0,orig:!0,dest:!0},f;for(f in e)if(!(f in a))throw Error("Missing property '"+f+"'");d.DATA=a.data;d.ORIG=
a.orig;d.DEST=a.dest;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.radius!==null&&a.radius!==void 0)d.RADIUS=a.radius;if(a.queryType!==null&&a.queryType!==void 0)d.QUERYTYPE=a.queryType;if(a.midpos!==null&&a.midpos!==void 0)d.MIDPOS=a.midpos;if(a.avoidPos!==null&&a.avoidPos!==void 0)d.AVOIDPOS=a.avoidPos;if(a.filterRoute!==null&&a.filterRoute!==void 0)d.FILTERROUTE=a.filterRoute;if(a.resultCount!==null&&a.resultCount!==
void 0)d.RESULTCOUNT=a.resultCount;GeoGlobe.Request.GET({url:this.url,params:d,async:!1,scope:this,success:function(a){a=this._format.read(a.responseText);if(typeof a.exceptionInfo!=="string"){var a=new GeoGlobe.Query.RoutesResult(a),c=a.routes,c=(new GeoGlobe.Format.GeoJSON).write(c);geojsonRoute=(new GeoGlobe.Format.JSON).read(c);a.geojsonRoute=geojsonRoute}b(a)},failure:c})},getRouteInfo:function(a,b,c){var d={REQUEST:"GetRouteInfo",SERVICE:"ROUTE",VERSION:"1.0.0"};if(!a.data||!a.id)throw"Error!Not data and id for bus query.";
d.DATA=a.data;d.ID=a.id;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._format.read(a.responseText);typeof a.exceptionInfo!=="string"&&(a=new GeoGlobe.Query.RouteInfoResult(a));b(a)},failure:c})},CLASS_NAME:"GeoGlobe.Query.RouteQuery"});
GeoGlobe.Format.RouteQuery=new GeoGlobe.Class4OL(GeoGlobe.Format.XML,{initialize:function(a){GeoGlobe.Format.XML.prototype.initialize.apply(this,[a])},read:function(a){var b={},c=[];typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));if(a&&a.nodeType==9){var c=[],d=GeoGlobe.Format.XML.prototype.getChildEl.apply(this,[a]).nodeName;if("ServiceExceptionReport"===d)return c=GeoGlobe.Format.XML.prototype.getElementsByTagNameNS(a,"*","ServiceException")[0],b=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,
[c]),c=c.getAttribute("code"),{exceptionInfo:b,exceptionCode:c};for(var a=a.getElementsByTagName(d)[0].childNodes,e=0;e<a.length;e++){var f=a[e],g=f.nodeName;this._resultPaser[d][g]&&this._resultPaser[d][g].apply(this,[f,c])}}d=d.toLowerCase();"routeinfo"===d?b.items=c:b[d]=c;return b},_resultPaser:{RouteInfo:{Item:function(a,b){var c=a.childNodes,d=a.getAttribute("id"),e={};d&&(e={id:d});for(d=0;d<c.length;d++){var a=c[d],f=a.nodeName;this._resultPaser.RouteInfo[f]&&this._resultPaser.RouteInfo[f].apply(this,
[a,e])}b.push(e)},Name:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);if(c)b.name=c},Toll:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);b.toll=c},Level:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);b.level=c},Length:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);b.length=c},Geometry:function(a,b){var c=GeoGlobe.Format.XML.prototype.getElementsByTagNameNS(a,"*","LineString")[0];
if(c&&(c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[c]),typeof c==="string"&&c.length>0)){for(var c=c.split(" "),d=[],e=0,f=c.length;e<f;e++){var g=c[e].split(",");d.push(new GeoGlobe.Geometry.Point(new Number(g[0]),new Number(g[1])))}c=new GeoGlobe.Geometry.LineString(d);b.geometry=c}},Directions:function(a,b){b.directions=[];for(var c=a.childNodes,d=0;d<c.length;d++){var a=c[d],e=a.nodeName;if(this._resultPaser.RouteInfo[e])this._resultPaser.RouteInfo[e](a,b.directions)}},Direction:function(a,
b){var c={},d=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);c.direction=d;c.nextID=a.getAttribute("nextID");c.nextItem=a.getAttribute("nextItem");b.push(c)}},Routes:{Route:function(a,b){for(var c=a.childNodes,d={},e=0;e<c.length;e++){var a=c[e],f=a.nodeName;this._resultPaser.Routes[f]&&this._resultPaser.Routes[f].apply(this,[a,d])}b.push(d)},Item:function(a,b){if(!GeoGlobe.Util.isArray(b.items))b.items=[];var c=a.childNodes,d=a.getAttribute("id"),e={};d&&(e={id:d});for(d=0;d<c.length;d++){var a=
c[d],f=a.nodeName;this._resultPaser.Routes[f]&&this._resultPaser.Routes[f].apply(this,[a,e])}b.items.push(e)},Distance:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);b.distance=c},Name:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);if(c)b.name=c},Length:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);b.length=c},Direction:function(a,b){var c={},d=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,
[a]);c.direction=d;c.nextID=a.getAttribute("nextID");c.nextItem=a.getAttribute("nextItem");b.direction=c},Geometry:function(a,b){var c=GeoGlobe.Format.XML.prototype.getElementsByTagNameNS(a,"*","LineString")[0];if(c&&(c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[c]),typeof c==="string"&&c.length>0)){for(var c=c.split(" "),d=[],e=0,f=c.length;e<f;e++){var g=c[e].split(",");d.push(new GeoGlobe.Geometry.Point(new Number(g[0]),new Number(g[1])))}c=new GeoGlobe.Geometry.LineString(d);b.geometry=
c}},Duration:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);b.duration=c},BoundingBox:function(a,b){for(var c=a.childNodes,d=0;d<c.length;d++){var a=c[d],e=a.nodeName;this._resultPaser.Routes[e]&&this._resultPaser.Routes[e].apply(this,[a,b])}},LowerCorner:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]).replace(/^\s*|\s*$/g,""),c=c.replace(/\s*,\s*/g,","),c=c.split(",");b.left=c[0];b.bottom=c[1]},UpperCorner:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,
[a]).replace(/^\s*|\s*$/g,""),c=c.replace(/\s*,\s*/g,","),c=c.split(",");b.right=c[0];b.top=c[1];b.bounds=new GeoGlobe.LngLatBounds(new GeoGlobe.LngLat(b.left,b.bottom),new GeoGlobe.LngLat(b.right,b.top));delete b.left;delete b.bottom;delete b.right;delete b.top},Count:function(a,b){var c=GeoGlobe.Format.XML.prototype.getChildValue.apply(this,[a]);b.count=c}}}});
GeoGlobe.Query.RoutesResult=GeoGlobe.Class4OL({data:null,routes:null,initialize:function(a){this.routes=[];var b=null;if(a&&a.routes)this.data=a,b=a.routes;if(GeoGlobe.Util.isArray(b))for(var a=0,c=b.length;a<c;a++){var d=new GeoGlobe.Query.RouteResult,e;for(e in b[a])d[e]=b[a][e];this.routes.push(d)}},CLASS_NAME:"GeoGlobe.Query.RoutesResult"});GeoGlobe.Query.RouteResult=GeoGlobe.Class4OL({bounds:null,count:null,distance:null,duration:null,geometry:null,items:null,initialize:function(){},CLASS_NAME:"GeoGlobe.Query.RouteResult"});
GeoGlobe.Query.RouteInfoResult=GeoGlobe.Class4OL({data:null,items:null,initialize:function(a){this.items=[];if(a&&a.items){this.data=a;var b=a.items}if(GeoGlobe.Util.isArray(b))for(var a=0,c=b.length;a<c;a++){var d=new GeoGlobe.Query.RouteInfoItem,e;for(e in b[a])d[e]=b[a][e];this.items.push(d)}},CLASS_NAME:"GeoGlobe.Query.RouteInfoResult"});GeoGlobe.Query.RouteInfoItem=GeoGlobe.Class4OL({id:null,name:null,toll:null,length:null,geometry:null,level:null,directions:null,initialize:function(){},CLASS_NAME:"GeoGlobe.Query.RouteInfoItem"});
GeoGlobe.Query.BusQuery=GeoGlobe.Class4OL(GeoGlobe.Query.Service,{networkName:null,transferScheme:null,initialize:function(a,b,c){this.name=a;this.url=b;GeoGlobe.Util.extend(this,c)},getCapabilities:function(a,b){typeof b!="function"&&(b=function(){alert("\u516c\u4ea4\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+this.url+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});
GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities"},scope:this,async:!1,success:function(b){typeof a=="function"&&a(b)},failure:b})},isExist:function(){var a=!1;GeoGlobe.Request.GET({url:this.url,scope:this,async:!1,success:function(){a=!0}});return a},queryStation:function(a,b,c){var d={REQUEST:"QueryStation"};if(!a.networkName)throw"Error!Not network name for bus query.";d.NETWORKNAME=a.networkName;if(a.stationId!==null&&a.stationId!==void 0)d.STATIONID=a.stationId;if(a.stationName!==
null&&a.stationName!==void 0)d.STATIONNAME=a.stationName;if(a.lineId!==null&&a.lineId!==void 0)d.LINEID=a.lineId;if(a.lineName!==null&&a.lineName!==void 0)d.LINENAME=a.lineName;if(a.coordinate!==null&&a.coordinate!==void 0)d.COORDINATE=a.coordinate;if(a.bbox!==null&&a.bbox!==void 0)d.BOX=a.bbox;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._parserFeatures(a.responseText);b(a)},failure:c})},queryLine:function(a,b,c){var d={REQUEST:"QueryLine"};if(!a.networkName)throw"Error!Not network name for bus query.";
d.NETWORKNAME=a.networkName;if(a.lineName!==null&&a.lineName!==void 0)d.LINENAME=a.lineName;if(a.lineId!==null&&a.lineId!==void 0)d.LINEID=a.lineId;if(a.stationName!==null&&a.stationName!==void 0)d.STATIONNAME=a.stationName;if(a.stationId!==null&&a.stationId!==void 0)d.STATIONID=a.stationId;if(a.coordinate!==null&&a.coordinate!==void 0)d.COORDINATE=a.coordinate;if(a.bbox!==null&&a.bbox!==void 0)d.BOX=a.bbox;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,success:function(a){a=this._parserFeatures(a.responseText);
b(a)},failure:c})},queryChange:function(a,b,c){var d={REQUEST:"QueryChange"};if(!a.networkName)throw"Error!Not network name for bus query.";d.NETWORKNAME=a.networkName;if(a.startStationId!==null&&a.startStationId!==void 0)d.STARTSTATIONID=a.startStationId;if(a.endStationId!==null&&a.endStationId!==void 0)d.ENDSTATIONID=a.endStationId;if(a.orderType!==null&&a.orderType!==void 0)d.ORDERTYPE=a.orderType;if(a.startCoordinate!==null&&a.startCoordinate!==void 0)d.STARTCOORDINATE=a.startCoordinate;if(a.endCoordinate!==
null&&a.endCoordinate!==void 0)d.ENDCOORDINATE=a.endCoordinate;if(a.maxDepth!==null&&a.maxDepth!==void 0)d.MAXDEPTH=a.maxDepth;if(a.maxCost!==null&&a.maxCost!==void 0)d.MAXCOST=a.maxCost;if(a.maxSolutions!==null&&a.maxSolutions!==void 0)d.MAXSOLUTIONS=a.maxSolutions;if(a.ChangeCount!==null&&a.ChangeCount!==void 0)d.CHANGECOUNT=a.ChangeCount;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,success:function(a){for(var c=[],a=(a.responseXML.documentElement?a.responseXML:format.read(a.responseText)).selectNodes("/Features/FeatureCollection"),
d=new GeoGlobe.Format.XML,h=0;h<a.length;h++){var j=a[h],l=this._getAttibutionOfNode(j,["cost","price","walkingDistance","transferTimes"]),n=this._parserFeatures(d.write(a[h]));n.attributes=l;j=j.selectNodes("featureMember");for(l=0;l<j.length;l++){var o=j[l].selectNodes("Road");n[l].isOnFoot=o[0].getAttribute("isOnFoot")}c.push(n)}b(c)},failure:c})},_getAttibutionOfNode:function(a,b){var c={};if(a.tagName)for(var d=0;d<b.length;d++)c[b[d]]=a.getAttribute(b[d]);return c},_getGeometryType:function(){return"polygon"},
_pagingToString:function(a,b){b=b||this.maxPerPage;return"<numPerPage>"+b+"</numPerPage><curPage>"+(a||1)+"</curPage>"},_orderByToString:function(a){return a?"<orderBy><PropertyName>"+a+"</PropertyName></orderBy>":""},_geometryToString:function(){return'<geometry><Polygon><outerBoundaryIs><LinearRing><coordinates decimal="." cs="," ts=" ">20,30 21,41 52,42 53,33 20,30</coordinates></LinearRing></outerBoundaryIs></Polygon></geometry>'},_stringToGeometry:function(){return GeoGlobe.Geometry.Polygon.createRegularPolygon(new GeoGlobe.Geometry.Point(Math.random()*
360-160,Math.random()*90-70),Math.round(Math.random()*20),Math.round(Math.random()*10))},_parserFeatures:function(a){var b=new GeoGlobe.Format.GML;b.gmlns="*";return b.read(a)},_parserResponseText:function(a,b){if(b)var c=RegExp("</"+b+">",["g"]),a=a.replace(RegExp("<"+b+">",["g"]),"<featureMember><"+b+">"),a=a.replace(c,"</"+b+"></featureMember>");a=a.replace(/<gml:LineString>/g,"<gml:LineString><gml:coordinates>");a=a.replace(/<\/gml:LineString>/g,"</gml:coordinates></gml:LineString>");a=a.replace(/<gml:Point>/g,
"<gml:Point><gml:coordinates>");return a=a.replace(/<\/gml:Point>/g,"</gml:coordinates></gml:Point>")},_parserFeaturesNew:function(a,b){var c=new GeoGlobe.Format.GML;c.gmlns="*";if(b)c.featureName=b;return c.read(a)},_parserSuccessResult:function(a){return(new GeoGlobe.Util.Format.XML2JSON).read(a)},_parseToXML:function(a){var b=a.responseXML;if(!b||!b.documentElement)b=a.responseText;return(new GeoGlobe.Format.XML).read(b)},_parseToJSON:function(a){return(new GeoGlobe.Format.XML2JSON).read(a)},queryTransferScheme:function(a,
b,c){var d={request:"QueryTransferScheme",SERVICE:"BUS",VERSION:"1.0.0"},e={networkName:!0,transferMode:!0,startInput:!0,endInput:!0},f;for(f in e)if(!(f in a))throw Error("\u7f3a\u5c11\u5fc5\u9009\u5c5e\u6027\uff1a'"+f+"'\u3002");d.networkName=a.networkName;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.transferMode!==null&&a.transferMode!==void 0)d.TRANSFERMODE=a.transferMode;if(a.startInput!==null&&a.startInput!==void 0)d.STARTINPUT=
a.startInput;if(a.endInput!==null&&a.endInput!==void 0)d.ENDINPUT=a.endInput;if(a.inputMode!==null&&a.inputMode!==void 0)d.INPUTMODEL=a.inputMode;if(a.ExistGoTime!==null&&a.ExistGoTime!==void 0)d.EXISTGOTIME=a.ExistGoTime;if(a.StartTime!==null&&a.StartTime!==void 0)d.STARTTIME=a.StartTime;if(a.MaxSearchDistance!==null&&a.MaxSearchDistance!==void 0)d.MAXSEARCHDISTANCE=a.MaxSearchDistance;if(a.PrioritySubset!==null&&a.PrioritySubset!==void 0)d.PRIORITYSUBSET=a.PrioritySubset;if(a.ExistAbsolutePriority!==
null&&a.ExistAbsolutePriority!==void 0)d.EXISTABSOLUTEPRIORITY=a.ExistAbsolutePriority;if(a.LagSubset!==null&&a.LagSubset!==void 0)d.LAGSUBSET=a.LagSubset;if(a.OutputPage!==null&&a.OutputPage!==void 0)d.OUTPUTPAGE=a.OutputPage;if(a.PageSize!==null&&a.PageSize!==void 0)d.PAGESIZE=a.PageSize;if(a.ChangeCount!==null&&a.ChangeCount!==void 0)d.CHANGECOUNT=a.ChangeCount;GeoGlobe.Request.GET({url:this.url,params:d,async:!1,scope:this,success:GeoGlobe.Function.bind(function(a){var c=a.responseXML,d={startPoint:[],
transferScheme:[],endPoint:[]};if(!c)return b(d),d;var a=new GeoGlobe.Format.XML,e=c.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(e&&e.length>0)return b(d),d;c=c.selectNodes("/QueryTransferSchemeResponse");a=this._parseToJSON(a.write(c[0]));d=a.QueryTransferSchemeResponse.StartPoint;GeoGlobe.Util.isArray(d)||(d=[d]);c=a.QueryTransferSchemeResponse.EndPoint;GeoGlobe.Util.isArray(c)||(c=[c]);a=a.QueryTransferSchemeResponse.TransferScheme;d=this._getPointGeometryByGMLPointStr(d[0].Geometry.gml_Point);
d=new GeoGlobe.Feature(d);c=this._getPointGeometryByGMLPointStr(c[0].Geometry.gml_Point);c=new GeoGlobe.Feature(c);a=this._parserTransferScheme(a);d={startPoint:d,transferScheme:a,endPoint:c};b(d)},this),failure:c})},_parserTransferScheme:function(a){GeoGlobe.Util.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=a[c],e=this._parserSectionInfo(d.SectionInfo),d=this._parserSectionRouting(d.SectionRouting);b.push({Cost:a[c].Cost,SectionInfo:e,SectionRouting:d,TotalDistance:a[c].TotalDistance,
TransferCount:a[c].TransferCount})}return b},_parserSectionInfo:function(a){GeoGlobe.Util.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=this._getPointFeatureByObj(a[c].FromStation);if(a[c].FromStation.PassagewayRouting){var e=this._getPointFeatureByObj(a[c].FromStation.PassagewayRouting);if(e.SectionRouting)e.attributes.SectionRouting=e.data.SectionRouting=this._parserSectionRouting(e.SectionRouting);d.attributes.PassagewayRouting=d.data.PassagewayRouting=e}var f=this._getPointFeatureByObj(a[c].ToStation);
if(a[c].ToStation.PassagewayRouting){e=this._getPointFeatureByObj(a[c].ToStation.PassagewayRouting);if(e.SectionRouting)e.attributes.SectionRouting=e.data.SectionRouting=this._parserSectionRouting(e.SectionRouting);f.attributes.PassagewayRouting=f.data.PassagewayRouting=e}var e=this._parserSectionLines(a[c].SectionLines.SectionLine),g=this._parserSectionRouting(a[c].SectionRouting);b.push({FromStation:d,SectionLine:e,ToStation:f,SectionRouting:g})}return b},_parserSectionLines:function(a){GeoGlobe.Util.isArray(a)||
(a=[a]);for(var b=[],c=0;c<a.length;c++){var d=new GeoGlobe.Feature(null,a[c]);b.push(d)}return b},_parserSectionRouting:function(a){GeoGlobe.Util.isArray(a)||(a=[a]);for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b},_getPointGeometryByGMLPointStr:function(a){a=a.split(",");return new GeoGlobe.Geometry.Point(parseFloat(a[0]),parseFloat(a[1]))},_getPointFeatureByObj:function(a){var b=null;a.Geometry&&a.Geometry.gml_Point&&(b=this._getPointGeometryByGMLPointStr(a.Geometry.gml_Point));return new GeoGlobe.Feature(b,
a)},_getLineGeometryByGMLLineStr:function(a){if(!a)return null;for(var a=a.split(" "),b=[],c=0,d=a.length;c<d;c++){var e=this._getPointGeometryByGMLPointStr(a[c]);b.push(e)}return new GeoGlobe.Geometry.LineString(b)},queryTransferGeometry:function(a,b,c){var d={request:"QueryTransferGeometry",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.parameterInfo===null||a.parameterInfo===void 0||a.parameterInfo==="")throw"Error!Not parameterInfo for bus query.";
d.networkName=a.networkName;d.PARAMETERINFO="";for(var e=0;e<a.parameterInfo.length;e++)d.PARAMETERINFO+=a.parameterInfo[e].toString(),e!=a.parameterInfo.length-1&&(d.PARAMETERINFO+="_");if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,async:!1,success:GeoGlobe.Function.bind(function(a){a=this._parseQueryTransferGeometryResult(a);b(a)},this),failure:c})},_parseQueryTransferGeometryResult:function(a){resXML=
a.responseXML;a=[];if(!resXML)return a;var b=new GeoGlobe.Format.XML,c=resXML.selectNodes("/QueryTransferGeometryResponse");if(c&&c.length<=0)return a;if(b=this._parseToJSON(b.write(c[0])).QueryTransferGeometryResponse.SectionGeometry){GeoGlobe.Util.isArray(b)||(b=[b]);for(c=0;c<b.length;c++){var d=this._getLineGeometryByGMLLineStr(b[c].Geometry.gml_LineString),d=new GeoGlobe.Feature(d,{ID:b[c].ID});a.push(d)}}return a},queryKeyWord:function(a,b,c){var d={REQUEST:"QueryKeyWord",SERVICE:"BUS",VERSION:"1.0.0",
SEARCHTYPE:2};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.keyWord===null||a.keyWord===void 0||a.keyWord==="")throw"Error!Not keyWord for bus query.";d.NETWORKNAME=a.networkName;d.KEYWORD=a.keyWord;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.searchType!==null&&a.searchType!==void 0)d.SEARCHTYPE=a.searchType;if(a.keyWordType!==null&&a.keyWordType!==void 0)d.KEYWORDTYPE=a.keyWordType;GeoGlobe.Request.GET({url:this.url,
params:d,async:!1,scope:this,success:GeoGlobe.Function.bind(function(c){c=this._parserQueryKeyWordResult(c,a.keyWordType);b(c)},this),failure:c})},_parserQueryKeyWordResult:function(a,b){var c=a.responseXML,d=[];if(!c)return d;var e=new GeoGlobe.Format.XML,f=c.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage");if(f&&f.length>0)return d;c=c.selectNodes("/QueryKeyWordResponse");e=this._parseToJSON(e.write(c[0]));if(b===1){(f=e.QueryKeyWordResponse.Stations.Station)&&!GeoGlobe.Util.isArray(f)&&
(f=[f]);for(e=0;e<f.length;e++)c=this._getPointFeatureByObj(f[e]),d.push(c)}else if(b===2){(f=e.QueryKeyWordResponse.Passageways.Passageway)&&!GeoGlobe.Util.isArray(f)&&(f=[f]);for(e=0;e<f.length;e++)c=this._getPointFeatureByObj(f[e]),d.push(c)}else{(c=e.QueryKeyWordResponse.Lines.Line)&&!GeoGlobe.Util.isArray(c)&&(c=[c]);for(e=0;e<c.length;e++)f=new GeoGlobe.Feature(null,c[e]),d.push(f)}return d},queryStationInfo:function(a,b,c){var d={REQUEST:"QueryStationInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";
if(a.stationId===null||a.stationId===void 0||a.stationId==="")throw"Error!Not stationId for bus query.";d.NETWORKNAME=a.networkName;if(a.service!==null&&a.service!==void 0)d.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.stationId!==null&&a.stationId!==void 0)d.STATIONID=a.stationId;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,success:function(a){if(resXML=a.responseXML){for(var c=new GeoGlobe.Format.XML,a=this._parserQueryStationInfoNode("Lines",c,resXML),
c=this._parserQueryStationInfoNode("Passageways",c,resXML),d=[],h=0;h<c.length;h++){var j=this._getPointFeatureByObj(c[h]);d.push(j)}a={lines:a,passageways:d}}else a={lines:[],passageways:[]};b(a)},failure:c})},_parserQueryStationInfoNode:function(a,b,c){switch(a){case "Lines":c=c.selectNodes("/QueryStationInfoResponse/StationInfo/Lines");a=[];if(c.length>0)b=b.write(c[0]),b=this._parseToJSON(b),a=b.Lines.Line,GeoGlobe.Util.isArray(a)||(a=[a]);return a;case "Passageways":c=c.selectNodes("/QueryStationInfoResponse");
a=[];if(c.length>0&&(b=b.write(c[0]),b=this._parseToJSON(b),b=b.QueryStationInfoResponse.StationInfo.Passageways))a=b.Passageway,GeoGlobe.Util.isArray(a)||(a=[a]);return a;default:return[]}},queryLineInfo:function(a,b,c){var d={REQUEST:"QueryLineInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.lineId===null||a.lineId===void 0||a.lineId==="")throw"Error!Not lineId for bus query.";d.NETWORKNAME=a.networkName;if(a.service!==null&&a.service!==void 0)d.SERVICE=
a.service;if(a.version!==null&&a.version!==void 0)d.VERSION=a.version;if(a.lineId!==null&&a.lineId!==void 0)d.LINEID=a.lineId;if(a.startNodeNumber!==null&&a.startNodeNumber!==void 0)d.STARTNODENUMBER=a.startNodeNumber;if(a.endNodeNumber!==null&&a.endNodeNumber!==void 0)d.ENDNODENUMBER=a.endNodeNumber;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,success:function(a){var c=[],d=null;if(a.responseXML){d=a.responseXML;if((a=d.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage"))&&a.length>
0){b(c);return}c=this._parserQueryLineInfoNode("Line",new GeoGlobe.Format.XML,d);d=[];for(a=0;a<c.length;a++){for(var h=[],j=0;j<c[a].VIAStations.Station.length;j++){var l=this._getPointFeatureByObj(c[a].VIAStations.Station[j]);h.push(l)}c[a].Stations=h;h=this._getLineGeometryByGMLLineStr(c[a].Geometry.gml_LineString);h=new GeoGlobe.Feature(h,c[a]);d.push(h)}c=d}b(c)},failure:c})},_parserQueryLineInfoNode:function(a,b,c){switch(a){case "Line":return a=c.selectNodes("/QueryLineInfoResponse"),b=this._parseToJSON(b.write(a[0])).QueryLineInfoResponse.Line,
a=[],a=b&&!GeoGlobe.Util.isArray(b)?[b]:b;default:return[]}},queryPassagewayInfo:function(a,b){var c={REQUEST:"QueryPassagewayInfo",SERVICE:"BUS",VERSION:"1.0.0"};if(!a.networkName)throw"Error!Not network name for bus query.";if(a.passagewayId===null||a.passagewayId===void 0||a.passagewayId==="")throw"Error!Not passagewayId for bus query.";c.NETWORKNAME=a.networkName;if(a.service!==null&&a.service!==void 0)c.SERVICE=a.service;if(a.version!==null&&a.version!==void 0)c.VERSION=a.version;if(a.passagewayId!==
null&&a.passagewayId!==void 0)c.PASSAGEWAYID=a.passagewayId;GeoGlobe.Request.GET({url:this.url,params:c,scope:this,success:function(a){var c=a.responseXML,f=[];if(!c)return b(f),f;new GeoGlobe.Format.XML;if((c=c.selectNodes("/ServiceExceptionReport/ServiceExceptionMessage"))&&c.length>0)return b(f),f;f=this._parserFeaturesNew(this._parserResponseText(a.responseText),"Stations");b(f)}})},_queryByName:function(a,b,c){var d=this,e=null;d.queryKeyWord({networkName:d.networkName,keyWord:a,keyWordType:1,
SEARCHTYPE:2},function(a){if(a.length==0)alert("\u6ca1\u6709\u67e5\u8be2\u5230\u8d77\u70b9");else{var g=a[0].geometry.x+" "+a[0].geometry.y;d.queryKeyWord({networkName:d.networkName,keyWord:b,keyWordType:1,SEARCHTYPE:2},function(a){a.length==0?alert("\u6ca1\u6709\u67e5\u8be2\u5230\u7ec8\u70b9"):e=d._queryTransferScheme(g,a[0].geometry.x+" "+a[0].geometry.y,c)})}});return e},queryBus:function(a,b,c){var d=this,e=null;d.getCapabilities(GeoGlobe.Function.bind(function(f){var g=f.responseXML;if(!g||!g.documentElement)g=
f.responseText;f=(new GeoGlobe.Format.BusCapabilities).read(g);f.capability?(d.networkName=f.capability.networks[0],e=typeof a=="string"&&typeof b=="string"?d._queryByName(a,b,c):d._queryTransferScheme(a.lng+" "+a.lat,b.lng+" "+b.lat,c)):alert("\u516c\u4ea4\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+url+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")},
this),function(){alert("\u516c\u4ea4\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+url+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")});return{flag:e?!0:!1,featuresInfo:e}},failFn:function(){alert("\u516c\u4ea4\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+
url+"\n\u64cd\u4f5c\u7c7b\u578b\uff1aGetCapabilities")},_queryTransferScheme:function(a,b,c){this.queryTransferScheme({networkName:this.networkName,transferMode:c?c:0,inputMode:0,startInput:a,endInput:b},function(a){featuresInfo=a});this.transferScheme=featuresInfo.transferScheme;return featuresInfo},queryBusTransferSchemeByIndex:function(a){var b=null,a=this.transferScheme[parseInt(a)].SectionInfo,c=[],d=[];for(i=0;i<a.length;i++){var e=a[i].SectionLine[0];c.push([0,e.data.ID,e.data.FromOrdinal,
e.data.ToOrdinal]);d.push(a[i].FromStation);d.push(a[i].ToStation)}this.queryTransferGeometry({networkName:this.networkName,parameterInfo:c},function(a){var c=new GeoGlobe.Format.GeoJSON,e=c.write(a),c=c.write(d),j=new GeoGlobe.Format.JSON,e=j.read(e),c=j.read(c);b={lineFeatures:a,geojsonRoute:e,stationFeatures:d,geojsonStation:c}});return b},CLASS_NAME:"GeoGlobe.Query.BusQuery"});
(function(){if(document.implementation.hasFeature("XPath","3.0"))XMLDocument.prototype.selectNodes=function(a,b){b||(b=this);for(var c=this.evaluate(a,b,function(a){return{csw:"http://www.opengis.net/cat/csw",smmd:"http://data.sbsm.gov.cn/smmd/2007",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",geoglobe:"http://www.geostar.com.cn/geoglobe"}[a]||null},XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),d=[],e=0;e<c.snapshotLength;e++)d[e]=c.snapshotItem(e);return d},Element.prototype.selectNodes=
function(a){if(this.ownerDocument.selectNodes)return this.ownerDocument.selectNodes(a,this);else throw"For XML Elements Only";};if(document.implementation.hasFeature("XPath","3.0"))XMLDocument.prototype.selectSingleNode=function(a,b){b||(b=this);var c=this.selectNodes(a,b);return c.length>0?c[0]:null},Element.prototype.selectSingleNode=function(a){if(this.ownerDocument.selectSingleNode)return this.ownerDocument.selectSingleNode(a,this);else throw"For XML Elements Only";}})();
GeoGlobe.Query.WFSQuery=GeoGlobe.Class4OL({url:null,version:"1.0.0",featureNS:null,isReverse:!1,featurePrefix:"",featureType:"",maxFeatures:10,filter:null,geometryName:"the_geom",protocol:null,format:null,formatOptions:null,isSeparate:!1,srsName:"EPSG:4326",time:null,userecent:!0,sortBy:null,groupBy:null,resultType:"Results",startPosition:null,initialize:function(a,b,c){this.url=a;this.featureType=b;a=null;if(c)c.isReverse===!0?(this.isReverse=c.isReverse,a=!c.isReverse):c.isReverse===!1?(this.isReverse=
c.isReverse,a=!c.isReverse):a=!this.isReverse,c.format?(c.format instanceof GeoGlobe.Format.GML.v2||c.format instanceof GeoGlobe.Format.GML.v3)&&c.format.setFeatureType_(b):this.format=new GeoGlobe.Format.GML({xy:a});GeoGlobe.Util.extend(this,c)},query:function(a,b,c){this.protocol=new GeoGlobe.Protocol.WFS({readFormat:this.format,formatOptions:this.formatOptions,propertyNames:this.propertyNames,maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,
geometryName:this.geometryName,featureType:this.featureType,time:this.time,userecent:this.userecent,srsName:this.srsName});var a=a||this.filter,d=b||this.successFn,e=c||this.failFn,b=GeoGlobe.Function.bind(function(a){if(a.success()){var b=a.features;this.isSeparate&&(b=this._separateFeatures(b));(a=this._read_trueName(a))&&(b.trueNames=a);a=(new GeoGlobe.Format.GeoJSON).write(b);a=(new GeoGlobe.Format.JSON).read(a);d({features:b,geojson:a})}else e()},this);this.response=this.protocol.read({sortBy:this.sortBy,
filter:a,callback:b})},queryPage:function(a,b,c,d){var e=d&&d.perPageNumber||15;this.protocol=new GeoGlobe.Protocol.WFS({readFormat:this.format,multi:!0,formatOptions:this.formatOptions,propertyNames:this.propertyNames,maxFeatures:e,startPosition:((d&&d.pageNumber||1)-1)*e+1,featurePrefix:this.featurePrefix,url:this.url,featureNS:this.featureNS,version:this.version,geometryName:this.geometryName,featureType:this.featureType,time:this.time,userecent:this.userecent,srsName:this.srsName});var a=a||this.filter,
f=b||this.successFn,g=c||this.failFn,b=GeoGlobe.Function.bind(function(a){if(a.success()){var b=a.features;this.isSeparate&&(b=this._separateFeatures(b));a=this._read_trueName(a);b.trueNames=a;a=(new GeoGlobe.Format.GeoJSON).write(b);a=(new GeoGlobe.Format.JSON).read(a);f({features:b,geojson:a})}else g()},this);this.response=this.protocol.read({sortBy:this.sortBy,filter:a,callback:b})},queryTotalNumber:function(a,b,c){var d=new GeoGlobe.Format.WFSHits;this.protocol=new GeoGlobe.Protocol.WFS({readFormat:d,
propertyNames:this.propertyNames,resultType:"hits",maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,geometryName:this.geometryName,featureType:this.featureType,time:this.time,userecent:this.userecent});var a=a||this.filter,e=b||this.successFn,f=c||this.failFn,b=GeoGlobe.Function.bind(function(a){a.success()?e(a.features):f()},this);this.response=this.protocol.read({filter:a,callback:b})},_read_trueName:function(a){var b=[];if(a.priv&&
a.priv.responseText){if(null==this.format)return null;a=this.format.getXMLDoc().getElementsByTagName("trueName");if(a==null||a.length==0)return null;for(var c=0;c<a.length;c++)b.push(a[c].text)}return b},getBufferRegion:function(a,b,c){var d=this._getFeaturesCenter(a);switch(c){case "km":b*=1E3;case "m":b=this._meterToDegree(b,d)}return GeoGlobe.Geometry.Polygon.createRegularPolygon(a.geometry,b,40,360)},_getFeaturesCenter:function(a){return this._getFeaturesExtent(a).getCenterLonLat()},_getFeaturesExtent:function(a){GeoGlobe.Util.isArray(a)||
(a=[a]);var b=null;if(a&&a.length>0)for(var b=new GeoGlobe.LngLatBounds,c=null,d=0,e=a.length;d<e;d++)(c=a[d].geometry)&&b.extend(c.getBounds());return b},_meterToDegree:function(a,b){return a*(8.99E-6/Math.cos(GeoGlobe.Util.rad(b.lat)))},pointQuery:function(a,b,c,d,e){this.query(new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.DWITHIN,property:this.geometryName,distance:b||0,distanceUnits:c||"degree",value:a}),d,e)},pathQuery:function(a,b,c,d,e){this.query(new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.DWITHIN,
property:this.geometryName,distance:b||0,distanceUnits:c||"degree",value:a}),d,e)},polygonQuery:function(a,b,c,d){this.query(new GeoGlobe.Filter.Spatial({type:b?GeoGlobe.Filter.Spatial.CONTAINS:GeoGlobe.Filter.Spatial.INTERSECTS,property:this.geometryName,value:a}),c,d)},bboxQuery:function(a,b,c){this.query(new GeoGlobe.Filter.Spatial({type:GeoGlobe.Filter.Spatial.BBOX,property:this.geometryName,value:a}),b,c)},attributeQuery:function(a,b,c,d,e,f){this.query(new GeoGlobe.Filter.Comparison({type:a,
property:b,value:c,matchCase:d&&d.matchCase,lowerBoundary:d?d.lowerBoundary:null,upperBoundary:d?d.upperBoundary:null}),e,f)},statisticsQuery:function(a,b,c){this.protocol=new GeoGlobe.Protocol.WFS({readFormat:this.format,formatOptions:this.formatOptions,propertyNames:this.propertyNames,resultType:"statistics",maxFeatures:this.maxFeatures,featurePrefix:this.featurePrefix,featureNS:this.featureNS,url:this.url,version:this.version,geometryName:this.geometryName,featureType:this.featureType,time:this.time,
userecent:this.userecent});var a=a||this.filter,d=b||this.successFn,e=c||this.failFn,b=GeoGlobe.Function.bind(function(a){if(a.success()){try{var b=this._analysis_StatisticsResult(a.priv.responseXML)}catch(c){d(a.priv.responseText);return}d(b)}else e()},this);this.response=this.protocol.read({sortBy:this.sortBy,groupBy:this.groupBy,filter:a,callback:b})},_analysis_StatisticsResult:function(a){var b={},a=a.documentElement.firstChild.childNodes;if(0<a.length)b.layers=this._analysis_StatisticsResult_results(a);
return b},_analysis_StatisticsResult_results:function(a){for(var b=[],c=0;c<a.length;c++){for(var d={},e=[],f=a[c].childNodes,g=0;g<f.length;g++){var h={};h.layerName=f[g].parentNode.nodeName;h.result=navigator.appName=="Microsoft Internet Explorer"?this._analysis_StatisticsResult_results_result_IE(f[g]):this._analysis_StatisticsResult_results_result_google(f[g]);e.push(h)}d.results=e;b.push(d)}return b},_analysis_StatisticsResult_results_result_IE:function(a){var b={},c=0;if("Key"==a.childNodes[0].nodeName)b.Key=
a.childNodes[0].text,c=1;for(var d=[],e=[];c<a.childNodes.length;c++){var f={},g={};f.name=a.childNodes[c].getAttribute("name");g.Value=a.childNodes[c].text;d.push(f);e.push(g)}b.name=d;b.values=e;return b},_analysis_StatisticsResult_results_result_google:function(a){var b={},c=0;if("Key"==a.childNodes[0].nodeName)b.Key=a.childNodes[0].innerHTML,c=1;for(var d=[],e=[];c<a.childNodes.length;c++){var f={},g={};f.name=a.childNodes[c].getAttribute("name");g.Value=a.childNodes[c].innerHTML;d.push(f);e.push(g)}b.name=
d;b.values=e;return b},successFn:function(){},failFn:function(){alert("\u5bf9\u4e0d\u8d77,\u67e5\u8be2\u5931\u8d25,\u8bf7\u67e5\u8be2\u670d\u52a1\u662f\u5426\u6b63\u5e38\u3002")},_separateFeatures:function(a){for(var b={},c=0;c<a.length;c++){var d=a[c],e;e=d.gml?d.gml.featureType:d.type;b[e]||(b[e]=[]);b[e].push(d)}return b},setTime:function(a){this.time=a},setUserecent:function(a){this.userecent=a},CLASS_NAME:"GeoGlobe.Query.WFSQuery"});
GeoGlobe.Query.WFSQuery.reverseGeometryXY=function(a){var b={Point:function(a){var b=a.x,e=a.y,a=a.clone(a);a.x=e;a.y=b;return a},LineString:function(a,b){for(var e=a.clone(a),f=0;f<e.components.length;f++){var g=b.Point(e.components[f]);e.components[f]=g}return e},Polygon:function(a,b){for(var e=a.clone(a),f=0;f<e.components.length;f++)for(var g=0;g<e.components[f].components.length-1;g++){var h=b.Point(e.components[f].components[g]);e.components[f].components[g]=h}return e}};return b[{"GeoGlobe.Geometry.Point":"Point",
"GeoGlobe.Geometry.MultiPoint":"MultiPoint","GeoGlobe.Geometry.LineString":"LineString","GeoGlobe.Geometry.MultiLineString":"MultiLineString","GeoGlobe.Geometry.Polygon":"Polygon","GeoGlobe.Geometry.MultiPolygon":"MultiPolygon","GeoGlobe.Geometry.Collection":"GeometryCollection"}[a.CLASS_NAME]](a,b)};
GeoGlobe.Format.WFSHits=GeoGlobe.Class4OL(GeoGlobe.Format.XML,{wfsns:"http://www.opengis.net/wfs",featureCollection:"FeatureCollection",read:function(a){typeof a=="string"&&(a=GeoGlobe.Format.XML.prototype.read.apply(this,[a]));return{numberOfFeatures:parseInt(a.documentElement.getAttribute("numberOfFeatures"))}}});
GeoGlobe.Query.GeoCodingQuery=function(a,b){var b=GeoGlobe.Util.applyDefaults(b,GeoGlobe.Query.GeoCodingQuery.DEFAULTS),c=GeoGlobe.Query.GeoCodingQuery["v"+b.version.replace(/\./g,"_")];if(!c)throw"\u4e0d\u652f\u6301\u7684\u5730\u5740\u5339\u914d\u670d\u52a1\u7248\u672c: "+b.version;return new c(a,b)};GeoGlobe.Query.GeoCodingQuery.DEFAULTS={version:"1.0.0"};
GeoGlobe.Query.GeoCodingQuery.v1=GeoGlobe.Class4OL({version:"1.0.0",url:null,initialize:function(a,b){this.url=a;GeoGlobe.Util.extend(this,b);this.format=new GeoGlobe.Format.JSON},getCommonParams:function(a){var b={request:"GetCategory",service:"GeoCoding",version:this.version,output:"json"};GeoGlobe.Util.extend(b,a);return b},getCategoryByName:function(a,b,c){var d=this.getCommonParams();if(typeof a==="string"&&a.length!==0)d.categoryName=a;c=c||this.failFn;GeoGlobe.Function.bind(this._requestCategory,
this)(d,b,c)},getCategoryByCode:function(a,b,c){var d=this.getCommonParams();if(typeof a==="number")d.categoryCode=a;GeoGlobe.Function.bind(this._requestCategory,this)(d,b,c)},getAllCategory:function(a,b){var c=this.getCommonParams();GeoGlobe.Function.bind(this._requestCategory,this)(c,a,b)},_requestCategory:function(a,b,c){c=c||this.failFn;GeoGlobe.loadURL(this.url,a,this,function(a){try{var c=this.format.read(a.responseText)}catch(f){b(a.responseText);return}b(c)},c)},_analysis_GeoCodeResult:function(a){var b=
{status:a.status};switch(a.status){case "OK":if(a=a.results)b.results=this._analysis_GeoCodeResult_results(a);break;case "INVALID_REQUEST":break;case "NO_RESULTS":break;case "UNKNOWN_ERROR":break;default:if(b={requestKeyWord:a.requestKeyWord,count:a.count,statisticsLevel:a.statisticsLevel,statisticsLevelName:a.statisticsLevelName},a&&a.count>0&&(a=a.results))b.results=this._analysis_GeoCodeResult_statistics(a)}return b},_analysis_GeoCodeResult_results:function(a){var b=[];if(GeoGlobe.Util.isArray(a)){for(var c=
0,d=a.length;c<d;c++){var e={};e.requestKeyWord=a[c].requestKeyWord;if(a[c].errorCorrectionTips)e.errorCorrectionTips=a[c].errorCorrectionTips;e.count=a[c].count;if(a[c].result)e.result=this._analysis_GeoCodeResult_results_result(a[c].result);b.push(e)}return b}},_analysis_GeoCodeResult_statistics:function(a){var b=[];if(GeoGlobe.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){var e={};if(a[c].errorCorrectionTips)e.errorCorrectionTips=a[c].errorCorrectionTips;if(a[c])e.name=a[c].name,e.value=a[c].value,
e.remark=a[c].remark;b.push(e)}return b}},_analysis_GeoCodeResult_results_result:function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e={},f={};e.resultType=a[c].resultType;e.precise=a[c].precise;e.isBrief=a[c].isBrief;e.score=a[c].score;if(a[c].addressComponent.street)f=a[c].addressComponent.street;if(e.isBrief==!1)e.addressComponent=this._analysis_GeoCodeResult_results_result_address(a[c].addressComponent,e.resultType);e.poiArray=this._analysispoiArray(a[c].poiArray);if(a[c].location)e.location=
a[c].location;if(e.precise==0)e.referenceAddressArray=a[c].referenceAddressArray;if(f)e.street_path=f;b.push(e)}return b},_analysis_GeoCodeResult_results_result_address:function(a,b){var c={country:a.country};if(a.province)c.province=a.province;if(a.city)c.city=a.city;if(a.district)c.district=a.district;if(a.town)c.town=a.town;if(a.street&&(c.street={name:a.street.name},b==="street"&&a.street.geometry)){var d=this.format.read(a.street.geometry),e=null;if(d.paths)e=this._getGeometry(d),c.street.geometry=
e;else if(d.rings)e=this._getGeometry(d),c.street.geometry=e;else if(d.x&&d.y)e=this._getGeometry(d),c.street.geometry=e}if(a.streetNumber)c.streetNumber=a.streetNumber;if(a.buildingNumber)c.buildingNumber=a.buildingNumber;if(b==="adminArea"){if(a.geometry)if(d=this.format.read(a.geometry),e=null,d.rings)e=this._getGeometry(d),c.geometry=e;else if(d.paths)e=this._getGeometry(d),c.geometry=e;else if(typeof d.x==="number"&&typeof d.y==="number")c.geometry=this._getGeometry(d);if(a.subordinate)c.subordinate=
a.subordinate;if(a.zipCode)c.zipCode=a.zipCode;if(a.callingCode)c.callingCode=a.callingCode}return c},_analysispoiArray:function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e={},f;for(f in a[c])e[f]=a[c][f];if(""!=e.geometry&&void 0!=e.geometry){var g=this.format.read(e.geometry);e.geometry=this._getGeometry(g)}b.push(e)}return b},_analysisLocation:function(){},_getGeometry:function(a){for(var b in a){if("spatialReference"==b)break;return a=a.hasOwnProperty("x")&&a.hasOwnProperty("y")?new GeoGlobe.Geometry.Point(a.x,
a.y):a.hasOwnProperty("xmin")&&a.hasOwnProperty("ymin")&&a.hasOwnProperty("xmax")&&a.hasOwnProperty("ymax")?(new GeoGlobe.Bounds(a.xmin,a.ymin,a.xmax,a.ymax)).toGeometry():this._geometryType[b](a[b])}},_geometryType:{points:function(a){var b=[];if(GeoGlobe.Util.isArray(a))for(var c=0,d=a.length;c<d;c++){var e=new GeoGlobe.Geometry.Point(a[c][0],a[c][1]);b.push(e)}return b},paths:function(a){var b=[];if(GeoGlobe.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new GeoGlobe.Geometry.Point(a[c][f][0],
a[c][f][1]));e=new GeoGlobe.Geometry.LineString(e);b.push(e)}c=new GeoGlobe.Geometry.MultiLineString(b)}return c},rings:function(a){var b=[];if(GeoGlobe.Util.isArray(a)){for(var c=0,d=a.length;c<d;c++){for(var e=[],f=0,g=a[c].length;f<g;f++)e.push(new GeoGlobe.Geometry.Point(a[c][f][0],a[c][f][1]));e=new GeoGlobe.Geometry.LinearRing(e);b.push(e)}c=new GeoGlobe.Geometry.Polygon(b)}return c}},failFn:function(a){typeof a=="string"&&alert(a);alert("\u5bf9\u4e0d\u8d77\uff0c\u67e5\u8be2\u8bf7\u6c42\u5931\u8d25\uff01\u8bf7\u68c0\u67e5\u5730\u5740\u5339\u914d\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u3002\n\u5f53\u524d\u670d\u52a1\u5730\u5740\u4e3a\uff1a"+
this.url)},CLASS_NAME:"GeoGlobe.Query.GeoCodingQuery.v1"});
GeoGlobe.Query.GeoCodingQuery.v1_0_0=GeoGlobe.Class4OL(GeoGlobe.Query.GeoCodingQuery.v1,{addressesToLocations:function(a,b){var c=this.getCommonParams({request:"GeoCoder"});if(typeof a.address==="string")c.address=a.address;else if(GeoGlobe.Util.isArray(a.address)){for(var d="",e=0;e<a.address.length;e++)d+=a.address[e]+",";d=d.substr(0,d.length-1);c.address=d}else if(a.address==void 0||a.address==null)throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01";if(typeof a.categoryCode==="number")c.categoryCode=
a.categoryCode;if(a.extent instanceof mapboxgl.LngLatBounds)c.bbox=a.extent.toBBOX(null,!0);else if(a.extent instanceof GeoGlobe.Geometry.Polygon){for(var d=a.extent,f=[],e=0,g=d.components.length;e<g;e++)for(var h=d.components[e].components,j=0;j<h.length;j++)f.push(h[j].toShortString());c.bbox=f.join(",")}if(typeof a.fuzzyMatch==="boolean")c.fuzzyMatch=a.fuzzyMatch;if(typeof a.resultType==="string")c.resultType=a.resultType;if(typeof a.maxCount==="number")c.maxCount=a.maxCount;if(typeof a.startPosition===
"number")c.startPosition=a.startPosition;GeoGlobe.loadURL(this.url,c,this,function(a){try{var d=this.format.read(a.responseText),e=c.resultType=="result"?this._parseQueryResultToFeature(d):this._analysis_GeoCodeResult(d)}catch(f){b(a.responseText);return}b(e)},this.failFn)},locationToAddresses:function(a,b){var c=this.getCommonParams({request:"GeoCoder"});if(a.lonlat)c.latlng=a.lonlat.lat+","+a.lonlat.lng;else throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01\u8bf7\u586b\u5199\u6b63\u786e\u7684\u6570\u636e\u7c7b\u578b\uff01";
if(typeof a.tolerance==="number")c.tolerance=a.tolerance;if(typeof a.unit==="string")c.unit=a.unit;if(typeof a.resultType==="string")c.resultType=a.resultType;if(typeof a.maxCount==="number")c.maxCount=a.maxCount;if(typeof a.startPosition==="number")c.startPosition=a.startPosition;GeoGlobe.loadURL(this.url,c,this,function(a){try{var e=this.format.read(a.responseText),f=c.resultType=="result"?this._parseQueryResultToFeature(e):this._analysis_GeoCodeResult(e)}catch(g){b(a.responseText);return}b(f,e)},
this.failFn)},getLocations:function(a,b,c){this.addressesToLocations(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,total))},this),c)},getLocationsByPage:function(a,b,c){a.resultType="hits";this.addressesToLocations(a,GeoGlobe.Function.bind(function(d){if(d.status=="OK"){a.resultType="result";var e=d.results[0].count;if(a.maxCount==void 0||a.maxCount==null)a.maxCount=3;a.startPosition=(a.startPosition-1)*a.maxCount+1;this.addressesToLocations(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,
e))},this),c)}else alert("\u6ca1\u6709\u67e5\u8be2\u5230\u4efb\u4f55\u6570\u636e")},this),c)},getAddresses:function(a,b,c){this.locationToAddresses(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,total))},this),c)},getAddressesByPage:function(a,b,c){a.resultType="hits";this.locationToAddresses(a,GeoGlobe.Function.bind(function(d){if(d.status=="OK"){a.resultType="result";var e=d.results[0].count;if(a.maxCount==void 0||a.maxCount==null)a.maxCount=3;a.startPosition=(a.startPosition-
1)*a.maxCount+1;this.locationToAddresses(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,e))},this),c)}else alert("\u6ca1\u6709\u67e5\u8be2\u5230\u4efb\u4f55\u6570\u636e")},this),c)},_parseQueryResultToFeature:function(a){var b=[];if(a.status=="OK"&&a.results)for(var c=0;c<a.results.length;c++){var d=a.results[c].result;if(d)for(var e=0;e<d.length;e++){var f={},g=null;f.requestKeyWord=a.results[c].requestKeyWord;if(GeoGlobe.Util.isArray(d[e].poiArray))for(var h=0;h<d[e].poiArray.length;h++)f.CONTINENT=
d[e].poiArray[h].CONTINENT,f.GBCODE=d[e].poiArray[h].GBCODE,f.STANDARDNAME=d[e].poiArray[h].STANDARDNAME,f.name=d[e].poiArray[h].name;if(d[e].addressComponent)f.address=this._getAddress(d[e].addressComponent,f.name),f.country=d[e].addressComponent.country,f.province=d[e].addressComponent.province,f.city=d[e].addressComponent.city,f.district=d[e].addressComponent.district,d[e].addressComponent.street?(f.streetName=d[e].addressComponent.street.name,f.streetgeometry=d[e].addressComponent.street.geometry):
f.streetName="",f.streetNumber=d[e].addressComponent.streetNumber;if(d[e].location){if(d[e].location.lng)f.lng=d[e].location.lng;if(d[e].location.lat)f.lat=d[e].location.lat;g=new GeoGlobe.Geometry.Point(d[e].location.lng,d[e].location.lat)}f.isBrief=d[e].isBrief;f.precise=d[e].precise;f.resultType=d[e].resultType;f.score=d[e].score;f=new GeoGlobe.Feature(g,f);b.push(f)}}c=(new GeoGlobe.Format.GeoJSON).write(b);c=(new GeoGlobe.Format.JSON).read(c);return{status:a.status,features:b,geojsonFeatures:c}},
_getAddress:function(a,b){var c="";a.country&&(c+=a.country);a.province&&(c+=a.province);a.city&&(c+=a.city);a.district&&(c+=a.district);a.street&&(a.street.name&&(c+=a.street.name),a.streetNumber&&(c+=a.streetNumber+"\u53f7"));b&&(c+=b);return c},CLASS_NAME:"GeoGlobe.Query.GeoCodingQuery.v1_0_0"});
GeoGlobe.Query.GeoCodingQuery.v1_1_0=GeoGlobe.Class4OL(GeoGlobe.Query.GeoCodingQuery.v1,{method:"get",initialize:function(a,b){GeoGlobe.Util.extend(this,b);this.filterFormat=new GeoGlobe.Format.Filter;GeoGlobe.Query.GeoCodingQuery.v1.prototype.initialize.apply(this,arguments)},addressesToLocations:function(a,b,c){var d=this.getCommonParams({request:"GeoCoder"});d.reverseMatch=!1;if(typeof a.address==="string")d.keyword=a.address;if(typeof a.categoryCode==="number")d.categoryCode=a.categoryCode;if((a.address==
void 0||a.address==null)&&(a.categoryCode==void 0||a.categoryCode==null))throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01";if(a.extent instanceof mapboxgl.LngLatBounds)d.bbox=a.extent.toBBOX(null,!0);else if(a.extent instanceof GeoGlobe.Geometry.Polygon){for(var e=a.extent,f=[],g=0,h=e.components.length;g<h;g++)for(var j=e.components[g].components,l=0;l<j.length;l++)f.push(j[l].toShortString());d.bbox=f.join(",")}if(a.filter instanceof GeoGlobe.Filter)e=this.filterFormat.write(a.filter),e=GeoGlobe.Format.XML.prototype.write.apply(this.filterFormat,
[e]),d.filter=e;if(typeof a.resultType==="string")d.resultType=a.resultType;if(a.resultType=="statistics")d.statisticsLevel=a.statisticsLevel;if(typeof a.maxCount==="number")d.maxCount=a.maxCount;if(typeof a.startPosition==="number")d.startPosition=a.startPosition;if(typeof a.semanticAnalysis==="boolean")d.semanticAnalysis=a.semanticAnalysis;if(typeof a.customWeight==="boolean")d.customWeight=a.customWeight;this._setGeoCoderCommonProperty(d,a);this._getCodingRequest(d,b,c)},_getCodingRequest:function(a,
b){if(this.method=="get")GeoGlobe.loadURL(this.url,a,this,function(c){try{var e=this.format.read(c.responseText),f=a.resultType=="result"?this._parseQueryResultToFeature(e):this._analysis_GeoCodeResult(e)}catch(g){b(c.responseText);return}b(f)},this.failFn);else{var c=GeoGlobe.Util.getParameterString(a);GeoGlobe.Request.POST({url:this.url,data:c,success:function(a){try{var c=this._analysis_GeoCodeResult(this.format.read(a.responseText))}catch(f){b(a.responseText);return}b(c)},failure:this.failFn,
scope:this})}},_setGeoCoderCommonProperty:function(a,b){if(typeof b.sortFields==="string")a.sortFields=b.sortFields;if(typeof b.scoreFilter==="string")a.scoreFilter=b.scoreFilter},locationToAddresses:function(a,b,c){var d=this.getCommonParams({request:"GeoCoder"});d.reverseMatch=!0;if(a.lonlat)d.keyword=a.lonlat.lat+","+a.lonlat.lng;else throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01\u8bf7\u586b\u5199\u6b63\u786e\u7684\u6570\u636e\u7c7b\u578b\uff01";if(typeof a.tolerance==="number")d.tolerance=
a.tolerance;if(typeof a.unit==="string")d.unit=a.unit;if(typeof a.resultType==="string")d.resultType=a.resultType;if(a.resultType=="statistics")d.statisticsLevel=a.statisticsLevel;if(typeof a.maxCount==="number")d.maxCount=a.maxCount;if(typeof a.startPosition==="number")d.startPosition=a.startPosition;if(typeof a.customWeight==="boolean")d.customWeight=a.customWeight;this._setGeoCoderCommonProperty(d,a);this._getCodingRequest(d,b,c)},batchAddressesToLocations:function(a,b,c){var d=this.getCommonParams({request:"BatchGeoCoder",
service:"GeoCoding"});d.reverseMatch=!1;if(GeoGlobe.Util.isArray(a.address)){for(var e="",f=0;f<a.address.length;f++)e+=a.address[f]+",";e=e.substr(0,e.length-1);d.keywords=e}else if(a.address==void 0||a.address==null)throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01";if(typeof a.singleKeywordResultCount==="number")d.singleKeywordResultCount=a.singleKeywordResultCount;if(a.filter instanceof GeoGlobe.Filter)e=this.filterFormat.write(a.filter),e=GeoGlobe.Format.XML.prototype.write.apply(this.filterFormat,
[e]),d.filter=e;this._setGeoCoderCommonProperty(d,a);this._getCodingRequest(d,b,c)},batchLocationToAddresses:function(a,b,c){var d=this.getCommonParams({request:"BatchGeoCoder",service:"GeoCoding"});d.reverseMatch=!0;if(a.lonlats instanceof GeoGlobe.LonLat)a.lonlats=[a.lonlats];else if(!GeoGlobe.Util.isArray(a.lonlats))throw"address\u662f\u5fc5\u9009\u53c2\u6570\uff01\u8bf7\u586b\u5199\u6b63\u786e\u7684\u6570\u636e\u7c7b\u578b\uff01";if(GeoGlobe.Util.isArray(a.lonlats)){for(var e="",f=0;f<a.lonlats.length;f++)e+=
a.lonlats[f].lat+","+a.lonlats[f].lng+";";e=e.substr(0,e.length-1);d.keywords=e}if(typeof a.tolerance==="number")d.tolerance=a.tolerance;if(typeof a.unit==="string")d.unit=a.unit;if(typeof a.singleKeywordResultCount==="number")d.singleKeywordResultCount=a.singleKeywordResultCount;this._setGeoCoderCommonProperty(d,a);this._getCodingRequest(d,b,c)},_getAddress:function(a,b){var c="";a.country&&(c+=a.country);a.province&&(c+=a.province);a.city&&(c+=a.city);a.district&&(c+=a.district);a.street&&(a.street.name&&
(c+=a.street.name),a.streetNumber&&(c+=a.streetNumber+"\u53f7"));b&&(c+=b);return c},getLocations:function(a,b,c){this.addressesToLocations(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,total))},this),c)},getLocationsByPage:function(a,b,c){a.resultType="hits";this.addressesToLocations(a,GeoGlobe.Function.bind(function(d){if(d.status=="OK"){a.resultType="result";var e=d.results[0].count;if(a.maxCount==void 0||a.maxCount==null)a.maxCount=3;a.startPosition=(a.startPosition-
1)*a.maxCount+1;this.addressesToLocations(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,e))},this),c)}else alert("\u6ca1\u6709\u67e5\u8be2\u5230\u4efb\u4f55\u6570\u636e")},this),c)},getAddresses:function(a,b,c){this.locationToAddresses(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,total))},this),c)},getAddressesByPage:function(a,b,c){a.resultType="hits";this.locationToAddresses(a,GeoGlobe.Function.bind(function(d){if(d.status=="OK"){a.resultType=
"result";var e=d.results[0].count;if(a.maxCount==void 0||a.maxCount==null)a.maxCount=3;a.startPosition=(a.startPosition-1)*a.maxCount+1;this.locationToAddresses(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a,e))},this),c)}else alert("\u6ca1\u6709\u67e5\u8be2\u5230\u4efb\u4f55\u6570\u636e")},this),c)},batchGetAddresses:function(a,b,c){this.batchLocationToAddresses(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a))},this),c)},batchGetLocations:function(a,
b,c){this.batchAddressesToLocations(a,GeoGlobe.Function.bind(function(a){b(this._parseQueryResultToFeature(a))},this),c)},_parseQueryResultToFeature:function(a){var b=[];if(a.status=="OK"&&a.results)for(var c=0;c<a.results.length;c++){var d=a.results[c].result;if(d)for(var e=0;e<d.length;e++){var f={},g=null;f.requestKeyWord=a.results[c].requestKeyWord;if(GeoGlobe.Util.isArray(d[e].poiArray))for(var h=0;h<d[e].poiArray.length;h++)f.CONTINENT=d[e].poiArray[h].CONTINENT,f.GBCODE=d[e].poiArray[h].GBCODE,
f.STANDARDNAME=d[e].poiArray[h].STANDARDNAME,f.name=d[e].poiArray[h].name;if(d[e].addressComponent)f.address=this._getAddress(d[e].addressComponent,f.name),f.country=d[e].addressComponent.country,f.province=d[e].addressComponent.province,f.city=d[e].addressComponent.city,f.district=d[e].addressComponent.district,d[e].addressComponent.street?(f.streetName=d[e].addressComponent.street.name,f.streetgeometry=d[e].addressComponent.street.geometry):f.streetName="",f.streetNumber=d[e].addressComponent.streetNumber;
if(d[e].location){if(d[e].location.lng)f.lng=d[e].location.lng;if(d[e].location.lat)f.lat=d[e].location.lat;g=new GeoGlobe.Geometry.Point(d[e].location.lng,d[e].location.lat)}f.isBrief=d[e].isBrief;f.precise=d[e].precise;f.resultType=d[e].resultType;f.score=d[e].score;f=new GeoGlobe.Feature(g,f);b.push(f)}}c=(new GeoGlobe.Format.GeoJSON).write(b);c=(new GeoGlobe.Format.JSON).read(c);return{status:a.status,features:b,geojsonFeatures:c}},CLASS_NAME:"GeoGlobe.Query.GeoCodingQuery.v1_1_0"});
GeoGlobe.HeatMap=GeoGlobe.Class4OL({map:null,size:25,intensity:0.5,initialize:function(a,b){this.heatmap=new mapboxgl.heatmap(a);a=this.map=a;b?(this.datas=b,this.setData(b)):this.datas=[];this._updataLayer=GeoGlobe.Function.bind(this.updateLayer,this);a.on("zoom",this._updataLayer);a.on("move",this._updataLayer)},addPoint:function(a,b,c){a=this.map.project([a[0],a[1]]);this.heatmap.heatmap.addPoint(a.x,a.y,b,c)},update:function(){this.heatmap.heatmap.update()},updateLayer:function(){this.setData(this.datas)},
setData:function(a){this.clear();if(this.datas=a)for(a=0;a<this.datas.length;a++)this.addPoint(this.datas[a],this.size,this.intensity)},display:function(){return this.heatmap.heatmap.display()},multiply:function(a){this.heatmap.heatmap.multiply(a)},clamp:function(a){this.heatmap.heatmap.clamp(a,a)},blur:function(){this.heatmap.heatmap.blur()},clear:function(){this.heatmap.heatmap.clear();this.datas=[]},remove:function(){this.clear();map.off("zoom",this._updataLayer);map.off("move",this._updataLayer);
this.heatmap.heatmap_canvas.parentNode.removeChild(this.heatmap.heatmap_canvas);this.map=this.heatmap=this.heatmap.heatmap_canvas=null},CLASS_NAME:"GeoGlobe.HeatMap"});
GeoGlobe.LayerGroup=GeoGlobe.Class4OL({map:null,initialize:function(){},addGroup:function(a,b,c,d){mapboxgl.LayerGroup.addGroup(a,b,c,d)},addLayerToGroup:function(a,b,c,d){mapboxgl.LayerGroup.addLayerToGroup(a,b,c,d)},removeLayerFromGroup:function(a,b,c){for(var d=a.getStyle().layers,e=0;e<d.length;e++)d[e].metadata&&d[e].metadata.group===c&&d[e].id==b&&a.removeLayer(d[e].id)},removeGroup:function(a,b){mapboxgl.LayerGroup.removeGroup(a,b)},moveGroup:function(a,b,c){mapboxgl.LayerGroup.moveGroup(a,
b,c)},getGroupFirstLayerId:function(a,b){return mapboxgl.LayerGroup.getGroupFirstLayerId(a,b)},getGroupLastLayerId:function(a,b){return mapboxgl.LayerGroup.getGroupLastLayerId(a,b)},CLASS_NAME:"GeoGlobe.LayerGroup"});
GeoGlobe.Service=GeoGlobe.Class({name:null,url:null,version:null,userid:"test@liferay.com",initialize:function(a,b,c){this.name=a;this.url=b;GeoGlobe.Util.extend(this,c)},getCapabilities:function(){},isExist:function(){},failFn:function(a){alert("\u670d\u52a1\u8bf7\u6c42\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u670d\u52a1\u662f\u5426\u6b63\u5e38\u8fd0\u884c\u6216\u8bf7\u6c42\u5730\u5740\u662f\u5426\u6b63\u786e\u3002\n\u8bf7\u6c42\u5730\u5740\uff1a"+this.url+"\n\u64cd\u4f5c\u7c7b\u578b\uff1a"+a)},_parseToXML:function(a){var b=
a.responseXML;if(!b||!b.documentElement)b=a.responseText;return(new GeoGlobe.Format.XML).read(b)},_checkIsError:function(a){if((new GeoGlobe.Format.XML).read(a).selectNodes("ServiceExceptionReport").length>0)return this._parseToJSON(a);return null},_isException:function(a){if(a&&a.ServiceExceptionReport)return!0;return!1},_parseToJSON:function(a){return(new GeoGlobe.Util.Format.XML2JSON).read(a)},CLASS_NAME:"GeoGlobe.Service"});
GeoGlobe.Service.WFST=GeoGlobe.Class4OL(GeoGlobe.Service,{xy:!0,initialize:function(){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WFS",VERSION:"1.0.0"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WFS"},scope:this,async:!1,success:function(){a=!0}});
return a},describeFeatureType:function(a,b,c){var d=this.url;GeoGlobe.Util.applyDefaults(a,{SERVICE:"WFS",VERSION:"1.0.0",REQUEST:"DescribeFeatureType"});c||(c=function(){this.failFn(a.REQUEST)});GeoGlobe.loadURL(d,a,this,function(a){b(a)},c)},getFeature:function(a,b,c){var d=this.url;GeoGlobe.Util.applyDefaults(a,{SERVICE:"WFS",VERSION:"1.0.0",REQUEST:"GetFeature"});c||(c=function(){this.failFn(a.REQUEST)});GeoGlobe.loadURL(d,a,this,function(a){b(a)},c)},lockFeature:function(a,b,c){GeoGlobe.Util.applyDefaults(a,
{service:"WFS",version:"1.0.0",request:"LockFeature",expiry:1,lockAction:"ALL"});var d=this._parserFilterToString(a.filter),d=GeoGlobe.String.format('<?xml version="1.0" encoding="UTF-8"?><LockFeature version="${version}" service="${service}" lockAction="${lockAction}" expiry="${expiry}" xmlns:wfs=" http://www.opengis.net/wfs" xmlns:gml=" http://www.opengis.net/gml" xmlns:myns=" http://www.someserver.com/myns" xmlns:ogc=" http://www.opengis.net/ogc" xmlns:xsi=" http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs ../wfs/1.1.0/WFS.xsd"><Lock typeName="${typeName}">${filterXMLString}</Lock></LockFeature>',
{version:a.version,service:a.service,lockAction:a.lockAction,expiry:a.expiry,typeName:a.typeName,filterXMLString:d});c||(c=function(){this.failFn(a.request)});new GeoGlobe.Request.POST({url:this.url,data:d,scope:this,success:b,failure:c})},transaction:function(a,b,c,d,e,f){var g=this.url;GeoGlobe.Util.applyDefaults(a,{service:"WFS",version:"1.0.0",request:"Transaction",releaseAction:"ALL"});var h=a.lockId,j="";h&&(j+="<LockId>"+h+"</LockId>");h="";b&&(h+=this._getInsertString(b));c&&(h+=this._getUpdateString(c));
d&&(h+=this._getDeleteString(d));b=GeoGlobe.String.format('<?xml version="1.0" encoding="UTF-8"?><wfs:Transaction releaseAction="${releaseAction}" handle="Transaction 01" version="${version}" service="${service}" xmlns="http://www.someserver.com/myns" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wfs="http://www.opengis.net/wfs" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">${lockIdString}${transactionString}</wfs:Transaction>',{releaseAction:a.releaseAction,
version:a.version,service:a.service,lockIdString:j,transactionString:h});f||(f=function(){this.failFn(a.request)});new GeoGlobe.Request.POST({url:g,data:b,scope:this,success:e,failure:f})},parseTransactionResult:function(a){var b=(new GeoGlobe.Format.XML2JSON).read(a.responseText),a=[],c=this._objToArray(b.wfs_WFS_TransactionResponse.wfs_TransactionResult.wfs_Status),b=this._objToArray(b.wfs_WFS_TransactionResponse.wfs_InsertResults);if(!c)return a;for(var d=0;d<c.length;d++)c[d].wfs_SUCCESS!==void 0?
a.push({status:"SUCCESS",fid:b&&b[d]?b[d].ogc_FeatureId.fid:null}):a.push({status:"FAILED",fid:null});return a},_objToArray:function(a){a&&!(a instanceof Array)&&(a=[a]);return a},_getInsertString:function(a){for(var b=a.features,a=a.typeName,c="",d=0;d<b.length;d++)c+='<wfs:Insert handle="Insert '+d+'">'+this._getInsertFeatureString(b[d],a)+"</wfs:Insert>";return c},_getInsertFeatureString:function(a,b){var c="",d;for(d in a.attributes)d!="OID"&&(c+=GeoGlobe.String.format("<${tag}><![CDATA[${value}]]\></${tag}>",
{value:a.attributes[d]?a.attributes[d]:"",tag:d}));c+=GeoGlobe.String.format("<GEOMETRY>${geometry}</GEOMETRY>",{geometry:this._getGeometryStringByFeature(a)});return c=GeoGlobe.String.format("<${typeName}>${content}</${typeName}>",{typeName:b,content:c})},_getUpdateString:function(a){for(var b=a.typeName,a=a.features,c="",d=0;d<a.length;d++)if(a[d].geometry){var e=this._getUpdatePropertyString(a[d]),f=this._parserFilterToString(new GeoGlobe.Filter.FeatureId({fids:[b+"."+a[d].attributes.OID]}));c+=
'<wfs:Update typeName="'+b+'" handle="Update '+d+'">'+e+f+"</wfs:Update>"}return c},_getUpdatePropertyString:function(a){var b="",c;for(c in a.data)c!="OID"&&a.data[c]&&(b+="<wfs:Property><wfs:Name><![CDATA["+c+"]]\></wfs:Name><wfs:Value><![CDATA["+(a.data[c]?a.data[c]:"")+"]]\></wfs:Value></wfs:Property>");b+="<wfs:Property><wfs:Name>Geometry</wfs:Name><wfs:Value>"+this._getGeometryStringByFeature(a)+"</wfs:Value></wfs:Property>";return b},_getGeometryStringByFeature:function(a){var b=new GeoGlobe.Format.GML({xy:this.xy});
b.buildCoordinatesNode=GeoGlobe.Function.bind(function(a){var b=this.createElementNS(this.gmlns,"gml:coordinates");b.setAttribute("decimal",".");b.setAttribute("cs",",");b.setAttribute("ts"," ");var e=[];if(a instanceof GeoGlobe.LngLatBounds)this.xy?(e.push(a.left+","+a.bottom),e.push(a.right+","+a.top)):(e.push(a.bottom+","+a.left),e.push(a.top+","+a.right));else for(var a=a.components?a.components:[a],f=0;f<a.length;f++)this.xy?e.push(a[f].x+","+a[f].y):e.push(a[f].y+","+a[f].x);e=this.createTextNode(e.join(" "));
b.appendChild(e);return b},b);a=b.buildGeometryNode(a.geometry);return(new GeoGlobe.Format.XML).write(a)},_getDeleteString:function(a){for(var b=a.filter,a=a.typeName,c="",d=0;d<b.fids.length;d++){c+='<wfs:Delete typeName="'+a+'" handle="Delete '+d+'">';var e=new GeoGlobe.Filter.FeatureId({fids:[b.fids[d]]});c+=this._parserFilterToString(e);c+="</wfs:Delete>"}return c},_parserFilterToString:function(a){var b="";a&&(a=(new GeoGlobe.Format.Filter.v1).write(a),b=(new GeoGlobe.Format.XML).write(a));return b},
CLASS_NAME:"GeoGlobe.Service.WFST"});
GeoGlobe.Service.CTS=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"CTS"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.loadURL(c,d,this,function(b){a(b)},b)},isExist:function(){var a=!1;GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"CTS"},scope:this,async:!1,success:function(){a=!0}});return a},TransCoords:function(a,
b,c){var d=this.url;GeoGlobe.Util.applyDefaults(a,{SERVICE:"CTS",REQUEST:"TransCoords"});c||(c=function(){this.failFn(a.REQUEST)});GeoGlobe.loadURL(d,a,this,function(c){if(a.FORMAT=="xml"){var d={},c=c.responseXML;GeoGlobe.Function.bind(this.xmltoJson,this);c=this.xmltoJson(c);d.attributes=c.CTS_TransResult["cts:Coordinate"].attributes.dim;for(var c=c.CTS_TransResult["cts:Coordinate"].text.split(","),g=[],h=0;h<c.length;h++)g.push(c[h]);d.coordvalue=g}else if(a.FORMAT=="json")d={},c=c.responseText,
c=(new GeoGlobe.Format.JSON).read(c),d.attributes=c.CTS_TransResult.dim,d.coordvalue=c.CTS_TransResult.Coordinate;b(d)},c)},xmltoJson:function(a){var b={};if(a.nodeType==1){if(a.attributes.length>0){b.attributes={};for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c);b.attributes[d.nodeName]=d.nodeValue}}}else if(a.nodeType==3)b=a.nodeValue;if(a.hasChildNodes())for(c=0;c<a.childNodes.length;c++){var d=a.childNodes.item(c),e=d.nodeName.replace("ows:",""),e=e.replace("#","");if(typeof b[e]==
"undefined")b[e]=this.xmltoJson(d);else{if(typeof b[e].push=="undefined"){var f=b[e];b[e]=[];b[e].push(f)}b[e].push(this.xmltoJson(d))}}return b},AffineTransform:function(a,b,c){var d=this.url;GeoGlobe.Util.applyDefaults(a,{SERVICE:"CTS",REQUEST:"AffineTransform"});c||(c=function(){this.failFn(a.REQUEST)});GeoGlobe.loadURL(d,a,this,function(c){if(a.FORMAT=="xml"){var d={},c=c.responseXML;GeoGlobe.Function.bind(this.xmltoJson,this);c=this.xmltoJson(c);d.attributes=c.CTS_AffineTransResult["cts:Coordinate"].attributes.dim;
for(var c=c.CTS_AffineTransResult["cts:Coordinate"].text.split(","),g=[],h=0;h<c.length;h++)g.push(c[h]);d.coordvalue=g}else if(a.FORMAT=="json")d={},c=c.responseText,c=(new GeoGlobe.Format.JSON).read(c),d.attributes=c.CTS_AffineTransResult.dim,d.coordvalue=c.CTS_AffineTransResult.Coordinate;b(d)},c)},CLASS_NAME:"GeoGlobe.Service.CTS"});
GeoGlobe.Service.VTS=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WMTS",VERSION:"1.0.0"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.loadURL(c,d,this,function(b){b=b.responseXML;GeoGlobe.Function.bind(this.xmlToJson,this);var b=this.xmlToJson(b),c=[],d,h=[],b=b.Capabilities;if(b.Contents.Layer.length)for(var j=0;j<b.Contents.Layer.length;j++)h.push(b.Contents.Layer[j]);
else h.push(b.Contents.Layer);for(var l=0;l<h.length;l++){d={};d.version=b.attributes.version;d.format=h[l].Format[4].text;d.LayerIdentifier=h[l].Identifier.text;d.StyleIdentifier=h[l].Style.Identifier.text;d.MatrixSet=h[l].TileMatrixSetLink[0].TileMatrixSet.text;if(h[l].BoundingBox)d.Bounding=h[l].BoundingBox;for(var n="",j=0;j<b.Contents.TileMatrixSet.length;j++)if(b.Contents.TileMatrixSet[j].Identifier.text==d.MatrixSet)var o=b.Contents.TileMatrixSet[j];d.mapCRS=o.SupportedCRS.text;var q=o.TileMatrix[0];
d.initZoom=q.Identifier.text;if(q.length>0){for(var j=0,r=q.length;j<r;j++){if(j==r)break;n+=q[j].ScaleDenominator.text+","}d.Scales=n.substr(0,n.length-1);d.zoomOffset=q[0].Identifier.text}else if(q)n+=q.ScaleDenominator.text+",",d.Scales=n.substr(0,n.length-1),d.zoomOffset=q.Identifier.text;c[l]=d}a(c,b)},b)},xmlToJson:function(a){var b={};if(a.nodeType==1){if(a.attributes.length>0){b.attributes={};for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c);b.attributes[d.nodeName]=d.nodeValue}}}else if(a.nodeType==
3)b=a.nodeValue;if(a.hasChildNodes())for(c=0;c<a.childNodes.length;c++){var d=a.childNodes.item(c),e=d.nodeName.replace("ows:",""),e=e.replace("#","");if(typeof b[e]=="undefined")b[e]=this.xmlToJson(d);else{if(typeof b[e].push=="undefined"){var f=b[e];b[e]=[];b[e].push(f)}b[e].push(this.xmlToJson(d))}}return b},GetTile:function(a){var b={REQUEST:"GetTile",SERVICE:"WMTS",VERSION:"1.0.0"};if(a.layer)b.LAYER=a.layer;if(a.format)b.FORMAT=a.format;if(a.tileMatrixSet)b.TILEMATRIXSET=a.tileMatrixSet;if(a.width)b.WIDTH=
a.width;if(a.height)b.HEIGHT=a.height;if(a.TILEMATRIX)b.TILEMATRIX=a.TILEMATRIX;if(a.TILEROW)b.TILEROW=a.TILEROW;if(a.TILECOL)b.TILECOL=a.TILECOL;a={};a.url=this.url;a.param=b;return this.urlAppend(a.url,this.getParameterString(a.param||{}))},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+
"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},GetStyleName:function(a,b){var c=this.url,d={REQUEST:"GetStyle",SERVICE:"WMTS",VERSION:"1.0.0"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.Request.GET({url:c,params:d,scope:this,async:this.async,success:function(c){c=c.responseText;if(!c)return b(),!1;var c=(new GeoGlobe.Format.JSON).read(c),d=[];if(c.style)for(var g=0;g<c.style.length;g++)d.push(c.style[g].styleName);
else if(c.styleName)for(g=0;g<c.styleName.length;g++)d.push(c.styleName[g]);a(d)},failure:b})},GetStyle:function(a,b,c){var d=this.url;if(a==""||a==void 0)alert("\u8bf7\u67e5\u770b\u6837\u5f0f\u540d\u79f0\u662f\u5426\u5b58\u5728");else{var e={REQUEST:"GetStyle",SERVICE:"WMTS",VERSION:"1.0.0",STYLENAME:a};c||(c=function(){this.failFn(e.REQUEST)});GeoGlobe.Request.GET({url:d,params:e,scope:this,async:this.async,success:function(a){a=a.responseText;if(!a)return c(),!1;a=(new GeoGlobe.Format.JSON).read(a);
b(a)},failure:c})}},isExist:function(){var a=!1;GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WFS"},scope:this,async:!1,success:function(){a=!0}});return a},CLASS_NAME:"GeoGlobe.Service.VTS"});
GeoGlobe.Service.WMS=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WMS"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.loadURL(c,d,this,function(b){b=b.responseXML;GeoGlobe.Function.bind(this.xmlToJson,this);var b=this.xmlToJson(b),c={},d=b.WMT_MS_Capabilities,h=d.Capability.Layer.Layer,j=d.Capability.Request,h=h.length?h[0]:h;c.version=d.attributes.version;
c.format=j.GetMap.Format[1].text;c.layer=h.Title.text;c.bbox=h.BoundingBox.attributes.SRS;c.maxExtent=d.Capability.Layer.LatLonBoundingBox.attributes;a(c,b)},b)},isExist:function(){var a=!1;GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"WMS"},scope:this,async:!1,success:function(){a=!0}});return a},xmlToJson:function(a){var b={};if(a.nodeType==1){if(a.attributes.length>0){b.attributes={};for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c);b.attributes[d.nodeName]=
d.nodeValue}}}else if(a.nodeType==3)b=a.nodeValue;if(a.hasChildNodes())for(c=0;c<a.childNodes.length;c++){var d=a.childNodes.item(c),e=d.nodeName.replace("ows:",""),e=e.replace("#","");if(typeof b[e]=="undefined")b[e]=this.xmlToJson(d);else{if(typeof b[e].push=="undefined"){var f=b[e];b[e]=[];b[e].push(f)}b[e].push(this.xmlToJson(d))}}return b},getMap:function(a){var b=this.url,b={};if(a.layers)b.LAYERS=a.layers;if(a.format)b.FORMAT=a.format;if(a.bbox)b.BBOX="{bbox-epsg-3857}";if(a.width)b.WIDTH=
a.width;if(a.height)b.HEIGHT=a.height;if(a.version)b.VERSION=a.version;if(a.SRS)b.SRS=a.SRS;GeoGlobe.Util.applyDefaults(b,{service:"WMS",request:"GetMap",TRANSPARENT:!0});return b=this.urlAppend(this.url,this.getParameterString(b||{}))},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+
"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},CLASS_NAME:"GeoGlobe.Service.WMS"});
GeoGlobe.Service.WMTS=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WMTS"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.loadURL(c,d,this,function(b){b=b.responseXML;GeoGlobe.Function.bind(this.xmlToJson,this);var b=this.xmlToJson(b),c=b.Capabilities,d={},h=c.Contents.Layer;h.length&&(h=h[0]);d.version=c.attributes.version;c=c.Contents;d.layer=
h.Title.text;d.LayerIdentifier=h.Identifier.text;d.StyleIdentifier=h.Style.Identifier.text;d.MatrixSet=h.TileMatrixSetLink[0].TileMatrixSet.text;d.Format=h.Format[1].text;d.Bounding=h.BoundingBox;h="";c=c.TileMatrixSet[0].TileMatrix;if(c.length>0)for(var j=0,l=c.length;j<l;j++){if(j==l)break;h+=c[j].ScaleDenominator.text+","}d.Scales=h.substr(0,h.length-1);d.zoomOffset=c[0].Identifier.text;a(d,b)},b)},xmlToJson:function(a){var b={};if(a.nodeType==1){if(a.attributes.length>0){b.attributes={};for(var c=
0;c<a.attributes.length;c++){var d=a.attributes.item(c);b.attributes[d.nodeName]=d.nodeValue}}}else if(a.nodeType==3)b=a.nodeValue;if(a.hasChildNodes())for(c=0;c<a.childNodes.length;c++){var d=a.childNodes.item(c),e=d.nodeName.replace("ows:",""),e=e.replace("#","");if(typeof b[e]=="undefined")b[e]=this.xmlToJson(d);else{if(typeof b[e].push=="undefined"){var f=b[e];b[e]=[];b[e].push(f)}b[e].push(this.xmlToJson(d))}}return b},isExist:function(){var a=!1;GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",
SERVICE:"WMTS"},scope:this,async:!1,success:function(){a=!0}});return a},getTile:function(a){var b={};if(a.layer)b.LAYER=a.layer;if(a.format)b.FORMAT=a.format;if(a.tileMatrixSet)b.TILEMATRIXSET=a.tileMatrixSet;if(a.TILEMATRIX)b.TILEMATRIX=a.TILEMATRIX;if(a.TILEROW)b.TILEROW=a.TILEROW;if(a.TILECOL)b.TILECOL=a.TILECOL;if(a.version)b.VERSION=a.version;if(a.style)b.STYLE=a.style;GeoGlobe.Util.applyDefaults(b,{service:"WMTS",request:"GetTile"});return this.urlAppend(this.url,this.getParameterString(b||
{}))},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},getCapabilitiesForRest:function(a,b){var c=this.url;c.match(/\/$/)||
(c+="/");c+="1.0.0/WMTSCapabilities.xml";b||(b=function(){this.failFn("GetCapabilities")});GeoGlobe.loadURL(c,null,this,function(b){a(b)},b)},getTileForRest:function(a){var b=a.layer,c=a.style,d=a.tileMatrixSet,e=a.tileMatrix,f=a.tileRow,g=a.tileCol,h=null,a=a.format?a.format:"image/png",j={"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"};h||(h=j[a]||a.split("/").pop());b=b+"/"+c+"/"+d+"/"+e+"/"+f+"/"+
g+"."+h;c=this.url;c.match(/\/$/)||(c+="/");c+=b;return c},CLASS_NAME:"GeoGlobe.Service.WMTS"});
GeoGlobe.Service.DTJ=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"WMS"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.loadURL(c,d,this,function(b){b=b.responseXML;GeoGlobe.Function.bind(this.xmlToJson,this);b=this.xmlToJson(b);a(b)},b)},getMap:function(a){var b={};if(a.layers)b.LAYERS=a.layers;if(a.format)b.FORMAT=a.format;if(a.bbox)b.BBOX=
"{bbox-epsg-3857}";if(a.width)b.WIDTH=a.width;if(a.height)b.HEIGHT=a.height;if(a.interval)b.INTERVAL=a.interval;if(a.GRADSIZE)b.GRADSIZE=a.GRADSIZE;if(a.simplitymethod)b.SIMPLIFYMETHOD=a.simplitymethod;if(a.intervalcolor)b.INTERVALCOLOR=a.intervalcolor;if(a.SIMPLIFYSIZE)b.SIMPLIFYSIZE=a.SIMPLIFYSIZE;if(a.INTERPOLAION)b.INTERPOLATIONMETHOD=a.INTERPOLAION;if(a.RADIUS)b.RADIUS=a.RADIUS;GeoGlobe.Util.applyDefaults(b,{request:"GetMap",service:"WMS",version:"1.1.1"});return this.urlAppend(this.url,this.getParameterString(b||
{}))},getStatisticInfo:function(a,b,c){var d={};if(a.layers)d.LAYERNAME=a.layers;if(a.lnglat)d.X=a.lnglat.lng,d.Y=a.lnglat.lat;if(a.simplitymethod)d.SIMPLIFYMETHOD=a.simplitymethod;if(a.INTERPOLATIONMETHOD)d.INTERPOLATIONMETHOD=a.INTERPOLATIONMETHOD;if(a.SIMPLIFYSIZE)d.SIMPLIFYSIZE=a.SIMPLIFYSIZE;if(a.INTERPOLAION)d.INTERPOLAION=a.INTERPOLAION;if(a.RADIUS)d.RADIUS=a.RADIUS;GeoGlobe.Util.applyDefaults(d,{request:"GetStatisticalValue",service:"WMS",version:"1.1.1"});a=this.urlAppend(this.url,this.getParameterString(d||
{}));GeoGlobe.loadURL(a,d,this,function(a){a=a.responseXML;GeoGlobe.Function.bind(this.xmlToJson,this);a=this.xmlToJson(a);a.FeatureCollection.featureMember&&b(a.FeatureCollection.featureMember)},c)},getParams:function(a){var b={request:"GetMap",service:"WMS",version:"1.1.1"};GeoGlobe.Util.extend(b,a);return b},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],
e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},xmlToJson:function(a){var b={};if(a.nodeType==1){if(a.attributes.length>0){b.attributes={};for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c);b.attributes[d.nodeName]=d.nodeValue}}}else if(a.nodeType==3)b=a.nodeValue;if(a.hasChildNodes())for(c=0;c<
a.childNodes.length;c++){var d=a.childNodes.item(c),e=d.nodeName.replace("ows:",""),e=e.replace("#","");if(typeof b[e]=="undefined")b[e]=this.xmlToJson(d);else{if(typeof b[e].push=="undefined"){var f=b[e];b[e]=[];b[e].push(f)}b[e].push(this.xmlToJson(d))}}return b},CLASS_NAME:"GeoGlobe.Service.DTJ"});
GeoGlobe.Service.Fonts=GeoGlobe.Class4OL(GeoGlobe.Service,{initialize:function(){GeoGlobe.Service.prototype.initialize.apply(this,arguments)},getCapabilities:function(a,b){var c=this.url,d={REQUEST:"GetCapabilities",SERVICE:"FLS",VERSION:"1.0"};b||(b=function(){this.failFn(d.REQUEST)});GeoGlobe.loadURL(c,d,this,function(b){var b=b.responseText,c=new GeoGlobe.Format.JSON,b=b?c.read(b):{};a(b)},b)},isExist:function(){var a=!1;GeoGlobe.Request.GET({url:this.url,params:{REQUEST:"GetCapabilities",SERVICE:"FLS"},
scope:this,async:!1,success:function(){a=!0}});return a},GetFont:function(a,b){var c={REQUEST:"GetFont",SERVICE:"FLS",VERSION:"1.0"};b||(b=function(){this.failFn(c.REQUEST)})},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,
b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},CLASS_NAME:"GeoGlobe.Service.Fonts"});
GeoGlobe.Service.RTDS=GeoGlobe.Class4OL(GeoGlobe.Service,{service:"RTDS",version:"1.0.0",format:"json",callback:"",initialize:function(a,b,c){GeoGlobe.Service.prototype.initialize.apply(this,arguments);GeoGlobe.Util.extend(this,c)},getCapabilities:function(a,b){var c=this;GeoGlobe.Request.GET({url:this.url,params:{SERVICE:this.service,VERSION:this.version,REQUEST:"GetCapabilities",FORMAT:this.format,CALLBACK:this.callback},scope:this,async:this.async,success:function(d){var e={};try{e=JSON.parse(d.responseText)}catch(f){console.error("RTDS GetCapabilities Error : "+
d.responseText);b(d.responseText);return}a(e,c)},failure:b});return this},describeFeatureDataSet:function(a,b,c){var d=this;GeoGlobe.Request.GET({url:this.url,params:{SERVICE:this.service,VERSION:this.version,REQUEST:"DescribeFeatureDataSet",FORMAT:this.format,CALLBACK:this.callback,OBSOBJSETNAME:a},scope:this,async:this.async,success:function(a){var f={};try{f=JSON.parse(a.responseText)}catch(g){console.error("RTDS DescribeFeatureDataSet Error : "+a.responseText);c(a.responseText);return}b(f,d)},
failure:c});return this},describeObservationDataSet:function(a,b,c){var d=this;GeoGlobe.Request.GET({url:this.url,params:{SERVICE:this.service,VERSION:this.version,REQUEST:"DescribeObservationDataSet",FORMAT:this.format,CALLBACK:this.callback,DATASETNAME:a},scope:this,async:this.async,success:function(a){var f={};try{f=JSON.parse(a.responseText)}catch(g){console.error("RTDS DescribeObservationDataSet Error : "+a.responseText);c(a.responseText);return}b(f,d)},failure:c});return this},queryFeature:function(a,
b,c){var d={SERVICE:this.service,VERSION:this.version,REQUEST:"QueryFeature",FORMAT:this.format,CALLBACK:this.callback,OBSOBJSETNAME:a.obsobjsetname};a.externalid&&(d.EXTERNALID=a.externalid);a.bbox&&(d.BBOX=a.bbox);a.geometry&&(d.GEOMETRY=a.geometry);typeof a.startposition!="undefined"&&(d.STARTPOSITION=a.startposition);typeof a.maxcount!="undefined"&&(d.MAXCOUNT=a.maxcount);var e=this;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,async:this.async,success:function(a){var d={};try{d=JSON.parse(a.responseText)}catch(h){console.error("RTDS QueryFeature Error : "+
a.responseText);c(a.responseText);return}b(d,e)},failure:c});return this},getObservation:function(a,b,c){var d={SERVICE:this.service,VERSION:this.version,REQUEST:"GetObservation",FORMAT:this.format,CALLBACK:this.callback,DATASETNAME:a.datasetname};a.externalid&&(d.EXTERNALID=a.externalid);a.observationproperty&&(d.OBSERVATIONPROPERTY=a.observationproperty);a.bbox&&(d.BBOX=a.bbox);a.geometry&&(d.GEOMETRY=a.geometry);typeof a.startposition!="undefined"&&(d.STARTPOSITION=a.startposition);typeof a.maxcount!=
"undefined"&&(d.MAXCOUNT=a.maxcount);var e=this;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,async:this.async,success:function(a){var d={};try{d=JSON.parse(a.responseText)}catch(h){console.error("RTDS GetObservation Error : "+a.responseText);c(a.responseText);return}b(d,e)},failure:c});return this},getObservationByCursor:function(a,b,c){var d={SERVICE:this.service,VERSION:this.version,REQUEST:"GetObservation",FORMAT:this.format,CALLBACK:this.callback,DATASETNAME:a.datasetname};a.externalid&&
(d.EXTERNALID=a.externalid);a.observationproperty&&(d.OBSERVATIONPROPERTY=a.observationproperty);a.bbox&&(d.BBOX=a.bbox);a.geometry&&(d.GEOMETRY=a.geometry);if(typeof a.maxcount=="undefined")console.error("RTDS GetObservationByCursor\u4e2dmaxcount\u4e3a\u5fc5\u987b\u53c2\u6570\uff01");else{d.MAXCOUNT=a.maxcount;var e=d.SCROLLID="GETSCROLL",f=!1,g=this,h=function(){GeoGlobe.Request.GET({url:g.url,params:d,scope:g,async:g.async,success:function(a){var h={};try{h=JSON.parse(a.responseText)}catch(n){console.error("RTDS GetObservation Error : "+
a.responseText);f=!0;c(a.responseText);return}d.SCROLLID==e&&!h.scrollId?(console.error("RTDS GetObservationByCursor \u83b7\u53d6\u6e38\u6807\u5931\u8d25\uff01"),f=!0):(h.features.length==0&&(f=!0),d.SCROLLID=h.scrollId,b(h,g))},failure:c})};h();return{next:function(){var a=this;f||(d.SCROLLID==e?setTimeout(function(){a.next()},300):h());return!f}}}},getObservationHistory:function(a,b,c){var d={SERVICE:this.service,VERSION:this.version,REQUEST:"GetObservationHistory",FORMAT:this.format,CALLBACK:this.callback,
DATASETNAME:a.datasetname,EXTERNALID:a.externalid,STARTTIME:a.starttime,ENDTIME:a.endtime};a.observationproperty&&(d.OBSERVATIONPROPERTY=a.observationproperty);typeof a.samplemethod!="undefined"&&(d.SAMPLEMETHOD=a.samplemethod);typeof a.samplecount!="undefined"&&(d.SAMPLECOUNT=a.samplecount);var e=this;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,async:this.async,success:function(a){var d={};try{d=JSON.parse(a.responseText)}catch(h){console.error("RTDS GetObservationHistory Error : "+a.responseText);
c(a.responseText);return}b(d,e)},failure:c});return this},featureAggs:function(a,b,c){var d={SERVICE:this.service,VERSION:this.version,REQUEST:"FeatureAggs",FORMAT:this.format,CALLBACK:this.callback,DATASETNAME:a.datasetname,STARTTIME:a.starttime,ENDTIME:a.endtime};typeof a.precision!="undefined"&&(d.PRECISION=a.precision);a.aggtype&&(d.AGGTYPE=a.aggtype);a.groupbypro&&(d.GROUPBYPRO=a.groupbypro);a.statisticspro&&(d.STATISTICSPRO=a.statisticspro);a.profilter&&(d.PROFILTER=a.profilter);a.bbox&&(d.BBOX=
a.bbox);var e=this;GeoGlobe.Request.GET({url:this.url,params:d,scope:this,async:this.async,success:function(a){var d={};try{d=JSON.parse(a.responseText)}catch(h){console.error("RTDS FeatureAggs Error : "+a.responseText);c(a.responseText);return}b(d,e)},failure:c});return this},CLASS_NAME:"GeoGlobe.Service.RTDS"});
GeoGlobe.Statistic=GeoGlobe.Class({url:null,type:"intersection",initialize:function(a,b){this.url=a;GeoGlobe.Util.extend(this,b)},paramUrl:function(a){var b=this.getParams({request:"GetMap"});if(a.layers)b.LAYERS=a.layers;if(a.format)b.FORMAT=a.format;if(a.bbox)b.BBOX="{bbox-epsg-3857}";if(a.width)b.WIDTH=a.width;if(a.height)b.HEIGHT=a.height;if(a.interval)b.INTERVAL=a.interval;if(a.GRADSIZE)b.GRADSIZE=a.GRADSIZE;if(a.simplitymethod)b.SIMPLIFYMETHOD=a.simplitymethod;if(a.intervalcolor)b.INTERVALCOLOR=
a.intervalcolor;if(a.SIMPLIFYSIZE)b.SIMPLIFYSIZE=a.SIMPLIFYSIZE;if(a.INTERPOLAION)b.INTERPOLATIONMETHOD=a.INTERPOLAION;if(a.RADIUS)b.RADIUS=a.RADIUS;a={};a.url=this.url;a.param=b;return this.urlAppend(a.url,this.getParameterString(a.param||{}))},getStatisticInfo:function(a){var b=this.getParams({request:"GetStatisticalValue"});if(a.layers)b.LAYERNAME=a.layers;if(a.lnglat)b.X=a.lnglat.lng,b.Y=a.lnglat.lat;if(a.simplitymethod)b.SIMPLIFYMETHOD=a.simplitymethod;if(a.INTERPOLATIONMETHOD)b.INTERPOLATIONMETHOD=
a.INTERPOLATIONMETHOD;if(a.SIMPLIFYSIZE)b.SIMPLIFYSIZE=a.SIMPLIFYSIZE;if(a.INTERPOLAION)b.INTERPOLAION=a.INTERPOLAION;if(a.RADIUS)b.RADIUS=a.RADIUS;a={};a.url=this.url;a.param=b;return this.getStatisticValue(this.urlAppend(a.url,this.getParameterString(a.param||{})))},getParams:function(a){var b={request:"GetMap",service:"WMS",version:"1.1.1"};GeoGlobe.Util.extend(b,a);return b},getParameterString:function(a){var b=[],c;for(c in a){var d=a[c];if(d!=null&&typeof d!="function"){if(typeof d=="object"&&
d.constructor==Array){for(var e=[],f,g=0,h=d.length;g<h;g++)f=d[g],e.push(encodeURIComponent(f===null||f===void 0?"":f));d=e.join(",")}b.push(encodeURIComponent(c)+"="+d)}}return b.join("&")},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},getStatisticValue:function(a){var b=Cfg.proxyHostUrl+a;Cfg.url=a;var a=sendAjaxRequest(b,dataChange),b=a.responseXML,c=xmlToJson(b);if(!b||!b.documentElement)b=a.responseText;if(b)if(c.FeatureCollection.featureMember)return c.FeatureCollection.featureMember;
else alert("\u670d\u52a1\u4e0d\u53ef\u7528!");else alert("\u670d\u52a1\u4e0d\u53ef\u7528!")},CLASS_NAME:"GeoGlobe.Statistic"});
GeoGlobe.ElementContainer=GeoGlobe.Class4OL({id:null,map:null,initialize:function(a){this.id=GeoGlobe.Util.createUniqueID(this.CLASS_NAME+"_");GeoGlobe.Util.extend(this,a)},addTo:function(a){this.map=a;var b=a.getCanvasContainer();if(!a.eleContainer)b=GeoGlobe.DOM.create("div","geoglobe-element-container",b),b.style.width=a.getCanvas().style.width,b.style.height=a.getCanvas().style.height,b.style.position="absolute",a.eleContainer=b;this.container=GeoGlobe.DOM.create("div",null,a.eleContainer);this.container.style.width=
a.getCanvas().style.width;this.container.style.height=a.getCanvas().style.height;this.container.style.position="absolute";this._resize=GeoGlobe.Function.bind(this._resize,this);a.on("resize",this._resize)},_resize:function(){var a=this.map;a.eleContainer.style.width=a.getCanvas().style.width;a.eleContainer.style.height=a.getCanvas().style.height;this.container.style.width=a.getCanvas().style.width;this.container.style.height=a.getCanvas().style.height},getElMap:function(){return this.elmap},remove:function(){this.map.off("resize",
this._resize)},CLASS_NAME:"GeoGlobe.ElementContainer"});
GeoGlobe.MaptalksEle=GeoGlobe.Class4OL(GeoGlobe.ElementContainer,{map:null,container:null,elmap:null,elmapOptions:null,initialize:function(){GeoGlobe.ElementContainer.prototype.initialize.apply(this,arguments)},addTo:function(){GeoGlobe.ElementContainer.prototype.addTo.apply(this,arguments);this.container.id=this.id;this.container.className="geoglobe-maptalks-container";if(window.maptalks&&window.maptalks.Map){GeoGlobe.MaptalksEle.overrideMapTalksFunc();var a=this.map.getCenter(),a=GeoGlobe.Util.extend({zoom:this.map.getZoom()+
1,center:[a.lng,a.lat]},this.elmapOptions);this.elmap=new maptalks.Map(this.container.id,a);this._bindEvent()}else console.log("\u4f7f\u7528\u524d\u7f6emaptalks\u5bb9\u5668\uff0c\u9700\u5f15\u5165maptalks\u5730\u56fe\u5e93\u3002")},_bindEvent:function(){var a=this.map;this._movestart=GeoGlobe.Function.bind(function(){if(this._zooming)this._zooming=!1,this._iszoomend=!0},this);this._move=GeoGlobe.Function.bind(function(){if(!(this._zooming==!0||this._rotating==!0))this.elmap._moving=!0,this.syncElmapCenter()},
this);this._moveend=GeoGlobe.Function.bind(function(a){this.elmap._moving=!1;this._rotating=this._zooming=this.elmap._dragRotating=!1;var c=this.map.getZoom();if(!this.map.isIntScrollZoom&&this._latelyZoom&&this._latelyZoom!=c)this._latelyZoom=c=this._latelyZoom<c?Math.ceil(c):Math.floor(c),this.map.setZoom(c);if(this._iszoomend){this._iszoomend=!1;var c=this.map.getZoom()+1,d=a.target.scrollZoom._pos?a.target.scrollZoom._pos:a.point;if(!d)d=a.target.scrollZoom._aroundPoint,a=new maptalks.Point(d.x,
d.y),this.elmap._zoomTo(c,a),this.elmap._zooming=!1,this.elmap._getRenderer().onZoomEnd(),this.elmap._fireEvent("zoomend",{from:this.elmap._startZoomVal,to:c}),this.syncElmapCenter()}else c=this.map.getCenter(),this.elmap.setCenter([c.lng,c.lat])},this);this._rotatestart=GeoGlobe.Function.bind(function(){this._rotating=!0;this.elmap._dragRotating=!0},this);this._rotate=GeoGlobe.Function.bind(function(){this.syncElmapRotate()},this);this._zoomstart=GeoGlobe.Function.bind(function(a){this._zooming=
!0;this._latelyZoom=this.map.getZoom();this.elmap._moving=!1;var c=this.map.getZoom()+1,d=a.target.scrollZoom._pos?a.target.scrollZoom._pos:a.point;if(!d&&a.originalEvent)d=GeoGlobe.DOM.mousePos(a.target.scrollZoom._el,a.originalEvent),a=new maptalks.Point(d.x,d.y),this.origin_lnglat=this.map.unproject(d),this.elmap.onZoomStart(c,a)},this);this._zoom=GeoGlobe.Function.bind(function(a){var c=this.map.getCenter(),d=this.map.getZoom()+1;if(this.elmap._zoomLevel!==d){var e=a.target.scrollZoom._pos?a.target.scrollZoom._pos:
a.point;if(!e&&a.originalEvent)e=(e=a.target.scrollZoom._aroundPoint)?e:GeoGlobe.DOM.mousePos(a.target.scrollZoom._el,a.originalEvent);else return;a=this.map.project(this.origin_lnglat);if(e.x!==Math.round(a.x)||e.y!==Math.round(a.y))this.elmap._zooming=!1;e=new maptalks.Point(e.x,e.y);this.elmap.onZooming(d,e)}d=this.elmap.getCenter();(c.lng-d.x>2||c.lng-d.x<-2)&&this.syncElmapCenter()},this);this._zoomend=GeoGlobe.Function.bind(function(){this._zooming=!1;this._iszoomend=!0},this);a.on("movestart",
this._movestart);a.on("move",this._move);a.on("moveend",this._moveend);a.on("rotatestart",this._rotatestart);a.on("rotate",this._rotate);a.on("zoomstart",this._zoomstart);a.on("zoom",this._zoom);a.on("zoomend",this._zoomend)},_resize:function(){GeoGlobe.ElementContainer.prototype._resize.apply(this,arguments);this.elmap.checkSize()},syncElmapCenter:function(){var a=this.map.getCenter(),a=[a.lng,a.lat];if(!a)return!1;a=new maptalks.Coordinate(a);this.elmap._setPrjCenter(this.elmap.getProjection().project(a))},
syncElmapRotate:function(){var a=this.map;this.elmap&&(a.getBearing(),a.getPitch(),this.elmap.setView({bearing:a.getBearing(),pitch:a.getPitch()}))},_syncElmap:function(){var a=this.map;if(this.elmap){var b=a.getCenter();a.getZoom();a.getBearing();a.getPitch();this.elmap.setView({center:[b.lng,b.lat],zoom:a.getZoom()+1,bearing:a.getBearing(),pitch:a.getPitch()})}},remove:function(){GeoGlobe.ElementContainer.prototype.remove.apply(this,arguments);var a=this.map;a.off("movestart",this._movestart);a.off("move",
this._move);a.off("moveend",this._moveend);a.off("rotatestart",this._rotatestart);a.off("rotate",this._rotate);a.off("zoomstart",this._zoomstart);a.off("zoom",this._zoom);a.off("zoomend",this._zoomend);this.container.parentNode.removeChild(this.container);this.container=null;this.elmap.remove();this.map=this.elmap=null},CLASS_NAME:"GeoGlobe.MaptalksEle"});
GeoGlobe.MaptalksEle.overrideMapTalksFunc=function(){if(window.maptalks&&window.maptalks.Map)maptalks.Map.prototype.addHandler=function(a,b){if(a==="draggable"||a==="touchZoom"||a==="boxZoom"||a==="doubleClickZoom"||a==="scrollWheelZoom")return this;if(!b)return this;if(!this._handlers)this._handlers=[];if(this[a])return this[a].enable(),this;var c=this[a]=new b(this);this._handlers.push(c);this.options[a]&&c.enable();return this}};
GeoGlobe.Lang={code:null,defaultCode:"zh-CN",getCode:function(){GeoGlobe.Lang.code||GeoGlobe.Lang.setCode();return GeoGlobe.Lang.code},setCode:function(a){var b;a||(a=GeoGlobe.BROWSER_NAME=="msie"?navigator.userLanguage:navigator.language);a=a.split("-");a[0]=a[0].toLowerCase();typeof GeoGlobe.Lang[a[0]]=="object"&&(b=a[0]);if(a[1]){var c=a[0]+"-"+a[1].toUpperCase();typeof GeoGlobe.Lang[c]=="object"&&(b=c)}if(!b)GeoGlobe.Console.warn("Failed to find GeoGlobe.Lang."+a.join("-")+" dictionary, falling back to default language"),
b=GeoGlobe.Lang.defaultCode;GeoGlobe.Lang.code=b},translate:function(a,b){var c=GeoGlobe.Lang[GeoGlobe.Lang.getCode()];(c=c&&c[a])||(c=a);b&&(c=GeoGlobe.String.format(c,b));return c}};GeoGlobe.i18n=GeoGlobe.Lang.translate;GeoGlobe.Lang.en={unhandledRequest:"Unhandled request return ${statusText}",end:""};GeoGlobe.Lang["zh-CN"]={unhandledRequest:"\u672a\u5904\u7406\u7684\u8bf7\u6c42\uff0c\u8fd4\u56de\u503c\u4e3a ${statusText}",end:""};
GeoGlobe.Visuals=GeoGlobe.Class4OL(GeoGlobe.ElementContainer,{initialize:function(){GeoGlobe.ElementContainer.prototype.initialize.apply(this,arguments)},addTo:function(a){a._visuals=a._visuals||[];a._visuals.push(this);GeoGlobe.ElementContainer.prototype.addTo.apply(this,arguments)}});GeoGlobe.Visuals=GeoGlobe.Class4OL(GeoGlobe.Visuals,mapboxgl.Evented);
GeoGlobe.Visuals.Three=GeoGlobe.Class4OL(GeoGlobe.Visuals,{type:"three",map:null,container:null,layers:[],_threebox:null,_raycaster:null,_raycAsix:null,initialize:function(){GeoGlobe.Visuals.prototype.initialize.apply(this,arguments);this.layers=[];!window.THREE||!window.Threebox?console.error("\u4f7f\u7528three\u53ef\u89c6\u5316\u56fe\u5c42\u524d\uff0c\u9700\u5f15\u5165threejs\u5e93\uff01"):(this._raycaster=new THREE.Raycaster,this._raycAsix=new THREE.Vector2)},addTo:function(){GeoGlobe.Visuals.prototype.addTo.apply(this,
arguments);this.container.className="geoglobe-three-container";this._threebox=new Threebox(this.map,this.container);this._threebox.setupDefaultLights();this._bindEvent()},render:function(){if(this._order)for(var a=0;a<this._order.length;a++)for(var b=0;b<this.layers.length;b++)this.layers[b].id===this._order[a]&&this.layers[b].render();else for(b=0;b<this.layers.length;b++)this.layers[b].render();this._render()},_render:function(){this._threebox.render()},addLayer:function(a){a.id?this.map.getLayer(a.id)?
console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u91cd\u590d\uff01"):this.layers.push(a):console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u4e3a\u7a7a\uff01")},removeLayer:function(a){for(var b=[],c=0;c<this.layers.length;c++)a===this.layers[c].id?this._removeInnerLayer(this.layers[c]):b.push(this.layers[c]);this.layers=b},moveLayer:function(a,b){this._order=this.layers.map(function(a){return a.id});this._order.splice(this._order.indexOf(a),1);this._order.splice(b?this._order.indexOf(b):
this._order.length,0,a);this.render()},_removeInnerLayer:function(a){if(a._meshes&&a._meshes instanceof Array&&a._meshes.length>0)for(var b=0;b<a._meshes.length;b++){for(var c=0;c<this._threebox.world.children.length;c++)if(this._threebox.world.children[c].children.length!==0&&this._threebox.world.children[c].children[0].uuid===a._meshes[b].uuid){this._threebox.world.remove(a._meshes[b].parent);break}for(c=0;c<this._threebox.world2.children.length;c++)if(this._threebox.world2.children[c].children.length!==
0&&this._threebox.world2.children[c].children[0].uuid===a._meshes[b].uuid){this._threebox.world2.remove(a._meshes[b].parent);break}}},getLayer:function(a){for(var b=0;b<this.layers.length;b++)if(a===this.layers[b].id)return this.layers[b]},unprojectFromWorld:function(a){var b=new THREE.Matrix4;b.getInverse(this._threebox.world.matrixWorld);return this._threebox.unprojectFromWorld(a.applyMatrix4(b))},_bindEvent:function(){var a=this;this.map.on("click",function(b){a._onClick(b)});this.map.on("mousemove",
function(b){a._onMouseMove(b)})},_unbindEvent:function(){for(var a=0;a<this.map._listeners.click.length;a++)this.map._listeners.click[a].name&&this.map._listeners.click[a].name==="THREE_CLICK_EVENT"&&this.map._listeners.click.splice(a,1);for(a=0;a<this.map._listeners.mousemove.length;a++)this.map._listeners.mousemove[a].name&&this.map._listeners.mousemove[a].name==="THREE_MOUSEMOVE_EVENT"&&this.map._listeners.mousemove.splice(a,1)},_onMouseMove:function(a){var b=this._computerIntersect(a);b.length>
0&&this.fire("overlayerhover",{param:{info:this._getSymbolObject(b[0].object),pickedInfos:b,event:a}})},_onClick:function(a){var b=this._computerIntersect(a);b.length>0&&this.fire("overlayerclick",{param:{info:this._getSymbolObject(b[0].object),pickedInfos:b,event:a}})},_computerIntersect:function(a){this._raycAsix.x=(a.originalEvent.pageX-this.container.offsetLeft)/this.container.offsetWidth*2-1;this._raycAsix.y=-((a.originalEvent.pageY-this.container.offsetTop)/this.container.offsetHeight)*2+1;
this._raycaster.setFromCamera(this._raycAsix,this._threebox.camera);return this._raycaster.intersectObjects(this._threebox.scene.children,!0)},_getSymbolObject:function(a){return a.userData.attributes?a:this._getSymbolObject(a.parent)}});
GeoGlobe.Visuals.Three.PointLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,data:[],getColor:function(a){return a.properties.color?a.properties.color:"rgb(255, 0, 0)"},getTexture:function(a){return a.properties.texture?a.properties.texture:""},getPoint:function(a){return a.geometry.type==="Point"?a.geometry.coordinates:null},getSize:function(a){return a.properties.size?a.properties.size:1},_three:null,_meshes:[],_textureCache:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==
void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.data=a.data?a.data:this.data;this.getColor=a.getColor?a.getColor:this.getColor;this.getTexture=a.getTexture?a.getTexture:this.getTexture;this.getPoint=a.getPoint?a.getPoint:this.getPoint;this.getSize=a.getSize?a.getSize:this.getSize},addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){var a=this;a._three._removeInnerLayer(a);a._meshes=[];for(var b=
0;b<a.data.length;b++){var c=a.data[b],d=null;if(d=a.getTexture(c)){var e=a._getTextureCacheByURL(d);e?e=e.clone():(e=(new THREE.TextureLoader).load(d,function(){a._three._render()}),a._addTextureInToCache({key:d,value:e}));d=new THREE.MeshPhongMaterial({map:e,transparent:!0,opacity:a.opacity})}else d=new THREE.MeshPhongMaterial({color:new THREE.Color(a.getColor(c)),transparent:!0,opacity:a.opacity});e=a.getSize(c);e=new THREE.CircleBufferGeometry(Threebox.ThreeboxConstants.PROJECTION_WORLD_SIZE*
e/2,20);d=new THREE.Mesh(e,d);e=a._three._threebox.projectToWorld(a.data[b].geometry.coordinates);d.position.set(e.x,e.y,e.z);d.visible=a.visible;d.name=(a.id?a.id:"threelayer")+"-"+b;d.userData.attributes={OriginalData:c,Layer:a};a._three._threebox.addGeoreferencedMesh(d);a._meshes.push(d);a._three._render()}},_getTextureCacheByURL:function(a){if(a)for(var b=0;b<this._textureCache.length;b++)if(this._textureCache[b].key===a&&this._textureCache[b].value.image)return this._textureCache[b].value;return null},
_addTextureInToCache:function(a){for(var b=!1,c=0;c<this._textureCache.length;c++)if(this._textureCache[c].key===a.key){b=!0;break}b||this._textureCache.push(a)}});
GeoGlobe.Visuals.Three.LineLayer=GeoGlobe.Class4OL({id:"1",visible:!0,data:[],getColor:function(a){return a.properties.color?a.properties.color:"rgb(255, 0, 0)"},getTexture:function(a){return a.properties.texture?a.properties.texture:""},getLineString:function(a){return a.geometry.type==="LineString"?a.geometry.coordinates:null},getWidth:function(a){return a.properties.width?a.properties.width:1},_three:null,_meshes:[],_textureCache:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=
a.visible!==void 0?a.visible:this.visible;this.data=a.data?a.data:this.data;this.getColor=a.getColor?a.getColor:this.getColor;this.getTexture=a.getTexture?a.getTexture:this.getTexture;this.getLineString=a.getLineString?a.getLineString:this.getLineString;this.getWidth=a.getWidth?a.getWidth:this.getWidth},addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){this._three._removeInnerLayer(this);this._meshes=[];for(var a=0;a<
this.data.length;a++){for(var b=this.data[a],c=new THREE.LineMaterial({color:new THREE.Color(this.getColor(b)),linewidth:5.0E-4*this.getWidth(b)}),d=[],e=this.data[a].geometry.coordinates,f=0;f<e.length;f++){var g=this._three._threebox.projectToWorld(e[f]);d.push(g.x,g.y,g.z)}e=new THREE.LineGeometry;e.setPositions(d);c=new THREE.Line2(e,c);c.computeLineDistances();c.visible=this.visible;c.name=(this.id?this.id:"threelayer")+"-"+a;c.userData.attributes={OriginalData:b,Layer:this};this._three._threebox.addGeoreferencedMesh(c);
this._meshes.push(c);this._three._render()}}});
GeoGlobe.Visuals.Three.PolygonLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,data:[],getColor:function(a){return a.properties.color?a.properties.color:"rgb(255, 0, 0)"},getTexture:function(a){return a.properties.texture?a.properties.texture:""},getPolygon:function(a){return a.geometry.type==="Polygon"?a.geometry.coordinates:null},_three:null,_meshes:[],_textureCache:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==void 0?a.visible:this.visible;this.opacity=a.opacity?
a.opacity:this.opacity;this.data=a.data?a.data:this.data;this.getColor=a.getColor?a.getColor:this.getColor;this.getTexture=a.getTexture?a.getTexture:this.getTexture;this.getPolygon=a.getPolygon?a.getPolygon:this.getPolygon},addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){var a=this;a._three._removeInnerLayer(a);a._meshes=[];for(var b=0;b<a.data.length;b++){var c=a.data[b],d=null;if(d=a.getTexture(c)){var e=a._getTextureCacheByURL(d);
e?e=e.clone():(e=(new THREE.TextureLoader).load(d,function(){a._three._render()}),a._addTextureInToCache({key:d,value:e}));d=new THREE.MeshPhongMaterial({map:e,transparent:!0,opacity:a.opacity})}else d=new THREE.MeshPhongMaterial({color:new THREE.Color(a.getColor(c)),transparent:!0,opacity:a.opacity});for(var e=new THREE.Shape,f=a.data[b].geometry.coordinates,g=0;g<f.length;g++){var h=a._three._threebox.projectToWorld(f[g][0]);e.moveTo(h.x,h.y);for(h=1;h<f[g].length;h++){var j=a._three._threebox.projectToWorld(f[g][h]);
e.lineTo(j.x,j.y)}}e=new THREE.ShapeBufferGeometry(e);d=new THREE.Mesh(e,d);d.visible=a.visible;d.name=(a.id?a.id:"threelayer")+"-"+b;d.userData.attributes={OriginalData:c,Layer:a};a._three._threebox.addGeoreferencedMesh(d);a._meshes.push(d);a._three._render()}},_getTextureCacheByURL:function(a){if(a)for(var b=0;b<this._textureCache.length;b++)if(this._textureCache[b].key===a&&this._textureCache[b].value.image)return this._textureCache[b].value;return null},_addTextureInToCache:function(a){for(var b=
!1,c=0;c<this._textureCache.length;c++)if(this._textureCache[c].key===a.key){b=!0;break}b||this._textureCache.push(a)}});
GeoGlobe.Visuals.Three.SymbolLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,data:[],scale:1,modelURL:"",autoplay:!1,getColor:function(a){return a.properties.color?a.properties.color:"rgb(255, 0, 0)"},getPosition:function(a){if(a.geometry.type==="Point"){var b=a.geometry.coordinates;a.properties.height?b.push(a.properties.height):b.push(0);return b}else return null},getGeometry:function(a){return a},getLoader:function(){return new THREE.JSONLoader},_three:null,_meshes:[],_clock:null,_mixer:null,
_modelCache:null,initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.data=a.data?a.data:this.data;this.scale=a.scale?a.scale:this.scale;this.modelURL=a.modelURL?a.modelURL:this.modelURL;this.autoplay=a.autoplay?a.autoplay:this.autoplay;this.getColor=a.getColor?a.getColor:this.getColor;this.getPosition=a.getPosition?a.getPosition:this.getPosition;this.getGeometry=a.getGeometry?a.getGeometry:this.getGeometry;
this.getLoader=a.getLoader?a.getLoader:this.getLoader;this._clock=new THREE.Clock},addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){var a=this;a._modelCache=null;a.getLoader().load(a.modelURL,function(b){a._modelCache=b;a._draw()},function(a){console.log(a.loaded/a.total*100+"% loaded")},function(a){console.error(a)})},redraw:function(){this._modelCache?this._draw():this.render()},_draw:function(){this._three._removeInnerLayer(this);
this._meshes=[];for(var a=this._modelCache,b=0;b<this.data.length;b++){if(a.scene)if(this.autoplay){symbol=a.scene;symbol=this.getGeometry(symbol,this.data[b]);var c=a.animations;if(c&&c.length){for(var d=new THREE.AnimationMixer(symbol),e=0;e<c.length;e++)d.clipAction(c[e]).play();this._mixer=d}}else symbol=a.scene.clone(),symbol=this.getGeometry(symbol,this.data[b]);else a instanceof THREE.Group?(symbol=a.clone(),symbol=this.getGeometry(symbol,this.data[b])):(c=this.getGeometry(a.clone(),this.data[b]),
d=new THREE.MeshLambertMaterial({color:new THREE.Color(this.getColor(this.data[b])),side:THREE.DoubleSide,transparent:!0,opacity:this.opacity}),symbol=(new THREE.Mesh(c,d)).clone());symbol.visible=this.visible;symbol.name=(this.id?this.id:"threelayer")+"-"+b;symbol.userData.attributes={OriginalData:this.data[b],Layer:this};c=this.scale?this.scale:1;d=this.getPosition(this.data[b]);Array.isArray(d)&&(d.length<3&&d.push(0),this._three._threebox.addAtCoordinate(symbol,d,{scaleToLatitude:!0,preScale:c}));
this._meshes.push(symbol)}this._three._render();this._animate()},_animate:function(){var a=this;a.autoplay&&(a._mixer.update(a._clock.getDelta()),a._three._render(),requestAnimationFrame(function(){a._animate()}))}});
GeoGlobe.Visuals.Three.BuildingLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,drawMode:{high:{minZoom:14,maxZoom:15},middle:{minZoom:16,maxZoom:17},low:{minZoom:18,maxZoom:20}},data:[],getColor:function(a){return a.properties.color?a.properties.color:"rgb(255, 0, 0)"},getFaceTexture:function(a){return a.properties.face_texture?a.properties.face_texture:""},getFaceTextureRepeat:function(a){return a.properties.face_texture_repeat?a.properties.face_texture_repeat:"10,10"},getSideTexture:function(a){return a.properties.side_texture?
a.properties.side_texture:""},getSideTextureRepeat:function(a){return a.properties.side_texture_repeat?a.properties.side_texture_repeat:"30,30"},getPolygon:function(a){return a.geometry.type==="Polygon"?a.geometry.coordinates:null},getElevation:function(a){return a.properties.height?a.properties.height:0},getBaseElevation:function(a){return a.properties.base_height?a.properties.base_height:0},_three:null,_meshes:[],_textureCache:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==
void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.drawMode=a.drawMode?a.drawMode:this.drawMode;this.data=a.data?a.data:this.data;this.scale=a.scale?a.scale:this.scale;this.getColor=a.getColor?a.getColor:this.getColor;this.getFaceTexture=a.getFaceTexture?a.getFaceTexture:this.getFaceTexture;this.getFaceTextureRepeat=a.getFaceTextureRepeat?a.getFaceTextureRepeat:this.getFaceTextureRepeat;this.getSideTexture=a.getSideTexture?a.getSideTexture:this.getSideTexture;this.getSideTextureRepeat=
a.getSideTextureRepeat?a.getSideTextureRepeat:this.getSideTextureRepeat;this.getPolygon=a.getPolygon?a.getPolygon:this.getPolygon;this.getElevation=a.getElevation?a.getElevation:this.getElevation;this.getBaseElevation=a.getBaseElevation?a.getBaseElevation:this.getBaseElevation;(!this.drawMode||!this.drawMode.high||!this.drawMode.middle||!this.drawMode.low||this.drawMode.high.maxZoom==void 0||this.drawMode.high.minZoom==void 0||this.drawMode.high.maxZoom<this.drawMode.high.minZoom)&&console.error("option\u4e2d\u7684drawMode\u683c\u5f0f\u4e0d\u6b63\u786e\uff01")},
addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){this._three._removeInnerLayer(this);this._meshes=[];switch(this._getDrawMode()){case "high":this._highDraw();break;case "middle":this._middleDraw();break;case "low":this._lowDraw();break;default:this._highDraw()}this._three._render()},_getDrawMode:function(){var a=this._three.map.getZoom();if(this.drawMode.high.minZoom<a&&this.drawMode.high.maxZoom>=a)return"high";if(this.drawMode.middle.minZoom<
a&&this.drawMode.middle.maxZoom>=a)return"middle";if(this.drawMode.low.minZoom<a&&this.drawMode.low.maxZoom>=a)return"low";return null},_highDraw:function(){for(var a=new THREE.Geometry,b=this.data.length>0?this.getColor(this.data[0]):"rgb(255, 0, 0)",b=new THREE.MeshPhongMaterial({color:new THREE.Color(b),opacity:this.opacity,transparent:!0}),c=0;c<this.data.length;c++){var d=this._createGeometry(this.data[c]);a.merge(d)}a=new THREE.Mesh(a,b);a.visible=this.visible;a.name=(this.id?this.id:"threelayer")+
"-merge";a.userData.attributes={OriginalData:this.data,Layer:this};this._three._threebox.addGeoreferencedMesh(a);this._meshes.push(a)},_middleDraw:function(){for(var a=0;a<this.data.length;a++){var b=this.data[a],c=this.getFaceTexture(b),d=this.getSideTexture(b),e=new THREE.MeshPhongMaterial({color:new THREE.Color(this.getColor(b)),opacity:this.opacity,transparent:!0});if(c){c=this._createTexture(c);c.wrapS=c.wrapT=THREE.RepeatWrapping;var f=this.getFaceTextureRepeat(b).split(",");c.repeat.set(f[0],
f[1]);c=new THREE.MeshPhongMaterial({map:c,opacity:this.opacity,transparent:!0})}else c=e.clone();d?(d=this._createTexture(d),d.wrapS=d.wrapT=THREE.RepeatWrapping,f=this.getSideTextureRepeat(b).split(","),d.repeat.set(f[0],f[1]),d=new THREE.MeshPhongMaterial({map:d,opacity:this.opacity,transparent:!0})):d=e.clone();e=this._createGeometry(b);e=this._createUvs(e);c=new THREE.Mesh(e,[c,d]);c.visible=this.visible;c.name=(this.id?this.id:"threelayer")+"-"+a;c.userData.attributes={OriginalData:b,Layer:this};
this._three._threebox.addGeoreferencedMesh(c);this._meshes.push(c)}},_lowDraw:function(){for(var a=0;a<this.data.length;a++){var b=this.data[a],c=this.getFaceTexture(b),d=this.getSideTexture(b),e=new THREE.MeshPhongMaterial({color:new THREE.Color(this.getColor(b)),opacity:this.opacity,transparent:!0});if(c){c=this._createTexture(c);c.wrapS=c.wrapT=THREE.RepeatWrapping;var f=this.getFaceTextureRepeat(b).split(",");c.repeat.set(f[0],f[1]);c=new THREE.MeshPhongMaterial({map:c,opacity:this.opacity,transparent:!0})}else c=
e.clone();d?(d=this._createTexture(d),d.wrapS=d.wrapT=THREE.RepeatWrapping,f=this.getSideTextureRepeat(b).split(","),d.repeat.set(f[0],f[1]),d=new THREE.MeshPhongMaterial({map:d,opacity:this.opacity,transparent:!0})):d=e.clone();e=this._createGeometry(b);e=this._createUvs(e);c=new THREE.Mesh(e,[c,d]);c.visible=this.visible;c.name=(this.id?this.id:"threelayer")+"-"+a;c.userData.attributes={OriginalData:b,Layer:this};this._three._threebox.addGeoreferencedMeshToWorld2(c);this._meshes.push(c)}},_createGeometry:function(a){var b=
a.geometry.coordinates[0],c=new THREE.Shape,d=this._three._threebox.projectToWorld(b[0]);c.moveTo(d.x,d.y);for(d=1;d<b.length;d++){var e=this._three._threebox.projectToWorld(b[d]);c.lineTo(e.x,e.y)}b={amount:this._three._threebox.distaneToWorld(this.getElevation(a)),bevelEnabled:!1,material:0,extrudeMaterial:1};c=new THREE.ExtrudeGeometry(c,b);if((a=this.getBaseElevation(a))&&a>0)a=this._three._threebox.distaneToWorld(a),c.translate(0,0,a);return c},_createUvs:function(a){a.faceVertexUvs=[[]];for(var b=
[new THREE.Vector2(1,0),new THREE.Vector2(0,0),new THREE.Vector2(0,1),new THREE.Vector2(1,1)],c=a.faces.length,d=0;d<c;d+=2)if(a.faces[d].normal.z==0)a.faceVertexUvs[0][d]=[b[1],b[0],b[2]],a.faceVertexUvs[0][d+1]=[b[0],b[3],b[2]];else{var e=a.vertices[a.faces[d].a],f=a.vertices[a.faces[d].b],g=a.vertices[a.faces[d].c];a.faceVertexUvs[0][d]=[new THREE.Vector2(e.x,e.y),new THREE.Vector2(f.x,f.y),new THREE.Vector2(g.x,g.y)];e=a.vertices[a.faces[d+1].a];f=a.vertices[a.faces[d+1].b];g=a.vertices[a.faces[d+
1].c];a.faceVertexUvs[0][d+1]=[new THREE.Vector2(e.x,e.y),new THREE.Vector2(f.x,f.y),new THREE.Vector2(g.x,g.y)]}return a},_createTexture:function(a){var b=this,c=b._getTextureCacheByURL(a);c?c=c.clone():(c=(new THREE.TextureLoader).load(a,function(){b._three._render()}),b._addTextureInToCache({key:a,value:c}));return c},_getTextureCacheByURL:function(a){if(a)for(;0<this._textureCache.length;)return this._textureCache[0].key===a&&this._textureCache[0].value.image?this._textureCache[0].value:null;
else return null},_addTextureInToCache:function(a){for(var b=!1,c=0;c<this._textureCache.length;c++)if(this._textureCache[c].key===a.key){b=!0;break}b||this._textureCache.push(a)}});
GeoGlobe.Visuals.Three.VideoLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,autoplay:!0,data:[],getVideoTexture:function(a){return a.properties.video_texture?a.properties.video_texture:""},getLine:function(a){return a.geometry.type==="LineString"?a.geometry.coordinates:null},getElevation:function(a){return a.properties.height?a.properties.height:0},getBaseElevation:function(a){return a.properties.base_height?a.properties.base_height:0},_three:null,_meshes:[],_frameId:null,initialize:function(a){this.id=
a.id?a.id:this.id;this.visible=a.visible!==void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.autoplay=a.autoplay?a.autoplay:this.autoplay;this.data=a.data?a.data:this.data;this.getVideoTexture=a.getVideoTexture?a.getVideoTexture:this.getVideoTexture;this.getLine=a.getLine?a.getLine:this.getLine;this.getElevation=a.getElevation?a.getElevation:this.getElevation;this.getBaseElevation=a.getBaseElevation?a.getBaseElevation:this.getBaseElevation},addTo:function(a){this._three=
a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){this._three._removeInnerLayer(this);this._meshes=[];for(var a=[new THREE.Vector2(1,0),new THREE.Vector2(0,0),new THREE.Vector2(0,1),new THREE.Vector2(1,1)],b=0;b<this.data.length;b++){var c=this.data[b],d=this.getVideoTexture(c);if(d){var e=document.createElement("video");e.setAttribute("class","geoglobe-three-video");e.setAttribute("src",d);e.setAttribute("autoplay","autoplay");e.setAttribute("loop",
"loop");e.style.display="none";document.body.appendChild(e);d=new THREE.VideoTexture(e);d.minFilter=THREE.LinearFilter;d.magFilter=THREE.LinearFilter;d.format=THREE.RGBFormat;var d=new THREE.MeshPhongMaterial({map:d,side:THREE.DoubleSide,transparent:!0,opacity:this.opacity}),f=this.getBaseElevation(c),e=this._three._threebox.distaneToWorld(f),g=this.getElevation(c),f=this._three._threebox.distaneToWorld(f+g),h=this.getLine(c),g=this._three._threebox.projectToWorld(h[0]),h=this._three._threebox.projectToWorld(h[1]),
j=h.clone(),l=g.clone();g.z=e;h.z=e;j.z=f;l.z=f;e=[g,h,j,l];f=[new THREE.Face3(0,1,2),new THREE.Face3(0,2,3)];g=new THREE.Geometry;g.vertices=e;g.faces=f;g.computeFaceNormals();g.faceVertexUvs=[[]];g.faceVertexUvs[0][0]=[a[0],a[1],a[2]];g.faceVertexUvs[0][1]=[a[0],a[2],a[3]];g.translate(g.faces[0].normal.x*1.0E-5,g.faces[0].normal.y*1.0E-5,g.faces[0].normal.z*1.0E-5);d=new THREE.Mesh(g,d);d.visible=this.visible;d.name=(this.id?this.id:"threelayer")+"-"+b;d.userData.attributes={OriginalData:c,Layer:this};
this._three._threebox.addGeoreferencedMeshToWorld2(d);this._meshes.push(d)}else console.warn("\u89c6\u9891\u7eb9\u7406\u4e3a\u5fc5\u8981\u5c5e\u6027\uff01")}this._three._render();this._animate()},play:function(){this.autoplay=!0;this._animate()},stop:function(){this.autoplay=!1;window.cancelAnimationFrame(this._frameId)},_animate:function(){var a=this;if(a.autoplay)a._three._render(),a._frameId=window.requestAnimationFrame(function(){a._animate()})}});
GeoGlobe.Visuals.Three.TextLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,scale:1,data:[],fontURL:"",size:100,thickness:50,curveSegments:12,getPosition:function(a){if(a.geometry.type==="Point"){var b=a.geometry.coordinates;a.properties.height?b.push(a.properties.height):b.push(0);return b}else return null},getText:function(a){return a.properties.text?a.properties.text:"\u672a\u77e5\u6587\u672c"},getColor:function(a){return a.properties.color?a.properties.color:"rgb(255, 0, 0)"},getGeometry:function(a){return a},
_three:null,_meshes:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.scale=a.scale?a.scale:this.scale;this.size=a.size?a.size:this.size;this.thickness=a.thickness?a.thickness:this.thickness;this.curveSegments=a.curveSegments?a.curveSegments:this.curveSegments;this.data=a.data?a.data:this.data;this.fontURL=a.fontURL?a.fontURL:this.fontURL;this.getPosition=a.getPosition?a.getPosition:this.getPosition;
this.getText=a.getText?a.getText:this.getText;this.getColor=a.getColor?a.getColor:this.getColor;this.getGeometry=a.getGeometry?a.getGeometry:this.getGeometry},addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){var a=this;a.fontURL?(this._three._removeInnerLayer(this),this._meshes=[],(new THREE.FontLoader).load(a.fontURL,function(b){for(var c=0;c<a.data.length;c++){var d=a.data[c],e=a.getText(d),e=new THREE.TextGeometry(e,
{font:b,size:a.size,height:a.thickness,curveSegments:a.curveSegments});e.computeBoundingBox();e.computeVertexNormals();e=a.getGeometry(e,d);materials=[new THREE.MeshPhongMaterial({color:new THREE.Color(a.getColor(d)),flatShading:!0,transparent:!0,opacity:a.opacity}),new THREE.MeshPhongMaterial({color:new THREE.Color(a.getColor(d)),transparent:!0,opacity:a.opacity})];textMesh=new THREE.Mesh(e,materials);var e=a.getPosition(d),f=a.scale?a.scale:1;textMesh.visible=a.visible;textMesh.name=(a.id?a.id:
"threelayer")+"-"+c;textMesh.userData.attributes={OriginalData:d,Layer:a};a._three._threebox.addAtCoordinate(textMesh,e,{scaleToLatitude:!0,preScale:f});a._meshes.push(textMesh)}a._three._render()})):console.error("\u5b57\u4f53\u8d44\u6e90\u662f\u5fc5\u987b\u7684\u5c5e\u6027\uff01")}});
GeoGlobe.Visuals.Three.CurveLayer=GeoGlobe.Class4OL({id:"1",visible:!0,data:[],getColor:function(a){return a.properties.color?a.properties.color:"rgb(255, 0, 0)"},getTexture:function(a){return a.properties.texture?a.properties.texture:""},getLineString:function(a){return a.geometry.type==="LineString"?a.geometry.coordinates:null},getWidth:function(a){return a.properties.width?a.properties.width:1},getCurveness:function(a){return a.properties.curveness?a.properties.curveness:0.2},_three:null,_meshes:[],
_textureCache:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==void 0?a.visible:this.visible;this.texture=a.texture?a.texture:this.texture;this.data=a.data?a.data:this.data;this.getColor=a.getColor?a.getColor:this.getColor;this.getTexture=a.getTexture?a.getTexture:this.getTexture;this.getLineString=a.getLineString?a.getLineString:this.getLineString;this.getWidth=a.getWidth?a.getWidth:this.getWidth;this.getCurveness=a.getCurveness?a.getCurveness:this.getCurveness},addTo:function(a){this._three=
a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},render:function(){var a=this;this._three._removeInnerLayer(this);this._meshes=[];for(var b=[],c=[],d=[],e=[],f=0;f<this.data.length;f++){var g=this.data[f],h=this.getWidth(g),j=new THREE.Color(this.getColor(g)),l=new THREE.LineMaterial({linewidth:5.0E-4*h,color:j,opacity:1,transparent:!0}),n=[],o=[],q=[],r=this.data[f].geometry.coordinates;if(r.length>1)var m=this._three._threebox.projectToWorld(r[0]),p=this._three._threebox.projectToWorld(r[r.length-
1]),p=Math.sqrt(Math.pow(p.x-m.x,2)+Math.pow(p.y-m.y,2)+Math.pow(p.z-m.z,2));for(var t=0;t<r.length-1;t++){var n=this._three._threebox.projectToWorld(r[t]),s=this._three._threebox.projectToWorld(r[t+1]),u={x:(n.x+s.x)/2,y:(n.y+s.y)/2,z:Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2))/2*Math.tan(Math.PI/2*this.getCurveness(g))},u=new THREE.QuadraticBezierCurve3(new THREE.Vector3(n.x,n.y,n.z),new THREE.Vector3(u.x,u.y,u.z),new THREE.Vector3(s.x,s.y,s.z));if(r.length>1)u.rate1=Math.sqrt(Math.pow(n.x-
m.x,2)+Math.pow(n.y-m.y,2)+Math.pow(n.z-m.z,2))/p,u.rate2=Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2)+Math.pow(s.z-n.z,2))/p;q.push(u);n=u.getPoints(50);for(s=0;s<n.length;s++)o.push(n[s].x,n[s].y,n[s].z)}r=new THREE.LineGeometry;r.setPositions(o);l=new THREE.Line2(r,l);l.computeLineDistances();l.visible=this.visible;l.name=(this.id?this.id:"threelayer")+"-"+f;l.userData.attributes={OriginalData:g,Layer:this};this._three._threebox.addGeoreferencedMesh(l);this._meshes.push(l);b.push(o[0]);b.push(o[1]);
b.push(o[2]);c.push(j.r,j.g,j.b);d.push(10+h*h);e.push(q)}var v=new THREE.BufferGeometry,f=new THREE.ShaderMaterial({uniforms:{texture:{value:(new THREE.TextureLoader).load(this.texture)}},vertexShader:"attribute float size;varying vec3 vColor;void main() {vColor = color;vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );gl_PointSize = size;gl_Position = projectionMatrix * mvPosition;}",fragmentShader:"varying vec3 vColor;uniform sampler2D texture;void main() {gl_FragColor = vec4( vColor, 1.0 );gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );}",
blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0,vertexColors:!0});v.addAttribute("position",(new THREE.Float32BufferAttribute(b,3)).setDynamic(!0));v.addAttribute("color",new THREE.Float32BufferAttribute(c,3));v.addAttribute("size",new THREE.Float32BufferAttribute(d,1));b=new THREE.Points(v,f);b.visible=this.visible;b.name="particles";b.userData.attributes={OriginalData:g,Layer:this};this._three._threebox.addGeoreferencedMesh(b);this._meshes.push(b);this._three._render();var w=0,x;(function A(){requestAnimationFrame(A);
w+=0.005;w>1&&(w=0);for(var b=v.attributes.position.array,c=0;c<e.length;c++){if(e[c].length===1)x=e[c][0].getPoint(w);else for(var d=0;d<e[c].length;d++)if(w>=e[c][d].rate1&&w<=e[c][d].rate1+e[c][d].rate2){x=e[c][d].getPoint((w-e[c][d].rate1)/e[c][d].rate2);break}b[c*3]=x.x;b[c*3+1]=x.y;b[c*3+2]=x.z}v.attributes.position.needsUpdate=!0;a._three._render()})()}});
GeoGlobe.Visuals.Three.SingleBuildingLayer=GeoGlobe.Class4OL({id:"1",visible:!0,isCirclesVisible:!0,lightShown:!0,lightColor:"rgb(255, 255, 0)",floorColor:"white",wallColor:"yellow",movingFloorColor:"rgb(135, 135, 135)",specificFloorColor:"#00FFFF",specificWallColor:"rgb(32, 178, 170)",floorColorOpacity:0.6,wallColorOpacity:0.3,movingFloorColorOpacity:0.2,specificFloorColorOpacity:0.6,specificWallColorOpacity:0.3,isFloorLinesVisible:!0,data:{},getColor:function(a){return a.properties.color?a.properties.color:
"rgb(255, 0, 0)"},getPolygon:function(a){return a.geometry.type==="Polygon"?a.geometry.coordinates:null},getElevation:function(a){if(a.properties.levels){var b=0;JSON.parse(a.properties.levels).forEach(function(a){b+=a});return b}else return 0},_three:null,_meshes:[],_textureCache:[],_INTERSECTED_FLOOR:null,_INTERSECTED_FLOOR_2:null,_INTERSECTED_FLOOR_3:null,_INTERSECTED_WALL:null,_INTERSECTED_WALL_2:null,initialize:function(a){if(window.turf){this.id=a.id?a.id:this.id;if(a.visible!==void 0)this.visible=
a.visible;if(a.isCirclesVisible!==void 0)this.isCirclesVisible=a.isCirclesVisible;if(a.isFloorLinesVisible!==void 0)this.isFloorLinesVisible=a.isFloorLinesVisible;this.lightShown=a.lightShown!==void 0?a.lightShown:this.lightShown;this.lightColor=a.lightColor?a.lightColor:this.lightColor;this.floorColor=a.floorColor?a.floorColor:this.floorColor;this.wallColor=a.wallColor?a.wallColor:this.wallColor;this.movingFloorColor=a.movingFloorColor?a.movingFloorColor:this.movingFloorColor;this.floorColorOpacity=
a.floorColorOpacity?a.floorColorOpacity:this.floorColorOpacity;this.wallColorOpacity=a.wallColorOpacity?a.wallColorOpacity:this.wallColorOpacity;this.movingFloorColorOpacity=a.movingFloorColorOpacity?a.movingFloorColorOpacity:this.movingFloorColorOpacity;this.specificFloorColor=a.specificFloorColor?a.specificFloorColor:this.specificFloorColor;this.specificWallColor=a.specificWallColor?a.specificWallColor:this.specificWallColor;this.specificFloorColorOpacity=a.specificFloorColorOpacity?a.specificFloorColorOpacity:
this.specificFloorColorOpacity;this.specificWallColorOpacity=a.specificWallColorOpacity?a.specificWallColorOpacity:this.specificWallColorOpacity;this.data=a.data?a.data:this.data;this.isClicked=!0;this.getColor=a.getColor?a.getColor:this.getColor;this.getPolygon=a.getPolygon?a.getPolygon:this.getPolygon;this.getElevation=a.getElevation?a.getElevation:this.getElevation;this.getBaseElevation=a.getBaseElevation?a.getBaseElevation:this.getBaseElevation}else console.error("\u672a\u5f15\u5165turf.js\u5e93\uff01")},
addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},_createMaterial:function(){},_createLineGeometry:function(a){var b=new THREE.Geometry;a.forEach(function(a){b.vertices.push(a)});return b},_createGeoExtrudeGeometry:function(a,b){var c=new THREE.Shape(a),c=new THREE.GeoExtrudeGeometry(c,b),d=new THREE.Geometry;d.faceVertexUvs=c.faceVertexUvs.concat();d.faces=c.faces.concat();d.vertices=c.vertices.concat();return d},_createSideGeometry:function(a,
b){var c=new THREE.Shape(a),c=new THREE.GeoExtrudeGeometry(c,b),d=0;c.faces.forEach(function(a){a.normal.z!=0&&d++});c.faces.splice(0,d);var e=new THREE.Geometry;e.faceVertexUvs=c.faceVertexUvs.concat();e.faces=c.faces.concat();e.vertices=c.vertices.concat();return e},_createPillarMesh:function(a,b,c){var d=this,e=new THREE.Geometry;a.forEach(function(a){var g=[];a.geometry.coordinates[0].forEach(function(a){g.push(d._three._threebox.projectToWorld(a))});var a=new THREE.Shape(g),a=new THREE.GeoExtrudeGeometry(a,
b),h=new THREE.Geometry;h.faceVertexUvs=a.faceVertexUvs.concat();h.faces=a.faces.concat();h.vertices=a.vertices.concat();a=new THREE.Mesh(h,c);e.merge(a.geometry,a.matrix)});return new THREE.Mesh(e,c)},highlightFloor_Wall:function(a){this.isClicked=!0;if(this._INTERSECTED_FLOOR_3&&this._INTERSECTED_WALL_2)this._INTERSECTED_FLOOR_3.material.color=new THREE.Color("rgb(98,123,193)"),this._INTERSECTED_FLOOR_3.material.opacity=0.1,this._INTERSECTED_WALL_2.material.color=new THREE.Color("rgb(98,123,193)"),
this._INTERSECTED_WALL_2.material.opacity=0.05;var b=null,c=null;if(a.length>0){for(var d=0;d<a.length;d++){if(a[d].object.userData.tag=="__wall__")c=a[d].object;if(a[d].object.userData.tag=="__floor__"){b=a[d].object;break}}if(b&&c)if(this._INTERSECTED_FLOOR!=b&&this._INTERSECTED_WALL!=c){if(this._INTERSECTED_FLOOR&&this._INTERSECTED_WALL)this._INTERSECTED_WALL.material.color=new THREE.Color("rgb(98, 123, 193)"),this._INTERSECTED_FLOOR.material.opacity=0,this._INTERSECTED_WALL.material.color.setHex(this._INTERSECTED_WALL.currentHex),
this._INTERSECTED_WALL.material.opacity=this._INTERSECTED_WALL.currentOpacity;this._INTERSECTED_FLOOR=b;this._INTERSECTED_FLOOR.currentHex=this._INTERSECTED_FLOOR.material.color.getHex();this._INTERSECTED_FLOOR.currentOpacity=this._INTERSECTED_FLOOR.material.opacity;this._INTERSECTED_FLOOR.material.color=new THREE.Color(this.floorColor);this._INTERSECTED_FLOOR.material.opacity=this.floorColorOpacity;this._INTERSECTED_WALL=c;this._INTERSECTED_WALL.currentHex=this._INTERSECTED_WALL.material.color.getHex();
this._INTERSECTED_WALL.currentOpacity=this._INTERSECTED_WALL.material.opacity;this._INTERSECTED_WALL.material.color=new THREE.Color(this.wallColor);this._INTERSECTED_WALL.material.opacity=this.wallColorOpacity;this._three._render()}else this._INTERSECTED_FLOOR.material.color=new THREE.Color(this.floorColor),this._INTERSECTED_FLOOR.material.opacity=this.floorColorOpacity,this._INTERSECTED_WALL.material.color=new THREE.Color(this.wallColor),this._INTERSECTED_WALL.material.opacity=this.wallColorOpacity}else this._INTERSECTED_WALL=
this._INTERSECTED_FLOOR=null;return b},highlightFloor:function(a){var b=null;if(a.length>0){for(var c=0;c<a.length;c++)if(a[c].object.userData.tag=="__floor__"){b=a[c].object;break}if(b&&this._INTERSECTED_FLOOR_2!=b){if(this._INTERSECTED_FLOOR_2)this._INTERSECTED_FLOOR_2.material.color.setHex(this._INTERSECTED_FLOOR_2.currentHex),this._INTERSECTED_FLOOR_2.material.opacity=this._INTERSECTED_FLOOR_2.currentOpacity;if(this._INTERSECTED_FLOOR){if(this.isClicked)this._INTERSECTED_FLOOR.material.color=
new THREE.Color(this.floorColor),this._INTERSECTED_FLOOR.material.opacity=this.floorColorOpacity;if(!this.isClicked)this._INTERSECTED_FLOOR_3.material.color=new THREE.Color(this.specificFloorColor),this._INTERSECTED_FLOOR_3.material.opacity=this.specificFloorColorOpacity}this._INTERSECTED_FLOOR_2=b;this._INTERSECTED_FLOOR_2.currentHex=this._INTERSECTED_FLOOR_2.material.color.getHex();this._INTERSECTED_FLOOR_2.currentOpacity=this._INTERSECTED_FLOOR_2.material.opacity;this._INTERSECTED_FLOOR_2.material.color=
new THREE.Color(this.movingFloorColor);this._INTERSECTED_FLOOR_2.material.opacity=this.movingFloorColorOpacity;this._three._render()}}else this._INTERSECTED_FLOOR_2=null;return b},locateToSpecificFloor:function(a){this.isClicked=!1;if(this._INTERSECTED_FLOOR&&this._INTERSECTED_WALL)this._INTERSECTED_FLOOR.material.color=new THREE.Color("rgb(98,123,193)"),this._INTERSECTED_FLOOR.material.opacity=0.1,this._INTERSECTED_WALL.material.color=new THREE.Color("rgb(98,123,193)"),this._INTERSECTED_WALL.material.opacity=
0.05;var b=this._three._threebox.world2.getObjectByName("this is "+a+" floor"),a=this._three._threebox.world2.getObjectByName("this is "+a+" wall");if(b&&a){if(this._INTERSECTED_FLOOR_3&&this._INTERSECTED_WALL_2&&this._INTERSECTED_FLOOR_3!=b&&this._INTERSECTED_WALL_2!=a)this._INTERSECTED_FLOOR_3.material.color=new THREE.Color("rgb(98,123,193)"),this._INTERSECTED_FLOOR_3.material.opacity=0.1,this._INTERSECTED_WALL_2.material.color=new THREE.Color("rgb(98,123,193)"),this._INTERSECTED_WALL_2.material.opacity=
0.05;this._INTERSECTED_FLOOR_3=b;this._INTERSECTED_FLOOR_3.material.color=new THREE.Color(this.specificFloorColor);this._INTERSECTED_FLOOR_3.material.opacity=this.specificFloorColorOpacity;this._INTERSECTED_WALL_2=a;this._INTERSECTED_WALL_2.material.color=new THREE.Color(this.specificWallColor);this._INTERSECTED_WALL_2.material.opacity=this.specificWallColorOpacity;this._three._render();return b}},getSelectedFloor:function(a){var b=null;if(a.length>0)for(var c=0;c<a.length;c++)if(a[c].object.userData.tag==
"__floor__"){b=a[c].object;break}return b},render:function(){function a(c,d){d>1E3/60&&(A<1?(x.position.copy(C.getPointAt(A)),A+=0.01):A=0,b._three._render(),d=0);window.requestAnimationFrame(function(b){return a(b,d+b-c)})}var b=this;b._three._removeInnerLayer(b);b._meshes=[];var c=new THREE.Group;c.visible=this.visible;c.name="main part";c.userData.attributes={OriginalData:b.data,Layer:b};var d=new THREE.Group;d.visible=this.visible;d.name="extra part";d.userData.attributes={OriginalData:b.data,
Layer:b};if(b.data.geometry){var e=turf.centroid(b.data).geometry.coordinates;if(b.isCirclesVisible){var f=new THREE.MeshBasicMaterial({color:7372944,transparent:!0,opacity:0.3});[0.01,0.015,0.02,0.025,0.03,0.035,0.04,0.045,0.05,0.055].forEach(function(a){var a=turf.circle(e,a,{steps:50,units:"kilometers",properties:{}}),d=new THREE.Geometry;a.geometry.coordinates[0].forEach(function(a){d.vertices.push(b._three._threebox.projectToWorld([a[0],a[1],-1]))});a=new THREE.Line(d,f);c.add(a)})}var g=b.data.geometry.coordinates[0],
h=0,j=JSON.parse(b.data.properties.levels);j.forEach(function(a){h+=a});for(var l=b._three._threebox.distaneToWorld(h),n={steps:10,units:"kilometers",properties:{}},o=[],q=[],r=[],m=[],p=[],t=[],s=0;s<g.length;s++){var u=[],v=b._three._threebox.projectToWorld(g[s]);q.push(v.clone());var w=v.clone();w.z=l;r.push(w.clone());u.push(v.clone());u.push(w.clone());m.push(u);p.push(v.clone());t.push(v.clone());u=turf.circle(g[s],2.0E-4,n);o.push(u)}g=new THREE.MeshPhongMaterial({color:16777215,transparent:!0,
opacity:1});new THREE.MeshPhongMaterial({color:6454209,transparent:!0,opacity:0.5});q=b._createLineGeometry(q);n=b._createLineGeometry(r);r=q.clone();q=new THREE.Line(q,g);q.name="linebase";n=new THREE.Line(n,g);n.name="lineUp";c.add(q);c.add(n);l={pillar:{amount:l,bevelEnabled:!1},floor:{amount:1.0E-12,bevelEnabled:!1}};o=b._createPillarMesh(o,l.pillar,g);o.name="pillar";c.add(o);o=new THREE.MeshPhongMaterial({color:6454209,transparent:!0,opacity:0.5});p=b._createGeoExtrudeGeometry(p,l.floor);for(q=
l=0;q<j.length;q++)g=b._three._threebox.distaneToWorld(l),m=new THREE.MeshPhongMaterial({color:6454209,transparent:!0,opacity:0.1,specular:6454209,shininess:100}),n=new THREE.MeshPhongMaterial({color:6454209,transparent:!0,opacity:0.05,specular:16776960,shininess:100,side:THREE.DoubleSide}),s=p.clone(),s.translate(0,0,g),m=new THREE.Mesh(s,m),m.userData.attributes={OriginalData:b.data,Layer:b,level:q+1,tag:"__floor__"},m.userData.tag="__floor__",m.name="this is "+(q+1)+" floor",c.add(m),b.isFloorLinesVisible&&
(m=r.clone(),m.translate(0,0,g),m=new THREE.Line(m,o),c.add(m)),m={amount:b._three._threebox.distaneToWorld(j[q]),bevelEnabled:!1},m=b._createSideGeometry(t,m),m.translate(0,0,g),g=new THREE.Mesh(m,n),g.userData.attributes={OriginalData:b.data,Layer:b,level:q+1,tag:"__wall__"},g.userData.tag="__wall__",g.name="this is "+(q+1)+" wall",c.add(g),l+=j[q];var j=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:1}),t=new THREE.SphereBufferGeometry(0.001,32,16),x=new THREE.Mesh(t,j);x.position.copy(b._three._threebox.projectToWorld([e[0],
e[1],0]));x.name="sphereTarget";x.scale.copy((new THREE.Vector3(1,1,1)).multiplyScalar(b._three._threebox.projectedUnitsPerMeterInScale(e[1])));b.lightShown&&d.add(x);j=new THREE.PointLight(new THREE.Color(b.lightColor),200,0);j.matrixWorldNeedsUpdate=!0;x.add(j);b._three._threebox.addGeoreferencedMeshToWorld2(c);b._meshes.push(c);b._three._threebox.addGeoreferencedMesh(d);b._meshes.push(d);var d=b._three._threebox.projectToWorld([e[0],e[1],h]),j=b._three._threebox.projectToWorld([e[0],e[1],0]),C=
new THREE.LineCurve3(j,d),A=0;window.requestAnimationFrame(function(b){return a(b,0)})}}});
GeoGlobe.Visuals.Three.RainLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,options:{},getTexture:function(a){return a.texture?a.texture:""},getSize:function(a){return a.size?a.size:10},_three:null,_meshes:[],_textureCache:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.getTexture=a.getTexture?a.getTexture:this.getTexture;this.getSize=a.getSize?a.getSize:this.getSize;this.options=a?a:
this.options},addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},setVisible:function(a){this.visible=this.rain.visible=a},getVisible:function(){return this.visible},createRainSprites:function(a){var b=this,c=new THREE.Geometry;for(i=0;i<2E4;i++){var d=new THREE.Vector3;d.x=Math.random()*8E3-4E3;d.y=Math.random()*8E3-4E3;d.z=Math.random()*4E3;d.velocityZ=6;d.velocityX=(Math.random()-0.5)/3;c.vertices.push(d)}c.verticesNeedUpdate=!0;var d=
b.getSize(a),e=null;(a=b.getTexture(a))?((e=b._getTextureCacheByURL(a))?e=e.clone():(e=(new THREE.TextureLoader).load(a,function(){b._three._render()}),b._addTextureInToCache({key:a,value:e})),e=new THREE.PointsMaterial({size:d,map:e,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0,sizeAttenuation:!0,opacity:b.opacity})):console.error("\u672a\u8bbe\u7f6e\u7eb9\u7406\u56fe\u7247\u8d44\u6e90\u8def\u5f84\uff01");return new THREE.Points(c,e)},render:function(){var a=this;a._three._removeInnerLayer(a);
a._meshes=[];var b=a.options;a.rain=a.createRainSprites(b);a.rain.visible=a.visible;a.rain.name=a.id?a.id:"threelayer";a.rain.userData.attributes={OriginalData:b,Layer:a};b=a._three.map.getCenter();a._three._threebox.addAtCoordinate(a.rain,[b.lng,b.lat,0],{scaleToLatitude:!0,preScale:1});a._meshes.push(a.rain);a._three._render();(function d(){requestAnimationFrame(d);a.rain.geometry.vertices.forEach(function(a){a.z-=a.velocityZ;a.x-=a.velocityX*0.5;if(a.z<0)a.z=4E3});a.rain.geometry.verticesNeedUpdate=
!0;a._three._render()})();a._three.map.on("zoom",function(){if(a.getVisible())a.rain.visible=a._three.map.getZoom()<15?!1:!0});a._three.map.on("dragend",function(){if(a.rain.visible){var b=a._three.map.getCenter();a.rain.parent.position.copy(a._three._threebox.projectToWorld([b.lng,b.lat,0]))}})},_getTextureCacheByURL:function(a){if(a)for(var b=0;b<this._textureCache.length;b++)if(this._textureCache[b].key===a&&this._textureCache[b].value.image)return this._textureCache[b].value;return null},_addTextureInToCache:function(a){for(var b=
!1,c=0;c<this._textureCache.length;c++)if(this._textureCache[c].key===a.key){b=!0;break}b||this._textureCache.push(a)}});
GeoGlobe.Visuals.Three.SnowLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,options:{},getTexture:function(a){return a.texture?a.texture:""},getSize:function(a){return a.size?a.size:10},_three:null,_meshes:[],_textureCache:[],initialize:function(a){this.id=a.id?a.id:this.id;this.visible=a.visible!==void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.getTexture=a.getTexture?a.getTexture:this.getTexture;this.getSize=a.getSize?a.getSize:this.getSize;this.options=a?a:
this.options},addTo:function(a){this._three=a;this._three.addLayer(this)},remove:function(){this._three.removeLayer(this.id)},setVisible:function(a){this.visible=this.snow.visible=a},getVisible:function(){return this.visible},createSnowSprites:function(a){var b=this,c=new THREE.Geometry;for(i=0;i<2E4;i++){var d=new THREE.Vector3;d.x=Math.random()*8E3-4E3;d.y=Math.random()*8E3-4E3;d.z=Math.random()*4E3;d.velocityZ=2;d.velocityX=(Math.random()-0.5)/3;c.vertices.push(d)}c.verticesNeedUpdate=!0;var d=
b.getSize(a),e=null;(a=b.getTexture(a))?((e=b._getTextureCacheByURL(a))?e=e.clone():(e=(new THREE.TextureLoader).load(a,function(){b._three._render()}),b._addTextureInToCache({key:a,value:e})),e=new THREE.PointsMaterial({size:d,map:e,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0,sizeAttenuation:!0,opacity:b.opacity})):console.error("\u672a\u8bbe\u7f6e\u7eb9\u7406\u56fe\u7247\u8d44\u6e90\u8def\u5f84\uff01");return new THREE.Points(c,e)},render:function(){var a=this;a._three._removeInnerLayer(a);
a._meshes=[];var b=a.options;a.snow=a.createSnowSprites(b);a.snow.visible=a.visible;a.snow.name=a.id?a.id:"threelayer";a.snow.userData.attributes={OriginalData:b,Layer:a};b=a._three.map.getCenter();a._three._threebox.addAtCoordinate(a.snow,[b.lng,b.lat,0],{scaleToLatitude:!0,preScale:1});a._meshes.push(a.snow);a._three._render();(function d(){requestAnimationFrame(d);a.snow.geometry.vertices.forEach(function(a){a.z-=a.velocityZ;a.x-=a.velocityX*0.5;if(a.z<0)a.z=4E3});a.snow.geometry.verticesNeedUpdate=
!0;a._three._render()})();a._three.map.on("zoom",function(){if(a.getVisible())a.snow.visible=a._three.map.getZoom()<15?!1:!0});a._three.map.on("dragend",function(){if(a.snow.visible){var b=a._three.map.getCenter();a.snow.parent.position.copy(a._three._threebox.projectToWorld([b.lng,b.lat,0]))}})},_getTextureCacheByURL:function(a){if(a)for(var b=0;b<this._textureCache.length;b++)if(this._textureCache[b].key===a&&this._textureCache[b].value.image)return this._textureCache[b].value;return null},_addTextureInToCache:function(a){for(var b=
!1,c=0;c<this._textureCache.length;c++)if(this._textureCache[c].key===a.key){b=!0;break}b||this._textureCache.push(a)}});
GeoGlobe.Visuals.Three.BrightkiteLayer=GeoGlobe.Class4OL({id:"1",visible:!0,opacity:1,name:"\u5b9e\u65f6\u6570\u636e\u670d\u52a1",version:"1.0.0",format:"json",levelPrecision:[8,8,8],requestArgs:{},rendererOptions:{},options:{},service:"RTDS",tileSize:256,_three:null,_meshes:[],_textureCache:[],initialize:function(a){this.options=a?a:this.options;this.textureCoord=[new THREE.Vector2(1,0),new THREE.Vector2(0,0),new THREE.Vector2(0,1),new THREE.Vector2(1,1)];this.id=a.id?a.id:this.id;this.visible=a.visible!==
void 0?a.visible:this.visible;this.opacity=a.opacity?a.opacity:this.opacity;this.name=a.name?a.name:this.name;this.service=a.service?a.service:this.service;this.tileSize=a.tileSize?a.tileSize:this.tileSize;this.version=a.version?a.version:this.version;this.format=a.format?a.format:this.format;this.levelPrecision=a.levelPrecision?a.levelPrecision:this.levelPrecision;this.requestArgs=a.requestArgs?a.requestArgs:this.requestArgs;this.rendererOptions=a.rendererOptions?a.rendererOptions:this.rendererOptions;
this.getService=a.getService?a.getService:this.getService;this.projMatrix=new Float64Array(16);this.alignedProjMatrix=new Float64Array(16);this.pixelMatrix=new Float64Array(16);this.pixelMatrixInverse=new Float64Array(16);this._initMat4();this._initCalculator();this.mat4=new this.mat4;this.calculator=new this.calculator;"OffscreenCanvas"in window&&this._initWorker()},_initWorker:function(){var a=this,b,c=new Blob(["\n// debugger\n'use strict';\n\nfunction transformMat4(out, a, m){\n    var x = a[0], y = a[1], z = a[2], w = a[3];\n    out[0] = m[0] * x + m[4] * y + m[8] * z + m[12] * w;\n    out[1] = m[1] * x + m[5] * y + m[9] * z + m[13] * w;\n    out[2] = m[2] * x + m[6] * y + m[10] * z + m[14] * w;\n    out[3] = m[3] * x + m[7] * y + m[11] * z + m[15] * w;\n    return out;\n}\n\nfunction zoomTo(column, row, zoom, tileZoom){\n    var scale = Math.pow(2, tileZoom - zoom);\n    column *= scale;\n    row *= scale;\n    zoom = tileZoom;\n    \n    return {\n       column: column,\n       row: row,\n       zoom: zoom,\n    };\n}\n\nfunction locationCoordinate(lnglat, transform){\n    var column = (180 + lnglat[0]) * transform.worldSize / 360 / transform.tileSize;\n    var row = (180 - (180 / Math.PI * Math.log(Math.tan(Math.PI / 4 + lnglat[1] * Math.PI / 360)))) * transform.worldSize / 360 / transform.tileSize;\n    var zoom = transform.zoom;\n    \n    return zoomTo(column, row, zoom, transform.tileZoom);\n}\n\nfunction coordinatePoint(coord, transform){\n    var zoomedCoord = zoomTo(coord.column, coord.row, coord.zoom, transform.zoom);\n    var p = [zoomedCoord.column * transform.tileSize, zoomedCoord.row * transform.tileSize, 0, 1];\n    transformMat4(p, p, transform.pixelMatrix);\n    return {\n        x: p[0] / p[3],\n        y: p[1] / p[3]\n    };\n}\n\nfunction locationPoint(lnglat, transform){\n    return coordinatePoint(locationCoordinate(lnglat, transform), transform);\n}\n\nfunction project(lnglat, transform){\n    return locationPoint(lnglat, transform);\n}\n\n/**\n * \u6839\u636e\u5355\u4e2a\u74e6\u7247URL\u8bf7\u6c42\u77e2\u91cf\u6570\u636e\uff0c\u5e76\u53d1\u8d77\u56de\u8c03\n * @param {Object} requestArgs \u5355\u4e2a\u74e6\u7247\u7684\u5b9e\u65f6\u6570\u636e\u7684\u8bf7\u6c42\u53c2\u6570\n * @param {Function} callback \u8bf7\u6c42\u5b8c\u6210\u540e\u56de\u8c03\u51fd\u6570\n */\nfunction getCanvas(requestArgs, callback) {\n\tvar formData = new FormData();\n    formData.append('SERVICE', 'RTDS');\n    formData.append('VERSION', '"+
a.version+"');\n    formData.append('REQUEST', 'FeatureAggs');\n    formData.append('FORMAT', '"+a.format+"');\n    for(var arg in requestArgs){\n        if(requestArgs.hasOwnProperty(arg)){\n            formData.append(arg.toUpperCase(), requestArgs[arg]);\n        }\n    }\n    \n    var url = proxyHost + '"+a.service+"?'\n    formData.forEach(function(value, arg) {\n        url += arg + '=' + value + '&';\n    });\n    url = url.slice(0, -1);\n    \n\tvar xhr = new XMLHttpRequest();\n\txhr.open('GET', url, true);\n    xhr.responseType = 'json';\n    xhr.send(null);\n\txhr.onreadystatechange = function (e) {\n\t\tif (this.status === 200 && this.readyState === 4) {\n\t\t    callback(this.response);\n\t\t}\n\t};\n}\n\n/**\n * \u5c06\u8bf7\u6c42\u83b7\u5f97\u7684\u5355\u4e2a\u74e6\u7247\u77e2\u91cf\u6570\u636e\u6e32\u67d3\u6210\u6805\u683c\u56fe\u50cf\n * @param {Object} data \u8bf7\u6c42\u5355\u4e2a\u74e6\u7247\u77e2\u91cf\u6570\u636e\u8fd4\u56de\u7684\u7ed3\u679c\n * @param {Object} coordinate \u5355\u4e2a\u74e6\u7247\u884c\u5217\u53f7\n * @param {Object} transform \u5730\u56fe\u53c2\u6570\n * @param {Function} callback \u8bf7\u6c42\u5b8c\u6210\u540e\u56de\u8c03\u51fd\u6570\n*/\nfunction renderToCanvas(data, coordinate, transform, callback) {\n    //\u74e6\u7247\u79bb\u5c4f\u753b\u5e03\uff08266*266\uff09\n    var tileOffscreen = new OffscreenCanvas("+
a.tileSize+" + 10, "+a.tileSize+' + 10);\n    var tileOffscreenContext = tileOffscreen.getContext(\'2d\');\n    tileOffscreenContext.globalCompositeOperation = \'lighter\';\n    \n\tvar features = [];\n\tdata.forEach(function (elt, i) {\n\t\tfeatures.push({\n\t\t\t"type": "Feature",\n\t\t\t"properties": {name: i, value: elt.value},\n\t\t\t"geometry": {\n\t\t\t\t"type": "Point",\n\t\t\t\t"coordinates": [elt.location.X, elt.location.Y]\n\t\t\t}\n\t\t});\n\t});\n\t\n\t// \u6c42\u6781\u503c\n\tvar minValue = Number.MAX_VALUE;\n\tvar maxValue = Number.MIN_VALUE;\n\tfor (var k = 0; k < features.length; k++) {\n\t\tif (features[k].properties.value < minValue) minValue = features[k].properties.value;\n\t\tif (features[k].properties.value > maxValue) maxValue = features[k].properties.value;\n\t}\n\t//\u6807\u6ce8\u53c2\u6570\u8ba1\u7b97\n\tfor (var j = 0; j < features.length; j++) {\n\t\t//\u74e6\u7247\u4e0a\u7684\u70b9\u76f8\u5bf9\u4e8e\u753b\u5e03\u7684\u5750\u6807\n\t\tvar point = project([features[j].geometry.coordinates[0], features[j].geometry.coordinates[1]], transform);\n\t\tvar canvasCord = coordinatePoint(coordinate, transform);\n\t\tvar X = point.x - (canvasCord.x-5);\n\t\tvar Y = point.y - (canvasCord.y-5);\n\n\t\t//\u7ed8\u5236\n\t\ttileOffscreenContext.save();\n\t\ttileOffscreenContext.translate(X, Y);\n\t\ttileOffscreenContext.drawImage(spriteOffscreen, -spriteOffscreen.width / 2, -spriteOffscreen.width / 2);\n\t\ttileOffscreenContext.restore();\n\t}\n\t\n\tvar imgData = tileOffscreenContext.getImageData(5, 5, '+
a.tileSize+", "+a.tileSize+");\n\ttileOffscreen.width = "+a.tileSize+";\n\ttileOffscreen.height = "+a.tileSize+";\n\ttileOffscreenContext.putImageData(imgData, 0, 0);\n\tcallback(tileOffscreen);\n}\n\nvar proxyHost;\nvar spriteOffscreen, spriteOffscreenContext;\nself.onmessage = function(e) {\n    if(!e.data.key){\n        proxyHost = e.data.proxyHost;\n\n        //\u5c0f\u7cbe\u7075\u79bb\u5c4f\u753b\u5e03\uff0810*10\uff09\n        spriteOffscreen = new OffscreenCanvas(e.data.size, e.data.size);\n        spriteOffscreenContext = spriteOffscreen.getContext('2d');\n        \n        //\u5c0f\u7cbe\u7075\u6807\u6ce8\u989c\u8272\u914d\u7f6e\u6682\u65f6\u53ea\u652f\u6301\u5355\u8272\n        var gradient = spriteOffscreenContext.createRadialGradient(e.data.size / 2, e.data.size / 2, 0, e.data.size / 2, e.data.size / 2, e.data.size / 2);\n        gradient.addColorStop(0.15, e.data.color);\n        gradient.addColorStop(0.5, 'rgba' + e.data.rgbColor.slice(3).split(')')[0] + ',0.15)');\n        gradient.addColorStop(1, 'rgba' + e.data.rgbColor.slice(3).split(')')[0] + ',0)');\n        spriteOffscreenContext.fillStyle = gradient;\n        spriteOffscreenContext.fillRect(0, 0, e.data.size, e.data.size);\n    } else {\n        getCanvas(e.data.requestArgs, function(response){\n            renderToCanvas(response, e.data.coordinate, e.data.transform, function(canvas){\n                var bitmap = canvas.transferToImageBitmap();\n                postMessage({\n                    key: e.data.key,\n                    bitmap: bitmap\n                }, [bitmap]);\n            });\n        });\n    }\n};"],
{type:"text/javascript"});this.workerObjectURL=URL.createObjectURL(c);this.worker=new Worker(this.workerObjectURL);this.worker.onmessage=function(c){var e=document.createElement("canvas");e.width=a.tileSize;e.height=a.tileSize;e.getContext("bitmaprenderer").transferFromImageBitmap(c.data.bitmap);b=new THREE.CanvasTexture(e);a._addTextureInToCache({key:c.data.key,value:b});a._render()};this.worker.postMessage({size:this.rendererOptions.markPoint.symbolMaxSize,color:this.rendererOptions.markPoint.color,
rgbColor:GeoGlobe.Util.getRgbColor(this.rendererOptions.markPoint.color),proxyHost:location.origin+"/"+location.pathname.split("/")[1]+"/proxy?url="});URL.revokeObjectURL(this.workerObjectURL)},addTo:function(a){this._three=a;this._three.addLayer(this);this._bindEvent()},remove:function(){this._three.removeLayer(this.id)},_bindEvent:function(){var a=this;this._three.map.on("moveend",function(){a._reDraw()})},_reDraw:function(){this.update()},reDraw:function(){this._clearTextureFromCache();this.update()},
_unbindEvent:function(){for(var a=0;a<this._three.map._listeners.moveend.length;a++)this._three.map._listeners.moveend[a].name&&this._three.map._listeners.moveend[a].name==="BRIGHTKITE_MOVEEND_EVENT"&&this._three.map._listeners.moveend.splice(a,1)},getTileMesh:function(a,b,c){var d=this._three._threebox.projectToWorld(a[0]),e=this._three._threebox.projectToWorld(a[1]),f=this._three._threebox.projectToWorld(a[2]),a=this._three._threebox.projectToWorld(a[3]),e=[d,e,f,a],f=[new THREE.Face3(0,1,2),new THREE.Face3(0,
2,3)],d=new THREE.Geometry;d.vertices=e;d.faces=f;d.computeFaceNormals();d.faceVertexUvs=[[]];d.faceVertexUvs[0][0]=[c[2],c[1],c[0]];d.faceVertexUvs[0][1]=[c[2],c[0],c[3]];b=new THREE.MeshBasicMaterial({map:b,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0,opacity:this.opacity});return new THREE.Mesh(d,b)},getTileBBox:function(a,b,c){c=Math.pow(2,c);b=c-b-1;return[-2.00375083427892E7+4.00750166855784E7*a/c,-2.00375083427892E7+4.00750166855784E7*b/c,-2.00375083427892E7+4.00750166855784E7*
(a+1)/c,-2.00375083427892E7+4.00750166855784E7*(b+1)/c]},getBiggerTileBBox:function(a,b,c,d){var e=Math.pow(2,c),b=e-b-1,c=-2.00375083427892E7+4.00750166855784E7*(a+1)/e,f=-2.00375083427892E7+4.00750166855784E7*(b+1)/e,a=GeoGlobe.Util.transferToLonLat([-2.00375083427892E7+4.00750166855784E7*a/e,-2.00375083427892E7+4.00750166855784E7*b/e]),b=GeoGlobe.Util.transferToLonLat([c,f]),a=this.calculator.project(a,d);a.x-=5;a.y=a.y+this.tileSize+5;b=this.calculator.project(b,d);b.x=b.x+this.tileSize+5;b.y-=
5;a=this.calculator.unproject(a,d);b=this.calculator.unproject(b,d);return[a.lng,a.lat,b.lng,b.lat]},getCanvas:function(a,b,c,d,e){var f=this;(new GeoGlobe.Service.RTDS(this.name,this.service,{version:this.version,format:this.format,coordinate:b,key:c,transform:d})).featureAggs(a,function(a,b){var c=f.renderToCanvas(this,a,b.coordinate,b.transform);e(c,b.key)},function(){})},renderToCanvas:function(a,b,c,d){console.time("renderToCanvas");if(!this.markPointCacheCanvas){a=this.rendererOptions.markPoint.symbolMaxSize;
this.markPointCacheCanvas=document.createElement("canvas");this.markPointCacheCanvas.width=a;this.markPointCacheCanvas.height=a;var e=this.markPointCacheCanvas.getContext("2d"),f=GeoGlobe.Util.getRgbColor(this.rendererOptions.markPoint.color),g=e.createRadialGradient(a/2,a/2,0,a/2,a/2,a/2);g.addColorStop(0.15,this.rendererOptions.markPoint.color);g.addColorStop(0.5,"rgba"+f.slice(3).split(")")[0]+",0.15)");g.addColorStop(1,"rgba"+f.slice(3).split(")")[0]+",0)");e.fillStyle=g;e.fillRect(0,0,a,a)}a=
document.createElement("canvas");a.width=this.tileSize+10;a.height=this.tileSize+10;a=a.getContext("2d");a.globalCompositeOperation="lighter";var h=[];b.forEach(function(a,b){h.push({type:"Feature",properties:{name:b,value:a.value},geometry:{type:"Point",coordinates:[a.location.X,a.location.Y]}})});b=Number.MAX_VALUE;e=Number.MIN_VALUE;for(f=0;f<h.length;f++){if(h[f].properties.value<b)b=h[f].properties.value;if(h[f].properties.value>e)e=h[f].properties.value}for(b=0;b<h.length;b++)f=this.calculator.project([h[b].geometry.coordinates[0],
h[b].geometry.coordinates[1]],d),g=this.calculator.coordinatePoint(c,d),e=f.x-(g.x-5),f=f.y-(g.y-5),a.save(),a.translate(e,f),a.drawImage(this.markPointCacheCanvas,-this.markPointCacheCanvas.width/2,-this.markPointCacheCanvas.height/2),a.restore();c=document.createElement("canvas");c.width=this.tileSize;c.height=this.tileSize;d=c.getContext("2d");a=a.getImageData(5,5,this.tileSize,this.tileSize);d.putImageData(a,0,0);console.timeEnd("renderToCanvas");return c},createTexture:function(a){var b=document.createElement("canvas");
b.height=256;b.width=256;b.getContext("2d").drawImage(a,0,0);return new THREE.CanvasTexture(b)},url:function(a,b,c,d){return a.replace("{z}",String(b)).replace("{x}",String(c)).replace("{y}",String(d))},_calcMatrices:function(a){a=a.transform;if(a.height){var b=0.5/Math.tan(a.fov/2)*a.height,c=a.fov/2,d=a.x,e=a.y,f=(Math.cos(Math.PI/2)*(Math.sin(c)*b/Math.sin(Math.PI-Math.PI/2-c))+b)*1.01,c=new Float64Array(16);this.mat4.perspective(c,a.fov,a.width/a.height,1,f);this.mat4.scale(c,c,[1,-1,1]);this.mat4.translate(c,
c,[0,0,-b]);this.mat4.rotateX(c,c,0);this.mat4.rotateZ(c,c,0);this.mat4.translate(c,c,[-d,-e,0]);b=a.worldSize/(Math.PI*12756274*Math.abs(Math.cos(a.center.lat*(Math.PI/180))));a.units==="m"&&(b=a.worldSize/(a.latRange[1]-a.latRange[0]));this.mat4.scale(c,c,[1,1,b,1]);this.projMatrix=c;var b=a.width%2/2,f=a.height%2/2,g=Math.cos(a.angle),h=Math.sin(a.angle),d=d-Math.round(d)+g*b+h*f,e=e-Math.round(e)+g*f+h*b,c=new Float64Array(c);this.mat4.translate(c,c,[d>0.5?d-1:d,e>0.5?e-1:e,0]);this.alignedProjMatrix=
c;c=this.mat4.create();this.mat4.scale(c,c,[a.width/2,-a.height/2,1]);this.mat4.translate(c,c,[1,-1,0]);this.pixelMatrix=this.mat4.multiply(new Float64Array(16),c,this.projMatrix);c=this.mat4.invert(new Float64Array(16),this.pixelMatrix);if(!c)throw Error("failed to invert matrix");this.pixelMatrixInverse=c}},update:function(){var a=this,b=a._three.map.transform.coveringTiles({tileSize:a.tileSize,minzoom:0,maxzoom:22,roundZoom:!0});this._calcMatrices(a._three.map);for(var c={pixelMatrix:a.pixelMatrix,
pixelMatrixInverse:a.pixelMatrixInverse,worldSize:a._three.map.transform.worldSize,tileSize:a._three.map.transform.tileSize,tileZoom:a._three.map.transform.tileZoom,zoom:a._three.map.transform.zoom},d=0;d<b.length;d++){var e=a.getBiggerTileBBox(b[d].canonical.x,b[d].canonical.y,b[d].canonical.z,c),f=8;a.levelPrecision[b[d].canonical.z-1]&&(f=a.levelPrecision[b[d].canonical.z-1]);a.requestArgs.precision=f;a.requestArgs.bbox=JSON.stringify(e);e=b[d].toCoordinate();e.column-=1;var f=b[d].key,g=a._getTextureCacheByTileId(f);
g||("OffscreenCanvas"in window?a.worker.postMessage({key:f,coordinate:e,requestArgs:a.requestArgs,transform:c}):a.getCanvas(a.requestArgs,e,f,c,function(b,c){g=new THREE.CanvasTexture(b);a._addTextureInToCache({key:c,value:g});a._render()}))}a._render()},_render:function(){this._three._removeInnerLayer(this);this._meshes=[];for(var a=this._three.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:0,maxzoom:22,roundZoom:!0}),b=0;b<a.length;b++){var c=this.getTileBBox(a[b].canonical.x,a[b].canonical.y,
a[b].canonical.z),d=GeoGlobe.Util.transferToLonLat([c[0],c[1]]),c=GeoGlobe.Util.transferToLonLat([c[2],c[3]]),d=[d[0],d[1],c[0],c[1]],d=[[d[0],d[3]],[d[0],d[1]],[d[2],d[1]],[d[2],d[3]]];if(c=this._getTextureCacheByTileId(a[b].key))d=this.getTileMesh(d,c,this.textureCoord),d.visible=this.visible,d.name=this.id?this.id:"BrightkiteLayer",d.userData.attributes={OriginalData:this.options,Layer:this},this._three._threebox.addGeoreferencedMeshToWorld2(d),this._meshes.push(d)}this._three._render()},render:function(){this.update()},
_getTextureCacheByTileId:function(a){if(a)for(var b=0;b<this._textureCache.length;b++)if(this._textureCache[b].key===a&&this._textureCache[b].value.image)return this._textureCache[b].value;return null},_addTextureInToCache:function(a){for(var b=!1,c=0;c<this._textureCache.length;c++)if(this._textureCache[c].key===a.key){b=!0;break}b||this._textureCache.push(a);this._textureCache.length>1E3&&this._textureCache.splice(0,this._textureCache.length-1E3)},_clearTextureFromCache:function(){this._textureCache=
[]},_initCalculator:function(){this.calculator=function(){};this.calculator.prototype={project:function(a,b){return this.locationPoint(a,b)},unproject:function(a,b){return this.pointLocation(a,b)},pointLocation:function(a,b){return this.coordinateLocation(this.pointCoordinate(a,b),b)},coordinateLocation:function(a,b){var c=this.zoomTo(a.column,a.row,a.zoom,b.zoom),d=this.xLng(c.column*b.tileSize,b),c=this.yLat(c.row*b.tileSize,b);return{lng:d,lat:c}},xLng:function(a,b){return a*360/b.worldSize-180},
yLat:function(a,b){return 360/Math.PI*Math.atan(Math.exp((180-a*360/b.worldSize)*Math.PI/180))-90},pointCoordinate:function(a,b){var c=b.tileZoom,d=[a.x,a.y,0,1],e=[a.x,a.y,1,1];this.transformMat4(d,d,b.pixelMatrixInverse);this.transformMat4(e,e,b.pixelMatrixInverse);var f=d[3],g=e[3],h=d[1]/f,j=e[1]/g,l=d[2]/f,n=e[2]/g,l=l===n?0:(0-l)/(n-l),d={column:this.interp(d[0]/f,e[0]/g,l)/b.tileSize,row:this.interp(h,j,l)/b.tileSize,zoom:b.zoom};return this.zoomTo(d.column,d.row,d.zoom,c)},interp:function(a,
b,c){return a*(1-c)+b*c},locationPoint:function(a,b){return this.coordinatePoint(this.locationCoordinate(a,b),b)},coordinatePoint:function(a,b){var c=this.zoomTo(a.column,a.row,a.zoom,b.zoom),c=[c.column*b.tileSize,c.row*b.tileSize,0,1];this.transformMat4(c,c,b.pixelMatrix);return{x:c[0]/c[3],y:c[1]/c[3]}},locationCoordinate:function(a,b){return this.zoomTo((180+a[0])*b.worldSize/360/b.tileSize,(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+a[1]*Math.PI/360)))*b.worldSize/360/b.tileSize,b.zoom,b.tileZoom)},
zoomTo:function(a,b,c,d){c=Math.pow(2,d-c);a*=c;b*=c;return{column:a,row:b,zoom:d}},transformMat4:function(a,b,c){var d=b[0],e=b[1],f=b[2],b=b[3];a[0]=c[0]*d+c[4]*e+c[8]*f+c[12]*b;a[1]=c[1]*d+c[5]*e+c[9]*f+c[13]*b;a[2]=c[2]*d+c[6]*e+c[10]*f+c[14]*b;a[3]=c[3]*d+c[7]*e+c[11]*f+c[15]*b;return a}}},_initMat4:function(){this.mat4=function(){};this.mat4.prototype={create:function(){var a=new Float32Array(16);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=
0;a[14]=0;a[15]=1;return a},identity:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},translate:function(a,b,c){var d=c[0],e=c[1],c=c[2],f,g,h,j,l,n,o,q,r,m,p,t;b===a?(a[12]=b[0]*d+b[4]*e+b[8]*c+b[12],a[13]=b[1]*d+b[5]*e+b[9]*c+b[13],a[14]=b[2]*d+b[6]*e+b[10]*c+b[14],a[15]=b[3]*d+b[7]*e+b[11]*c+b[15]):(f=b[0],g=b[1],h=b[2],j=b[3],l=b[4],n=b[5],o=b[6],q=b[7],r=b[8],m=b[9],p=b[10],t=b[11],a[0]=f,a[1]=g,a[2]=h,
a[3]=j,a[4]=l,a[5]=n,a[6]=o,a[7]=q,a[8]=r,a[9]=m,a[10]=p,a[11]=t,a[12]=f*d+l*e+r*c+b[12],a[13]=g*d+n*e+m*c+b[13],a[14]=h*d+o*e+p*c+b[14],a[15]=j*d+q*e+t*c+b[15]);return a},scale:function(a,b,c){var d=c[0],e=c[1],c=c[2];a[0]=b[0]*d;a[1]=b[1]*d;a[2]=b[2]*d;a[3]=b[3]*d;a[4]=b[4]*e;a[5]=b[5]*e;a[6]=b[6]*e;a[7]=b[7]*e;a[8]=b[8]*c;a[9]=b[9]*c;a[10]=b[10]*c;a[11]=b[11]*c;a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return a},multiply:function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],j=b[5],l=b[6],
n=b[7],o=b[8],q=b[9],r=b[10],m=b[11],p=b[12],t=b[13],s=b[14],b=b[15],u=c[0],v=c[1],w=c[2],x=c[3];a[0]=u*d+v*h+w*o+x*p;a[1]=u*e+v*j+w*q+x*t;a[2]=u*f+v*l+w*r+x*s;a[3]=u*g+v*n+w*m+x*b;u=c[4];v=c[5];w=c[6];x=c[7];a[4]=u*d+v*h+w*o+x*p;a[5]=u*e+v*j+w*q+x*t;a[6]=u*f+v*l+w*r+x*s;a[7]=u*g+v*n+w*m+x*b;u=c[8];v=c[9];w=c[10];x=c[11];a[8]=u*d+v*h+w*o+x*p;a[9]=u*e+v*j+w*q+x*t;a[10]=u*f+v*l+w*r+x*s;a[11]=u*g+v*n+w*m+x*b;u=c[12];v=c[13];w=c[14];x=c[15];a[12]=u*d+v*h+w*o+x*p;a[13]=u*e+v*j+w*q+x*t;a[14]=u*f+v*l+w*
r+x*s;a[15]=u*g+v*n+w*m+x*b;return a},perspective:function(a,b,c,d,e){var b=1/Math.tan(b/2),f=1/(d-e);a[0]=b/c;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=b;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=(e+d)*f;a[11]=-1;a[12]=0;a[13]=0;a[14]=2*e*d*f;a[15]=0;return a},rotateX:function(a,b,c){var d=Math.sin(c),c=Math.cos(c),e=b[4],f=b[5],g=b[6],h=b[7],j=b[8],l=b[9],n=b[10],o=b[11];b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]);a[4]=e*c+j*d;a[5]=f*c+l*d;a[6]=g*c+n*d;a[7]=h*
c+o*d;a[8]=j*c-e*d;a[9]=l*c-f*d;a[10]=n*c-g*d;a[11]=o*c-h*d;return a},rotateZ:function(a,b,c){var d=Math.sin(c),c=Math.cos(c),e=b[0],f=b[1],g=b[2],h=b[3],j=b[4],l=b[5],n=b[6],o=b[7];b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]);a[0]=e*c+j*d;a[1]=f*c+l*d;a[2]=g*c+n*d;a[3]=h*c+o*d;a[4]=j*c-e*d;a[5]=l*c-f*d;a[6]=n*c-g*d;a[7]=o*c-h*d;return a},invert:function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],j=b[6],l=b[7],n=b[8],o=b[9],q=b[10],r=
b[11],m=b[12],p=b[13],t=b[14],s=b[15],u=c*h-d*g,v=c*j-e*g,w=c*l-f*g,x=d*j-e*h,C=d*l-f*h,A=e*l-f*j,B=n*p-o*m,y=n*t-q*m,z=n*s-r*m,E=o*t-q*p,F=o*s-r*p,G=q*s-r*t,D=u*G-v*F+w*E+x*z-C*y+A*B;if(!D)return null;D=1/D;a[0]=(h*G-j*F+l*E)*D;a[1]=(e*F-d*G-f*E)*D;a[2]=(p*A-t*C+s*x)*D;a[3]=(q*C-o*A-r*x)*D;a[4]=(j*z-g*G-l*y)*D;a[5]=(c*G-e*z+f*y)*D;a[6]=(t*w-m*A-s*v)*D;a[7]=(n*A-q*w+r*v)*D;a[8]=(g*F-h*z+l*B)*D;a[9]=(d*z-c*F-f*B)*D;a[10]=(m*C-p*w+s*u)*D;a[11]=(o*w-n*C-r*u)*D;a[12]=(h*y-g*E-j*B)*D;a[13]=(c*E-d*y+e*
B)*D;a[14]=(p*v-m*x-t*u)*D;a[15]=(n*x-o*v+q*u)*D;return a},ortho:function(a,b,c,d,e,f,g){var h=1/(b-c),j=1/(d-e),l=1/(f-g);a[0]=-2*h;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=-2*j;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=2*l;a[11]=0;a[12]=(b+c)*h;a[13]=(e+d)*j;a[14]=(g+f)*l;a[15]=1;return a}}}});
GeoGlobe.Visuals.EchartsGL=GeoGlobe.Class4OL(GeoGlobe.Visuals,{type:"echartsgl",map:null,container:null,layers:[],visualMap:null,mapbox3D:{boxHeight:10,boxWidth:100,altitudeScale:1},_echartsgl:null,initialize:function(a){GeoGlobe.Visuals.prototype.initialize.apply(this,arguments);this.layers=[];window.echarts?(this.visualMap=a.visualMap?a.visualMap:this.visualMap,this.mapbox3D=a.mapbox3D?a.mapbox3D:this.mapbox3D,console.warn("EchartsGL 1.1 \u6682\u672a\u652f\u6301\u9f20\u6807\u62fe\u53d6\u4e8b\u4ef6\uff01")):
console.error("\u4f7f\u7528EchartsGL\u53ef\u89c6\u5316\u56fe\u5c42\u524d\uff0c\u9700\u5f15\u5165echarts\u548cechartsgl\u5e93\uff01")},addTo:function(){GeoGlobe.Visuals.prototype.addTo.apply(this,arguments);this.container.className="geoglobe-echartsgl-container";this._init()},_init:function(){this._echartsgl=echarts.init(this.container);this._echartsgl._mapbox=this.map;this.mapbox3D.center=this.map.getCenter().toArray();this.mapbox3D.zoom=this.map.getZoom();this.mapbox3D.pitch=this.map.getPitch();
this.mapbox3D.bearing=this.map.getBearing();this._bindEvent()},render:function(){if(this._echartsgl.getOption())try{this.clear()}catch(a){try{this._echartsgl.dispose()}catch(b){}this._unbindEvent();this._init()}this.option={};this.visualMap&&(this.option.visualMap=this.visualMap);this.option.mapbox3D=this.mapbox3D;this.option.series=[];this.option.units=this.map.units;this.option.topTileExtent=this.map._tileExtent;if(this._order)for(var c=0;c<this._order.length;c++)for(var d=0;d<this.layers.length;d++)this.layers[d].id===
this._order[c]&&this.option.series.push(this.layers[d].getRenderOption());else for(d=0;d<this.layers.length;d++)this.option.series.push(this.layers[d].getRenderOption());this._echartsgl.setOption(this.option)},clear:function(){this._echartsgl.clear()},addLayer:function(a){a.id?this.map.getLayer(a.id)?console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u91cd\u590d\uff01"):this.layers.push(a):console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u4e3a\u7a7a\uff01")},removeLayer:function(a){for(var b=
[],c=0;c<this.layers.length;c++)a!==this.layers[c].id&&b.push(this.layers[c]);this.layers=b},moveLayer:function(a,b){this._order=this.layers.map(function(a){return a.id});this._order.splice(this._order.indexOf(a),1);this._order.splice(b?this._order.indexOf(b):this._order.length,0,a);this.render()},getLayer:function(a){for(var b=0;b<this.layers.length;b++)if(a===this.layers[b].id)return this.layers[b]},_bindEvent:function(){var a=this;this.map.on("click",function(b){a._onClick(b)});this.map.on("mousemove",
function(b){a._onMouseMove(b)});this.map.on("resize",function(){a._echartsgl.resize()})},_unbindEvent:function(){for(var a=0;a<this.map._listeners.click.length;a++)this.map._listeners.click[a].name&&this.map._listeners.click[a].name==="ECHARTSGL_CLICK_EVENT"&&this.map._listeners.click.splice(a,1);for(a=0;a<this.map._listeners.mousemove.length;a++)this.map._listeners.mousemove[a].name&&this.map._listeners.mousemove[a].name==="ECHARTSGL_MOUSEMOVE_EVENT"&&this.map._listeners.mousemove.splice(a,1);for(a=
0;a<this.map._listeners.resize.length;a++)this.map._listeners.resize[a].name&&this.map._listeners.resize[a].name==="ECHARTSGL_RESIZE_EVENT"&&this.map._listeners.resize.splice(a,1)},_onMouseMove:function(a){this.fire("overlayerhover",{param:{info:null,pickedInfos:[],event:a}})},_onClick:function(a){this.fire("overlayerclick",{param:{info:null,pickedInfos:[],event:a}})}});
GeoGlobe.Visuals.EchartsGL.BarLayer=GeoGlobe.Class4OL({id:"1",name:"",type:"bar3D",coordinateSystem:"mapbox3D",bevelSize:0,bevelSmoothness:2,stack:"",minHeight:0,itemStyle:null,data:[],label:null,emphasis:null,shading:null,realisticMaterial:null,lambertMaterial:null,colorMaterial:null,zlevel:-10,silent:!1,animation:!0,animationDurationUpdate:500,animationEasingUpdate:"cubicOut ",_parent:null,initialize:function(a){this.id=a.id?a.id:this.id;this.name=a.name?a.name:this.name;this.bevelSize=a.bevelSize?
a.bevelSize:this.bevelSize;this.bevelSmoothness=a.bevelSmoothness?a.bevelSmoothness:this.bevelSmoothness;this.stack=a.stack?a.stack:this.stack;this.minHeight=a.minHeight?a.minHeight:this.minHeight;this.itemStyle=a.itemStyle?a.itemStyle:this.itemStyle;this.label=a.label?a.label:this.label;this.emphasis=a.emphasis?a.emphasis:this.emphasis;this.data=a.data?a.data:this.data;this.shading=a.shading?a.shading:this.shading;this.realisticMaterial=a.realisticMaterial?a.realisticMaterial:this.realisticMaterial;
this.lambertMaterial=a.lambertMaterial?a.lambertMaterial:this.lambertMaterial;this.colorMaterial=a.colorMaterial?a.colorMaterial:this.colorMaterial;this.zlevel=a.zlevel?a.zlevel:this.zlevel;this.silent=a.silent?a.silent:this.silent;this.animation=a.animation?a.animation:this.animation;this.animationDurationUpdate=a.animationDurationUpdate?a.animationDurationUpdate:this.animationDurationUpdate;this.animationEasingUpdate=a.animationEasingUpdate?a.animationEasingUpdate:this.animationEasingUpdate;this.type=
"bar3D";this.coordinateSystem="mapbox3D"},addTo:function(a){this._parent=a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getRenderOption:function(){var a={};this.id&&(a.id=this.id);this.name&&(a.name=this.name);this.bevelSize&&(a.bevelSize=this.bevelSize);this.bevelSmoothness&&(a.bevelSmoothness=this.bevelSmoothness);this.stack&&(a.stack=this.stack);this.minHeight&&(a.minHeight=this.minHeight);this.itemStyle&&(a.itemStyle=
this.itemStyle);this.label&&(a.label=this.label);this.emphasis&&(a.emphasis=this.emphasis);this.shading&&(a.shading=this.shading);this.realisticMaterial&&(a.realisticMaterial=this.realisticMaterial);this.lambertMaterial&&(a.lambertMaterial=this.lambertMaterial);this.colorMaterial&&(a.colorMaterial=this.colorMaterial);this.zlevel&&(a.zlevel=this.zlevel);this.silent&&(a.silent=this.silent);this.animation&&(a.animation=this.animation);this.animationDurationUpdate&&(a.animationDurationUpdate=this.animationDurationUpdate);
this.animationEasingUpdate&&(a.animationEasingUpdate=this.animationEasingUpdate);a.type="bar3D";a.coordinateSystem="mapbox3D";if(this.data&&this.data instanceof Array){a.data=[];for(var b=0;b<this.data.length;b++)if(!this.data[b].properties||!this.data[b].geometry)console.warn("BarLayer\u4f7f\u7528\u7684\u6570\u636e\u683c\u5f0f\u4e0d\u6b63\u786e\uff0c\u8bf7\u786e\u8ba4\u4e3ageojson\u683c\u5f0f\uff01");else if(this.data[b].geometry.type!="Point")console.warn("BarLayer\u4f7f\u7528\u7684\u5fc5\u987b\u662fPoint\u51e0\u4f55\u5f62\u72b6\uff01");
else{var c={};c.name=this.data[b].properties.name;c.value=[this.data[b].geometry.coordinates[0],this.data[b].geometry.coordinates[1],this.data[b].properties.height?this.data[b].properties.height:0];this.data[b].itemStyle&&(c.itemStyle=this.data[b].itemStyle);this.data[b].label&&(c.label=this.data[b].label);this.data[b].emphasis&&(c.emphasis=this.data[b].emphasis);a.data.push(c)}}return a}});
GeoGlobe.Visuals.EchartsGL.ScatterLayer=GeoGlobe.Class4OL({id:"1",name:"",type:"scatter3D",coordinateSystem:"mapbox3D",symbol:"circle",symbolSize:10,blendMode:"source-over",itemStyle:null,data:[],label:null,emphasis:null,zlevel:-10,silent:!1,animation:!0,animationDurationUpdate:500,animationEasingUpdate:"cubicOut ",_parent:null,initialize:function(a){this.id=a.id?a.id:this.id;this.name=a.name?a.name:this.name;this.symbol=a.symbol?a.symbol:this.symbol;this.symbolSize=a.symbolSize?a.symbolSize:this.symbolSize;
this.blendMode=a.blendMode?a.blendMode:this.blendMode;this.itemStyle=a.itemStyle?a.itemStyle:this.itemStyle;this.label=a.label?a.label:this.label;this.emphasis=a.emphasis?a.emphasis:this.emphasis;this.data=a.data?a.data:this.data;this.zlevel=a.zlevel?a.zlevel:this.zlevel;this.silent=a.silent?a.silent:this.silent;this.animation=a.animation?a.animation:this.animation;this.animationDurationUpdate=a.animationDurationUpdate?a.animationDurationUpdate:this.animationDurationUpdate;this.animationEasingUpdate=
a.animationEasingUpdate?a.animationEasingUpdate:this.animationEasingUpdate},addTo:function(a){this._parent=a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getRenderOption:function(){var a={};this.id&&(a.id=this.id);this.name&&(a.name=this.name);this.symbol&&(a.symbol=this.symbol);this.symbolSize&&(a.symbolSize=this.symbolSize);this.blendMode&&(a.blendMode=this.blendMode);this.itemStyle&&(a.itemStyle=this.itemStyle);this.label&&
(a.label=this.label);this.emphasis&&(a.emphasis=this.emphasis);this.zlevel&&(a.zlevel=this.zlevel);this.silent&&(a.silent=this.silent);this.animation&&(a.animation=this.animation);this.animationDurationUpdate&&(a.animationDurationUpdate=this.animationDurationUpdate);this.animationEasingUpdate&&(a.animationEasingUpdate=this.animationEasingUpdate);a.type="scatter3D";a.coordinateSystem="mapbox3D";if(this.data&&this.data instanceof Array){a.data=[];for(var b=0;b<this.data.length;b++)if(!this.data[b].properties||
!this.data[b].geometry)console.warn("ScatterLayer\u4f7f\u7528\u7684\u6570\u636e\u683c\u5f0f\u4e0d\u6b63\u786e\uff0c\u8bf7\u786e\u8ba4\u4e3ageojson\u683c\u5f0f\uff01");else if(this.data[b].geometry.type!=="Point")console.warn("ScatterLayer\u4f7f\u7528\u7684\u5fc5\u987b\u662fPoint\u51e0\u4f55\u5f62\u72b6\uff01");else{var c={};c.name=this.data[b].properties.name;c.value=[this.data[b].geometry.coordinates[0],this.data[b].geometry.coordinates[1],this.data[b].properties.height?this.data[b].properties.height:
0];a.data.push(c)}}return a}});
GeoGlobe.Visuals.EchartsGL.LinesLayer=GeoGlobe.Class4OL({id:"1",name:"",type:"lines3D",coordinateSystem:"mapbox3D",polyline:!1,blendMode:"source-over",effect:null,lineStyle:null,data:[],zlevel:-10,silent:!1,_parent:null,initialize:function(a){this.id=a.id?a.id:this.id;this.name=a.name?a.name:this.name;this.polyline=a.polyline?a.polyline:this.polyline;this.blendMode=a.blendMode?a.blendMode:this.blendMode;this.effect=a.effect?a.effect:this.effect;this.lineStyle=a.lineStyle?a.lineStyle:this.lineStyle;
this.data=a.data?a.data:this.data;this.zlevel=a.zlevel?a.zlevel:this.zlevel;this.silent=a.silent?a.silent:this.silent},addTo:function(a){this._parent=a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getRenderOption:function(){var a={};this.id&&(a.id=this.id);this.name&&(a.name=this.name);this.polyline&&(a.polyline=this.polyline);this.blendMode&&(a.blendMode=this.blendMode);this.effect&&(a.effect=this.effect);this.lineStyle&&
(a.lineStyle=this.lineStyle);this.zlevel&&(a.zlevel=this.zlevel);this.silent&&(a.silent=this.silent);a.type="lines3D";a.coordinateSystem="mapbox3D";if(this.data&&this.data instanceof Array){a.data=[];for(var b=0;b<this.data.length;b++)if(!this.data[b].properties||!this.data[b].geometry)console.warn("LinesLayer\u4f7f\u7528\u7684\u6570\u636e\u683c\u5f0f\u4e0d\u6b63\u786e\uff0c\u8bf7\u786e\u8ba4\u4e3ageojson\u683c\u5f0f\uff01");else if(this.data[b].geometry.type!=="LineString")console.warn("LinesLayer\u4f7f\u7528\u7684\u5fc5\u987b\u662fLineString\u51e0\u4f55\u5f62\u72b6\uff01");
else{var c={};c.name=this.data[b].properties.name;c.value=this.data[b].properties.value;c.lineStyle=this.data[b].properties.lineStyle;c.coords=this.data[b].geometry.coordinates;a.data.push(c)}}return a}});
GeoGlobe.Visuals.EchartsGL.MapLayer=GeoGlobe.Class4OL({id:"1",name:"",type:"map3D",coordinateSystem:"mapbox3D",map:"",instancing:!1,label:null,emphasis:null,itemStyle:null,data:[],shading:null,realisticMaterial:null,lambertMaterial:null,colorMaterial:null,light:null,postEffect:null,temporalSuperSampling:null,zlevel:-10,_parent:null,initialize:function(a){this.id=a.id?a.id:this.id;this.name=a.name?a.name:this.name;this.map=a.map?a.map:this.map;this.instancing=a.instancing?a.instancing:this.instancing;
this.label=a.label?a.label:this.label;this.emphasis=a.emphasis?a.emphasis:this.emphasis;this.itemStyle=a.itemStyle?a.itemStyle:this.itemStyle;this.data=a.data?a.data:this.data;this.shading=a.shading?a.shading:this.shading;this.realisticMaterial=a.realisticMaterial?a.realisticMaterial:this.realisticMaterial;this.lambertMaterial=a.lambertMaterial?a.lambertMaterial:this.lambertMaterial;this.colorMaterial=a.colorMaterial?a.colorMaterial:this.colorMaterial;this.light=a.light?a.light:this.light;this.postEffect=
a.postEffect?a.postEffect:this.postEffect;this.temporalSuperSampling=a.temporalSuperSampling?a.temporalSuperSampling:this.temporalSuperSampling;this.zlevel=a.zlevel?a.zlevel:this.zlevel},addTo:function(a){this._parent=a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getRenderOption:function(){var a={};this.id&&(a.id=this.id);this.name&&(a.name=this.name);this.map&&(a.map=this.map);this.instancing&&(a.instancing=this.instancing);
this.label&&(a.label=this.label);this.emphasis&&(a.emphasis=this.emphasis);this.itemStyle&&(a.itemStyle=this.itemStyle);this.shading&&(a.shading=this.shading);this.realisticMaterial&&(a.realisticMaterial=this.realisticMaterial);this.lambertMaterial&&(a.lambertMaterial=this.lambertMaterial);this.colorMaterial&&(a.colorMaterial=this.colorMaterial);this.light&&(a.light=this.light);this.postEffect&&(a.postEffect=this.postEffect);this.temporalSuperSampling&&(a.temporalSuperSampling=this.temporalSuperSampling);
this.zlevel&&(a.zlevel=this.zlevel);a.type="map3D";a.coordinateSystem="mapbox3D";if(this.data&&this.data instanceof Array){a.data=[];for(var b=0;b<this.data.length;b++)if(!this.data[b].properties||!this.data[b].geometry)console.warn("MapLayer\u4f7f\u7528\u7684\u6570\u636e\u683c\u5f0f\u4e0d\u6b63\u786e\uff0c\u8bf7\u786e\u8ba4\u4e3ageojson\u683c\u5f0f\uff01");else if(this.data[b].geometry.type!=="Polygon")console.warn("MapLayer\u4f7f\u7528\u7684\u5fc5\u987b\u662fPolygon\u51e0\u4f55\u5f62\u72b6\uff01");
else{var c={};c.name=this.data[b].properties.name;c.height=this.data[b].properties.height;c.value=this.data[b].properties.value;a.data.push(c)}}return a}});
GeoGlobe.Visuals.Custom=GeoGlobe.Class4OL(GeoGlobe.Visuals,{type:"custom",map:null,container:null,layers:[],_order:[],initialize:function(){GeoGlobe.Visuals.prototype.initialize.apply(this,arguments);this.layers=[];this._order=[]},addTo:function(){GeoGlobe.Visuals.prototype.addTo.apply(this,arguments);this.container.className="geoglobe-custom-container";this._bindEvent()},render:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].render()},addLayer:function(a){a.id?this.map.getLayer(a.id)?
console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u91cd\u590d\uff01"):this.layers.push(a):console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u4e3a\u7a7a\uff01")},moveLayer:function(a,b){this._order=this.layers.map(function(a){return a.id});this._order.splice(this._order.indexOf(a),1);this._order.splice(b?this._order.indexOf(b):this._order.length,0,a);for(var c=0;c<this._order.length;c++)for(var d=0;d<this.layers.length;d++)if(this._order[c]===this.layers[d].id)this.layers[d].div.style.zIndex=
c},removeLayer:function(a){for(var b=[],c=0;c<this.layers.length;c++)a===this.layers[c].id?this.layers[c].destroy&&this.layers[c].destroy():b.push(this.layers[c]);this.layers=b},getLayer:function(a){for(var b=0;b<this.layers.length;b++)if(a===this.layers[b].id)return this.layers[b]},getBounds:function(a){var a=a||0,b=this.map.unproject([-a,-a]),c=this.map.unproject([this.map.transform.width+a,-a]),d=this.map.unproject([-a,this.map.transform.height+a]),a=this.map.unproject([this.map.transform.width+
a,this.map.transform.height+a]);return[[Math.min(b.lng,c.lng,d.lng,a.lng),Math.min(b.lat,c.lat,d.lat,a.lat)],[Math.max(b.lng,c.lng,d.lng,a.lng),Math.max(b.lat,c.lat,d.lat,a.lat)]]},_bindEvent:function(){var a=this;this.map.on("dragstart",function(){if(this.getPitch()===0)a.lastCenter=this.getCenter()});this.map.on("zoomstart",function(){a.layers.forEach(function(a){a.visibility&&a.onZoomStart&&a.onZoomStart()})});this.map.on("move",function(){a.lastCenter&&(a.lastCenterPixel=this.project(a.lastCenter));
a.layers.forEach(function(a){a.visibility&&a.onMove&&a.onMove()})});this.map.on("zoomend",function(){a.layers.forEach(function(a){a.visibility&&a.onZoomEnd&&a.onZoomEnd()})});this.map.on("moveend",function(){a.lastCenter=void 0;a.layers.forEach(function(a){a.visibility&&a.onMoveEnd&&a.onMoveEnd()})});this.map.on("click",function(b){a._onClick(b)});this.map.on("mousemove",function(b){a._onMouseMove(b)});this.map.on("resize",function(){a._onResize()})},_unbindEvent:function(){for(var a=0;a<this.map._listeners.dragstart.length;a++)this.map._listeners.dragstart[a].name&&
this.map._listeners.dragstart[a].name==="CUSTOM_DRAGSTART_EVENT"&&this.map._listeners.dragstart.splice(a,1);for(a=0;a<this.map._listeners.zoomstart.length;a++)this.map._listeners.zoomstart[a].name&&this.map._listeners.zoomstart[a].name==="CUSTOM_ZOOMSTART_EVENT"&&this.map._listeners.zoomstart.splice(a,1);for(a=0;a<this.map._listeners.move.length;a++)this.map._listeners.move[a].name&&this.map._listeners.move[a].name==="CUSTOM_MOVE_EVENT"&&this.map._listeners.move.splice(a,1);for(a=0;a<this.map._listeners.zoomend.length;a++)this.map._listeners.zoomend[a].name&&
this.map._listeners.zoomend[a].name==="CUSTOM_ZOOMEND_EVENT"&&this.map._listeners.zoomend.splice(a,1);for(a=0;a<this.map._listeners.moveend.length;a++)this.map._listeners.moveend[a].name&&this.map._listeners.moveend[a].name==="CUSTOM_MOVEEND_EVENT"&&this.map._listeners.moveend.splice(a,1);for(a=0;a<this.map._listeners.click.length;a++)this.map._listeners.click[a].name&&this.map._listeners.click[a].name==="CUSTOM_CLICK_EVENT"&&this.map._listeners.click.splice(a,1);for(a=0;a<this.map._listeners.mousemove.length;a++)this.map._listeners.mousemove[a].name&&
this.map._listeners.mousemove[a].name==="CUSTOM_MOUSEMOVE_EVENT"&&this.map._listeners.mousemove.splice(a,1);for(a=0;a<this.map._listeners.resize.length;a++)this.map._listeners.resize[a].name&&this.map._listeners.resize[a].name==="CUSTOM_RESIZE_EVENT"&&this.map._listeners.resize.splice(a,1)},_onClick:function(a){for(var b=0;b<this.layers.length;b++)this.layers[b].onClick&&this.layers[b].onClick(a)},_onMouseMove:function(a){for(var b=0;b<this.layers.length;b++)this.layers[b].onMouseMove&&this.layers[b].onMouseMove(a)},
_onResize:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].onResize&&this.layers[a].onResize()}});
GeoGlobe.Visuals.Custom.Bubble=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPoint:null,markPoints:[],visibility:!0,dragdrawing:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},
_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({},{markPoint:{nameField:"name",valueField:"value",hoverable:!0,clickable:!0,symbol:"bubble",symbolMinSize:20,symbolMaxSize:40,symbolNumber:Number.MAX_VALUE,symbolValueRangeScale:1,symbolSrc:"",symbolWidth:24,symbolHeight:30,effect:{show:!0,period:10,scaleSize:2,ringNumber:2,circleNumber:3},itemStyle:{flat:!0,color:"rgba(255,0,0,0.7)",lineWidth:1,shadowColor:"#000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0},label:{show:!0,
color:"#fff",align:"center",baseline:"middle",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}}},this.rendererOptions)},_initMarkPoint:function(){var a=this,b=this._rendererOptions.markPoint,c=b.effect,d=b.itemStyle,e=b.label;this.MarkPoint=function(c,e,h,j,l,n){this.index=c;this.name=
e;this.value=h;this.lon=j;this.lat=l;this.attributes=n;this.init();this.weight=(this.value-a.minValue)/(a.maxValue-a.minValue);if(isNaN(this.weight))this.weight=1;if(this.weight>1)this.weight=1;if(this.weight<0)this.weight=0;this.size=b.symbolMinSize+(b.symbolMaxSize-b.symbolMinSize)*this.weight;this.radius=this.size/2;if(d.flat)this.color=GeoGlobe.Util.getType(d.color)==="object"?"rgba("+a.gradientImageData[~~(this.weight*255+0.5)*4]+","+a.gradientImageData[~~(this.weight*255+0.5)*4+1]+","+a.gradientImageData[~~(this.weight*
255+0.5)*4+2]+","+a.gradientImageData[3]/255+")":d.color;else{if(GeoGlobe.Util.getType(d.color)!=="object"){console.error("\u975e\u6241\u5e73\u6837\u5f0f\u4e0b\u8bf7\u4f7f\u7528\u6e10\u53d8\u8272\uff01");return}var c=0,o;for(o in d.color)+o>c&&(c=+o);this.color=d.color[c]}this.rgbColor=GeoGlobe.Util.getRgbColor(this.color);this.tmpColor=this.color;this.alpha=this.color.indexOf("a(")!==-1?+this.color.split(",")[3].split(")")[0]:1;if(b.valueFilter)for(o=0;o<b.valueFilter.length;o++)if(this.value===
b.valueFilter[o])this.tmpColor=this.rgbColor=b.filterColor[o],this.size=b.filterSize[o],this.increment=b.filterIncrement[o];if(b.threshold)for(o=0;o<b.threshold.length;o++)if(b.threshold[o+1]&&b.threshold[o]<this.value&&this.value<b.threshold[o+1])this.tmpColor=this.rgbColor=b.thresholdColor[o],this.size=b.thresholdSize[o],this.increment=b.thresholdIncrement[o];switch(b.symbol){case "fire":this.fires=[];for(o=0;o<150;o++)this.fires.push(new a.Fire(this.size));break;case "water":this.waveLength=0.1;
this.waveSize=this.size*0.8;this.attenuations=[3,2];this.noises=[0.6*(this.waveSize/2-4),0.3*(this.waveSize/2-4)];this.Fs=[10,10];break;case "heatmap":this.scale=this.size/b.symbolMaxSize;break;case "sprite":this.scale=this.size/b.symbolMaxSize;this.factor=1;break;case "simple":this.factor=1}};this.MarkPoint.prototype.init=function(){switch(b.symbol){case "simple":case "bubble":case "ellipse":this.energy=c.show?Math.random()*c.scaleSize:c.scaleSize;b.increment!=void 0&&(b.increment>1||b.increment<
0)&&console.error("increment must be between 0 and 1");if(b.increment!=void 0&&b.increment==0)this.energy=1;this.increment=b.increment!=void 0?b.increment:Math.max(0.1*c.scaleSize/c.period+Math.random()*(Math.random()>0.5?1:-1)*0.002,0.001);break;case "circle":this.energy=[];for(var a=0;a<c.circleNumber;a++)this.energy.push(a/c.circleNumber);this.increment=b.increment?b.increment:Math.max(0.1*c.scaleSize/c.period+Math.random()*(Math.random()>0.5?1:-1)*0.002,0.001);break;case "ring":this.energy=[];
for(a=0;a<c.ringNumber;a++)this.energy.push(a/c.ringNumber);this.increment=b.increment?b.increment:Math.max(0.1*c.scaleSize/c.period+Math.random()*(Math.random()>0.5?1:-1)*0.002,0.001);break;case "water":this.energy=0;this.increment=b.increment?b.increment:0.1+Math.random()*(Math.random()>0.5?1:-1)*0.02;break;case "sprite":this.energy=c.show?Math.random()*c.scaleSize:c.scaleSize,this.increment=b.increment?b.increment:Math.max(0.1*c.scaleSize/c.period+Math.random()*(Math.random()>0.5?1:-1)*0.002,0.001)}};
this.MarkPoint.prototype.updateXY=function(){var c=a._parent.map.project([this.lon,this.lat]);this.x=c.x;this.y=c.y;if(b.symbol==="fire")for(c=0;c<this.fires.length;c++)this.fires[c].x=this.x,this.fires[c].y=this.y};this.MarkPoint.prototype.update=function(){var d;switch(b.symbol){case "simple":if(this.energy<=1)this.factor=1;else if(this.energy>=c.scaleSize)this.factor=-1;this.energy+=this.factor*this.increment;break;case "bubble":case "ellipse":this.energy+=this.increment;if(this.energy>c.scaleSize)this.energy=
0;break;case "circle":for(d=0;d<c.circleNumber;d++)this.energy[d]+=this.increment,this.energy[d]>1&&(this.energy[d]=0);break;case "ring":for(d=0;d<c.ringNumber;d++)this.energy[d]+=this.increment,this.energy[d]>1&&(this.energy[d]=0);break;case "fire":var e;for(d=0;d<this.fires.length;d++)e=this.fires[d],e.x+=e.speedX,e.y+=e.speedY,e.opacity-=e.increment,e.radius++,e.opacity<0&&(this.fires[d]=new a.Fire(this.size,this.x,this.y));break;case "water":this.energy=(this.energy+this.increment)%(Math.PI*64);
break;case "sprite":if(this.energy<=0.15)this.factor=1;else if(this.energy>=c.scaleSize)this.factor=-1;this.energy+=this.factor*this.increment}};this.MarkPoint.prototype.isPointInPath=function(c,d,h){c.beginPath();switch(b.symbol){case "simple":case "bubble":case "circle":case "ring":case "round":case "water":case "ellipse":case "heatmap":case "sprite":c.arc(this.x,this.y,this.radius,0,Math.PI*2,!0);break;case "pin":c.moveTo(this.x-0.5,this.y);c.quadraticCurveTo(this.x,this.y-this.radius/2,this.x-
this.radius*Math.sin(Math.PI/3),this.y-this.radius-this.radius*Math.sin(Math.PI/6));c.arc(this.x,this.y-this.radius*2,this.radius,0,Math.PI*5/6,!0);c.arc(this.x,this.y-this.radius*2,this.radius,0,Math.PI/6,!1);c.quadraticCurveTo(this.x,this.y-this.radius/2,this.x+0.5,this.y);break;case "rmb":c.font=e.fontStyle+" "+e.fontWeight+" "+this.size+"px "+e.fontFamily;if(GeoGlobe.String.isNumeric(this.value)){var j=0,l=this.size;if(b.formatter)for(var n=GeoGlobe.Util.getFormattedString({a:this.name,b:"\u7edf\u8ba1\u6570",
c:this.value},b.formatter).split("<br/>"),o=n.length,q=0;q<o;q++){var r=c.measureText(n[q]).width;r>j&&(j=r);c.fillText(n[q],this.x,this.y-((o-1)/2-q)*(this.radius*2+5))}else j=c.measureText("\uffe5"+this.value).width;c.rect(this.x-j/2,this.y-l/2,j,l)}break;case "fire":c.rect(this.x-this.size/2,this.y-this.size/2,this.size,this.size);break;case "icon":c.rect(this.x-b.symbolWidth/2,this.y-b.symbolHeight/2,b.symbolWidth,b.symbolHeight)}if(c.isPointInPath(d,h))a.hoveredMarkPoint=this};this.MarkPoint.prototype.draw1=
function(f){a.hoveredMarkPoint===this?(this.radius=this.size/2*1.1,this.color=GeoGlobe.Util.getShadeColor(this.tmpColor,20)):(this.radius=this.size/2,this.color=this.tmpColor);this.rgbColor=GeoGlobe.Util.getRgbColor(this.color);f.shadowColor=d.shadowColor;f.shadowBlur=d.shadowBlur;f.shadowOffsetX=d.shadowOffsetX;f.shadowOffsetY=d.shadowOffsetY;switch(b.symbol){case "bubble":if(a.hoveredMarkPoint===this)f.beginPath(),f.arc(this.x,this.y,this.radius*c.scaleSize/2,0,Math.PI*2,!0),f.lineWidth=~~(this.radius/
5+0.5)<2?2:~~(this.radius/5+0.5),f.strokeStyle=this.color,f.stroke();break;case "circle":case "ring":case "round":if(!d.flat)for(var g in this.color=f.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius),d.color)d.color.hasOwnProperty(g)&&(a.hoveredMarkPoint===this?this.color.addColorStop(+g,GeoGlobe.Util.getShadeColor(d.color[g],20)):this.color.addColorStop(+g,d.color[g]));f.beginPath();f.arc(this.x,this.y,this.radius,0,Math.PI*2,!0);f.fillStyle=this.color;f.fill();break;case "pin":f.beginPath();
f.moveTo(this.x+this.radius/3,this.y);f.quadraticCurveTo(this.x+this.radius/3,this.y+this.radius/10,this.x,this.y+this.radius/10);f.quadraticCurveTo(this.x-this.radius/3,this.y+this.radius/10,this.x-this.radius/3,this.y);f.quadraticCurveTo(this.x-this.radius/3,this.y-this.radius/10,this.x,this.y-this.radius/10);f.quadraticCurveTo(this.x+this.radius/3,this.y-this.radius/10,this.x+this.radius/3,this.y);f.fillStyle="rgba(0,0,0,0.3)";f.fill();f.beginPath();f.moveTo(this.x+this.radius*2/3,this.y);f.quadraticCurveTo(this.x+
this.radius*2/3,this.y+this.radius/6,this.x,this.y+this.radius/6);f.quadraticCurveTo(this.x-this.radius*2/3,this.y+this.radius/6,this.x-this.radius*2/3,this.y);f.quadraticCurveTo(this.x-this.radius*2/3,this.y-this.radius/6,this.x,this.y-this.radius/6);f.quadraticCurveTo(this.x+this.radius*2/3,this.y-this.radius/6,this.x+this.radius*2/3,this.y);f.fillStyle="rgba(0,0,0,0.2)";f.fill();f.beginPath();f.moveTo(this.x-0.5,this.y);f.quadraticCurveTo(this.x,this.y-this.radius/2,this.x-this.radius*Math.sin(Math.PI/
3),this.y-this.radius-this.radius*Math.sin(Math.PI/6));f.arc(this.x,this.y-this.radius*2,this.radius,0,Math.PI*5/6,!0);f.arc(this.x,this.y-this.radius*2,this.radius,0,Math.PI/6,!1);f.quadraticCurveTo(this.x,this.y-this.radius/2,this.x+0.5,this.y);f.fillStyle=this.color;f.fill();break;case "rmb":f.font=e.fontStyle+" "+e.fontWeight+" "+this.radius*2+"px "+e.fontFamily;f.textAlign="center";f.textBaseline="middle";f.fillStyle=this.color;if(GeoGlobe.String.isNumeric(this.value))if(b.formatter){g=GeoGlobe.Util.getFormattedString({a:this.name,
b:"\u7edf\u8ba1\u6570",c:this.value},b.formatter).split("<br/>");for(var h=g.length,j=0;j<h;j++)f.fillText(g[j],this.x,this.y-((h-1)/2-j)*(this.radius*2+5))}else f.fillText("\uffe5"+this.value,this.x,this.y);break;case "water":g=f.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);g.addColorStop(0.8,"rgba(255,255,255,0)");g.addColorStop(1,"rgba(255,255,255,1)");f.beginPath();f.arc(this.x,this.y,this.radius,0,Math.PI*2,!1);f.fillStyle=g;f.fill();break;case "heatmap":f.save();f.translate(this.x,
this.y);f.scale(this.scale,this.scale);f.drawImage(a.markPointCacheCanvas,-a.markPointCacheCanvasSize/2,-a.markPointCacheCanvasSize/2);f.restore();break;case "icon":f.save(),f.translate(this.x,this.y),f.rotate(Math.PI/180*(this.attributes.azimuth-a._parent.map.getBearing())),f.drawImage(a.markPointCacheImage,-b.symbolWidth/2,-b.symbolHeight/2,b.symbolWidth,b.symbolHeight),f.restore()}switch(b.symbol){case "bubble":case "circle":case "ring":case "round":case "water":case "ellipse":if(e.show)f.font=
e.fontStyle+" "+e.fontWeight+" "+e.fontSize+"px "+e.fontFamily,f.textAlign=e.align,f.textBaseline=e.baseline,f.fillStyle=e.color,f.fillText(this.value,this.x,this.y);break;case "pin":if(e.show)f.beginPath(),f.arc(this.x,this.y-this.radius*2,this.radius/3,0,Math.PI*2,!0),f.shadowBlur=0,f.shadowOffsetX=0,f.shadowOffsetY=0,f.fillStyle=e.color,f.fill()}};this.MarkPoint.prototype.draw2=function(e){var g;switch(b.symbol){case "simple":if(!d.flat)for(g in this.color=e.createRadialGradient(this.x,this.y,
0,this.x,this.y,this.radius*this.energy),d.color)d.color.hasOwnProperty(g)&&(a.hoveredMarkPoint===this?this.color.addColorStop(+g,GeoGlobe.Util.getShadeColor(d.color[g],20)):this.color.addColorStop(+g,d.color[g]));e.beginPath();e.arc(this.x,this.y,this.radius*this.energy,0,Math.PI*2,!0);e.fillStyle=this.color;e.fill();break;case "bubble":e.beginPath();e.arc(this.x,this.y,this.radius*this.energy,0,Math.PI*2,!0);e.lineWidth=d.lineWidth;e.strokeStyle=this.color;e.stroke();break;case "circle":for(g=0;g<
c.circleNumber;)e.beginPath(),e.arc(this.x,this.y,this.radius+this.radius*(c.scaleSize-1)*this.energy[g],0,Math.PI*2,!0),e.lineWidth=d.lineWidth,e.strokeStyle="rgba"+this.rgbColor.slice(3).split(")")[0]+","+(1-this.energy[g])*this.alpha+")",e.stroke(),g++;break;case "ring":for(g=0;g<c.ringNumber;)e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2,!1),e.arc(this.x,this.y,this.radius+this.radius*(c.scaleSize-1)*this.energy[g],0,Math.PI*2,!0),e.fillStyle="rgba"+this.rgbColor.slice(3).split(")")[0]+
","+(1-this.energy[g])*this.alpha+")",e.fill(),g++;break;case "fire":var h,j;for(g=0;g<this.fires.length;g++)h=this.fires[g],j=e.createRadialGradient(h.x,h.y,0,h.x,h.y,h.radius),j.addColorStop(0,"rgba"+this.rgbColor.slice(3).split(")")[0]+","+h.opacity+")"),j.addColorStop(0.5,"rgba"+this.rgbColor.slice(3).split(")")[0]+","+h.opacity+")"),j.addColorStop(1,"rgba"+this.rgbColor.slice(3).split(")")[0]+", 0)"),e.beginPath(),e.arc(h.x,h.y,h.radius,0,Math.PI*2,!1),e.fillStyle=j,e.globalAlpha=this.alpha,
e.fill();break;case "water":h=this.x-this.radius*0.8;j=this.y;var l,n;e.beginPath();e.moveTo(h,j);for(g=-this.waveLength;g<=this.waveLength;g+=0.01)g=parseFloat(parseFloat(g).toFixed(2)),l=h+this.waveSize*((g+this.waveLength)/(this.waveLength*2)),n=j+this.noises[0]*Math.pow(Math.sin(g*10*this.attenuations[0]),1)*Math.sin(this.Fs[0]*g-this.energy),e.lineTo(l,n);e.arc(this.x,this.y,this.radius*0.8,0,Math.PI,!1);e.fillStyle=GeoGlobe.Util.getShadeColor(this.color,-10);e.globalAlpha=this.alpha;e.fill();
e.beginPath();e.moveTo(h,j);for(g=-this.waveLength;g<=this.waveLength;g+=0.01)g=parseFloat(parseFloat(g).toFixed(2)),l=h+this.waveSize*((g+this.waveLength)/(this.waveLength*2)),n=j+this.noises[1]*Math.pow(Math.sin(g*10*this.attenuations[1]),1)*Math.sin(this.Fs[1]*g-this.energy),e.lineTo(l,n);e.arc(this.x,this.y,this.radius*0.8,0,Math.PI,!1);e.fillStyle=this.color;e.globalAlpha=1;e.fill();break;case "ellipse":j=e.createRadialGradient(this.x,this.y,this.radius*this.energy,this.x,this.y,0);j.addColorStop(0.7,
"rgba"+this.rgbColor.slice(3).split(")")[0]+", 0.5)");j.addColorStop(0.3,"rgba"+this.rgbColor.slice(3).split(")")[0]+", 1)");j.addColorStop(0.2,"rgba"+this.rgbColor.slice(3).split(")")[0]+", 1)");j.addColorStop(0,"rgba"+this.rgbColor.slice(3).split(")")[0]+", 0)");e.beginPath();e.arc(this.x,this.y,this.radius*this.energy,0,Math.PI*2,!1);e.fillStyle=j;e.globalAlpha=(1-this.energy/c.scaleSize)*this.alpha;e.fill();break;case "sprite":e.save(),e.translate(this.x,this.y),e.scale(this.scale*this.energy,
this.scale*this.energy),e.drawImage(a.markPointCacheCanvas,-a.markPointCacheCanvasSize/2,-a.markPointCacheCanvasSize/2),e.restore()}c.show&&this.update()}},_initMarkPointExtra:function(){var a=this;if(this._rendererOptions.markPoint.itemStyle.flat&&GeoGlobe.Util.getType(this._rendererOptions.markPoint.itemStyle.color)==="object")this.gradientImageData=GeoGlobe.Util.getGradientImageData(this._rendererOptions.markPoint.itemStyle.color);switch(this._rendererOptions.markPoint.symbol){case "fire":if(!this.Fire)this.Fire=
function(a,b,c){this.x=b;this.y=c;this.speedX=-1+Math.random()*2;this.speedY=-5+Math.random()*5;this.radius=0.5+Math.random();this.increment=(1+Math.random())/a;this.opacity=1};break;case "heatmap":this.markPointCacheCanvasSize=this._rendererOptions.markPoint.symbolMaxSize;this.markPointCacheCanvas=document.createElement("canvas");this.markPointCacheCanvas.width=this.markPointCacheCanvasSize;this.markPointCacheCanvas.height=this.markPointCacheCanvasSize;this.markPointCacheCanvasContext=this.markPointCacheCanvas.getContext("2d");
var b=this._rendererOptions.markPoint.symbolMaxSize/2,c=this.markPointCacheCanvasContext.createRadialGradient(b,b,0,b,b,b);c.addColorStop(0.25,"rgba(0,0,0,0.25)");c.addColorStop(1,"rgba(0,0,0,0)");this.markPointCacheCanvasContext.beginPath();this.markPointCacheCanvasContext.arc(b,b,b,0,2*Math.PI,!1);this.markPointCacheCanvasContext.fillStyle=c;this.markPointCacheCanvasContext.fill();if(!this.makeItHot)this.makeItHot=function(a,b,c,g,h){for(var g=a.getImageData(b,c,g,h),h=g.data,j=this.gradientImageData,
l=h.length/4,n,o,q;l--;)n=l*4+3,o=h[n],q=o*4,o&&(h[n-3]=j[q],h[n-2]=j[q+1],h[n-1]=j[q+2]);a.putImageData(g,b,c)};break;case "icon":this.markPointCacheImage=new Image;this.markPointCacheImage.width=this._rendererOptions.markPoint.symbolWidth;this.markPointCacheImage.height=this._rendererOptions.markPoint.symbolHeight;this.markPointCacheImage.src=this._rendererOptions.markPoint.symbolSrc;this.markPointCacheImage.onload=function(){a.drawCanvas1()};break;case "sprite":this.markPointCacheCanvasSize=this._rendererOptions.markPoint.symbolMaxSize,
this.markPointCacheCanvas=document.createElement("canvas"),this.markPointCacheCanvas.width=this.markPointCacheCanvasSize,this.markPointCacheCanvas.height=this.markPointCacheCanvasSize,this.markPointCacheCanvasContext=this.markPointCacheCanvas.getContext("2d"),b=GeoGlobe.Util.getRgbColor(this._rendererOptions.markPoint.itemStyle.color),c=this.markPointCacheCanvasContext.createRadialGradient(this.markPointCacheCanvasSize/2,this.markPointCacheCanvasSize/2,0,this.markPointCacheCanvasSize/2,this.markPointCacheCanvasSize/
2,this.markPointCacheCanvasSize/2),c.addColorStop(0.15,this._rendererOptions.markPoint.itemStyle.color),c.addColorStop(0.5,"rgba"+b.slice(3).split(")")[0]+",0.15)"),c.addColorStop(1,"rgba"+b.slice(3).split(")")[0]+",0)"),this.markPointCacheCanvasContext.fillStyle=c,this.markPointCacheCanvasContext.fillRect(0,0,this.markPointCacheCanvasSize,this.markPointCacheCanvasSize)}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvas.push(document.createElement("canvas"));
this.canvasContext.push(this.canvas[0].getContext("2d"));this.canvasContext.push(this.canvas[1].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.cacheCanvasContext.push(this.cacheCanvas[1].getContext("2d"));this.canvas[0].style.position="absolute";this.canvas[1].style.position="absolute";this.div.appendChild(this.canvas[0]);
this.div.appendChild(this.canvas[1])},_initTooltip:function(){if((this._rendererOptions.markPoint.hoverable||this._rendererOptions.markPoint.clickable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=this._rendererOptions.tooltip.padding+
"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+
"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="pre-wrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},render:function(){this._init_RendererOptions();
this._initTooltip();this._initMarkPoint();this._initMarkPointExtra();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas1();this.animation=!0;this.frame&&cancelAnimationFrame(this.frame);if(this._rendererOptions.markPoint.effect.show&&this._rendererOptions.markPoint.symbol==="simple"||this._rendererOptions.markPoint.symbol==="bubble"||this._rendererOptions.markPoint.symbol==="circle"||this._rendererOptions.markPoint.symbol==="ring"||this._rendererOptions.markPoint.symbol===
"fire"||this._rendererOptions.markPoint.symbol==="water"||this._rendererOptions.markPoint.symbol==="ellipse"||this._rendererOptions.markPoint.symbol==="sprite"){var a=this;(function c(){a.frame=requestAnimationFrame(c);(!a.moving||a.dragdrawing&&a.animation)&&a.drawCanvas2();a.animation=!0})()}},onMove:function(){this.moving=!0;this.dragdrawing?(this.cacheCanvas[1].width=this.width,this.animation=!1,this.updateXY(),this.drawCanvas1(),this.drawCanvas2()):this._parent.lastCenter?this.moveCanvas():this.clearCanvas()},
onMoveEnd:function(){this.moving=!1;this.redraw()},onClick:function(a){this.visibility&&this._rendererOptions.markPoint.clickable&&this.hoveredMarkPoint&&this._parent.fire("overlayerclick",{layer:this,feature:this.hoveredMarkPoint,event:a})},onMouseMove:function(a){this.visibility&&this._rendererOptions.markPoint.hoverable&&this.markPoints.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),this.hoveredMarkPoint&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkPoint,
event:a}))},onResize:function(){this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.canvas[1].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.resetCanvas();this.updateXY();this.drawCanvas1();this.drawCanvas2()},updateXY:function(){for(var a=this._parent.getBounds(this._rendererOptions.markPoint.symbolMaxSize/
2),b=this.markPoints.length<this._rendererOptions.markPoint.symbolNumber?this.markPoints.length:this._rendererOptions.markPoint.symbolNumber,c;b--;)c=this.markPoints[b],c.lon>=a[0][0]&&c.lon<=a[1][0]&&c.lat>=a[0][1]&&c.lat<=a[1][1]?(c.visible=!0,c.updateXY()):c.visible=!1},drawCanvas1:function(){this.cacheCanvas[0].width=this.width;if(this._rendererOptions.markPoint.symbol==="round")this.cacheCanvasContext[0].globalCompositeOperation="lighter";for(var a=this.markPoints.length<this._rendererOptions.markPoint.symbolNumber?
this.markPoints.length:this._rendererOptions.markPoint.symbolNumber,b;a--;)b=this.markPoints[a],b.visible&&b.draw1(this.cacheCanvasContext[0]);this._rendererOptions.markPoint.symbol==="heatmap"&&this.makeItHot(this.cacheCanvasContext[0],0,0,this.width,this.height);this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawCanvas2:function(){this._rendererOptions.markPoint.symbol==="bubble"?document.createElement("canvas").getContext?(this.cacheCanvasContext[1].globalCompositeOperation=
"destination-out",this.cacheCanvasContext[1].fillStyle="rgba(0, 0, 0, 0.1)",this.cacheCanvasContext[1].fillRect(0,0,this.width,this.height),this.cacheCanvasContext[1].globalCompositeOperation="source-over"):this.cacheCanvas[1].width=this.width:this._rendererOptions.markPoint.symbol==="fire"||this._rendererOptions.markPoint.symbol==="sprite"?(this.cacheCanvas[1].width=this.width,this.cacheCanvasContext[1].globalCompositeOperation="lighter"):this.cacheCanvas[1].width=this.width;this.cacheCanvasContext[1].save();
for(var a=this.markPoints.length<this._rendererOptions.markPoint.symbolNumber?this.markPoints.length:this._rendererOptions.markPoint.symbolNumber,b;a--;)b=this.markPoints[a],b.visible&&b.draw2(this.cacheCanvasContext[1]);this.canvas[1].width=this.width;this.canvasContext[1].drawImage(this.cacheCanvas[1],0,0)},moveCanvas:function(){this.canvas[0].style.left=this.canvas[1].style.left=this._parent.lastCenterPixel.x-this.width/2+"px";this.canvas[0].style.top=this.canvas[1].style.top=this._parent.lastCenterPixel.y-
this.height/2+"px"},resetCanvas:function(){this.canvas[0].style.left=this.canvas[1].style.left=this.canvas[0].style.top=this.canvas[1].style.top=""},clearCanvas:function(){this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=
[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,b){this.hoveredMarkPoint=null;for(var c,d=0,e=this.markPoints.length<this._rendererOptions.markPoint.symbolNumber?this.markPoints.length:this._rendererOptions.markPoint.symbolNumber;d<e;d++)c=this.markPoints[d],!this.hoveredMarkPoint&&c.visible&&c.isPointInPath(this.cacheCanvasContext[0],a,b);this.drawCanvas1();!this._rendererOptions.markPoint.effect.show&&this.drawCanvas2();this.hoveredMarkPoint?(this.canvas[1].style.cursor=
"pointer",this.showTooltip(this.hoveredMarkPoint.name,a,b)):(this.canvas[1].style.cursor="grab",this.hideTooltip())},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);
this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.canvas[1].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";a?this.draw():this.stopDraw()},setData:function(a){this.data=a;this.minValue=Number.MAX_VALUE;this.maxValue=Number.MIN_VALUE;for(a=0;a<this.data.length;a++){if(this.data[a].properties[this._rendererOptions.markPoint.valueField]<
this.minValue)this.minValue=this.data[a].properties[this._rendererOptions.markPoint.valueField];if(this.data[a].properties[this._rendererOptions.markPoint.valueField]>this.maxValue)this.maxValue=this.data[a].properties[this._rendererOptions.markPoint.valueField]}this.maxValue/=this._rendererOptions.markPoint.symbolValueRangeScale;for(var b=[],a=0;a<this.data.length;a++)b.push(new this.MarkPoint(a,this.data[a].properties[this._rendererOptions.markPoint.nameField],this.data[a].properties[this._rendererOptions.markPoint.valueField],
this.data[a].geometry.coordinates[0],this.data[a].geometry.coordinates[1],this.data[a].properties));this.hoveredMarkPoint=null;this.markPoints=b}});
GeoGlobe.Visuals.Custom.Migration=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPoint:null,MarkLine:null,markPoints:[],markLines:[],visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":
"none"},_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({},{markLine:{hoverable:!0,curveness:0.6,effect:{color:"#fff",scaleSize:3,period:30},itemStyle:{color:null,width:1}},markPoint:{hoverable:!0,symbol:"emptyCircle",symbolMinSize:20,symbolMaxSize:40,effect:{scaleSize:2,period:30},itemStyle:{color:"rgba(255,0,0,0.5)",shadowColor:"#000000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0},label:{show:!0,color:"#fff",align:"center",baseline:"middle",fontFamily:"serif",fontSize:12,
fontStyle:"normal",fontWeight:"normal"}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}}},this.rendererOptions)},_initMarkPoint:function(){var a=this,b=this._rendererOptions.markPoint.symbol,c=this._rendererOptions.markPoint.symbolMinSize,d=this._rendererOptions.markPoint.symbolMaxSize,e=this._rendererOptions.markPoint.effect,f=this._rendererOptions.markPoint.itemStyle;
if(typeof f.color==="object")var g=GeoGlobe.Util.getGradientImageData(f.color);var h=this._rendererOptions.markPoint.label;this.MarkPoint=function(b,e,h,o,q){this.index=b;this.name=e;this.value=h;this.lon=o;this.lat=q;this.init();this.weight=(this.value-a.minValue)/(a.maxValue-a.minValue);if(isNaN(this.weight))this.weight=1;if(this.weight>1)this.weight=1;if(this.weight<0)this.weight=0;this.size=c+(d-c)*this.weight;this.radius=this.size/2;this.color=typeof f.color==="object"?"rgba("+g[parseInt(this.weight*
255,10)*4]+","+g[parseInt(this.weight*255,10)*4+1]+","+g[parseInt(this.weight*255,10)*4+2]+","+g[3]/255+")":f.color;this.rgbColor=GeoGlobe.Util.getRgbColor(this.color);this.tmpColor=this.color};this.MarkPoint.prototype.init=function(){switch(b){case "circle":this.energy=[0,1/3,2/3];break;case "ring":this.energy=[0,0.25*e.scaleSize,0.5*e.scaleSize,0.75*e.scaleSize];break;case "emptyCircle":this.energy=0}this.increment=Math.max(0.1*e.scaleSize/e.period+Math.random()*(Math.random()>0.5?1:-1)*0.002,0.001)};
this.MarkPoint.prototype.updateXY=function(){var b=a._parent.map.project([this.lon,this.lat]);this.x=b.x;this.y=b.y};this.MarkPoint.prototype.update=function(){var a;switch(b){case "circle":for(a=0;a<3;a++)this.energy[a]<1?this.energy[a]+=this.increment:this.energy[a]=0;break;case "ring":for(a=0;a<4;a++)this.energy[a]<e.scaleSize?this.energy[a]+=this.increment:this.energy[a]=0;break;case "emptyCircle":this.energy<e.scaleSize?this.energy+=this.increment:this.energy=0}};this.MarkPoint.prototype.isPointInPath=
function(b,c,d){b.beginPath();b.arc(this.x,this.y,this.size/2,0,Math.PI*2,!0);if(b.isPointInPath(c,d))a.hoveredMarkPoint=this};this.MarkPoint.prototype.draw1=function(c){a.hoveredMarkPoint===this?(this.radius=this.size/2*1.1,this.color=GeoGlobe.Util.getShadeColor(this.tmpColor,20)):(this.radius=this.size/2,this.color=this.tmpColor);this.rgbColor=GeoGlobe.Util.getRgbColor(this.color);c.shadowColor=f.shadowColor;c.shadowBlur=f.shadowBlur;c.shadowOffsetX=f.shadowOffsetX;c.shadowOffsetY=f.shadowOffsetY;
switch(b){case "circle":c.beginPath();c.arc(this.x,this.y,this.radius,0,Math.PI*2,!0);c.fillStyle=this.color;c.fill();break;case "emptyCircle":if(a.hoveredMarkPoint===this)c.beginPath(),c.arc(this.x,this.y,this.radius*e.scaleSize/2,0,Math.PI*2,!0),c.lineWidth=Math.round(this.radius/5)<2?2:Math.round(this.radius/5),c.strokeStyle=this.color,c.stroke()}};this.MarkPoint.prototype.draw2=function(a){this.update();var c;switch(b){case "circle":for(c=0;c<3;)a.beginPath(),a.arc(this.x,this.y,this.radius+this.radius*
(e.scaleSize-1)*this.energy[c],0,Math.PI*2,!0),a.strokeStyle="rgba"+this.rgbColor.slice(3).split(")")[0]+","+(1-this.energy[c])+")",a.stroke(),c++;break;case "ring":for(c=0;c<4;)a.beginPath(),a.arc(this.x,this.y,this.radius*this.energy[c],0,Math.PI*2,!0),a.fillStyle="rgba"+this.rgbColor.slice(3).split(")")[0]+","+Math.max(1-this.energy[c]/e.scaleSize,0)+")",a.fill(),c++;break;case "emptyCircle":a.beginPath(),a.arc(this.x,this.y,this.radius*this.energy,0,Math.PI*2,!0),a.strokeStyle=this.color,a.stroke()}if(h.show)a.font=
h.fontStyle+" "+h.fontWeight+" "+h.fontSize+"px "+h.fontFamily,a.textAlign=h.align,a.textBaseline=h.baseline,a.fillStyle=h.color?h.color:this.color,a.fillText(this.value,this.x,this.y)}},_initMarkLine:function(){var a=this,b=this._rendererOptions.markLine.effect,c=this._rendererOptions.markLine.itemStyle;this.MarkLine=function(d,e,f){var g=this;this.index=d;this.start=e;this.end=f;this.color=c.color?c.color:a.direction==="out"?f.color:e.color;this.width=c.width;this.effect={radius:c.width*b.scaleSize/
2,color:b.color,increment:0.1/b.period,init:function(){this.energy=0},update:function(){this.energy<1?(this.energy+=this.increment,a._rendererOptions.markLine.curveness!==0?(this.x=Math.pow(1-this.energy,2)*g.p1.x+2*this.energy*(1-this.energy)*g.cp.x+Math.pow(this.energy,2)*g.p2.x,this.y=Math.pow(1-this.energy,2)*g.p1.y+2*this.energy*(1-this.energy)*g.cp.y+Math.pow(this.energy,2)*g.p2.y):(this.x=g.p1.x+this.energy*(g.p2.x-g.p1.x),this.y=g.p1.y+this.energy*(g.p2.y-g.p1.y))):this.init()},draw:function(a){this.update();
a.beginPath();a.arc(this.x,this.y,this.radius,0,Math.PI*2,!0);a.fillStyle=this.color;a.fill();a.closePath()}}};this.MarkLine.prototype.updateXY=function(){this.p1=a._parent.map.project([this.start.lon,this.start.lat]);this.p2=a._parent.map.project([this.end.lon,this.end.lat]);a._rendererOptions.markLine.curveness!==0&&this.getControlPoint()};this.MarkLine.prototype.getControlPoint=function(){var b=a._rendererOptions.markLine.curveness/2,c=Math.sqrt(Math.pow(this.p1.x-this.p2.x,2)+Math.pow(this.p1.y-
this.p2.y,2)),f=c/2/Math.cos(b);this.p1.x===this.p2.x?this.cp=this.p1.y>this.p2.y?{x:this.p1.x-Math.round(f*Math.sin(b)),y:this.p1.y-Math.round(f*Math.cos(b))}:this.p1.y===this.p2.y?{x:this.p1.x,y:this.p1.y}:{x:this.p1.x+Math.round(f*Math.sin(b)),y:this.p1.y+Math.round(f*Math.cos(b))}:this.p1.x<this.p2.x?this.p1.y>this.p2.y?(c=Math.asin((this.p2.x-this.p1.x)/c),this.cp=c<b?{x:this.p1.x-Math.round(f*Math.sin(b-c)),y:this.p1.y-Math.round(f*Math.cos(b-c))}:c===b?{x:this.p1.x,y:this.p1.y-f}:{x:this.p1.x+
Math.round(f*Math.sin(c-b)),y:this.p1.y-Math.round(f*Math.cos(c-b))}):this.p1.y===this.p2.y?this.cp={x:this.p1.x+Math.round(f*Math.cos(b)),y:this.p1.y-Math.round(f*Math.sin(b))}:(c=Math.PI-Math.asin((this.p2.x-this.p1.x)/c),this.cp=c<Math.PI/2+b?{x:this.p1.x+Math.round(f*Math.cos(b-(c-Math.PI/2))),y:this.p1.y-Math.round(f*Math.sin(b-(c-Math.PI/2)))}:c===Math.PI/2+b?{x:this.p1.x+f,y:this.p1.y}:{x:this.p1.x+Math.round(f*Math.cos(c-Math.PI/2-b)),y:this.p1.y+Math.round(f*Math.sin(c-Math.PI/2-b))}):this.p1.y<
this.p2.y?(c=Math.PI+Math.asin((this.p1.x-this.p2.x)/c),this.cp=c<Math.PI+b?{x:this.p1.x+Math.round(f*Math.sin(b-(c-Math.PI))),y:this.p1.y+Math.round(f*Math.cos(b-(c-Math.PI)))}:c===Math.PI+b?{x:this.p1.x,y:this.p1.y+f}:{x:this.p1.x-Math.round(f*Math.sin(c-Math.PI-b)),y:this.p1.y+Math.round(f*Math.cos(c-Math.PI-b))}):this.p1.y===this.p2.y?this.cp={x:this.p1.x-Math.round(f*Math.cos(b)),y:this.p1.y+Math.round(f*Math.sin(b))}:(c=Math.PI*3/2+Math.acos((this.p1.x-this.p2.x)/c),this.cp=c<Math.PI*3/2+b?
{x:this.p1.x-Math.round(f*Math.cos(b-(c-Math.PI*3/2))),y:this.p1.y+Math.round(f*Math.sin(b-(c-Math.PI*3/2)))}:c===Math.PI*3/2+b?{x:this.p1.x-f,y:this.p1.y}:{x:this.p1.x-Math.round(f*Math.cos(c-Math.PI*3/2-b)),y:this.p1.y-Math.round(f*Math.sin(c-Math.PI*3/2-b))})};this.MarkLine.prototype.isPointInStroke=function(b,c,f){b.beginPath();b.moveTo(this.p1.x,this.p1.y);a._rendererOptions.markLine.curveness!==0?b.quadraticCurveTo(this.cp.x,this.cp.y,this.p2.x,this.p2.y):b.lineTo(this.p2.x,this.p2.y);if(b.isPointInStroke(c,
f))a.hoveredMarkLine=this};this.MarkLine.prototype.draw=function(b){a.hoveredMarkLine===this?(this.color=GeoGlobe.Util.getShadeColor(c.color?c.color:a.direction==="out"?this.end.color:this.start.color,20),this.width=c.width*1.1):(this.color=c.color?c.color:a.direction==="out"?this.end.color:this.start.color,this.width=c.width);b.beginPath();b.moveTo(this.p1.x,this.p1.y);a._rendererOptions.markLine.curveness!==0?b.quadraticCurveTo(this.cp.x,this.cp.y,this.p2.x,this.p2.y):b.lineTo(this.p2.x,this.p2.y);
b.lineWidth=this.width;b.strokeStyle=this.color;b.stroke()}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvas.push(document.createElement("canvas"));this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.canvasContext.push(this.canvas[1].getContext("2d"));this.canvasContext.push(this.canvas[2].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));
this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.cacheCanvasContext.push(this.cacheCanvas[1].getContext("2d"));this.cacheCanvasContext.push(this.cacheCanvas[2].getContext("2d"));this.canvas[0].style.position="absolute";this.canvas[1].style.position="absolute";this.canvas[2].style.position="absolute";this.div.appendChild(this.canvas[0]);this.div.appendChild(this.canvas[1]);
this.div.appendChild(this.canvas[2])},_initTooltip:function(){if((this._rendererOptions.markLine.hoverable||this._rendererOptions.markPoint.hoverable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=this._rendererOptions.tooltip.padding+
"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+
"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="nowrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},render:function(){this._init_RendererOptions();this._initMarkPoint();
this._initMarkLine();this._initTooltip();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas1();this.animation=!0;this.frame&&cancelAnimationFrame(this.frame);var a=this;(function c(){a.frame=requestAnimationFrame(c);a.animation&&a.drawCanvas2();a.animation&&a.drawCanvas3();a.animation=!0})()},onMove:function(){this.cacheCanvas[1].width=this.cacheCanvas[2].width=this.width;this.animation=!1;this.updateXY();this.drawCanvas1();this.drawCanvas2();this.drawCanvas3()},
onMoveEnd:function(){this.redraw()},onMouseMove:function(a){if(this.visibility&&(this._rendererOptions.markLine.hoverable||this._rendererOptions.markPoint.hoverable)&&this.markPoints.length>0&&!this._parent.map.moving)this.hover(a.point.x,a.point.y),this.hoveredMarkPoint&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkPoint,event:a})},onResize:function(){this.canvas[0].width=this.canvas[1].width=this.canvas[2].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.cacheCanvas[2].width=
this.width=this._parent.map.transform.width;this.canvas[0].height=this.canvas[1].height=this.canvas[2].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.cacheCanvas[2].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();this.drawCanvas1();this.drawCanvas2();this.drawCanvas3()},updateXY:function(){for(var a=this.markPoints.length;a--;)this.markPoints[a].updateXY(),this.markLines[a].updateXY()},drawCanvas1:function(){this.cacheCanvas[0].width=
this.width;for(var a=this.markLines.length;a--;)this.markLines[a].draw(this.cacheCanvasContext[0]);for(a=this.markPoints.length;a--;)this.markPoints[a].draw1(this.cacheCanvasContext[0]);this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawCanvas2:function(){document.createElement("canvas").getContext?(this.cacheCanvasContext[1].globalCompositeOperation="destination-out",this.cacheCanvasContext[1].fillStyle="rgba(0, 0, 0, 0.05)",this.cacheCanvasContext[1].fillRect(0,
0,this.width,this.height),this.cacheCanvasContext[1].globalCompositeOperation="source-over"):this.cacheCanvas[1].width=this.width;this.cacheCanvasContext[1].save();for(var a=this.markLines.length;a--;)this.markLines[a].effect.draw(this.cacheCanvasContext[1]);this.cacheCanvasContext[1].restore();this.canvas[1].width=this.width;this.canvasContext[1].drawImage(this.cacheCanvas[1],0,0)},drawCanvas3:function(){this._rendererOptions.markPoint.symbol==="emptyCircle"?document.createElement("canvas").getContext?
(this.cacheCanvasContext[2].globalCompositeOperation="destination-out",this.cacheCanvasContext[2].fillStyle="rgba(0, 0, 0, 0.05)",this.cacheCanvasContext[2].fillRect(0,0,this.width,this.height),this.cacheCanvasContext[2].globalCompositeOperation="source-over"):this.cacheCanvas[2].width=this.width:this._rendererOptions.markPoint.symbol==="ring"?(this.cacheCanvas[2].width=this.width,this.cacheCanvasContext[2].globalCompositeOperation="lighter"):this.cacheCanvas[2].width=this.width;this.cacheCanvasContext[2].save();
for(var a=this.markPoints.length;a--;)this.markPoints[a].draw2(this.cacheCanvasContext[2]);this.cacheCanvasContext[2].restore();this.canvas[2].width=this.width;this.canvasContext[2].drawImage(this.cacheCanvas[2],0,0)},clearCanvas:function(){this.canvas[0].width=this.canvas[1].width=this.canvas[2].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.cacheCanvas[2].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();
this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,b){this.hoveredMarkLine=null;this.lastHoveredMarkPoint=this.hoveredMarkPoint?GeoGlobe.Util.clone(this.hoveredMarkPoint):null;this.hoveredMarkPoint=null;var c,d;c=0;for(d=this.markLines.length;c<d;c++)!this.hoveredMarkLine&&this.markLines[c].isPointInStroke(this.cacheCanvasContext[0],
a,b);c=0;for(d=this.markPoints.length;c<d;c++)!this.hoveredMarkPoint&&this.markPoints[c].isPointInPath(this.cacheCanvasContext[0],a,b);this.drawCanvas1();this.hoveredMarkLine||this.hoveredMarkPoint?(this.showTooltip(this.hoveredMarkLine?this.hoveredMarkLine.start.name+" > "+this.hoveredMarkLine.end.name:this.hoveredMarkPoint.name,a,b),this.canvas[2].style.cursor="pointer"):(this.hideTooltip(),this.canvas[2].style.cursor="grab")},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=
a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.canvas[1].width=this.canvas[2].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.cacheCanvas[2].width=this.width=this._parent.map.transform.width;
this.canvas[0].height=this.canvas[1].height=this.canvas[2].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.cacheCanvas[2].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";a?this.draw():this.stopDraw()},setData:function(a){this.data=a;this.minValue=Number.MAX_VALUE;this.maxValue=Number.MIN_VALUE;for(var b=0;b<a.length;b++){if(a[b].properties.value<this.minValue)this.minValue=a[b].properties.value;
if(a[b].properties.value>this.maxValue)this.maxValue=a[b].properties.value}for(var c=new this.MarkPoint(void 0,this.location.name,0,this.location.lonLat[0],this.location.lonLat[1]),d=[],e=[],b=0;b<a.length;b++)d.push(new this.MarkPoint(b,a[b].properties.name,a[b].properties.value,a[b].geometry.coordinates[0],a[b].geometry.coordinates[1])),e.push(this.direction==="out"?new this.MarkLine(b,c,d[b]):new this.MarkLine(b,d[b],c));this.hoveredMarkLine=this.hoveredMarkPoint=null;this.markPoints=d;this.markLines=
e}});
GeoGlobe.Visuals.Custom.Commute=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPoint:null,MarkLine:null,markPoints:[],markLines:{items:[],option:{}},visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?
"block":"none"},_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({},{markLine:{effect:{color:"rgba(255,255,255,0.7)",scaleSize:60,period:15},itemStyle:{color:"rgba(255,58,53,0.9)",width:0.1}},markPoint:{hoverable:!0,symbolSize:30,effect:{scaleSize:2,period:15},itemStyle:{color:"rgba(255,255,255,0.7)"}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",fontFamily:"serif",fontSize:12,fontStyle:"normal",
fontWeight:"normal"}}},this.rendererOptions)},_initMarkPoint:function(){var a=this,b=this._rendererOptions.markPoint.symbolSize,c=this._rendererOptions.markPoint.effect,d=this._rendererOptions.markPoint.itemStyle;this.MarkPoint=function(a,c,g,h){this.index=a;this.name=c;this.lon=g;this.lat=h;this.init();this.radius=b/2;this.color=d.color;this.rgbColor=GeoGlobe.Util.getRgbColor(d.color)};this.MarkPoint.prototype.init=function(){this.energy=0;this.increment=0.1*c.scaleSize/c.period+Math.random()*(Math.random()>
0.5?1:-1)*0.002};this.MarkPoint.prototype.updateXY=function(){var b=a._parent.map.project([this.lon,this.lat]);this.x=b.x;this.y=b.y};this.MarkPoint.prototype.update=function(){this.energy<c.scaleSize?this.energy+=this.increment:this.energy=0};this.MarkPoint.prototype.isPointInPath=function(b,c,d){b.beginPath();b.arc(this.x,this.y,this.radius,0,Math.PI*2,!0);if(b.isPointInPath(c,d))a.hoveredMarkPoint=this};this.MarkPoint.prototype.draw=function(b){this.update();b.beginPath();b.arc(this.x,this.y,this.radius*
this.energy,0,Math.PI*2,!0);b.globalAlpha=1;b.strokeStyle=this.color;b.stroke();if(a.hoveredMarkPoint===this)b.beginPath(),b.arc(this.x,this.y,this.radius*c.scaleSize/2,0,Math.PI*2,!0),b.lineWidth=Math.round(this.radius/5)<2?2:Math.round(this.radius/5),b.strokeStyle=this.color,b.globalAlpha=0.1,b.stroke()}},_initMarkLine:function(){var a=this,b=this._rendererOptions.markLine.effect,c=this._rendererOptions.markLine.itemStyle;this.MarkLine=function(d,e){this.index=d;this.points=e;if(d<~~(a.markLines.option.linesNumber/
10)){var f=this;this.effect={radius:c.width*b.scaleSize/2,color:b.color,pointIndex:~~(Math.random()*this.points.length),update:function(){a.markLines.option.factor===1?(this.pointIndex+=a.markLines.option.lineIncrement+0.1,this.pointIndex>f.points.length-1&&(this.pointIndex=0)):(this.pointIndex-=a.markLines.option.lineIncrement-0.1,this.pointIndex<0&&(this.pointIndex=f.points.length-1));this.pointIndex=Math.round(this.pointIndex)},draw:function(b){this.update();b.beginPath();d<~~(a.markLines.option.linesNumber/
200)?b.arc(f.points[this.pointIndex].x,f.points[this.pointIndex].y,this.radius,0,Math.PI*2,!0):b.rect(f.points[this.pointIndex].x-1,f.points[this.pointIndex].y-1,2,2);b.fillStyle=this.color;b.fill()}}}};this.MarkLine.prototype.updateXY=function(){for(var b=0;b<this.points.length;b++){var c=a._parent.map.project([this.points[b].lon,this.points[b].lat]);this.points[b].x=c.x;this.points[b].y=c.y}};this.MarkLine.prototype.path=function(a,b){a>this.points.length&&(a=this.points.length);for(var c=0;c<a;c++)c===
0?b.moveTo(this.points[0].x,this.points[0].y):b.lineTo(this.points[c].x,this.points[c].y)}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.canvasContext.push(this.canvas[1].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvas.push(document.createElement("canvas"));
this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.cacheCanvasContext.push(this.cacheCanvas[1].getContext("2d"));this.canvas[0].style.position="absolute";this.canvas[1].style.position="absolute";this.div.appendChild(this.canvas[0]);this.div.appendChild(this.canvas[1])},_initTooltip:function(){if(this._rendererOptions.markPoint.hoverable&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position=
"relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=this._rendererOptions.tooltip.padding+"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=
document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="nowrap",
this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},render:function(){this._init_RendererOptions();this._initTooltip();this._initMarkPoint();this._initMarkLine();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.animation=!0;this.frame&&cancelAnimationFrame(this.frame);var a=this;(function c(){a.frame=requestAnimationFrame(c);a.animation&&
a.drawCanvas1();a.animation&&a.drawCanvas2();a.animation=!0})()},onMove:function(){this.animation=!1;this.updateXY();this.drawCanvas1();this.drawCanvas2()},onMoveEnd:function(){this.redraw()},onMouseMove:function(a){this.visibility&&this._rendererOptions.markPoint.hoverable&&this.markPoints.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),this.hoveredMarkPoint&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkPoint,event:a}))},onResize:function(){this.canvas[0].width=
this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.canvas[1].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();this.drawCanvas1();this.drawCanvas2()},updateXY:function(){for(var a=this.markLines.items.length;a--;)this.markLines.items[a].updateXY();for(a=this.markPoints.length;a--;)this.markPoints[a].updateXY()},
drawCanvas1:function(){this.cacheCanvas[0].width=this.width;this.cacheCanvasContext[0].globalCompositeOperation="lighter";var a,b,c=this.markLines.items,d=this.markLines.option;if(c.length>0){this.cacheCanvasContext[0].beginPath();switch(d.step){case 1:d.lineLength+=d.lineIncrement+0.1;a=0;for(b=~~(d.linesNumber*2/3);a<b;a++)c[a].path(Math.round(d.lineLength),this.cacheCanvasContext[0]);d.lineLength>d.linePointsNumber-1&&(d.factor=1,d.lineLength=0,d.step=2);break;case 2:a=0;for(b=~~(d.linesNumber*
2/3);a<b;a++)c[a].path(d.linePointsNumber,this.cacheCanvasContext[0]);d.lineLength+=d.lineIncrement+0.1;a=~~(d.linesNumber*2/3);for(b=d.linesNumber;a<b;a++)c[a].path(Math.round(d.lineLength),this.cacheCanvasContext[0]);d.lineLength>d.linePointsNumber-1&&(d.factor=-1,d.lineLength=d.linePointsNumber-1,d.step=3);break;case 3:a=0;for(b=~~(d.linesNumber*2/3);a<b;a++)c[a].path(d.linePointsNumber,this.cacheCanvasContext[0]);d.lineLength-=d.lineIncrement-0.1;a=~~(d.linesNumber*2/3);for(b=d.linesNumber;a<
b;a++)c[a].path(Math.round(d.lineLength),this.cacheCanvasContext[0]);d.lineLength<0&&(d.factor=-1,d.lineLength=d.linePointsNumber-1,d.step=4);break;case 4:d.lineLength-=d.lineIncrement-0.1;a=0;for(b=~~(d.linesNumber*2/3);a<b;a++)c[a].path(Math.round(d.lineLength),this.cacheCanvasContext[0]);d.lineLength<0&&(d.factor=1,d.lineLength=0,d.step=1)}this.cacheCanvasContext[0].lineWidth=this._rendererOptions.markLine.itemStyle.width;this.cacheCanvasContext[0].strokeStyle=this._rendererOptions.markLine.itemStyle.color;
this.cacheCanvasContext[0].stroke();a=~~(this.markLines.option.linesNumber/200);for(b=~~(this.markLines.option.linesNumber/10);a<b;a++)this.markLines.items[a].effect.draw(this.cacheCanvasContext[0])}this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawCanvas2:function(){document.createElement("canvas").getContext?(this.cacheCanvasContext[1].globalCompositeOperation="destination-out",this.cacheCanvasContext[1].fillStyle="rgba(0, 0, 0, 0.05)",this.cacheCanvasContext[1].fillRect(0,
0,this.width,this.height),this.cacheCanvasContext[1].globalCompositeOperation="source-over"):this.cacheCanvas[1].width=this.width;this.cacheCanvasContext[1].save();if(this.markLines.items.length>0)for(var a=0;a<~~(this.markLines.option.linesNumber/200);a++)this.markLines.items[a].effect.draw(this.cacheCanvasContext[1]);for(a=this.markPoints.length;a--;)this.markPoints[a].draw(this.cacheCanvasContext[1]);this.cacheCanvasContext[1].restore();this.canvas[1].width=this.width;this.canvasContext[1].drawImage(this.cacheCanvas[1],
0,0)},clearCanvas:function(){this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,b){this.hoveredMarkPoint=null;this.cacheCanvasContext[1].save();
for(var c=0,d=this.markPoints.length;c<d;c++)!this.hoveredMarkPoint&&this.markPoints[c].isPointInPath(this.cacheCanvasContext[1],a,b);this.cacheCanvasContext[1].restore();this.hoveredMarkPoint?(this.canvas[1].style.cursor="pointer",this.showTooltip(this.hoveredMarkPoint.name,a,b)):(this.canvas[1].style.cursor="grab",this.hideTooltip())},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+
"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.canvas[1].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.height=this._parent.map.transform.height},
setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";a?this.draw():this.stopDraw()},setData:function(a){this.data=a;this.markLines.option={step:1,factor:1,linesNumber:a.length,linePointsNumber:a[0].geometry.coordinates.length,lineLength:0,lineIncrement:10/this._rendererOptions.markLine.effect.period};for(var b=0;b<a.length;b++){for(var c=[],d=0;d<a[b].geometry.coordinates.length;d++)c.push({lon:a[b].geometry.coordinates[d][0],lat:a[b].geometry.coordinates[d][1]});this.markLines.items.push(new this.MarkLine(b,
c))}b=a[a.length-1].geometry.coordinates[a[a.length-1].geometry.coordinates.length-1];this.markPoints.push(new this.MarkPoint(0,a[a.length-1].properties.name||"\u7ec8\u70b9",b[0],b[1]))}});
GeoGlobe.Visuals.Custom.Scatter=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPointsSet:null,markPointsSets:[],legendLabels:[],visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":
"none"},_init_Legend:function(){this._legend=GeoGlobe.Util.deepExtend({},{show:!0,left:null,right:null,top:null,bottom:null,col:1,itemSize:10,itemColors:[],itemStatuses:[],backgroundColor:"rgba(0,0,0,0.5)",borderColor:"#000",borderWidth:1,borderRadius:0,shadowColor:"#fff",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0,padding:10,textStyle:{color:"#fff",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}},this.legend)},_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({},
{markPoint:{unactivatedDrawable:!0,symbol:"square",symbolSize:2,itemStyle:{color:"rgba(255,0,0,0.7)",shadowColor:"#000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0}}},this.rendererOptions)},_initMarkPointsSet:function(){var a=this,b=this._legend.itemColors,c=this._legend.itemStatuses,d=this._rendererOptions.markPoint.unactivatedDrawable,e=this._rendererOptions.markPoint.symbol,f=this._rendererOptions.markPoint.symbolSize,g=this._rendererOptions.markPoint.itemStyle;this.MarkPointsSet=function(c,d,
e){this.legendLabel=c;this.markPoints=d;for(c=d.length;c--;){d[c].weight=(d[c].value-a.minValue)/(a.maxValue-a.minValue);if(isNaN(d[c].weight))d[c].weight=1;if(d[c].weight>1)d[c].weight=1;if(d[c].weight<0)d[c].weight=0;if(GeoGlobe.Util.getType(a._rendererOptions.markPoint.itemStyle.color[e])==="object")a.gradientImageData=GeoGlobe.Util.getGradientImageData(a._rendererOptions.markPoint.itemStyle.color[e]);d[c].color=GeoGlobe.Util.getType(g.color[e])==="object"?"rgba("+a.gradientImageData[~~(d[c].weight*
255+0.5)*4]+","+a.gradientImageData[~~(d[c].weight*255+0.5)*4+1]+","+a.gradientImageData[~~(d[c].weight*255+0.5)*4+2]+","+a.gradientImageData[3]/255+")":b[e]}};this.MarkPointsSet.prototype.updateXY=function(){for(var b=this.markPoints.length;b--;){var c=a._parent.map.project([this.markPoints[b].lon,this.markPoints[b].lat]);this.markPoints[b].x=c.x;this.markPoints[b].y=c.y}};this.MarkPointsSet.prototype.draw=function(a,b){if(d||c[b]!==0){var g=[],n=function(a){for(var b=0;b<g.length;b++)if(parseInt(g[b].x)===
parseInt(a.x)&&parseInt(g[b].y)===parseInt(a.y))return g[b];return null},o=function(){a.fillStyle=r.color;a.beginPath();switch(e){case "square":a.globalCompositeOperation="lighter";a.rect(r.x-f/2,r.y-f/2,f,f);break;case "square2":a.rect(r.x-f/2,r.y-f/2,f,f);break;case "round":a.globalCompositeOperation="lighter",a.arc(r.x,r.y,f/2,0,Math.PI*2,!1)}a.fill()},q=this.markPoints.length;for(this.markPoints=this.markPoints.sort(function(a,b){var c=a.value,d=b.value;return c>d?-1:c<d?1:0});q--;){var r;r=this.markPoints[q];
if(e==="square2"){var m=n(r);if(m){if(r.value>m.value)o(),m.value=r.value}else o(),g.push({x:r.x,y:r.y,value:r.value})}else o()}}}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.canvas[0].style.position="absolute";
this.div.appendChild(this.canvas[0])},render:function(){this._init_Legend();this._init_RendererOptions();this._initMarkPointsSet();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas();this.frame&&cancelAnimationFrame(this.frame)},lazydraw:function(){var a=this;(function c(){if(a.DRAWINDEX<a.legendLabels.length)requestAnimationFrame(c),a.drawLegend(a.DRAWINDEX),a.markPointsSets[a.DRAWINDEX].draw(a.cacheCanvasContext[0],a.DRAWINDEX),a.canvas[0].width=a.width,a.canvasContext[0].drawImage(a.cacheCanvas[0],
0,0),a.DRAWINDEX++})()},onMove:function(){this.updateXY();this.drawCanvas()},onMoveEnd:function(){this.redraw()},onResize:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();this.drawCanvas()},updateXY:function(){for(var a=this.markPointsSets.length;a--;)this.markPointsSets[a].updateXY()},
drawCanvas:function(){this.cacheCanvas[0].width=this.width;for(var a=0,b=this.markPointsSets.length;a<b;a++)this.markPointsSets[a].draw(this.cacheCanvasContext[0],a);this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawLegend:function(a){if(this._legend&&this._legend.show){if(!this.legendDiv)this.legendDiv=document.createElement("div"),this.legendDiv.style.position="absolute",this.legendDiv.style["background-color"]=this._legend.backgroundColor,this.legendDiv.style["border-color"]=
this._legend.borderColor,this.legendDiv.style["border-width"]=this._legend.borderWidth+"px",this.legendDiv.style["border-radius"]=this._legend.borderRadius+"px",this.legendDiv.style["border-style"]="solid",this.legendDiv.style["box-shadow"]=this._legend.shadowOffsetX+"px "+this._legend.shadowOffsetY+"px "+this._legend.shadowBlur+"px "+this._legend.shadowColor,this.legendDiv.style.padding=this._legend.padding+"px",this.legendDiv.style.left=this._legend.left!==null?this._legend.left+"px":null,this.legendDiv.style.right=
this._legend.right!==null?this._legend.right+"px":null,this.legendDiv.style.top=this._legend.top!==null?this._legend.top+"px":null,this.legendDiv.style.bottom=this._legend.bottom!==null?this._legend.bottom+"px":null,this.legendCanvas=document.createElement("canvas"),this.legendCanvasContext=this.legendCanvas.getContext("2d"),this.legendCanvas.style.display="block",this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+
"px "+this._legend.textStyle.fontFamily,this.legendDiv.appendChild(this.legendCanvas),this.div.appendChild(this.legendDiv);for(var b=[],c=null,d=0,e=this.legendLabels.length;d<e;d++)for(var c=this._legend.itemSize+10+this.legendCanvasContext.measureText(this.legendLabels[d].toString()).width,f=this._legend.col,g=0;g<f;g++)d%this._legend.col===g&&(!b[g]||b[g]<c)&&(b[g]=c);for(var h=10,c=10,d=0,e=b.length;d<e;d++)h+=b[d]+10;c+=((this._legend.itemSize<this._legend.textStyle.fontSize?this._legend.textStyle.fontSize:
this._legend.itemSize)+10)*(~~(this.legendLabels.length/this._legend.col)+(this.legendLabels.length%this._legend.col===0?0:1));this.legendCanvas.width=h;this.legendCanvas.height=c;var j=function(a,c,d,e){this.legendCanvas.width=h;for(var f=!1,g,j,t=0,a=a!==void 0?a+1:this.legendLabels.length;t<a;t++){j=0;for(var s=this._legend.col;j<s;j++)if(t%this._legend.col===j){g=10+this._legend.itemSize/2;for(var u=0;u<j;u++)g+=b[u]+10}j=10+this._legend.itemSize/2+((this._legend.itemSize<this._legend.textStyle.fontSize?
this._legend.textStyle.fontSize:this._legend.itemSize)+10)*~~(t/this._legend.col);u=s=!1;this.legendCanvasContext.beginPath();switch(this._rendererOptions.markPoint.symbol){case "square":this.legendCanvasContext.rect(g-this._legend.itemSize/2,j-this._legend.itemSize/2,this._legend.itemSize,this._legend.itemSize);break;case "square2":this.legendCanvasContext.rect(g-this._legend.itemSize/2,j-this._legend.itemSize/2,this._legend.itemSize,this._legend.itemSize);break;case "round":this.legendCanvasContext.arc(g,
j,this._legend.itemSize/2,0,Math.PI*2,!1)}c==="mousemove"&&d!==void 0&&e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(f=s=!0);c==="mousedown"&&d!==void 0&&e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(u=!0);this.legendCanvasContext.beginPath();this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+"px "+this._legend.textStyle.fontFamily;this.legendCanvasContext.rect(g+this._legend.itemSize/2+10,
j-this._legend.textStyle.fontSize/2,this.legendCanvasContext.measureText(this.legendLabels[t].toString()).width,this._legend.textStyle.fontSize);c==="mousemove"&&d!==void 0&&e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(f=s=!0);c==="mousedown"&&d!==void 0&&e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(u=!0);u&&(this._legend.itemStatuses[t]=this._legend.itemStatuses[t]===0?1:0,this.drawCanvas());var v=this._legend.itemStatuses[t]===0?"#808080":this._legend.itemColors[t]?this._legend.itemColors[t]:
this._rendererOptions.markPoint.itemStyle.color,w=this._legend.itemStatuses[t]===0?"#808080":this._legend.textStyle.color,v=s||u?GeoGlobe.Util.getShadeColor(v,20):v,w=s||u?GeoGlobe.Util.getShadeColor(w,20):w;this.legendCanvasContext.beginPath();switch(this._rendererOptions.markPoint.symbol){case "square":this.legendCanvasContext.rect(g-this._legend.itemSize/2,j-this._legend.itemSize/2,this._legend.itemSize,this._legend.itemSize);break;case "square2":this.legendCanvasContext.rect(g-this._legend.itemSize/
2,j-this._legend.itemSize/2,this._legend.itemSize,this._legend.itemSize);break;case "round":this.legendCanvasContext.arc(g,j,this._legend.itemSize/2,0,Math.PI*2,!1)}this.legendCanvasContext.fillStyle=v;this.legendCanvasContext.fill();this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+"px "+this._legend.textStyle.fontFamily;this.legendCanvasContext.textAlign="left";this.legendCanvasContext.textBaseline="middle";this.legendCanvasContext.fillStyle=
w;this.legendCanvasContext.fillText(this.legendLabels[t],g+this._legend.itemSize/2+10,j)}this.legendCanvas.style.cursor=f?"pointer":"default"}.bind(this);this.legendCanvas.onmousedown=function(a){var b=a.offsetX||a.clientX-(a.target||a.srcElement).getBoundingClientRect().left,c=a.offsetY||a.clientY-(a.target||a.srcElement).getBoundingClientRect().top;j(void 0,a.type,b,c)};this.legendCanvas.onmousemove=function(a){var b=a.offsetX||a.clientX-(a.target||a.srcElement).getBoundingClientRect().left,c=a.offsetY||
a.clientY-(a.target||a.srcElement).getBoundingClientRect().top;j(void 0,a.type,b,c)};j(a)}},clearCanvas:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},addTo:function(a){this._parent=
a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";this.legendDiv&&(this.legendDiv.style.display=a?"block":"none");a?this.draw():this.stopDraw()},setData:function(a){this.data=a;this.minValue=Number.MAX_VALUE;
this.maxValue=Number.MIN_VALUE;for(var b=0;b<a.length;b++){if(a[b].properties.value<this.minValue)this.minValue=a[b].properties.value;if(a[b].properties.value>this.maxValue)this.maxValue=a[b].properties.value}a=new Blob(["function MarkPoint(lon, lat, value) {this.lon = lon;this.lat = lat;this.value = value;}function MarkPointsSet(legendLabel) {this.legendLabel = legendLabel;this.markPoints = [];}var legendLabels = [];var markPointsSets = [];onmessage = function (evt) {var features = evt.data.data;var feature = null;var legendLabel = null;for (var i = 0, len = features.length; i < len; i++) {feature = features[i];legendLabel = feature.properties.type;if (legendLabels.indexOf(legendLabel) === -1) {legendLabels.push(legendLabel);markPointsSets.push(new MarkPointsSet(legendLabel));}markPointsSets[legendLabels.indexOf(legendLabel)].markPoints.push(new MarkPoint(feature.geometry.coordinates[0], feature.geometry.coordinates[1],feature.properties.value));}postMessage({legendLabels: legendLabels,markPointsSets: markPointsSets})}"]);
a=window.URL.createObjectURL(a);a=new Worker(a);a.postMessage({data:this.data});a.onmessage=function(a){this.legendLabels=a.data.legendLabels;for(var b,e=0,f=a.data.markPointsSets.length;e<f;e++)b=new this.MarkPointsSet(a.data.markPointsSets[e].legendLabel,a.data.markPointsSets[e].markPoints,e),b.updateXY(),this.markPointsSets.push(b);this.DRAWINDEX=0;this.lazydraw()}.bind(this)}});
GeoGlobe.Visuals.Custom.Proportion=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPoint:null,markPoints:[],visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},_init_Legend:function(){this._legend=
GeoGlobe.Util.deepExtend({},{show:!0,left:null,right:null,top:null,bottom:null,col:1,itemWidth:20,itemHeight:12,itemColors:[],itemStatuses:[],hLegendLabels:[],vLegendLabels:[],backgroundColor:"rgba(0,0,0,0.5)",borderColor:"#000",borderWidth:1,borderRadius:0,shadowColor:"#fff",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0,padding:10,textStyle:{color:"#fff",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}},this.legend)},_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({},
{markPoint:{hoverable:!0,clickable:!0,slope:0.8,symbol:"column",symbolMinSize:0,symbolMaxSize:100,symbolWidth:10,symbolThickness:5,symbolGap:5,opacity:1,itemStyle:{color:"rgba(255,0,0,0.7)",shadowColor:"#000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}}},this.rendererOptions)},_initMarkPoint:function(){var a=
this,b=this._legend.itemColors,c=this._legend.itemStatuses,d=this._rendererOptions.markPoint.symbol,e=this._rendererOptions.markPoint.symbolMinSize,f=this._rendererOptions.markPoint.symbolMaxSize,g=this._rendererOptions.markPoint.symbolWidth,h=this._rendererOptions.markPoint.symbolThickness,j=this._rendererOptions.markPoint.symbolGap,l=this._rendererOptions.markPoint.opacity,n=this._rendererOptions.markPoint.itemStyle;this.MarkPoint=function(a,b,c,e,f){this.id=a;this.name=b;this.measureValues=c;this.lon=
e;this.lat=f;this.init();if(d==="pie"){var g=this;this.Point=function(a,b,c){this.x=a;this.y=b;this.z=c;this.get2d=function(){var a=5E4/(5E4+this.z);return{x:g.x+this.x*a,y:g.y+this.y*a}}}}};this.MarkPoint.prototype.init=function(){this.energy=0;switch(d){case "column":this.velocity=0.1;break;case "pie":this.velocity=0.05}};this.MarkPoint.prototype.updateXY=function(){var b=a._parent.map.project([this.lon,this.lat]);this.x=b.x;this.y=b.y};this.MarkPoint.prototype.updateSize=function(){var b,g;this.parts=
[];for(b=0;b<this.measureValues.length;b++){this.parts.push({size:(f-e)*(a.measureValueMaxSum===a.measureValueMinSum?1:(this.measureValueSums[b]-a.measureValueMinSum)/(a.measureValueMaxSum-a.measureValueMinSum))+e});switch(d){case "column":this.parts[b].cubes=[];break;case "pie":this.parts[b].sectors=[]}for(g=0;g<this.measureValues[b].length;g++)switch(d){case "column":this.parts[b].cubes.push({height:c[g]===0||this.measureValueSums[b]===0?0:this.measureValues[b][g]/this.measureValueSums[b]*this.parts[b].size});
break;case "pie":this.parts[b].sectors.push({angle:c[g]===0||this.measureValueSums[b]===0?0:this.measureValues[b][g]/this.measureValueSums[b]*Math.PI*2})}}};this.MarkPoint.prototype.updatePartXY=function(){var b=a._rendererOptions.markPoint.slope,c,e,f;switch(d){case "column":var n,l;n=this.parts.length%2===0?this.x-h*Math.cos(b)/2-(this.parts.length/2-1)*g-(this.parts.length/2-0.5)*j:this.x+(g-h*Math.cos(b))/2-(this.parts.length-1)/2*g-(this.parts.length-1)/2*j;l=this.y+h*Math.sin(b)/2;for(c=0;c<
this.parts.length;c++)for(e=0;e<this.parts[c].cubes.length;e++){var s=0;for(f=e;f>0;f--)s+=this.parts[c].cubes[f-1].height;this.parts[c].cubes[e].vertexs=[[n+c*(g+j),l-s],[n+c*(g+j)+h*Math.cos(b),l-h*Math.sin(b)-s],[n+c*(g+j)+h*Math.cos(b)-g,l-h*Math.sin(b)-s],[n+c*(g+j)-g,l-s]]}break;case "pie":var u,v,w,x,C,A=Math.PI*2/50;for(c=0;c<1;c++){f=this.parts[c].size/2;n=f>g?f-g:0;s=new this.Point(0,0,-h/2);u=new this.Point(0,0,h/2);v=[];w=[];x=[];C=[];for(l=0;l<=Math.PI*2;)v.push(new this.Point(f*Math.cos(l),
f*Math.sin(l),-h/2)),w.push(new this.Point(f*Math.cos(l),f*Math.sin(l),h/2)),n>0&&(x.push(new this.Point(n*Math.cos(l),n*Math.sin(l),-h/2)),C.push(new this.Point(n*Math.cos(l),n*Math.sin(l),h/2))),l+=A;v.push(new this.Point(f,0,-h/2));w.push(new this.Point(f,0,h/2));n>0&&(x.push(new this.Point(n,0,-h/2)),C.push(new this.Point(n,0,h/2)));e=Math.cos(b);var B=Math.sin(b),y;l=s.y*e-s.z*B;y=s.z*e+s.y*B;s.y=l;s.z=y;l=u.y*e-u.z*B;y=u.z*e+u.y*B;u.y=l;u.z=y;for(f=0;f<50;f++)if(l=v[f].y*e-v[f].z*B,y=v[f].z*
e+v[f].y*B,v[f].y=l,v[f].z=y,l=w[f].y*e-w[f].z*B,y=w[f].z*e+w[f].y*B,w[f].y=l,w[f].z=y,n>0)l=x[f].y*e-x[f].z*B,y=x[f].z*e+x[f].y*B,x[f].y=l,x[f].z=y,l=C[f].y*e-C[f].z*B,y=C[f].z*e+C[f].y*B,C[f].y=l,C[f].z=y;for(e=0;e<this.parts[c].sectors.length;e++){l=this.parts[c].sectors[e].angle;B=0;for(f=e;f>0;f--)B+=this.parts[c].sectors[f-1].angle;f=B+l;this.parts[c].sectors[e].startIndex=e===0?Math.round(B/A):this.parts[c].sectors[e-1].endIndex;this.parts[c].sectors[e].endIndex=Math.round(f/A)}this.parts[c].uCentrePoint=
s;this.parts[c].tCentrePoint=u;this.parts[c].oUnderPoints=v;this.parts[c].oTopPoints=w;if(n>0)this.parts[c].iUnderPoints=x,this.parts[c].iTopPoints=C}}};this.MarkPoint.prototype.update=function(){this.energy+=this.velocity;this.energy>1&&(this.energy=1);a.DRAWDONE=this.energy===1};this.MarkPoint.prototype.isPointInPath=function(c,e,f){var h,j,l;switch(d){case "column":for(h=0;h<this.parts.length;h++)for(j=0;j<this.parts[h].cubes.length;j++)if(this.parts[h].cubes[j].height>0&&(c.beginPath(),c.moveTo(this.parts[h].cubes[j].vertexs[0][0],
this.parts[h].cubes[j].vertexs[0][1]),c.lineTo(this.parts[h].cubes[j].vertexs[1][0],this.parts[h].cubes[j].vertexs[1][1]),c.lineTo(this.parts[h].cubes[j].vertexs[1][0],this.parts[h].cubes[j].vertexs[1][1]-this.parts[h].cubes[j].height),c.lineTo(this.parts[h].cubes[j].vertexs[3][0],this.parts[h].cubes[j].vertexs[3][1]-this.parts[h].cubes[j].height),c.lineTo(this.parts[h].cubes[j].vertexs[3][0],this.parts[h].cubes[j].vertexs[3][1]),c.isPointInPath(e,f))){a.hoveredMarkPoint=this;this.hActive=h;this.vActive=
j;return}break;case "pie":for(h=0;h<1;h++){var s=this.parts[h].tCentrePoint,u=this.parts[h].oUnderPoints,v=this.parts[h].oTopPoints,w=this.parts[h].iUnderPoints,x=this.parts[h].iTopPoints,C=!1;this.parts[h].size/2>g&&(C=!0);var A=Math.round(25),B=[],y=[],z=[];l=[];for(j=0;j<this.parts[h].sectors.length;j++)B.push(this.parts[h].sectors[j].angle),y.push(this.parts[h].sectors[j].startIndex),z.push(Math.round(this.parts[h].sectors[j].endIndex*this.energy)),l.push(b[j]?b[j]:n.color);for(j=B.length-1;j>=
0;j--)if(B[j]>0){c.beginPath();if(y[j]>A){c.moveTo(v[z[j]].get2d().x,v[z[j]].get2d().y);for(l=z[j]-1;l>=y[j];l--)c.lineTo(v[l].get2d().x,v[l].get2d().y);if(C){c.lineTo(x[y[j]].get2d().x,x[y[j]].get2d().y);for(l=y[j];l<=z[j];l++)c.lineTo(w[l].get2d().x,w[l].get2d().y);c.lineTo(x[z[j]].get2d().x,x[z[j]].get2d().y)}else c.lineTo(s.get2d().x,s.get2d().y)}else if(z[j]<A){c.moveTo(u[z[j]].get2d().x,u[z[j]].get2d().y);for(l=z[j]-1;l>=y[j];l--)c.lineTo(u[l].get2d().x,u[l].get2d().y);c.lineTo(v[y[j]].get2d().x,
v[y[j]].get2d().y);if(C)for(l=y[j];l<=z[j];l++)c.lineTo(x[l].get2d().x,x[l].get2d().y);else c.lineTo(s.get2d().x,s.get2d().y);c.lineTo(v[z[j]].get2d().x,v[z[j]].get2d().y)}else{c.moveTo(v[z[j]].get2d().x,v[z[j]].get2d().y);for(l=z[j]-1;l>=A;l--)c.lineTo(v[l].get2d().x,v[l].get2d().y);for(l=A;l>=y[j];l--)c.lineTo(u[l].get2d().x,u[l].get2d().y);c.lineTo(v[y[j]].get2d().x,v[y[j]].get2d().y);if(C){for(l=y[j];l<=A;l++)c.lineTo(x[l].get2d().x,x[l].get2d().y);for(l=A;l<=z[j];l++)c.lineTo(w[l].get2d().x,
w[l].get2d().y)}else c.lineTo(s.get2d().x,s.get2d().y)}if(c.isPointInPath(e,f)){a.hoveredMarkPoint=this;this.hActive=h;this.vActive=j;return}}}}};this.MarkPoint.prototype.draw=function(c){var e=a._rendererOptions.markPoint.slope;this.update();var f,m,p;p=!1;var t;switch(d){case "column":for(f=0;f<this.parts.length;f++)for(m=0;m<this.parts[f].cubes.length;m++)if(this.parts[f].cubes[m].height>0&&(p=!0,t=b[m]?b[m]:n.color,a.hoveredMarkPoint===this&&f===this.hActive&&m===this.vActive&&(t=GeoGlobe.Util.getShadeColor(t,
20)),c.globalAlpha=l,c.globalCompositeOperation="source-over",c.shadowBlur=0,c.shadowOffsetX=0,c.shadowOffsetY=0,c.beginPath(),c.moveTo(this.parts[f].cubes[m].vertexs[0][0],this.parts[f].cubes[m].vertexs[0][1]),c.lineTo(this.parts[f].cubes[m].vertexs[0][0],this.parts[f].cubes[m].vertexs[0][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[3][0],this.parts[f].cubes[m].vertexs[3][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[3][0],
this.parts[f].cubes[m].vertexs[3][1]),c.closePath(),c.fillStyle=t,c.fill(),h!==0))c.beginPath(),c.moveTo(this.parts[f].cubes[m].vertexs[0][0],this.parts[f].cubes[m].vertexs[0][1]),c.lineTo(this.parts[f].cubes[m].vertexs[1][0],this.parts[f].cubes[m].vertexs[1][1]),c.lineTo(this.parts[f].cubes[m].vertexs[1][0],this.parts[f].cubes[m].vertexs[1][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[0][0],this.parts[f].cubes[m].vertexs[0][1]-this.parts[f].cubes[m].height*
this.energy),c.closePath(),c.fillStyle=GeoGlobe.Util.getShadeColor(t,-40),c.fill(),c.beginPath(),c.moveTo(this.parts[f].cubes[m].vertexs[0][0],this.parts[f].cubes[m].vertexs[0][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[1][0],this.parts[f].cubes[m].vertexs[1][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[2][0],this.parts[f].cubes[m].vertexs[2][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[3][0],
this.parts[f].cubes[m].vertexs[3][1]-this.parts[f].cubes[m].height*this.energy),c.closePath(),c.fillStyle=GeoGlobe.Util.getShadeColor(t,-20),c.fill(),c.shadowColor=n.shadowColor,c.shadowBlur=n.shadowBlur,c.shadowOffsetX=n.shadowOffsetX,c.shadowOffsetY=n.shadowOffsetY,c.globalCompositeOperation="destination-over",c.beginPath(),c.moveTo(this.parts[f].cubes[m].vertexs[1][0],this.parts[f].cubes[m].vertexs[1][1]),c.lineTo(this.parts[f].cubes[m].vertexs[1][0],this.parts[f].cubes[m].vertexs[1][1]-this.parts[f].cubes[m].height*
this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[2][0],this.parts[f].cubes[m].vertexs[2][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[2][0],this.parts[f].cubes[m].vertexs[2][1]),c.closePath(),c.fillStyle=t,c.fill(),c.beginPath(),c.moveTo(this.parts[f].cubes[m].vertexs[2][0],this.parts[f].cubes[m].vertexs[2][1]),c.lineTo(this.parts[f].cubes[m].vertexs[2][0],this.parts[f].cubes[m].vertexs[2][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[3][0],
this.parts[f].cubes[m].vertexs[3][1]-this.parts[f].cubes[m].height*this.energy),c.lineTo(this.parts[f].cubes[m].vertexs[3][0],this.parts[f].cubes[m].vertexs[3][1]),c.closePath(),c.fillStyle=GeoGlobe.Util.getShadeColor(t,-40),c.fill(),c.beginPath(),c.moveTo(this.parts[f].cubes[m].vertexs[0][0],this.parts[f].cubes[m].vertexs[0][1]),c.lineTo(this.parts[f].cubes[m].vertexs[1][0],this.parts[f].cubes[m].vertexs[1][1]),c.lineTo(this.parts[f].cubes[m].vertexs[2][0],this.parts[f].cubes[m].vertexs[2][1]),c.lineTo(this.parts[f].cubes[m].vertexs[3][0],
this.parts[f].cubes[m].vertexs[3][1]),c.closePath(),c.fillStyle=GeoGlobe.Util.getShadeColor(t,-20),c.fill();if(p)c.lineWidth=0.3,c.globalAlpha=1,c.globalCompositeOperation="destination-over",c.shadowBlur=0,c.shadowOffsetX=0,c.shadowOffsetY=0,c.strokeStyle="#fff",c.beginPath(),c.moveTo(this.x-this.parts.length/2*g-(this.parts.length/2-0.5)*j-5,this.y),c.lineTo(this.x+this.parts.length/2*g+(this.parts.length/2-0.5)*j+5,this.y),c.closePath(),c.stroke(),h!==0&&(c.beginPath(),c.moveTo(this.x-(h/2+5)*Math.cos(e),
this.y+(h/2+5)*Math.sin(e)),c.lineTo(this.x+(h/2+5)*Math.cos(e),this.y-(h/2+5)*Math.sin(e)),c.closePath(),c.stroke());break;case "pie":c.globalAlpha=l;for(f=0;f<1;f++){t=this.parts[f].uCentrePoint;var s=this.parts[f].tCentrePoint,u=this.parts[f].oUnderPoints,v=this.parts[f].oTopPoints,w=this.parts[f].iUnderPoints,x=this.parts[f].iTopPoints,C=!1;this.parts[f].size/2>g&&(C=!0);var A=Math.round(25),B=[],y=[],z=[],E=[];for(m=0;m<this.parts[f].sectors.length;m++)B.push(this.parts[f].sectors[m].angle),
y.push(this.parts[f].sectors[m].startIndex),z.push(Math.round(this.parts[f].sectors[m].endIndex*this.energy)),E.push(b[m]?b[m]:n.color);for(m=B.length-1;m>=0;m--)B[m]>0&&a.hoveredMarkPoint===this&&f===this.hActive&&m===this.vActive&&(E[m]=GeoGlobe.Util.getShadeColor(E[m],10));for(m=B.length-1;m>=0;m--)if(B[m]>0){c.globalCompositeOperation="destination-over";c.beginPath();c.moveTo(u[z[m]].get2d().x,u[z[m]].get2d().y);for(p=z[m]-1;p>=y[m];p--)c.lineTo(u[p].get2d().x,u[p].get2d().y);if(C)for(p=y[m];p<=
z[m];p++)c.lineTo(w[p].get2d().x,w[p].get2d().y);else c.lineTo(t.get2d().x,t.get2d().y);c.fillStyle=E[m];c.fill()}if(e!==0){for(m=B.length-1;m>=0;m--)if(B[m]>0)c.globalCompositeOperation="source-over",c.beginPath(),c.moveTo(u[z[m]].get2d().x,u[z[m]].get2d().y),C?(c.lineTo(w[z[m]].get2d().x,w[z[m]].get2d().y),c.lineTo(x[z[m]].get2d().x,x[z[m]].get2d().y)):(c.lineTo(t.get2d().x,t.get2d().y),c.lineTo(s.get2d().x,s.get2d().y)),c.lineTo(v[z[m]].get2d().x,v[z[m]].get2d().y),c.moveTo(u[y[m]].get2d().x,u[y[m]].get2d().y),
C?(c.lineTo(w[y[m]].get2d().x,w[y[m]].get2d().y),c.lineTo(x[y[m]].get2d().x,x[y[m]].get2d().y)):(c.lineTo(t.get2d().x,t.get2d().y),c.lineTo(s.get2d().x,s.get2d().y)),c.lineTo(v[y[m]].get2d().x,v[y[m]].get2d().y),c.fillStyle=GeoGlobe.Util.getShadeColor(E[m],-20),c.fill();if(C)for(m=B.length-1;m>=0;m--)if(B[m]>0){c.globalCompositeOperation="source-over";c.beginPath();c.moveTo(w[z[m]].get2d().x,w[z[m]].get2d().y);if(y[m]<A&&z[m]>A){for(p=z[m]-1;p>=A;p--)c.lineTo(w[p].get2d().x,w[p].get2d().y);for(p=
A;p<=z[m];p++)c.lineTo(x[p].get2d().x,x[p].get2d().y);c.moveTo(w[y[m]].get2d().x,w[y[m]].get2d().y);for(p=y[m]+1;p<=A;p++)c.lineTo(w[p].get2d().x,w[p].get2d().y);for(p=A;p>=y[m];p--)c.lineTo(x[p].get2d().x,x[p].get2d().y)}else{for(p=z[m]-1;p>=y[m];p--)c.lineTo(w[p].get2d().x,w[p].get2d().y);for(p=y[m];p<=z[m];p++)c.lineTo(x[p].get2d().x,x[p].get2d().y)}c.fillStyle=GeoGlobe.Util.getShadeColor(E[m],-20);c.fill()}for(m=B.length-1;m>=0;m--)if(B[m]>0){if(y[m]<A&&z[m]>A){c.globalCompositeOperation="destination-over";
c.beginPath();c.moveTo(u[z[m]].get2d().x,u[z[m]].get2d().y);for(p=z[m]-1;p>=A;p--)c.lineTo(u[p].get2d().x,u[p].get2d().y);for(p=A;p<=z[m];p++)c.lineTo(v[p].get2d().x,v[p].get2d().y);c.fillStyle=GeoGlobe.Util.getShadeColor(E[m],-20);c.fill();c.globalCompositeOperation="source-over";c.beginPath();c.moveTo(u[y[m]].get2d().x,u[y[m]].get2d().y);for(p=y[m]+1;p<=A;p++)c.lineTo(u[p].get2d().x,u[p].get2d().y);for(p=A;p>=y[m];p--)c.lineTo(v[p].get2d().x,v[p].get2d().y)}else{c.globalCompositeOperation="source-over";
c.beginPath();c.moveTo(u[z[m]].get2d().x,u[z[m]].get2d().y);for(p=z[m]-1;p>=y[m];p--)c.lineTo(u[p].get2d().x,u[p].get2d().y);for(p=y[m];p<=z[m];p++)c.lineTo(v[p].get2d().x,v[p].get2d().y)}c.fillStyle=GeoGlobe.Util.getShadeColor(E[m],-20);c.fill()}for(m=B.length-1;m>=0;m--)if(B[m]>0){c.globalCompositeOperation="source-over";c.beginPath();c.moveTo(v[z[m]].get2d().x,v[z[m]].get2d().y);for(p=z[m]-1;p>=y[m];p--)c.lineTo(v[p].get2d().x,v[p].get2d().y);if(C)for(p=y[m];p<=z[m];p++)c.lineTo(x[p].get2d().x,
x[p].get2d().y);else c.lineTo(s.get2d().x,s.get2d().y);c.fillStyle=E[m];c.fill()}}}}}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.canvas[0].style.position="absolute";this.div.appendChild(this.canvas[0])},
_initTooltip:function(){if((this._rendererOptions.markPoint.hoverable||this._rendererOptions.markPoint.clickable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.width=this._rendererOptions.tooltip.width+"px",this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=
this._rendererOptions.tooltip.padding.toString().split(" ").join("px ")+"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),
this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="nowrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)",
this.tooltipDiv.innerHTML='<h3 style="opacity:0.9;margin:0;padding-bottom:8px;border-bottom:1px solid '+this._rendererOptions.tooltip.textStyle.color+';overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><span></span><span style="float: right;"></span></h3><ul style="list-style-type:none;opacity:0.8;margin:0;padding:6px 18px 0 0;"></ul>'},render:function(){this._init_Legend();this._init_RendererOptions();this._initMarkPoint();this._initTooltip();this.setData(this.data);this.draw()},draw:function(){this.updateCountValueMinMaxSum();
this.updateXY();this.drawCanvas();this.drawLegend();this.frame&&cancelAnimationFrame(this.frame);var a=this;(function c(){a.frame=requestAnimationFrame(c);!a.DRAWDONE&&a.drawCanvas()})()},onMove:function(){this._rendererOptions.markPoint.slope=this._parent.map.getPitch()*Math.PI/180;this.updateXY();this.drawCanvas()},onMoveEnd:function(){this.redraw()},onClick:function(a){this.visibility&&this._rendererOptions.markPoint.clickable&&this.hoveredMarkPoint&&this._parent.fire("overlayerclick",{layer:this,
feature:this.hoveredMarkPoint,event:a})},onMouseMove:function(a){this.visibility&&this._rendererOptions.markPoint.hoverable&&this.markPoints.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),this.hoveredMarkPoint&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkPoint,event:a}))},onResize:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height;
this.redraw()},redraw:function(){this.clearCanvas();this.updateCountValueMinMaxSum();this.updateXY();this.drawCanvas();this.drawLegend()},updateXY:function(){for(var a=this.markPoints.length;a--;)this.SWITCH&&this.markPoints[a].init(),!this.SWITCH&&this.markPoints[a].updateXY(),this.markPoints[a].updateSize(),this.markPoints[a].updatePartXY();this.SWITCH=!1},drawCanvas:function(){this.cacheCanvas[0].width=this.width;for(var a=this.markPoints.length;a--;)this.markPoints[a].draw(this.cacheCanvasContext[0]);
this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawLegend:function(){if(this._legend&&this._legend.show){if(!this.legendDiv)this.legendDiv=document.createElement("div"),this.legendDiv.style.position="absolute",this.legendDiv.style["background-color"]=this._legend.backgroundColor,this.legendDiv.style["border-color"]=this._legend.borderColor,this.legendDiv.style["border-width"]=this._legend.borderWidth+"px",this.legendDiv.style["border-radius"]=this._legend.borderRadius+
"px",this.legendDiv.style["border-style"]="solid",this.legendDiv.style["box-shadow"]=this._legend.shadowOffsetX+"px "+this._legend.shadowOffsetY+"px "+this._legend.shadowBlur+"px "+this._legend.shadowColor,this.legendDiv.style.padding=this._legend.padding+"px",this.legendDiv.style.left=this._legend.left!==null?this._legend.left+"px":null,this.legendDiv.style.right=this._legend.right!==null?this._legend.right+"px":null,this.legendDiv.style.top=this._legend.top!==null?this._legend.top+"px":null,this.legendDiv.style.bottom=
this._legend.bottom!==null?this._legend.bottom+"px":null,this.legendCanvas=document.createElement("canvas"),this.legendCanvasContext=this.legendCanvas.getContext("2d"),this.legendCanvas.style.display="block",this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+"px "+this._legend.textStyle.fontFamily,this.legendDiv.appendChild(this.legendCanvas),this.div.appendChild(this.legendDiv);for(var a=[],b=null,c=0,d=this._legend.vLegendLabels.length;c<
d;c++)for(var b=this._legend.itemWidth+10+this.legendCanvasContext.measureText(this._legend.vLegendLabels[c].toString()).width,e=this._legend.col,f=0;f<e;f++)c%this._legend.col===f&&(!a[f]||a[f]<b)&&(a[f]=b);for(var g=10,b=10,c=0,d=a.length;c<d;c++)g+=a[c]+10;b+=((this._legend.itemHeight<this._legend.textStyle.fontSize?this._legend.textStyle.fontSize:this._legend.itemHeight)+10)*(~~(this._legend.vLegendLabels.length/this._legend.col)+(this._legend.vLegendLabels.length%this._legend.col===0?0:1));this.legendCanvas.width=
g;this.legendCanvas.height=b;var h=function(b,c,d){this.legendCanvas.width=g;for(var e=!1,f,h,m=0,p=this._legend.vLegendLabels.length;m<p;m++){h=0;for(var t=this._legend.col;h<t;h++)if(m%this._legend.col===h){f=10+this._legend.itemWidth/2;for(var s=0;s<h;s++)f+=a[s]+10}h=10+this._legend.itemHeight/2+((this._legend.itemHeight<this._legend.textStyle.fontSize?this._legend.textStyle.fontSize:this._legend.itemHeight)+10)*~~(m/this._legend.col);s=t=!1;this.legendCanvasContext.beginPath();this.legendCanvasContext.rect(f-
this._legend.itemWidth/2,h-this._legend.itemHeight/2,this._legend.itemWidth,this._legend.itemHeight);b==="mousemove"&&c!==void 0&&d!==void 0&&this.legendCanvasContext.isPointInPath(c,d)&&(e=t=!0);b==="mousedown"&&c!==void 0&&d!==void 0&&this.legendCanvasContext.isPointInPath(c,d)&&(s=!0);this.legendCanvasContext.beginPath();this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+"px "+this._legend.textStyle.fontFamily;
this.legendCanvasContext.rect(f+this._legend.itemWidth/2+10,h-this._legend.textStyle.fontSize/2,this.legendCanvasContext.measureText(this._legend.vLegendLabels[m].toString()).width,this._legend.textStyle.fontSize);b==="mousemove"&&c!==void 0&&d!==void 0&&this.legendCanvasContext.isPointInPath(c,d)&&(e=t=!0);b==="mousedown"&&c!==void 0&&d!==void 0&&this.legendCanvasContext.isPointInPath(c,d)&&(s=!0);if(s)this._legend.itemStatuses[m]=this._legend.itemStatuses[m]===0?1:0,this.SWITCH=!0,this.redraw();
var u=this._legend.itemStatuses[m]===0?"#808080":this._legend.itemColors[m]?this._legend.itemColors[m]:this._rendererOptions.markPoint.itemStyle.color,v=this._legend.itemStatuses[m]===0?"#808080":this._legend.textStyle.color,u=t||s?GeoGlobe.Util.getShadeColor(u,20):u,v=t||s?GeoGlobe.Util.getShadeColor(v,20):v;this.legendCanvasContext.beginPath();this.legendCanvasContext.rect(f-this._legend.itemWidth/2,h-this._legend.itemHeight/2,this._legend.itemWidth,this._legend.itemHeight);this.legendCanvasContext.fillStyle=
u;this.legendCanvasContext.fill();this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+"px "+this._legend.textStyle.fontFamily;this.legendCanvasContext.textAlign="left";this.legendCanvasContext.textBaseline="middle";this.legendCanvasContext.fillStyle=v;this.legendCanvasContext.fillText(this._legend.vLegendLabels[m],f+this._legend.itemWidth/2+10,h)}this.legendCanvas.style.cursor=e?"pointer":"default"}.bind(this);this.legendCanvas.onmousedown=
function(a){var b=a.offsetX||a.clientX-(a.target||a.srcElement).getBoundingClientRect().left,c=a.offsetY||a.clientY-(a.target||a.srcElement).getBoundingClientRect().top;h(a.type,b,c)};this.legendCanvas.onmousemove=function(a){var b=a.offsetX||a.clientX-(a.target||a.srcElement).getBoundingClientRect().left,c=a.offsetY||a.clientY-(a.target||a.srcElement).getBoundingClientRect().top;h(a.type,b,c)};h()}},updateCountValueMinMaxSum:function(){this.measureValueMinSum=Infinity;this.measureValueMaxSum=-Infinity;
var a,b,c,d,e,f,g;a=0;for(d=this.markPoints.length;a<d;a++){this.markPoints[a].measureValueSums=[];b=0;for(e=this.markPoints[a].measureValues.length;b<e;b++){c=g=0;for(f=this.markPoints[a].measureValues[b].length;c<f;c++)this._legend.itemStatuses[c]!==0&&(g+=this.markPoints[a].measureValues[b][c]);this.markPoints[a].measureValueSums.push(g);g<this.measureValueMinSum&&(this.measureValueMinSum=g);g>this.measureValueMaxSum&&(this.measureValueMaxSum=g)}}},clearCanvas:function(){this.canvas[0].width=this.cacheCanvas[0].width=
this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,b){this.lastHoveredMarkPoint=this.hoveredMarkPoint?GeoGlobe.Util.clone(this.hoveredMarkPoint):null;this.hoveredMarkPoint=null;for(var c=0,d=this.markPoints.length;c<
d;c++)!this.hoveredMarkPoint&&this.markPoints[c].isPointInPath(this.cacheCanvasContext[0],a,b);this.drawCanvas();this.hoveredMarkPoint?(this.canvas[0].style.cursor="pointer",this.showTooltip(this.hoveredMarkPoint,a,b)):(this.canvas[0].style.cursor="grab",this.hideTooltip())},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show){this.tooltipDiv.getElementsByTagName("span")[0].textContent=this._legend.hLegendLabels[a.hActive];this.tooltipDiv.getElementsByTagName("span")[1].textContent=
a.name;var d=this.tooltipDiv.getElementsByTagName("ul")[0];d.innerHTML="";for(var e=0;e<this._legend.vLegendLabels.length;e++)this._legend.itemStatuses[e]!==0&&(d.innerHTML+='<li style="line-height:20px;'+(e===a.vActive?"":"opacity:0.6;")+'"><div style="width: 12px;height: 12px;margin: 5px 5px 0 0;float: left;background-color: '+(this._legend.itemColors[e]?this._legend.itemColors[e]:this._rendererOptions.markPoint.itemStyle.color)+';"></div><span style="font-weight: 600;">'+this._legend.vLegendLabels[e]+
"\uff1a</span><span>"+this._rendererOptions.tooltip.formatter.replace("{0}",a.measureValues[a.hActive][e])+"</span></li>");this.tooltipDiv.style.top=c-15+"px";this.tooltipDiv.style.left=b+15+"px";this.tooltipDiv.style.display="block"}},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;
this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";this.legendDiv&&(this.legendDiv.style.display=a?"block":"none");a?this.draw():this.stopDraw()},setData:function(a){this.data=a;for(var b=[],c=0;c<a.length;c++){for(var d=[],e=0;e<this._legend.hLegendLabels.length;e++){d[e]=[];for(var f=0;f<this._legend.vLegendLabels.length;f++)d[e][f]=Number(a[c].properties[this._legend.hLegendLabels[e]][this._legend.vLegendLabels[f]]||
0)}b.push(new this.MarkPoint(c,a[c].properties.name,d,a[c].geometry.coordinates[0],a[c].geometry.coordinates[1]))}this.markPoints=b}});
GeoGlobe.Visuals.Custom.Voronoi=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkFace:null,markFaces:[],visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},_init_RendererOptions:function(){this._rendererOptions=
GeoGlobe.Util.deepExtend({},{markFace:{hoverable:!0,clickable:!0,itemStyle:{color:"rgba(255,0,0,0)",borderColor:"#000",borderWidth:1,shadowColor:"#000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}}},this.rendererOptions)},_initMarkFace:function(){var a=this,b=this._rendererOptions.markFace.itemStyle;if(typeof b.color===
"object")var c=GeoGlobe.Util.getGradientImageData(b.color);this.MarkFace=function(a,e,f,g,h,j){this.index=a;this.name=e;this.value=f;this.lon=g;this.lat=h;this.polygons=j;this.vertices=[];this.color=typeof b.color==="object"?"rgba("+c[parseInt(f*255,10)*4]+","+c[parseInt(f*255,10)*4+1]+","+c[parseInt(f*255,10)*4+2]+","+c[3]/255+")":b.color};this.MarkFace.prototype.updateXY=function(){var b=a._parent.map.project([this.lon,this.lat]);this.x=b.x;this.y=b.y;var c;this.vertices=[];this.polygons.map(function(f){f.geometry.coordinates.map(function(g){c=
[];(f.geometry.type==="MultiPolygon"?g[0]:g).map(function(f){b=a._parent.map.project(f);c.push([b.x,b.y])});this.vertices.push(c)}.bind(this))}.bind(this))};this.MarkFace.prototype.isPointInPath=function(b,c,f){b.beginPath();this.vertices.map(function(a){b.moveTo(a[0][0],a[0][1]);a.map(function(a){b.lineTo(a[0],a[1])})});b.closePath();if(b.isPointInPath(c,f))a.hoveredMarkFace=this};this.MarkFace.prototype.draw=function(c){c.shadowColor=b.shadowColor;c.shadowBlur=b.shadowBlur;c.shadowOffsetX=b.shadowOffsetX;
c.shadowOffsetY=b.shadowOffsetY;c.beginPath();this.vertices.map(function(a){c.moveTo(a[0][0],a[0][1]);a.map(function(a){c.lineTo(a[0],a[1])})});c.closePath();c.fillStyle=a.hoveredMarkFace===this?GeoGlobe.Util.getShadeColor(this.color,20):this.color;c.strokeStyle=b.borderColor;c.lineWidth=b.borderWidth;c.stroke();c.fill()}},_initBounds:function(){var a=this,b=new XMLHttpRequest;b.open("GET",this.boundsURL,!0);b.responseType="json";b.onload=function(){switch(this.response.features[0].geometry.type){case "Polygon":a.bounds=
this.response.features;break;case "MultiPolygon":a.bounds=[];for(var b=this.response.features[0].geometry.coordinates,d=0;d<b.length;d++)a.bounds.push(turf.polygon(b[d]))}};b.send()},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));
this.canvas[0].style.position="absolute";this.div.appendChild(this.canvas[0])},_initTooltip:function(){if((this._rendererOptions.markFace.hoverable||this._rendererOptions.markFace.clickable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=
this._rendererOptions.tooltip.padding+"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),this.tooltipDiv.style["border-width"]=
this._rendererOptions.tooltip.borderWidth+"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="nowrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},render:function(){this._init_RendererOptions();
this._initTooltip();this._initMarkFace();this._initBounds();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas();this.frame&&cancelAnimationFrame(this.frame)},onMove:function(){this.updateXY();this.drawCanvas()},onMoveEnd:function(){this.redraw()},onClick:function(a){this.visibility&&this._rendererOptions.markFace.clickable&&this.hoveredMarkFace&&this._parent.fire("overlayerclick",{layer:this,feature:this.hoveredMarkFace,event:a})},onMouseMove:function(a){this.visibility&&
this._rendererOptions.markFace.hoverable&&this.markFaces.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),this.hoveredMarkFace&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkFace,event:a}))},onResize:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();
this.drawCanvas()},updateXY:function(){for(var a=this.markFaces.length;a--;)this.markFaces[a].updateXY()},drawCanvas:function(){this.cacheCanvas[0].width=this.width;for(var a=this.markFaces.length;a--;)this.markFaces[a].draw(this.cacheCanvasContext[0]);this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},clearCanvas:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();
this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,b){this.lastHoveredMarkFace=this.hoveredMarkFace?GeoGlobe.Util.clone(this.hoveredMarkFace):null;this.hoveredMarkFace=null;for(var c=0,d=this.markFaces.length;c<d;c++)!this.hoveredMarkFace&&this.markFaces[c].isPointInPath(this.cacheCanvasContext[0],a,b);this.drawCanvas();this.hoveredMarkFace?
(this.canvas[0].style.cursor="pointer",this.showTooltip(this.hoveredMarkFace.name,a,b)):(this.canvas[0].style.cursor="grab",this.hideTooltip())},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);
this._parent.container.appendChild(this.div);this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";a?this.draw():this.stopDraw()},getVoronoi:function(a){a=GeoGlobe.Util.clone(a);a.features.map(function(a){a.geometry.coordinates=GeoGlobe.Util.transferToMercator(a.geometry.coordinates)});
a=turf.voronoi(a,{bbox:GeoGlobe.Util.transferToMercator([-180,-90]).concat(GeoGlobe.Util.transferToMercator([180,90]))});a=GeoGlobe.Util.clone(a);a.features.map(function(a){a.geometry.coordinates[0].map(function(c,d){a.geometry.coordinates[0][d]=GeoGlobe.Util.transferToLonLat(c)})});return a},setData:function(a){this.data=a;var b=this,c=setInterval(function(){if(b.bounds){clearInterval(c);b.markFaces=[];b.hoveredMarkFace=null;for(var d=b.getVoronoi({type:"FeatureCollection",features:a}).features,
e=b.bounds,f,g,h=0;h<d.length;h++){f=[];for(var j=0;j<e.length;j++)(g=turf.intersect(d[h],e[j]))&&f.push(g);b.markFaces.push(new b.MarkFace(h,a[h].properties.name,Math.random(),a[h].geometry.coordinates[0],a[h].geometry.coordinates[1],f))}b.redraw()}},1)}});
GeoGlobe.Visuals.Custom.Delaunay=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkFace:null,markFaces:[],visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},_init_RendererOptions:function(){this._rendererOptions=
GeoGlobe.Util.deepExtend({},{markFace:{hoverable:!0,clickable:!0,itemStyle:{color:"rgba(255,0,0,0.5)",borderColor:"#000",borderWidth:1,shadowColor:"#000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}}},this.rendererOptions)},_initMarkFace:function(){var a=this,b=this._rendererOptions.markFace.itemStyle;if(typeof b.color===
"object")var c=GeoGlobe.Util.getGradientImageData(b.color);this.MarkFace=function(a,e,f,g){this.index=a;this.count=e;this.attributes=f;this.triangle=g;this.vertices=[];this.color=typeof b.color==="object"?"rgba("+c[parseInt(e*255,10)*4]+","+c[parseInt(e*255,10)*4+1]+","+c[parseInt(e*255,10)*4+2]+","+c[3]/255+")":b.color};this.MarkFace.prototype.updateXY=function(){for(var b=4;b--;){var c=a._parent.map.project(this.triangle.geometry.coordinates[0][b]);this.x=c.x;this.y=c.y;this.vertices[b]=[this.x,
this.y]}};this.MarkFace.prototype.isPointInPath=function(b,c,f){b.beginPath();b.moveTo(this.vertices[3][0],this.vertices[3][1]);for(var g=3;g--;)b.lineTo(this.vertices[g][0],this.vertices[g][1]);b.closePath();if(b.isPointInPath(c,f))a.hoveredMarkFace=this};this.MarkFace.prototype.draw=function(c){c.shadowColor=b.shadowColor;c.shadowBlur=b.shadowBlur;c.shadowOffsetX=b.shadowOffsetX;c.shadowOffsetY=b.shadowOffsetY;c.beginPath();c.moveTo(this.vertices[3][0],this.vertices[3][1]);for(var e=3;e--;)c.lineTo(this.vertices[e][0],
this.vertices[e][1]);c.closePath();c.fillStyle=a.hoveredMarkFace===this?GeoGlobe.Util.getShadeColor(this.color,20):this.color;c.strokeStyle=b.borderColor;c.lineWidth=b.borderWidth;c.stroke();c.fill();c.beginPath();c.arc(this.x,this.y,1,0,Math.PI*2,!1);c.fillStyle="#fff";c.fill()}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));
this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.canvas[0].style.position="absolute";this.div.appendChild(this.canvas[0])},_initTooltip:function(){if((this._rendererOptions.markFace.hoverable||this._rendererOptions.markFace.clickable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=
this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=this._rendererOptions.tooltip.padding+"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),
this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="nowrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},
render:function(){this._init_RendererOptions();this._initMarkFace();this._initTooltip();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas();this.frame&&cancelAnimationFrame(this.frame)},onMove:function(){this.updateXY();this.drawCanvas()},onMoveEnd:function(){this.redraw()},onClick:function(a){this.visibility&&this._rendererOptions.markFace.clickable&&this.hoveredMarkFace&&this._parent.fire("overlayerclick",{layer:this,feature:this.hoveredMarkFace,event:a})},onMouseMove:function(a){this.visibility&&
this._rendererOptions.markFace.hoverable&&this.markFaces.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),this.hoveredMarkFace&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkFace,event:a}))},onResize:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width=this.parentMap.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this.parentMap.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();this.drawCanvas()},
updateXY:function(){for(var a=this.markFaces.length;a--;)this.markFaces[a].updateXY()},clearCanvas:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,
b){this.lastHoveredMarkFace=this.hoveredMarkFace?GeoGlobe.Util.clone(this.hoveredMarkFace,!1):null;this.hoveredMarkFace=null;for(var c=0,d=this.markFaces.length;c<d;c++)!this.hoveredMarkFace&&this.markFaces[c].isPointInPath(this.cacheCanvasContext[0],a,b);this.drawCanvas();this.hoveredMarkFace?(this.canvas[0].style.cursor="pointer",this.showTooltip("["+this.hoveredMarkFace.attributes.a+","+this.hoveredMarkFace.attributes.b+","+this.hoveredMarkFace.attributes.c+"]",a,b)):(this.canvas[0].style.cursor=
"grab",this.hideTooltip())},drawCanvas:function(){this.cacheCanvas[0].width=this.width;for(var a=this.markFaces.length;a--;)this.markFaces[a].draw(this.cacheCanvasContext[0]);this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display=
"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";a?this.draw():this.stopDraw()},setData:function(a){this.data=a;var b=this,c=setInterval(function(){clearInterval(c);b.markFaces=
[];b.hoveredMarkFace=null;var d,e;e=turf.tin({type:"FeatureCollection",features:a},"name");for(var f=0;f<e.features.length;f++)d=e.features[f],b.markFaces.push(new b.MarkFace(f,Math.random(),d.properties,d));b.redraw()},1)}});
GeoGlobe.Visuals.Custom.Network=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPoint:null,MarkLine:null,markPoints:[],markLines:[],visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":
"none"},_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({},{markLine:{hoverable:!0,itemStyle:{color:"#0095ff",width:2}},markPoint:{hoverable:!0,itemStyle:{images:["../../images/symbol/00.png","../../images/symbol/01.png","../../images/symbol/02.png","../../images/symbol/03.png"],shadowColor:"#000000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",
fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}}},this.rendererOptions)},_initMarkPointImages:function(){this.markPointImages=[];var a=this;this._rendererOptions.markPoint.itemStyle.images.forEach(function(b){var c=new Image;c.src=b;c.onload=function(){a.drawCanvas1()};a.markPointImages.push(c)})},_initMarkPoint:function(){var a=this,b=this._rendererOptions.markPoint.itemStyle;this.MarkPoint=function(a,b,e,f,g,h,j,l){this.index=a;this.id=b;this.name=e;this.value=f;this.symbol=
g;this.lon=h;this.lat=j;this.attributes=l;this.width=50;this.height=68;this.radius=30};this.MarkPoint.prototype.init=function(){};this.MarkPoint.prototype.updateXY=function(){var b=a._parent.map.project([this.lon,this.lat]);this.x=b.x;this.y=b.y};this.MarkPoint.prototype.update=function(){};this.MarkPoint.prototype.isPointInPath=function(b,d,e){b.beginPath();this.symbol===0?b.rect(this.x-this.width/2,this.y-this.height+5,this.width,this.height):b.arc(this.x,this.y,this.radius,0,Math.PI*2,!0);if(b.isPointInPath(d,
e))a.hoveredMarkPoint=this};this.MarkPoint.prototype.draw1=function(c){var d=!1;if(a.hoveredMarkPoint===this||a.hoveredMarkLine&&(a.hoveredMarkLine.source===this||a.hoveredMarkLine.target===this))d=!0;c.globalAlpha=a.energy;c.shadowColor=b.shadowColor;c.shadowBlur=b.shadowBlur;c.shadowOffsetX=b.shadowOffsetX;c.shadowOffsetY=b.shadowOffsetY;c.save();c.translate(this.x,this.y);d&&c.scale(1.1,1.1);this.symbol===0?c.drawImage(a.markPointImages[this.symbol],-this.width/2,-this.height+5):c.drawImage(a.markPointImages[this.symbol],
-this.radius,-this.radius);c.restore()};this.MarkPoint.prototype.draw2=function(){}},_initMarkLine:function(){var a=this,b=this._rendererOptions.markLine.itemStyle;this.MarkLine=function(a,d,e){this.index=a;this.source=d;this.target=e;this.width=b.width;this.color=b.color};this.MarkLine.prototype.updateXY=function(){};this.MarkLine.prototype.isPointInStroke=function(b,d,e){b.beginPath();b.moveTo(this.source.x,this.source.y);b.lineTo(this.target.x,this.target.y);if(b.isPointInStroke(d,e))a.hoveredMarkLine=
this};this.MarkLine.prototype.draw=function(b){var d=this.color;if(a.hoveredMarkLine===this||a.hoveredMarkPoint===this.source||a.hoveredMarkPoint===this.target)d=GeoGlobe.Util.getShadeColor(d,20);b.beginPath();b.moveTo(this.source.x,this.source.y);b.lineTo(this.source.x+(this.target.x-this.source.x)*a.energy,this.source.y+(this.target.y-this.source.y)*a.energy);b.lineWidth=this.width;b.strokeStyle=d;b.stroke()}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));
this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.canvasContext.push(this.canvas[1].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.cacheCanvasContext.push(this.cacheCanvas[1].getContext("2d"));this.canvas[0].style.position="absolute";this.canvas[1].style.position=
"absolute";this.div.appendChild(this.canvas[0]);this.div.appendChild(this.canvas[1])},_initTooltip:function(){if((this._rendererOptions.markLine.hoverable||this._rendererOptions.markPoint.hoverable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,
this.tooltipDiv.style.padding=this._rendererOptions.tooltip.padding+"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),
this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="nowrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},
render:function(){this._init_RendererOptions();this._initMarkPointImages();this._initMarkPoint();this._initMarkLine();this._initTooltip();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas1();this.energy=0;this.animation=!0;this.frame&&cancelAnimationFrame(this.frame);var a=this;(function c(){if(a.energy<1)a.frame=requestAnimationFrame(c),a.energy+=0.05,a.energy>1&&(a.energy=1),a.drawCanvas1()})()},onMove:function(){this.animation=!1;this.updateXY();this.drawCanvas1();
this.drawCanvas2()},onMoveEnd:function(){this.redraw()},onMouseMove:function(a){if(this.visibility&&(this._rendererOptions.markLine.hoverable||this._rendererOptions.markPoint.hoverable)&&this.markPoints.length>0&&!this._parent.map.moving)this.hover(a.point.x,a.point.y),this.hoveredMarkPoint&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkPoint,event:a})},onResize:function(){this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width=
this._parent.map.transform.width;this.canvas[0].height=this.canvas[1].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();this.drawCanvas1();this.drawCanvas2()},updateXY:function(){this.markPoints.forEach(function(a){a.updateXY()})},drawCanvas1:function(){this.cacheCanvas[0].width=this.width;var a=this;this.markLines.forEach(function(b){b.draw(a.cacheCanvasContext[0])});this.markPoints.forEach(function(b){b.draw1(a.cacheCanvasContext[0])});
this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawCanvas2:function(){},clearCanvas:function(){this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this.markPointImages=[];this.MarkPoint=null;this.markPoints=[];this.MarkLine=null;this.markLines=[];this.canvas=
[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,b){this.hoveredMarkPoint=this.hoveredMarkLine=null;var c=this;this.markPoints.forEach(function(d){!c.hoveredMarkPoint&&d.isPointInPath(c.cacheCanvasContext[0],a,b)});this.markLines.forEach(function(d){!c.hoveredMarkLine&&d.isPointInStroke(c.cacheCanvasContext[0],a,b)});this.drawCanvas1();this.hoveredMarkLine||this.hoveredMarkPoint?(this.showTooltip(this.hoveredMarkLine?this.hoveredMarkLine.source.name+
" > "+this.hoveredMarkLine.target.name:this.hoveredMarkPoint.name,a,b),this.canvas[1].style.cursor="pointer"):(this.hideTooltip(),this.canvas[1].style.cursor="grab")},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=
a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.canvas[1].width=this.cacheCanvas[0].width=this.cacheCanvas[1].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.canvas[1].height=this.cacheCanvas[0].height=this.cacheCanvas[1].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";a?this.draw():this.stopDraw()},getMarkPointById:function(a){for(var b,
c=0,d=this.markPoints.length;c<d;c++)if(this.markPoints[c].id===a){b=this.markPoints[c];break}return b},setData:function(a){this.hoveredMarkLine=this.hoveredMarkPoint=null;this.markPoints=[];this.markLines=[];var b=this,c,d,a=a||{};a.points=a.points||[];a.points.forEach(function(a,d){c=new b.MarkPoint(d,a.id,a.name,a.value,a.symbol,a.lon,a.lat,a);b.markPoints.push(c)});a.links=a.links||[];a.links.forEach(function(a,c){d=new b.MarkLine(c,b.getMarkPointById(a.source),b.getMarkPointById(a.target));b.markLines.push(d)});
this.data=a}});
GeoGlobe.Visuals.Custom.Fluorescence=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPointsSet:null,markPointsSets:[],legendLabels:[],visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":
"none"},_init_Legend:function(){this._legend=GeoGlobe.Util.deepExtend({},{show:!0,left:null,right:null,top:null,bottom:null,col:1,itemSize:10,itemColors:[],itemStatuses:[],backgroundColor:"rgba(0,0,0,0.5)",borderColor:"#000",borderWidth:1,borderRadius:0,shadowColor:"#fff",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0,padding:10,textStyle:{color:"#fff",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}},this.legend)},_init_Legend_rightop:function(){this._legend_rightop=GeoGlobe.Util.deepExtend({},
{show:!0,left:null,right:null,top:null,bottom:null,col:1,itemSize:10,itemColors:[],itemStatuses:[],backgroundColor:"rgba(0,0,0,0.5)",borderColor:"#000",borderWidth:1,borderRadius:0,shadowColor:"#fff",shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0,padding:10,textStyle:{color:"#fff",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}},this.legend_rightop)},_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({},{markPoint:{unactivatedDrawable:!0,itemSymbol:[],
itemStyle:{color:"rgba(255,0,0,0.7)",shadowColor:"#000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0}}},this.rendererOptions)},_initMarkPointsSet:function(){var a=this,b=this._legend.itemColors,c=this._rendererOptions.markPoint.itemStyle,d=this._rendererOptions.markPoint.effect,e=this._rendererOptions.markPoint.itemSymbol;this.MarkPointsSet=function(f,g,h){this.legendLabel=f;this.markPoints=g;for(f=g.length;f--;){g[f].value<66?(g[f].symbolSize=1,g[f].symbol=e[0]):g[f].value<95?(g[f].symbolSize=3,
g[f].symbol=e[1]):(g[f].symbolSize=4,g[f].symbol=e[2]);if(GeoGlobe.Util.getType(a._rendererOptions.markPoint.itemStyle.color[h])==="object")a.gradientImageData=GeoGlobe.Util.getGradientImageData(a._rendererOptions.markPoint.itemStyle.color[h]);g[f].category=this.legendLabel;g[f].color=GeoGlobe.Util.getType(c.color[h])==="object"?"rgba("+a.gradientImageData[~~(g[f].weight*255+0.5)*4]+","+a.gradientImageData[~~(g[f].weight*255+0.5)*4+1]+","+a.gradientImageData[~~(g[f].weight*255+0.5)*4+2]+","+a.gradientImageData[3]/
255+")":b[h];g[f].rgbColor=GeoGlobe.Util.getRgbColor(g[f].color);g[f].alpha=g[f].color.indexOf("a(")!==-1?+g[f].color.split(",")[3].split(")")[0]:1;switch(g[f].symbol){case "circle":g[f].energy=[0,0.25,0.5,0.75];g[f].increment=Math.max(0.1*d.scaleSize/d.period+Math.random()*(Math.random()>0.5?1:-1)*0.002,0.001);break;case "ring":g[f].energy=[0,1/3*d.scaleSize,2/3*d.scaleSize],g[f].increment=Math.max(0.1*d.scaleSize/d.period+Math.random()*(Math.random()>0.5?1:-1)*0.002,0.001)}}};this.MarkPointsSet.prototype.update=
function(){var a;for(a=this.markPoints.length;a--;)switch(this.markPoints[a].symbol){case "circle":for(var b=0;b<4;b++)this.markPoints[a].energy[b]+=this.markPoints[a].increment,this.markPoints[a].energy[b]>1&&(this.markPoints[a].energy[b]=0);break;case "ring":for(b=0;b<3;b++)this.markPoints[a].energy[b]+=this.markPoints[a].increment,this.markPoints[a].energy[b]>d.scaleSize&&(this.markPoints[a].energy[b]=0)}};this.MarkPointsSet.prototype.isPointInPath=function(b,c,d){for(var e=0;e<this.markPoints.length;e++){var l=
this.markPoints[e];b.beginPath();switch(l.symbol){case "circle":case "ring":b.arc(l.x,l.y,l.symbolSize,0,Math.PI*2,!0)}if(b.isPointInPath(c,d))a.hoveredMarkPoint=l}};this.MarkPointsSet.prototype.updateXY=function(){for(var b=this.markPoints.length;b--;){var c=a._parent.map.project([this.markPoints[b].lon,this.markPoints[b].lat]);this.markPoints[b].x=c.x;this.markPoints[b].y=c.y}};this.MarkPointsSet.prototype.draw=function(a){for(var b=this.markPoints.length;b--;){var c;c=this.markPoints[b];var e;
a.fillStyle=c.color;a.beginPath();switch(c.symbol){case "circle":a.beginPath();a.arc(c.x,c.y,c.symbolSize/2,0,Math.PI*2,!0);a.strokeStyle="rgba"+c.rgbColor.slice(3).split(")")[0]+","+c.alpha+")";a.fill();for(e=0;e<4;)a.beginPath(),a.arc(c.x,c.y,c.symbolSize+c.symbolSize*(d.scaleSize-1)*c.energy[e],0,Math.PI*2,!0),a.strokeStyle="rgba"+c.rgbColor.slice(3).split(")")[0]+","+(1-c.energy[e])*c.alpha+")",a.stroke(),e++;break;case "ring":for(e=0;e<3;)a.beginPath(),a.arc(c.x,c.y,c.symbolSize*c.energy[e],
0,Math.PI*2,!0),a.fillStyle="rgba"+c.rgbColor.slice(3).split(")")[0]+","+Math.max(1-c.energy[e]/d.scaleSize,0)*c.alpha+")",a.fill(),e++}}}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.canvas[0].style.position=
"absolute";this.div.appendChild(this.canvas[0])},_initTooltip:function(){if((this._rendererOptions.markPoint.hoverable||this._rendererOptions.markPoint.clickable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=this._rendererOptions.tooltip.padding+
"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+
"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="pre-wrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},render:function(){this._init_Legend();this._init_Legend_rightop();
this._init_RendererOptions();this._initTooltip();this._initMarkPointsSet();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas();this.frame&&cancelAnimationFrame(this.frame)},lazydraw:function(){var a=this;(function c(){if(a.DRAWINDEX<a.legendLabels.length)requestAnimationFrame(c),a.drawLegend(a.DRAWINDEX),a.drawLegend2(a.DRAWINDEX),a.markPointsSets[a.DRAWINDEX].draw(a.cacheCanvasContext[0],a.DRAWINDEX),a.canvas[0].width=a.width,a.canvasContext[0].drawImage(a.cacheCanvas[0],
0,0),a.DRAWINDEX++})()},onMove:function(){this.updateXY();this.drawCanvas()},onMoveEnd:function(){this.moving=!1;this.redraw()},onClick:function(a){this.visibility&&this._rendererOptions.markPoint.clickable&&this.hoveredMarkPoint&&this._parent.fire("overlayerclick",{layer:this,feature:this.hoveredMarkPoint,event:a})},onMouseMove:function(a){this.visibility&&this._rendererOptions.markPoint.hoverable&&this.markPointsSets.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),this.hoveredMarkPoint&&
this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkPoint,event:a}))},onMoveEnd:function(){this.redraw()},onResize:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();this.drawCanvas()},updateXY:function(){for(var a=this.markPointsSets.length;a--;)this.markPointsSets[a].updateXY()},
drawCanvas:function(){this.cacheCanvas[0].width=this.width;for(var a=0,b=this.markPointsSets.length;a<b;a++)this.markPointsSets[a].draw(this.cacheCanvasContext[0],a);this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawLegend:function(a){if(this._legend&&this._legend.show&&!this.legendDiv){this.legendDiv=document.createElement("div");this.legendDiv.style.position="absolute";this.legendDiv.style["background-color"]=this._legend.backgroundColor;this.legendDiv.style["border-color"]=
this._legend.borderColor;this.legendDiv.style["border-width"]=this._legend.borderWidth+"px";this.legendDiv.style["border-radius"]=this._legend.borderRadius+"px";this.legendDiv.style["border-style"]="solid";this.legendDiv.style["box-shadow"]=this._legend.shadowOffsetX+"px "+this._legend.shadowOffsetY+"px "+this._legend.shadowBlur+"px "+this._legend.shadowColor;this.legendDiv.style.padding=this._legend.padding+"px";this.legendDiv.style.left=this._legend.left!==null?this._legend.left+"px":null;this.legendDiv.style.right=
this._legend.right!==null?this._legend.right+"px":null;this.legendDiv.style.top=this._legend.top!==null?this._legend.top+"px":null;this.legendDiv.style.bottom=this._legend.bottom!==null?this._legend.bottom+"px":null;this.legendCanvas=document.createElement("canvas");this.legendCanvasContext=this.legendCanvas.getContext("2d");this.legendCanvas.style.display="block";this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+
"px "+this._legend.textStyle.fontFamily;this.legendDiv.appendChild(this.legendCanvas);this.div.appendChild(this.legendDiv);for(var b=[],c=null,d=0,e=this.legendLabels.length;d<e;d++)for(var c=this._legend.itemSize+10+this.legendCanvasContext.measureText(this.legendLabels[d].toString()).width,f=this._legend.col,g=0;g<f;g++)d%this._legend.col===g&&(!b[g]||b[g]<c)&&(b[g]=c);for(var h=10,c=10,d=0,e=b.length;d<e;d++)h+=b[d]+10;c+=((this._legend.itemSize<this._legend.textStyle.fontSize?this._legend.textStyle.fontSize:
this._legend.itemSize)+10)*(~~(this.legendLabels.length/this._legend.col)+(this.legendLabels.length%this._legend.col===0?0:1));this.legendCanvas.width=h;this.legendCanvas.height=c;var j=function(a,c,d,e){this.legendCanvas.width=h;for(var a=!1,f,g,j=0,t=this.legendLabels.length;j<t;j++){g=0;for(var s=this._legend.col;g<s;g++)if(j%this._legend.col===g){f=10+this._legend.itemSize/2;for(var u=0;u<g;u++)f+=b[u]+10}g=10+this._legend.itemSize/2+((this._legend.itemSize<this._legend.textStyle.fontSize?this._legend.textStyle.fontSize:
this._legend.itemSize)+10)*~~(j/this._legend.col);u=s=!1;this.legendCanvasContext.beginPath();switch(this._legend.symbol){case "ring":this.legendCanvasContext.arc(f,g,this._legend.itemSize/2,0,Math.PI*2,!1);break;case "circle":this.legendCanvasContext.arc(f,g,this._legend.itemSize/2,0,Math.PI*2,!1)}c==="mousemove"&&d!==void 0&&e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(a=s=!0);c==="mousedown"&&d!==void 0&&e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(u=!0);this.legendCanvasContext.beginPath();
this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+"px "+this._legend.textStyle.fontFamily;this.legendCanvasContext.rect(f+this._legend.itemSize/2+10,g-this._legend.textStyle.fontSize/2,this.legendCanvasContext.measureText(this.legendLabels[j].toString()).width,this._legend.textStyle.fontSize);c==="mousemove"&&d!==void 0&&e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(a=s=!0);c==="mousedown"&&d!==void 0&&
e!==void 0&&this.legendCanvasContext.isPointInPath(d,e)&&(u=!0);u&&(this._legend.itemStatuses[j]=this._legend.itemStatuses[j]===0?1:0,this.drawCanvas());var v=this._legend.itemColors[j],w=this._legend.textStyle.color,v=s||u?GeoGlobe.Util.getShadeColor(v,20):v,w=s||u?GeoGlobe.Util.getShadeColor(w,20):w;this.legendCanvasContext.beginPath();switch(this._legend.symbol){case "ring":this.legendCanvasContext.arc(f,g,this._legend.itemSize/2,0,Math.PI*2,!1);break;case "circle":this.legendCanvasContext.arc(f,
g,this._legend.itemSize/2,0,Math.PI*2,!1)}this.legendCanvasContext.fillStyle=v;this.legendCanvasContext.fill();this.legendCanvasContext.font=this._legend.textStyle.fontStyle+" "+this._legend.textStyle.fontWeight+" "+this._legend.textStyle.fontSize+"px "+this._legend.textStyle.fontFamily;this.legendCanvasContext.textAlign="left";this.legendCanvasContext.textBaseline="middle";this.legendCanvasContext.fillStyle=w;this.legendCanvasContext.fillText(this.legendLabels[j],f+this._legend.itemSize/2+10,g)}this.legendCanvas.style.cursor=
a?"pointer":"default"}.bind(this);this.legendCanvas.onmousedown=function(a){var b=a.offsetX||a.clientX-(a.target||a.srcElement).getBoundingClientRect().left,c=a.offsetY||a.clientY-(a.target||a.srcElement).getBoundingClientRect().top;j(void 0,a.type,b,c)};this.legendCanvas.onmousemove=function(a){var b=a.offsetX||a.clientX-(a.target||a.srcElement).getBoundingClientRect().left,c=a.offsetY||a.clientY-(a.target||a.srcElement).getBoundingClientRect().top;j(void 0,a.type,b,c)};j(a)}},drawLegend2:function(){if(this._legend_rightop&&
this._legend_rightop.show){if(!this.legendDiv2)this.legendDiv2=document.createElement("div"),this.legendDiv2.style.position="absolute",this.legendDiv2.style["background-color"]=this._legend.backgroundColor,this.legendDiv2.style["border-color"]=this._legend.borderColor,this.legendDiv2.style["border-width"]=this._legend.borderWidth+"px",this.legendDiv2.style["border-radius"]=this._legend.borderRadius+"px",this.legendDiv2.style["border-style"]="solid",this.legendDiv2.style["box-shadow"]=this._legend.shadowOffsetX+
"px "+this._legend.shadowOffsetY+"px "+this._legend.shadowBlur+"px "+this._legend.shadowColor,this.legendDiv2.style.padding=this._legend.padding+"px",this.legendDiv2.style.left=this._legend_rightop.left!==null?this._legend_rightop.left+"px":null,this.legendDiv2.style.right=this._legend_rightop.right!==null?this._legend_rightop.right+"px":null,this.legendDiv2.style.top=this._legend_rightop.top!==null?this._legend_rightop.top+"px":null,this.legendDiv2.style.bottom=this._legend_rightop.bottom!==null?
this._legend_rightop.bottom+"px":null,this.legendCanvas2=document.createElement("canvas"),this.legendCanvasContext2=this.legendCanvas2.getContext("2d"),this.legendCanvas2.style.display="block",this.legendCanvasContext2.font=this._legend_rightop.textStyle.fontStyle+" "+this._legend_rightop.textStyle.fontWeight+" "+this._legend_rightop.textStyle.fontSize+"px "+this._legend_rightop.textStyle.fontFamily,this.legendDiv2.appendChild(this.legendCanvas2),this.div.appendChild(this.legendDiv2);for(var a=[],
b=null,c=0,d=this._legend_rightop.vLegendLabels.length;c<d;c++)for(var b=this._legend_rightop.itemWidth+10+this.legendCanvasContext2.measureText(this._legend_rightop.vLegendLabels[c].toString()).width,e=this._legend_rightop.col,f=0;f<e;f++)c%this._legend_rightop.col===f&&(!a[f]||a[f]<b)&&(a[f]=b);b=10;c=0;for(d=a.length;c<d;c++)b+=a[c]+10;this.legendCanvas2.width=b;this.legendCanvas2.height=this._legend_rightop.itemHeight;(function(){var b,d,e=0;for(d=this._legend_rightop.col;e<d;e++)if(c%this._legend_rightop.col===
e){b=10+this._legend_rightop.itemSize/2;for(var f=0;f<e;f++)b+=a[f]+10}d=this._legend_rightop.itemSize/2+((this._legend_rightop.itemSize<this._legend_rightop.textStyle.fontSize?this._legend_rightop.textStyle.fontSize:this._legend_rightop.itemSize)+10)*~~(c/this._legend_rightop.col);var f=this._rendererOptions.markPoint.itemStyle.color,n=this._legend_rightop.textStyle.color;this.legendCanvasContext2.beginPath();this.legendCanvasContext2.arc(b,d,this._legend_rightop.itemSize_circle[0]/2,0,Math.PI*2,
!1);this.legendCanvasContext2.fillStyle=f;this.legendCanvasContext2.fill();for(e=0;e<4;)this.legendCanvasContext2.beginPath(),this.legendCanvasContext2.arc(b,d,this._legend_rightop.itemSize_circle[e]/2,0,Math.PI*2,!1),this.legendCanvasContext2.strokeStyle=f,this.legendCanvasContext2.stroke(),e++;this.legendCanvasContext2.font=this._legend_rightop.textStyle.fontStyle+" "+this._legend_rightop.textStyle.fontWeight+" "+this._legend_rightop.textStyle.fontSize+"px "+this._legend_rightop.textStyle.fontFamily;
this.legendCanvasContext2.textAlign="left";this.legendCanvasContext2.textBaseline="middle";this.legendCanvasContext2.fillStyle=n;this.legendCanvasContext2.fillText(this._legend_rightop.vLegendLabels[0],b+this._legend_rightop.itemWidth/2+10,d);this.legendCanvasContext2.beginPath();this.legendCanvasContext2.arc(b+(this._legend_rightop.itemWidth+10)*2,d,this._legend_rightop.itemSize_ringBig[0]/2,0,Math.PI*2,!1);this.legendCanvasContext2.fillStyle=f;this.legendCanvasContext2.fill();for(e=0;e<3;)this.legendCanvasContext2.beginPath(),
this.legendCanvasContext2.arc(b+(this._legend_rightop.itemWidth+10)*2,d,this._legend_rightop.itemSize_ringBig[e]/2,0,Math.PI*2,!1),this.legendCanvasContext2.fillStyle=f,this.legendCanvasContext2.fill(),e++;this.legendCanvasContext2.font=this._legend_rightop.textStyle.fontStyle+" "+this._legend_rightop.textStyle.fontWeight+" "+this._legend_rightop.textStyle.fontSize+"px "+this._legend_rightop.textStyle.fontFamily;this.legendCanvasContext2.textAlign="left";this.legendCanvasContext2.textBaseline="middle";
this.legendCanvasContext2.fillStyle=n;this.legendCanvasContext2.fillText(this._legend_rightop.vLegendLabels[1],b+(this._legend_rightop.itemWidth+10)*2+15,d);this.legendCanvasContext2.beginPath();this.legendCanvasContext2.arc(b+(this._legend_rightop.itemWidth+10)*4,d,this._legend_rightop.itemSize_ringSmall[0]/2,0,Math.PI*2,!1);this.legendCanvasContext2.fillStyle=f;this.legendCanvasContext2.fill();for(e=0;e<3;)this.legendCanvasContext2.beginPath(),this.legendCanvasContext2.arc(b+(this._legend_rightop.itemWidth+
10)*4,d,this._legend_rightop.itemSize_ringSmall[e]/2,0,Math.PI*2,!1),this.legendCanvasContext2.fillStyle=f,this.legendCanvasContext2.fill(),e++;this.legendCanvasContext2.font=this._legend_rightop.textStyle.fontStyle+" "+this._legend_rightop.textStyle.fontWeight+" "+this._legend_rightop.textStyle.fontSize+"px "+this._legend_rightop.textStyle.fontFamily;this.legendCanvasContext2.textAlign="left";this.legendCanvasContext2.textBaseline="middle";this.legendCanvasContext2.fillStyle=n;this.legendCanvasContext2.fillText(this._legend_rightop.vLegendLabels[2],
b+(this._legend_rightop.itemWidth+10)*4+13,d)}).bind(this)()}},clearCanvas:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this.MarkPoint=null;this.markPoints=[];this.canvas=[];this.data=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this._rendererOptions={}},hover:function(a,b){this.hoveredMarkPoint=
null;for(var c=0,d=this.markPointsSets.length;c<d;c++)!this.hoveredMarkPoint&&this.markPointsSets[c].isPointInPath(this.cacheCanvasContext[0],a,b);this.drawCanvas();this.hoveredMarkPoint?(this.canvas[0].style.cursor="pointer",this.showTooltip(this.hoveredMarkPoint.category,a,b)):(this.canvas[0].style.cursor="grab",this.hideTooltip())},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+
"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?
"block":"none";this.legendDiv&&(this.legendDiv.style.display=a?"block":"none");a?this.draw():this.stopDraw()},setData:function(a){this.data=a;a=new Blob(["function MarkPoint(lon, lat, value) {this.lon = lon;this.lat = lat;this.value = value;}function MarkPointsSet(legendLabel) {this.legendLabel = legendLabel;this.markPoints = [];}var legendLabels = [];var markPointsSets = [];onmessage = function (evt) {var features = evt.data.data;var feature = null;var legendLabel = null;for (var i = 0, len = features.length; i < len; i++) {feature = features[i];legendLabel = feature.properties.type;if (legendLabels.indexOf(legendLabel) === -1) {legendLabels.push(legendLabel);markPointsSets.push(new MarkPointsSet(legendLabel));}markPointsSets[legendLabels.indexOf(legendLabel)].markPoints.push(new MarkPoint(feature.geometry.coordinates[0], feature.geometry.coordinates[1],feature.properties.value));}postMessage({legendLabels: legendLabels,markPointsSets: markPointsSets})}"]);
a=window.URL.createObjectURL(a);a=new Worker(a);a.postMessage({data:this.data});var b;a.onmessage=function(a){this.legendLabels=a.data.legendLabels;for(var d=0,e=a.data.markPointsSets.length;d<e;d++)b=new this.MarkPointsSet(a.data.markPointsSets[d].legendLabel,a.data.markPointsSets[d].markPoints,d),b.updateXY(),this.markPointsSets.push(b);this.DRAWINDEX=0;this.lazydraw()}.bind(this)}});
GeoGlobe.Visuals.Custom.Cluster=GeoGlobe.Class4OL({_parent:null,canvas:[],cacheCanvas:[],canvasContext:[],cacheCanvasContext:[],MarkPoint:null,MarkCluster:null,markPoints:[],markClusterZoomMap:[],markClusterMaxZoom:18,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=
this.visibility?"block":"none"},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.canvas[0].style.position="absolute";this.div.appendChild(this.canvas[0])},_init_RendererOptions:function(){this._rendererOptions=
GeoGlobe.Util.deepExtend({},{markPoint:{nameField:"name",hoverable:!0,clickable:!0,symbol:"icon",symbolSrc:"",symbolSize:8,symbolWidth:24,symbolHeight:30,itemStyle:{color:"#f00",lineWidth:1,lineColor:"#fff",shadowColor:"#000000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0}},markCluster:{hoverable:!0,clickable:!0,symbol:"icon",symbolSrc:"bubble.png",symbolSize:[[0,40],[9,60],[99,80]],itemStyle:{color:[[0,"rgba(0, 0, 255, 0.7)"],[9,"rgba(0, 255, 0, 0.7)"],[99,"rgba(255, 0, 0, 0.7)"]],lineWidth:3,lineColor:"#fff",
shadowColor:"#000",shadowBlur:0,shadowOffsetX:0,shadowOffsetY:0},label:{show:!0,color:"#fff",align:"center",baseline:"middle",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}},tooltip:{show:!0,backgroundColor:"#fff",borderColor:"#333",borderRadius:0,borderWidth:0,padding:10,textStyle:{color:"#000",fontFamily:"serif",fontSize:12,fontStyle:"normal",fontWeight:"normal"}}},this.rendererOptions)},_initTooltip:function(){if((this._rendererOptions.markPoint.hoverable||this._rendererOptions.markPoint.clickable||
this._rendererOptions.markCluster.hoverable||this._rendererOptions.markCluster.clickable)&&this._rendererOptions.tooltip.show)this.tooltipDiv=this.tooltipDiv||this.div.appendChild(document.createElement("div")),this.tooltipDiv.style.position="relative",this.tooltipDiv.style.display="none",this.tooltipDiv.style.zIndex=999,this.tooltipDiv.style.color=this._rendererOptions.tooltip.textStyle.color,this.tooltipDiv.style.padding=this._rendererOptions.tooltip.padding+"px",this.tooltipDiv.style.font=this._rendererOptions.tooltip.textStyle.fontStyle+
" "+this._rendererOptions.tooltip.textStyle.fontWeight+" "+this._rendererOptions.tooltip.textStyle.fontSize+"px "+this._rendererOptions.tooltip.textStyle.fontFamily,this.tooltipDiv.style["background-color"]=document.createElement("canvas").getContext?this._rendererOptions.tooltip.backgroundColor:GeoGlobe.Util.getRgbColor(this._rendererOptions.tooltip.backgroundColor),this.tooltipDiv.style["border-width"]=this._rendererOptions.tooltip.borderWidth+"px",this.tooltipDiv.style["border-color"]=this._rendererOptions.tooltip.borderColor,
this.tooltipDiv.style["border-radius"]=this._rendererOptions.tooltip.borderRadius+"px",this.tooltipDiv.style["border-style"]="solid",this.tooltipDiv.style["white-space"]="pre-wrap",this.tooltipDiv.style["box-shadow"]="rgba(0, 0, 0, 0.2) 0px 10px 10px",this.tooltipDiv.style.transition="left 0.4s cubic-bezier(0.23, 1, 0.32, 1), top 0.4s cubic-bezier(0.23, 1, 0.32, 1)"},_initMarkPointImage:function(){if(this._rendererOptions.markPoint.symbol==="icon"){var a=this;this.markPointImage=new Image;this.markPointImage.width=
this._rendererOptions.markPoint.symbolWidth;this.markPointImage.height=this._rendererOptions.markPoint.symbolHeight;this.markPointImage.src=this._rendererOptions.markPoint.symbolSrc||"data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDE2IDIzIiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiA+PGRlZnM+PC9kZWZzPiA8cGF0aCAgZmlsbD0iI0RFMzMzMyIgc3Ryb2tlLWxpbmVjYXA9ImJ1dHQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGQ9Ik04IDIzbDAgMCAwIDAgMCAwIDAgMCAwIDBjLTQsLTUgLTgsLTEwIC04LC0xNCAwLC01IDQsLTkgOCwtOWwwIDAgMCAwYzQsMCA4LDQgOCw5IDAsNCAtNCw5IC04LDE0eiBNMyw5IGE1LDUgMCwxLDAsMCwtMC45WiI+PC9wYXRoPiA8L3N2Zz4=";
this.markPointImage.onload=function(){a.drawCanvas()}}},_initMarkClusterImages:function(){if(this._rendererOptions.markCluster.symbol==="icon"){var a=this;this.markClusterImages=[];typeof this._rendererOptions.markCluster.symbolSrc==="string"?this._rendererOptions.markCluster.symbolSize.forEach(function(b,c){var d=a._rendererOptions.markCluster.itemStyle.color[c][1],e=new Image;e.width=b[1];e.height=b[1];e.src=a._rendererOptions.markCluster.symbolSrc;e.onload=function(){var c=document.createElement("canvas"),
g=c.getContext("2d");c.width=c.height=b[1];g.drawImage(e,0,0,b[1],b[1]);for(var h=g.getImageData(0,0,b[1],b[1]),j=h.data,l=GeoGlobe.Util.getRgbColor(d).slice(4).split(")")[0].split(","),n=0,o=j.length;n<o;n+=4)j[n]=j[n]=+l[0],j[n+1]===255&&(j[n+1]=+l[1]),j[n+2]===255&&(j[n+2]=+l[2]);g.putImageData(h,0,0);a.markClusterImages[b[1]]=c;a.drawCanvas()}}):this._rendererOptions.markCluster.symbolSrc.forEach(function(b,c){var d=a._rendererOptions.markCluster.symbolSize[c][1],e=new Image;e.width=d;e.height=
d;e.src=b[1];e.onload=function(){a.markClusterImages[d]=e;a.drawCanvas()}})}},_initMarkPoint:function(){var a=this,b=this._rendererOptions.markPoint,c=b.itemStyle;this.MarkPoint=function(a,b,c,g){this.index=a;this.lon=b;this.lat=c;this.mercator=GeoGlobe.Util.transferToMercator([b,c]);this.attributes=g};this.MarkPoint.prototype.updateXY=function(){var b=a._parent.map.project([this.lon,this.lat]);this.x=this.ox=b.x;this.y=this.oy=b.y};this.MarkPoint.prototype.draw=function(d,e){d.save();d.shadowColor=
c.shadowColor;d.shadowBlur=c.shadowBlur;d.shadowOffsetX=c.shadowOffsetX;d.shadowOffsetY=c.shadowOffsetY;d.globalAlpha=e;d.translate(this.x,this.y);a.hoveredMarkPoint===this&&d.scale(1.1,1.1);switch(b.symbol){case "round":d.beginPath();d.arc(0,0,b.symbolSize/2,0,Math.PI*2,!0);d.fillStyle=a.hoveredMarkPoint===this?GeoGlobe.Util.getShadeColor(c.color,20):c.color;d.fill();if(c.lineWidth)d.lineWidth=c.lineWidth,d.strokeStyle=a.hoveredMarkPoint===this?GeoGlobe.Util.getShadeColor(c.lineColor,20):c.lineColor,
d.stroke();break;case "icon":d.drawImage(a.markPointImage,-b.symbolWidth/2,-b.symbolHeight/2,b.symbolWidth,b.symbolHeight)}d.restore()};this.MarkPoint.prototype.isPointInPath=function(c,e,f){c.beginPath();switch(b.symbol){case "round":c.arc(this.x,this.y,b.symbolSize/2,0,Math.PI*2,!0);break;case "icon":c.rect(this.x-b.symbolWidth/2,this.y-b.symbolHeight/2,b.symbolWidth,b.symbolHeight)}if(c.isPointInPath(e,f))a.hoveredMarkPoint=this}},_initMarkCluster:function(){var a=this,b=this._rendererOptions.markCluster,
c=b.itemStyle,d=b.label;this.MarkCluster=function(a,b,c,d,j){this.key=a;this.count=b;this.sumLonLat=c;this.children=d;this.parent=j};this.MarkCluster.prototype.init=function(){this.lon=this.sumLonLat[0]*1/this.count;this.lat=this.sumLonLat[1]*1/this.count;this.mercator=GeoGlobe.Util.transferToMercator([this.lon,this.lat]);var a=this;b.symbolSize.forEach(function(b){if(a.count>b[0])a.size=b[1]});c.color.forEach(function(b){if(a.count>b[0])a.color=b[1]});this.alpha=this.color.indexOf("a(")!==-1?+this.color.split(",")[3].split(")")[0]:
1;return this};this.MarkCluster.prototype.updateXY=function(){var b=a._parent.map.project([this.lon,this.lat]);this.x=this.ox=b.x;this.y=this.oy=b.y};this.MarkCluster.prototype.draw=function(e,f){e.save();e.shadowColor=c.shadowColor;e.shadowBlur=c.shadowBlur;e.shadowOffsetX=c.shadowOffsetX;e.shadowOffsetY=c.shadowOffsetY;e.globalAlpha=f*this.alpha;e.translate(this.x,this.y);a.hoveredMarkCluster===this&&e.scale(1.1,1.1);switch(b.symbol){case "round":e.beginPath();e.arc(0,0,this.size/2,0,Math.PI*2,
!0);e.fillStyle=a.hoveredMarkCluster===this?GeoGlobe.Util.getShadeColor(this.color,20):this.color;e.fill();if(c.lineWidth)e.lineWidth=c.lineWidth,e.strokeStyle=a.hoveredMarkCluster===this?GeoGlobe.Util.getShadeColor(c.lineColor,20):c.lineColor,e.stroke();break;case "icon":a.markClusterImages[this.size]&&e.drawImage(a.markClusterImages[this.size],-this.size/2,-this.size/2,this.size,this.size)}if(d.show)e.font=d.fontStyle+" "+d.fontWeight+" "+d.fontSize+"px "+d.fontFamily,e.textAlign=d.align,e.textBaseline=
d.baseline,e.fillStyle=d.color,e.fillText(this.count,0,0);e.restore()};this.MarkCluster.prototype.isPointInPath=function(c,d,g){c.beginPath();switch(b.symbol){case "round":c.arc(this.x,this.y,this.size/2,0,Math.PI*2,!0);break;case "icon":c.rect(this.x-this.size/2,this.y-this.size/2,this.size,this.size)}if(c.isPointInPath(d,g))a.hoveredMarkCluster=this}},render:function(){this._init_RendererOptions();this._initTooltip();this._initMarkPointImage();this._initMarkClusterImages();this._initMarkPoint();
this._initMarkCluster();this.setData(this.data);this.draw()},draw:function(){this.updateXY();this.drawCanvas();this.frame&&cancelAnimationFrame(this.frame);var a=this;(function c(){a.frame=requestAnimationFrame(c);if(a._animated&&(a._inout==="in"?(a._ratio+=0.08,a._ratio>1&&(a._ratio=1)):(a._ratio-=0.08,a._ratio<0&&(a._ratio=0)),a.energy=1-Math.cos(Math.PI/2*a._ratio),a.drawCanvasFrame(),a._ratio===0||a._ratio===1))a._animated=!1,a._inout=void 0,a._from=void 0,a._to=void 0})()},onZoomStart:function(){this._animated=
!1;this._from=this._parent.map.getZoom();if(this._from>this.markClusterMaxZoom){this._fromMarkPoints=[];for(var a=this._parent.getBounds(this._rendererOptions.markPoint.symbolHeight/2),b,c=this.markPoints,d=0,e=c.length;d<e;d++)b=c[d],b.lon>=a[0][0]&&b.lon<=a[1][0]&&b.lat>=a[0][1]&&b.lat<=a[1][1]&&this._fromMarkPoints.push(b)}else{this._fromMarkClusters=[];a=this._parent.getBounds(40);c=this.markClusterZoomMap[Math.floor(this._from)].markClusters;d=0;for(e=c.length;d<e;d++)b=c[d],b.lon>=a[0][0]&&
b.lon<=a[1][0]&&b.lat>=a[0][1]&&b.lat<=a[1][1]&&this._fromMarkClusters.push(b)}},onMove:function(){this.updateXY();this.drawCanvas()},onZoomEnd:function(){this._to=this._parent.map.getZoom();this._from&&Math.floor(this._from)!==Math.floor(this._to)?(this._from<this._to?(this._inout="in",this._ratio=0,this._from<=this.markClusterMaxZoom&&this.markClusterMaxZoom<this._to?(this._animated=!0,this._parentMarkClusterZoom=this.markClusterZoomMap[Math.floor(this._from)],this._childMarkClusterZoom=void 0):
this._to<=this.markClusterMaxZoom?(this._animated=!0,this._parentMarkClusterZoom=this.markClusterZoomMap[Math.floor(this._from)],this._childMarkClusterZoom=this.markClusterZoomMap[Math.floor(this._to)]):(this._animated=!1,this._to=this._from=void 0)):(this._inout="out",this._ratio=1,this._from>this.markClusterMaxZoom&&this.markClusterMaxZoom>=this._to?(this._animated=!0,this._parentMarkClusterZoom=this.markClusterZoomMap[Math.floor(this._to)],this._childMarkClusterZoom=void 0):this._from<=this.markClusterMaxZoom?
(this._animated=!0,this._parentMarkClusterZoom=this.markClusterZoomMap[Math.floor(this._to)],this._childMarkClusterZoom=this.markClusterZoomMap[Math.floor(this._from)]):(this._animated=!1,this._to=this._from=void 0)),this._parentMarkClusters=this._parentMarkClusterZoom?this._parentMarkClusterZoom.markClusters:[],this._childMarkClusters=this._childMarkClusterZoom?this._childMarkClusterZoom.markClusters:[]):(this._animated=!1,this._to=this._from=void 0)},onMoveEnd:function(){this.redraw()},onClick:function(a){this._parent.map.getZoom()>
this.markClusterMaxZoom?this.visibility&&this._rendererOptions.markPoint.clickable&&this.hoveredMarkPoint&&this._parent.fire("overlayerclick",{layer:this,feature:this.hoveredMarkPoint,event:a}):this.visibility&&this._rendererOptions.markCluster.clickable&&(this.hoveredMarkCluster||this.hoveredMarkPoint)&&this._parent.fire("overlayerclick",{layer:this,feature:this.hoveredMarkCluster?this.hoveredMarkCluster:this.hoveredMarkPoint,event:a})},onMouseMove:function(a){var b=this._parent.map.getZoom();b>
this.markClusterMaxZoom?this.visibility&&this._rendererOptions.markPoint.hoverable&&this.markPoints.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),this.hoveredMarkPoint&&this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkPoint,event:a})):this.visibility&&this._rendererOptions.markCluster.hoverable&&this.markClusterZoomMap[Math.floor(b)].markClusters.length>0&&!this._parent.map.moving&&(this.hover(a.point.x,a.point.y),(this.hoveredMarkCluster||this.hoveredMarkPoint)&&
this._parent.fire("overlayerhover",{layer:this,feature:this.hoveredMarkCluster?this.hoveredMarkCluster:this.hoveredMarkPoint,event:a}))},onResize:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this.clearCanvas();this.updateXY();this.drawCanvas()},updateXY:function(){var a=this._parent.map.getZoom();this._from===void 0?
a>this.markClusterMaxZoom?this.updateMarkPointXY():this.updateMarkClusterXY(a):this._to===void 0?this._from>this.markClusterMaxZoom?this.updateMarkPointXY():this.updateMarkClusterXY(this._from):this._to>this.markClusterMaxZoom?this.updateMarkPointXY():this.updateMarkClusterXY(this._to)},updateMarkPointXY:function(){for(var a=this._parent.getBounds(this._rendererOptions.markPoint.symbolHeight/2),b,c=this.markPoints,d=0,e=c.length;d<e;d++)b=c[d],b.lon>=a[0][0]&&b.lon<=a[1][0]&&b.lat>=a[0][1]&&b.lat<=
a[1][1]?(b.visible=!0,b.updateXY()):b.visible=!1},updateMarkClusterXY:function(a){for(var b=this._parent.getBounds(40),c=this.markClusterZoomMap[Math.floor(a)].markClusters,d=0,e=c.length;d<e;d++)a=c[d],a.lon>=b[0][0]&&a.lon<=b[1][0]&&a.lat>=b[0][1]&&a.lat<=b[1][1]?(a.visible=!0,a.updateXY()):a.visible=!1},drawCanvas:function(){this.cacheCanvas[0].width=this.width;var a=this._from!==void 0?this._from:this._parent.map.getZoom();if(a>this.markClusterMaxZoom)for(var b,c=this._from!==void 0?this._fromMarkPoints:
this.markPoints,a=0,d=c.length;a<d;a++)b=c[a],b.visible&&b.draw(this.cacheCanvasContext[0],1);else{c=this._from!==void 0?this._fromMarkClusters:this.markClusterZoomMap[Math.floor(a)].markClusters;a=0;for(d=c.length;a<d;a++)if(b=c[a],b.visible)b.children.length>1?b.draw(this.cacheCanvasContext[0],1):(b.children[0].x=b.x,b.children[0].y=b.y,b.children[0].draw(this.cacheCanvasContext[0],1))}this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},drawCanvasFrame:function(){this.cacheCanvas[0].width=
this.width;for(var a,b=this._parentMarkClusters,c=0,d=b.length;c<d;c++)if(a=b[c],a.visible)a.children.length>1?a.draw(this.cacheCanvasContext[0],1-this.energy):(a.children[0].x=a.x,a.children[0].y=a.y,a.children[0].draw(this.cacheCanvasContext[0],1-this.energy));if(this._childMarkClusterZoom){var c=this._parentMarkClusterZoom.zoom,b=this._parent.map.getResolutions()[c]*80,e=a=void 0;a=void 0;for(var f,g=this._childMarkClusters,c=0,d=g.length;c<d;c++)if(f=g[c],(this._inout==="in"||this._inout==="out"&&
this._fromMarkClusters.includes(f))&&f.visible)if(a=Math.floor((f.mercator[0]-this._markPointSWMercator[0])/b),e=Math.floor((f.mercator[1]-this._markPointSWMercator[1])/b),a=a+"_"+e,a=this._parentMarkClusterZoom.markClustersMap[a]){if(a.visible)f.x=a.x+(f.ox-a.x)*this.energy,f.y=a.y+(f.oy-a.y)*this.energy;f.children.length>1?f.draw(this.cacheCanvasContext[0],this.energy):(f.children[0].x=f.x,f.children[0].y=f.y,f.children[0].draw(this.cacheCanvasContext[0],this.energy))}}else{c=0;for(g=b.length;c<
g;c++){a=b[c];f=a.children;for(var e=0,h=f.length;e<h;e++)if(d=f[e],(this._inout==="in"||this._inout==="out"&&this._fromMarkPoints.includes(d))&&d.visible){if(a.visible)d.x=a.x+(d.ox-a.x)*this.energy,d.y=a.y+(d.oy-a.y)*this.energy;d.draw(this.cacheCanvasContext[0],this.energy)}}}this.canvas[0].width=this.width;this.canvasContext[0].drawImage(this.cacheCanvas[0],0,0)},clearCanvas:function(){this.canvas[0].width=this.cacheCanvas[0].width=this.width},stopDraw:function(){cancelAnimationFrame(this.frame);
this.clearCanvas()},destroy:function(){this.stopDraw();this._parent.container.removeChild(this.div);this._parent=null;this.canvas=[];this.cacheCanvas=[];this.canvasContext=[];this.cacheCanvasContext=[];this.MarkCluster=this.MarkPoint=null;this.markPoints=[];this.markClusterZoomMap=[]},hover:function(a,b){this.hoveredMarkCluster=this.hoveredMarkPoint=null;var c=this._parent.map.getZoom();if(c>this.markClusterMaxZoom)for(var d=0,e=this.markPoints.length;d<e;d++)c=this.markPoints[d],!this.hoveredMarkPoint&&
c.visible&&c.isPointInPath(this.cacheCanvasContext[0],a,b);else for(var d=0,e=this.markClusterZoomMap[Math.floor(c)].markClusters.length,f;d<e;d++)f=this.markClusterZoomMap[Math.floor(c)].markClusters[d],!this.hoveredMarkCluster&&f.visible&&(f.children.length>1?f.isPointInPath(this.cacheCanvasContext[0],a,b):f.children[0].isPointInPath(this.cacheCanvasContext[0],a,b));this.drawCanvas();this.hoveredMarkPoint||this.hoveredMarkCluster?(this.canvas[0].style.cursor="pointer",this.hoveredMarkPoint?this.showTooltip(this.hoveredMarkPoint.attributes[this._rendererOptions.markPoint.nameField],
a,b):this.hideTooltip()):(this.canvas[0].style.cursor="grab",this.hideTooltip())},showTooltip:function(a,b,c){if(this._rendererOptions.tooltip.show)this.tooltipDiv.textContent=a,this.tooltipDiv.style.top=c-15+"px",this.tooltipDiv.style.left=b+15+"px",this.tooltipDiv.style.display="block"},hideTooltip:function(){if(this._rendererOptions.tooltip.show)this.tooltipDiv.style.display="none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=
this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none";a?this.draw():this.stopDraw()},setData:function(a){this.data=a;this.hoveredMarkCluster=this.hoveredMarkPoint=null;this.markPoints=[];for(var b=0;b<a.length;b++)this.markPoints.push(new this.MarkPoint(b,a[b].geometry.coordinates[0],a[b].geometry.coordinates[1],
a[b].properties));var c=Number.MAX_VALUE,d=Number.MAX_VALUE;this.markPoints.forEach(function(a){c=Math.min(c,a.lon);d=Math.min(d,a.lat)});this._markPointSWMercator=GeoGlobe.Util.transferToMercator([c,d]);var e=this;this.markClusterZoomMap=[];for(var f=this._parent.map.getMinZoom(),a=this.markClusterMaxZoom<this._parent.map.getMaxZoom()?this.markClusterMaxZoom:this._parent.map.getMaxZoom(),b=f;b<=a;b++){var g={},h=this._parent.map.getResolutions()[b]*80,j=this._parent.map.getResolutions()[b-1]*80,
l=void 0,n=void 0,o=void 0,q=void 0,r=void 0,m=void 0;this.markPoints.forEach(function(a){l=Math.floor((a.mercator[0]-e._markPointSWMercator[0])/h);n=Math.floor((a.mercator[1]-e._markPointSWMercator[1])/h);o=l+"_"+n;if(g[o])g[o].count++,g[o].sumLonLat[0]+=a.lon,g[o].sumLonLat[1]+=a.lat,g[o].children.push(a);else if(g[o]={key:o,count:1,sumLonLat:[a.lon,a.lat],children:[a]},b>f)q=Math.floor((a.mercator[0]-e._markPointSWMercator[0])/j),r=Math.floor((a.mercator[1]-e._markPointSWMercator[1])/j),m=q+"_"+
r,g[o].parent=e.markClusterZoomMap[b-1].markClustersMap[m]});for(o in g)g[o]=new this.MarkCluster(o,g[o].count,g[o].sumLonLat,g[o].children,g[o].parent);var p=this._mergeMarkClusters(g,h/2);this.markClusterZoomMap[b]={};this.markClusterZoomMap[b].zoom=b;this.markClusterZoomMap[b].markClusters=[];this.markClusterZoomMap[b].markClustersMap=p.markClustersMap;for(o in p.markClusters)this.markClusterZoomMap[b].markClusters.push(p.markClusters[o].init())}},_mergeMarkClusters:function(a,b){var c={},d;for(d in a)c[d]=
a[d];var e={},f={},g=void 0,h=void 0;for(d in a)if(g=a[d],!f[d])for(var h=d.split("_"),j=+h[0],l=+h[1],n=-1;n<=1;n++)for(var o=-1;o<=1;o++)if(!(n===0&&o===0)){var q=j+n+"_"+(l+o);if(h=a[q]){var r=GeoGlobe.Util.transferToMercator([g.sumLonLat[0]/g.count,g.sumLonLat[1]/g.count]),m=GeoGlobe.Util.transferToMercator([h.sumLonLat[0]/h.count,h.sumLonLat[1]/h.count]),p=r[0]-m[0],r=r[1]-m[1];Math.sqrt(p*p+r*r)<=b&&(e[d]=e[d]||[],e[d].push(h),f[q]=1)}}for(var t in e)if(d=a[t]){f=e[t];for(g=0;g<f.length;g++)if(a[f[g].key])d.count+=
f[g].count,d.sumLonLat[0]+=f[g].sumLonLat[0],d.sumLonLat[1]+=f[g].sumLonLat[1],d.children=d.children.concat(f[g].children),c[f[g].key]=d,delete a[f[g].key]}return{markClusters:a,markClustersMap:c}}});
GeoGlobe.Visuals.Custom.Wind=GeoGlobe.Class4OL({_parent:null,canvas:null,canvasContext:null,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initCanvas()},_initCanvas:function(){this.canvas=document.createElement("canvas");this.canvasContext=this.canvas.getContext("2d")},_init_RendererOptions:function(){this._rendererOptions=GeoGlobe.Util.deepExtend({velocityScale:0.011,particleMultiplier:0.002,maxWindIntensity:30,lineWidth:2,opacity:0.6,colors:["#00ffff","#64f0ff","#87e1ff",
"#a0d0ff","#b5c0ff","#c6adff","#d49bff","#e185ff","#ec6dff","#ff1edb"]},{},this.rendererOptions)},_initWindy:function(){var a=this;this.Windy=function(){var b=a._rendererOptions.velocityScale,c=a._rendererOptions.maxWindIntensity,d=100,e=a._rendererOptions.lineWidth,f=a._rendererOptions.particleMultiplier,g=a._rendererOptions.opacity,h=a._rendererOptions.colors,j=[NaN,NaN,null],l=2*Math.PI,n=Math.pow(10,-5.2),o=function(a,b,c,d,e,f){var g=1-a,h=1-b,j=g*h;h*=a;g*=b;b*=a;a=c[0]*j+d[0]*h+e[0]*g+f[0]*
b;c=c[1]*j+d[1]*h+e[1]*g+f[1]*b;return[a,c,Math.sqrt(a*a+c*c)]},q=function(a,b){var c=a.data,d=b.data;return{header:a.header,data:function(a){return[c[a],d[a]]},interpolate:o}},r=function(a){var b=null,c=null;a.forEach(function(a){switch(a.header.parameterCategory+","+a.header.parameterNumber){case "2,2":b=a;break;case "2,3":c=a}});return q(b,c)},m=function(a){return a!==null&&a!==void 0},p=function(a,b,c){function d(b,c){var e=a[Math.round(b)];return e&&e[Math.round(c)]||j}d.release=function(){a=
[]};d.randomize=function(a){var c,e,f=0;do c=Math.round(Math.floor(Math.random()*b.width)+b.x),e=Math.round(Math.floor(Math.random()*b.height)+b.y);while(d(c,e)[2]===null&&f++<30);a.x=c;a.y=e;return a};c(b,d)},t=function(a,b,c){var d=a[0];return{x:Math.round(d[0]),y:Math.max(Math.floor(d[1],0),0),xMax:b,yMax:Math.min(Math.ceil(a[1][1],c),c-1),width:b,height:c}},s=function(a){return Math.log(Math.tan(a/2+Math.PI/4))},u=function(a,b,c){var d=s(c.south),e=s(c.north),f=c.width/(c.east-c.west),d=c.height/
(e-d),a=s(a/180*Math.PI),b=(b/180*Math.PI-c.west)*f;return[b,(e-a)*d]},v=function(a,c,d){var e=[],f=a.x;(function D(){for(var g=Date.now();f<a.width;){for(var h=f,j=[],m=a.y;m<=a.yMax;m+=2){var o;o=c.east-c.west;var q=c.width/(o/(Math.PI/180))*360/(2*Math.PI);o=[c.west/(Math.PI/180)+h/c.width*(o/(Math.PI/180)),180/Math.PI*(2*Math.atan(Math.exp((c.height+q/2*Math.log((1+Math.sin(c.south))/(1-Math.sin(c.south)))-m)/q))-Math.PI/2)];var r=o[0],s=o[1];if(isFinite(r)&&(o=C(r,s))){var q=o[0]*b,t=o[1]*b,
v=r,w=s,r=h,s=m,x=c,A=v<0?n:-n,H=w<0?n:-n,I=u(w,v+A,x),v=u(w+H,v,x),w=Math.cos(w/360*l),r=[(I[0]-r)/A/w,(I[1]-s)/A/w,(v[0]-r)/H,(v[1]-s)/H];o[0]=r[0]*q+r[2]*t;o[1]=r[1]*q+r[3]*t;j[m+1]=j[m]=o}}e[h+1]=e[h]=j;f+=2;if(Date.now()-g>1E3){setTimeout(D,25);return}}p(e,a,d)})()},w=function(b,j){function l(a){return a.charAt(0)=="#"?a.substring(1,7):a}function m(){p.forEach(function(a){a.length=0});r.forEach(function(a){if(a.age>d)j.randomize(a).age=0;var b=a.x,c=a.y,e=j(b,c),f=e[2];f===null?a.age=d:(b+=e[0],
c+=e[1],j(b,c)[2]!==null?(a.xt=b,a.yt=c,p[o.indexFor(f)].push(a)):(a.x=b,a.y=c));a.age+=1})}function n(){var a=t.globalCompositeOperation;t.globalCompositeOperation="destination-in";t.fillRect(b.x,b.y,b.width,b.height);t.globalCompositeOperation=a;p.forEach(function(a,b){if(a.length>0)t.beginPath(),t.strokeStyle=o[b],a.forEach(function(a){t.moveTo(a.x,a.y);t.lineTo(a.xt,a.yt);a.x=a.xt;a.y=a.yt}),t.stroke()})}var o=function(a,b){var c=[];h.forEach(function(a){c.push("rgba("+parseInt(l(a).substring(0,
2),16)+", "+parseInt(l(a).substring(2,4),16)+", "+parseInt(l(a).substring(4,6),16)+", "+g+")")});c.indexFor=function(a){return Math.floor(Math.min(a,b)/b*(c.length-1))};return c}(10,c),p=o.map(function(){return[]}),q=Math.round(b.width*b.height*f);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(q*=0.075);for(var r=[],s=0;s<q;s++)r.push(j.randomize({age:Math.floor(Math.random()*d)+0}));var t=a.canvasContext;t.lineWidth=e;t.fillStyle="rgba(0, 0, 0, 0.97)";
(function J(){try{A.timer=setTimeout(function(){requestAnimationFrame(J);m();n()},50)}catch(a){console.error(a)}})()},x=function(){A.field&&A.field.release();A.timer&&clearTimeout(A.timer)},C=function(a){var b=r(a),c=b.header,d=c.lo1,e=c.la1,f=c.dx,g=c.dy,a=c.nx,h=c.ny,j=new Date(c.refTime);j.setHours(j.getHours()+c.forecastTime);for(var l=[],c=0,j=Math.floor(a*f)>=360,n=0;n<h;n++){for(var o=[],p=0;p<a;p++,c++)o[p]=b.data(c);j&&o.push(o[0]);l[n]=o}return function(a,c){var h=(a-d-360*Math.floor((a-
d)/360))/f,j=(e-c)/g,n=Math.floor(h),o=n+1,p=Math.floor(j),q=p+1,r;if(r=l[p]){var t=r[n],s=r[o];if(m(t)&&m(s)&&(r=l[q]))if(q=r[n],o=r[o],m(q)&&m(o))return b.interpolate(h-n,j-p,t,s,q,o)}return null}}(a.data),A={start:function(a,b,c,d){d={south:d[0][1]/180*Math.PI,north:d[1][1]/180*Math.PI,east:d[1][0]/180*Math.PI,west:d[0][0]/180*Math.PI,width:b,height:c};x();v(t(a,b,c),d,function(a,b){A.field=b;w(a,b)})},stop:x};return A}},render:function(){this._init_RendererOptions();this._initWindy();this.setData(this.data);
this.setVisible(this.visibility)},draw:function(){setTimeout(function(){this.windy.start([[0,0],this.size],this.size[0],this.size[1],this.bounds)}.bind(this),1)},onMove:function(){this.stopDraw()},onMoveEnd:function(){this.redraw()},onResize:function(){this.width=this._parent.map.transform.width;this.height=this._parent.map.transform.height;this.redraw()},redraw:function(){this._calculateBoundsAndSize();this.canvas.width=Math.round(this.size[0]);this.canvas.height=Math.round(this.size[1]);this.source.setCoordinates([[this.bounds[0][0],
this.bounds[1][1]],this.bounds[1],[this.bounds[1][0],this.bounds[0][1]],this.bounds[0]]);this.draw()},_calculateBoundsAndSize:function(){this.bounds=this._parent.getBounds();var a=this._parent.map.transform.locationCoordinate({lng:this.bounds[0][0],lat:this.bounds[0][1]}),b=this._parent.map.transform.locationCoordinate({lng:this.bounds[1][0],lat:this.bounds[1][1]});this.size=[Math.abs(a.column-b.column)*this._parent.map.transform.tileSize,Math.abs(a.row-b.row)*this._parent.map.transform.tileSize]},
clearCanvas:function(){this.canvasContext.clearRect(0,0,this.canvas.width,this.canvas.height)},stopDraw:function(){this.clearCanvas();this.windy.stop()},destroy:function(){this.stopDraw();this.Windy=this.windy=this.canvasContext=this.canvas=this._parent=null},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._calculateBoundsAndSize();this.canvas.width=Math.round(this.size[0]);this.canvas.height=Math.round(this.size[1]);this._parent.map.addSource(this.id+"_source",{type:"canvas",canvas:this.canvas,
animate:!0,coordinates:[[this.bounds[0][0],this.bounds[1][1]],this.bounds[1],[this.bounds[1][0],this.bounds[0][1]],this.bounds[0]]});this._parent.map.addLayer({type:"raster",id:this.id+"_layer",source:this.id+"_source"});this.source=this._parent.map.getSource(this.id+"_source");this.layer=this._parent.map.getLayer(this.id+"_layer");this.width=this._parent.map.transform.width;this.height=this._parent.map.transform.height},setVisible:function(a){this.visibility=a;this._parent.map.setLayoutProperty(this.id+
"_layer","visibility",a?"visible":"none");a?this.draw():this.stopDraw()},setData:function(a){this.data=a;this.windy=new this.Windy}});
GeoGlobe.Visuals.Grid=GeoGlobe.Class4OL(GeoGlobe.Visuals,{type:"grid",map:null,container:null,layers:[],initialize:function(){GeoGlobe.Visuals.prototype.initialize.apply(this,arguments);this.layers=[]},addTo:function(){GeoGlobe.Visuals.prototype.addTo.apply(this,arguments);this.container.className="geoglobe-Grid-container"},render:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].render()},addLayer:function(a){a.id?this.map.getLayer(a.id)?console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u91cd\u590d\uff01"):
this.layers.push(a):console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u4e3a\u7a7a\uff01")},removeLayer:function(a){for(var b=[],c=0;c<this.layers.length;c++)a!==this.layers[c].id&&b.push(this.layers[c]);this.layers=b},moveLayer:function(a,b){this._order=this.layers.map(function(a){return a.id});this._order.splice(this._order.indexOf(a),1);this._order.splice(b?this._order.indexOf(b):this._order.length,0,a);for(var c=0;c<this._order.length;c++)for(var d=0;d<this.layers.length;d++)if(this._order[c]===
this.layers[d].id)this.layers[d].div.style.zIndex=c},getLayer:function(a){for(var b=0;b<this.layers.length;b++)if(a===this.layers[b].id)return this.layers[b]}});
GeoGlobe.Visuals.Grid.Typhoon=GeoGlobe.Class4OL(GeoGlobe.Visuals,{_parent:null,canvas:[],canvasContext:[],initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this._initContainer();this._initCanvas()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute")},initParticles:function(){var a=this;this.Particle=function(a,c,d){this.x=a;this.y=c;this.oldY=this.oldX=-1;this.age=d;this.opacity=1};
this.Particle.prototype.updateXY=function(b,c,d){c=a._parent.map.project([this.x,this.y]);b=c.x;c=c.y;if(d)return d.x=b,d.y=c,d;return new a.Vector(b,c)}},_initCanvas:function(){this.canvas=[];this.canvasContext=[];this.canvas.push(document.createElement("canvas"));this.canvasContext.push(this.canvas[0].getContext("2d"));this.cacheCanvas=[];this.cacheCanvasContext=[];this.cacheCanvas.push(document.createElement("canvas"));this.cacheCanvasContext.push(this.cacheCanvas[0].getContext("2d"));this.canvas[0].style.position=
"absolute";this.div.appendChild(this.canvas[0]);this.setVisible(this.visibility)},setVisible:function(a){this.visibility=a;this.canvas[0].style.display=a?"block":"none"},render:function(){this.particles=[];this.initParticles();this.setData(this.data);var a,b=this;(function d(){requestAnimationFrame(d);if(b._parent.map.moving||b.RELOADED||b.RESIZE){a=b.particles.length;for(var e=new b.Vector(0,0);a--;)b.particles[a].updateXY(b.particles[a].x,b.particles[a].y,e);b.canvas[0].width=b.width;b.RELOADED&&
(b.RELOADED=!1);b.RESIZE&&(b.RESIZE=!1)}b.moveThings();b.draw()})();this.RENDERED=!0},moveThings:function(){for(var a=this.particles,b=0;b<a.length;b++)if(a[b].age>0&&this.inBounds(a[b].x,a[b].y)){var c=this.getValue(a[b].x,a[b].y);a[b].x+=0.01*c.x;a[b].y+=0.01*c.y;a[b].age--}else a[b]=this.makeParticle()},draw:function(){this.colors=[];this.rgb="0, 0, 0";this.background="rgb("+this.rgb+")";this.backgroundAlpha="rgba("+this.rgb+", .02)";var a=this.particles;this.canvasContext[0].globalCompositeOperation=
"destination-out";this.first?(this.canvasContext[0].fillStyle=this.background,this.first=!1):this.canvasContext[0].fillStyle=this.backgroundAlpha;this.canvasContext[0].fillRect(0,0,this.canvas[0].width,this.canvas[0].height);this.canvasContext[0].globalCompositeOperation="source-over";this.canvasContext[0].lineWidth=this.options.lineWidth||1;this.canvasContext[0].strokeStyle=this.options.lineColor||"rgba(138,43,226,1)";for(var b=new this.Vector(0,0),c=0;c<a.length;c++){var d=this.particles[c];this.particles[c].updateXY(d.x,
d.y,b);d.oldX!=-1&&(this.canvasContext[0].beginPath(),this.canvasContext[0].moveTo(b.x,b.y),this.canvasContext[0].lineTo(d.oldX,d.oldY),this.canvasContext[0].stroke());d.oldX=b.x;d.oldY=b.y}},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div);this.canvas[0].width=this.cacheCanvas[0].width=this.width=this._parent.map.transform.width;this.canvas[0].height=this.cacheCanvas[0].height=this.height=this._parent.map.transform.height},setData:function(a){this.data=
a;var b=this;this.inBounds=function(a,b){return a>=this.field.x0&&a<this.field.x1&&b>=this.field.y0&&b<this.field.y1};this.bilinear=function(a,b,c){var d=Math.floor(b),e=Math.floor(c),f=Math.ceil(b),g=Math.ceil(c);b-=d;c-=e;return this.Data[d][e][a]*(1-b)*(1-c)+this.Data[f][e][a]*b*(1-c)+this.Data[d][g][a]*(1-b)*c+this.Data[f][g][a]*b*c};this.getValue=function(a,c){var d=(this.field.gridWidth-1-1.0E-6)*(a-this.field.x0)/(this.field.x1-this.field.x0),e=(this.field.gridHeight-1-1.0E-6)*(c-this.field.y0)/
(this.field.y1-this.field.y0),f=this.bilinear("x",d,e),d=this.bilinear("y",d,e);return new b.Vector(f,d)};this.Vector=function(a,b){this.x=a;this.y=b};this.Vector.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};this.makeParticle=function(){var a=Math.random(),b=Math.random();return new this.Particle(a*this.field.x0+(1-a)*this.field.x1,b*this.field.y0+(1-b)*this.field.y1,1+40*Math.random())};for(var c=[],d=a.gridWidth,e=a.gridHeight,f=0,g=0;g<d;g++){c[g]=[];for(var h=0;h<
e;h++){var j=a.field[f++],l=a.field[f++],j=new this.Vector(j,l);c[g][h]=j}}this.field=a;this.numParticles=5E3;for(f=0;f<this.numParticles;f++)this.particles.push(this.makeParticle());this.Data=c}});
GeoGlobe.Visuals.MapV=GeoGlobe.Class4OL(GeoGlobe.Visuals,{type:"mapv",map:null,container:null,layers:[],initialize:function(){GeoGlobe.Visuals.prototype.initialize.apply(this,arguments);this.layers=[];window.mapv||console.error("\u4f7f\u7528MapV\u53ef\u89c6\u5316\u56fe\u5c42\u524d\uff0c\u9700\u5f15\u5165mapv\u5e93\uff01")},addTo:function(){GeoGlobe.Visuals.prototype.addTo.apply(this,arguments);this.container.className="geoglobe-mapv-container"},render:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].render()},
addLayer:function(a){a.id?this.map.getLayer(a.id)?console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u91cd\u590d\uff01"):this.layers.push(a):console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u4e3a\u7a7a\uff01")},removeLayer:function(a){for(var b=[],c=0;c<this.layers.length;c++)a===this.layers[c].id?this.layers[c].destroy&&this.layers[c].destroy():b.push(this.layers[c]);this.layers=b},moveLayer:function(a,b){this._order=this.layers.map(function(a){return a.id});this._order.splice(this._order.indexOf(a),
1);this._order.splice(b?this._order.indexOf(b):this._order.length,0,a);for(var c=0;c<this._order.length;c++)for(var d=0;d<this.layers.length;d++)if(this._order[c]===this.layers[d].id)this.layers[d].div.style.zIndex=c},getLayer:function(a){for(var b=0;b<this.layers.length;b++)if(a===this.layers[b].id)return this.layers[b]}});
GeoGlobe.Visuals.MapV.Bubble=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="bubble";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.Category=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="category";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.Choropleth=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="choropleth";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.Grid=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="grid";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.HeatMap=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="heatmap";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.HoneyComb=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="honeycomb";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.Icon=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this,b=this._parent.map,c=new mapv.DataSet(this.data),d=this.rendererOptions,e=new Image;e.src=this.icon;e.onload=function(){d.icon=e;d.draw="icon";d.dragdrawing=a.dragdrawing;d.container=a.div;a._layer&&a.div.removeChild(a._layer.canvasLayer.canvas);a._layer=new mapv.mapboxGLMapLayer(b,c,d)}},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=
[]},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.Intensity=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="intensity";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.Simple=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this,b=this._parent.map,c=new mapv.DataSet(this.data),d=this.rendererOptions;d.draw="simple";d.dragdrawing=this.dragdrawing;d.container=this.div;d.methods={};d.methods.click=function(b,c){b&&a._parent.fire("overlayerclick",{layer:a,feature:b,event:c})};d.methods.mousemove=function(b,c){b&&a._parent.fire("overlayerhover",{layer:a,feature:b,event:c})};this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=
new mapv.mapboxGLMapLayer(b,c,d)},destroy:function(){this._parent.container.removeChild(this.div);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.MapV.Text=GeoGlobe.Class4OL({_parent:null,visibility:!0,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data);this._initContainer()},_initContainer:function(){this.div=document.createElement("div");this.div.setAttribute("id",this.id);this.div.setAttribute("style","position:absolute");this.div.style.display=this.visibility?"block":"none"},addTo:function(a){this._parent=a;this._parent.addLayer(this);this._parent.container.appendChild(this.div)},
remove:function(){this._parent.removeLayer(this.id)},render:function(){var a=this._parent.map,b=new mapv.DataSet(this.data),c=this.rendererOptions;c.draw="text";c.dragdrawing=this.dragdrawing;c.container=this.div;this._layer&&this.div.removeChild(this._layer.canvasLayer.canvas);this._layer=new mapv.mapboxGLMapLayer(a,b,c)},destroy:function(){this._parent.container.removeChild(this._layer.canvasLayer.canvas);this.rendererOptions=this.options=this._layer=this._parent=null;this.data=[]},setVisible:function(a){this.visibility=
a;this.div.style.display=a?"block":"none"},setData:function(a){this.data=a.map(function(a){return GeoGlobe.Util.extend(a.properties,{geometry:a.geometry})})}});
GeoGlobe.Visuals.DeckGL=GeoGlobe.Class4OL(GeoGlobe.Visuals,{type:"deckgl",map:null,container:null,layers:[],_deckgl:null,initialize:function(){GeoGlobe.Visuals.prototype.initialize.apply(this,arguments);this.layers=[];window.deck||console.error("\u4f7f\u7528DeckGL\u53ef\u89c6\u5316\u56fe\u5c42\u524d\uff0c\u9700\u5f15\u5165deckgl\u5e93\uff01")},addTo:function(){GeoGlobe.Visuals.prototype.addTo.apply(this,arguments);this.container.className="geoglobe-deckgl-container";var a=this;this._deckgl=new deck.DeckGL({container:this.container,
geoMap:this.map,onWebGLInitialized:function(b){a.fire("overlayerinit",{param:b})},onLayerClick:function(b,c,d){a.fire("overlayerclick",{param:{info:b,pickedInfos:c,event:d}})},onLayerHover:function(b,c,d){a.fire("overlayerhover",{param:{info:b,pickedInfos:c,event:d}})},layers:[]})},render:function(){var a=[];if(this._order)for(var b=0;b<this._order.length;b++)for(var c=0;c<this.layers.length;c++)this.layers[c].id===this._order[b]&&a.push(this.layers[c].getInnerLayer());else for(c=0;c<this.layers.length;c++)a.push(this.layers[c].getInnerLayer());
this._deckgl.props.layers=a;this._deckgl.setProps()},addLayer:function(a){a.id?this.map.getLayer(a.id)?console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u91cd\u590d\uff01"):this.layers.push(a):console.error("\u56fe\u5c42id\u5c5e\u6027\u4e0d\u80fd\u4e3a\u7a7a\uff01")},removeLayer:function(a){for(var b=[],c=0;c<this.layers.length;c++)a!==this.layers[c].id&&b.push(this.layers[c]);this.layers=b},moveLayer:function(a,b){this._order=this.layers.map(function(a){return a.id});this._order.splice(this._order.indexOf(a),
1);this._order.splice(b?this._order.indexOf(b):this._order.length,0,a);this.render()},getLayer:function(a){for(var b=0;b<this.layers.length;b++)if(a===this.layers[b].id)return this.layers[b]}});
GeoGlobe.Visuals.DeckGL.HexagonLayer=GeoGlobe.Class4OL({id:"1",name:"",visible:!0,pickable:!0,fp64:!1,opacity:1,data:[],colorDomain:null,colorRange:[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]],lowerPercentile:0,upperPercentile:100,elevationDomain:null,elevationRange:[0,1E3],elevationLowerPercentile:0,elevationUpperPercentile:100,elevationScale:1,radius:1E3,coverage:1,extruded:!1,lightSettings:{},getPosition:function(a){return a.geometry.type==="Point"?a.geometry.coordinates:
null},getColorValue:function(a){return a.length},getElevationValue:function(a){return a.length},onSetColorDomain:function(){},onSetElevationDomain:function(){},_parent:null,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a)},addTo:function(a){this._parent=a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getInnerLayer:function(){var a={};GeoGlobe.Util.extend(a,this);return new deck.HexagonLayer(a)}});
GeoGlobe.Visuals.DeckGL.ScatterplotLayer=GeoGlobe.Class4OL({id:"1",name:"",visible:!0,pickable:!0,fp64:!1,opacity:1,data:[],radiusScale:1,outline:!1,strokeWidth:1,radiusMinPixels:0,radiusMaxPixels:Number.MAX_SAFE_INTEGER,getPosition:function(a){return a.geometry.type==="Point"?a.geometry.coordinates:null},getColor:function(a){return a.color||[0,0,0,255]},getRadius:function(a){return a.radius||1},_parent:null,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a)},addTo:function(a){this._parent=
a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getInnerLayer:function(){var a={};GeoGlobe.Util.extend(a,this);return new deck.ScatterplotLayer(a)}});
GeoGlobe.Visuals.DeckGL.GeoJsonLayer=GeoGlobe.Class4OL({id:"1",name:"",visible:!0,pickable:!0,fp64:!1,data:[],filled:!0,stroked:!1,extruded:!1,wireframe:!1,lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,elevationScale:1,pointRadiusScale:1,pointRadiusMinPixels:0,pointRadiusMaxPixels:Number.MAX_SAFE_INTEGER,lightSettings:{},getLineColor:function(a){return a.properties.lineColor||[0,0,0,255]},getFillColor:function(a){return a.properties.fillColor||
[0,0,0,255]},getRadius:function(a){return a.properties.radius||a.properties.size||1},getLineWidth:function(a){return a.properties.lineWidth||1},getElevation:function(a){return a.properties.elevation||1E3},_parent:null,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a)},addTo:function(a){this._parent=a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getInnerLayer:function(){var a={};GeoGlobe.Util.extend(a,this);
return new deck.GeoJsonLayer(a)}});
GeoGlobe.Visuals.DeckGL.PolygonLayer=GeoGlobe.Class4OL({id:"1",name:"",visible:!0,pickable:!0,fp64:!1,data:[],filled:!0,stroked:!1,extruded:!1,wireframe:!1,lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,elevationScale:1,lightSettings:{},getPolygon:function(a){return a.geometry.type==="Polygon"?a.geometry.coordinates:null},getLineColor:function(a){return a.properties.lineColor||[0,0,0,255]},getFillColor:function(a){return a.properties.fillColor||[0,
0,0,255]},getLineWidth:function(a){return a.properties.lineWidth||1},getElevation:function(a){return a.properties.elevation||1E3},_parent:null,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a)},addTo:function(a){this._parent=a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getInnerLayer:function(){var a={};GeoGlobe.Util.extend(a,this);return new deck.PolygonLayer(a)}});
GeoGlobe.Visuals.DeckGL.LineLayer=GeoGlobe.Class4OL({id:"1",name:"",visible:!0,pickable:!0,fp64:!1,data:[],getSourcePosition:function(a){return a.geometry.type==="LineString"?a.geometry.coordinates[0]:null},getTargetPosition:function(a){return a.geometry.type==="LineString"?a.geometry.coordinates[1]:null},getColor:function(a){return a.properties.color||[0,0,0,255]},getStrokeWidth:function(){return 1},_parent:null,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a)},addTo:function(a){this._parent=
a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getInnerLayer:function(){var a={};GeoGlobe.Util.extend(a,this);return new deck.LineLayer(a)}});
GeoGlobe.Visuals.DeckGL.TrackLayer=GeoGlobe.Class4OL({id:"1",name:"",visible:!0,pickable:!0,fp64:!1,opacity:1,rounded:!1,data:[],getPath:function(a){return a.geometry.type==="LineString"?a.geometry.coordinates:null},getWidth:function(a){return a.properties.width||1},getColor:function(a){return a.properties.color||[0,0,0,255]},getDashArray:function(){return[0,0]},_parent:null,initialize:function(a){this.options=a;GeoGlobe.Util.extend(this,a);this.setData(this.data)},addTo:function(a){this._parent=
a;this._parent.addLayer(this)},remove:function(){this._parent.removeLayer(this.id)},render:function(){this._parent.render()},getInnerLayer:function(){var a={};GeoGlobe.Util.extend(a,this);a.data=this.paths;return new deck.PathLayer(a)},_initTracker:function(){var a=this;this.tracker={status:"ready",multiple:100,current:0,currentPoint:a.trackPoints[0],startPoint:a.trackPoints[0],endPoint:a.trackPoints[a.trackPoints.length-1],play:function(){requestAnimationFrame(a.tracker.play);if(a.tracker.status===
"playing"){a.tracker.current+=a.tracker.multiple;if(a.tracker.current<a.tracker.startPoint[1])a.tracker.current=a.tracker.startPoint[1];if(a.tracker.current>a.tracker.endPoint[1])a.tracker.current=a.tracker.endPoint[1],a.tracker.status="stop";a.tracker.currentPoint=a.trackPoints[a.tracker.current];a._updateTrackData();a.render()}},start:function(){if(this.status==="ready")this.status="playing",this.play();else if(this.status==="stop")this.status="playing"},pause:function(){this.status={playing:"pause",
pause:"playing"}[this.status]||this.status},restart:function(){if(this.status!=="ready")this.status="playing",this.current=0}}},_linearInterpolation:function(){console.time("\u7ebf\u6027\u63d2\u503c\u8017\u65f6");this.trackPoints=[];var a,b,c,d,e,f,g,h,j,l,n,o,q;o=0;for(q=this.data.length;o<q-1;o++){a=this.data[o].geometry.coordinates[0];b=this.data[o+1].geometry.coordinates[0];c=this.data[o].geometry.coordinates[1];d=this.data[o+1].geometry.coordinates[1];e=(new Date(this.data[o].properties.time)).getTime();
f=(new Date(this.data[o+1].properties.time)).getTime();g=b-a;h=d-c;f-=e;if(g!==0||h!==0)j=a%360*Math.PI/180,b=b%360*Math.PI/180,l=c%360*Math.PI/180,n=d%360*Math.PI/180,d=Math.sin(b-j)*Math.cos(n),j=Math.cos(l)*Math.sin(n)-Math.sin(l)*Math.cos(n)*Math.cos(b-j),j=Math.atan2(d,j)%(2*Math.PI)*180/Math.PI,j<0&&(j+=360);d=0;for(b=~~(f/(1E3/60)+0.5);d<=b;d++)this.trackPoints.push([o,this.trackPoints.length,a+g*d/b,c+h*d/b,j,e+~~(f*d/b+0.5)])}console.timeEnd("\u7ebf\u6027\u63d2\u503c\u8017\u65f6")},_updateTrackData:function(){for(var a=
[{type:"Feature",properties:{T:0},geometry:{type:"LineString",coordinates:[]}},{type:"Feature",properties:{T:1},geometry:{type:"LineString",coordinates:[]}},{type:"Feature",properties:{T:2},geometry:{type:"LineString",coordinates:[]}},{type:"Feature",properties:{T:0},geometry:{type:"LineString",coordinates:[]}}],b=0,c=this.data.length;b<c-1;b++)b<this.tracker.startPoint[0]?(a[0].geometry.coordinates.push(this.data[b].geometry.coordinates),a[0].geometry.coordinates.push(this.data[b+1].geometry.coordinates)):
b===this.tracker.startPoint[0]?(a[0].geometry.coordinates.push(this.data[b].geometry.coordinates),a[0].geometry.coordinates.push([this.tracker.startPoint[2],this.tracker.startPoint[3]]),b===this.tracker.currentPoint[0]?(a[1].geometry.coordinates.push([this.tracker.startPoint[2],this.tracker.startPoint[3]]),a[1].geometry.coordinates.push([this.tracker.currentPoint[2],this.tracker.currentPoint[3]]),b===this.tracker.endPoint[0]?(a[2].geometry.coordinates.push([this.tracker.currentPoint[2],this.tracker.currentPoint[3]]),
a[2].geometry.coordinates.push([this.tracker.endPoint[2],this.tracker.endPoint[3]]),a[3].geometry.coordinates.push([this.tracker.endPoint[2],this.tracker.endPoint[3]]),a[3].geometry.coordinates.push(this.data[b+1].geometry.coordinates)):(a[2].geometry.coordinates.push([this.tracker.currentPoint[2],this.tracker.currentPoint[3]]),a[2].geometry.coordinates.push(this.data[b+1].geometry.coordinates))):(a[1].geometry.coordinates.push([this.tracker.startPoint[2],this.tracker.startPoint[3]]),a[1].geometry.coordinates.push(this.data[b+
1].geometry.coordinates))):b<this.tracker.endPoint[0]?b<this.tracker.currentPoint[0]?(a[1].geometry.coordinates.push(this.data[b].geometry.coordinates),a[1].geometry.coordinates.push(this.data[b+1].geometry.coordinates)):(b===this.tracker.currentPoint[0]?(a[1].geometry.coordinates.push(this.data[b].geometry.coordinates),a[1].geometry.coordinates.push([this.tracker.currentPoint[2],this.tracker.currentPoint[3]]),a[2].geometry.coordinates.push([this.tracker.currentPoint[2],this.tracker.currentPoint[3]])):
a[2].geometry.coordinates.push(this.data[b].geometry.coordinates),a[2].geometry.coordinates.push(this.data[b+1].geometry.coordinates)):(b===this.tracker.endPoint[0]?(b===this.tracker.currentPoint[0]?(a[1].geometry.coordinates.push(this.data[b].geometry.coordinates),a[1].geometry.coordinates.push([this.tracker.currentPoint[2],this.tracker.currentPoint[3]]),a[2].geometry.coordinates.push([this.tracker.currentPoint[2],this.tracker.currentPoint[3]])):a[2].geometry.coordinates.push(this.data[b].geometry.coordinates),
a[2].geometry.coordinates.push([this.tracker.endPoint[2],this.tracker.endPoint[3]]),a[3].geometry.coordinates.push([this.tracker.endPoint[2],this.tracker.endPoint[3]])):a[3].geometry.coordinates.push(this.data[b].geometry.coordinates),a[3].geometry.coordinates.push(this.data[b+1].geometry.coordinates));this.paths=[];a.forEach(function(a){var b=[];a.geometry.coordinates.forEach(function(a){(!b.length||a[0]!==b[b.length-1][0]||a[1]!==b[b.length-1][1])&&b.push(a)});if(b.length>1)a.geometry.coordinates=
b,this.paths.push(a)}.bind(this))},setRange:function(a,b){if(a<=this.trackPoints[0][5])this.tracker.startPoint=this.trackPoints[0],this.tracker.currentPoint=this.trackPoints[0],this.tracker.current=0;else if(a<this.trackPoints[this.trackPoints.length-1][5])for(var c=0;c<this.trackPoints.length;c++){if(a<=this.trackPoints[c][5]){this.tracker.startPoint=this.trackPoints[c];this.tracker.currentPoint=this.trackPoints[c];this.tracker.current=c;break}}else this.tracker.startPoint=this.trackPoints[this.trackPoints.length-
1],this.tracker.currentPoint=this.trackPoints[this.trackPoints.length-1],this.tracker.current=this.trackPoints.length-1;if(b>=this.trackPoints[this.trackPoints.length-1][5])this.tracker.endPoint=this.trackPoints[this.trackPoints.length-1];else if(b>this.trackPoints[0][5])for(c=this.trackPoints.length-1;c>=0;c--){if(b>=this.trackPoints[c][5]){this.tracker.endPoint=this.trackPoints[c];break}}else this.tracker.endPoint=this.trackPoints[0];this._updateTrackData()},setData:function(a){this.data=a;this.paths=
[];if(this.data.length){this.paths.push({type:"Feature",properties:{T:2},geometry:{type:"LineString",coordinates:[]}});for(a=0;a<this.data.length;a++)this.paths[0].geometry.coordinates.push(this.data[a].geometry.coordinates)}this._linearInterpolation();this._initTracker()}});
